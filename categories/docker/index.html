<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Docker | Heartbeat Diary</title>
<meta name=keywords content><meta name=description content="ExampleSite description"><meta name=author content="iren."><link rel=canonical href=https://blog.mletter.cn/categories/docker/><link crossorigin=anonymous href=/assets/css/stylesheet.8a45bf3109af523fe28e4543131ec0279b94176fadabc87578224e0f3b623ba4.css integrity="sha256-ikW/MQmvUj/ijkVDEx7AJ5uUF2+tq8h1eCJODztiO6Q=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://blog.mletter.cn/categories/docker/index.xml><link rel=alternate hreflang=zh href=https://blog.mletter.cn/categories/docker/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/mermaid/8.14.0/mermaid.min.js></script><script>mermaid.init(void 0,".language-mermaid")</script><meta property="og:url" content="https://blog.mletter.cn/categories/docker/"><meta property="og:site_name" content="Heartbeat Diary"><meta property="og:title" content="Docker"><meta property="og:description" content="ExampleSite description"><meta property="og:locale" content="zh"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker"><meta name=twitter:description content="ExampleSite description"></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.mletter.cn/ accesskey=h title="Heartbeat Diary (Alt + H)">Heartbeat Diary</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.mletter.cn/ title=主页><span>主页</span></a></li><li><a href=https://blog.mletter.cn/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.mletter.cn/posts/ title=文章><span>文章</span></a></li><li><a href=https://blog.mletter.cn/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.mletter.cn/friends/ title=友联><span>友联</span></a></li><li><a href=https://blog.mletter.cn/about title=关于><span>关于</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://blog.mletter.cn/>主页</a></div><h1>Docker
<a href=/categories/docker/index.xml title=RSS aria-label=RSS><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="23"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></h1></header><article class="post-entry tag-entry"><figure class=entry-cover><img loading=lazy src=https://img10.360buyimg.com/ddimg/jfs/t1/305882/19/13878/66347/685e5695F77cae217/23dbeceefb8b6e73.jpg alt></figure><header class=entry-header><h2 class=entry-hint-parent>Docker日志太多？磁盘爆了？一篇教你搞定容器日志问题</h2></header><div class=entry-content><p>在使用 Docker 时，容器日志的无限制增长可能会导致磁盘空间被快速占满，甚至引发服务崩溃。哥们带你将从问题定位、临时解决方案、长期优化策略三个层面，手把手教你彻底解决 Docker 日志问题。
一、问题定位：日志文件在哪？ 通常情况下位于Docker容器的日志默认存储在宿主机的以下路径中：
/var/lib/docker/containers/&lt;container_id>/&lt;container_id>-json.log 取决于你的 docker 存储目录，如需修改请结合个人环境以及项目条件进行修改，每个容器生成的日志文件通常以 *-json.log 结尾。
快速检查磁盘占用：
# 查看磁盘使用情况 df -h # 找出日志目录占用空间最大的容器 cd /var/lib/docker/containers/ du -sh * | sort -nr | head -n 20 二、临时解决方案：快速释放磁盘空间 方法一：使用 truncate 清空日志 # 替换为实际容器ID container_id="your_container_id" truncate -s 0 /var/lib/docker/containers/${container_id}/*-json.log 优势：保留文件 inode，不会中断正在写入的日志进程。 方法二：使用 echo 清空日志 echo "" > /var/lib/docker/containers/${container_id}/*-json.log 注意：可能导致日志文件 inode 变化，建议优先使用 truncate。 其实某些情况下你也可以使用docker system prune -a来进行清理未使用的容器、镜像、网络和卷。
三、长期优化策略 方法一：配置日志轮转（Log Rotation） 通过 logrotate 工具自动管理日志文件的大小和保留时间。
创建配置文件 /etc/logrotate.d/docker-container-logs： vim /etc/logrotate.d/docker-container-logs /var/lib/docker/containers/*/*.log { rotate 7 # 保留7天日志 daily # 每天轮转一次 compress # 压缩旧日志 missingok # 文件缺失不报错 notifempty # 空文件不轮转 copytruncate # 截断原始文件前复制 } 方法二：限制单个日志文件大小 在启动容器时，通过 --log-opt 参数限制日志文件的大小和数量：
...</p></div><footer class=entry-footer><span title='2025-06-26 00:00:00 +0000 UTC'>六月 26, 2025</span>&nbsp;·&nbsp;1 分钟&nbsp;·&nbsp;iren.</footer><a class=entry-link aria-label="post link to Docker日志太多？磁盘爆了？一篇教你搞定容器日志问题" href=https://blog.mletter.cn/tech/docker/docker-container-logging-troubleshooting/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>利用CloudFlare来实现镜像加速</h2></header><div class=entry-content><p>目前可用加速镜像仓库 DockerProxy 代理加速：dockerproxy.com
百度云 Mirror: mirror.baidubce.com
Daocloud: docker.m.daocloud.io
南京大学：docker.nju.edu.cn
上海交大：docker.mirrors.sjtug.sjtu.edu.cn
sudo mkdir -p /etc/docker sudo tee /etc/docker/daemon.json &lt;&lt;-EOF { "registry-mirrors": [ "https://&lt;changme>.mirror.aliyuncs.com", "https://dockerproxy.com", "https://mirror.baidubce.com", "https://docker.m.daocloud.io", "https://docker.nju.edu.cn", "https://docker.mirrors.sjtug.sjtu.edu.cn" ] } EOF sudo systemctl daemon-reload sudo systemctl restart docker 准备工作 注册CloudFlare账号 开始自建CloudFlare仓库 首先进入cloudflare创建一个Workers,创建完成以后点击编辑代码
编辑Woker.js文件
import HTML from './docker.html'; export default { async fetch(request) { const url = new URL(request.url); const path = url.pathname; const originalHost = request.headers.get("host"); const registryHost = "registry-1.docker.io"; if (path.startsWith("/v2/")) { const headers = new Headers(request.headers); headers.set("host", registryHost); const registryUrl = `https://${registryHost}${path}`; const registryRequest = new Request(registryUrl, { method: request.method, headers: headers, body: request.body, // redirect: "manual", redirect: "follow", }); const registryResponse = await fetch(registryRequest); console.log(registryResponse.status); const responseHeaders = new Headers(registryResponse.headers); responseHeaders.set("access-control-allow-origin", originalHost); responseHeaders.set("access-control-allow-headers", "Authorization"); return new Response(registryResponse.body, { status: registryResponse.status, statusText: registryResponse.statusText, headers: responseHeaders, }); } else { return new Response(HTML.replace(/{{host}}/g, originalHost), { status: 200, headers: { "content-type": "text/html" } }); } } } 编辑器内新建docker.html &lt;!DOCTYPE html> &lt;html lang="zh-CN"> &lt;head> &lt;meta charset="utf-8"> &lt;meta name="viewport" content="width=device-width, initial-scale=1"> &lt;title>镜像使用说明&lt;/title> &lt;style> body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; } .header { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 20px 0; text-align: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); } .container { max-width: 800px; margin: 40px auto; padding: 20px; background-color: #fff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border-radius: 10px; } .content { margin-bottom: 20px; } .footer { text-align: center; padding: 20px 0; background-color: #333; color: #fff; } pre { background-color: #272822; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; } code { font-family: 'Source Code Pro', monospace; } a { color: #4CAF50; text-decoration: none; } a:hover { text-decoration: underline; } @media (max-width: 600px) { .container { margin: 20px; padding: 15px; } .header { padding: 15px 0; } } &lt;/style> &lt;link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&amp;family=Source+Code+Pro:wght@400;700&amp;display=swap" rel="stylesheet"> &lt;/head> &lt;body> &lt;div class="header"> &lt;h1>镜像仓库Hub加速说明&lt;/h1> &lt;/div> &lt;div class="container"> &lt;div class="content"> &lt;p>为了加速镜像拉取，你可以使用以下命令设置 registry mirror:&lt;/p> &lt;pre>&lt;code>sudo tee /etc/docker/daemon.json &amp;lt;&amp;lt;EOF { "registry-mirrors": ["https://{{host}}"] } EOF&lt;/code>&lt;/pre> &lt;p>为了避免 Worker 用量耗尽，你可以手动 pull 镜像然后 re-tag 之后 push 至本地镜像仓库:&lt;/p> &lt;pre>&lt;code>docker pull {{host}}/library/alpine:latest # 拉取 library 镜像 docker pull {{host}}/coredns/coredns:latest # 拉取 coredns 镜像&lt;/code>&lt;/pre> &lt;/div> &lt;/div> &lt;div class="footer"> &lt;p>Powered by Cloudflare Workers&lt;/p> &lt;p>&lt;a href="https://blog.mletter.cn" target="_blank">技术支持: Cloudflare && 春日心动日记&lt;/a>&lt;/p> &lt;/div> &lt;/body> &lt;/html> 点击右侧的部署 ...</p></div><footer class=entry-footer><span title='2024-07-16 00:00:00 +0000 UTC'>七月 16, 2024</span>&nbsp;·&nbsp;2 分钟&nbsp;·&nbsp;iren.</footer><a class=entry-link aria-label="post link to 利用CloudFlare来实现镜像加速" href=https://blog.mletter.cn/tech/docker/cloudflare-proxy/></a></article><article class="post-entry tag-entry"><figure class=entry-cover><img loading=lazy src=https://img12.360buyimg.com/ddimg/jfs/t1/221585/17/40296/38910/663b8f0aF38d1916d/5d09c604af566108.jpg alt></figure><header class=entry-header><h2 class=entry-hint-parent>优雅的多阶段构建微服务镜像</h2></header><div class=entry-content><p>借助Maven Wrapper 首先我们说说maven wrapper的使用场景
假设我们所在的团队同时维护多个项目，不同的项目使用的JDK版本不同，使用的maven版本也不同，那么为了支持多项目开发，为了构建运行效果一致，你可能需要在本地管理多个maven版本，这会非常繁琐，从而引出了maven wrapper来解决这个maven版本的管理问题。
版本一致性：通过在mvnw配置中指定 Maven 版本，确保所有开发人员和持续集成环境使用相同的maven版本。 简化批量安装：不需要预先安装maven，直接运行mvnw命令就如安装了mvn一样，从而简化了项目的初始设置和配置。 Maven Wrapper安装方式 maven-wrapper: 提供maven-wrapper.jar下载、安装和运行目标maven发行版。 maven-wrapper-distribution: 提供mvnw/mvnw.cmd脚本发行版， maven-wrapper-plugin: wrapper用于轻松将 Wrapper 安装到项目中的插件。 首先安装maven wrapper,默认情况下安装的是only-script版本，也就是精简版，不需要额外的maven-wrapper.jar。如果你需要安装source版本请使用-Dtype=source参数。 # 假设你的本地已经有了一个特定版本的maven,可以直接通过如下命令进行引入 mvn -N wrapper:wrapper # 当然也可以指定引入的maven版本信息 mvn -N wrapper:wrapper -Dmaven=3.6.1 检查是否安装成功,正常来讲是会出现一个mvnw和mvnw.cmd以及.mvn目录 [root@localhost maven-wrapper]# tree -fa . ├── ./.mvn │ └── ./.mvn/wrapper │ └── ./.mvn/wrapper/maven-wrapper.properties ├── ./mvnw └── ./mvnw.cmd 2 directories, 3 files 修改maven-wrapper.properties定义的路径地址，因为用的是官方地址可能由于墙的问题无法进行下载，我这边采用MinioS3的地址来提前下好相关版本的maven包进行上传。 wrapperVersion=3.3.1 distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.6.1/apache-maven-3.6.1-bin.zip # 正常修改distributionUrl的地址就可以了 distributionUrl=http://10.1.6.15:10240/software/apache-maven-3.6.1-bin.zip 正常能检测到相关的版本即表示成功
[root@localhost maven-wrapper]# ./mvnw --version Apache Maven 3.6.1 (d66c9c0b3152b2e69ee9bac180bb8fcc8e6af555; 2019-04-05T03:00:29+08:00) Maven home: /root/.m2/wrapper/dists/apache-maven-3.6.1/5256b4e Java version: 1.8.0_391, vendor: Oracle Corporation, runtime: /usr/local/java/jre Default locale: en_US, platform encoding: UTF-8 OS name: "linux", version: "4.18.0-372.9.1.el8.x86_64", arch: "amd64", family: "unix" 遇到小问题 如果大家在构建的过程中遇到了小问题可以看看小思路
...</p></div><footer class=entry-footer><span title='2024-05-08 00:00:00 +0000 UTC'>五月 8, 2024</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;iren.</footer><a class=entry-link aria-label="post link to 优雅的多阶段构建微服务镜像" href=https://blog.mletter.cn/tech/docker/review-docker/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Docker常见的几个问题处理</h2></header><div class=entry-content><p>Docker迁移存储目录 问题起因 由于公司最开始的服务器在/var/lib/docker没有挂载存储,容量只有40G,导致服务器磁盘用满。现将原有的Docker目录数据进行迁移。
请各位Kubernetes用户不要操作,因为容器编排不支持!
# 启动容器发现如下报错 ERROR：cannot create temporary directory! 方法一: 软连接方式 # 1.停止docker服务 systemctl stop docker # 2.开始迁移目录 mv /var/lib/docker /data/ # 使用cp命令也可以 cp -arv /var/lib/docker /data/docker # 3.添加软链接 ln -s /data/docker /var/lib/docker # 4.启动docker服务 systemctl start docker 方法二: 修改docker配置文件 注意: 这是一个旧版本docker修改存储目录的方式.
vim /etc/docker/daemon.json { "graph": [ "/data/docker/" ] # 更改docker镜像的存储目录 } 新版本修改存储目录方式
# 请找到你的docker.service存放位置 vim /usr/lib/systemd/system/docker.service 通过加入--data-root=/data/docker进行修改默认的数据存储位置
[Unit] Description=Docker Application Container Engine Documentation=https://docs.docker.com After=network-online.target firewalld.service Wants=network-online.target [Service] Type=notify ExecStart=/usr/bin/dockerd --data-root=/data/docker ExecReload=/bin/kill -s HUP $MAINPID LimitNOFILE=infinity LimitNPROC=infinity TimeoutStartSec=0 Delegate=yes KillMode=process Restart=on-failure StartLimitBurst=3 StartLimitInterval=60s [Install] WantedBy=multi-user.target 修改完成之后重启docker
...</p></div><footer class=entry-footer><span title='2022-07-14 00:00:00 +0000 UTC'>七月 14, 2022</span>&nbsp;·&nbsp;2 分钟&nbsp;·&nbsp;iren.</footer><a class=entry-link aria-label="post link to Docker常见的几个问题处理" href=https://blog.mletter.cn/tech/docker/docker-frequently-asked-questions/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>什么是dockershim</h2></header><div class=entry-content><p>先前了解 参考链接 Githubissue kubelet中的Docker支持现在已弃用，并将在未来的版本中删除。kubelet使用了一个名为dockershim的模块，该模块实现了对Docker的CRI支持，并在Kubernetes社区中发现了维护问题。我们鼓励您评估迁移到一个容器运行时的情况，该容器运行时是CRI（v1alpha1或v1兼容）的完整实现。
也就是说,在后续的Kubernetes1.20x版本以后会删除dockershim组件,但是由于目前Docker的使用用户众多,中间必然会有替换的一个过渡期,所以大家可以更多的关注一下其他的Container Runtime。 例如我们的Podman、Containerd、cri-o等其他容器运行时来运行kubernetes。
下面我们就具体来看看Kubernetes所提到的弃用dockershim到底是什么东西.
CRI容器运行时接口 参考链接 CRI：容器运行时接口 container runtime interface，CRI 中定义了容器和镜像两个接口，实现了这两个接口目前主流的是：CRI-O、Containerd。（目前 PCI 产品使用的即为 Containerd）。 CRI接口的具体用处就在于
对容器操作的接口，包括容器的创建、启动和停止.即create、stop等操作。 对镜像的操作，下载、删除镜像等. 即pull、rmi等操作。 podsandbox OCI开放容器标准 OCI：开放容器标准 open container initiative，OCI 中定义了两个标准：容器运行时标准 和 容器镜像标准，实现了这一标准的主流是：runc（也即我们日常说的 Docker）、Kata-Container。 OCI的作用在于
ImageSpec(容器标准包) 文件系统：以 layer 保存的文件系统，每个 layer 保存了和上层之间变化的部分，layer 应该保存哪些文件，怎么表示增加、修改和删除的文件等 config 文件：保存了文件系统的层级信息（每个层级的 hash 值，以及历史信息），以及容器运行时需要的一些信息（比如环境变量、工作目录、命令参数、mount 列表），指定了镜像在某个特定平台和系统的配置。比较接近我们使用 docker inspect &lt;image_id> 看到的内容 manifest 文件：镜像的 config 文件索引，有哪些 layer，额外的 annotation 信息，manifest 文件中保存了很多和当前平台有关的信息 index 文件：可选的文件，指向不同平台的 manifest 文件，这个文件能保证一个镜像可以跨平台使用，每个平台拥有不同的 manifest 文件，使用 index 作为索引 2.runtimeSpec:
ociVersion(string, REQUIRED):是该州遵守的开放容器倡议运行时规范的版本。 id： 容器的 ID。这在此主机上的所有容器中必须是唯一的。不要求它在主机之间是唯一的。 status(string, REQUIRED): 加冕时容器的几个状态 1. creating 2. created 3. running 4. stopped pid: host上看到的容器进程 bundle：host上容器bundle目录的绝对路径 annotation：容器相关的标注，可选 所以在Json的序列化时,必须遵守以下格式
...</p></div><footer class=entry-footer><span title='2022-02-13 00:00:00 +0000 UTC'>二月 13, 2022</span>&nbsp;·&nbsp;1 分钟&nbsp;·&nbsp;iren.</footer><a class=entry-link aria-label="post link to 什么是dockershim" href=https://blog.mletter.cn/tech/docker/docker-shim/></a></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.mletter.cn/>Heartbeat Diary</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>