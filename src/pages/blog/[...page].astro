---
import type { CollectionEntry } from "astro:content";
import Pagination from "@/components/Paginator.astro";
import PostPreview from "@/components/blog/PostPreview.astro";
import { getAllPosts, getUniqueTags, groupPostsByYear } from "@/data/post";
import PageLayout from "@/layouts/Base.astro";
import { collectionDateSort } from "@/utils/date";
import type { GetStaticPaths, Page } from "astro";
import { Icon } from "astro-icon/components";
import Badge from "@/components/Badge.astro";

export const getStaticPaths = (async ({ paginate }) => {
	const MAX_POSTS_PER_PAGE = 10; 
	const MAX_TAGS = 20;
	const allPosts = await getAllPosts();
	const uniqueTags = getUniqueTags(allPosts).slice(0, MAX_TAGS);
	return paginate(allPosts.sort(collectionDateSort), {
		pageSize: MAX_POSTS_PER_PAGE,
		props: { uniqueTags },
	});
}) satisfies GetStaticPaths;

interface Props {
	page: Page<CollectionEntry<"post">>;
	uniqueTags: string[];
}

const { page, uniqueTags } = Astro.props;

const meta = {
	description: "Read my collection of posts and the things that interest me",
	title: "文章",
};

const paginationProps = {
	...(page.url.prev && {
		prevUrl: {
			text: "← 上一页",
			url: page.url.prev,
		},
	}),
	...(page.url.next && {
		nextUrl: {
			text: "下一页 →",
			url: page.url.next,
		},
	}),
};

const groupedByYear = groupPostsByYear(page.data);
const descYearKeys = Object.keys(groupedByYear).sort((a, b) => +b - +a);
---

<PageLayout meta={meta}>
	
	<!-- Background Blobs (保持全站统一的呼吸背景) -->
	<div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
		<div class="animate-blob absolute top-0 left-1/4 w-[60vw] h-[60vw] md:w-[45rem] md:h-[45rem] -translate-x-1/2 bg-gradient-to-b from-emerald-100/40 via-teal-50/20 to-transparent rounded-full blur-[100px] opacity-50 dark:from-emerald-900/20 dark:via-teal-900/10 dark:opacity-30 mix-blend-multiply dark:mix-blend-screen"></div>
		<div class="animate-blob animation-delay-4000 absolute bottom-0 right-0 w-[60vw] h-[60vw] md:w-[40rem] md:h-[40rem] bg-gradient-to-l from-sky-100/30 via-blue-50/20 to-transparent rounded-full blur-[100px] opacity-40 dark:from-sky-900/20 dark:opacity-20 mix-blend-multiply dark:mix-blend-screen"></div>
	</div>

	<!-- Header Section -->
	<div class="mb-8 animate-fade-in-up" style="animation-fill-mode: forwards;">
			<h1 class="text-3xl font-bold flex items-center gap-3 text-accent-two">
				文章
				<a class="group relative flex items-center justify-center p-2 rounded-full hover:bg-accent-two/10 transition-colors duration-300" href="/rss.xml" target="_blank" aria-label="RSS Feed">
					<Icon aria-hidden="true" class="h-5 w-5 text-accent-two group-hover:scale-110 transition-transform" focusable="false" name="mdi:rss" />
				</a>
			</h1>
			<p class="mt-2 text-gray-500 dark:text-gray-400">
				共 {page.total} 篇文章.
			</p>
		</div>

	<div class="grid gap-y-10 md:grid-cols-[1fr_14rem] md:gap-x-10 items-start">
		
		<!-- Main List Section (时间轴样式) -->
		<section aria-label="Blog post list" class="animate-fade-in-up animation-delay-200 opacity-0" style="animation-fill-mode: forwards;">
			{
				descYearKeys.map((yearKey) => (
					<div class="relative pl-8 border-l border-gray-200 dark:border-white/10 last:border-0 pb-10">
						<!-- Timeline Year Marker -->
						<span class="absolute -left-[5px] top-1 h-2.5 w-2.5 rounded-full bg-accent-two ring-4 ring-bgColor"></span>
						
						<h4 class="text-2xl font-bold text-accent-two mb-6 -mt-2 font-mono tracking-tight">
							{yearKey}
						</h4>
						
						<ul class="space-y-6">
							{groupedByYear[yearKey]?.map((p) => (
								<li class="group relative transition-all duration-300 hover:translate-x-1">
									<PostPreview post={p} withDesc={true} />
								</li>
							))}
						</ul>
					</div>
				))
			}
			
			<!-- Pagination -->
			<div class="mt-8 pt-8 border-t border-gray-200 dark:border-white/10">
				<Pagination {...paginationProps} />
			</div>
		</section>

		<!-- Sidebar (Sticky Tags) -->
		{
			!!uniqueTags.length && (
				<aside class="hidden md:block sticky top-24 animate-fade-in-up animation-delay-500 opacity-0" style="animation-fill-mode: forwards;">
					<!-- 
						这里移除了之前的 bg-white/40 等背景样式 
						保持原始布局结构，仅增加了 sticky 定位 
					-->
					<h4 class="title mb-4 flex items-center gap-2">
						标签云
					</h4>
					
					<ul class="flex flex-wrap gap-2 mb-6">
						{uniqueTags.map((tag) => (
							<li>
								<a aria-label={`View all posts with the tag: ${tag}`} href={`/tags/${tag}`}>
									{/* Badge 组件会使用其内部定义的颜色，此处没有任何外部容器颜色干扰 */}
									<Badge variant="muted" title={tag} class="transition-transform hover:scale-105" />
								</a>
							</li>
						))}
					</ul>

					<span class="block text-end">
						<a
							aria-label="View all blog categories"
							class="text-sm font-medium text-gray-500 hover:text-accent-two transition-colors"
							href="/tags/"
						>
							查看更多 →
						</a>
					</span>
				</aside>
			)
		}
	</div>
</PageLayout>

<style>
	/* 简单的入场动画 */
	@keyframes fade-in-up {
		0% { opacity: 0; transform: translateY(20px); }
		100% { opacity: 1; transform: translateY(0); }
	}
	.animate-fade-in-up {
		animation: fade-in-up 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
	}
	
	/* 呼吸背景 */
	@keyframes blob {
		0% { transform: translate(0px, 0px) scale(1); }
		33% { transform: translate(30px, -50px) scale(1.1); }
		66% { transform: translate(-20px, 20px) scale(0.95); }
		100% { transform: translate(0px, 0px) scale(1); }
	}
	.animate-blob {
		animation: blob 25s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
	}

	/* 动画延迟工具类 */
	.animation-delay-200 { animation-delay: 0.2s; }
	.animation-delay-500 { animation-delay: 0.5s; }
	.animation-delay-4000 { animation-delay: 4s; }
</style>