<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Coredns on æ˜¥æ—¥å¿ƒåŠ¨æ—¥è®°</title>
        <link>http://localhost:1313/tags/coredns/</link>
        <description>Recent content in Coredns on æ˜¥æ—¥å¿ƒåŠ¨æ—¥è®°</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <copyright>Live and learn. ğŸŒ±</copyright>
        <lastBuildDate>Sun, 26 Feb 2023 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/tags/coredns/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>CacheDNSå’ŒDNSç¼“å­˜</title>
        <link>http://localhost:1313/kubernetes/nodelocaldns/</link>
        <pubDate>Sun, 26 Feb 2023 00:00:00 +0000</pubDate>
        
        <guid>http://localhost:1313/kubernetes/nodelocaldns/</guid>
        <description>&lt;img src="https://d33wubrfki0l68.cloudfront.net/bf8e5eaac697bac89c5b36a0edb8855c860bfb45/6944f/images/docs/nodelocaldns.svg" alt="Featured image of post CacheDNSå’ŒDNSç¼“å­˜" /&gt;&lt;p&gt;å¦‚æœåœ¨é›†ç¾¤è§„æ¨¡è¾ƒå¤§å¹¶å‘è¾ƒé«˜çš„æƒ…å†µä¸‹æˆ‘ä»¬ä»ç„¶éœ€è¦å¯¹ DNS è¿›è¡Œä¼˜åŒ–ï¼Œå…¸å‹çš„å°±æ˜¯å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„ CoreDNS ä¼šå‡ºç°è¶…æ—¶5sçš„æƒ…å†µã€‚&lt;/p&gt;
&lt;h2 id=&#34;è¶…æ—¶åŸå› &#34;&gt;è¶…æ—¶åŸå› &lt;/h2&gt;
&lt;p&gt;åœ¨ iptables æ¨¡å¼ä¸‹ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰ï¼Œæ¯ä¸ªæœåŠ¡çš„ kube-proxy åœ¨ä¸»æœºç½‘ç»œåç§°ç©ºé—´çš„ nat è¡¨ä¸­åˆ›å»ºä¸€äº› iptables è§„åˆ™ã€‚ æ¯”å¦‚åœ¨é›†ç¾¤ä¸­å…·æœ‰ä¸¤ä¸ª DNS æœåŠ¡å™¨å®ä¾‹çš„ kube-dns æœåŠ¡ï¼Œå…¶ç›¸å…³è§„åˆ™å¤§è‡´å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;1&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; -A PREROUTING -m comment --comment &lt;span class=&#34;s2&#34;&gt;&amp;#34;kubernetes service portals&amp;#34;&lt;/span&gt; -j KUBE-SERVICES
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;...&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;2&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; -A KUBE-SERVICES -d 10.96.0.10/32 -p udp -m comment --comment &lt;span class=&#34;s2&#34;&gt;&amp;#34;kube-system/kube-dns:dns cluster IP&amp;#34;&lt;/span&gt; -m udp --dport &lt;span class=&#34;m&#34;&gt;53&lt;/span&gt; -j KUBE-SVC-TCOU7JCQXEZGVUNU
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;...&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;3&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; -A KUBE-SVC-TCOU7JCQXEZGVUNU -m comment --comment &lt;span class=&#34;s2&#34;&gt;&amp;#34;kube-system/kube-dns:dns&amp;#34;&lt;/span&gt; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-LLLB6FGXBLX6PZF7
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;4&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; -A KUBE-SVC-TCOU7JCQXEZGVUNU -m comment --comment &lt;span class=&#34;s2&#34;&gt;&amp;#34;kube-system/kube-dns:dns&amp;#34;&lt;/span&gt; -j KUBE-SEP-LRVEW52VMYCOUSMZ
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;...&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;5&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; -A KUBE-SEP-LLLB6FGXBLX6PZF7 -p udp -m comment --comment &lt;span class=&#34;s2&#34;&gt;&amp;#34;kube-system/kube-dns:dns&amp;#34;&lt;/span&gt; -m udp -j DNAT --to-destination 10.32.0.6:53
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;...&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;6&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; -A KUBE-SEP-LRVEW52VMYCOUSMZ -p udp -m comment --comment &lt;span class=&#34;s2&#34;&gt;&amp;#34;kube-system/kube-dns:dns&amp;#34;&lt;/span&gt; -m udp -j DNAT --to-destination 10.32.0.7:53
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æˆ‘ä»¬çŸ¥é“æ¯ä¸ª Pod çš„ &lt;code&gt;/etc/resolv.conf&lt;/code&gt; æ–‡ä»¶ä¸­éƒ½æœ‰å¡«å……çš„ &lt;code&gt;nameserver 10.96.0.10&lt;/code&gt; è¿™ä¸ªæ¡ç›®ã€‚æ‰€ä»¥æ¥è‡ª Pod çš„ DNS æŸ¥æ‰¾è¯·æ±‚å°†å‘é€åˆ° &lt;code&gt;10.96.0.10&lt;/code&gt;ï¼Œè¿™æ˜¯ kube-dns æœåŠ¡çš„ ClusterIP åœ°å€ã€‚ ç”±äº &lt;code&gt;(1)&lt;/code&gt; è¯·æ±‚è¿›å…¥ &lt;code&gt;KUBE-SERVICE&lt;/code&gt; é“¾ï¼Œç„¶ååŒ¹é…è§„åˆ™ &lt;code&gt;(2)&lt;/code&gt;ï¼Œæœ€åæ ¹æ® &lt;code&gt;(3)&lt;/code&gt; çš„ random éšæœºæ¨¡å¼ï¼Œè·³è½¬åˆ° (5) æˆ– (6) æ¡ç›®ï¼Œå°†è¯·æ±‚ UDP æ•°æ®åŒ…çš„ç›®æ ‡ IP åœ°å€ä¿®æ”¹ä¸º DNS æœåŠ¡å™¨çš„&lt;code&gt;å®é™…&lt;/code&gt; IP åœ°å€ï¼Œè¿™æ˜¯é€šè¿‡ &lt;code&gt;DNAT&lt;/code&gt; å®Œæˆçš„ã€‚å…¶ä¸­ &lt;code&gt;10.32.0.6&lt;/code&gt; å’Œ &lt;code&gt;10.32.0.7&lt;/code&gt; æ˜¯æˆ‘ä»¬é›†ç¾¤ä¸­ CoreDNS çš„ä¸¤ä¸ª Pod å‰¯æœ¬çš„ IP åœ°å€ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å†…æ ¸ä¸­çš„dnat&#34;&gt;å†…æ ¸ä¸­çš„DNAT&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;DNAT&lt;/code&gt; çš„ä¸»è¦èŒè´£æ˜¯åŒæ—¶æ›´æ”¹ä¼ å‡ºæ•°æ®åŒ…çš„ç›®çš„åœ°ï¼Œå“åº”æ•°æ®åŒ…çš„æºï¼Œå¹¶ç¡®ä¿å¯¹æ‰€æœ‰åç»­æ•°æ®åŒ…è¿›è¡Œç›¸åŒçš„ä¿®æ”¹ã€‚åè€…ä¸¥é‡ä¾èµ–äºè¿æ¥è·Ÿè¸ªæœºåˆ¶ï¼Œä¹Ÿç§°ä¸º &lt;code&gt;conntrack&lt;/code&gt;ï¼Œå®ƒè¢«å®ç°ä¸ºå†…æ ¸æ¨¡å—ã€‚&lt;code&gt;conntrack&lt;/code&gt; ä¼šè·Ÿè¸ªç³»ç»Ÿä¸­æ­£åœ¨è¿›è¡Œçš„ç½‘ç»œè¿æ¥ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;conntrack&lt;/code&gt; ä¸­çš„æ¯ä¸ªè¿æ¥éƒ½ç”±ä¸¤ä¸ªå…ƒç»„è¡¨ç¤ºï¼Œä¸€ä¸ªå…ƒç»„ç”¨äºåŸå§‹è¯·æ±‚ï¼ˆIP_CT_DIR_ORIGINALï¼‰ï¼Œå¦ä¸€ä¸ªå…ƒç»„ç”¨äºç­”å¤ï¼ˆIP_CT_DIR_REPLYï¼‰ã€‚å¯¹äº UDPï¼Œæ¯ä¸ªå…ƒç»„éƒ½ç”±æº IP åœ°å€ï¼Œæºç«¯å£ä»¥åŠç›®æ ‡ IP åœ°å€å’Œç›®æ ‡ç«¯å£ç»„æˆï¼Œç­”å¤å…ƒç»„åŒ…å«å­˜å‚¨åœ¨src å­—æ®µä¸­çš„ç›®æ ‡çš„çœŸå®åœ°å€ã€‚&lt;/p&gt;
&lt;p&gt;ä¾‹å¦‚ï¼Œå¦‚æœ IP åœ°å€ä¸º &lt;code&gt;10.40.0.17&lt;/code&gt; çš„ Pod å‘ kube-dns çš„ ClusterIP å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¯¥è¯·æ±‚è¢«è½¬æ¢ä¸º &lt;code&gt;10.32.0.6&lt;/code&gt;ï¼Œåˆ™å°†åˆ›å»ºä»¥ä¸‹å…ƒç»„ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;åŸå§‹ï¼šsrc &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; 10.40.0.17 &lt;span class=&#34;nv&#34;&gt;dst&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; 10.96.0.10 &lt;span class=&#34;nv&#34;&gt;sport&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;53378&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;dport&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;53&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;å›å¤ï¼šsrc &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; 10.32.0.6 &lt;span class=&#34;nv&#34;&gt;dst&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; 10.40.0.17 &lt;span class=&#34;nv&#34;&gt;sport&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;53&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;dport&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;53378&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é€šè¿‡è¿™äº›æ¡ç›®å†…æ ¸å¯ä»¥ç›¸åº”åœ°ä¿®æ”¹ä»»ä½•ç›¸å…³æ•°æ®åŒ…çš„ç›®çš„åœ°å’Œæºåœ°å€ï¼Œè€Œæ— éœ€å†æ¬¡éå† DNAT è§„åˆ™ï¼Œæ­¤å¤–ï¼Œå®ƒå°†çŸ¥é“å¦‚ä½•ä¿®æ”¹å›å¤ä»¥åŠåº”å°†å›å¤å‘é€ç»™è°ã€‚åˆ›å»º &lt;code&gt;conntrack&lt;/code&gt; æ¡ç›®åï¼Œå°†é¦–å…ˆå¯¹å…¶è¿›è¡Œç¡®è®¤ï¼Œç„¶åå¦‚æœæ²¡æœ‰å·²ç¡®è®¤çš„ &lt;code&gt;conntrack&lt;/code&gt; æ¡ç›®å…·æœ‰ç›¸åŒçš„åŸå§‹å…ƒç»„æˆ–å›å¤å…ƒç»„ï¼Œåˆ™å†…æ ¸å°†å°è¯•ç¡®è®¤è¯¥æ¡ç›®ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å…·ä½“åŸå› å¯ä»¥å‚è€ƒ weave works æ€»ç»“çš„æ–‡ç«  &lt;a class=&#34;link&#34; href=&#34;https://www.weave.works/blog/racy-conntrack-and-dns-lookup-timeouts&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Racy conntrack and DNS lookup timeouts&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;åªæœ‰å¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ï¼Œå¹¶å‘ä»åŒä¸€ä¸ª socket å‘é€ç›¸åŒäº”å…ƒç»„çš„ UDP æŠ¥æ–‡æ—¶ï¼Œæ‰æœ‰ä¸€å®šæ¦‚ç‡ä¼šå‘ç”Ÿ&lt;/li&gt;
&lt;li&gt;glibcã€muslï¼ˆalpine linux çš„ libc åº“ï¼‰éƒ½ä½¿ç”¨ &lt;code&gt;parallel query&lt;/code&gt;, å°±æ˜¯å¹¶å‘å‘å‡ºå¤šä¸ªæŸ¥è¯¢è¯·æ±‚ï¼Œå› æ­¤å¾ˆå®¹æ˜“ç¢°åˆ°è¿™æ ·çš„å†²çªï¼Œé€ æˆæŸ¥è¯¢è¯·æ±‚è¢«ä¸¢å¼ƒ&lt;/li&gt;
&lt;li&gt;ç”±äº ipvs ä¹Ÿä½¿ç”¨äº† conntrack, ä½¿ç”¨ kube-proxy çš„ ipvs æ¨¡å¼ï¼Œå¹¶ä¸èƒ½é¿å…è¿™ä¸ªé—®é¢˜&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;è§£å†³æ–¹æ³•&#34;&gt;è§£å†³æ–¹æ³•&lt;/h3&gt;
&lt;p&gt;è¦å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜æœ€å¥½å½“ç„¶æ˜¯å†…æ ¸ä¸Šå» FIX æ‰è¿™ä¸ª BUGï¼Œé™¤äº†è¿™ç§æ–¹æ³•ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•æ¥è¿›è¡Œè§„é¿ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…ç›¸åŒäº”å…ƒç»„ DNSè¯·æ±‚çš„å¹¶å‘ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ &lt;code&gt;resolv.conf&lt;/code&gt; ä¸­å°±æœ‰ä¸¤ä¸ªç›¸å…³çš„å‚æ•°å¯ä»¥è¿›è¡Œé…ç½®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;single-request-reopen&lt;/code&gt;ï¼šå‘é€ A ç±»å‹è¯·æ±‚å’Œ AAAA ç±»å‹è¯·æ±‚ä½¿ç”¨ä¸åŒçš„æºç«¯å£ï¼Œè¿™æ ·ä¸¤ä¸ªè¯·æ±‚åœ¨ conntrack è¡¨ä¸­ä¸å ç”¨åŒä¸€ä¸ªè¡¨é¡¹ï¼Œä»è€Œé¿å…å†²çªã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;single-request&lt;/code&gt;ï¼šé¿å…å¹¶å‘ï¼Œæ”¹ä¸ºä¸²è¡Œå‘é€ A ç±»å‹å’Œ AAAA ç±»å‹è¯·æ±‚ã€‚æ²¡æœ‰äº†å¹¶å‘ï¼Œä»è€Œä¹Ÿé¿å…äº†å†²çªã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;Pod çš„ postStart hook ä¸­æ·»åŠ &lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;lifecycle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;postStart&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;exec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;command&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;l&#34;&gt;/bin/sh&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- -&lt;span class=&#34;l&#34;&gt;c &lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;s2&#34;&gt;&amp;#34;/bin/echo &amp;#39;options single-request-reopen&amp;#39; &amp;gt;&amp;gt; /etc/resolv.conf&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;ä½¿ç”¨ &lt;code&gt;template.spec.dnsConfig&lt;/code&gt; é…ç½®&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;dnsConfig&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;options&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;single-request-reopen	&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;ä½¿ç”¨ ConfigMap è¦†ç›– Pod é‡Œé¢çš„ &lt;code&gt;/etc/resolv.conf&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;# configmap&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;apiVersion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;v1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;resolv.conf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;    nameserver 1.2.3.4
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;    search default.svc.cluster.local svc.cluster.local cluster.local
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;    options ndots:5 single-request-reopen timeout:1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;kind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;ConfigMap&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;resolvconf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;---&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# Pod Spec&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;volumeMounts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;resolv-conf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;mountPath&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;/etc/resolv.conf   &lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;subPath&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;resolv.conf &lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# åœ¨æŸä¸ªç›®å½•ä¸‹é¢æŒ‚è½½ä¸€ä¸ªæ–‡ä»¶ï¼ˆä¿è¯ä¸è¦†ç›–å½“å‰ç›®å½•ï¼‰éœ€è¦ä½¿ç”¨subPath -&amp;gt; ä¸æ”¯æŒçƒ­æ›´æ–°&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;volumes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;resolv-conf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;configMap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;resolvconf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;items&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;resolv.conf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;resolv.conf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;nodelocal-dnscache&#34;&gt;NodeLocal DNSCache&lt;/h2&gt;
&lt;p&gt;NodeLocal DNSCache é€šè¿‡åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šä½œä¸º DaemonSet è¿è¡Œ DNS ç¼“å­˜ä»£ç†æ¥æé«˜é›†ç¾¤ DNS æ€§èƒ½ã€‚ åœ¨å½“ä»Šçš„ä½“ç³»ç»“æ„ä¸­ï¼Œè¿è¡Œåœ¨ &lt;code&gt;ClusterFirst&lt;/code&gt; DNS æ¨¡å¼ä¸‹çš„ Pod å¯ä»¥è¿æ¥åˆ° kube-dns &lt;code&gt;serviceIP&lt;/code&gt; è¿›è¡Œ DNS æŸ¥è¯¢ã€‚ é€šè¿‡ kube-proxy æ·»åŠ çš„ iptables è§„åˆ™å°†å…¶è½¬æ¢ä¸º kube-dns/CoreDNS ç«¯ç‚¹ã€‚ å€ŸåŠ©è¿™ç§æ–°æ¶æ„ï¼ŒPod å°†å¯ä»¥è®¿é—®åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ DNS ç¼“å­˜ä»£ç†ï¼Œä»è€Œé¿å… iptables DNAT è§„åˆ™å’Œè¿æ¥è·Ÿè¸ªã€‚ æœ¬åœ°ç¼“å­˜ä»£ç†å°†æŸ¥è¯¢ kube-dns æœåŠ¡ä»¥è·å–é›†ç¾¤ä¸»æœºåçš„ç¼“å­˜ç¼ºå¤±ï¼ˆé»˜è®¤ä¸º â€œ&lt;code&gt;cluster.local&lt;/code&gt;â€ åç¼€ï¼‰ã€‚&lt;/p&gt;
&lt;h3 id=&#34;åŠ¨æœº&#34;&gt;åŠ¨æœº&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨å½“å‰çš„ DNS ä½“ç³»ç»“æ„ï¼Œå¦‚æœæ²¡æœ‰æœ¬åœ° kube-dns/CoreDNS å®ä¾‹ï¼Œåˆ™å…·æœ‰æœ€é«˜ DNS QPS çš„ Pod å¯èƒ½å¿…é¡»å»¶ä¼¸åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ã€‚ åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œæ‹¥æœ‰æœ¬åœ°ç¼“å­˜å°†æœ‰åŠ©äºæ”¹å–„å»¶è¿Ÿã€‚&lt;/li&gt;
&lt;li&gt;è·³è¿‡ iptables DNAT å’Œè¿æ¥è·Ÿè¸ªå°†æœ‰åŠ©äºå‡å°‘ &lt;a class=&#34;link&#34; href=&#34;https://github.com/kubernetes/kubernetes/issues/56903&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;conntrack ç«äº‰&lt;/a&gt;å¹¶é¿å… UDP DNS æ¡ç›®å¡«æ»¡ conntrack è¡¨ã€‚&lt;/li&gt;
&lt;li&gt;ä»æœ¬åœ°ç¼“å­˜ä»£ç†åˆ° kube-dns æœåŠ¡çš„è¿æ¥å¯ä»¥å‡çº§ä¸º TCPã€‚ TCP conntrack æ¡ç›®å°†åœ¨è¿æ¥å…³é—­æ—¶è¢«åˆ é™¤ï¼Œç›¸å UDP æ¡ç›®å¿…é¡»è¶…æ—¶ ï¼ˆ&lt;a class=&#34;link&#34; href=&#34;https://www.kernel.org/doc/Documentation/networking/nf_conntrack-sysctl.txt&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;é»˜è®¤&lt;/a&gt; &lt;code&gt;nf_conntrack_udp_timeout&lt;/code&gt; æ˜¯ 30 ç§’ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;å°† DNS æŸ¥è¯¢ä» UDP å‡çº§åˆ° TCP å°†å‡å°‘ç”±äºè¢«ä¸¢å¼ƒçš„ UDP åŒ…å’Œ DNS è¶…æ—¶è€Œå¸¦æ¥çš„å°¾éƒ¨ç­‰å¾…æ—¶é—´ï¼› è¿™ç±»å»¶æ—¶é€šå¸¸é•¿è¾¾ 30 ç§’ï¼ˆ3 æ¬¡é‡è¯• + 10 ç§’è¶…æ—¶ï¼‰ã€‚ ç”±äº nodelocal ç¼“å­˜ç›‘å¬ UDP DNS æŸ¥è¯¢ï¼Œåº”ç”¨ä¸éœ€è¦å˜æ›´ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨èŠ‚ç‚¹çº§åˆ«å¯¹ DNS è¯·æ±‚çš„åº¦é‡å’Œå¯è§æ€§ã€‚&lt;/li&gt;
&lt;li&gt;å¯ä»¥é‡æ–°å¯ç”¨è´Ÿç¼“å­˜ï¼Œä»è€Œå‡å°‘å¯¹ kube-dns æœåŠ¡çš„æŸ¥è¯¢æ•°é‡ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å·¥ä½œåŸç†å¦‚ä¸‹&lt;/p&gt;
&lt;p&gt;















  
  &lt;picture&gt;
  &lt;img class=&#34;img-fluid&#34; src=&#34;https://d33wubrfki0l68.cloudfront.net/bf8e5eaac697bac89c5b36a0edb8855c860bfb45/6944f/images/docs/nodelocaldns.svg&#34; alt=&#34;NodeLocal DNSCache æµ&#34; loading=&#34;lazy&#34; /&gt;
&lt;/picture&gt;
&lt;/p&gt;
&lt;p&gt;æ­¤å›¾æ˜¾ç¤ºäº† NodeLocal DNSCache å¦‚ä½•å¤„ç† DNS æŸ¥è¯¢&lt;/p&gt;
&lt;h3 id=&#34;å®‰è£…nodelocaldns&#34;&gt;å®‰è£…NodeLocalDNS&lt;/h3&gt;
&lt;p&gt;ç›´æ¥ä»å®˜æ–¹çš„èµ„æºæ¸…å•å½“ä¸­è·å–å³å¯&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;image&lt;/code&gt;ï¼šé»˜è®¤é•œåƒå›½å†…æ˜¯ä¸‹è½½ä¸äº†çš„è¯·æ›´æ¢åœ°å€&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;wget https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# ä¸‹è½½å®Œæˆè¯·æ›´æ¢imageåœ°å€ï¼š registry.cn-beijing.aliyuncs.com/custom_img/k8s-dns-node-cache:1.22.18&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ³¨æ„èµ„æºæ¸…å•ä¸­çš„å‡ ä¸ªå˜é‡ä¿¡æ¯&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;__PILLAR__DNS__SERVER__&lt;/code&gt;ï¼šè¡¨ç¤º kube-dns è¿™ä¸ª Service çš„ ClusterIPã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;__PILLAR__LOCAL__DNS__&lt;/code&gt;: è¡¨ç¤º DNSCache æœ¬åœ°çš„ IPï¼Œé»˜è®¤ä¸º &lt;code&gt;169.254.20.10&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;__PILLAR__DNS__DOMAIN__&lt;/code&gt;: è¡¨ç¤ºé›†ç¾¤åŸŸï¼Œé»˜è®¤å°±æ˜¯ &lt;code&gt;cluster.local&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œè·å–&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl get svc kube-dns -n kube-system -o &lt;span class=&#34;nv&#34;&gt;jsonpath&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;={&lt;/span&gt;.spec.clusterIP&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# ä¿®æ”¹éƒ¨åˆ†å˜é‡ä¿¡æ¯&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;sed -i &lt;span class=&#34;s1&#34;&gt;&amp;#39;s/__PILLAR__DNS__SERVER__/10.10.0.10/g
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s1&#34;&gt;s/__PILLAR__LOCAL__DNS__/169.254.20.10/g
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s1&#34;&gt;s/__PILLAR__DNS__DOMAIN__/cluster.local/g&amp;#39;&lt;/span&gt; nodelocaldns.yaml 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# åˆ›å»ºèµ„æºé…ç½®æ¸…å•&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl apply -f nodelocaldns.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;å¦‚æœ kube-proxy è¿è¡Œåœ¨ IPVS æ¨¡å¼(å› ä¸ºæˆ‘æ˜¯&lt;code&gt;ipvs&lt;/code&gt;çš„æ¨¡å¼)&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;sed -i &lt;span class=&#34;s2&#34;&gt;&amp;#34;s/__PILLAR__LOCAL__DNS__/&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$localdns&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;/g; s/__PILLAR__DNS__DOMAIN__/&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$domain&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;/g; s/,__PILLAR__DNS__SERVER__//g; s/__PILLAR__CLUSTER__DNS__/&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$kubedns&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;/g&amp;#34;&lt;/span&gt; nodelocaldns.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œnode-local-dns Pod åªä¼šä¾¦å¬ &lt;code&gt;&amp;lt;node-local-address&amp;gt;&lt;/code&gt; çš„åœ°å€ã€‚ node-local-dns æ¥å£ä¸èƒ½ç»‘å®š kube-dns çš„é›†ç¾¤ IP åœ°å€ï¼Œå› ä¸º IPVS è´Ÿè½½å‡è¡¡ä½¿ç”¨çš„æ¥å£å·²ç»å ç”¨äº†è¯¥åœ°å€ã€‚ node-local-dns Pod ä¼šè®¾ç½® &lt;code&gt;__PILLAR__UPSTREAM__SERVERS__&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æŸ¥çœ‹Podæ˜¯å¦è¿è¡ŒæˆåŠŸ&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;root@Online-Beijing-master1 ~&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# kubectl get pods -n kube-system | grep node-local-dns&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;node-local-dns-578vf                             1/1     Running   &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;             5m23s
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;node-local-dns-5jhcl                             1/1     Running   &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;             5m23s
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;node-local-dns-8hz5j                             1/1     Running   &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;             5m23s
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;node-local-dns-ch44w                             1/1     Running   &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;             5m23s
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;node-local-dns-jbg2p                             1/1     Running   &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;             5m23s
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;node-local-dns-t92ww                             1/1     Running   &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;             5m23s
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚æœ kube-proxy ç»„ä»¶ä½¿ç”¨çš„æ˜¯ ipvs æ¨¡å¼çš„è¯æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ kubelet çš„ &lt;code&gt;--cluster-dns&lt;/code&gt; å‚æ•°ï¼Œå°†å…¶æŒ‡å‘ &lt;code&gt;169.254.20.10&lt;/code&gt;ï¼ŒDaemonset ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªç½‘å¡æ¥ç»‘è¿™ä¸ª IPï¼ŒPod å‘æœ¬èŠ‚ç‚¹è¿™ä¸ª IP å‘ DNS è¯·æ±‚ï¼Œç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„æ—¶å€™æ‰ä¼šå†ä»£ç†åˆ°ä¸Šæ¸¸é›†ç¾¤ DNS è¿›è¡ŒæŸ¥è¯¢ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¦‚æœæ‹…å¿ƒçº¿ä¸Šç¯å¢ƒä¿®æ”¹ &lt;code&gt;--cluster-dns&lt;/code&gt; å‚æ•°ä¼šäº§ç”Ÿå½±å“ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨æ–°éƒ¨ç½²çš„ Pod ä¸­é€šè¿‡ dnsConfig é…ç½®ä½¿ç”¨æ–°çš„ localdns çš„åœ°å€æ¥è¿›è¡Œè§£æã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;é€šè¿‡ä¿®æ”¹&lt;code&gt;--cluster-dns&lt;/code&gt;å®ç°&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# 1. é¦–å…ˆæŸ¥çœ‹å½“å‰çš„proxyæ¨¡å¼&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;root@Online-Beijing-master1 ~&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# kubectl get cm kube-proxy -n kube-system -o yaml | grep mode&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    mode: &lt;span class=&#34;s2&#34;&gt;&amp;#34;ipvs&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;sed -i &lt;span class=&#34;s1&#34;&gt;&amp;#39;s/10.10.0.10/169.254.20.10/g&amp;#39;&lt;/span&gt; /var/lib/kubelet/config.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;systemctl daemon-reload &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; systemctl restart kubelet
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;Podä¸­é€šè¿‡dnsConfigé…ç½®ä½¿ç”¨localdns&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;dnsConfig&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;nameservers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;- &lt;span class=&#34;m&#34;&gt;169.254.20.10&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;searches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;- &lt;span class=&#34;l&#34;&gt;default.svc.cluster.local&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;- &lt;span class=&#34;l&#34;&gt;svc.cluster.local&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;- &lt;span class=&#34;l&#34;&gt;cluster.local&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;options&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;ndots&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;3&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;dnsPolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;ç”±äºæŒ‡å®š&lt;code&gt;nameservers&lt;/code&gt;å±äº&lt;code&gt;append&lt;/code&gt;æ“ä½œï¼Œå¦‚æœéœ€è¦å¿½ç•¥åŸæ¥çš„dnsåœ°å€è¯·ä½¿ç”¨&lt;code&gt;dnsPolicy: None&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;corednsçš„æ€§èƒ½ä¼˜åŒ–&#34;&gt;CoreDnsçš„æ€§èƒ½ä¼˜åŒ–&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;åˆç†æ§åˆ¶CoreDNSçš„å‰¯æœ¬æ•°é‡&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n kube-system scale --replicas&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;10&lt;/span&gt; deployment/coredns
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;ä¸º coredns å®šä¹‰ HPA è‡ªåŠ¨æ‰©ç¼©å®¹ã€‚&lt;/li&gt;
&lt;li&gt;å®‰è£… &lt;a class=&#34;link&#34; href=&#34;https://github.com/kubernetes-sigs/cluster-proportional-autoscaler&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;cluster-proportional-autoscaler&lt;/a&gt; ä»¥å®ç°æ›´ç²¾ç¡®çš„æ‰©ç¼©å®¹(æ¨è)ã€‚&lt;/li&gt;
&lt;li&gt;ç¦ç”¨IPv6&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¦‚æœ K8S èŠ‚ç‚¹æ²¡æœ‰ç¦ç”¨ IPV6 çš„è¯ï¼Œå®¹å™¨å†…è¿›ç¨‹è¯·æ±‚ coredns æ—¶çš„é»˜è®¤è¡Œä¸ºæ˜¯åŒæ—¶å‘èµ· IPV4 å’Œ IPV6 è§£æï¼Œè€Œé€šå¸¸æˆ‘ä»¬åªéœ€è¦ç”¨åˆ° IPV4ï¼Œå½“å®¹å™¨è¯·æ±‚æŸä¸ªåŸŸåæ—¶ï¼Œcoredns è§£æä¸åˆ° IPV6 è®°å½•ï¼Œå°±ä¼š forward åˆ° upstream å»è§£æï¼Œå¦‚æœåˆ° upstream éœ€è¦ç»è¿‡è¾ƒé•¿æ—¶é—´(æ¯”å¦‚è·¨å…¬ç½‘ï¼Œè·¨æœºæˆ¿ä¸“çº¿)ï¼Œå°±ä¼šæ‹–æ…¢æ•´ä¸ªè§£ææµç¨‹çš„é€Ÿåº¦ï¼Œä¸šåŠ¡å±‚é¢å°±ä¼šæ„ŸçŸ¥ DNS è§£ææ…¢ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl edit cm coredns -n kube-system
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Corefileä¸­æ·»åŠ ç¦ç”¨IPv6&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;apiVersion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;v1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;Corefile&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;    .:53 {
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;        errors
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;        health {
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;           lameduck 5s
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;        # æ·»åŠ æ­¤å†…å®¹
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;        template ANY AAAA {
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;           rcode NXDOMAIN
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;        ...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol&gt;
&lt;li&gt;ä¼˜åŒ–ndots&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes é›†ç¾¤ä¸­çš„åŸŸåè§£æå¾€å¾€éœ€è¦ç»è¿‡å¤šæ¬¡è¯·æ±‚æ‰èƒ½è§£æåˆ°ã€‚æŸ¥çœ‹ pod å†… çš„ &lt;code&gt;/etc/resolv.conf&lt;/code&gt; å¯ä»¥çŸ¥é“ &lt;code&gt;ndots&lt;/code&gt; é€‰é¡¹é»˜è®¤ä¸º 5&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;root@nginxv1-56f77cbc67-4v4fp:/# cat /etc/resolv.conf 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;search default.svc.cluster.local svc.cluster.local cluster.local
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;nameserver 10.10.0.10
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;options ndots:5
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ„æ€æ˜¯: å¦‚æœåŸŸåä¸­ &lt;code&gt;.&lt;/code&gt; çš„æ•°é‡å°äº 5ï¼Œå°±ä¾æ¬¡éå† &lt;code&gt;search&lt;/code&gt; ä¸­çš„åç¼€å¹¶æ‹¼æ¥ä¸Šè¿›è¡Œ DNS æŸ¥è¯¢ã€‚&lt;/p&gt;
&lt;p&gt;ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ debug å‘½åç©ºé—´æŸ¥è¯¢ &lt;code&gt;kubernetes.default.svc.cluster.local&lt;/code&gt; è¿™ä¸ª service:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åŸŸåä¸­æœ‰4ä¸ª&lt;code&gt;.&lt;/code&gt;å°äº5å°è¯•æ‹¼æ¥ä¸Šç¬¬ä¸€ä¸ª search è¿›è¡ŒæŸ¥è¯¢,ä¹Ÿå°±æ˜¯æŸ¥è¯¢å³&lt;code&gt;kubernetes.default.svc.cluster.local.debug.svc.cluster.local&lt;/code&gt;æŸ¥ä¸åˆ°è¯¥åŸŸåã€‚&lt;/li&gt;
&lt;li&gt;ç»§ç»­å°è¯• &lt;code&gt;kubernetes.default.svc.cluster.local.svc.cluster.local&lt;/code&gt;ï¼ŒæŸ¥ä¸åˆ°è¯¥åŸŸåã€‚&lt;/li&gt;
&lt;li&gt;ç»§ç»­å°è¯• &lt;code&gt;kubernetes.default.svc.cluster.local.cluster.local&lt;/code&gt;ï¼Œä»ç„¶æŸ¥ä¸åˆ°è¯¥åŸŸåã€‚&lt;/li&gt;
&lt;li&gt;å°è¯•ä¸åŠ åç¼€ï¼Œå³ &lt;code&gt;kubernetes.default.svc.cluster.local&lt;/code&gt;ï¼ŒæŸ¥è¯¢æˆåŠŸï¼Œè¿”å›å“åº”çš„ ClusterIPã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç®€å•çš„ service åŸŸåè§£æéœ€è¦ç»è¿‡ 4 è½®è§£ææ‰èƒ½æˆåŠŸï¼Œé›†ç¾¤ä¸­å……æ–¥ç€å¤§é‡æ— ç”¨çš„ DNS è¯·æ±‚ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥è®¾ç½®è¾ƒå°çš„ ndotsï¼Œåœ¨ Pod çš„ &lt;code&gt;dnsConfig&lt;/code&gt; ä¸­å¯ä»¥è®¾ç½®&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;containers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;nginxv1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;image&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;nginx:latest&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;resources&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;terminationMessagePath&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;/dev/termination-log&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;terminationMessagePolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;File&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;imagePullPolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;Always&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;securityContext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;privileged&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# åŠ å…¥dnsConfigè¿›è¡Œè®¾ç½® &lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;dnsConfig&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;options&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;ndots&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç„¶åä¸šåŠ¡å‘è¯·æ±‚æ—¶å°½é‡å°† service åŸŸåæ‹¼å®Œæ•´ï¼Œè¿™æ ·å°±ä¸ä¼šç»è¿‡ search æ‹¼æ¥é€ æˆå¤§é‡å¤šä½™çš„ DNS è¯·æ±‚ã€‚&lt;/p&gt;
&lt;p&gt;ä¸è¿‡è¿™æ ·ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„åŠæ³•å‘¢ï¼Ÿæœ‰çš„ï¼è¯·çœ‹ä¸‹é¢çš„ &lt;code&gt;autopath&lt;/code&gt; æ–¹å¼ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¯ç”¨autopath&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¯ç”¨ CoreDNS çš„ autopath æ’ä»¶å¯ä»¥é¿å…æ¯æ¬¡åŸŸåè§£æç»è¿‡å¤šæ¬¡è¯·æ±‚æ‰èƒ½è§£æåˆ°ï¼ŒåŸç†æ˜¯ CoreDNS æ™ºèƒ½è¯†åˆ«æ‹¼æ¥è¿‡ search çš„ DNS è§£æï¼Œç›´æ¥å“åº” CNAME å¹¶é™„ä¸Šç›¸åº”çš„ ClusterIPï¼Œä¸€æ­¥åˆ°ä½ï¼Œå¯ä»¥æå¤§å‡å°‘é›†ç¾¤å†… DNS è¯·æ±‚æ•°é‡ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;l&#34;&gt;kubectl -n kube-system edit configmap coredns&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;{&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;#34;Corefile&amp;#34;: &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;#34;.:53 {&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;errors&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;health {&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;lameduck 5s&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;ready&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;kubernetes cluster.local in-addr.arpa ip6.arpa {&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;pods insecure&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# ä¿®æ”¹ä¸º pods verified&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;fallthrough in-addr.arpa ip6.arpa&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;ttl 30&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;autopath @kubernetes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# æ·»åŠ autopath @kubernetes&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;prometheus :9153&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;forward . /etc/resolv.conf {&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;max_concurrent 1000&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;template ANY AAAA {&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;rcode NXDOMAIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;cache 30&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;loop&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;reload&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;loadbalance&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯ç”¨ autopath åï¼Œç”±äº coredns éœ€è¦ watch æ‰€æœ‰çš„ podï¼Œä¼šå¢åŠ  coredns çš„å†…å­˜æ¶ˆè€—ï¼Œæ ¹æ®æƒ…å†µé€‚å½“è°ƒèŠ‚ coredns çš„ &lt;code&gt;memory request&lt;/code&gt; å’Œ limitã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœ‰å…´è¶£çš„å¯ä»¥å»çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š&lt;a class=&#34;link&#34; href=&#34;https://draveness.me/dns-coredns/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;è¯¦è§£DNSå’ŒCoreDNS&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        </item>
        
    </channel>
</rss>
