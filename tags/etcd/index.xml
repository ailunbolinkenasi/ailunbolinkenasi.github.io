<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<<<<<<< HEAD
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Etcd on Heartbeat Diary</title>
    <link>https://blog.mletter.cn/tags/etcd/</link>
    <description>Recent content in Etcd on Heartbeat Diary</description>
    <generator>Hugo -- 0.146.5</generator>
    <language>zh</language>
    <lastBuildDate>Sun, 26 Feb 2023 00:00:00 +0000</lastBuildDate>
    <atom:link href="https://blog.mletter.cn/tags/etcd/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>ä½¿ç”¨Kubeadmåˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„ETCDé›†ç¾¤</title>
      <link>https://blog.mletter.cn/tech/kubernetes/install-etcd-ha/</link>
      <pubDate>Sun, 26 Feb 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/install-etcd-ha/</guid>
      <description>é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeadm åœ¨æ¯ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªæœ¬åœ° etcd å®ä¾‹ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ etcd é›†ç¾¤ï¼Œå¹¶åœ¨ä¸åŒçš„ä¸»æœºä¸Šæä¾› etcd å®ä¾‹ã€‚ è¿™ä¸¤ç§æ–¹æ³•çš„åŒºåˆ«åœ¨ é«˜å¯ç”¨æ‹“æ‰‘çš„é€‰é¡¹ é¡µé¢ä¸­é˜è¿°ã€‚è¿™ä¸ªä»»åŠ¡å°†æŒ‡å¯¼ä½ åˆ›å»ºä¸€ä¸ªç”±ä¸‰ä¸ªæˆå‘˜ç»„æˆçš„é«˜å¯ç”¨å¤–éƒ¨ etcd é›†ç¾¤ï¼Œè¯¥é›†ç¾¤åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å¯è¢« kubeadm ä½¿ç”¨ã€‚</description>
      <content:encoded><![CDATA[<h2 id="ä½¿ç”¨kubeadmåˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„etcdé›†ç¾¤">ä½¿ç”¨Kubeadmåˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„Etcdé›†ç¾¤</h2>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeadm åœ¨æ¯ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªæœ¬åœ° etcd å®ä¾‹ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ etcd é›†ç¾¤ï¼Œå¹¶åœ¨ä¸åŒçš„ä¸»æœºä¸Šæä¾› etcd å®ä¾‹ã€‚ è¿™ä¸¤ç§æ–¹æ³•çš„åŒºåˆ«åœ¨ é«˜å¯ç”¨æ‹“æ‰‘çš„é€‰é¡¹ é¡µé¢ä¸­é˜è¿°ã€‚</p>
<p>è¿™ä¸ªä»»åŠ¡å°†æŒ‡å¯¼ä½ åˆ›å»ºä¸€ä¸ªç”±ä¸‰ä¸ªæˆå‘˜ç»„æˆçš„é«˜å¯ç”¨å¤–éƒ¨ etcd é›†ç¾¤ï¼Œè¯¥é›†ç¾¤åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å¯è¢« kubeadm ä½¿ç”¨ã€‚</p>
<h2 id="å‡†å¤‡å¼€å§‹">å‡†å¤‡å¼€å§‹</h2>
<ul>
<li>ä¸‰ä¸ªå¯ä»¥é€šè¿‡ 2379 å’Œ 2380 ç«¯å£ç›¸äº’é€šä¿¡çš„ä¸»æœºã€‚æœ¬æ–‡æ¡£ä½¿ç”¨è¿™äº›ä½œä¸ºé»˜è®¤ç«¯å£ã€‚ä¸è¿‡ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡ kubeadm çš„é…ç½®æ–‡ä»¶è¿›è¡Œè‡ªå®šä¹‰ã€‚</li>
<li>æ¯ä¸ªä¸»æœºå¿…é¡»å®‰è£… systemd å’Œ bash å…¼å®¹çš„ shellã€‚</li>
<li>æ¯å°ä¸»æœºå¿…é¡»å®‰è£…<code>æœ‰å®¹å™¨è¿è¡Œæ—¶</code>ã€<code>kubelet</code> å’Œ <code>kubeadm</code></li>
<li>æ¯ä¸ªä¸»æœºéƒ½åº”è¯¥èƒ½å¤Ÿè®¿é—® Kubernetes å®¹å™¨é•œåƒä»“åº“ (<a href="http://registry.k8s.io/">registry.k8s.io</a>)ï¼Œ æˆ–è€…ä½¿ç”¨ kubeadm config images list/pull åˆ—å‡º/æ‹‰å–æ‰€éœ€çš„ etcd é•œåƒã€‚ æœ¬æŒ‡å—å°†æŠŠ etcd å®ä¾‹è®¾ç½®ä¸ºç”± kubelet ç®¡ç†çš„é™æ€ Podã€‚</li>
<li>ä¸€äº›å¯ä»¥ç”¨æ¥åœ¨ä¸»æœºé—´å¤åˆ¶æ–‡ä»¶çš„åŸºç¡€è®¾æ–½ã€‚ä¾‹å¦‚ ssh å’Œ scp å°±å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚</li>
</ul>
<blockquote>
<p>æœ¬æ¬¡å®¹å™¨è¿è¡Œæ—¶é‡‡ç”¨<code>Containerd</code>ä½œä¸ºRuntime</p></blockquote>
<h3 id="å°†kubeleté…ç½®ä¸ºetcdçš„æœåŠ¡å¯åŠ¨ç®¡ç†å™¨">å°†Kubeleté…ç½®ä¸ºEtcdçš„æœåŠ¡å¯åŠ¨ç®¡ç†å™¨</h3>
<blockquote>
<p>ä½ å¿…é¡»åœ¨è¦è¿è¡Œ etcd çš„æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œæ­¤æ“ä½œã€‚</p></blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF &gt; /usr/lib/systemd/system/kubelet.service.d/20-etcd-service-manager.conf 
</span></span></span><span class="line"><span class="cl"><span class="s">[Service]
</span></span></span><span class="line"><span class="cl"><span class="s">ExecStart=
</span></span></span><span class="line"><span class="cl"><span class="s">ExecStart=/usr/bin/kubelet --address=127.0.0.1 --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=systemd  --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock
</span></span></span><span class="line"><span class="cl"><span class="s">Restart=always
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>å¯åŠ¨kubelet</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl daemon-reload
</span></span><span class="line"><span class="cl">systemctl restart kubelet
</span></span></code></pre></div><blockquote>
<p>æ³¨æ„: è¯·æ‰§è¡Œå®Œæ¯•ååŠ¡å¿…ç¡®ä¿<code>kubelet</code>å¤„äº<code>running</code>çŠ¶æ€ã€‚</p></blockquote>
<h3 id="ä¸ºkubeadmåˆ›å»ºé…ç½®æ–‡ä»¶">ä¸ºKubeadmåˆ›å»ºé…ç½®æ–‡ä»¶</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ä½¿ç”¨ä½ çš„ä¸»æœº IP æ›¿æ¢ HOST0ã€HOST1 å’Œ HOST2 çš„ IP åœ°å€</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HOST0</span><span class="o">=</span>10.1.6.48
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HOST1</span><span class="o">=</span>10.1.6.24
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HOST2</span><span class="o">=</span>10.1.6.45
</span></span><span class="line"><span class="cl"><span class="c1"># ä½¿ç”¨ä½ çš„ä¸»æœºåæ›´æ–° NAME0ã€NAME1 å’Œ NAME2</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NAME0</span><span class="o">=</span><span class="s2">&#34;containerd-master1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NAME1</span><span class="o">=</span><span class="s2">&#34;containerd-master2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NAME2</span><span class="o">=</span><span class="s2">&#34;containerd-master3&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºä¸´æ—¶ç›®å½•æ¥å­˜å‚¨å°†è¢«åˆ†å‘åˆ°å…¶å®ƒä¸»æœºä¸Šçš„æ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">mkdir -p /tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/ /tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/ /tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">HOSTS</span><span class="o">=(</span><span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span> <span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span> <span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">NAMES</span><span class="o">=(</span><span class="si">${</span><span class="nv">NAME0</span><span class="si">}</span> <span class="si">${</span><span class="nv">NAME1</span><span class="si">}</span> <span class="si">${</span><span class="nv">NAME2</span><span class="si">}</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="s2">&#34;</span><span class="si">${</span><span class="p">!HOSTS[@]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl"><span class="nv">HOST</span><span class="o">=</span><span class="si">${</span><span class="nv">HOSTS</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAMES</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF &gt; /tmp/${HOST}/kubeadmcfg.yaml
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: &#34;kubeadm.k8s.io/v1beta3&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">kind: InitConfiguration
</span></span></span><span class="line"><span class="cl"><span class="s">nodeRegistration:
</span></span></span><span class="line"><span class="cl"><span class="s">    name: ${NAME}
</span></span></span><span class="line"><span class="cl"><span class="s">localAPIEndpoint:
</span></span></span><span class="line"><span class="cl"><span class="s">    advertiseAddress: ${HOST}
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: &#34;kubeadm.k8s.io/v1beta3&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ClusterConfiguration
</span></span></span><span class="line"><span class="cl"><span class="s">etcd:
</span></span></span><span class="line"><span class="cl"><span class="s">    local:
</span></span></span><span class="line"><span class="cl"><span class="s">        dataDir: /var/lib/etcds
</span></span></span><span class="line"><span class="cl"><span class="s">        serverCertSANs:
</span></span></span><span class="line"><span class="cl"><span class="s">        - &#34;${HOST}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        peerCertSANs:
</span></span></span><span class="line"><span class="cl"><span class="s">        - &#34;${HOST}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        extraArgs:
</span></span></span><span class="line"><span class="cl"><span class="s">            initial-cluster: ${NAMES[0]}=https://${HOSTS[0]}:2380,${NAMES[1]}=https://${HOSTS[1]}:2380,${NAMES[2]}=https://${HOSTS[2]}:2380
</span></span></span><span class="line"><span class="cl"><span class="s">            initial-cluster-state: new
</span></span></span><span class="line"><span class="cl"><span class="s">            name: ${NAME}
</span></span></span><span class="line"><span class="cl"><span class="s">            listen-peer-urls: https://${HOST}:2380
</span></span></span><span class="line"><span class="cl"><span class="s">            listen-client-urls: https://${HOST}:2379
</span></span></span><span class="line"><span class="cl"><span class="s">            advertise-client-urls: https://${HOST}:2379
</span></span></span><span class="line"><span class="cl"><span class="s">            initial-advertise-peer-urls: https://${HOST}:2380
</span></span></span><span class="line"><span class="cl"><span class="s">imageRepository: registry.aliyuncs.com/google_containers
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><h3 id="ç”Ÿæˆè¯ä¹¦é¢å‘æœºæ„">ç”Ÿæˆè¯ä¹¦é¢å‘æœºæ„</h3>
<p>å¦‚æœä½ è¿˜æ²¡æœ‰ CAï¼Œåˆ™åœ¨ $HOST0ï¼ˆä½ ä¸º kubeadm ç”Ÿæˆé…ç½®æ–‡ä»¶çš„ä½ç½®ï¼‰ä¸Šè¿è¡Œæ­¤å‘½ä»¤ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init phase certs etcd-ca
</span></span></code></pre></div><ul>
<li>è¿™ä¸€æ“ä½œå°†ä¼šç”Ÿæˆ
<ul>
<li><code>/etc/kubernetes/pki/etcd/ca.crt</code></li>
<li><code>/etc/kubernetes/pki/etcd/ca.key</code></li>
</ul>
</li>
</ul>
<h3 id="ä¸ºæ¯ä¸ªæˆå‘˜åˆ›å»ºè¯ä¹¦">ä¸ºæ¯ä¸ªæˆå‘˜åˆ›å»ºè¯ä¹¦</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init phase certs etcd-server --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-peer --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-healthcheck-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs apiserver-etcd-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">cp -R /etc/kubernetes/pki /tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl"><span class="c1"># æ¸…ç†ä¸å¯é‡å¤ä½¿ç”¨çš„è¯ä¹¦</span>
</span></span><span class="line"><span class="cl">find /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-server --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-peer --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-healthcheck-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs apiserver-etcd-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">cp -R /etc/kubernetes/pki /tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">find /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># HOST0ä¸éœ€è¦è¿›è¡Œç§»åŠ¨</span>
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-server --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-peer --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-healthcheck-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs apiserver-etcd-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span></code></pre></div><h3 id="å¤åˆ¶è¯ä¹¦å’Œ-kubeadm-é…ç½®">å¤åˆ¶è¯ä¹¦å’Œ kubeadm é…ç½®</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">scp -r /tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/* root@<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>:
</span></span><span class="line"><span class="cl">scp -r /tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/* root@<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>:
</span></span><span class="line"><span class="cl">chown -R root:root pki/
</span></span><span class="line"><span class="cl">mv pki /etc/kubernetes/
</span></span></code></pre></div><h3 id="è¯·æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨">è¯·æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨</h3>
<p>æ£€æŸ¥<code>$HOST0</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-master1 ~<span class="o">]</span><span class="c1"># tree /etc/kubernetes/pki/</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.crt
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.key
</span></span><span class="line"><span class="cl">â””â”€â”€ etcd
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ ca.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ ca.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ server.crt
</span></span><span class="line"><span class="cl">    â””â”€â”€ server.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> directory, <span class="m">10</span> files
</span></span></code></pre></div><p>æ£€æŸ¥<code>$HOST1</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-master2 ~<span class="o">]</span><span class="c1"># tree /etc/kubernetes/pki/</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.crt
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.key
</span></span><span class="line"><span class="cl">â””â”€â”€ etcd
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ ca.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ server.crt
</span></span><span class="line"><span class="cl">    â””â”€â”€ server.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> directory, <span class="m">9</span> files
</span></span></code></pre></div><p>æ£€æŸ¥<code>$HOST2</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-master3 ~<span class="o">]</span><span class="c1"># tree /etc/kubernetes/pki/</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.crt
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.key
</span></span><span class="line"><span class="cl">â””â”€â”€ etcd
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ ca.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ server.crt
</span></span><span class="line"><span class="cl">    â””â”€â”€ server.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> directory, <span class="m">9</span> files
</span></span></code></pre></div><h3 id="åˆ›å»ºetcdçš„podæ¸…å•">åˆ›å»ºEtcdçš„Podæ¸…å•</h3>
<p>è¯·åœ¨<code>$HOST0</code>è¿›è¡Œæ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init phase etcd <span class="nb">local</span> --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span></code></pre></div><p>è¯·åœ¨<code>$HOST1</code>è¿›è¡Œæ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init phase etcd <span class="nb">local</span> --config<span class="o">=</span><span class="nv">$HOME</span>/kubeadmcfg.yaml
</span></span></code></pre></div><p>è¯·åœ¨<code>$HOST2</code>è¿›è¡Œæ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init phase etcd <span class="nb">local</span> --config<span class="o">=</span><span class="nv">$HOME</span>/kubeadmcfg.yaml
</span></span></code></pre></div><h3 id="æ£€æŸ¥etcdçš„podæ˜¯å¦è¿è¡Œ">æ£€æŸ¥Etcdçš„Podæ˜¯å¦è¿è¡Œ</h3>
<ul>
<li>ä¸‰å°Etcdä¸»æœºå…¨éƒ¨ä½¿ç”¨<code>crictl ps -a </code>è¿›è¡ŒæŸ¥çœ‹EtcdPodæ˜¯å¦å¤„äº<code>running</code>çŠ¶æ€</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-master1 ~<span class="o">]</span><span class="c1"># crictl ps -a</span>
</span></span><span class="line"><span class="cl">CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD
</span></span><span class="line"><span class="cl">0a183925d2542       <span class="m">0048118155842</span>       <span class="m">52</span> seconds ago      Running     
</span></span></code></pre></div>]]></content:encoded>
    </item>
  </channel>
=======
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Etcd on å¤ªé˜³å¯ä»¥æ˜¯è“è‰²</title>
        <link>https://blog.mletter.cn/tags/etcd/</link>
        <description>Recent content in Etcd on å¤ªé˜³å¯ä»¥æ˜¯è“è‰²</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <copyright>Live and learn. ğŸŒ±</copyright>
        <lastBuildDate>Sun, 26 Feb 2023 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.mletter.cn/tags/etcd/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>ä½¿ç”¨Kubeadmåˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„ETCDé›†ç¾¤</title>
        <link>https://blog.mletter.cn/tech/kubernetes/install-etcd-ha/</link>
        <pubDate>Sun, 26 Feb 2023 00:00:00 +0000</pubDate>
        
        <guid>https://blog.mletter.cn/tech/kubernetes/install-etcd-ha/</guid>
        <description>&lt;img src="https://img.linux.net.cn/data/attachment/album/201501/29/141718izklanww82qm888k.png" alt="Featured image of post ä½¿ç”¨Kubeadmåˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„ETCDé›†ç¾¤" /&gt;&lt;h2 id=&#34;ä½¿ç”¨kubeadmåˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„etcdé›†ç¾¤&#34;&gt;&lt;/h&gt;ä½¿ç”¨Kubeadmåˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„Etcdé›†ç¾¤
&lt;/h2&gt;&lt;p&gt;é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeadm åœ¨æ¯ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªæœ¬åœ° etcd å®ä¾‹ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ etcd é›†ç¾¤ï¼Œå¹¶åœ¨ä¸åŒçš„ä¸»æœºä¸Šæä¾› etcd å®ä¾‹ã€‚ è¿™ä¸¤ç§æ–¹æ³•çš„åŒºåˆ«åœ¨ é«˜å¯ç”¨æ‹“æ‰‘çš„é€‰é¡¹ é¡µé¢ä¸­é˜è¿°ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªä»»åŠ¡å°†æŒ‡å¯¼ä½ åˆ›å»ºä¸€ä¸ªç”±ä¸‰ä¸ªæˆå‘˜ç»„æˆçš„é«˜å¯ç”¨å¤–éƒ¨ etcd é›†ç¾¤ï¼Œè¯¥é›†ç¾¤åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å¯è¢« kubeadm ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å‡†å¤‡å¼€å§‹&#34;&gt;&lt;/h&gt;å‡†å¤‡å¼€å§‹
&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;ä¸‰ä¸ªå¯ä»¥é€šè¿‡ 2379 å’Œ 2380 ç«¯å£ç›¸äº’é€šä¿¡çš„ä¸»æœºã€‚æœ¬æ–‡æ¡£ä½¿ç”¨è¿™äº›ä½œä¸ºé»˜è®¤ç«¯å£ã€‚ä¸è¿‡ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡ kubeadm çš„é…ç½®æ–‡ä»¶è¿›è¡Œè‡ªå®šä¹‰ã€‚&lt;/li&gt;
&lt;li&gt;æ¯ä¸ªä¸»æœºå¿…é¡»å®‰è£… systemd å’Œ bash å…¼å®¹çš„ shellã€‚&lt;/li&gt;
&lt;li&gt;æ¯å°ä¸»æœºå¿…é¡»å®‰è£…&lt;code&gt;æœ‰å®¹å™¨è¿è¡Œæ—¶&lt;/code&gt;ã€&lt;code&gt;kubelet&lt;/code&gt; å’Œ &lt;code&gt;kubeadm&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;æ¯ä¸ªä¸»æœºéƒ½åº”è¯¥èƒ½å¤Ÿè®¿é—® Kubernetes å®¹å™¨é•œåƒä»“åº“ (&lt;a class=&#34;link&#34; href=&#34;http://registry.k8s.io/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;registry.k8s.io&lt;/a&gt;)ï¼Œ æˆ–è€…ä½¿ç”¨ kubeadm config images list/pull åˆ—å‡º/æ‹‰å–æ‰€éœ€çš„ etcd é•œåƒã€‚ æœ¬æŒ‡å—å°†æŠŠ etcd å®ä¾‹è®¾ç½®ä¸ºç”± kubelet ç®¡ç†çš„é™æ€ Podã€‚&lt;/li&gt;
&lt;li&gt;ä¸€äº›å¯ä»¥ç”¨æ¥åœ¨ä¸»æœºé—´å¤åˆ¶æ–‡ä»¶çš„åŸºç¡€è®¾æ–½ã€‚ä¾‹å¦‚ ssh å’Œ scp å°±å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ¬æ¬¡å®¹å™¨è¿è¡Œæ—¶é‡‡ç”¨&lt;code&gt;Containerd&lt;/code&gt;ä½œä¸ºRuntime&lt;/p&gt;&lt;/blockquote&gt;
&lt;h3 id=&#34;å°†kubeleté…ç½®ä¸ºetcdçš„æœåŠ¡å¯åŠ¨ç®¡ç†å™¨&#34;&gt;&lt;/h&gt;å°†Kubeleté…ç½®ä¸ºEtcdçš„æœåŠ¡å¯åŠ¨ç®¡ç†å™¨
&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;ä½ å¿…é¡»åœ¨è¦è¿è¡Œ etcd çš„æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œæ­¤æ“ä½œã€‚&lt;/p&gt;&lt;/blockquote&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cat &lt;span class=&#34;s&#34;&gt;&amp;lt;&amp;lt; EOF &amp;gt; /usr/lib/systemd/system/kubelet.service.d/20-etcd-service-manager.conf 
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;[Service]
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;ExecStart=
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;ExecStart=/usr/bin/kubelet --address=127.0.0.1 --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=systemd  --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;Restart=always
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;EOF&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯åŠ¨kubelet&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;systemctl daemon-reload
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;systemctl restart kubelet
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;æ³¨æ„: è¯·æ‰§è¡Œå®Œæ¯•ååŠ¡å¿…ç¡®ä¿&lt;code&gt;kubelet&lt;/code&gt;å¤„äº&lt;code&gt;running&lt;/code&gt;çŠ¶æ€ã€‚&lt;/p&gt;&lt;/blockquote&gt;
&lt;h3 id=&#34;ä¸ºkubeadmåˆ›å»ºé…ç½®æ–‡ä»¶&#34;&gt;&lt;/h&gt;ä¸ºKubeadmåˆ›å»ºé…ç½®æ–‡ä»¶
&lt;/h3&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# ä½¿ç”¨ä½ çš„ä¸»æœº IP æ›¿æ¢ HOST0ã€HOST1 å’Œ HOST2 çš„ IP åœ°å€&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;HOST0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;10.1.6.48
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;HOST1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;10.1.6.24
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;HOST2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;10.1.6.45
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# ä½¿ç”¨ä½ çš„ä¸»æœºåæ›´æ–° NAME0ã€NAME1 å’Œ NAME2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;NAME0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;containerd-master1&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;NAME1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;containerd-master2&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;NAME2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;containerd-master3&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# åˆ›å»ºä¸´æ—¶ç›®å½•æ¥å­˜å‚¨å°†è¢«åˆ†å‘åˆ°å…¶å®ƒä¸»æœºä¸Šçš„æ–‡ä»¶&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mkdir -p /tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST0&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/ /tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST1&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/ /tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST2&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;HOSTS&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=(&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST0&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST1&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST2&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;NAMES&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=(&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;NAME0&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;NAME1&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;NAME2&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; i in &lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;!HOSTS[@]&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;HOST&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOSTS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;NAME&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;NAMES&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cat &lt;span class=&#34;s&#34;&gt;&amp;lt;&amp;lt; EOF &amp;gt; /tmp/${HOST}/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;---
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;apiVersion: &amp;#34;kubeadm.k8s.io/v1beta3&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;kind: InitConfiguration
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;nodeRegistration:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;    name: ${NAME}
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;localAPIEndpoint:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;    advertiseAddress: ${HOST}
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;---
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;apiVersion: &amp;#34;kubeadm.k8s.io/v1beta3&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;kind: ClusterConfiguration
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;etcd:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;    local:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;        dataDir: /var/lib/etcds
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;        serverCertSANs:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;        - &amp;#34;${HOST}&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;        peerCertSANs:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;        - &amp;#34;${HOST}&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;        extraArgs:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;            initial-cluster: ${NAMES[0]}=https://${HOSTS[0]}:2380,${NAMES[1]}=https://${HOSTS[1]}:2380,${NAMES[2]}=https://${HOSTS[2]}:2380
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;            initial-cluster-state: new
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;            name: ${NAME}
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;            listen-peer-urls: https://${HOST}:2380
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;            listen-client-urls: https://${HOST}:2379
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;            advertise-client-urls: https://${HOST}:2379
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;            initial-advertise-peer-urls: https://${HOST}:2380
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;imageRepository: registry.aliyuncs.com/google_containers
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s&#34;&gt;EOF&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;done&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;ç”Ÿæˆè¯ä¹¦é¢å‘æœºæ„&#34;&gt;&lt;/h&gt;ç”Ÿæˆè¯ä¹¦é¢å‘æœºæ„
&lt;/h3&gt;&lt;p&gt;å¦‚æœä½ è¿˜æ²¡æœ‰ CAï¼Œåˆ™åœ¨ $HOST0ï¼ˆä½ ä¸º kubeadm ç”Ÿæˆé…ç½®æ–‡ä»¶çš„ä½ç½®ï¼‰ä¸Šè¿è¡Œæ­¤å‘½ä»¤ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs etcd-ca
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;è¿™ä¸€æ“ä½œå°†ä¼šç”Ÿæˆ
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/etc/kubernetes/pki/etcd/ca.crt&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/etc/kubernetes/pki/etcd/ca.key&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;ä¸ºæ¯ä¸ªæˆå‘˜åˆ›å»ºè¯ä¹¦&#34;&gt;&lt;/h&gt;ä¸ºæ¯ä¸ªæˆå‘˜åˆ›å»ºè¯ä¹¦
&lt;/h3&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs etcd-server --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST2&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs etcd-peer --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST2&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs etcd-healthcheck-client --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST2&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs apiserver-etcd-client --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST2&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cp -R /etc/kubernetes/pki /tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST2&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# æ¸…ç†ä¸å¯é‡å¤ä½¿ç”¨çš„è¯ä¹¦&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;find /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs etcd-server --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST1&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs etcd-peer --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST1&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs etcd-healthcheck-client --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST1&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs apiserver-etcd-client --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST1&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cp -R /etc/kubernetes/pki /tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST1&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;find /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# HOST0ä¸éœ€è¦è¿›è¡Œç§»åŠ¨&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs etcd-server --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST0&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs etcd-peer --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST0&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs etcd-healthcheck-client --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST0&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase certs apiserver-etcd-client --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST0&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;å¤åˆ¶è¯ä¹¦å’Œ-kubeadm-é…ç½®&#34;&gt;&lt;/h&gt;å¤åˆ¶è¯ä¹¦å’Œ kubeadm é…ç½®
&lt;/h3&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;scp -r /tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST1&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/* root@&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST1&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;scp -r /tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST2&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/* root@&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST2&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;chown -R root:root pki/
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mv pki /etc/kubernetes/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;è¯·æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨&#34;&gt;&lt;/h&gt;è¯·æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨
&lt;/h3&gt;&lt;p&gt;æ£€æŸ¥&lt;code&gt;$HOST0&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;root@containerd-master1 ~&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# tree /etc/kubernetes/pki/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;/etc/kubernetes/pki/
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;â”œâ”€â”€ apiserver-etcd-client.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;â”œâ”€â”€ apiserver-etcd-client.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;â””â”€â”€ etcd
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ ca.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ ca.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ healthcheck-client.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ healthcheck-client.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ peer.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ peer.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ server.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â””â”€â”€ server.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; directory, &lt;span class=&#34;m&#34;&gt;10&lt;/span&gt; files
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ£€æŸ¥&lt;code&gt;$HOST1&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;root@containerd-master2 ~&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# tree /etc/kubernetes/pki/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;/etc/kubernetes/pki/
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;â”œâ”€â”€ apiserver-etcd-client.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;â”œâ”€â”€ apiserver-etcd-client.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;â””â”€â”€ etcd
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ ca.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ healthcheck-client.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ healthcheck-client.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ peer.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ peer.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ server.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â””â”€â”€ server.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; directory, &lt;span class=&#34;m&#34;&gt;9&lt;/span&gt; files
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ£€æŸ¥&lt;code&gt;$HOST2&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;root@containerd-master3 ~&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# tree /etc/kubernetes/pki/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;/etc/kubernetes/pki/
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;â”œâ”€â”€ apiserver-etcd-client.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;â”œâ”€â”€ apiserver-etcd-client.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;â””â”€â”€ etcd
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ ca.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ healthcheck-client.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ healthcheck-client.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ peer.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ peer.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â”œâ”€â”€ server.crt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    â””â”€â”€ server.key
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; directory, &lt;span class=&#34;m&#34;&gt;9&lt;/span&gt; files
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;åˆ›å»ºetcdçš„podæ¸…å•&#34;&gt;&lt;/h&gt;åˆ›å»ºEtcdçš„Podæ¸…å•
&lt;/h3&gt;&lt;p&gt;è¯·åœ¨&lt;code&gt;$HOST0&lt;/code&gt;è¿›è¡Œæ‰§è¡Œ&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase etcd &lt;span class=&#34;nb&#34;&gt;local&lt;/span&gt; --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/tmp/&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;HOST0&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¯·åœ¨&lt;code&gt;$HOST1&lt;/code&gt;è¿›è¡Œæ‰§è¡Œ&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase etcd &lt;span class=&#34;nb&#34;&gt;local&lt;/span&gt; --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¯·åœ¨&lt;code&gt;$HOST2&lt;/code&gt;è¿›è¡Œæ‰§è¡Œ&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubeadm init phase etcd &lt;span class=&#34;nb&#34;&gt;local&lt;/span&gt; --config&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/kubeadmcfg.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;æ£€æŸ¥etcdçš„podæ˜¯å¦è¿è¡Œ&#34;&gt;&lt;/h&gt;æ£€æŸ¥Etcdçš„Podæ˜¯å¦è¿è¡Œ
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ä¸‰å°Etcdä¸»æœºå…¨éƒ¨ä½¿ç”¨&lt;code&gt;crictl ps -a &lt;/code&gt;è¿›è¡ŒæŸ¥çœ‹EtcdPodæ˜¯å¦å¤„äº&lt;code&gt;running&lt;/code&gt;çŠ¶æ€&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;root@containerd-master1 ~&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# crictl ps -a&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;0a183925d2542       &lt;span class=&#34;m&#34;&gt;0048118155842&lt;/span&gt;       &lt;span class=&#34;m&#34;&gt;52&lt;/span&gt; seconds ago      Running     
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
        </item>
        
    </channel>
>>>>>>> e6c11e7684b5a835a7809ddc8609bc9f39cdf2c5
</rss>
