<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Kubernetes on å¤ªé˜³å¯ä»¥æ˜¯è“è‰²</title>
    <link>https://blog.mletter.cn/tags/kubernetes/</link>
    <description>Recent content in Kubernetes on å¤ªé˜³å¯ä»¥æ˜¯è“è‰²</description>
    <image>
      <title>å¤ªé˜³å¯ä»¥æ˜¯è“è‰²</title>
      <url>https://blog.mletter.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</url>
      <link>https://blog.mletter.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</link>
    </image>
    <generator>Hugo -- 0.138.0</generator>
    <language>zh</language>
    <lastBuildDate>Mon, 15 Apr 2024 00:00:00 +0000</lastBuildDate>
    <atom:link href="https://blog.mletter.cn/tags/kubernetes/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>åŸºäºSealOSéƒ¨ç½²é«˜å¯ç”¨çš„kubernetesé›†ç¾¤</title>
      <link>https://blog.mletter.cn/tech/kubernetes/sealos/</link>
      <pubDate>Mon, 15 Apr 2024 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/sealos/</guid>
      <description>åŸºäºSealOSæ¥éƒ¨ç½²é«˜å¯ç”¨çš„kubernetesé›†ç¾¤</description>
      <content:encoded><![CDATA[<p>é…å¥—Bilibiliè§†é¢‘å·²ç»æ›´æ–°ï¼š<a class="link" href="https://www.bilibili.com/video/BV1Pr421V7PT/?share_source=copy_web&amp;vd_source=2cac9fa5f0a3fb896b7f6b1468993554"  target="_blank" rel="noopener"
    >ç‚¹æˆ‘è§‚çœ‹</a></p>
<h2 id="å‡†å¤‡sealos">å‡†å¤‡SealOS</h2>
<p>æœºå™¨ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<table>
  <thead>
      <tr>
          <th>æœåŠ¡å™¨åç§°</th>
          <th>IP</th>
          <th>Role</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ready-kubernetes-master1</td>
          <td>10.1.11.100</td>
          <td>Control-Plane</td>
      </tr>
      <tr>
          <td>ready-kubernetes-master2</td>
          <td>10.1.11.101</td>
          <td>Control-Plane</td>
      </tr>
      <tr>
          <td>ready-kubernetes-master3</td>
          <td>10.1.11.102</td>
          <td>Control-Plane</td>
      </tr>
      <tr>
          <td>ready-kubernetes-node1</td>
          <td>10.1.11.103</td>
          <td>Node</td>
      </tr>
      <tr>
          <td>ready-kubernetes-node2</td>
          <td>10.1.11.104</td>
          <td>Node</td>
      </tr>
      <tr>
          <td>ready-kubernetes-node3</td>
          <td>10.1.11.105</td>
          <td>Node</td>
      </tr>
  </tbody>
</table>
<h3 id="é€šè¿‡sealoséƒ¨ç½²çš„å‰ææ¡ä»¶">é€šè¿‡SealOSéƒ¨ç½²çš„å‰ææ¡ä»¶</h3>
<ul>
<li>
<p><a class="link" href="https://sealos.io/zh-Hans/docs/self-hosting/lifecycle-management/quick-start/deploy-kubernetes"  target="_blank" rel="noopener"
    >SealOS For Kubernetes</a></p>
</li>
<li>
<p>æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹åº”è¯¥æœ‰ä¸åŒçš„ä¸»æœºåã€‚ä¸»æœºåä¸è¦å¸¦ä¸‹åˆ’çº¿ã€‚</p>
</li>
<li>
<p>æ‰€æœ‰èŠ‚ç‚¹çš„æ—¶é—´éœ€è¦åŒæ­¥ã€‚</p>
</li>
<li>
<p>éœ€è¦åœ¨ K8s é›†ç¾¤çš„ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ä¸Šè¿è¡Œ sealos run å‘½ä»¤ï¼Œç›®å‰é›†ç¾¤å¤–çš„èŠ‚ç‚¹ä¸æ”¯æŒé›†ç¾¤å®‰è£…ã€‚</p>
</li>
<li>
<p>å»ºè®®ä½¿ç”¨å¹²å‡€çš„æ“ä½œç³»ç»Ÿæ¥åˆ›å»ºé›†ç¾¤ã€‚ä¸è¦è‡ªå·±è£… <code>Docker</code>ï¼</p>
</li>
<li>
<p>æ”¯æŒå¤§å¤šæ•° Linux å‘è¡Œç‰ˆï¼Œä¾‹å¦‚ï¼šUbuntuã€CentOSã€Rocky linuxã€‚</p>
</li>
<li>
<p>æ”¯æŒ Docker Hub ä¸­çš„æ‰€æœ‰ Kubernetes ç‰ˆæœ¬ã€‚</p>
</li>
<li>
<p>æ”¯æŒä½¿ç”¨ Containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ã€‚</p>
</li>
<li>
<p>åœ¨å…¬æœ‰äº‘ä¸Šå®‰è£…è¯·ä½¿ç”¨ç§æœ‰ IPã€‚</p>
</li>
</ul>
<ol>
<li>è·å–å½“å‰ç¨³å®šç‰ˆæœ¬çš„<code>SealOS</code>åˆ—è¡¨</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># è·å–ébetaç‰ˆæœ¬</span>
</span></span><span class="line"><span class="cl">curl --silent <span class="s2">&#34;https://api.github.com/repos/labring/sealos/releases&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;map(select(.tag_name | test(&#34;beta&#34;; &#34;i&#34;) | not)) | .[].tag_name&#39;</span>
</span></span></code></pre></div><ol start="2">
<li>ä¸‹è½½æœ€æ–°ç¨³å®šç‰ˆæœ¬çš„<code>SealOS</code>ï¼Œç‰ˆæœ¬å·ä¸º<code>v4.3.7</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># åœ¨ä¸€å°ä¸»æœºä¸Šæ‰§è¡Œå°±è¡Œäº†</span>
</span></span><span class="line"><span class="cl"><span class="nv">VERSION</span><span class="o">=</span>v4.3.7
</span></span><span class="line"><span class="cl">wget https://mirror.ghproxy.com/https://github.com/labring/sealos/releases/download/<span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span>/sealos_<span class="si">${</span><span class="nv">VERSION</span><span class="p">#v</span><span class="si">}</span>_linux_amd64.tar.gz <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="o">&amp;&amp;</span> tar zxvf sealos_<span class="si">${</span><span class="nv">VERSION</span><span class="p">#v</span><span class="si">}</span>_linux_amd64.tar.gz sealos <span class="o">&amp;&amp;</span> chmod +x sealos <span class="o">&amp;&amp;</span> mv sealos /usr/bin
</span></span></code></pre></div><ol start="3">
<li>éªŒè¯<code>SealOS</code>æ˜¯å¦å®‰è£…å®Œæˆ</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># sealos version</span>
</span></span><span class="line"><span class="cl">SealosVersion:
</span></span><span class="line"><span class="cl">  buildDate: <span class="s2">&#34;2023-10-30T16:19:05Z&#34;</span>
</span></span><span class="line"><span class="cl">  compiler: gc
</span></span><span class="line"><span class="cl">  gitCommit: f39b2339
</span></span><span class="line"><span class="cl">  gitVersion: 4.3.7
</span></span><span class="line"><span class="cl">  goVersion: go1.20.10
</span></span><span class="line"><span class="cl">  platform: linux/amd64
</span></span></code></pre></div><blockquote>
<p>æ­£å¸¸èƒ½æ˜¾ç¤ºå‡ºæ¥ç‰ˆæœ¬å·ä¿¡æ¯å°±è¡¨ç¤ºå®‰è£…æ­£å¸¸ã€‚</p>
</blockquote>
<h2 id="å¿«é€Ÿéƒ¨ç½²é«˜å¯ç”¨é›†ç¾¤">å¿«é€Ÿéƒ¨ç½²é«˜å¯ç”¨é›†ç¾¤</h2>
<ul>
<li>é»˜è®¤ä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶ä¸º<code>Containerd</code></li>
</ul>
<ol>
<li>å¼€å§‹ä½¿ç”¨<code>sealOS</code>æ¥éƒ¨ç½²å¤šèŠ‚ç‚¹é›†ç¾¤</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sealos run registry.cn-shanghai.aliyuncs.com/labring/kubernetes:v1.27.7 registry.cn-shanghai.aliyuncs.com/labring/helm:v3.9.4 registry.cn-shanghai.aliyuncs.com/labring/cilium:v1.13.4 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>     --masters 10.1.11.100,10.1.11.101,10.1.11.102 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>     --nodes 10.1.11.103,10.1.11.104,10.1.11.105  -p 123..com
</span></span></code></pre></div><ul>
<li><code>--masters</code>: kubernetes-masterçš„èŠ‚ç‚¹åœ°å€åˆ—è¡¨</li>
<li><code>--nodes</code>:  kubernetes-nodeçš„èŠ‚ç‚¹åœ°å€åˆ—è¡¨</li>
<li><code>-p</code>: è¿œç¨‹ä¸»æœºçš„SSHç™»å½•å¯†ç </li>
</ul>
<p>æ³¨æ„éƒ¨ç½²çš„æ—¶å€™æ³¨æ„æœåŠ¡å™¨çš„<code>HostName</code>å¿…é¡»å”¯ä¸€ä¸å†²çª</p>
<ol start="2">
<li>æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ å‡ºç°å¦‚ä¸‹å†…å®¹è¡¨ç¤ºå®‰è£…æˆåŠŸ</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">2024-04-11T15:20:01 info Executing pipeline RunGuest in CreateProcessor.
</span></span><span class="line"><span class="cl">â„¹ï¸  Using Cilium version 1.13.4
</span></span><span class="line"><span class="cl">ğŸ”® Auto-detected cluster name: kubernetes
</span></span><span class="line"><span class="cl">ğŸ”® Auto-detected datapath mode: tunnel
</span></span><span class="line"><span class="cl">ğŸ”® Auto-detected kube-proxy has been installed
</span></span><span class="line"><span class="cl">2024-04-11T15:20:03 info succeeded in creating a new cluster, enjoy it!
</span></span><span class="line"><span class="cl">2024-04-11T15:20:03 info 
</span></span><span class="line"><span class="cl">      ___           ___           ___           ___       ___           ___
</span></span><span class="line"><span class="cl">     /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\_</span>_<span class="se">\ </span>    /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\ </span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /::<span class="se">\ </span> <span class="se">\ </span>      /::<span class="se">\ </span> <span class="se">\ </span>      /::<span class="se">\ </span> <span class="se">\ </span>      /:/  /    /::<span class="se">\ </span> <span class="se">\ </span>      /::<span class="se">\ </span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   /:/<span class="se">\ \ </span> <span class="se">\ </span>    /:/<span class="se">\:\ </span> <span class="se">\ </span>    /:/<span class="se">\:\ </span> <span class="se">\ </span>    /:/  /    /:/<span class="se">\:\ </span> <span class="se">\ </span>    /:/<span class="se">\ \ </span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  _<span class="se">\:\~\ \ </span> <span class="se">\ </span>  /::<span class="se">\~\:\ </span> <span class="se">\ </span>  /::<span class="se">\~\:\ </span> <span class="se">\ </span>  /:/  /    /:/  <span class="se">\:\ </span> <span class="se">\ </span>  _<span class="se">\:\~\ \ </span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> /<span class="se">\ \:\ \ \_</span>_<span class="se">\ </span>/:/<span class="se">\:\ \:\_</span>_<span class="se">\ </span>/:/<span class="se">\:\ \:\_</span>_<span class="se">\ </span>/:/__/    /:/__/ <span class="se">\:\_</span>_<span class="se">\ </span>/<span class="se">\ \:\ \ \_</span>_<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> <span class="se">\:\ \:\ \/</span>__/ <span class="se">\:\~\:\ \/</span>__/ <span class="se">\/</span>__<span class="se">\:\/</span>:/  / <span class="se">\:\ </span> <span class="se">\ </span>   <span class="se">\:\ </span> <span class="se">\ </span>/:/  / <span class="se">\:\ \:\ \/</span>__/
</span></span><span class="line"><span class="cl">  <span class="se">\:\ \:\_</span>_<span class="se">\ </span>   <span class="se">\:\ \:\_</span>_<span class="se">\ </span>       <span class="se">\:</span>:/  /   <span class="se">\:\ </span> <span class="se">\ </span>   <span class="se">\:\ </span> /:/  /   <span class="se">\:\ \:\_</span>_<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   <span class="se">\:\/</span>:/  /     <span class="se">\:\ \/</span>__/        /:/  /     <span class="se">\:\ </span> <span class="se">\ </span>   <span class="se">\:\/</span>:/  /     <span class="se">\:\/</span>:/  /
</span></span><span class="line"><span class="cl">    <span class="se">\:</span>:/  /       <span class="se">\:\_</span>_<span class="se">\ </span>        /:/  /       <span class="se">\:\_</span>_<span class="se">\ </span>   <span class="se">\:</span>:/  /       <span class="se">\:</span>:/  /
</span></span><span class="line"><span class="cl">     <span class="se">\/</span>__/         <span class="se">\/</span>__/         <span class="se">\/</span>__/         <span class="se">\/</span>__/     <span class="se">\/</span>__/         <span class="se">\/</span>__/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                  Website: https://www.sealos.io/
</span></span><span class="line"><span class="cl">                  Address: github.com/labring/sealos
</span></span><span class="line"><span class="cl">                  Version: 4.3.7-f39b2339
</span></span></code></pre></div><ol start="3">
<li>ç®€å•çš„éªŒè¯ä¸€ä¸‹<code>kubernetes</code>å·¥ä½œæ˜¯å¦æ­£å¸¸</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@ready-kubernetes-master1 ~<span class="o">]</span><span class="c1"># kubectl get nodes</span>
</span></span><span class="line"><span class="cl">NAME                       STATUS   ROLES           AGE     VERSION
</span></span><span class="line"><span class="cl">ready-kubernetes-master1   Ready    control-plane   5m26s   v1.27.7
</span></span><span class="line"><span class="cl">ready-kubernetes-master2   Ready    control-plane   4m50s   v1.27.7
</span></span><span class="line"><span class="cl">ready-kubernetes-master3   Ready    control-plane   4m      v1.27.7
</span></span><span class="line"><span class="cl">ready-kubernetes-node1     Ready    &lt;none&gt;          3m48s   v1.27.7
</span></span><span class="line"><span class="cl">ready-kubernetes-node2     Ready    &lt;none&gt;          3m47s   v1.27.7
</span></span><span class="line"><span class="cl">ready-kubernetes-node3     Ready    &lt;none&gt;          3m49s   v1.27.7
</span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>kubernetesåŸºäºEFKçš„æ—¥å¿—è½åœ°å®ç°</title>
      <link>https://blog.mletter.cn/tech/kubernetes/install-efk/</link>
      <pubDate>Fri, 08 Dec 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/install-efk/</guid>
      <description>&lt;p&gt;Kubernetes ä¸­æ¯”è¾ƒæµè¡Œçš„æ—¥å¿—æ”¶é›†è§£å†³æ–¹æ¡ˆæ˜¯ &lt;code&gt;Elasticsearch&lt;/code&gt;ã€&lt;code&gt;Fluentd&lt;/code&gt; å’Œ &lt;code&gt;Kibana&lt;/code&gt;ï¼ˆEFKï¼‰æŠ€æœ¯æ ˆï¼Œä¹Ÿæ˜¯å®˜æ–¹ç°åœ¨æ¯”è¾ƒæ¨èçš„ä¸€ç§æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Elasticsearch&lt;/code&gt; æ˜¯ä¸€ä¸ªå®æ—¶çš„ã€åˆ†å¸ƒå¼çš„å¯æ‰©å±•çš„æœç´¢å¼•æ“ï¼Œå…è®¸è¿›è¡Œå…¨æ–‡ã€ç»“æ„åŒ–æœç´¢ï¼Œå®ƒé€šå¸¸ç”¨äºç´¢å¼•å’Œæœç´¢å¤§é‡æ—¥å¿—æ•°æ®ï¼Œä¹Ÿå¯ç”¨äºæœç´¢è®¸å¤šä¸åŒç±»å‹çš„æ–‡æ¡£ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Elasticsearch&lt;/code&gt; é€šå¸¸ä¸ &lt;code&gt;Kibana&lt;/code&gt; ä¸€èµ·éƒ¨ç½²ï¼Œ&lt;code&gt;Kibana&lt;/code&gt; æ˜¯ &lt;code&gt;Elasticsearch&lt;/code&gt; çš„ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æ•°æ®å¯è§†åŒ– Dashboardï¼Œ&lt;code&gt;Kibana&lt;/code&gt; å…è®¸ä½ é€šè¿‡ web ç•Œé¢æ¥æµè§ˆ&lt;code&gt;Elasticsearch&lt;/code&gt; æ—¥å¿—æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Fluentd&lt;/code&gt;æ˜¯ä¸€ä¸ªæµè¡Œçš„å¼€æºæ•°æ®æ”¶é›†å™¨ï¼Œæˆ‘ä»¬å°†åœ¨ Kubernetes é›†ç¾¤èŠ‚ç‚¹ä¸Šå®‰è£… &lt;code&gt;Fluentd&lt;/code&gt;ï¼Œé€šè¿‡è·å–å®¹å™¨æ—¥å¿—æ–‡ä»¶ã€è¿‡æ»¤å’Œè½¬æ¢æ—¥å¿—æ•°æ®ï¼Œç„¶åå°†æ•°æ®ä¼ é€’åˆ° Elasticsearch é›†ç¾¤ï¼Œåœ¨è¯¥é›†ç¾¤ä¸­å¯¹å…¶è¿›è¡Œç´¢å¼•å’Œå­˜å‚¨ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆæ¥é…ç½®å¯åŠ¨ä¸€ä¸ªå¯æ‰©å±•çš„ Elasticsearch é›†ç¾¤ï¼Œç„¶ååœ¨ Kubernetes é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ª Kibana åº”ç”¨ï¼Œæœ€åé€šè¿‡ DaemonSet æ¥è¿è¡Œ Fluentdï¼Œä»¥ä¾¿å®ƒåœ¨æ¯ä¸ª Kubernetes å·¥ä½œèŠ‚ç‚¹ä¸Šéƒ½å¯ä»¥è¿è¡Œä¸€ä¸ª Podã€‚&lt;/p&gt;
&lt;h2 id=&#34;å®‰è£…-elasticsearch-é›†ç¾¤&#34;&gt;å®‰è£… Elasticsearch é›†ç¾¤&lt;/h2&gt;
&lt;p&gt;å…ˆåˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­å®‰è£…æ‰€æœ‰æ—¥å¿—ç›¸å…³çš„èµ„æºå¯¹è±¡ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl create ns kube-logging
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;ç¯å¢ƒå‡†å¤‡&#34;&gt;ç¯å¢ƒå‡†å¤‡&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;ElasticSearch&lt;/code&gt; å®‰è£…æœ‰æœ€ä½å®‰è£…è¦æ±‚ï¼Œå¦‚æœå®‰è£…å Pod æ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œè¯·æ£€æŸ¥æ˜¯å¦ç¬¦åˆæœ€ä½è¦æ±‚çš„é…ç½®ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;èŠ‚ç‚¹&lt;/th&gt;
          &lt;th&gt;CPUæœ€ä½è¦æ±‚&lt;/th&gt;
          &lt;th&gt;å†…å­˜æœ€ä½è¦æ±‚&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;elasticsearch-master&lt;/td&gt;
          &lt;td&gt;æ ¸å¿ƒæ•°&amp;gt;2&lt;/td&gt;
          &lt;td&gt;å†…å­˜&amp;gt;2G&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;elasticsearch-data&lt;/td&gt;
          &lt;td&gt;æ ¸å¿ƒæ•°&amp;gt;1&lt;/td&gt;
          &lt;td&gt;å†…å­˜&amp;gt;2G&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;elasticsearch-client&lt;/td&gt;
          &lt;td&gt;æ ¸å¿ƒæ•°&amp;gt;1&lt;/td&gt;
          &lt;td&gt;å†…å­˜&amp;gt;2G&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯&lt;/p&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;é›†ç¾¤&lt;/th&gt;
          &lt;th&gt;èŠ‚ç‚¹ç±»å‹&lt;/th&gt;
          &lt;th&gt;å‰¯æœ¬æ•°ç›®&lt;/th&gt;
          &lt;th&gt;å­˜å‚¨å¤§å°&lt;/th&gt;
          &lt;th&gt;ç½‘ç»œæ¨¡å¼&lt;/th&gt;
          &lt;th&gt;æè¿°&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;elasticsearch&lt;/td&gt;
          &lt;td&gt;master&lt;/td&gt;
          &lt;td&gt;3&lt;/td&gt;
          &lt;td&gt;5Gi&lt;/td&gt;
          &lt;td&gt;ClusterIP&lt;/td&gt;
          &lt;td&gt;ä¸»èŠ‚ç‚¹&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;elasticsearch-data&lt;/td&gt;
          &lt;td&gt;data&lt;/td&gt;
          &lt;td&gt;3&lt;/td&gt;
          &lt;td&gt;50Gi&lt;/td&gt;
          &lt;td&gt;ClusterIP&lt;/td&gt;
          &lt;td&gt;æ•°æ®èŠ‚ç‚¹&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;elasticsearch-client&lt;/td&gt;
          &lt;td&gt;client&lt;/td&gt;
          &lt;td&gt;2&lt;/td&gt;
          &lt;td&gt;æ— &lt;/td&gt;
          &lt;td&gt;NodePort&lt;/td&gt;
          &lt;td&gt;è´Ÿè´£å¤„ç†ç”¨æˆ·è¯·æ±‚&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;å»ºè®®ä½¿ç”¨ &lt;code&gt;StorageClass&lt;/code&gt; æ¥åšæŒä¹…åŒ–å­˜å‚¨ï¼Œå½“ç„¶å¦‚æœä½ æ˜¯çº¿ä¸Šç¯å¢ƒå»ºè®®ä½¿ç”¨ Local PV æˆ–è€… Ceph RBD ä¹‹ç±»çš„å­˜å‚¨æ¥æŒä¹…åŒ– Elasticsearch çš„æ•°æ®ã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>Kubernetes ä¸­æ¯”è¾ƒæµè¡Œçš„æ—¥å¿—æ”¶é›†è§£å†³æ–¹æ¡ˆæ˜¯ <code>Elasticsearch</code>ã€<code>Fluentd</code> å’Œ <code>Kibana</code>ï¼ˆEFKï¼‰æŠ€æœ¯æ ˆï¼Œä¹Ÿæ˜¯å®˜æ–¹ç°åœ¨æ¯”è¾ƒæ¨èçš„ä¸€ç§æ–¹æ¡ˆã€‚</p>
<p><code>Elasticsearch</code> æ˜¯ä¸€ä¸ªå®æ—¶çš„ã€åˆ†å¸ƒå¼çš„å¯æ‰©å±•çš„æœç´¢å¼•æ“ï¼Œå…è®¸è¿›è¡Œå…¨æ–‡ã€ç»“æ„åŒ–æœç´¢ï¼Œå®ƒé€šå¸¸ç”¨äºç´¢å¼•å’Œæœç´¢å¤§é‡æ—¥å¿—æ•°æ®ï¼Œä¹Ÿå¯ç”¨äºæœç´¢è®¸å¤šä¸åŒç±»å‹çš„æ–‡æ¡£ã€‚</p>
<p><code>Elasticsearch</code> é€šå¸¸ä¸ <code>Kibana</code> ä¸€èµ·éƒ¨ç½²ï¼Œ<code>Kibana</code> æ˜¯ <code>Elasticsearch</code> çš„ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æ•°æ®å¯è§†åŒ– Dashboardï¼Œ<code>Kibana</code> å…è®¸ä½ é€šè¿‡ web ç•Œé¢æ¥æµè§ˆ<code>Elasticsearch</code> æ—¥å¿—æ•°æ®ã€‚</p>
<p><code>Fluentd</code>æ˜¯ä¸€ä¸ªæµè¡Œçš„å¼€æºæ•°æ®æ”¶é›†å™¨ï¼Œæˆ‘ä»¬å°†åœ¨ Kubernetes é›†ç¾¤èŠ‚ç‚¹ä¸Šå®‰è£… <code>Fluentd</code>ï¼Œé€šè¿‡è·å–å®¹å™¨æ—¥å¿—æ–‡ä»¶ã€è¿‡æ»¤å’Œè½¬æ¢æ—¥å¿—æ•°æ®ï¼Œç„¶åå°†æ•°æ®ä¼ é€’åˆ° Elasticsearch é›†ç¾¤ï¼Œåœ¨è¯¥é›†ç¾¤ä¸­å¯¹å…¶è¿›è¡Œç´¢å¼•å’Œå­˜å‚¨ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥é…ç½®å¯åŠ¨ä¸€ä¸ªå¯æ‰©å±•çš„ Elasticsearch é›†ç¾¤ï¼Œç„¶ååœ¨ Kubernetes é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ª Kibana åº”ç”¨ï¼Œæœ€åé€šè¿‡ DaemonSet æ¥è¿è¡Œ Fluentdï¼Œä»¥ä¾¿å®ƒåœ¨æ¯ä¸ª Kubernetes å·¥ä½œèŠ‚ç‚¹ä¸Šéƒ½å¯ä»¥è¿è¡Œä¸€ä¸ª Podã€‚</p>
<h2 id="å®‰è£…-elasticsearch-é›†ç¾¤">å®‰è£… Elasticsearch é›†ç¾¤</h2>
<p>å…ˆåˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­å®‰è£…æ‰€æœ‰æ—¥å¿—ç›¸å…³çš„èµ„æºå¯¹è±¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create ns kube-logging
</span></span></code></pre></div><h3 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡</h3>
<p><code>ElasticSearch</code> å®‰è£…æœ‰æœ€ä½å®‰è£…è¦æ±‚ï¼Œå¦‚æœå®‰è£…å Pod æ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œè¯·æ£€æŸ¥æ˜¯å¦ç¬¦åˆæœ€ä½è¦æ±‚çš„é…ç½®ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š</p>
<table>
  <thead>
      <tr>
          <th>èŠ‚ç‚¹</th>
          <th>CPUæœ€ä½è¦æ±‚</th>
          <th>å†…å­˜æœ€ä½è¦æ±‚</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>elasticsearch-master</td>
          <td>æ ¸å¿ƒæ•°&gt;2</td>
          <td>å†…å­˜&gt;2G</td>
      </tr>
      <tr>
          <td>elasticsearch-data</td>
          <td>æ ¸å¿ƒæ•°&gt;1</td>
          <td>å†…å­˜&gt;2G</td>
      </tr>
      <tr>
          <td>elasticsearch-client</td>
          <td>æ ¸å¿ƒæ•°&gt;1</td>
          <td>å†…å­˜&gt;2G</td>
      </tr>
  </tbody>
</table>
<p>é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</p>
<table>
  <thead>
      <tr>
          <th>é›†ç¾¤</th>
          <th>èŠ‚ç‚¹ç±»å‹</th>
          <th>å‰¯æœ¬æ•°ç›®</th>
          <th>å­˜å‚¨å¤§å°</th>
          <th>ç½‘ç»œæ¨¡å¼</th>
          <th>æè¿°</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>elasticsearch</td>
          <td>master</td>
          <td>3</td>
          <td>5Gi</td>
          <td>ClusterIP</td>
          <td>ä¸»èŠ‚ç‚¹</td>
      </tr>
      <tr>
          <td>elasticsearch-data</td>
          <td>data</td>
          <td>3</td>
          <td>50Gi</td>
          <td>ClusterIP</td>
          <td>æ•°æ®èŠ‚ç‚¹</td>
      </tr>
      <tr>
          <td>elasticsearch-client</td>
          <td>client</td>
          <td>2</td>
          <td>æ— </td>
          <td>NodePort</td>
          <td>è´Ÿè´£å¤„ç†ç”¨æˆ·è¯·æ±‚</td>
      </tr>
  </tbody>
</table>
<blockquote>
<p>å»ºè®®ä½¿ç”¨ <code>StorageClass</code> æ¥åšæŒä¹…åŒ–å­˜å‚¨ï¼Œå½“ç„¶å¦‚æœä½ æ˜¯çº¿ä¸Šç¯å¢ƒå»ºè®®ä½¿ç”¨ Local PV æˆ–è€… Ceph RBD ä¹‹ç±»çš„å­˜å‚¨æ¥æŒä¹…åŒ– Elasticsearch çš„æ•°æ®ã€‚</p>
</blockquote>
<p>ç”±äº ElasticSearch 7.x ç‰ˆæœ¬é»˜è®¤å®‰è£…äº† X-Pack æ’ä»¶ï¼Œå¹¶ä¸”éƒ¨åˆ†åŠŸèƒ½å…è´¹ï¼Œéœ€è¦æˆ‘ä»¬é…ç½®ä¸€äº›å®‰å…¨è¯ä¹¦æ–‡ä»¶ã€‚</p>
<h3 id="å‡†å¤‡ç”Ÿæˆè¯ä¹¦æ–‡ä»¶">å‡†å¤‡ç”Ÿæˆè¯ä¹¦æ–‡ä»¶</h3>
<blockquote>
<p>æ³¨æ„ï¼šç”±äºæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯<code>containerd</code>æ‰€ä»¥ä½¿ç”¨<code>nerdctl</code>æ¥è¿è¡Œä¸€ä¸ªå®¹å™¨</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p elastic-certs
</span></span><span class="line"><span class="cl">nerdctl run --name elastic-certs -v elastic-certs:/app -it -w /app elasticsearch:7.17.3 /bin/sh -c  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="s2">&#34;elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass &#39;&#39; &amp;&amp; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    elasticsearch-certutil cert --name security-master --dns \
</span></span></span><span class="line"><span class="cl"><span class="s2">    security-master --ca /app/elastic-stack-ca.p12 --pass &#39;&#39; --ca-pass &#39;&#39; --out /app/elastic-certificates.p12&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æ‰¾åˆ°nerdctlæŒ‚è½½çš„ç›®å½•</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /var/lib/nerdctl/1935db59/volumes/default/elastic-certs/_data/ <span class="c1"># è¿™ä¸ªæ¯ä¸ªäººæ˜¯ä¸ä¸€æ ·çš„ å¯ä»¥è‡ªå·±æœç´¢ä¸€ä¸‹</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mv * /root/elastic-certs/
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /root/elastic-certs/ <span class="o">&amp;&amp;</span> openssl pkcs12 -nodes -passin pass:<span class="s1">&#39;&#39;</span> -in elastic-certificates.p12 -out elastic-certificate.pem
</span></span></code></pre></div><ol start="2">
<li>æ·»åŠ è¯ä¹¦åˆ°<code>kubernetes</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create secret -n kube-logging generic elastic-certs --from-file<span class="o">=</span>elastic-certificates.p12
</span></span><span class="line"><span class="cl"><span class="c1"># è®¾ç½®é›†ç¾¤ç”¨æˆ·åå’Œå¯†ç </span>
</span></span><span class="line"><span class="cl">kubectl create secret -n kube-logging generic elastic-auth --from-literal<span class="o">=</span><span class="nv">username</span><span class="o">=</span>elastic --from-literal<span class="o">=</span><span class="nv">password</span><span class="o">=</span>elastic-master
</span></span></code></pre></div><h3 id="å‡†å¤‡å®‰è£…elasticé›†ç¾¤">å‡†å¤‡å®‰è£…Elasticé›†ç¾¤</h3>
<ol>
<li>é‡‡ç”¨<code>Helm</code>çš„æ–¹å¼æ¥æ·»åŠ <code>elasticsearch</code>ä»“åº“</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm repo add elastic https://helm.elastic.co
</span></span><span class="line"><span class="cl">helm repo update
</span></span></code></pre></div><p>ElaticSearch å®‰è£…éœ€è¦å®‰è£…ä¸‰æ¬¡ï¼Œåˆ†åˆ«å®‰è£… Masterã€Dataã€Client èŠ‚ç‚¹ï¼ŒMaster èŠ‚ç‚¹è´Ÿè´£é›†ç¾¤é—´çš„ç®¡ç†å·¥ä½œï¼›Data èŠ‚ç‚¹è´Ÿè´£å­˜å‚¨æ•°æ®ï¼›Client èŠ‚ç‚¹è´Ÿè´£ä»£ç† ElasticSearch Cluster é›†ç¾¤ï¼Œè´Ÿè½½å‡è¡¡ã€‚
2. æ‹‰å–elasticsearch</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm pull elastic/elasticsearch --untar --version 7.17.3
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> elasticsearch/
</span></span></code></pre></div><p>åœ¨Chartç›®å½•ä¸‹åˆ›å»ºå¯¹åº”èŠ‚ç‚¹èŠ‚ç‚¹çš„<code>values</code>æ–‡ä»¶
ä»¥ä¸‹æ˜¯<code>master-value.yaml</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># è®¾ç½®é›†ç¾¤åç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;elasticsearch&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è®¾ç½®èŠ‚ç‚¹åç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeGroup</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;master&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è®¾ç½®è§’è‰²</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">master</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingest</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># é•œåƒ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;docker.elastic.co/elasticsearch/elasticsearch&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imageTag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;7.17.3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;IfNotPresent&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># å‰¯æœ¬æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ---èµ„æºé…ç½®---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">esJavaOpts</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;-Xmx1g -Xms1g&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2000m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2Gi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2000m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2Gi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># æ•°æ®æŒä¹…å·é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># å­˜å‚¨æ•°æ®å¤§å°é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">volumeClaimTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">managed-nfs-storage</span><span class="w"> </span><span class="c"># å®šä¹‰ä½ è‡ªå·±çš„å­˜å‚¨ç±»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;ReadWriteOnce&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ---å®‰å…¨è®¾ç½®---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è®¾ç½®åè®®ï¼Œå¯é…ç½®ä¸º httpã€https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è¯ä¹¦æŒ‚è½½é…ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‚å…¥ä¸Šé¢åˆ›å»ºçš„è¯ä¹¦</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">secretMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/elasticsearch/config/certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="m">0755</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># å…è®¸æ‚¨åœ¨/usr/share/elasticsearch/config/ä¸­æ·»åŠ ä»»ä½•è‡ªå®šä¹‰é…ç½®æ–‡ä»¶,ä¾‹å¦‚ elasticsearch.ymlã€log4j2.properties</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ElasticSearch 7.x é»˜è®¤å®‰è£…äº† x-pack æ’ä»¶ï¼Œéƒ¨åˆ†åŠŸèƒ½å…è´¹ï¼Œè¿™é‡Œæˆ‘ä»¬é…ç½®ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ä¸‹é¢æ³¨æ‰çš„éƒ¨åˆ†ä¸ºé…ç½® https è¯ä¹¦ï¼Œé…ç½®æ­¤éƒ¨åˆ†è¿˜éœ€è¦é…ç½® helm å‚æ•° protocol å€¼æ”¹ä¸º https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">esConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">elasticsearch.yml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.enabled: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.enabled: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.verification_mode: certificate
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class="line"><span class="cl"><span class="sd">    # xpack.security.http.ssl.enabled: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class="line"><span class="cl"><span class="sd">    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ç¯å¢ƒå˜é‡é…ç½®ï¼Œè¿™é‡Œå¼•å…¥ä¸Šé¢è®¾ç½®çš„ç”¨æˆ·åã€å¯†ç  secret æ–‡ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">extraEnvs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ELASTIC_USERNAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">username</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ELASTIC_PASSWORD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">password</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ---è°ƒåº¦è®¾ç½®---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è®¾ç½®è°ƒåº¦ç­–ç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># - hardï¼šåªæœ‰å½“æœ‰è¶³å¤Ÿçš„èŠ‚ç‚¹æ—¶ Pod æ‰ä¼šè¢«è°ƒåº¦ï¼Œå¹¶ä¸”å®ƒä»¬æ°¸è¿œä¸ä¼šå‡ºç°åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Š</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># - softï¼šå°½æœ€å¤§åŠªåŠ›è°ƒåº¦</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">antiAffinity</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;soft&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Exists&#34;</span><span class="w"> </span><span class="c"># å®¹å¿å…¨éƒ¨æ±¡ç‚¹</span><span class="w">
</span></span></span></code></pre></div><p>ä»¥ä¸‹æ˜¯<code>data-value.yaml</code>çš„å†…å®¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># è®¾ç½®é›†ç¾¤åç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;elasticsearch&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è®¾ç½®èŠ‚ç‚¹åç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeGroup</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;data&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è®¾ç½®è§’è‰²</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">master</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingest</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># é•œåƒ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;docker.elastic.co/elasticsearch/elasticsearch&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imageTag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;7.17.3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;IfNotPresent&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># å‰¯æœ¬æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ---èµ„æºé…ç½®---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">esJavaOpts</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;-Xmx1g -Xms1g&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1000m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2Gi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1000m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2Gi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># æ•°æ®æŒä¹…å·é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># å­˜å‚¨æ•°æ®å¤§å°é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">volumeClaimTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">managed-nfs-storage</span><span class="w"> </span><span class="c"># å®šä¹‰ä½ è‡ªå·±çš„å­˜å‚¨ç±»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;ReadWriteOnce&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">20Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ---å®‰å…¨è®¾ç½®---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è®¾ç½®åè®®ï¼Œå¯é…ç½®ä¸º httpã€https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è¯ä¹¦æŒ‚è½½é…ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‚å…¥ä¸Šé¢åˆ›å»ºçš„è¯ä¹¦</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">secretMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/elasticsearch/config/certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="m">0755</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># å…è®¸æ‚¨åœ¨/usr/share/elasticsearch/config/ä¸­æ·»åŠ ä»»ä½•è‡ªå®šä¹‰é…ç½®æ–‡ä»¶,ä¾‹å¦‚ elasticsearch.ymlã€log4j2.properties</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ElasticSearch 7.x é»˜è®¤å®‰è£…äº† x-pack æ’ä»¶ï¼Œéƒ¨åˆ†åŠŸèƒ½å…è´¹ï¼Œè¿™é‡Œæˆ‘ä»¬é…ç½®ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ä¸‹é¢æ³¨æ‰çš„éƒ¨åˆ†ä¸ºé…ç½® https è¯ä¹¦ï¼Œé…ç½®æ­¤éƒ¨åˆ†è¿˜éœ€è¦é…ç½® helm å‚æ•° protocol å€¼æ”¹ä¸º https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">esConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">elasticsearch.yml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.enabled: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.enabled: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.verification_mode: certificate
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class="line"><span class="cl"><span class="sd">    # xpack.security.http.ssl.enabled: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class="line"><span class="cl"><span class="sd">    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ç¯å¢ƒå˜é‡é…ç½®ï¼Œè¿™é‡Œå¼•å…¥ä¸Šé¢è®¾ç½®çš„ç”¨æˆ·åã€å¯†ç  secret æ–‡ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">extraEnvs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ELASTIC_USERNAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">username</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ELASTIC_PASSWORD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">password</span><span class="w">
</span></span></span></code></pre></div><p>ä»¥ä¸‹æ˜¯<code>client-value.yaml</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># è®¾ç½®é›†ç¾¤åç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;elasticsearch&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è®¾ç½®èŠ‚ç‚¹åç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeGroup</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;client&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è®¾ç½®è§’è‰²</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">master</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingest</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># é•œåƒ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;docker.elastic.co/elasticsearch/elasticsearch&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imageTag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;7.17.3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;IfNotPresent&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># å‰¯æœ¬æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ---èµ„æºé…ç½®---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">esJavaOpts</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;-Xmx1g -Xms1g&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1000m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2Gi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1000m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2Gi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># æ•°æ®æŒä¹…å·é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ---å®‰å…¨è®¾ç½®---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è®¾ç½®åè®®ï¼Œå¯é…ç½®ä¸º httpã€https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># è¯ä¹¦æŒ‚è½½é…ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‚å…¥ä¸Šé¢åˆ›å»ºçš„è¯ä¹¦</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">secretMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/elasticsearch/config/certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="m">0755</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># å…è®¸æ‚¨åœ¨/usr/share/elasticsearch/config/ä¸­æ·»åŠ ä»»ä½•è‡ªå®šä¹‰é…ç½®æ–‡ä»¶,ä¾‹å¦‚ elasticsearch.ymlã€log4j2.properties</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ElasticSearch 7.x é»˜è®¤å®‰è£…äº† x-pack æ’ä»¶ï¼Œéƒ¨åˆ†åŠŸèƒ½å…è´¹ï¼Œè¿™é‡Œæˆ‘ä»¬é…ç½®ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ä¸‹é¢æ³¨æ‰çš„éƒ¨åˆ†ä¸ºé…ç½® https è¯ä¹¦ï¼Œé…ç½®æ­¤éƒ¨åˆ†è¿˜éœ€è¦é…ç½® helm å‚æ•° protocol å€¼æ”¹ä¸º https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">esConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">elasticsearch.yml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.enabled: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.enabled: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.verification_mode: certificate
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class="line"><span class="cl"><span class="sd">    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class="line"><span class="cl"><span class="sd">    # xpack.security.http.ssl.enabled: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class="line"><span class="cl"><span class="sd">    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ç¯å¢ƒå˜é‡é…ç½®ï¼Œè¿™é‡Œå¼•å…¥ä¸Šé¢è®¾ç½®çš„ç”¨æˆ·åã€å¯†ç  secret æ–‡ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">extraEnvs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ELASTIC_USERNAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">username</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ELASTIC_PASSWORD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">password</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ----æœåŠ¡è®¾ç½®----</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;30200&#39;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>å¼€å§‹éƒ¨ç½²ç›¸å…³èŠ‚ç‚¹</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm upgrade --install elasticsearch-master -f master-values.yaml --namespace kube-logging ./ <span class="c1"># éƒ¨ç½²master</span>
</span></span><span class="line"><span class="cl">helm upgrade --install elasticsearch-data -f data-values.yaml --namespace kube-logging ./ <span class="c1"># éƒ¨ç½²data</span>
</span></span><span class="line"><span class="cl">helm upgrade --install elasticsearch-client -f client-values.yaml --namespace kube-logging ./  <span class="c1"># éƒ¨ç½² client</span>
</span></span></code></pre></div><p>æ­£å¸¸æƒ…å†µä¸‹çœ‹åˆ°æ‰€æœ‰èŠ‚ç‚¹éƒ½å¤„äº<code>running</code>çŠ¶æ€å³å¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 elasticsearch<span class="o">]</span><span class="c1"># kubectl get pods -n kube-logging</span>
</span></span><span class="line"><span class="cl">NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">elasticsearch-client-0   1/1     Running   <span class="m">0</span>          13m
</span></span><span class="line"><span class="cl">elasticsearch-data-0     1/1     Running   <span class="m">0</span>          17m
</span></span><span class="line"><span class="cl">elasticsearch-data-1     1/1     Running   <span class="m">0</span>          17m
</span></span><span class="line"><span class="cl">elasticsearch-data-2     1/1     Running   <span class="m">0</span>          17m
</span></span><span class="line"><span class="cl">elasticsearch-master-0   1/1     Running   <span class="m">0</span>          43m
</span></span><span class="line"><span class="cl">elasticsearch-master-1   1/1     Running   <span class="m">0</span>          43m
</span></span><span class="line"><span class="cl">elasticsearch-master-2   1/1     Running   <span class="m">0</span>          43m
</span></span></code></pre></div><h2 id="å®‰è£…kibana">å®‰è£…Kibana</h2>
<p>ä¾æ—§ä½¿ç”¨<code>helm</code>çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²</p>
<ol>
<li>ä½¿ç”¨<code>helm pull</code>æ‹‰å–<code>Kibana</code>åŒ…æ¥è¿›è¡Œè§£å‹</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm pull elastic/kibana --untar --version 7.17.3
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> kibana
</span></span></code></pre></div><ol start="2">
<li>å®šä¹‰ä¸€ä¸ªåå­—ä¸º<code>custom-value.yaml</code>çš„æ–‡ä»¶</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># æŒ‡å®šé•œåƒä¸é•œåƒç‰ˆæœ¬</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;kibana&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imageTag</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;7.17.3&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># é…ç½® ElasticSearch åœ°å€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">elasticsearchHosts</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;http://elasticsearch-client:9200&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ç¯å¢ƒå˜é‡é…ç½®ï¼Œè¿™é‡Œå¼•å…¥ä¸Šé¢è®¾ç½®çš„ç”¨æˆ·åã€å¯†ç  secret æ–‡ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">extraEnvs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;ELASTICSEARCH_USERNAME&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">username</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;ELASTICSEARCH_PASSWORD&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">password</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;500m&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1Gi&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;500m&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1Gi&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># kibana é…ç½®ä¸­æ·»åŠ è¯­è¨€é…ç½®ï¼Œè®¾ç½® kibana ä¸ºä¸­æ–‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kibanaConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kibana.yml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    i18n.locale: &#34;zh-CN&#34;</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;30601&#39;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>éƒ¨ç½²<code>kibana</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm install kibana -f custom-value.yaml --namespace kube-logging .
</span></span></code></pre></div><h2 id="éƒ¨ç½²fluentd">éƒ¨ç½²Fluentd</h2>
<p>Fluentd æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„æ—¥å¿—èšåˆå™¨ï¼Œæ˜¯ç”¨ Ruby ç¼–å†™çš„ï¼Œå¹¶ä¸”å¯ä»¥å¾ˆå¥½åœ°æ‰©å±•ã€‚å¯¹äºå¤§éƒ¨åˆ†ä¼ä¸šæ¥è¯´ï¼ŒFluentd è¶³å¤Ÿé«˜æ•ˆå¹¶ä¸”æ¶ˆè€—çš„èµ„æºç›¸å¯¹è¾ƒå°‘ï¼Œå¦å¤–ä¸€ä¸ªå·¥å…· <code>Fluent-bit</code> æ›´è½»é‡çº§ï¼Œå ç”¨èµ„æºæ›´å°‘ï¼Œä½†æ˜¯æ’ä»¶ç›¸å¯¹ Fluentd æ¥è¯´ä¸å¤Ÿä¸°å¯Œï¼Œæ‰€ä»¥æ•´ä½“æ¥è¯´ï¼ŒFluentd æ›´åŠ æˆç†Ÿï¼Œä½¿ç”¨æ›´åŠ å¹¿æ³›ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Fluentd æ¥ä½œä¸ºæ—¥å¿—æ”¶é›†å·¥å…·ã€‚</p>
<h3 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h3>
<p>Fluentd é€šè¿‡ä¸€ç»„ç»™å®šçš„æ•°æ®æºæŠ“å–æ—¥å¿—æ•°æ®ï¼Œå¤„ç†åï¼ˆè½¬æ¢æˆç»“æ„åŒ–çš„æ•°æ®æ ¼å¼ï¼‰å°†å®ƒä»¬è½¬å‘ç»™å…¶ä»–æœåŠ¡ï¼Œæ¯”å¦‚ Elasticsearchã€å¯¹è±¡å­˜å‚¨ç­‰ç­‰ã€‚Fluentd æ”¯æŒè¶…è¿‡ 300 ä¸ªæ—¥å¿—å­˜å‚¨å’Œåˆ†ææœåŠ¡ï¼Œæ‰€ä»¥åœ¨è¿™æ–¹é¢æ˜¯éå¸¸çµæ´»çš„ã€‚ä¸»è¦è¿è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>é¦–å…ˆ Fluentd ä»å¤šä¸ªæ—¥å¿—æºè·å–æ•°æ®</li>
<li>ç»“æ„åŒ–å¹¶ä¸”æ ‡è®°è¿™äº›æ•°æ®</li>
<li>ç„¶åæ ¹æ®åŒ¹é…çš„æ ‡ç­¾å°†æ•°æ®å‘é€åˆ°å¤šä¸ªç›®æ ‡æœåŠ¡å»</li>
<li><a class="link" href="https://docs.fluentd.org/quickstart"  target="_blank" rel="noopener"
    >å®˜æ–¹æ–‡æ¡£</a></li>
</ul>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="image.png" loading="lazy" src="https://img14.360buyimg.com/ddimg/jfs/t1/177175/31/35833/30306/64cb08eeF5ba90f46/1da6311bbbec8921.jpg"></p>
<h3 id="æ—¥å¿—æºé…ç½®">æ—¥å¿—æºé…ç½®</h3>
<p>æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œä¸ºäº†æ”¶é›† Kubernetes èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å®¹å™¨æ—¥å¿—ï¼Œå°±éœ€è¦åšå¦‚ä¸‹çš„æ—¥å¿—æºé…ç½®ï¼š</p>
<ul>
<li>idï¼šè¡¨ç¤ºå¼•ç”¨è¯¥æ—¥å¿—æºçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè¯¥æ ‡è¯†å¯ç”¨äºè¿›ä¸€æ­¥è¿‡æ»¤å’Œè·¯ç”±ç»“æ„åŒ–æ—¥å¿—æ•°æ®</li>
<li>typeï¼šFluentd å†…ç½®çš„æŒ‡ä»¤ï¼Œtail è¡¨ç¤º Fluentd ä»ä¸Šæ¬¡è¯»å–çš„ä½ç½®é€šè¿‡ tail ä¸æ–­è·å–æ•°æ®ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ http è¡¨ç¤ºé€šè¿‡ä¸€ä¸ª GET è¯·æ±‚æ¥æ”¶é›†æ•°æ®ã€‚</li>
<li>pathï¼š<code>tail</code> ç±»å‹ä¸‹çš„ç‰¹å®šå‚æ•°ï¼Œå‘Šè¯‰ Fluentd é‡‡é›† /var/log/containers ç›®å½•ä¸‹çš„æ‰€æœ‰æ—¥å¿—ï¼Œè¿™æ˜¯ docker åœ¨ Kubernetes èŠ‚ç‚¹ä¸Šç”¨æ¥å­˜å‚¨è¿è¡Œå®¹å™¨ stdout è¾“å‡ºæ—¥å¿—æ•°æ®çš„ç›®å½•ã€‚</li>
<li>pos_fileï¼šæ£€æŸ¥ç‚¹ï¼Œå¦‚æœ Fluentd ç¨‹åºé‡æ–°å¯åŠ¨äº†ï¼Œå®ƒå°†ä½¿ç”¨æ­¤æ–‡ä»¶ä¸­çš„ä½ç½®æ¥æ¢å¤æ—¥å¿—æ•°æ®æ”¶é›†ã€‚</li>
<li>tagï¼šç”¨æ¥å°†æ—¥å¿—æºä¸ç›®æ ‡æˆ–è€…è¿‡æ»¤å™¨åŒ¹é…çš„è‡ªå®šä¹‰å­—ç¬¦ä¸²ï¼ŒFluentd åŒ¹é…æº/ç›®æ ‡æ ‡ç­¾æ¥è·¯ç”±æ—¥å¿—æ•°æ®ã€‚</li>
</ul>
<pre tabindex="0"><code>&lt;source&gt;
  @id fluentd-containers.log
  @type tail                             # Fluentd å†…ç½®çš„è¾“å…¥æ–¹å¼ï¼Œå…¶åŸç†æ˜¯ä¸åœåœ°ä»æºæ–‡ä»¶ä¸­è·å–æ–°çš„æ—¥å¿—,ç±»ä¼¼äºtailå‘½ä»¤
  path /var/log/containers/*.log         # æŒ‚è½½çš„å®¿ä¸»æœºå®¹å™¨æ—¥å¿—åœ°å€
  pos_file /var/log/es-containers.log.pos
  tag raw.kubernetes.*                   # è®¾ç½®æ—¥å¿—æ ‡ç­¾
  read_from_head true
  &lt;parse&gt;                                # å¤šè¡Œæ ¼å¼åŒ–æˆJSON
    @type multi_format                   # ä½¿ç”¨ multi-format-parser è§£æå™¨æ’ä»¶
    &lt;pattern&gt;
      format json                        # JSON è§£æå™¨
      time_key time                      # æŒ‡å®šäº‹ä»¶æ—¶é—´çš„æ—¶é—´å­—æ®µ
      time_format %Y-%m-%dT%H:%M:%S.%NZ  # æ—¶é—´æ ¼å¼
    &lt;/pattern&gt;
    &lt;pattern&gt;
      format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/
      time_format %Y-%m-%dT%H:%M:%S.%N%:z
    &lt;/pattern&gt;
  &lt;/parse&gt;
&lt;/source&gt;
</code></pre><h3 id="è¿‡æ»¤">è¿‡æ»¤</h3>
<p>ç”±äº Kubernetes é›†ç¾¤ä¸­åº”ç”¨å¤ªå¤šï¼Œä¹Ÿè¿˜æœ‰å¾ˆå¤šå†å²æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åªå°†æŸäº›åº”ç”¨çš„æ—¥å¿—è¿›è¡Œæ”¶é›†ï¼Œæ¯”å¦‚æˆ‘ä»¬åªé‡‡é›†å…·æœ‰<code> discovery-log=true</code> è¿™ä¸ª Label æ ‡ç­¾çš„ Pod æ—¥å¿—ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨ filterã€‚</p>
<pre tabindex="0"><code># åˆ é™¤æ— ç”¨çš„å±æ€§
&lt;filter kubernetes.**&gt;
  @type record_transformer
  remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash
&lt;/filter&gt;
# åªä¿ç•™å…·æœ‰discovery-log=trueæ ‡ç­¾çš„Podæ—¥å¿—
&lt;filter kubernetes.**&gt;
  @id filter_log
  @type grep
  &lt;regexp&gt;
    key $.kubernetes.labels.discovery-log
    pattern ^true$
  &lt;/regexp&gt;
&lt;/filter&gt;
</code></pre><h3 id="è·¯ç”±è®¾ç½®">è·¯ç”±è®¾ç½®</h3>
<pre tabindex="0"><code>&lt;match **&gt;
  @id elasticsearch
  @type elasticsearch
  @log_level info
  include_tag_key true
  type_name fluentd
  host &#34;#{ENV[&#39;OUTPUT_HOST&#39;]}&#34;
  port &#34;#{ENV[&#39;OUTPUT_PORT&#39;]}&#34;
  logstash_format true
  &lt;buffer&gt;
    @type file
    path /var/log/fluentd-buffers/kubernetes.system.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 5s
    retry_forever
    retry_max_interval 30
    chunk_limit_size &#34;#{ENV[&#39;OUTPUT_BUFFER_CHUNK_LIMIT&#39;]}&#34;
    queue_limit_length &#34;#{ENV[&#39;OUTPUT_BUFFER_QUEUE_LIMIT&#39;]}&#34;
    overflow_action block
  &lt;/buffer&gt;
&lt;/match&gt;
</code></pre><ul>
<li>matchï¼šæ ‡è¯†ä¸€ä¸ªç›®æ ‡æ ‡ç­¾ï¼Œåé¢æ˜¯ä¸€ä¸ªåŒ¹é…æ—¥å¿—æºçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬è¿™é‡Œæƒ³è¦æ•è·æ‰€æœ‰çš„æ—¥å¿—å¹¶å°†å®ƒä»¬å‘é€ç»™ Elasticsearchï¼Œæ‰€ä»¥éœ€è¦é…ç½®æˆ**ã€‚</li>
<li>idï¼šç›®æ ‡çš„ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ã€‚</li>
<li>typeï¼šæ”¯æŒçš„è¾“å‡ºæ’ä»¶æ ‡è¯†ç¬¦ï¼Œæˆ‘ä»¬è¿™é‡Œè¦è¾“å‡ºåˆ° Elasticsearchï¼Œæ‰€ä»¥é…ç½®æˆ elasticsearchï¼Œè¿™æ˜¯ Fluentd çš„ä¸€ä¸ªå†…ç½®æ’ä»¶ã€‚</li>
<li>log_levelï¼šæŒ‡å®šè¦æ•è·çš„æ—¥å¿—çº§åˆ«ï¼Œæˆ‘ä»¬è¿™é‡Œé…ç½®æˆ infoï¼Œè¡¨ç¤ºä»»ä½•è¯¥çº§åˆ«æˆ–è€…è¯¥çº§åˆ«ä»¥ä¸Šï¼ˆINFOã€WARNINGã€ERRORï¼‰çš„æ—¥å¿—éƒ½å°†è¢«è·¯ç”±åˆ° Elsasticsearchã€‚</li>
<li>host/portï¼šå®šä¹‰ Elasticsearch çš„åœ°å€ï¼Œä¹Ÿå¯ä»¥é…ç½®è®¤è¯ä¿¡æ¯ï¼Œæˆ‘ä»¬çš„ Elasticsearch ä¸éœ€è¦è®¤è¯ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥æŒ‡å®š host å’Œ port å³å¯ã€‚</li>
<li>logstash_formatï¼šElasticsearch æœåŠ¡å¯¹æ—¥å¿—æ•°æ®æ„å»ºåå‘ç´¢å¼•è¿›è¡Œæœç´¢ï¼Œå°† logstash_format è®¾ç½®ä¸º trueï¼ŒFluentd å°†ä¼šä»¥ logstash æ ¼å¼æ¥è½¬å‘ç»“æ„åŒ–çš„æ—¥å¿—æ•°æ®ã€‚</li>
<li>Bufferï¼š Fluentd å…è®¸åœ¨ç›®æ ‡ä¸å¯ç”¨æ—¶è¿›è¡Œç¼“å­˜ï¼Œæ¯”å¦‚ï¼Œå¦‚æœç½‘ç»œå‡ºç°æ•…éšœæˆ–è€… Elasticsearch ä¸å¯ç”¨çš„æ—¶å€™ã€‚ç¼“å†²åŒºé…ç½®ä¹Ÿæœ‰åŠ©äºé™ä½ç£ç›˜çš„ IOã€‚</li>
</ul>
<h3 id="å¼€å§‹éƒ¨ç½²fluentd">å¼€å§‹éƒ¨ç½²Fluentd</h3>
<p>è¦æ”¶é›† Kubernetes é›†ç¾¤çš„æ—¥å¿—ï¼Œç›´æ¥ç”¨<code>DasemonSet</code> æ§åˆ¶å™¨æ¥éƒ¨ç½² Fluentd åº”ç”¨ï¼Œè¿™æ ·ï¼Œå®ƒå°±å¯ä»¥ä» Kubernetes èŠ‚ç‚¹ä¸Šé‡‡é›†æ—¥å¿—ï¼Œç¡®ä¿åœ¨é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šå§‹ç»ˆè¿è¡Œä¸€ä¸ª Fluentd å®¹å™¨ã€‚å½“ç„¶å¯ä»¥ç›´æ¥ä½¿ç”¨ Helm æ¥è¿›è¡Œä¸€é”®å®‰è£…ï¼Œä¸ºäº†èƒ½å¤Ÿäº†è§£æ›´å¤šå®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯é‡‡ç”¨æ‰‹åŠ¨æ–¹æ³•æ¥è¿›è¡Œå®‰è£…ã€‚</p>
<ul>
<li><a class="link" href="https://docs.fluentd.org/container-deployment/kubernetes"  target="_blank" rel="noopener"
    >å®‰è£…æ–‡æ¡£</a></li>
</ul>
<ol>
<li>é¦–å…ˆåˆ›å»º<code>fluentd</code>çš„<code>configmap</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># fluentd-configmap.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd-conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># containerdçš„å®¹å™¨æ—¥å¿—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containerd.input.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;source&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">      @id containerd-fluentd-beta.log         # å”¯ä¸€Idï¼šè¿è¡Œæ—¶+æ”¶é›†æ’ä»¶+ç¯å¢ƒ
</span></span></span><span class="line"><span class="cl"><span class="sd">      @type tail                              # Fluentd å†…ç½®çš„è¾“å…¥æ–¹å¼ï¼Œå…¶åŸç†æ˜¯ä¸åœåœ°ä»æºæ–‡ä»¶ä¸­è·å–æ–°çš„æ—¥å¿—
</span></span></span><span class="line"><span class="cl"><span class="sd">      path /var/log/containers/*.log          # Docker å®¹å™¨æ—¥å¿—è·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="sd">      pos_file /var/log/es-containers.log.pos  # è®°å½•è¯»å–çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="sd">      tag raw.kubernetes.*                    # è®¾ç½®æ—¥å¿—æ ‡ç­¾
</span></span></span><span class="line"><span class="cl"><span class="sd">      read_from_head true                     # ä»å¤´è¯»å–
</span></span></span><span class="line"><span class="cl"><span class="sd">      &lt;parse&gt;                                 # å¤šè¡Œæ ¼å¼åŒ–æˆJSON
</span></span></span><span class="line"><span class="cl"><span class="sd">        # å¯ä»¥ä½¿ç”¨æˆ‘ä»¬ä»‹ç»è¿‡çš„ multiline æ’ä»¶å®ç°å¤šè¡Œæ—¥å¿—
</span></span></span><span class="line"><span class="cl"><span class="sd">        @type multi_format                    # ä½¿ç”¨ multi-format-parser è§£æå™¨æ’ä»¶
</span></span></span><span class="line"><span class="cl"><span class="sd">        &lt;pattern&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">          format json                         # JSONè§£æå™¨
</span></span></span><span class="line"><span class="cl"><span class="sd">          time_key time                       # æŒ‡å®šäº‹ä»¶æ—¶é—´çš„æ—¶é—´å­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="sd">          time_format %Y-%m-%dT%H:%M:%S.%NZ   # æ—¶é—´æ ¼å¼
</span></span></span><span class="line"><span class="cl"><span class="sd">        &lt;/pattern&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">        &lt;pattern&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/
</span></span></span><span class="line"><span class="cl"><span class="sd">          time_format %Y-%m-%dT%H:%M:%S.%N%:z
</span></span></span><span class="line"><span class="cl"><span class="sd">        &lt;/pattern&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">      &lt;/parse&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;/source&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    # åœ¨æ—¥å¿—è¾“å‡ºä¸­æ£€æµ‹å¼‚å¸¸(å¤šè¡Œæ—¥å¿—)ï¼Œå¹¶å°†å…¶ä½œä¸ºä¸€æ¡æ—¥å¿—è½¬å‘
</span></span></span><span class="line"><span class="cl"><span class="sd">    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;match raw.kubernetes.**&gt;           # åŒ¹é…tagä¸ºraw.kubernetes.**æ—¥å¿—ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="sd">      @id raw.kubernetes
</span></span></span><span class="line"><span class="cl"><span class="sd">      @type detect_exceptions           # ä½¿ç”¨detect-exceptionsæ’ä»¶å¤„ç†å¼‚å¸¸æ ˆä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="sd">      remove_tag_prefix raw             # ç§»é™¤ raw å‰ç¼€
</span></span></span><span class="line"><span class="cl"><span class="sd">      message log
</span></span></span><span class="line"><span class="cl"><span class="sd">      multiline_flush_interval 5
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;/match&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;filter **&gt;  # æ‹¼æ¥æ—¥å¿—
</span></span></span><span class="line"><span class="cl"><span class="sd">      @id filter_concat
</span></span></span><span class="line"><span class="cl"><span class="sd">      @type concat                # Fluentd Filter æ’ä»¶ï¼Œç”¨äºè¿æ¥å¤šä¸ªæ—¥å¿—ä¸­åˆ†éš”çš„å¤šè¡Œæ—¥å¿—
</span></span></span><span class="line"><span class="cl"><span class="sd">      key message
</span></span></span><span class="line"><span class="cl"><span class="sd">      multiline_end_regexp /\n$/  # ä»¥æ¢è¡Œç¬¦â€œ\nâ€æ‹¼æ¥
</span></span></span><span class="line"><span class="cl"><span class="sd">      separator &#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;/filter&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    # æ·»åŠ  Kubernetes metadata æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;filter kubernetes.**&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">      @id filter_kubernetes_metadata
</span></span></span><span class="line"><span class="cl"><span class="sd">      @type kubernetes_metadata
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;/filter&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    # ä¿®å¤ ES ä¸­çš„ JSON å­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="sd">    # æ’ä»¶åœ°å€ï¼šhttps://github.com/repeatedly/fluent-plugin-multi-format-parser
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;filter kubernetes.**&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">      @id filter_parser
</span></span></span><span class="line"><span class="cl"><span class="sd">      @type parser                # multi-format-parserå¤šæ ¼å¼è§£æå™¨æ’ä»¶
</span></span></span><span class="line"><span class="cl"><span class="sd">      key_name log                # åœ¨è¦è§£æçš„æ—¥å¿—ä¸­æŒ‡å®šå­—æ®µåç§°
</span></span></span><span class="line"><span class="cl"><span class="sd">      reserve_data true           # åœ¨è§£æç»“æœä¸­ä¿ç•™åŸå§‹é”®å€¼å¯¹
</span></span></span><span class="line"><span class="cl"><span class="sd">      remove_key_name_field true  # key_name è§£ææˆåŠŸååˆ é™¤å­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="sd">      &lt;parse&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">        @type multi_format
</span></span></span><span class="line"><span class="cl"><span class="sd">        &lt;pattern&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">          format json
</span></span></span><span class="line"><span class="cl"><span class="sd">        &lt;/pattern&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">        &lt;pattern&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">          format none
</span></span></span><span class="line"><span class="cl"><span class="sd">        &lt;/pattern&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">      &lt;/parse&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;/filter&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    # åˆ é™¤ä¸€äº›å¤šä½™çš„å±æ€§
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;filter kubernetes.**&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">      @type record_transformer
</span></span></span><span class="line"><span class="cl"><span class="sd">      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;/filter&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    # åªä¿ç•™å…·æœ‰kubernetes.log.kubernetes.log/fluentdæ ‡ç­¾çš„Podæ—¥å¿—
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;filter kubernetes.**&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">      @id filter_log
</span></span></span><span class="line"><span class="cl"><span class="sd">      @type grep
</span></span></span><span class="line"><span class="cl"><span class="sd">      &lt;regexp&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">        key $.kubernetes.labels.kubernetes.log/fluentd
</span></span></span><span class="line"><span class="cl"><span class="sd">        pattern ^true$
</span></span></span><span class="line"><span class="cl"><span class="sd">      &lt;/regexp&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;/filter&gt;</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">###### ç›‘å¬é…ç½®ï¼Œä¸€èˆ¬ç”¨äºæ—¥å¿—èšåˆç”¨ ######</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">forward.input.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    # ç›‘å¬é€šè¿‡TCPå‘é€çš„æ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;source&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">      @id forward
</span></span></span><span class="line"><span class="cl"><span class="sd">      @type forward
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;/source&gt;</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">output.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;match **&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">      @id elasticsearch
</span></span></span><span class="line"><span class="cl"><span class="sd">      @type elasticsearch
</span></span></span><span class="line"><span class="cl"><span class="sd">      @log_level info
</span></span></span><span class="line"><span class="cl"><span class="sd">      include_tag_key true
</span></span></span><span class="line"><span class="cl"><span class="sd">      host elasticsearch-client
</span></span></span><span class="line"><span class="cl"><span class="sd">      port 9200
</span></span></span><span class="line"><span class="cl"><span class="sd">      user elastic # FLUENT_ELASTICSEARCH_USER | FLUENT_ELASTICSEARCH_PASSWORD
</span></span></span><span class="line"><span class="cl"><span class="sd">      password elastic-master
</span></span></span><span class="line"><span class="cl"><span class="sd">      logstash_format true
</span></span></span><span class="line"><span class="cl"><span class="sd">      logstash_prefix kubernetes-cluster
</span></span></span><span class="line"><span class="cl"><span class="sd">      request_timeout 30s
</span></span></span><span class="line"><span class="cl"><span class="sd">      &lt;buffer&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">        @type file
</span></span></span><span class="line"><span class="cl"><span class="sd">        path /var/log/fluentd-buffers/kubernetes.system.buffer
</span></span></span><span class="line"><span class="cl"><span class="sd">        flush_mode interval
</span></span></span><span class="line"><span class="cl"><span class="sd">        retry_type exponential_backoff
</span></span></span><span class="line"><span class="cl"><span class="sd">        flush_thread_count 2
</span></span></span><span class="line"><span class="cl"><span class="sd">        flush_interval 5s
</span></span></span><span class="line"><span class="cl"><span class="sd">        retry_forever
</span></span></span><span class="line"><span class="cl"><span class="sd">        retry_max_interval 30
</span></span></span><span class="line"><span class="cl"><span class="sd">        chunk_limit_size 2M
</span></span></span><span class="line"><span class="cl"><span class="sd">        queue_limit_length 8
</span></span></span><span class="line"><span class="cl"><span class="sd">        overflow_action block
</span></span></span><span class="line"><span class="cl"><span class="sd">      &lt;/buffer&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">    &lt;/match&gt;</span><span class="w">    
</span></span></span></code></pre></div><ol start="2">
<li>åˆ›å»ºç›¸å…³çš„Rbacæƒé™</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">namespaces</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>åˆ›å»º<code>fluentd</code>çš„<code>daemonset</code></li>
</ol>
<blockquote>
<p>è¿™ä¸ªæ˜¯æœ€æ–°çš„ç‰ˆæœ¬è¿˜åœ¨ç ”ç©¶ä¸­,ç”¨ä¸‹é¢çš„ç‰ˆæœ¬ã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/control-plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">K8S_NODE_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">spec.nodeName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w">  </span><span class="l">FLUENT_ELASTICSEARCH_HOST</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;elasticsearch-client-headless.kube-logging.svc.cluster.local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w">  </span><span class="l">FLUENT_ELASTICSEARCH_PORT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;9200&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENT_ELASTICSEARCH_SCHEME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># Option to configure elasticsearch plugin with self signed certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># ================================================================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENT_ELASTICSEARCH_SSL_VERIFY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># Option to configure elasticsearch plugin with tls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># ================================================================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENT_ELASTICSEARCH_SSL_VERSION</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;TLSv1_2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># X-Pack Authentication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># =====================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENT_ELASTICSEARCH_USER</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;elastic&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENT_ELASTICSEARCH_PASSWORD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;elastic-master&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENT_ELASTICSEARCH_LOGSTASH_PREFIX</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kubernetes-cluster&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">200Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">200Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentconfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/fluentd/etc/custom</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dockercontainerlogdirectory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentconfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd-conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dockercontainerlogdirectory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/pods</span><span class="w">
</span></span></span></code></pre></div><p>éº»çƒ¦ç”¨ä¸‹é¢çš„è¿›è¡Œéƒ¨ç½²</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/cluster-service</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/cluster-service</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/fluentd_elasticsearch/fluentd:v3.4.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentconfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/fluent/config.d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentconfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd-conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log</span><span class="w">
</span></span></span></code></pre></div><h2 id="å…³äºä¿ç•™æŒ‡å®šæ ‡ç­¾çš„é—®é¢˜">å…³äºä¿ç•™æŒ‡å®šæ ‡ç­¾çš„é—®é¢˜</h2>
<p>éƒ¨ç½²å®Œæˆä»¥åæˆ‘å‘ç°ä¸€ç›´æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå°±æ˜¯æ— è®ºæˆ‘å¦‚ä½•è®¾ç½®<code>label</code>éƒ½æ— æ³•è®©<code>elasticsearch</code>è·å–åˆ°æ­£å¸¸çš„æ•°æ®ã€‚</p>
<p>æ ¹æ®è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘è¿›è¡Œäº†æ›´ç»†è‡´çš„æ’æŸ¥ã€‚ç°åœ¨å¾—å‡ºäº†å¦‚ä¸‹çš„ç»“è®ºã€‚</p>
<ol>
<li>
<p>å¯èƒ½æ˜¯ç”±äºæˆ‘å¯¹çŸ¥è¯†çš„ç¼ºä¹ï¼Œæˆ‘å®šä¹‰çš„æ˜¯<code>Deployment</code>å½“ä¸­çš„<code>label</code>æ ‡ç­¾ï¼Œä½†æ˜¯è¿™ä¸ª<code>label</code>æ ‡è¯†åªä½œç”¨äº<code>Deployment</code>æœ¬èº«ï¼Œé€šå¸¸ç”¨ä½œ<code>kubernete</code>é›†ç¾¤ä¸­çš„é€‰æ‹©å™¨åŒ¹é…ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„<code>Service</code>è¦å»åŒ¹é…æŸä¸ª<code>Deployment</code>ã€‚</p>
</li>
<li>
<p>å…³äº<code>spec.template.metadata.labels</code>ï¼Œæˆ‘å‘ç°è¿™ä¸ªæ‰æ˜¯æˆ‘ä»¬æ­£ç¡®è¦åŒ¹é…çš„<code>label</code>æ ‡ç­¾é€‰é¡¹ï¼Œå› ä¸ºè¿™äº›æ ‡ç­¾ç”¨äºæ ‡è¯†<code>Deployment</code>æ‰€åˆ›å»ºçš„<code>Pod</code></p>
</li>
<li>
<p>æ‰€ä»¥æœ€åæ€»ç»“å‡ºæ¥çš„é—®é¢˜å°±æ˜¯ï¼Œæˆ‘ä»¬ä¸Šé¢çš„<code>fluentd</code>ä¸­å†™çš„è¿‡æ»¤æ’ä»¶<code> key $.kubernetes.labels.kubernetes.log/fluentd</code>ä¸­æ‰€åŒ¹é…çš„<code>label</code>æ ‡ç­¾åº”å½“æ˜¯<code>spec.template.metadata.labels</code>çš„<code>label</code></p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">canary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">canary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubernetes.log/fluentd</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>Kubernetesçš„æ¶æ„è®¾è®¡å’Œå¯¹è±¡å±æ€§åŸºæœ¬ç†è§£</title>
      <link>https://blog.mletter.cn/tech/kubernetes/architectural-design/</link>
      <pubDate>Tue, 07 Nov 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/architectural-design/</guid>
      <description>ä¸»è¦è®²è§£kubernetesçš„ç»„æˆå’Œç»„ä»¶çš„å…·ä½“ä½œç”¨</description>
      <content:encoded><![CDATA[<h2 id="ä¸ºä»€ä¹ˆéœ€è¦kubernetes">ä¸ºä»€ä¹ˆéœ€è¦kubernetesï¼Ÿ</h2>
<ul>
<li>å¤§è§„æ¨¡å¤šèŠ‚ç‚¹å®¹å™¨è°ƒåº¦</li>
<li>å¿«é€Ÿæ‰©ç¼©å®¹</li>
<li>æ•…éšœè‡ªæ„ˆ</li>
<li>å¼¹æ€§ä¼¸ç¼©</li>
<li>æŠ€æœ¯è¶‹åŠ¿</li>
<li>ä¸€è‡´æ€§ã€ä¸é”å®š
æ—©æœŸå‹å¤šçš„ä¸€äº›æœåŠ¡éƒ½å±äºå•ä½“æœåŠ¡ã€å•èŠ‚ç‚¹ã€å•è¿›ç¨‹çš„ä¸€ç§å•ä½“æœåŠ¡æ¶æ„ï¼Œåç»­éšç€æŠ€æœ¯çš„å‘å±•è¡ç”Ÿå‡ºäº†å®¹å™¨æŠ€æœ¯ã€‚å®¹å™¨æŠ€æœ¯å…¶å®ä¹Ÿä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„å¤šèŠ‚ç‚¹ã€åˆ†å¸ƒå¼çš„åº”ç”¨æ¶æ„ä½“ç³»ï¼Œä»è€Œè¡ç”Ÿå‡ºäº†<code>kubernetes</code>å®¹å™¨ç¼–æ’å¼•æ“ã€‚</li>
</ul>
<p>é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ—©æœŸå•ä½“å®¹å™¨æ¶æ„</p>
<blockquote>
<p>å…¶å®å¯¹äºå®¹å™¨åŒ–æŠ€æœ¯å¸¦æ¥äº†é‚£äº›ä¼˜åŠ¿å‘¢?</p>
</blockquote>
<ol>
<li>å…¶å®æˆ‘è§‰å¾—å®¹å™¨åŒ–å¸¦æ¥çš„æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯äº¤ä»˜å’Œéƒ¨ç½²çš„ä¼˜åŠ¿</li>
</ol>
<p><!doctype html>
<html lang="en">
    <head>
        <meta
            name="viewport"
            content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"
        />
        <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js"></script>
        <link
            href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/nanogallery2/3.0.5/css/nanogallery2.min.css"
            rel="stylesheet"
        />
        <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/nanogallery2/3.0.5/jquery.nanogallery2.min.js"></script>
    </head>
    <body>
        <div
            data-nanogallery2='{
    "itemsBaseURL":               "https://nanogallery2.nanostudio.org/samples",
    "thumbnailDisplayTransition":          "slideUp2",
	"thumbnailHeight":    200,
    "thumbnailWidth":     200,
    "thumbnailAlignment": "fillWidth",
    "thumbnailOpenInLightox": true,
    "breadcrumbOnlyCurrentLevel": true,
    "thumbnailLabel":     { "valign": "bottom", "position": "overImage", "hideIcons": true },
    "galleryMosaic" :   [
      { "c": 1, "r": 1, "w": 2, "h": 2 },
      { "c": 3, "r": 1, "w": 1, "h": 1 },
      { "c": 3, "r": 2, "w": 1, "h": 1 },
      { "c": 4, "r": 1, "w": 1, "h": 1 },
      { "c": 4, "r": 2, "w": 1, "h": 1 }
    ],
    "galleryLastRowFull" : true,
     "thumbnailDisplayTransitionDuration":  500,
     "thumbnailDisplayInterval":            30,
     "galleryDisplayTransition":            "rotateX",
     "galleryDisplayTransitionDuration":    500,
     "galleryDisplayMode": "rows",
     "thumbnailDisplayOutsideScreen": "true",
     "eventsDebounceDelay": 10,
     "thumbnailL1BorderHorizontal": 0,
     "thumbnailL1BorderVertical": 0,
     "thumbnailLabel": {
        "titleFontSize": "0.6em"
     },
     "thumbnailHoverEffect2": "image_scale_1.00_1.10|label_backgroundColor_rgba(0,0,0,0)_rgba(255,255,255,0)",
     "galleryTheme": {
        "thumbnail": {
            "borderRadius": "8px"
        }
     },
     "thumbnailToolbarImage": {
        "topLeft": "",
        "topRight": "",
        "bottomLeft": "",
        "bottomRight": ""
     },
     "viewerToolbar":   {
        "display": true,
        "standard": "label"
     },
     "viewerTools":     {
        "topLeft":    "pageCounter, playPauseButton",
        "topRight":   "downloadButton, rotateLeft, zoomButton, fullscreenButton, closeButton"
     },
     "viewerGalleryTWidth": 40,
     "viewerGalleryTHeight": 40
}'
        >
            

<a href="https://img13.360buyimg.com/ddimg/jfs/t1/164078/6/34165/22231/654ba81fFe1bf21d7/9d02bd791b795b3b.jpg" data-ngThumb="https://img13.360buyimg.com/ddimg/jfs/t1/164078/6/34165/22231/654ba81fFe1bf21d7/9d02bd791b795b3b.jpg">å®¹å™¨å•ç‚¹æ¶æ„æµç¨‹å›¾</a>



        </div>
    </body>
</html>

é‚£ä¹ˆéšä¹‹è€Œæ¥å¸¦æ¥çš„é—®é¢˜æ˜¯:</p>
<blockquote>
<p>é‚£ä¹ˆç”±äºDockerçš„å®¹å™¨é•œåƒå¯ä»¥åœ¨Aã€Bã€Cä»»æ„ä¸€å°æœºå™¨ä¸Šè¿è¡Œ,é‚£ä¹ˆæ˜¯å¦å¯ä»¥å½“Aæœºå™¨æ‰€è¿è¡Œçš„é•œåƒæŒ‚æ‰ä»¥åè‡ªåŠ¨çš„å¸®æˆ‘åœ¨Bæœºå™¨ä¸Šè¿›è¡Œé‡å¯å‘¢?</p>
</blockquote>
<p>okey å¸¦ç€è¿™ä¸ªé—®é¢˜ ä¸€èµ·å¾€ä¸‹è¿›è¡Œã€‚</p>
<h2 id="kubernesç»„ä»¶">kubernesç»„ä»¶</h2>
<p>å…ˆçœ‹ä¸€å¼ å®˜æ–¹ç»™å‡ºçš„kubernetesçš„æ¶æ„å›¾
å›¾ä¸­åˆ—å‡ºäº†kubernetesçš„ç»„æˆä»¥åŠç›¸å¯¹åº”çš„ç»„ä»¶</p>
<ul>
<li>ControlPlane: æ§åˆ¶å¹³é¢èŠ‚ç‚¹</li>
<li>Node: å·¥ä½œèŠ‚ç‚¹</li>
<li>Kubelet: ç”¨äºæ§åˆ¶<code>staticPod</code>,å…¶ä¸»è¦å°±æ˜¯ç”¨æ¥æ§åˆ¶é™æ€Podï¼Œå› ä¸ºé™æ€Podä¸å—<code>ApiServer</code>çš„å½±å“ã€‚
<img style="max-width: 100%; height: auto;" loading="lazy" loading="lazy" src="https://kubernetes.io/images/docs/components-of-kubernetes.svg"></li>
</ul>
<p>Oh ä¸æ’ä¸€å¥å˜´ å­¦åˆ°äº†ä¸€ä¸ªæ–°çš„å‘½ä»¤</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># jqå‘½ä»¤æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†jsonçš„å‘½ä»¤</span>
</span></span><span class="line"><span class="cl">kubectl get deploy wecho-canary -o json <span class="p">|</span> jq .spec
</span></span></code></pre></div><p>okey ç»§ç»­&hellip;
æˆ‘ä»¬æ—¶é•¿è°ˆèµ·åˆ°çš„<code>control-plane</code>å®é™…ä¸Šå¹¶ä¸æ˜¯ä¸€å°æœºå™¨ä»–åªæ˜¯ä¸€ä¸ªæŠ½è±¡å‡ºæ¥çš„æ¦‚å¿µ,å®é™…ä¸Šæˆ‘ä»¬æ˜¯åœ¨è¯´æ‰€è°“çš„<code>control-plane</code>å±‚é¢çš„ç»„ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™äº›ç»„ä»¶å¯ä»¥è¿è¡Œåœ¨æ§åˆ¶é¢çš„æœºå™¨ä¸ŠåŒæ—¶ä¹Ÿå¯ä»¥è¿è¡Œåœ¨Nodeæœºå™¨ä¸Š</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="Pasted image 20231108213644.png" loading="lazy" src="https://img14.360buyimg.com/ddimg/jfs/t1/231911/36/2404/28759/654ba847Fc032ef5e/32d3a1f4a8f2b4c4.jpg"></p>
<h2 id="kubernetesæ ¸å¿ƒæ¦‚å¿µ">kubernetesæ ¸å¿ƒæ¦‚å¿µ</h2>
<ul>
<li><code>ResourceObject</code>: æ˜¯æˆ‘è®¤ä¸ºç›¸å¯¹è€Œè¨€kubernetesé›†ç¾¤å½“ä¸­æ¯”è¾ƒæ ¸å¿ƒçš„èµ„æºå¯¹è±¡,å…¶å®ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„<code>Pod</code>ã€<code>Deployment</code>ã€<code>Daemonset</code>ç­‰kubernetesçš„èµ„æºç±»å‹
å¯¹äºä¸€ä¸ªPodè€Œè¨€,kuberneteså¯¹å…¶å®šä¹‰çš„é”®å€¼æ— éä»¥ä¸‹çš„å‡ ç§</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span><span class="err">root@Online-Beijing-master</span><span class="mi">1</span> <span class="err">~</span><span class="p">]</span><span class="err">#</span> <span class="err">kubectl</span> <span class="err">get</span> <span class="err">deploy</span> <span class="err">wecho-canary</span> <span class="err">-o</span> <span class="err">json</span> <span class="err">|</span> <span class="err">jq</span> <span class="err">keys</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;apiVersion&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;metadata&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;spec&#34;</span><span class="p">,</span>   <span class="c1">// specæè¿°çš„æ˜¯Podé¢„æœŸçš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="s2">&#34;status&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>ä½ å¯ä»¥é€šè¿‡<code>kubectl api-resource</code>æ¥è·å–kubernetesç›¸å¯¹åº”çš„èµ„æºç±»å‹ã€‚</p>
<h3 id="kubernetsçš„èµ„æºæäº¤">kubernetsçš„èµ„æºæäº¤</h3>
<p>æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„<code>kubectl run nginx-$RANDOM --image=&quot;nginx:alpine&quot;</code>ç©¶ç«Ÿæ˜¯æ‰§è¡Œäº†ä»€ä¹ˆæ ·çš„å†…å®¹ï¼Ÿ</p>
<p>æ­£å¸¸æ¥è¯´<code>Api-Server</code>æœ¬èº«å°±æ˜¯æœåŠ¡,é‚£ä¹ˆå½“æˆ‘æŠŠè¯·æ±‚å‘é€ç»™<code>Api-Server</code>çš„æ—¶å€™,æˆ‘æ˜¯ä»¥ä»€ä¹ˆæ ·çš„è¯·æ±‚å†…å®¹è¿›è¡Œäº†æäº¤?é‚£<code>Api-Server</code>æ¥æ”¶äº†æˆ‘çš„è¯·æ±‚å†…å®¹åˆå¯¹æˆ‘çš„è¯·æ±‚å†…å®¹åšå‡ºäº†ä»€ä¹ˆæ ·çš„å¤„ç†å‘¢?</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹å®é™…ä½œä¸ºå®¢æˆ·ç«¯,ä¹Ÿå°±æ˜¯<code>client</code>ç«¯æäº¤çš„è¯·æ±‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># å¯ä»¥é€šè¿‡--dry-run=clientæ¥æ¨¡æ‹Ÿå®¢æˆ·ç«¯æäº¤çš„è¯·æ±‚å†…å®¹</span>
</span></span><span class="line"><span class="cl">kubectl run nginx-<span class="nv">$RANDOM</span> --image<span class="o">=</span><span class="s2">&#34;nginx:alpine&#34;</span> --dry-run<span class="o">=</span>client -ojson -v6
</span></span></code></pre></div><p>æ­£å¸¸çš„è¿”å›å“åº”åº”è¯¥å¦‚ä¸‹,è¿™æ˜¯ä¸€ä¸ªæˆ‘ä»¬æ­£å¸¸é€šè¿‡kubeletåˆ›å»ºä¸€ä¸ªPodæ‰€å‘é€çš„è¯·æ±‚ä½“å†…å®¹,ä½†ä½œä¸ºclinetåªä¼šåœ¨æˆ‘ä»¬æœ¬åœ°è¿›è¡Œå¤„ç†,æ‰€ä»¥ä½ ä¹Ÿå¯ä»¥çœ‹åˆ°è¿”å›çš„ç»“æ„å†…å®¹ä¸­å¸¦æœ‰<code>I1108 21:54:49.922270 1219589 loader.go:374] Config loaded from file:  /root/.kube/config</code>,ä¹Ÿå°±è¯æ˜äº†å®ƒå¹¶æ²¡æœ‰åƒApi-Serverå‘é€ä»»ä½•è¯·æ±‚,åªæ˜¯è¯»å–äº†ç›¸å…³çš„é…ç½®ä¿¡æ¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;Pod&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;apiVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;nginx-27147&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;creationTimestamp&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;labels&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;run&#34;</span><span class="p">:</span> <span class="s2">&#34;nginx-27147&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;spec&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;containers&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;nginx-27147&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;nginx:alpine&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;resources&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;restartPolicy&#34;</span><span class="p">:</span> <span class="s2">&#34;Always&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;dnsPolicy&#34;</span><span class="p">:</span> <span class="s2">&#34;ClusterFirst&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¾ˆå¥½ä¸Šé¢æˆ‘ä»¬æ¨¡æ‹Ÿäº†ä¸€ä¸ª<code>client</code>ç«¯æ‰€ç”Ÿäº§çš„å†…å®¹,é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬çœ‹çœ‹å½“å®é™…å‘é€ç»™<code>Api-Server</code>çš„æ—¶å€™äº§ç”Ÿäº†å“ªäº›å†…å®¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl run nginx-<span class="nv">$RANDOM</span> --image<span class="o">=</span><span class="s2">&#34;nginx:alpine&#34;</span> --dry-run<span class="o">=</span>server -ojson -v6
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°æ—¥å¿—çš„è¾“å‡º</p>
<ol>
<li>é¦–å…ˆç¬¬ä¸€æ­¥åŠ è½½äº†kubernetesç›¸å…³çš„é…ç½®æ–‡ä»¶ä¿¡æ¯ã€‚</li>
<li>å‘é€äº†ç›¸å…³è¯·æ±‚(ç›²çŒœåº”è¯¥æ˜¯éªŒè¯api-serveræ˜¯å¦æ­£å¸¸)</li>
<li>å‘<code>https://resk8s.api.beijing.io:8443/api/v1/namespaces/default/pods?dryRun=All&amp;fieldManager=kubectl-run</code>å‘é€äº†POSTè¯·æ±‚ç”¨äºåˆ›å»ºPod</li>
</ol>
<pre tabindex="0"><code class="language-log" data-lang="log">I1108 21:58:14.866131 1221713 loader.go:374] Config loaded from file:  /root/.kube/config
I1108 21:58:14.884329 1221713 round_trippers.go:553] GET https://resk8s.api.beijing.io:8443/openapi/v2?timeout=32s 200 OK in 15 milliseconds
I1108 21:58:14.946553 1221713 round_trippers.go:553] POST https://resk8s.api.beijing.io:8443/api/v1/namespaces/default/pods?dryRun=All&amp;fieldManager=kubectl-run 201 Created in 15 milliseconds
</code></pre><p>äº‹å®ä¸Šæˆ‘ä»¬ç”±æ­¤å¯è§å‘é€åˆ°<code>Api-Server</code>çš„è¯·æ±‚å†…å®¹å¤šäº†å¾ˆå¤šä¸œè¥¿</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;Pod&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;apiVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;nginx-14483&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;uid&#34;</span><span class="p">:</span> <span class="s2">&#34;d27e1836-8bac-40d4-805b-420f4bca4ee1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;creationTimestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-11-08T14:05:36Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;labels&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;run&#34;</span><span class="p">:</span> <span class="s2">&#34;nginx-14483&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;annotations&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kubernetes.customized/fabric-networks&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;spec&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;volumes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;kube-api-access-vwtvp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;projected&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;sources&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;serviceAccountToken&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;expirationSeconds&#34;</span><span class="p">:</span> <span class="mi">3607</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;token&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;configMap&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;kube-root-ca.crt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;items&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;ca.crt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;ca.crt&#34;</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="p">]</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;downwardAPI&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;items&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;namespace&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="nt">&#34;fieldRef&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="nt">&#34;apiVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                            <span class="nt">&#34;fieldPath&#34;</span><span class="p">:</span> <span class="s2">&#34;metadata.namespace&#34;</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="p">]</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;defaultMode&#34;</span><span class="p">:</span> <span class="mi">420</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;containers&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;nginx-14483&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;nginx:alpine&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;resources&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;volumeMounts&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;kube-api-access-vwtvp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;readOnly&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;mountPath&#34;</span><span class="p">:</span> <span class="s2">&#34;/var/run/secrets/kubernetes.io/serviceaccount&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;terminationMessagePath&#34;</span><span class="p">:</span> <span class="s2">&#34;/dev/termination-log&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;terminationMessagePolicy&#34;</span><span class="p">:</span> <span class="s2">&#34;File&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;imagePullPolicy&#34;</span><span class="p">:</span> <span class="s2">&#34;IfNotPresent&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;restartPolicy&#34;</span><span class="p">:</span> <span class="s2">&#34;Always&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;terminationGracePeriodSeconds&#34;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;dnsPolicy&#34;</span><span class="p">:</span> <span class="s2">&#34;ClusterFirst&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;serviceAccountName&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;serviceAccount&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;securityContext&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;schedulerName&#34;</span><span class="p">:</span> <span class="s2">&#34;default-scheduler&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;tolerations&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;node.kubernetes.io/not-ready&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;operator&#34;</span><span class="p">:</span> <span class="s2">&#34;Exists&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;effect&#34;</span><span class="p">:</span> <span class="s2">&#34;NoExecute&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;tolerationSeconds&#34;</span><span class="p">:</span> <span class="mi">300</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;node.kubernetes.io/unreachable&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;operator&#34;</span><span class="p">:</span> <span class="s2">&#34;Exists&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;effect&#34;</span><span class="p">:</span> <span class="s2">&#34;NoExecute&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;tolerationSeconds&#34;</span><span class="p">:</span> <span class="mi">300</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;priority&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;dnsConfig&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;options&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;single-request-reopen&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enableServiceLinks&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;preemptionPolicy&#34;</span><span class="p">:</span> <span class="s2">&#34;PreemptLowerPriority&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;phase&#34;</span><span class="p">:</span> <span class="s2">&#34;Pending&#34;</span><span class="p">,</span> <span class="c1">// å¯ä»¥çœ‹åˆ°å½“å‰å¤„äºPendingé˜¶æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nt">&#34;qosClass&#34;</span><span class="p">:</span> <span class="s2">&#34;BestEffort&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>å¦å¤–: å½“ä½ éœ€è¦åˆ›å»ºèµ„æºç±»å‹çš„æ—¶å€™,æˆ‘å¹¶ä¸å»ºè®®ä½ ä»å¤´å¼€å§‹å»ç¼–å†™ç›¸å…³æ–‡ä»¶,å¯ä»¥çµæ´»çš„åº”ç”¨<code>kubectl run</code>æ¥è¿›è¡Œå¡«å……ç›¸å…³çš„å­—æ®µä¿¡æ¯ã€‚</p>
</blockquote>
<h2 id="kubernetesè®¾è®¡ç†å¿µ">kubernetesè®¾è®¡ç†å¿µ</h2>
<ul>
<li>å£°æ˜å¼ï¼šå…¸å‹å°±æ˜¯åœ¨èµ„æºæ–‡ä»¶ä¸­è¿›è¡Œå£°æ˜</li>
<li>æ— ä¾µå…¥æ€§</li>
<li>å¯ç§»æ¤: æ‰€æœ‰ç¬¦åˆkubernetesæ ‡å‡†çš„kuberneteså¹³å°éƒ½å¯ä»¥è¿›è¡Œè¿ç§»</li>
<li>æ˜¾ç¤ºæ¥å£ï¼šæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯å¼€æ”¾æ€§çš„,ä¸ä¼šå­˜åœ¨ç§æœ‰æ¥å£,æ— è®ºæ˜¯<code>Api-Server</code>æˆ–è€…<code>Clinet-go</code>æ‰€æ“ä½œçš„æ¥å£éƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚</li>
</ul>
<h2 id="åˆ›å»ºèµ„æºçš„å·¥ä½œæµç¨‹">åˆ›å»ºèµ„æºçš„å·¥ä½œæµç¨‹</h2>
<ol>
<li>é¦–å…ˆå½“ç”¨æˆ·çš„è¯·æ±‚è¿›å…¥åˆ°<code>Api-Server</code>åä¼šè¿›å…¥åˆ°<code>Authorization</code>è®¤è¯æˆæƒçš„å¤„ç†æ¥å£å®é™…ä¸Šå°±æ˜¯åŠ è½½æˆ‘ä»¬çš„<code>config</code>é…ç½®æ–‡ä»¶,å…¶å…·ä½“ä»£ç åœ¨<code>loader.go:372</code>è¿›è¡Œå®ç°
<!doctype html>
<html lang="en">
    <head>
        <meta
            name="viewport"
            content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"
        />
        <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js"></script>
        <link
            href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/nanogallery2/3.0.5/css/nanogallery2.min.css"
            rel="stylesheet"
        />
        <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/nanogallery2/3.0.5/jquery.nanogallery2.min.js"></script>
    </head>
    <body>
        <div
            data-nanogallery2='{
    "itemsBaseURL":               "https://nanogallery2.nanostudio.org/samples",
    "thumbnailDisplayTransition":          "slideUp2",
	"thumbnailHeight":    200,
    "thumbnailWidth":     200,
    "thumbnailAlignment": "fillWidth",
    "thumbnailOpenInLightox": true,
    "breadcrumbOnlyCurrentLevel": true,
    "thumbnailLabel":     { "valign": "bottom", "position": "overImage", "hideIcons": true },
    "galleryMosaic" :   [
      { "c": 1, "r": 1, "w": 2, "h": 2 },
      { "c": 3, "r": 1, "w": 1, "h": 1 },
      { "c": 3, "r": 2, "w": 1, "h": 1 },
      { "c": 4, "r": 1, "w": 1, "h": 1 },
      { "c": 4, "r": 2, "w": 1, "h": 1 }
    ],
    "galleryLastRowFull" : true,
     "thumbnailDisplayTransitionDuration":  500,
     "thumbnailDisplayInterval":            30,
     "galleryDisplayTransition":            "rotateX",
     "galleryDisplayTransitionDuration":    500,
     "galleryDisplayMode": "rows",
     "thumbnailDisplayOutsideScreen": "true",
     "eventsDebounceDelay": 10,
     "thumbnailL1BorderHorizontal": 0,
     "thumbnailL1BorderVertical": 0,
     "thumbnailLabel": {
        "titleFontSize": "0.6em"
     },
     "thumbnailHoverEffect2": "image_scale_1.00_1.10|label_backgroundColor_rgba(0,0,0,0)_rgba(255,255,255,0)",
     "galleryTheme": {
        "thumbnail": {
            "borderRadius": "8px"
        }
     },
     "thumbnailToolbarImage": {
        "topLeft": "",
        "topRight": "",
        "bottomLeft": "",
        "bottomRight": ""
     },
     "viewerToolbar":   {
        "display": true,
        "standard": "label"
     },
     "viewerTools":     {
        "topLeft":    "pageCounter, playPauseButton",
        "topRight":   "downloadButton, rotateLeft, zoomButton, fullscreenButton, closeButton"
     },
     "viewerGalleryTWidth": 40,
     "viewerGalleryTHeight": 40
}'
        >
            

<a href="https://img12.360buyimg.com/ddimg/jfs/t1/228353/25/2337/91698/654ba7e1Fcf72fe29/40d7e21b0d3e5f2d.jpg" data-ngThumb="https://img12.360buyimg.com/ddimg/jfs/t1/228353/25/2337/91698/654ba7e1Fcf72fe29/40d7e21b0d3e5f2d.jpg">åˆ›å»ºèµ„æºçš„å·¥ä½œæµç¨‹</a>



        </div>
    </body>
</html>
</li>
</ol>
<h2 id="æœåŠ¡å‘ç°åŸç†å’Œåº”ç”¨">æœåŠ¡å‘ç°åŸç†å’Œåº”ç”¨</h2>
<h3 id="kubernetesä¸­podçš„é€šä¿¡">kubernetesä¸­Podçš„é€šä¿¡</h3>
<ul>
<li>æ¯ä¸ªPodéƒ½æœ‰è‡ªå·±çš„IPåˆ†é…</li>
<li>Podé—´çš„å¯ä»¥é€šè¿‡IPè¿›è¡Œé€šä¿¡</li>
<li>Podçš„IPæ˜¯å¯å˜çš„</li>
<li>Podçš„IPé€šå¸¸ä¸èƒ½è¢«æå‰è·å–,ä¸€èˆ¬éƒ½æ˜¯ç½‘ç»œæ’ä»¶è¿›è¡Œåˆ†é…</li>
</ul>
<h3 id="kubernetesçš„serviceé€šä¿¡">kubernetesçš„Serviceé€šä¿¡</h3>
<p>å®ƒæ˜¯ä¸€ç§æŠ½è±¡ï¼Œå¸®åŠ©ä½ å°† Pod é›†åˆåœ¨ç½‘ç»œä¸Šå…¬å¼€å‡ºå»ã€‚ æ¯ä¸ª Service å¯¹è±¡å®šä¹‰ç«¯ç‚¹çš„ä¸€ä¸ªé€»è¾‘é›†åˆï¼ˆé€šå¸¸è¿™äº›ç«¯ç‚¹å°±æ˜¯ Podï¼‰ä»¥åŠå¦‚ä½•è®¿é—®åˆ°è¿™äº› Pod çš„ç­–ç•¥ã€‚
æˆ‘ä»¬é€šå¸¸å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥ç®€å•çš„æš´éœ²ä¸€ä¸ª<code>Service</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl expose deploy/nginx --port<span class="o">=</span><span class="m">80</span>
</span></span></code></pre></div><p>é€šå¸¸æ¥è¯´æˆ‘ä»¬è®¿é—®æŸä¸ªæœåŠ¡éƒ½æ˜¯è®¿é—®æœåŠ¡çš„IPåœ°å€ï¼Œå½“ç„¶äº†,åœ¨kubernetesä¸­è®¿é—®<code>Service</code>å¯¹åº”çš„åœ°å€ä¹Ÿå¯ä»¥è®¿é—®åˆ°æœåŠ¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get service</span>
</span></span><span class="line"><span class="cl">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>             AGE
</span></span><span class="line"><span class="cl">wecho-canary                ClusterIP   10.10.166.79    &lt;none&gt;        80/TCP,9113/TCP     69d
</span></span><span class="line"><span class="cl">kubernetes                  ClusterIP   10.10.0.1       &lt;none&gt;        443/TCP             279d
</span></span></code></pre></div><p>å®é™…ä¸Šä¹Ÿå°±æ˜¯è¯´å½“æˆ‘éœ€è¦è®¿é—®<code>wecho-canary</code>è¿™ä¸ªæœåŠ¡çš„æ—¶å€™,æˆ‘æ— éœ€å…³å¿ƒä»–åç«¯endå¦‚ä½•è¿›è¡Œå˜åŒ–,æˆ‘åªéœ€è¦è®°ä½è®¿é—®<code>wecho-canary</code>çš„<code>Service</code>æ‰€ç»™å‡ºçš„<code>ClusterIP</code>å³å¯è¿›è¡Œè®¿é—®åˆ°ç›¸åº”çš„æœåŠ¡ã€‚</p>
<p>å¦å¤–çš„ä¸€ç§æ–¹å¼å°±æ˜¯é€šè¿‡æˆ‘ä»¬çš„<code>Service</code>åç§°æ¥è¿›è¡Œè®¿é—®ï¼Œä¸‹é¢è¯´ä¸€ä¸‹å…·ä½“æ˜¯å¦‚ä½•é€šè¿‡<code>Service</code>åç§°è¿›è¡Œè®¿é—®çš„ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬å‡è®¾ä½¿ç”¨ä¸Šé¢çš„<code>wecho-canary</code>åç§°è¿›è¡Œä¸€æ¬¡è®¿é—®</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -v wecho-canary <span class="c1"># å‡è®¾è®¿é—®æ­£å¸¸</span>
</span></span></code></pre></div><p>å¾ˆç®€å•,å¤§å®¶éƒ½çŸ¥é“å½“æˆ‘ä»¬è®¿é—®ä¸€ä¸ªåŸŸåçš„æ—¶å€™èƒŒåè‚¯å®šåˆDNSæœåŠ¡å™¨æ¥è§£æå…¶æ‰€å¯¹åº”çš„IPåœ°å€,é‚£ä¹ˆå…¶å®åœ¨kuberneteså½“ä¸­ä¹Ÿæœ‰ä¸€ä¸ªå†…éƒ¨çš„DNSæœåŠ¡å™¨,åå­—å«åš<code>kube-dns</code>
æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>kubectl get svc -A </code>è¿›è¡ŒæŸ¥çœ‹,å…¶ä¸­æ‰€æŒ‡å®šçš„<code>10.10.0.10</code>å°±æ˜¯æˆ‘ä»¬kube-dnsçš„IPåœ°å€.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kube-system    kube-dns                        ClusterIP   10.10.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP                         279d
</span></span></code></pre></div><p>çœ‹åˆ°æˆ‘ä»¬<code>kube-dns</code>æœ‰ä»¥ä¸‹ç«¯ç‚¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get ep -n kube-system | grep kube-dns</span>
</span></span><span class="line"><span class="cl">kube-dns             10.10.151.159:53,10.10.4.95:53,10.10.151.159:53 + <span class="m">3</span> more...   279d
</span></span><span class="line"><span class="cl">kube-dns-upstream    10.10.151.159:53,10.10.4.95:53,10.10.151.159:53 + <span class="m">1</span> more...   81d
</span></span></code></pre></div><p>å…¶æ¬¡å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®¹å™¨å†…æ‰€å¯¹åº”çš„<code>resolv.conf</code>æ‰€å†™å†…å®¹çš„é…ç½®æ–‡ä»¶</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">search jiashicang.svc.cluster.local svc.cluster.local cluster.local
nameserver 169.254.20.10
options ndots:5 single-request-reopen
</code></pre><p>ç”±äºæˆ‘ä½¿ç”¨äº†<code>NodeLocalDns</code>æ‰€ä»¥æˆ‘è¿™ä¸ªåœ°æ–¹çš„nameserverä¸å¤ªä¸€æ ·,å…³äº<code>NodeLocalDns</code>æˆ‘ä»¬åç»­å†è¯´ã€‚
æ€»ç»“ä»¥ä¸‹å‡ ç‚¹:</p>
<blockquote>
<ol>
<li>å½“æˆ‘ä»¬è®¿é—®<code>wecho-canary</code>çš„æ—¶å€™å®é™…ä¸Šæ˜¯è®¿é—®äº†<code>wecho-canary.default.cluster.local.svc</code>,å³<code>ServiceName.Namespace.cluster.local.svc</code></li>
<li>æ‰€æœ‰çš„è§£æåŸŸåè¯·æ±‚éƒ½ä¼šè¯·æ±‚åˆ°<code>kube-dns</code>å½“ä¸­,å½“<code>kube-dns</code>æ— æ³•å®Œæˆè§£æçš„æ—¶å€™,æˆ‘ä»¬ä¼šå°†è¯·æ±‚<code>forward</code>åˆ°æœ¬åœ°çš„è§£ææ–‡ä»¶å½“ä¸­,å¦‚æœæœ¬åœ°è§£ææ–‡ä»¶ä¹Ÿæ— æ³•è§£æåˆ™è®¤ä¸ºå¤±è´¥ã€‚å…¸å‹çš„å°±æ˜¯è¶…æ—¶ã€æ— æ³•è§£æç­‰é—®é¢˜ã€‚</li>
<li>Serviceé€šè¿‡ç›‘è§†API serverçš„æ•°æ®å˜åŒ–æ¥æ„ŸçŸ¥åç«¯Podçš„å˜åŒ–,å¹¶åŠæ—¶æ›´æ–°è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚å…·ä½“æ¥è¯´,Kubernetes ApiServerè´Ÿè´£ç®¡ç†é›†ç¾¤çŠ¶æ€,å®ƒä¼šè®°å½•æ¯ä¸€ä¸ªå¯¹è±¡(åŒ…æ‹¬Pod)çš„Specå’ŒStatusã€‚Serviceå¯¹è±¡ä½¿ç”¨ApiServerçš„watchæ¥å£,ç›‘è§†åç«¯å…³è”Podå¯¹è±¡çš„å˜åŒ–äº‹ä»¶ã€‚æ¯”å¦‚Podå®ä¾‹åŠ å…¥æˆ–é”€æ¯æ—¶,ApiServerä¼šä¸»åŠ¨é€šçŸ¥Serviceã€‚ä¸€æ—¦æ£€æµ‹åˆ°Podå˜åŒ–,Serviceä¼šç«‹å³ä½¿ç”¨æ–°çš„Podåˆ—è¡¨,é‡æ–°è®¡ç®—å¹¶æ›´æ–°è‡ªå·±è´Ÿè½½å‡è¡¡çš„ç«¯å£è½¬å‘è§„åˆ™ã€‚ä¾‹å¦‚ä½¿ç”¨iptablesè§„åˆ™æˆ–IPVSè¡¨æ›´æ–°åç«¯ç›®æ ‡åœ°å€ã€‚è¿™æ ·,æ— è®ºPodæ˜¯åŠ¨æ€ä¼¸ç¼©è¿˜æ˜¯æ•…éšœè½¬ç§»,Serviceéƒ½èƒ½å³æ—¶æ„ŸçŸ¥,ä¿æŒè´Ÿè½½å‡è¡¡å…¥å£åœ°å€çš„é«˜å¯é æ€§ã€‚è¿™å°±æ˜¯Serviceå¦‚ä½•å®ç°åŠ¨æ€æ›´æ–°è´Ÿè½½å‡è¡¡è§„åˆ™çš„åŸç†ã€‚</li>
</ol>
</blockquote>
<h3 id="serviceç±»å‹">Serviceç±»å‹</h3>
<ul>
<li>ClusterIP: é€šè¿‡é›†ç¾¤çš„å†…éƒ¨IPå…¬å¼€<code>Service</code>ï¼Œé€‰æ‹©è¯¥å€¼æ—¶<code>Service</code>åªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚è¿™ä¹Ÿæ˜¯ä½ æ²¡æœ‰ä¸ºæœåŠ¡æ˜¾å¼æŒ‡å®š<code>type</code>æ—¶ä½¿ç”¨çš„é»˜è®¤å€¼ã€‚</li>
<li>NodePort: é€šè¿‡æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„IPå’Œé™æ€ç«¯å£<code>NodePort</code>å…¬å¼€ Serviceã€‚ä¸ºäº†è®©Serviceå¯é€šè¿‡èŠ‚ç‚¹ç«¯å£è®¿é—®ï¼ŒKubernetes ä¼šä¸º Serviceé…ç½®é›†ç¾¤IPåœ°å€ï¼Œ ç›¸å½“äºä½ è¯·æ±‚äº†type:ClusterIPçš„æœåŠ¡ã€‚</li>
<li>LoadBalancer:ä½¿ç”¨äº‘å¹³å°çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨å…¬å¼€<code>Service</code>,ä¸€èˆ¬æ¥è¯´éƒ½ç”¨åœ¨äº‘å‚å•†æ‰ä¼šä½¿ç”¨<code>LoadBalancer</code></li>
<li>ExternalName:å°†æœåŠ¡æ˜ å°„åˆ°<code>externalName</code>å­—æ®µçš„å†…å®¹ ä¾‹å¦‚ï¼Œæ˜ å°„åˆ°ä¸»æœºå:<code>api.foo.bar.example</code>,è¯¥æ˜ å°„å°†é›†ç¾¤çš„ DNS æœåŠ¡å™¨é…ç½®ä¸ºè¿”å›å…·æœ‰è¯¥å¤–éƒ¨ä¸»æœºåå€¼çš„CNAMEè®°å½•ã€‚</li>
</ul>
<p>å¸¸ç”¨çš„æš´éœ²Serviceçš„æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl expose deploy/nginx --port<span class="o">=</span><span class="m">80</span> --type<span class="o">=</span>NodePort
</span></span></code></pre></div><p>å“¦,å¯¹äº†,æ¨èä¸€ä¸ªå¼€æºçš„LBæ’ä»¶</p>
<ul>
<li>Metallb: <a class="link" href="https://github.com/metallb/metallb"  target="_blank" rel="noopener"
    >Github</a></li>
</ul>
<h3 id="æœåŠ¡å‘ç°å’Œæµé‡è·¯ç”±">æœåŠ¡å‘ç°å’Œæµé‡è·¯ç”±</h3>
<p>æ€»çš„æ¥è¯´æˆ‘ä»¬åˆ†ä¸ºä¸€ä¸‹å‡ ç‚¹å§</p>
<ol>
<li>Podä¹‹é—´çš„æµé‡é€šä¿¡:
<ol>
<li>IPç›´è¿çš„æ–¹å¼: ä¸æ¨èè¿™ç§æ–¹å¼,å› ä¸ºPodçš„IPä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´å¯¹äºæœåŠ¡ç‰ˆæœ¬æ›´æ–°ç”Ÿå‘½å‘¨æœŸç›¸å¯¹è¾ƒçŸ­ã€‚</li>
<li>ClusterIPï¼š ç›¸å¯¹äºæ¯”è¾ƒæ¨èé€šè¿‡æŒ‡å®šServiceNameçš„æ–¹å¼æ¥ç»‘å®šæ´»ç€ç›‘å¬æŸç§æœåŠ¡</li>
</ol>
</li>
<li>å¤–éƒ¨è®¿é—®Podçš„é€šä¿¡
<ol>
<li>NodePort: é€šè¿‡æš´éœ²å¤–éƒ¨ç«¯å£çš„æ–¹å¼æ¥è¿›è¡ŒPodçš„è®¿é—®</li>
<li>LoadBalancer: é€šè¿‡å¯¹Serviceç»‘å®šLBçš„æ–¹å¼è¿›è¡ŒPodçš„è®¿é—®</li>
</ol>
</li>
<li>Podè®¿é—®å¤–éƒ¨é€šä¿¡:
<ol>
<li>ExternalName: å°† Service æ˜ å°„åˆ° DNS åç§°</li>
<li>HeadlessService: å½“ä½ ä¸éœ€è¦è´Ÿè½½å‡è¡¡ï¼Œä¹Ÿä¸éœ€è¦å•ç‹¬çš„ ServiceIP,ä½ å¯ä»¥ä½¿ç”¨<code>HeadlessService</code></li>
</ol>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ä¸‹é¢æ˜¯ExternalNameçš„ç®€å•å®ä¾‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ExternalName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">externalName</span><span class="p">:</span><span class="w"> </span><span class="l">my.database.example.com</span><span class="w">
</span></span></span></code></pre></div><p>ä¸€èˆ¬æ¥è¯´Kubernetesçš„å†…éƒ¨DNSè®°å½•æœ‰ä¸¤ç§è§„èŒƒ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">PodIP.Namespace.pod.cluster-domain.example
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">ServiceName.Namespace.svc.cluster-domain.example
</span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>OpenEBSå­˜å‚¨çš„ä½¿ç”¨</title>
      <link>https://blog.mletter.cn/tech/kubernetes/openebs/</link>
      <pubDate>Sun, 14 May 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/openebs/</guid>
      <description>&lt;h1 id=&#34;openebså­˜å‚¨ä½¿ç”¨&#34;&gt;OpenEBSå­˜å‚¨ä½¿ç”¨&lt;/h1&gt;
&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;https://openebs.io/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;OpenEBS&lt;/a&gt; æ˜¯ä¸€ç§æ¨¡æ‹Ÿäº† AWS çš„ EBSã€é˜¿é‡Œäº‘çš„äº‘ç›˜ç­‰å—å­˜å‚¨å®ç°çš„åŸºäºå®¹å™¨çš„å­˜å‚¨å¼€æºè½¯ä»¶ã€‚OpenEBS æ˜¯ä¸€ç§åŸºäº CAS(Container Attached Storage) ç†å¿µçš„å®¹å™¨è§£å†³æ–¹æ¡ˆï¼Œå…¶æ ¸å¿ƒç†å¿µæ˜¯å­˜å‚¨å’Œåº”ç”¨ä¸€æ ·é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œå¹¶é€šè¿‡ Kubernetes æ¥åšèµ„æºç¼–æ’ã€‚å…¶æ¶æ„å®ç°ä¸Šï¼Œæ¯ä¸ªå·çš„ Controller éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œä¸”ä¸åº”ç”¨ Pod åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œå·çš„æ•°æ®ä½¿ç”¨å¤šä¸ª Pod è¿›è¡Œç®¡ç†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img style=&#34;max-width: 100%; height: auto;&#34; loading=&#34;lazy&#34; alt=&#34;openEBSç»„ä»¶&#34; loading=&#34;lazy&#34; src=&#34;https://openebs.io/docs/assets/images/control-plane-overview-93c59878e3356a11f03029dd0fc1cd6b.svg&#34;&gt;&lt;/p&gt;
&lt;p&gt;OpenEBS æœ‰å¾ˆå¤šç»„ä»¶ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ§åˆ¶å¹³é¢ç»„ä»¶ - ç®¡ç† OpenEBS å·å®¹å™¨ï¼Œé€šå¸¸ä¼šç”¨åˆ°å®¹å™¨ç¼–æ’è½¯ä»¶çš„åŠŸèƒ½&lt;/li&gt;
&lt;li&gt;æ•°æ®å¹³é¢ç»„ä»¶ - ä¸ºåº”ç”¨ç¨‹åºæä¾›æ•°æ®å­˜å‚¨ï¼ŒåŒ…å« Jiva å’Œ cStor ä¸¤ä¸ªå­˜å‚¨åç«¯&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹ç£ç›˜ç®¡ç†å™¨ - å‘ç°ã€ç›‘æ§å’Œç®¡ç†è¿æ¥åˆ° Kubernetes èŠ‚ç‚¹çš„åª’ä½“&lt;/li&gt;
&lt;li&gt;ä¸äº‘åŸç”Ÿå·¥å…·çš„æ•´åˆ - ä¸ Prometheusã€Grafanaã€Fluentd å’Œ Jaeger è¿›è¡Œæ•´åˆã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;æ§åˆ¶å¹³é¢&#34;&gt;æ§åˆ¶å¹³é¢&lt;/h2&gt;
&lt;p&gt;OpenEBS ä¸Šä¸‹æ–‡ä¸­çš„æ§åˆ¶å¹³é¢æ˜¯æŒ‡éƒ¨ç½²åœ¨é›†ç¾¤ä¸­çš„ä¸€ç»„å·¥å…·æˆ–ç»„ä»¶ï¼Œå®ƒä»¬è´Ÿè´£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç®¡ç† kubernetes å·¥ä½œèŠ‚ç‚¹ä¸Šå¯ç”¨çš„å­˜å‚¨&lt;/li&gt;
&lt;li&gt;é…ç½®å’Œç®¡ç†æ•°æ®å¼•æ“&lt;/li&gt;
&lt;li&gt;ä¸ CSI æ¥å£ä»¥ç®¡ç†å·çš„ç”Ÿå‘½å‘¨æœŸ&lt;/li&gt;
&lt;li&gt;ä¸ CSI å’Œå…¶ä»–å·¥å…·è¿›è¡Œæ¥å£ï¼Œæ‰§è¡Œå¿«ç…§ã€å…‹éš†ã€è°ƒæ•´å¤§å°ã€å¤‡ä»½ã€æ¢å¤ç­‰æ“ä½œã€‚&lt;/li&gt;
&lt;li&gt;é›†æˆåˆ°å…¶ä»–å·¥å…·ä¸­ï¼Œå¦‚ Prometheus/Grafana ä»¥è¿›è¡Œé¥æµ‹å’Œç›‘æ§&lt;/li&gt;
&lt;li&gt;é›†æˆåˆ°å…¶ä»–å·¥å…·ä¸­è¿›è¡Œè°ƒè¯•ã€æ•…éšœæ’é™¤æˆ–æ—¥å¿—ç®¡ç†&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;OpenEBS æ§åˆ¶å¹³é¢ç”±ä¸€ç»„å¾®æœåŠ¡ç»„æˆï¼Œè¿™äº›å¾®æœåŠ¡æœ¬èº«ç”± Kubernetes ç®¡ç†ï¼Œä½¿ OpenEBS çœŸæ­£æˆä¸º Kubernetes åŸç”Ÿçš„ã€‚ç”± OpenEBS æ§åˆ¶å¹³é¢ç®¡ç†çš„é…ç½®è¢«ä¿å­˜ä¸º Kubernetes è‡ªå®šä¹‰èµ„æºã€‚æ§åˆ¶å¹³é¢çš„åŠŸèƒ½å¯ä»¥åˆ†è§£ä¸ºä»¥ä¸‹å„ä¸ªé˜¶æ®µï¼š&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h1 id="openebså­˜å‚¨ä½¿ç”¨">OpenEBSå­˜å‚¨ä½¿ç”¨</h1>
<p><a class="link" href="https://openebs.io/"  target="_blank" rel="noopener"
    >OpenEBS</a> æ˜¯ä¸€ç§æ¨¡æ‹Ÿäº† AWS çš„ EBSã€é˜¿é‡Œäº‘çš„äº‘ç›˜ç­‰å—å­˜å‚¨å®ç°çš„åŸºäºå®¹å™¨çš„å­˜å‚¨å¼€æºè½¯ä»¶ã€‚OpenEBS æ˜¯ä¸€ç§åŸºäº CAS(Container Attached Storage) ç†å¿µçš„å®¹å™¨è§£å†³æ–¹æ¡ˆï¼Œå…¶æ ¸å¿ƒç†å¿µæ˜¯å­˜å‚¨å’Œåº”ç”¨ä¸€æ ·é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œå¹¶é€šè¿‡ Kubernetes æ¥åšèµ„æºç¼–æ’ã€‚å…¶æ¶æ„å®ç°ä¸Šï¼Œæ¯ä¸ªå·çš„ Controller éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œä¸”ä¸åº”ç”¨ Pod åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œå·çš„æ•°æ®ä½¿ç”¨å¤šä¸ª Pod è¿›è¡Œç®¡ç†ã€‚</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="openEBSç»„ä»¶" loading="lazy" src="https://openebs.io/docs/assets/images/control-plane-overview-93c59878e3356a11f03029dd0fc1cd6b.svg"></p>
<p>OpenEBS æœ‰å¾ˆå¤šç»„ä»¶ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p>
<ul>
<li>æ§åˆ¶å¹³é¢ç»„ä»¶ - ç®¡ç† OpenEBS å·å®¹å™¨ï¼Œé€šå¸¸ä¼šç”¨åˆ°å®¹å™¨ç¼–æ’è½¯ä»¶çš„åŠŸèƒ½</li>
<li>æ•°æ®å¹³é¢ç»„ä»¶ - ä¸ºåº”ç”¨ç¨‹åºæä¾›æ•°æ®å­˜å‚¨ï¼ŒåŒ…å« Jiva å’Œ cStor ä¸¤ä¸ªå­˜å‚¨åç«¯</li>
<li>èŠ‚ç‚¹ç£ç›˜ç®¡ç†å™¨ - å‘ç°ã€ç›‘æ§å’Œç®¡ç†è¿æ¥åˆ° Kubernetes èŠ‚ç‚¹çš„åª’ä½“</li>
<li>ä¸äº‘åŸç”Ÿå·¥å…·çš„æ•´åˆ - ä¸ Prometheusã€Grafanaã€Fluentd å’Œ Jaeger è¿›è¡Œæ•´åˆã€‚</li>
</ul>
<h2 id="æ§åˆ¶å¹³é¢">æ§åˆ¶å¹³é¢</h2>
<p>OpenEBS ä¸Šä¸‹æ–‡ä¸­çš„æ§åˆ¶å¹³é¢æ˜¯æŒ‡éƒ¨ç½²åœ¨é›†ç¾¤ä¸­çš„ä¸€ç»„å·¥å…·æˆ–ç»„ä»¶ï¼Œå®ƒä»¬è´Ÿè´£ï¼š</p>
<ul>
<li>ç®¡ç† kubernetes å·¥ä½œèŠ‚ç‚¹ä¸Šå¯ç”¨çš„å­˜å‚¨</li>
<li>é…ç½®å’Œç®¡ç†æ•°æ®å¼•æ“</li>
<li>ä¸ CSI æ¥å£ä»¥ç®¡ç†å·çš„ç”Ÿå‘½å‘¨æœŸ</li>
<li>ä¸ CSI å’Œå…¶ä»–å·¥å…·è¿›è¡Œæ¥å£ï¼Œæ‰§è¡Œå¿«ç…§ã€å…‹éš†ã€è°ƒæ•´å¤§å°ã€å¤‡ä»½ã€æ¢å¤ç­‰æ“ä½œã€‚</li>
<li>é›†æˆåˆ°å…¶ä»–å·¥å…·ä¸­ï¼Œå¦‚ Prometheus/Grafana ä»¥è¿›è¡Œé¥æµ‹å’Œç›‘æ§</li>
<li>é›†æˆåˆ°å…¶ä»–å·¥å…·ä¸­è¿›è¡Œè°ƒè¯•ã€æ•…éšœæ’é™¤æˆ–æ—¥å¿—ç®¡ç†</li>
</ul>
<p>OpenEBS æ§åˆ¶å¹³é¢ç”±ä¸€ç»„å¾®æœåŠ¡ç»„æˆï¼Œè¿™äº›å¾®æœåŠ¡æœ¬èº«ç”± Kubernetes ç®¡ç†ï¼Œä½¿ OpenEBS çœŸæ­£æˆä¸º Kubernetes åŸç”Ÿçš„ã€‚ç”± OpenEBS æ§åˆ¶å¹³é¢ç®¡ç†çš„é…ç½®è¢«ä¿å­˜ä¸º Kubernetes è‡ªå®šä¹‰èµ„æºã€‚æ§åˆ¶å¹³é¢çš„åŠŸèƒ½å¯ä»¥åˆ†è§£ä¸ºä»¥ä¸‹å„ä¸ªé˜¶æ®µï¼š</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="æ§åˆ¶å¹³é¢ç»„ä»¶" loading="lazy" src="https://openebs.io/docs/assets/images/openebs-control-plane-ed2fef338de5f1b10298fc5f5c0f4e3f.svg"></p>
<p>OpenEBS æä¾›äº†ä¸€ä¸ªåŠ¨æ€ä¾›åº”å™¨ï¼Œå®ƒæ˜¯æ ‡å‡†çš„ Kubernetes å¤–éƒ¨å­˜å‚¨æ’ä»¶ã€‚OpenEBS PV ä¾›åº”å™¨çš„ä¸»è¦ä»»åŠ¡æ˜¯å‘åº”ç”¨ Pod å‘èµ·å·ä¾›åº”ï¼Œå¹¶å®ç°Kubernetes çš„ PV è§„èŒƒã€‚</p>
<p><code>m-apiserver</code> æš´éœ²äº†å­˜å‚¨ REST APIï¼Œå¹¶æ‰¿æ‹…äº†å¤§éƒ¨åˆ†çš„å·ç­–ç•¥å¤„ç†å’Œç®¡ç†ã€‚</p>
<p>æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢ä¹‹é—´çš„è¿æ¥é‡‡ç”¨ Kubernetes sidecar æ¨¡å¼ã€‚æœ‰å¦‚ä¸‹å‡ ä¸ªåœºæ™¯ï¼Œæ§åˆ¶å¹³é¢éœ€è¦ä¸æ•°æ®å¹³é¢è¿›è¡Œé€šä¿¡ã€‚</p>
<ul>
<li>å¯¹äº IOPSã€ååé‡ã€å»¶è¿Ÿç­‰å·ç»Ÿè®¡ - é€šè¿‡ <code>volume-exporter</code> sidecarå®ç°</li>
<li>ç”¨äºé€šè¿‡å·æ§åˆ¶å™¨ Pod æ‰§è¡Œå·ç­–ç•¥ï¼Œä»¥åŠé€šè¿‡å·å¤åˆ¶ Pod è¿›è¡Œ<code>ç£ç›˜/æ± </code>ç®¡ç† - é€šè¿‡å·ç®¡ç† sidecar å®ç°ã€‚</li>
</ul>
<h2 id="openebs-local-pv">OpenEBS Local Pv</h2>
<p><a class="link" href="https://kubernetes.io/docs/concepts/storage/volumes/#local"  target="_blank" rel="noopener"
    >OpenEBS ä¸ºKubernetes Local Volumes</a>æä¾›åŠ¨æ€ PV ä¾›åº”å™¨ã€‚æœ¬åœ°å·æ„å‘³ç€å­˜å‚¨åªèƒ½ä»å•ä¸ªèŠ‚ç‚¹ä½¿ç”¨ã€‚æœ¬åœ°å·è¡¨ç¤ºå·²æŒ‚è½½çš„æœ¬åœ°å­˜å‚¨è®¾å¤‡ï¼Œä¾‹å¦‚ç£ç›˜ã€åˆ†åŒºæˆ–ç›®å½•ã€‚</p>
<p>ç”±äº Local Volume åªèƒ½ä»å•ä¸ªèŠ‚ç‚¹è®¿é—®ï¼Œå› æ­¤æœ¬åœ°å·å—åº•å±‚èŠ‚ç‚¹å¯ç”¨æ€§çš„å½±å“ï¼Œå¹¶ä¸é€‚åˆæ‰€æœ‰åº”ç”¨ç¨‹åºã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å˜å¾—ä¸å¥åº·ï¼Œé‚£ä¹ˆæœ¬åœ°å·ä¹Ÿå°†å˜å¾—ä¸å¯è®¿é—®ï¼Œä½¿ç”¨å®ƒçš„ Pod å°†æ— æ³•è¿è¡Œã€‚ä½¿ç”¨æœ¬åœ°å·çš„åº”ç”¨ç¨‹åºå¿…é¡»èƒ½å¤Ÿå®¹å¿è¿™ç§å¯ç”¨æ€§é™ä½ä»¥åŠæ½œåœ¨çš„æ•°æ®ä¸¢å¤±ï¼Œå…·ä½“å–å†³äºåº•å±‚ç£ç›˜çš„è€ç”¨æ€§ç‰¹å¾ã€‚</p>
<p>å¯ä»¥ä»æœ¬åœ°å·ä¸­å—ç›Šçš„è‰¯å¥½å·¥ä½œè´Ÿè½½ç¤ºä¾‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>å¤åˆ¶æ•°æ®åº“ï¼Œå¦‚ MongoDBã€Cassandra</li>
<li>å¯ä»¥ä½¿ç”¨è‡ªå·±çš„é«˜å¯ç”¨æ€§é…ç½®ï¼ˆå¦‚ Elasticã€MinIOï¼‰é…ç½®çš„æœ‰çŠ¶æ€å·¥ä½œè´Ÿè½½</li>
<li>é€šå¸¸åœ¨å•ä¸ªèŠ‚ç‚¹æˆ–å•èŠ‚ç‚¹ Kubernetes é›†ç¾¤ä¸­è¿è¡Œçš„è¾¹ç¼˜å·¥ä½œè´Ÿè½½ã€‚</li>
</ul>
<p>OpenEBS é€šè¿‡æä¾› Kubernetes å½“å‰ç¼ºå°‘çš„åŠŸèƒ½æ¥å¸®åŠ©ç”¨æˆ·å°†æœ¬åœ°å·æŠ•å…¥ç”Ÿäº§ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>æœ¬åœ°å·çš„åŠ¨æ€ PV Provisionerã€‚</li>
<li>ç”± Ext3ã€XFSã€LVM æˆ– ZFS ç­‰æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä¸»æœºè·¯å¾„æ”¯æŒçš„æœ¬åœ°å·ã€‚</li>
<li>ç›‘æ§ç”¨äºåˆ›å»ºæœ¬åœ°å·çš„åº•å±‚è®¾å¤‡æˆ–å­˜å‚¨çš„å¥åº·çŠ¶å†µã€‚</li>
<li>å®¹é‡ç®¡ç†åŠŸèƒ½ï¼Œå¦‚è¿‡åº¦é…ç½®å’Œ/æˆ–é…é¢å¼ºåˆ¶æ‰§è¡Œã€‚</li>
<li>å½“æœ¬åœ°å·ç”± ZFS ç­‰é«˜çº§æ–‡ä»¶ç³»ç»Ÿæ”¯æŒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¿«ç…§ã€å…‹éš†ã€å‹ç¼©ç­‰åº•å±‚å­˜å‚¨åŠŸèƒ½ã€‚</li>
<li>é€šè¿‡ Velero è¿›è¡Œå¤‡ä»½å’Œæ¢å¤ã€‚</li>
<li>é€šè¿‡ LUKS æˆ–ä½¿ç”¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ ZFSï¼‰çš„å†…ç½®åŠ å¯†æ”¯æŒæ¥ä¿æŠ¤æœ¬åœ°å·ã€‚</li>
</ul>
<h2 id="èŠ‚ç‚¹ç£ç›˜ç®¡ç†å™¨ndm">èŠ‚ç‚¹ç£ç›˜ç®¡ç†å™¨(NDM)</h2>
<p>èŠ‚ç‚¹ç£ç›˜ç®¡ç†å™¨ï¼ˆNDMï¼‰æ˜¯OpenEBSæ¶æ„ä¸­çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ã€‚NDM å°†å—è®¾å¤‡è§†ä¸ºéœ€è¦ç›‘æ§å’Œç®¡ç†çš„èµ„æºï¼Œå°±åƒå…¶ä»–èµ„æºï¼ˆå¦‚ CPUã€å†…å­˜å’Œç½‘ç»œï¼‰ä¸€æ ·ã€‚å®ƒæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œæ ¹æ®è¿‡æ»¤å™¨æ£€æµ‹é™„åŠ çš„å—è®¾å¤‡å¹¶å°†å®ƒä»¬ä½œä¸ºå—è®¾å¤‡è‡ªå®šä¹‰èµ„æºåŠ è½½åˆ° Kubernetes ä¸­ã€‚è¿™äº›è‡ªå®šä¹‰èµ„æºæ—¨åœ¨é€šè¿‡æä¾›ä»¥ä¸‹åŠŸèƒ½æ¥å¸®åŠ©è¶…èåˆå­˜å‚¨è¿è¥å•†ï¼š</p>
<ul>
<li>æ˜“äºè®¿é—® Kubernetes é›†ç¾¤ä¸­å¯ç”¨çš„å—è®¾å¤‡æ¸…å•ã€‚</li>
<li>é¢„æµ‹ç£ç›˜æ•…éšœä»¥å¸®åŠ©é‡‡å–é¢„é˜²æªæ–½ã€‚</li>
<li>å…è®¸åŠ¨æ€åœ°å°†ç£ç›˜é™„åŠ /åˆ†ç¦»åˆ°å­˜å‚¨ podï¼Œè€Œæ— éœ€é‡æ–°å¯åŠ¨åœ¨ç£ç›˜é™„åŠ /åˆ†ç¦»çš„èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ç›¸åº” NDM podã€‚</li>
<li><code>Node Disk Manager</code>åœ¨<code>Kubernetes</code>ä¸­æ˜¯ä»¥<code>DaemonSet</code>çš„æ–¹å¼è¿›è¡Œè¿è¡Œçš„</li>
<li><a class="link" href="https://openebs.io/docs/concepts/ndm"  target="_blank" rel="noopener"
    >Node Disk Manager</a></li>
</ul>
<p>å°½ç®¡æ‰§è¡Œäº†ä¸Šè¿°æ‰€æœ‰æ“ä½œï¼Œä½† NDM æœ‰åŠ©äºæ•´ä½“ç®€åŒ–æŒä¹…å·çš„é…ç½®ã€‚</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="NDM" loading="lazy" src="https://openebs.io/docs/assets/files/ndm-96fc51e849ddea8084d8b800d0e08975.svg"></p>
<blockquote>
<p>NDM åœ¨å®‰è£… OpenEBS æœŸé—´éƒ¨ç½²ä¸ºå®ˆæŠ¤è¿›ç¨‹ã€‚NDM daemonset å‘ç°æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ç£ç›˜å¹¶åˆ›å»ºç§°ä¸ºå—è®¾å¤‡æˆ– BD çš„è‡ªå®šä¹‰èµ„æºã€‚</p>
</blockquote>
<h2 id="å¯ç”¨openebs">å¯ç”¨OpenEBS</h2>
<p>ç”±äº OpenEBS é€šè¿‡ iSCSI åè®®æä¾›å­˜å‚¨æ”¯æŒï¼Œå› æ­¤ï¼Œéœ€è¦åœ¨æ‰€æœ‰ Kubernetes èŠ‚ç‚¹ä¸Šéƒ½å®‰è£… iSCSI å®¢æˆ·ç«¯ï¼ˆå¯åŠ¨å™¨ï¼‰ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯Rockyçš„ç³»ç»Ÿï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£…å¯åŠ¨ iSCSI å¯åŠ¨å™¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dnf install iscsi-initiator-utils -y
</span></span><span class="line"><span class="cl"><span class="c1"># æŸ¥çœ‹iSCSIçŠ¶æ€æ˜¯å¦æ­£å¸¸</span>
</span></span><span class="line"><span class="cl">cat /etc/iscsi/initiatorname.iscsi
</span></span><span class="line"><span class="cl"><span class="c1"># å¯åŠ¨iSCSI</span>
</span></span><span class="line"><span class="cl">systemctl start iscsid.service
</span></span><span class="line"><span class="cl">systemctl status iscsid.service
</span></span></code></pre></div><h3 id="å®‰è£…openebs">å®‰è£…OpenEBS</h3>
<ol>
<li>ä½¿ç”¨<code>kubectl</code>çš„æ–¹å¼è¿›è¡Œå®‰è£…</li>
</ol>
<ul>
<li>Helméƒ¨ç½²ä¹Ÿæ˜¯å¯é€‰çš„: <a class="link" href="https://openebs.io/docs/user-guides/installation#installation-through-helm"  target="_blank" rel="noopener"
    >åœ°å€</a></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl apply -f https://openebs.github.io/charts/openebs-operator.yaml</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æ£€æŸ¥æ˜¯å¦å®‰è£…å®Œæˆ,æ­£å¸¸åº”è¯¥éƒ½æ˜¯Runningå³å¯</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get pods -n openebs</span>
</span></span><span class="line"><span class="cl">NAME                                           READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">openebs-localpv-provisioner-846c6bdc56-vvvsv   1/1     Running   <span class="m">0</span>          6m11s
</span></span><span class="line"><span class="cl">openebs-ndm-5sfdk                              1/1     Running   <span class="m">0</span>          6m11s
</span></span><span class="line"><span class="cl">openebs-ndm-cluster-exporter-b49987ffb-vjq87   1/1     Running   <span class="m">0</span>          6m11s
</span></span><span class="line"><span class="cl">openebs-ndm-kthfj                              1/1     Running   <span class="m">0</span>          6m11s
</span></span><span class="line"><span class="cl">openebs-ndm-node-exporter-94zhh                1/1     Running   <span class="m">0</span>          6m11s
</span></span><span class="line"><span class="cl">openebs-ndm-node-exporter-q9h5p                1/1     Running   <span class="m">0</span>          6m11s
</span></span><span class="line"><span class="cl">openebs-ndm-node-exporter-x7z9t                1/1     Running   <span class="m">0</span>          6m11s
</span></span><span class="line"><span class="cl">openebs-ndm-operator-6469f6bb4c-95kss          1/1     Running   <span class="m">0</span>          6m11s
</span></span><span class="line"><span class="cl">openebs-ndm-wf9k2                              1/1     Running   <span class="m">0</span>          6m11s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ­£å¸¸æˆ‘ä»¬ä¼šæœ‰ä¸¤ä¸ªStorageClass</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get sc</span>
</span></span><span class="line"><span class="cl">NAME               PROVISIONER        RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
</span></span><span class="line"><span class="cl">openebs-device     openebs.io/local   Delete          WaitForFirstConsumer   <span class="nb">false</span>                  20m
</span></span><span class="line"><span class="cl">openebs-hostpath   openebs.io/local   Delete          WaitForFirstConsumer   <span class="nb">false</span>                  20m
</span></span></code></pre></div><ol>
<li>æˆ‘ä»¬è‡ªå·±åˆ›å»ºä¸€ä¸ª<code>Pvc</code>å¯¹è±¡æ¥ç»™æˆ‘ä»¬çš„<code>Deployment</code>æ¥è¿›è¡Œä½¿ç”¨</li>
</ol>
<pre tabindex="0"><code class="language-yanml" data-lang="yanml">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: local-hostpath-pvc
spec:
  storageClassName: openebs-hostpath
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
</code></pre><ol>
<li>åˆ›å»ºä¸€ä¸ªPodè¿›è¡Œæµ‹è¯•</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hello-local-hostpath-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local-storage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">local-hostpath-pvc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hello-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span>- <span class="l">sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span>- <span class="s1">&#39;while true; do echo &#34;`date` [`hostname`] Hello from OpenEBS Local PV.&#34; &gt;&gt; /mnt/store/greet.txt; sleep $(($RANDOM % 5 + 300)); done&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local-storage</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>æ³¨æ„ï¼šå¦‚æœä½ æƒ³çŸ¥é“è¿™ä¸ªPvcå…·ä½“æŒ‚è½½ä½ç½®å¯ä»¥ä½¿ç”¨<code>kubectl describe pv pvåç§°</code>,å…¶ä¸­çš„<code>Ptah: /var/openebs/local/pvc-e011f2a1-27dc-46d0-ba34-9ad44ba03188</code>å°±æ˜¯æˆ‘ä»¬æ‰€åœ¨èŠ‚ç‚¹çš„è·¯å¾„</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get pv</span>
</span></span><span class="line"><span class="cl">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                        STORAGECLASS       REASON   AGE
</span></span><span class="line"><span class="cl">example-local                              20Gi       RWO            Delete           Bound    default/bound-tasknginx      local-storage               26d
</span></span><span class="line"><span class="cl">pvc-e011f2a1-27dc-46d0-ba34-9ad44ba03188   1Gi        RWO            Delete           Bound    default/local-hostpath-pvc   openebs-hostpath            3m53s
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl describe pv pvc-e011f2a1-27dc-46d0-ba34-9ad44ba03188</span>
</span></span><span class="line"><span class="cl">Name:              pvc-e011f2a1-27dc-46d0-ba34-9ad44ba03188
</span></span><span class="line"><span class="cl">Labels:            openebs.io/cas-type<span class="o">=</span>local-hostpath
</span></span><span class="line"><span class="cl">Annotations:       pv.kubernetes.io/provisioned-by: openebs.io/local
</span></span><span class="line"><span class="cl">Finalizers:        <span class="o">[</span>kubernetes.io/pv-protection<span class="o">]</span>
</span></span><span class="line"><span class="cl">StorageClass:      openebs-hostpath
</span></span><span class="line"><span class="cl">Status:            Bound
</span></span><span class="line"><span class="cl">Claim:             default/local-hostpath-pvc
</span></span><span class="line"><span class="cl">Reclaim Policy:    Delete
</span></span><span class="line"><span class="cl">Access Modes:      RWO
</span></span><span class="line"><span class="cl">VolumeMode:        Filesystem
</span></span><span class="line"><span class="cl">Capacity:          1Gi
</span></span><span class="line"><span class="cl">Node Affinity:     
</span></span><span class="line"><span class="cl">  Required Terms:  
</span></span><span class="line"><span class="cl">    Term 0:        kubernetes.io/hostname in <span class="o">[</span>online-beijing-node1<span class="o">]</span>
</span></span><span class="line"><span class="cl">Message:           
</span></span><span class="line"><span class="cl">Source:
</span></span><span class="line"><span class="cl">    Type:  LocalVolume <span class="o">(</span>a persistent volume backed by <span class="nb">local</span> storage on a node<span class="o">)</span>
</span></span><span class="line"><span class="cl">    Path:  /var/openebs/local/pvc-e011f2a1-27dc-46d0-ba34-9ad44ba03188
</span></span><span class="line"><span class="cl">Events:    &lt;none&gt;
</span></span></code></pre></div><ol>
<li>è¿›å…¥æ‰€åœ¨èŠ‚ç‚¹çš„ç›®å½•è¿›è¡ŒéªŒè¯</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span>  /var/openebs/local/pvc-e011f2a1-27dc-46d0-ba34-9ad44ba03188
</span></span><span class="line"><span class="cl"><span class="c1"># éšä¾¿åˆ›å»ºä¸€ä¸ªæ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">touch openebs.txt
</span></span><span class="line"><span class="cl"><span class="c1"># è¿›å…¥å®¹å™¨å†…éƒ¨</span>
</span></span><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it nginx-67fbcff654-glklg bash
</span></span><span class="line"><span class="cl"><span class="c1"># æŸ¥çœ‹æ‰€æŒ‚è½½openebsçš„è·¯å¾„æ˜¯å¦æˆåŠŸæœ‰openebs.txt</span>
</span></span><span class="line"><span class="cl">root@nginx-67fbcff654-glklg:/# ls /data/
</span></span><span class="line"><span class="cl">1.txt  openebs.txt
</span></span></code></pre></div><h2 id="ä¿®æ”¹openebsçš„hostpathé»˜è®¤å­˜å‚¨">ä¿®æ”¹OpenEBSçš„HostPathé»˜è®¤å­˜å‚¨</h2>
<ol>
<li>ä¿®æ”¹åå­—ä¸º<code>openebs-hostpath</code>çš„<code>StorageClass</code>å½“ä¸­çš„<code>BasePath</code>å³å¯</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">openebs-hostpath</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">openebs.io/cas-type</span><span class="p">:</span><span class="w"> </span><span class="l">local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cas.openebs.io/config</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      #hostpath type will create a PV by 
</span></span></span><span class="line"><span class="cl"><span class="sd">      # creating a sub-directory under the
</span></span></span><span class="line"><span class="cl"><span class="sd">      # BASEPATH provided below.
</span></span></span><span class="line"><span class="cl"><span class="sd">      - name: StorageType
</span></span></span><span class="line"><span class="cl"><span class="sd">        value: &#34;hostpath&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">      #Specify the location (directory) where
</span></span></span><span class="line"><span class="cl"><span class="sd">      # where PV(volume) data will be saved. 
</span></span></span><span class="line"><span class="cl"><span class="sd">      # A sub-directory with pv-name will be 
</span></span></span><span class="line"><span class="cl"><span class="sd">      # created. When the volume is deleted, 
</span></span></span><span class="line"><span class="cl"><span class="sd">      # the PV sub-directory will be deleted.
</span></span></span><span class="line"><span class="cl"><span class="sd">      #Default value is /var/openebs/local
</span></span></span><span class="line"><span class="cl"><span class="sd">      - name: BasePath
</span></span></span><span class="line"><span class="cl"><span class="sd">        value: &#34;/var/openebs/local/&#34;</span><span class="w">      
</span></span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>TraekfikåŸºç¡€ä½¿ç”¨æŒ‡å—</title>
      <link>https://blog.mletter.cn/tech/kubernetes/traefik/</link>
      <pubDate>Fri, 07 Apr 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/traefik/</guid>
      <description>&lt;h2 id=&#34;traekfikæ˜¯ä»€ä¹ˆ&#34;&gt;Traekfikæ˜¯ä»€ä¹ˆ&lt;/h2&gt;
&lt;p&gt;Traefik æ˜¯ä¸€ç§&lt;a class=&#34;link&#34; href=&#34;https://github.com/traefik/traefik&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;å¼€æº&lt;/a&gt; &lt;em&gt;è¾¹ç¼˜è·¯ç”±å™¨&lt;/em&gt;ï¼Œå®ƒä½¿æ‚¨å‘å¸ƒæœåŠ¡æˆä¸ºä¸€ç§æœ‰è¶£è€Œè½»æ¾çš„ä½“éªŒã€‚å®ƒä»£è¡¨æ‚¨çš„ç³»ç»Ÿæ¥æ”¶è¯·æ±‚å¹¶æ‰¾å‡ºå“ªäº›ç»„ä»¶è´Ÿè´£å¤„ç†å®ƒä»¬ã€‚&lt;/p&gt;
&lt;p&gt;Traefik çš„ä¸ä¼—ä¸åŒä¹‹å¤„åœ¨äºï¼Œé™¤äº†å®ƒçš„è®¸å¤šåŠŸèƒ½ä¹‹å¤–ï¼Œå®ƒè¿˜å¯ä»¥è‡ªåŠ¨ä¸ºæ‚¨çš„æœåŠ¡å‘ç°æ­£ç¡®çš„é…ç½®ã€‚å½“ Traefik æ£€æŸ¥æ‚¨çš„åŸºç¡€æ¶æ„æ—¶ï¼Œå¥‡è¿¹å°±ä¼šå‘ç”Ÿï¼Œå®ƒä¼šåœ¨å…¶ä¸­æ‰¾åˆ°ç›¸å…³ä¿¡æ¯å¹¶å‘ç°å“ªä¸ªæœåŠ¡æœåŠ¡äºå“ªä¸ªè¯·æ±‚ã€‚&lt;/p&gt;
&lt;p&gt;Traefik åŸç”Ÿå…¼å®¹æ‰€æœ‰ä¸»è¦çš„é›†ç¾¤æŠ€æœ¯ï¼Œä¾‹å¦‚ Kubernetesã€Dockerã€Docker Swarmã€AWSã€Mesosã€Marathonï¼Œ&lt;a class=&#34;link&#34; href=&#34;https://doc.traefik.io/traefik/providers/overview/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;ç­‰ç­‰&lt;/a&gt;ï¼›å¹¶ä¸”å¯ä»¥åŒæ—¶å¤„ç†å¾ˆå¤šã€‚ï¼ˆå®ƒç”šè‡³é€‚ç”¨äºåœ¨è£¸æœºä¸Šè¿è¡Œçš„é—ç•™è½¯ä»¶ã€‚ï¼‰&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨ Traefikï¼Œæ— éœ€ç»´æŠ¤å’ŒåŒæ­¥å•ç‹¬çš„é…ç½®æ–‡ä»¶ï¼šä¸€åˆ‡éƒ½è‡ªåŠ¨å®æ—¶å‘ç”Ÿï¼ˆæ— éœ€é‡å¯ï¼Œæ— è¿æ¥ä¸­æ–­ï¼‰ã€‚ä½¿ç”¨ Traefikï¼Œæ‚¨å¯ä»¥èŠ±æ—¶é—´ä¸ºç³»ç»Ÿå¼€å‘å’Œéƒ¨ç½²æ–°åŠŸèƒ½ï¼Œè€Œä¸æ˜¯é…ç½®å’Œç»´æŠ¤å…¶å·¥ä½œçŠ¶æ€ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img style=&#34;max-width: 100%; height: auto;&#34; loading=&#34;lazy&#34; loading=&#34;lazy&#34; src=&#34;https://doc.traefik.io/traefik/assets/img/traefik-architecture.png&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;è¾¹ç¼˜è·¯ç”±å™¨&#34;&gt;è¾¹ç¼˜è·¯ç”±å™¨&lt;/h3&gt;
&lt;p&gt;Traefik æ˜¯ä¸€ä¸ª&lt;em&gt;Edge Router&lt;/em&gt;ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯æ‚¨å¹³å°çš„å¤§é—¨ï¼Œå®ƒæ‹¦æˆªå¹¶è·¯ç”±æ¯ä¸ªä¼ å…¥è¯·æ±‚ï¼šå®ƒçŸ¥é“ç¡®å®šå“ªäº›æœåŠ¡å¤„ç†å“ªäº›è¯·æ±‚çš„æ‰€æœ‰é€»è¾‘å’Œæ¯æ¡è§„åˆ™ï¼ˆåŸºäº&lt;a class=&#34;link&#34; href=&#34;https://doc.traefik.io/traefik/routing/routers/#rule&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;path&lt;/a&gt;ï¼Œ&lt;a class=&#34;link&#34; href=&#34;https://doc.traefik.io/traefik/routing/routers/#rule&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;host&lt;/a&gt;ï¼Œ&lt;a class=&#34;link&#34; href=&#34;https://doc.traefik.io/traefik/routing/routers/#rule&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;æ ‡å¤´&lt;/a&gt;ï¼Œ&lt;a class=&#34;link&#34; href=&#34;https://doc.traefik.io/traefik/routing/routers/#rule&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;ç­‰ç­‰&lt;/a&gt;â€¦ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img style=&#34;max-width: 100%; height: auto;&#34; loading=&#34;lazy&#34; alt=&#34;è¾¹ç¼˜è·¯ç”±&#34; loading=&#34;lazy&#34; src=&#34;https://doc.traefik.io/traefik/assets/img/traefik-concepts-1.png&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;è‡ªåŠ¨æœåŠ¡å‘ç°&#34;&gt;è‡ªåŠ¨æœåŠ¡å‘ç°&lt;/h3&gt;
&lt;p&gt;ä¼ ç»Ÿä¸Šè¾¹ç¼˜è·¯ç”±å™¨ï¼ˆæˆ–åå‘ä»£ç†ï¼‰éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åˆ°æ‚¨çš„æœåŠ¡çš„æ¯æ¡å¯èƒ½è·¯å¾„ï¼ŒTraefik ä»æœåŠ¡æœ¬èº«è·å–å®ƒä»¬ã€‚éƒ¨ç½²æ‚¨çš„æœåŠ¡ï¼Œæ‚¨é™„åŠ ä¿¡æ¯å‘Šè¯‰ Traefik æœåŠ¡å¯ä»¥å¤„ç†çš„è¯·æ±‚çš„ç‰¹å¾ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img style=&#34;max-width: 100%; height: auto;&#34; loading=&#34;lazy&#34; alt=&#34;ä¾›åº”å•†&#34; loading=&#34;lazy&#34; src=&#34;https://doc.traefik.io/traefik/assets/img/providers.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;é¦–å…ˆï¼Œå½“å¯åŠ¨ Traefik æ—¶ï¼Œéœ€è¦å®šä¹‰ &lt;code&gt;entrypoints&lt;/code&gt;ï¼ˆå…¥å£ç‚¹ï¼‰ï¼Œç„¶åï¼Œæ ¹æ®è¿æ¥åˆ°è¿™äº› entrypoints çš„&lt;strong&gt;è·¯ç”±&lt;/strong&gt;æ¥åˆ†æä¼ å…¥çš„è¯·æ±‚ï¼Œæ¥æŸ¥çœ‹ä»–ä»¬æ˜¯å¦ä¸ä¸€ç»„&lt;strong&gt;è§„åˆ™&lt;/strong&gt;ç›¸åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™è·¯ç”±å¯èƒ½ä¼šå°†è¯·æ±‚é€šè¿‡ä¸€ç³»åˆ—&lt;strong&gt;ä¸­é—´ä»¶&lt;/strong&gt;è½¬æ¢è¿‡åå†è½¬å‘åˆ°ä½ çš„&lt;strong&gt;æœåŠ¡&lt;/strong&gt;ä¸Šå»ã€‚åœ¨äº†è§£ Traefik ä¹‹å‰æœ‰å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µæˆ‘ä»¬å¿…é¡»è¦äº†è§£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Providers&lt;/code&gt; ç”¨æ¥è‡ªåŠ¨å‘ç°å¹³å°ä¸Šçš„æœåŠ¡ï¼Œå¯ä»¥æ˜¯ç¼–æ’å·¥å…·ã€å®¹å™¨å¼•æ“æˆ–è€… key-value å­˜å‚¨ç­‰ï¼Œæ¯”å¦‚ Dockerã€Kubernetesã€File&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Entrypoints&lt;/code&gt; ç›‘å¬ä¼ å…¥çš„æµé‡ï¼ˆç«¯å£ç­‰â€¦ï¼‰ï¼Œæ˜¯ç½‘ç»œå…¥å£ç‚¹ï¼Œå®ƒä»¬å®šä¹‰äº†æ¥æ”¶è¯·æ±‚çš„ç«¯å£ï¼ˆHTTP æˆ–è€… TCPï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Routers&lt;/code&gt; åˆ†æè¯·æ±‚ï¼ˆhost, path, headers, SSL, â€¦ï¼‰ï¼Œè´Ÿè´£å°†ä¼ å…¥è¯·æ±‚è¿æ¥åˆ°å¯ä»¥å¤„ç†è¿™äº›è¯·æ±‚çš„æœåŠ¡ä¸Šå»ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Services&lt;/code&gt; å°†è¯·æ±‚è½¬å‘ç»™ä½ çš„åº”ç”¨ï¼ˆload balancing, â€¦ï¼‰ï¼Œè´Ÿè´£é…ç½®å¦‚ä½•è·å–æœ€ç»ˆå°†å¤„ç†ä¼ å…¥è¯·æ±‚çš„å®é™…æœåŠ¡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Middlewares&lt;/code&gt; ä¸­é—´ä»¶ï¼Œç”¨æ¥ä¿®æ”¹è¯·æ±‚æˆ–è€…æ ¹æ®è¯·æ±‚æ¥åšå‡ºä¸€äº›åˆ¤æ–­ï¼ˆauthentication, rate limiting, headers, â€¦ï¼‰ï¼Œä¸­é—´ä»¶è¢«é™„ä»¶åˆ°è·¯ç”±ä¸Šï¼Œæ˜¯ä¸€ç§åœ¨è¯·æ±‚å‘é€åˆ°ä½ çš„&lt;strong&gt;æœåŠ¡&lt;/strong&gt;ä¹‹å‰ï¼ˆæˆ–è€…åœ¨æœåŠ¡çš„å“åº”å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼‰è°ƒæ•´è¯·æ±‚çš„ä¸€ç§æ–¹æ³•ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;éƒ¨ç½²traefik&#34;&gt;éƒ¨ç½²Traefik&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Traefikçš„é…ç½®å¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼ï¼š&lt;code&gt;é™æ€é…ç½®&lt;/code&gt;å’Œ&lt;code&gt;åŠ¨æ€é…ç½®&lt;/code&gt;&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="traekfikæ˜¯ä»€ä¹ˆ">Traekfikæ˜¯ä»€ä¹ˆ</h2>
<p>Traefik æ˜¯ä¸€ç§<a class="link" href="https://github.com/traefik/traefik"  target="_blank" rel="noopener"
    >å¼€æº</a> <em>è¾¹ç¼˜è·¯ç”±å™¨</em>ï¼Œå®ƒä½¿æ‚¨å‘å¸ƒæœåŠ¡æˆä¸ºä¸€ç§æœ‰è¶£è€Œè½»æ¾çš„ä½“éªŒã€‚å®ƒä»£è¡¨æ‚¨çš„ç³»ç»Ÿæ¥æ”¶è¯·æ±‚å¹¶æ‰¾å‡ºå“ªäº›ç»„ä»¶è´Ÿè´£å¤„ç†å®ƒä»¬ã€‚</p>
<p>Traefik çš„ä¸ä¼—ä¸åŒä¹‹å¤„åœ¨äºï¼Œé™¤äº†å®ƒçš„è®¸å¤šåŠŸèƒ½ä¹‹å¤–ï¼Œå®ƒè¿˜å¯ä»¥è‡ªåŠ¨ä¸ºæ‚¨çš„æœåŠ¡å‘ç°æ­£ç¡®çš„é…ç½®ã€‚å½“ Traefik æ£€æŸ¥æ‚¨çš„åŸºç¡€æ¶æ„æ—¶ï¼Œå¥‡è¿¹å°±ä¼šå‘ç”Ÿï¼Œå®ƒä¼šåœ¨å…¶ä¸­æ‰¾åˆ°ç›¸å…³ä¿¡æ¯å¹¶å‘ç°å“ªä¸ªæœåŠ¡æœåŠ¡äºå“ªä¸ªè¯·æ±‚ã€‚</p>
<p>Traefik åŸç”Ÿå…¼å®¹æ‰€æœ‰ä¸»è¦çš„é›†ç¾¤æŠ€æœ¯ï¼Œä¾‹å¦‚ Kubernetesã€Dockerã€Docker Swarmã€AWSã€Mesosã€Marathonï¼Œ<a class="link" href="https://doc.traefik.io/traefik/providers/overview/"  target="_blank" rel="noopener"
    >ç­‰ç­‰</a>ï¼›å¹¶ä¸”å¯ä»¥åŒæ—¶å¤„ç†å¾ˆå¤šã€‚ï¼ˆå®ƒç”šè‡³é€‚ç”¨äºåœ¨è£¸æœºä¸Šè¿è¡Œçš„é—ç•™è½¯ä»¶ã€‚ï¼‰</p>
<p>ä½¿ç”¨ Traefikï¼Œæ— éœ€ç»´æŠ¤å’ŒåŒæ­¥å•ç‹¬çš„é…ç½®æ–‡ä»¶ï¼šä¸€åˆ‡éƒ½è‡ªåŠ¨å®æ—¶å‘ç”Ÿï¼ˆæ— éœ€é‡å¯ï¼Œæ— è¿æ¥ä¸­æ–­ï¼‰ã€‚ä½¿ç”¨ Traefikï¼Œæ‚¨å¯ä»¥èŠ±æ—¶é—´ä¸ºç³»ç»Ÿå¼€å‘å’Œéƒ¨ç½²æ–°åŠŸèƒ½ï¼Œè€Œä¸æ˜¯é…ç½®å’Œç»´æŠ¤å…¶å·¥ä½œçŠ¶æ€ã€‚</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" loading="lazy" src="https://doc.traefik.io/traefik/assets/img/traefik-architecture.png"></p>
<h3 id="è¾¹ç¼˜è·¯ç”±å™¨">è¾¹ç¼˜è·¯ç”±å™¨</h3>
<p>Traefik æ˜¯ä¸€ä¸ª<em>Edge Router</em>ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯æ‚¨å¹³å°çš„å¤§é—¨ï¼Œå®ƒæ‹¦æˆªå¹¶è·¯ç”±æ¯ä¸ªä¼ å…¥è¯·æ±‚ï¼šå®ƒçŸ¥é“ç¡®å®šå“ªäº›æœåŠ¡å¤„ç†å“ªäº›è¯·æ±‚çš„æ‰€æœ‰é€»è¾‘å’Œæ¯æ¡è§„åˆ™ï¼ˆåŸºäº<a class="link" href="https://doc.traefik.io/traefik/routing/routers/#rule"  target="_blank" rel="noopener"
    >path</a>ï¼Œ<a class="link" href="https://doc.traefik.io/traefik/routing/routers/#rule"  target="_blank" rel="noopener"
    >host</a>ï¼Œ<a class="link" href="https://doc.traefik.io/traefik/routing/routers/#rule"  target="_blank" rel="noopener"
    >æ ‡å¤´</a>ï¼Œ<a class="link" href="https://doc.traefik.io/traefik/routing/routers/#rule"  target="_blank" rel="noopener"
    >ç­‰ç­‰</a>â€¦ï¼‰ã€‚</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="è¾¹ç¼˜è·¯ç”±" loading="lazy" src="https://doc.traefik.io/traefik/assets/img/traefik-concepts-1.png"></p>
<h3 id="è‡ªåŠ¨æœåŠ¡å‘ç°">è‡ªåŠ¨æœåŠ¡å‘ç°</h3>
<p>ä¼ ç»Ÿä¸Šè¾¹ç¼˜è·¯ç”±å™¨ï¼ˆæˆ–åå‘ä»£ç†ï¼‰éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åˆ°æ‚¨çš„æœåŠ¡çš„æ¯æ¡å¯èƒ½è·¯å¾„ï¼ŒTraefik ä»æœåŠ¡æœ¬èº«è·å–å®ƒä»¬ã€‚éƒ¨ç½²æ‚¨çš„æœåŠ¡ï¼Œæ‚¨é™„åŠ ä¿¡æ¯å‘Šè¯‰ Traefik æœåŠ¡å¯ä»¥å¤„ç†çš„è¯·æ±‚çš„ç‰¹å¾ã€‚</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="ä¾›åº”å•†" loading="lazy" src="https://doc.traefik.io/traefik/assets/img/providers.png"></p>
<p>é¦–å…ˆï¼Œå½“å¯åŠ¨ Traefik æ—¶ï¼Œéœ€è¦å®šä¹‰ <code>entrypoints</code>ï¼ˆå…¥å£ç‚¹ï¼‰ï¼Œç„¶åï¼Œæ ¹æ®è¿æ¥åˆ°è¿™äº› entrypoints çš„<strong>è·¯ç”±</strong>æ¥åˆ†æä¼ å…¥çš„è¯·æ±‚ï¼Œæ¥æŸ¥çœ‹ä»–ä»¬æ˜¯å¦ä¸ä¸€ç»„<strong>è§„åˆ™</strong>ç›¸åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™è·¯ç”±å¯èƒ½ä¼šå°†è¯·æ±‚é€šè¿‡ä¸€ç³»åˆ—<strong>ä¸­é—´ä»¶</strong>è½¬æ¢è¿‡åå†è½¬å‘åˆ°ä½ çš„<strong>æœåŠ¡</strong>ä¸Šå»ã€‚åœ¨äº†è§£ Traefik ä¹‹å‰æœ‰å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µæˆ‘ä»¬å¿…é¡»è¦äº†è§£ï¼š</p>
<ul>
<li><code>Providers</code> ç”¨æ¥è‡ªåŠ¨å‘ç°å¹³å°ä¸Šçš„æœåŠ¡ï¼Œå¯ä»¥æ˜¯ç¼–æ’å·¥å…·ã€å®¹å™¨å¼•æ“æˆ–è€… key-value å­˜å‚¨ç­‰ï¼Œæ¯”å¦‚ Dockerã€Kubernetesã€File</li>
<li><code>Entrypoints</code> ç›‘å¬ä¼ å…¥çš„æµé‡ï¼ˆç«¯å£ç­‰â€¦ï¼‰ï¼Œæ˜¯ç½‘ç»œå…¥å£ç‚¹ï¼Œå®ƒä»¬å®šä¹‰äº†æ¥æ”¶è¯·æ±‚çš„ç«¯å£ï¼ˆHTTP æˆ–è€… TCPï¼‰ã€‚</li>
<li><code>Routers</code> åˆ†æè¯·æ±‚ï¼ˆhost, path, headers, SSL, â€¦ï¼‰ï¼Œè´Ÿè´£å°†ä¼ å…¥è¯·æ±‚è¿æ¥åˆ°å¯ä»¥å¤„ç†è¿™äº›è¯·æ±‚çš„æœåŠ¡ä¸Šå»ã€‚</li>
<li><code>Services</code> å°†è¯·æ±‚è½¬å‘ç»™ä½ çš„åº”ç”¨ï¼ˆload balancing, â€¦ï¼‰ï¼Œè´Ÿè´£é…ç½®å¦‚ä½•è·å–æœ€ç»ˆå°†å¤„ç†ä¼ å…¥è¯·æ±‚çš„å®é™…æœåŠ¡ã€‚</li>
<li><code>Middlewares</code> ä¸­é—´ä»¶ï¼Œç”¨æ¥ä¿®æ”¹è¯·æ±‚æˆ–è€…æ ¹æ®è¯·æ±‚æ¥åšå‡ºä¸€äº›åˆ¤æ–­ï¼ˆauthentication, rate limiting, headers, â€¦ï¼‰ï¼Œä¸­é—´ä»¶è¢«é™„ä»¶åˆ°è·¯ç”±ä¸Šï¼Œæ˜¯ä¸€ç§åœ¨è¯·æ±‚å‘é€åˆ°ä½ çš„<strong>æœåŠ¡</strong>ä¹‹å‰ï¼ˆæˆ–è€…åœ¨æœåŠ¡çš„å“åº”å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼‰è°ƒæ•´è¯·æ±‚çš„ä¸€ç§æ–¹æ³•ã€‚</li>
</ul>
<h2 id="éƒ¨ç½²traefik">éƒ¨ç½²Traefik</h2>
<blockquote>
<p>Traefikçš„é…ç½®å¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼ï¼š<code>é™æ€é…ç½®</code>å’Œ<code>åŠ¨æ€é…ç½®</code></p>
</blockquote>
<ul>
<li>é™æ€é…ç½®ï¼šåœ¨ Traefik ä¸­å®šä¹‰é™æ€é…ç½®é€‰é¡¹æœ‰ä¸‰ç§ä¸åŒçš„ã€äº’æ–¥çš„å³ä½ åªèƒ½åŒæ—¶ä½¿ç”¨ä¸€ç§ï¼‰æ–¹å¼ã€‚
<ul>
<li>åœ¨é…ç½®æ–‡ä»¶ä¸­</li>
<li>åœ¨å‘½ä»¤è¡Œå‚æ•°ä¸­</li>
<li>ä½œä¸ºç¯å¢ƒå˜é‡</li>
</ul>
</li>
<li>åŠ¨æ€é…ç½®ï¼šTraefikä»<a class="link" href="https://doc.traefik.io/traefik/providers/overview/"  target="_blank" rel="noopener"
    >æä¾›è€…å¤„è·å–å…¶</a><em>åŠ¨æ€é…ç½®</em>ï¼šæ— è®ºæ˜¯ç¼–æ’å™¨ã€æœåŠ¡æ³¨å†Œè¡¨è¿˜æ˜¯æ™®é€šçš„æ—§é…ç½®æ–‡ä»¶ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ä½¿ç”¨Helmçš„æ–¹å¼è¿›è¡Œéƒ¨ç½²Traefik2.9.x</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># helm repo add traefik https://traefik.github.io/charts</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># helm repo update</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 yaml<span class="o">]</span><span class="c1"># helm fetch traefik/traefik</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 yaml<span class="o">]</span><span class="c1"># tar -zxf traefik-21.1.0.tgz</span>
</span></span></code></pre></div><ol>
<li>ä¿®æ”¹ä¸€ä¸‹<code>value.yaml</code>ä¸­çš„éƒ¨åˆ†å†…å®¹ï¼Œæ”¹åŠ¨å¤§æ¦‚å¦‚ä¸‹éƒ¨åˆ†çš„å†…å®¹</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">deployment</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">initContainers</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># The &#34;volume-permissions&#34; init container is required if you run into permission issues.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Related issue: https://github.com/traefik/traefik/issues/6825</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume-permissions</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.35</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;touch /data/acme.json &amp;&amp; chmod -Rv 600 /data/* &amp;&amp; chown 65532:65532 /data/acme.json&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">websecure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exposedPort</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exposedPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ingressRoute</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dashboard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">node.kubernetes.io/traefik-manager</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tolerations</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;node-role.kubernetes.io/master&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Equal&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;NoSchedule&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;node-role.kubernetes.io/control-plane&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Equal&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;NoSchedule&#34;</span><span class="w">
</span></span></span></code></pre></div><ol>
<li>åˆ›å»ºä¸€ä¸ª<code>traefik-v2</code>çš„åç§°ç©ºé—´</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 yaml<span class="o">]</span><span class="c1"># kubectl create ns traefik-v2</span>
</span></span></code></pre></div><ol>
<li>éƒ¨ç½²Traefik</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 yaml<span class="o">]</span><span class="c1"># helm install traefik ./traefik -f ./traefik/values.yaml --namespace traefik-v2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 yaml<span class="o">]</span><span class="c1"># kubectl get pods traefik-67b8896675-4xdrx -n traefik-v2 -o yaml</span>
</span></span></code></pre></div><p>å…¶ä¸­ <code>entryPoints</code> å±æ€§å®šä¹‰äº† <code>web</code> å’Œ <code>websecure</code> è¿™ä¸¤ä¸ªå…¥å£ç‚¹çš„ï¼Œå¹¶å¼€å¯ <code>kubernetesingress</code> å’Œ <code>kubernetescrd</code> è¿™ä¸¤ä¸ª providerï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Kubernetes åŸæœ¬çš„ Ingress èµ„æºå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Traefik è‡ªå·±æ‰©å±•çš„ IngressRoute è¿™æ ·çš„ CRD èµ„æºå¯¹è±¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">global.checknewversion</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">global.sendanonymoususage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">entrypoints.metrics.address=:9100/tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">entrypoints.traefik.address=:9000/tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">entrypoints.web.address=:8000/tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">entrypoints.websecure.address=:8443/tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">api.dashboard=true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">ping=true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">metrics.prometheus=true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">metrics.prometheus.entrypoint=metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">providers.kubernetescrd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">providers.kubernetesingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- --<span class="l">entrypoints.websecure.http.tls=true</span><span class="w">
</span></span></span></code></pre></div><h3 id="åˆ›å»ºç”¨äº-dashboard-è®¿é—®çš„-ingressroute-èµ„æº">åˆ›å»ºç”¨äº Dashboard è®¿é—®çš„ IngressRoute èµ„æº</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">web</span><span class="w"> </span><span class="c"># è¿™é‡Œå¯¹åº”çš„æ˜¯webçš„entryPoints å¦‚æœæ˜¯httpså°±éœ€è¦ä½¿ç”¨websecureçš„entryPoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Host(`traefik.kube.com`) </span><span class="w"> </span><span class="c"># æŒ‡å®šåŸŸå</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api@internal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TraefikService </span><span class="w"> </span><span class="c"># å¼•ç”¨å¦å¤–çš„ Traefik Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">root@Online-Beijing-master1 yaml]# kubectl apply -f traefik.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">ingressroute.traefik.containo.us/traefik-dashboard created	</span><span class="w">
</span></span></span></code></pre></div><h2 id="traefikçš„åŸºæœ¬ä½¿ç”¨">Traefikçš„åŸºæœ¬ä½¿ç”¨</h2>
<h3 id="è‡ªå®šä¹‰ä¸€ä¸ªingressroute">è‡ªå®šä¹‰ä¸€ä¸ªIngressRoute</h3>
<p>å‡è®¾æˆ‘ä»¬è¦è®¿é—®ä¸€ä¸ªç®€å•åœ°<code>nginx</code>æœåŠ¡,ä¸‹é¢æ˜¯<code>traefik</code>çš„åŒ¹é…è§„åˆ™</p>
<table>
  <thead>
      <tr>
          <th>åŒ¹é…è§„åˆ™</th>
          <th>æè¿°</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>HeadersRegexp(</code>key<code>, </code>regexp<code>)</code></td>
          <td><code>key</code>æ£€æŸ¥æ ‡é¢˜ä¸­æ˜¯å¦å®šä¹‰äº†é”®ï¼Œå…¶å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…<code>regexp</code></td>
      </tr>
      <tr>
          <td><code>Host(</code>example.com<code>, ...)</code></td>
          <td>æ£€æŸ¥è¯·æ±‚åŸŸï¼ˆä¸»æœºæ ‡å¤´å€¼ï¼‰æ˜¯å¦é’ˆå¯¹ç»™å®šçš„<code>domains</code>.</td>
      </tr>
      <tr>
          <td><code>HostHeader(</code>example.com<code>, ...)</code></td>
          <td>ä¸ ç›¸åŒ<code>Host</code>ï¼Œä»…å› å†å²åŸå› è€Œå­˜åœ¨ã€‚</td>
      </tr>
      <tr>
          <td><code>HostRegexp(</code>example.com<code>, </code>{subdomain:[a-z]+}.example.com<code>, ...)</code></td>
          <td>åŒ¹é…è¯·æ±‚åŸŸã€‚è¯·å‚é˜…ä¸‹é¢çš„â€œæ­£åˆ™è¡¨è¾¾å¼è¯­æ³•â€ã€‚</td>
      </tr>
      <tr>
          <td><code>Method(</code>GET<code>, ...)</code></td>
          <td>æ£€æŸ¥è¯·æ±‚æ–¹æ³•æ˜¯å¦ä¸ºç»™å®šçš„<code>methods</code>( <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code>, <code>PATCH</code>, <code>HEAD</code>)ä¹‹ä¸€</td>
      </tr>
      <tr>
          <td><code>Path(</code>/path<code>, </code>/articles/{cat:[a-z]+}/{id:[0-9]+}<code>, ...)</code></td>
          <td>åŒ¹é…å‡†ç¡®çš„è¯·æ±‚è·¯å¾„ã€‚è¯·å‚é˜…ä¸‹é¢çš„â€œæ­£åˆ™è¡¨è¾¾å¼è¯­æ³•â€ã€‚</td>
      </tr>
      <tr>
          <td><code>PathPrefix(</code>/products/<code>, </code>/articles/{cat:[a-z]+}/{id:[0-9]+}<code>)</code></td>
          <td>åŒ¹é…è¯·æ±‚å‰ç¼€è·¯å¾„ã€‚è¯·å‚é˜…ä¸‹é¢çš„â€œæ­£åˆ™è¡¨è¾¾å¼è¯­æ³•â€ã€‚</td>
      </tr>
      <tr>
          <td><code>Query(</code>foo=bar<code>, </code>bar=baz<code>)</code></td>
          <td>åŒ¹é…æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°ã€‚å®ƒæ¥å—ä¸€ç³»åˆ—é”®=å€¼å¯¹ã€‚</td>
      </tr>
      <tr>
          <td><code>ClientIP(</code>10.0.0.0/16<code>, </code>::1<code>)</code></td>
          <td>å¦‚æœè¯·æ±‚å®¢æˆ·ç«¯ IP æ˜¯ç»™å®šçš„ IP/CIDR ä¹‹ä¸€ï¼Œåˆ™åŒ¹é…ã€‚å®ƒæ¥å— IPv4ã€IPv6 å’Œ CIDR</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-qingyang-http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">web</span><span class="w"> </span><span class="c"># ä¾æ—§å¯¹åº”web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Host(`traefik.qingyang.com`) </span><span class="w"> </span><span class="c"># æŒ‡å®šåŸŸå</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-demo</span><span class="w"> </span><span class="c"># è¿™ä¸ªåœ°æ–¹å¯¹åº”kubernetesçš„svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>å¦‚æœæˆ‘ä»¬éœ€è¦å¼€å¯<code>HTTPS</code>æ¥è®¿é—®æˆ‘ä»¬è¿™ä¸ªåº”ç”¨çš„è¯ï¼Œå°±éœ€è¦ç›‘å¬ <code>websecure</code> è¿™ä¸ªå…¥å£ç‚¹ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ 443 ç«¯å£æ¥è®¿é—®ï¼ŒåŒæ ·ç”¨ <code>HTTPS</code> è®¿é—®åº”ç”¨å¿…ç„¶å°±éœ€è¦è¯ä¹¦ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ <code>openssl</code> æ¥åˆ›å»ºä¸€ä¸ªè‡ªç­¾åçš„è¯ä¹¦ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="s2">&#34;/CN=traefik.qingyang.com&#34;</span>
</span></span></code></pre></div><p>ç„¶ååˆ›å»º<code>secret</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 yaml<span class="o">]</span><span class="c1"># kubectl create secret tls traefik-demo-tls --cert=tls.crt --key=tls.key</span>
</span></span></code></pre></div><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>HTTPS</code> è®¿é—®åº”ç”¨çš„ <code>IngressRoute</code> å¯¹è±¡äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-qingyang-https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">websecure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Host(`traefik.qingyang.com`)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-demo-tls</span><span class="w">
</span></span></span></code></pre></div><h3 id="acmeè‡ªåŠ¨ç­¾å‘">ACMEè‡ªåŠ¨ç­¾å‘</h3>
<p>raefik åŒæ ·ä¹Ÿæ”¯æŒä½¿ç”¨ <code>Letâ€™s Encrypt</code> è‡ªåŠ¨ç”Ÿæˆè¯ä¹¦ï¼Œè¦ä½¿ç”¨ <code>Letâ€™s Encrypt</code> æ¥è¿›è¡Œè‡ªåŠ¨åŒ– HTTPSï¼Œå°±éœ€è¦é¦–å…ˆå¼€å¯ <code>ACME</code>ï¼Œå¼€å¯ <code>ACME</code> éœ€è¦é€šè¿‡é™æ€é…ç½®çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ã€å¯åŠ¨å‚æ•°ç­‰æ–¹å¼æ¥æä¾›ã€‚</p>
<p>ACME æœ‰å¤šç§æ ¡éªŒæ–¹å¼ <code>tlsChallenge</code>ã€<code>httpChallenge</code> å’Œ <code>dnsChallenge</code> ä¸‰ç§éªŒè¯æ–¹å¼ï¼Œä¹‹å‰æ›´å¸¸ç”¨çš„æ˜¯ http è¿™ç§éªŒè¯æ–¹å¼(å¯ä»¥ç™¾åº¦ä¸€ä¸‹)è¿™å‡ ç§çš„æ ¡éªŒæ–¹å¼ã€‚è¦ä½¿ç”¨ tls æ ¡éªŒæ–¹å¼çš„è¯éœ€è¦ä¿è¯ Traefik çš„ 443 ç«¯å£æ˜¯å¯è¾¾çš„ï¼Œdns æ ¡éªŒæ–¹å¼å¯ä»¥ç”Ÿæˆé€šé…ç¬¦çš„è¯ä¹¦ï¼Œåªéœ€è¦é…ç½®ä¸Š DNS è§£ææœåŠ¡å•†çš„ API è®¿é—®å¯†é’¥å³å¯æ ¡éªŒã€‚æˆ‘ä»¬è¿™é‡Œç”¨ DNS æ ¡éªŒçš„æ–¹å¼æ¥ä¸ºå¤§å®¶è¯´æ˜å¦‚ä½•é…ç½® ACMEã€‚</p>
<ol>
<li>é‡æ–°ä¿®æ”¹ä¸€ä¸‹åˆšåˆšTraefikçš„å‚æ•°<code>values.yaml</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">additionalArguments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ä½¿ç”¨ dns éªŒè¯æ–¹å¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- --<span class="l">certificatesResolvers.ali.acme.dnsChallenge.provider=alidns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># å…ˆä½¿ç”¨stagingç¯å¢ƒè¿›è¡ŒéªŒè¯ï¼ŒéªŒè¯æˆåŠŸåå†ä½¿ç”¨ç§»é™¤ä¸‹é¢ä¸€è¡Œçš„é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># - --certificatesResolvers.ali.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># é‚®ç®±é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- --<span class="l">certificatesResolvers.ali.acme.email=ych_1024@163.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ä¿å­˜ ACME è¯ä¹¦çš„ä½ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- --<span class="l">certificatesResolvers.ali.acme.storage=/data/acme.json</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">envFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">secretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-alidns-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ALICLOUD_ACCESS_KEY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ALICLOUD_SECRET_KEY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ALICLOUD_REGION_ID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># å¼€å¯æŒä¹…åŒ–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessMode</span><span class="p">:</span><span class="w"> </span><span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ç”±äºä¸Šé¢æŒä¹…åŒ–äº†ACMEçš„æ•°æ®ï¼Œéœ€è¦é‡æ–°é…ç½®ä¸‹é¢çš„å®‰å…¨ä¸Šä¸‹æ–‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åæ›´æ–°<code>traefik</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm up traefik ./traefik -f ./traefik/values.yaml --namespace traefik-v2
</span></span></code></pre></div><ul>
<li>è¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® <code>--certificatesresolvers.ali.acme.dnschallenge.provider=alidns</code> å‚æ•°æ¥æŒ‡å®šæŒ‡å®šé˜¿é‡Œäº‘çš„ DNS æ ¡éªŒï¼Œè¦ä½¿ç”¨é˜¿é‡Œäº‘çš„ DNS æ ¡éªŒæˆ‘ä»¬è¿˜éœ€è¦é…ç½®3ä¸ªç¯å¢ƒå˜é‡ï¼š<code>ALICLOUD_ACCESS_KEY</code>ã€<code>ALICLOUD_SECRET_KEY</code>ã€<code>ALICLOUD_REGION_ID</code>ï¼Œåˆ†åˆ«å¯¹åº”æˆ‘ä»¬å¹³æ—¶å¼€å‘é˜¿é‡Œäº‘åº”ç”¨çš„æ—¶å€™çš„å¯†é’¥ï¼Œå¯ä»¥ç™»å½•é˜¿é‡Œäº‘åå°è·å–ï¼Œç”±äºè¿™æ˜¯æ¯”è¾ƒç§å¯†çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ Secret å¯¹è±¡æ¥åˆ›å»º</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create secret generic traefik-alidns-secret --from-literal<span class="o">=</span><span class="nv">ALICLOUD_ACCESS_KEY</span><span class="o">=</span>&lt;aliyun ak&gt; --from-literal<span class="o">=</span><span class="nv">ALICLOUD_SECRET_KEY</span><span class="o">=</span>&lt;aliyun sk&gt; --from-literal<span class="o">=</span><span class="nv">ALICLOUD_REGION_ID</span><span class="o">=</span>cn-beijing -n traefik-v2
</span></span></code></pre></div><ul>
<li>åˆ›å»ºå®Œæˆåå°†è¿™ä¸ª Secret é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®åˆ° Traefik çš„åº”ç”¨ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ˜¯éªŒè¯é€šè¿‡çš„è¯ä¹¦æˆ‘ä»¬è¿™é‡Œå­˜åˆ° <code>/data/acme.json</code> æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¸€å®šè¦å°†è¿™ä¸ªæ–‡ä»¶æŒä¹…åŒ–ï¼Œå¦åˆ™æ¯æ¬¡ Traefik é‡å»ºåå°±éœ€è¦é‡æ–°è®¤è¯ï¼Œè€Œ <code>Letâ€™s Encrypt</code> æœ¬èº«æ ¡éªŒæ¬¡æ•°æ˜¯æœ‰é™åˆ¶çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨ values ä¸­é‡æ–°å¼€å¯äº†æ•°æ®æŒä¹…åŒ–ï¼Œä¸è¿‡å¼€å¯è¿‡åéœ€è¦æˆ‘ä»¬æä¾›ä¸€ä¸ªå¯ç”¨çš„ PV å­˜å‚¨ï¼Œç”±äºæˆ‘ä»¬å°† Traefik å›ºå®šåˆ° master1 èŠ‚ç‚¹ä¸Šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª hostpath ç±»å‹çš„ PV</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/data/k8s/traefik</span><span class="w">
</span></span></span></code></pre></div><ol>
<li>æ›´æ–°<code>IngressRoute</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-qingyang-https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">websecure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Host(`traefik.qingyang.com`)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">certResolver</span><span class="p">:</span><span class="w"> </span><span class="l">ali</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">domains</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">main</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*.qingyang.com&#34;</span><span class="w">
</span></span></span></code></pre></div><p>åªéœ€è¦å°† tls éƒ¨åˆ†æ”¹æˆæˆ‘ä»¬å®šä¹‰çš„ <code>ali</code> è¿™ä¸ªè¯ä¹¦è§£æå™¨ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ç”Ÿæˆä¸€ä¸ªé€šé…ç¬¦çš„åŸŸåè¯ä¹¦çš„è¯å¯ä»¥å®šä¹‰ <code>domains</code> å‚æ•°æ¥æŒ‡å®šï¼Œç„¶åæ›´æ–° <code>IngressRoute </code>å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†å»ç”¨ HTTPS è®¿é—®æˆ‘ä»¬çš„åº”ç”¨ï¼ˆå½“ç„¶éœ€è¦å°†åŸŸååœ¨é˜¿é‡Œäº‘ DNS ä¸Šåšè§£æï¼‰</p>
<h2 id="ä¸­é—´ä»¶">ä¸­é—´ä»¶</h2>
<p>è¿æ¥åˆ°è·¯ç”±å™¨çš„ä¸­é—´ä»¶æ˜¯ä¸€ç§åœ¨å°†è¯·æ±‚å‘é€åˆ°æ‚¨çš„<a class="link" href="https://doc.traefik.io/traefik/routing/services/"  target="_blank" rel="noopener"
    >æœåŠ¡</a>ä¹‹å‰ï¼ˆæˆ–åœ¨å°†æœåŠ¡çš„ç­”æ¡ˆå‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼‰è°ƒæ•´è¯·æ±‚çš„æ–¹æ³•ã€‚</p>
<p>Traefik ä¸­æœ‰å‡ ä¸ªå¯ç”¨çš„ä¸­é—´ä»¶ï¼Œæœ‰çš„å¯ä»¥ä¿®æ”¹è¯·æ±‚ï¼Œheadersï¼Œæœ‰çš„è´Ÿè´£é‡å®šå‘ï¼Œæœ‰çš„æ·»åŠ è®¤è¯ç­‰ç­‰ã€‚</p>
<p>ä½¿ç”¨ç›¸åŒåè®®çš„ä¸­é—´ä»¶å¯ä»¥ç»„åˆæˆé“¾ä»¥é€‚åº”å„ç§åœºæ™¯ã€‚</p>
<ul>
<li><a class="link" href="https://doc.traefik.io/traefik/middlewares/http/overview/"  target="_blank" rel="noopener"
    >HTTPä¸­é—´ä»¶åˆ—è¡¨</a></li>
<li><a class="link" href="https://doc.traefik.io/traefik/middlewares/tcp/overview/"  target="_blank" rel="noopener"
    >TCPä¸­é—´ä»¶åˆ—è¡¨</a></li>
</ul>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="img" loading="lazy" src="https://doc.traefik.io/traefik/assets/img/middleware/overview.png"></p>
<h3 id="å¼ºåˆ¶è·³è½¬https">å¼ºåˆ¶è·³è½¬Https</h3>
<p>Traefik ä¸­ä¹Ÿæ˜¯å¯ä»¥é…ç½®å¼ºåˆ¶è·³è½¬çš„ï¼Œåªæ˜¯è¿™ä¸ªåŠŸèƒ½ç°åœ¨æ˜¯é€šè¿‡ä¸­é—´ä»¶æ¥æä¾›çš„äº†ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>redirectScheme</code> ä¸­é—´ä»¶æ¥åˆ›å»ºæä¾›å¼ºåˆ¶è·³è½¬æœåŠ¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Redirect to https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Middleware </span><span class="w"> </span><span class="c"># åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-redirectscheme</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">redirectScheme</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">permanent</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-qingyang-http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">web </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Host(`traefik.qingyang.com`) </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">middlewares</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-redirectscheme</span><span class="w"> </span><span class="c"># æŒ‡å®šæ·»åŠ ä¸­é—´ä»¶çš„åç§°</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>å¦‚æœä½ æœ‰å…·ä½“éœ€æ±‚çš„è¯è¯·å‰å¾€å®˜ç½‘æ–‡æ¡£æŸ¥çœ‹æ›´å¤šä¸­é—´ä»¶çš„é€‚ç”¨æ–¹æ³•ã€‚</p>
</blockquote>
<h2 id="traefik-pilot">Traefik Pilot</h2>
<p>è™½ç„¶ Traefik å·²ç»é»˜è®¤å®ç°äº†å¾ˆå¤šä¸­é—´ä»¶ï¼Œå¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†æˆ‘ä»¬æ—¥å¸¸çš„éœ€æ±‚ï¼Œä½†æ˜¯åœ¨å®é™…å·¥ä½œä¸­ï¼Œç”¨æˆ·ä»ç„¶è¿˜æ˜¯æœ‰è‡ªå®šä¹‰ä¸­é—´ä»¶çš„éœ€æ±‚ï¼Œè¿™å°± <a class="link" href="https://pilot.traefik.io/"  target="_blank" rel="noopener"
    >Traefik Pilot</a> çš„åŠŸèƒ½äº†ã€‚</p>
<p>Traefik Pilot æ˜¯ä¸€ä¸ª SaaS å¹³å°ï¼Œå’Œ Traefik è¿›è¡Œé“¾æ¥æ¥æ‰©å±•å…¶åŠŸèƒ½ï¼Œå®ƒæä¾›äº†å¾ˆå¤šåŠŸèƒ½ï¼Œé€šè¿‡ä¸€ä¸ªå…¨å±€æ§åˆ¶é¢æ¿å’Œ Dashboard æ¥å¢å¼ºå¯¹ Traefik çš„è§‚æµ‹å’Œæ§åˆ¶ï¼š</p>
<ul>
<li>Traefik ä»£ç†å’Œä»£ç†ç»„çš„ç½‘ç»œæ´»åŠ¨çš„æŒ‡æ ‡</li>
<li>æœåŠ¡å¥åº·é—®é¢˜å’Œå®‰å…¨æ¼æ´è­¦æŠ¥</li>
<li>æ‰©å±• Traefik åŠŸèƒ½çš„æ’ä»¶</li>
</ul>
<p>åœ¨ Traefik å¯ä»¥ä½¿ç”¨ <code>Traefik Pilot</code> çš„åŠŸèƒ½ä¹‹å‰ï¼Œå¿…é¡»å…ˆè¿æ¥å®ƒä»¬ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹ Traefik çš„é™æ€é…ç½®è¿›è¡Œå°‘é‡æ›´æ”¹å³å¯ã€‚</p>
<blockquote>
<p>æ³¨æ„: Traefik ä»£ç†å¿…é¡»è¦èƒ½è®¿é—®äº’è”ç½‘æ‰èƒ½è¿æ¥åˆ° <code>Traefik Pilot</code>ï¼Œé€šè¿‡ HTTPS åœ¨ 443 ç«¯å£ä¸Šå»ºç«‹è¿æ¥ã€‚ è¿™ä¸ªæˆ‘å°±ä¸æ¼”ç¤ºäº†ï¼Œæˆ‘çš„è™šæ‹Ÿæœºæœ¨æœ‰å¤–ç½‘ã€‚</p>
</blockquote>
<h2 id="ç°åº¦å‘å¸ƒ">ç°åº¦å‘å¸ƒ</h2>
<p>è·ŸIngress-nginxæ˜¯ä¸€æ ·çš„å°±ä¸å¤šä»‹ç»ç°åº¦å‘å¸ƒæ˜¯å•¥äº†</p>
<h3 id="åŸºäºæƒé‡çš„è½®è¯¢">åŸºäºæƒé‡çš„è½®è¯¢</h3>
<p>è¿™æ¬¡ä½¿ç”¨çš„<code>Deployment</code>å’Œä¸Šæ¬¡<code>Ingress-nginx</code>ä¸€æ ·ï¼Œå¤§å®¶å»Ingressé‚£ç¯‡æ–‡ç« å»æ‰¾ä¸€ä¸‹å’¯</p>
<p>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨<code>TraefikService</code>è¿™ä¸ªå¯¹è±¡æ¥é…ç½®åŸºäºæƒé‡çš„è½®è¯¢</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TraefikService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">auy-cat-wrr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">weighted</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">production</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">  </span><span class="c"># å®šä¹‰æƒé‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åä¿®æ”¹æˆ‘ä»¬<code>IngressRoute</code>ä¸­ä½¿ç”¨çš„<code>TraefikService</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-qingyang-http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">web </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Host(`traefik.qingyang.com`) </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">auy-cat-wrr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TraefikService</span><span class="w"> </span><span class="c"># ä½¿ç”¨å£°æ˜çš„ TraefikService æœåŠ¡ï¼Œè€Œä¸æ˜¯ K8S çš„ Service</span><span class="w">
</span></span></span></code></pre></div><h2 id="æµé‡å¤åˆ¶">æµé‡å¤åˆ¶</h2>
<p>é™¤äº†ç°åº¦å‘å¸ƒä¹‹å¤–ï¼ŒTraefikè¿˜å¼•å…¥äº†æµé‡é•œåƒæœåŠ¡ï¼Œæ˜¯ä¸€ç§å¯ä»¥å°†æµå…¥æµé‡å¤åˆ¶å¹¶åŒæ—¶å°†å…¶å‘é€ç»™å…¶ä»–æœåŠ¡çš„æ–¹æ³•ï¼Œé•œåƒæœåŠ¡å¯ä»¥è·å¾—ç»™å®šç™¾åˆ†æ¯”çš„è¯·æ±‚åŒæ—¶ä¹Ÿä¼šå¿½ç•¥è¿™éƒ¨åˆ†è¯·æ±‚çš„å“åº”ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬åˆšåˆšçš„<code>production</code>ä¸ºçº¿ä¸ŠæœåŠ¡<code>canary</code>ä¸ºé¢„è§ˆæœåŠ¡,ç°åœ¨å¸Œæœ›è¯·æ±‚<code>production</code>çš„æµé‡åŒæ—¶å¤åˆ¶ä¸€ä»½ä¹Ÿè¯·æ±‚åˆ°<code>canary</code>ç‰ˆæœ¬ä¸­</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TraefikService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mirror-replication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mirroring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">production</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mirrors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">percent</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-qingyang-http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">web </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Host(`traefik.qingyang.com`) </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mirror-replication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TraefikService</span><span class="w"> </span><span class="c"># ä½¿ç”¨å£°æ˜çš„ TraefikService æœåŠ¡ï¼Œè€Œä¸æ˜¯ K8S çš„ Service</span><span class="w">
</span></span></span></code></pre></div><h2 id="ä»£ç†tcpudp">ä»£ç†Tcp/Udp</h2>
<p>å¦å¤– Traefik2.X å·²ç»æ”¯æŒäº† TCP æœåŠ¡çš„ï¼Œä¸‹é¢æˆ‘ä»¬ä»¥ mongo ä¸ºä¾‹æ¥äº†è§£ä¸‹ Traefik æ˜¯å¦‚ä½•æ”¯æŒ TCP æœåŠ¡å¾—ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">27017</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">27017</span><span class="w">
</span></span></span></code></pre></div><ol>
<li>æ–°å¢<code>Traefik</code>çš„å…¥å£ç‚¹</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">websecure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mongo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">27017</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">27017</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œç»™å…¥å£ç‚¹æ·»åŠ  <code>hostPort</code> æ˜¯ä¸ºäº†èƒ½å¤Ÿé€šè¿‡èŠ‚ç‚¹çš„ç«¯å£è®¿é—®åˆ°æœåŠ¡ï¼Œå…³äº entryPoints å…¥å£ç‚¹çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹æ–‡æ¡£ <a class="link" href="https://www.qikqiak.com/traefik-book/routing/entrypoints/"  target="_blank" rel="noopener"
    >entrypoints</a> äº†è§£æ›´å¤šä¿¡æ¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm upgrade --install traefik ./traefik -f ./traefik/values.yaml -n traefik-v2
</span></span></code></pre></div><ol start="2">
<li>ç”±äº Traefik ä¸­ä½¿ç”¨ TCP è·¯ç”±é…ç½®éœ€è¦ <code>SNI</code>ï¼Œè€Œ <code>SNI</code> åˆæ˜¯ä¾èµ– <code>TLS</code> çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é…ç½®è¯ä¹¦æ‰è¡Œï¼Œå¦‚æœæ²¡æœ‰è¯ä¹¦çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ <code>*</code> è¿›è¡Œé…ç½®ï¼Œæˆ‘ä»¬è¿™é‡Œåˆ›å»ºä¸€ä¸ª <code>IngressRouteTCP</code> ç±»å‹çš„ CRD</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRouteTCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-traefik-tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">HostSNI(`*`)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">27017</span><span class="w">
</span></span></span></code></pre></div><p>æˆ‘è¿™é‡Œæ²¡æœ‰<code>mongo</code>çš„å®¢æˆ·ç«¯,ç›´æ¥æ ¡éªŒä¸€ä¸‹ç«¯å£å°±è¡Œäº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">telnet traefik.qingyang.com <span class="m">27017</span>
</span></span></code></pre></div><h3 id="ä½¿ç”¨ç‰¹å®šçš„åŸŸåè¿›è¡Œä»£ç†è®¿é—®">ä½¿ç”¨ç‰¹å®šçš„åŸŸåè¿›è¡Œä»£ç†è®¿é—®</h3>
<p>å‡è®¾æˆ‘ç°åœ¨æœ‰ä¸€ä¸ª<code>mysql</code>æœåŠ¡ï¼Œæƒ³é€šè¿‡<code>traefik.mysql.prod</code>è¿›è¡Œè¿æ¥è®¿é—®.</p>
<p>æˆ‘ä»¬åœ¨åŠ ä¸€ä¸ª<code>proxy-mysql</code>çš„<code>entryPoints</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">websecure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mongo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">27017</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">27017</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">proxy-mysql</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span></span></span></code></pre></div><ol>
<li>ç”Ÿæˆä¸€ä¸ª<code>traefik.mysql.prod</code>çš„è‡ªç­¾åè¯ä¹¦</li>
</ol>
<ul>
<li>è£…ä¸ªGolang<code>dnf install -y go</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/jsha/minica.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> minica
</span></span><span class="line"><span class="cl">go build
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 minica<span class="o">]</span><span class="c1"># ./minica --domains &#39;traefik.mysql.prod&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 minica<span class="o">]</span><span class="c1"># cd traefik.mysql.prod/</span>
</span></span></code></pre></div><ol start="2">
<li>ç”Ÿæˆ<code>secret</code>,è¯·ç¡®ä¿ä½ å¤„äºå½“å‰çš„<code>cert.key</code>å’Œ<code>key.pem</code>çš„ç›®å½•ä¸‹</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create secret tls tcp-demo-mysql --cert<span class="o">=</span>cert.pem --key<span class="o">=</span>key.pem
</span></span></code></pre></div><ol start="3">
<li>åˆ›å»º<code>IngressRouteTCP</code>å¯¹è±¡</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRouteTCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tcp-inner-mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">proxy-mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">HostSNI(`traefik.mysql.prod`)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">env-prod-mysql-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w"> </span><span class="c"># ç»‘å®šTls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">tcp-demo-mysql</span><span class="w">
</span></span></span></code></pre></div><h3 id="ä»£ç†ä¸€ä¸ªudpæœåŠ¡">ä»£ç†ä¸€ä¸ªUdpæœåŠ¡</h3>
<ol>
<li>éƒ¨ç½²ä¸€ä¸ªUDPæœåŠ¡</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">whoami</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">whoami</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">whoami</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">whoami</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">whoami</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">containous/whoamiudp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">whoamiudp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">udp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">whoami</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>åœ¨<code>Traefik</code>å½“ä¸­æ·»åŠ UDPçš„å…¥å£ç‚¹ï¼Œè€æ ·å­ä¿®æ”¹<code>values.yaml</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">udpend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">18080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">18080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>UDP çš„å…¥å£ç‚¹å¢åŠ æˆåŠŸåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>IngressRouteUDP</code> ç±»å‹çš„èµ„æºå¯¹è±¡ï¼Œç”¨æ¥ä»£ç† UDP è¯·æ±‚ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRouteUDP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">whoamiudp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">udpend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">whoamiudp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>Kubernetes-æœ¬åœ°å­˜å‚¨</title>
      <link>https://blog.mletter.cn/tech/kubernetes/local-storage/</link>
      <pubDate>Wed, 22 Mar 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/local-storage/</guid>
      <description>å‰é¢æˆ‘ä»¬æœ‰é€šè¿‡ hostPath æˆ–è€… emptyDir çš„æ–¹å¼æ¥æŒä¹…åŒ–æˆ‘ä»¬çš„æ•°æ®</description>
      <content:encoded><![CDATA[<h1 id="æœ¬åœ°å­˜å‚¨">æœ¬åœ°å­˜å‚¨</h1>
<p>å‰é¢æˆ‘ä»¬æœ‰é€šè¿‡ <code>hostPath</code> æˆ–è€… <code>emptyDir</code> çš„æ–¹å¼æ¥æŒä¹…åŒ–æˆ‘ä»¬çš„æ•°æ®ï¼Œä½†æ˜¯æ˜¾ç„¶æˆ‘ä»¬è¿˜éœ€è¦æ›´åŠ å¯é çš„å­˜å‚¨æ¥ä¿å­˜åº”ç”¨çš„æŒä¹…åŒ–æ•°æ®ï¼Œè¿™æ ·å®¹å™¨åœ¨é‡å»ºåï¼Œä¾ç„¶å¯ä»¥ä½¿ç”¨ä¹‹å‰çš„æ•°æ®ã€‚ä½†æ˜¯å­˜å‚¨èµ„æºå’Œ CPU èµ„æºä»¥åŠå†…å­˜èµ„æºæœ‰å¾ˆå¤§ä¸åŒï¼Œä¸ºäº†å±è”½åº•å±‚çš„æŠ€æœ¯å®ç°ç»†èŠ‚ï¼Œè®©ç”¨æˆ·æ›´åŠ æ–¹ä¾¿çš„ä½¿ç”¨ï¼ŒKubernetes ä¾¿å¼•å…¥äº† <code>PV</code> å’Œ <code>PVC</code> ä¸¤ä¸ªé‡è¦çš„èµ„æºå¯¹è±¡æ¥å®ç°å¯¹å­˜å‚¨çš„ç®¡ç†ã€‚</p>
<h2 id="persistentvolume">PersistentVolume</h2>
<p><code>PV</code> çš„å…¨ç§°æ˜¯ï¼š<code>PersistentVolume</code>ï¼ˆæŒä¹…åŒ–å·ï¼‰ï¼Œæ˜¯å¯¹åº•å±‚å…±äº«å­˜å‚¨çš„ä¸€ç§æŠ½è±¡ï¼ŒPV ç”±ç®¡ç†å‘˜è¿›è¡Œåˆ›å»ºå’Œé…ç½®ï¼Œå®ƒå’Œå…·ä½“çš„åº•å±‚çš„å…±äº«å­˜å‚¨æŠ€æœ¯çš„å®ç°æ–¹å¼æœ‰å…³ï¼Œæ¯”å¦‚ <code>Ceph</code>ã€<code>GlusterFS</code>ã€<code>NFS</code>ã€<code>hostPath</code> ç­‰ï¼Œéƒ½æ˜¯é€šè¿‡æ’ä»¶æœºåˆ¶å®Œæˆä¸å…±äº«å­˜å‚¨çš„å¯¹æ¥ã€‚</p>
<h2 id="persistentvolumeclaim">PersistentVolumeClaim</h2>
<p><code>PVC</code> çš„å…¨ç§°æ˜¯ï¼š<code>PersistentVolumeClaim</code>ï¼ˆæŒä¹…åŒ–å·å£°æ˜ï¼‰ï¼ŒPVC æ˜¯ç”¨æˆ·å­˜å‚¨çš„ä¸€ç§å£°æ˜ï¼ŒPVC å’Œ Pod æ¯”è¾ƒç±»ä¼¼ï¼ŒPod æ¶ˆè€—çš„æ˜¯èŠ‚ç‚¹ï¼ŒPVC æ¶ˆè€—çš„æ˜¯ PV èµ„æºï¼ŒPod å¯ä»¥è¯·æ±‚ CPU å’Œå†…å­˜ï¼Œè€Œ PVC å¯ä»¥è¯·æ±‚ç‰¹å®šçš„å­˜å‚¨ç©ºé—´å’Œè®¿é—®æ¨¡å¼ã€‚å¯¹äºçœŸæ­£ä½¿ç”¨å­˜å‚¨çš„ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒåº•å±‚çš„å­˜å‚¨å®ç°ç»†èŠ‚ï¼Œåªéœ€è¦ç›´æ¥ä½¿ç”¨ PVC å³å¯ã€‚</p>
<p>ä½†æ˜¯é€šè¿‡ PVC è¯·æ±‚åˆ°ä¸€å®šçš„å­˜å‚¨ç©ºé—´ä¹Ÿå¾ˆæœ‰å¯èƒ½ä¸è¶³ä»¥æ»¡è¶³åº”ç”¨å¯¹äºå­˜å‚¨è®¾å¤‡çš„å„ç§éœ€æ±‚ï¼Œè€Œä¸”ä¸åŒçš„åº”ç”¨ç¨‹åºå¯¹äºå­˜å‚¨æ€§èƒ½çš„è¦æ±‚å¯èƒ½ä¹Ÿä¸å°½ç›¸åŒï¼Œæ¯”å¦‚è¯»å†™é€Ÿåº¦ã€å¹¶å‘æ€§èƒ½ç­‰ï¼Œä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒKubernetes åˆä¸ºæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªæ–°çš„èµ„æºå¯¹è±¡ï¼š<code>StorageClass</code>ï¼Œé€šè¿‡ <code>StorageClass</code> çš„å®šä¹‰ï¼Œç®¡ç†å‘˜å¯ä»¥å°†å­˜å‚¨èµ„æºå®šä¹‰ä¸ºæŸç§ç±»å‹çš„èµ„æºï¼Œæ¯”å¦‚å¿«é€Ÿå­˜å‚¨ã€æ…¢é€Ÿå­˜å‚¨ç­‰ï¼Œç”¨æˆ·æ ¹æ® <code>StorageClass</code> çš„æè¿°å°±å¯ä»¥éå¸¸ç›´è§‚çš„çŸ¥é“å„ç§å­˜å‚¨èµ„æºçš„å…·ä½“ç‰¹æ€§äº†ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®åº”ç”¨çš„ç‰¹æ€§å»ç”³è¯·åˆé€‚çš„å­˜å‚¨èµ„æºäº†ï¼Œæ­¤å¤– <code>StorageClass</code> è¿˜å¯ä»¥ä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆ PVï¼Œå…å»äº†æ¯æ¬¡æ‰‹åŠ¨åˆ›å»ºçš„éº»çƒ¦ã€‚</p>
<h2 id="hostpath">HostPath</h2>
<p>æˆ‘ä»¬ä¸Šé¢æåˆ°äº† PV æ˜¯å¯¹åº•å±‚å­˜å‚¨æŠ€æœ¯çš„ä¸€ç§æŠ½è±¡ï¼ŒPV ä¸€èˆ¬éƒ½æ˜¯ç”±ç®¡ç†å‘˜æ¥åˆ›å»ºå’Œé…ç½®çš„ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥åˆ›å»ºä¸€ä¸ª <code>hostPath</code> ç±»å‹çš„ <code>PersistentVolume</code>ã€‚Kubernetes æ”¯æŒ <code>hostPath</code> ç±»å‹çš„ <code>PersistentVolume</code> ä½¿ç”¨èŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•æ¥æ¨¡æ‹Ÿé™„å¸¦ç½‘ç»œçš„å­˜å‚¨ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ç”Ÿäº§é›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šä½¿ç”¨ <code>hostPath</code>ï¼Œé›†ç¾¤ç®¡ç†å‘˜ä¼šæä¾›ç½‘ç»œå­˜å‚¨èµ„æºï¼Œæ¯”å¦‚ <code>NFS</code> å…±äº«å·æˆ– <code>Ceph</code> å­˜å‚¨å·ï¼Œé›†ç¾¤ç®¡ç†å‘˜è¿˜å¯ä»¥ä½¿ç”¨ <code>StorageClasses</code> æ¥è®¾ç½®åŠ¨æ€æä¾›å­˜å‚¨ã€‚å› ä¸º Pod å¹¶ä¸æ˜¯å§‹ç»ˆå›ºå®šåœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šé¢çš„ï¼Œæ‰€ä»¥è¦ä½¿ç”¨ hostPath çš„è¯æˆ‘ä»¬å°±éœ€è¦å°† Pod å›ºå®šåœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šï¼Œè¿™æ ·æ˜¾ç„¶å°±å¤§å¤§é™ä½äº†åº”ç”¨çš„å®¹é”™æ€§ã€‚</p>
<blockquote>
<p>å½“ç„¶äº†ï¼Œç”Ÿäº§ç¯å¢ƒä¸­ç”¨çš„è¿˜æ˜¯ç›¸å¯¹è¾ƒå°‘å› ä¸ºæœ‰è¾ƒå°‘çš„éœ€æ±‚éœ€è¦å°†Podæ¥å›ºå®šåˆ°æŸäº›èŠ‚ç‚¹ä¸Šã€‚</p>
</blockquote>
<h3 id="åˆ›å»ºpersistentvolume">åˆ›å»ºPersistentVolume</h3>
<ol>
<li>å‡è®¾æˆ‘ä»¬ç°åœ¨åœ¨èŠ‚ç‚¹1ä¸Šæ–°å»ºä¸€ä¸ª<code>/data/hostPath/index.html</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-node1 ~<span class="o">]</span><span class="c1"># echo &#34;Hello This is new hostPath message.&#34; &gt;&gt; /data/hostPath/index.html</span>
</span></span></code></pre></div><ol>
<li>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªPvå¯¹è±¡</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">demo-hostpath</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w"> </span><span class="c"># å®šä¹‰è¯¥Pvçš„å®¹é‡ä¸º10Gb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">10Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">  </span><span class="c"># å®šä¹‰è¯¥Pvçš„è®¿é—®æ¨¡å¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/data/hostPath&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">type-ssd-sc</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>Capacityï¼ˆå­˜å‚¨èƒ½åŠ›ï¼‰ï¼šä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ª PV å¯¹è±¡éƒ½è¦æŒ‡å®šä¸€ä¸ªå­˜å‚¨èƒ½åŠ›ï¼Œé€šè¿‡ PV çš„ <code>capacity</code> å±æ€§æ¥è®¾ç½®çš„ï¼Œç›®å‰åªæ”¯æŒå­˜å‚¨ç©ºé—´çš„è®¾ç½®ï¼Œå°±æ˜¯æˆ‘ä»¬è¿™é‡Œçš„ <code>storage=10Gi</code>ï¼Œä¸è¿‡æœªæ¥å¯èƒ½ä¼šåŠ å…¥ <code>IOPS</code>ã€ååé‡ç­‰æŒ‡æ ‡çš„é…ç½®ã€‚</li>
<li>AccessModesï¼ˆè®¿é—®æ¨¡å¼ï¼‰ï¼šç”¨æ¥å¯¹ PV è¿›è¡Œè®¿é—®æ¨¡å¼çš„è®¾ç½®ï¼Œç”¨äºæè¿°ç”¨æˆ·åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™ï¼Œè®¿é—®æƒé™åŒ…æ‹¬ä¸‹é¢å‡ ç§æ–¹å¼ï¼š
<ul>
<li>ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½</li>
<li>ReadOnlyManyï¼ˆROXï¼‰ï¼šåªè¯»æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½</li>
<li>ReadWriteManyï¼ˆRWXï¼‰ï¼šè¯»å†™æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½</li>
</ul>
</li>
</ul>
<p>åˆ›å»ºå®ŒæˆåæŸ¥çœ‹ PersistentVolume çš„ä¿¡æ¯ï¼Œè¾“å‡ºç»“æœæ˜¾ç¤ºè¯¥ <code>PersistentVolume</code> çš„çŠ¶æ€ï¼ˆSTATUSï¼‰ ä¸º <code>Available</code>ã€‚ è¿™æ„å‘³ç€å®ƒè¿˜æ²¡æœ‰è¢«ç»‘å®šç»™ <code>PersistentVolumeClaim</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get pv</span>
</span></span><span class="line"><span class="cl">NAME            CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
</span></span><span class="line"><span class="cl">demo-hostpath   10Gi       RWO            Retain           Available           type-ssd-sc             13m
</span></span></code></pre></div><p>å…¶ä¸­æœ‰ä¸€é¡¹ <code>RECLAIM POLICY</code> çš„é…ç½®ï¼ŒåŒæ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡ PV çš„ <code>persistentVolumeReclaimPolicy</code>ï¼ˆå›æ”¶ç­–ç•¥ï¼‰å±æ€§æ¥è¿›è¡Œé…ç½®ï¼Œç›®å‰ PV æ”¯æŒçš„ç­–ç•¥æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>Retainï¼ˆä¿ç•™ï¼‰ï¼šå›æ”¶ç­–ç•¥ <code>Retain</code> ä½¿å¾—ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨å›æ”¶èµ„æºã€‚å½“ <code>PersistentVolumeClaim</code> å¯¹è±¡è¢«åˆ é™¤æ—¶ï¼Œ<code>PersistentVolume</code> å·ä»ç„¶å­˜åœ¨ï¼Œå¯¹åº”çš„æ•°æ®å·è¢«è§†ä¸º&quot;å·²é‡Šæ”¾ï¼ˆreleasedï¼‰&quot;ã€‚ ç”±äºå·ä¸Šä»ç„¶å­˜åœ¨è¿™å‰ä¸€ç”³é¢†äººçš„æ•°æ®ï¼Œè¯¥å·è¿˜ä¸èƒ½ç”¨äºå…¶ä»–ç”³é¢†ã€‚ ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ­¥éª¤æ¥æ‰‹åŠ¨å›æ”¶è¯¥å·ï¼š
<ul>
<li>åˆ é™¤ PersistentVolume å¯¹è±¡ã€‚ä¸ä¹‹ç›¸å…³çš„ã€ä½äºå¤–éƒ¨åŸºç¡€è®¾æ–½ä¸­çš„å­˜å‚¨èµ„äº§ ï¼ˆä¾‹å¦‚ AWS EBSã€GCE PDã€Azure Disk æˆ– Cinder å·ï¼‰åœ¨ PV åˆ é™¤ä¹‹åä»ç„¶å­˜åœ¨ã€‚</li>
<li>æ ¹æ®æƒ…å†µï¼Œæ‰‹åŠ¨æ¸…é™¤æ‰€å…³è”çš„å­˜å‚¨èµ„äº§ä¸Šçš„æ•°æ®ã€‚</li>
<li>æ‰‹åŠ¨åˆ é™¤æ‰€å…³è”çš„å­˜å‚¨èµ„äº§ã€‚</li>
</ul>
</li>
<li>Recycleï¼ˆå›æ”¶ï¼‰ï¼šå›æ”¶ç­–ç•¥ <code>Recycle</code> å·²è¢«åºŸå¼ƒã€‚å–è€Œä»£ä¹‹çš„å»ºè®®æ–¹æ¡ˆæ˜¯ä½¿ç”¨åŠ¨æ€åˆ¶å¤‡ã€‚å¦‚æœä¸‹å±‚çš„å·æ’ä»¶æ”¯æŒï¼Œå›æ”¶ç­–ç•¥ <code>Recycle</code> ä¼šåœ¨å·ä¸Šæ‰§è¡Œä¸€äº›åŸºæœ¬çš„æ“¦é™¤ ï¼ˆ<code>rm -rf /thevolume/*</code>ï¼‰æ“ä½œï¼Œä¹‹åå…è®¸è¯¥å·ç”¨äºæ–°çš„ PVC ç”³é¢†ã€‚</li>
<li>Deleteï¼ˆåˆ é™¤ï¼‰ï¼šå¯¹äºæ”¯æŒ <code>Delete</code> å›æ”¶ç­–ç•¥çš„å·æ’ä»¶ï¼Œåˆ é™¤åŠ¨ä½œä¼šå°† <code>PersistentVolume</code> å¯¹è±¡ä» Kubernetes ä¸­ç§»é™¤ï¼ŒåŒæ—¶ä¹Ÿä¼šä»å¤–éƒ¨åŸºç¡€è®¾æ–½ï¼ˆå¦‚ AWS EBSã€GCE PDã€Azure Disk æˆ– Cinder å·ï¼‰ä¸­ç§»é™¤æ‰€å…³è”çš„å­˜å‚¨èµ„äº§ã€‚</li>
</ul>
<p>ç›®å‰ï¼Œä»… NFS å’Œ HostPath æ”¯æŒå›æ”¶ï¼ˆRecycleï¼‰ã€‚ AWS EBSã€GCE PDã€Azure Disk å’Œ Cinder å·éƒ½æ”¯æŒåˆ é™¤ï¼ˆDeleteï¼‰ã€‚</p>
<blockquote>
<p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›®å‰åªæœ‰ <code>NFS</code> å’Œ <code>HostPath</code> ä¸¤ç§ç±»å‹æ”¯æŒå›æ”¶ç­–ç•¥ï¼Œå½“ç„¶ä¸€èˆ¬æ¥è¯´è¿˜æ˜¯è®¾ç½®ä¸º <code>Retain</code> è¿™ç§ç­–ç•¥ä¿é™©ä¸€ç‚¹ã€‚</p>
</blockquote>
<p>å…³äº PV çš„çŠ¶æ€ï¼Œå®é™…ä¸Šæè¿°çš„æ˜¯ PV çš„ç”Ÿå‘½å‘¨æœŸçš„æŸä¸ªé˜¶æ®µï¼Œä¸€ä¸ª PV çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¯èƒ½ä¼šå¤„äº4ç§ä¸åŒçš„é˜¶æ®µï¼š</p>
<ul>
<li>Availableï¼ˆå¯ç”¨ï¼‰ï¼šè¡¨ç¤ºå¯ç”¨çŠ¶æ€ï¼Œè¿˜æœªè¢«ä»»ä½• PVC ç»‘å®š</li>
<li>Boundï¼ˆå·²ç»‘å®šï¼‰ï¼šè¡¨ç¤º PVC å·²ç»è¢« PVC ç»‘å®š</li>
<li>Releasedï¼ˆå·²é‡Šæ”¾ï¼‰ï¼šPVC è¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºè¿˜æœªè¢«é›†ç¾¤é‡æ–°å£°æ˜</li>
<li>Failedï¼ˆå¤±è´¥ï¼‰ï¼š è¡¨ç¤ºè¯¥ PV çš„è‡ªåŠ¨å›æ”¶å¤±è´¥</li>
</ul>
<h3 id="åˆ›å»ºpersistentvolumeclaim">åˆ›å»ºPersistentVolumeClaim</h3>
<p>å¦‚æœæˆ‘ä»¬éœ€è¦ä½¿ç”¨è¿™ä¸ª PV çš„è¯ï¼Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ PVC æ¥å’Œä»–è¿›è¡Œç»‘å®šäº†ï¼Œå°±ç±»ä¼¼äºæˆ‘ä»¬çš„æœåŠ¡æ˜¯é€šè¿‡ Pod æ¥è¿è¡Œçš„ï¼Œè€Œä¸æ˜¯ Nodeï¼Œåªæ˜¯ Pod è·‘åœ¨ Node ä¸Šè€Œå·²ã€‚</p>
<p>è®©æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªä½¿ç”¨3Gç©ºé—´çš„<code>PersistentVolumeClaim</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">task-pv-claim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">3Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">type-ssd-sc</span><span class="w">
</span></span></span></code></pre></div><p>åˆ›å»º <code>PersistentVolumeClaim</code> ä¹‹åï¼ŒKubernetes æ§åˆ¶å¹³é¢å°†æŸ¥æ‰¾æ»¡è¶³ç”³é¢†è¦æ±‚çš„ <code>PersistentVolume</code>ã€‚ å¦‚æœæ§åˆ¶å¹³é¢æ‰¾åˆ°å…·æœ‰ç›¸åŒ <code>StorageClass</code> çš„é€‚å½“çš„ <code>PersistentVolume</code>ï¼Œ åˆ™å°† <code>PersistentVolumeClaim</code> ç»‘å®šåˆ°è¯¥ <code>PersistentVolume</code> ä¸Šã€‚æ‰€ä»¥å†æ¬¡<code>kubectl get pv</code>çš„<code>PersistentVolume</code>çŠ¶æ€åº”è¯¥å±äº<code>Bound</code>çŠ¶æ€ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 yaml<span class="o">]</span><span class="c1"># kubectl get pv</span>
</span></span><span class="line"><span class="cl">NAME            CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                   STORAGECLASS   REASON   AGE
</span></span><span class="line"><span class="cl">demo-hostpath   10Gi       RWO            Retain           Bound    default/task-pv-claim   type-ssd-sc             47m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 yaml<span class="o">]</span><span class="c1"># kubectl get pvc</span>
</span></span><span class="line"><span class="cl">NAME            STATUS   VOLUME          CAPACITY   ACCESS MODES   STORAGECLASS   AGE
</span></span><span class="line"><span class="cl">task-pv-claim   Bound    demo-hostpath   10Gi       RWO            type-ssd-sc    18m
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°å·²ç»ç»‘å®šåˆ°äº†ä¸€ä¸ª<code>Volume</code>å«åš<code>demo-hostpath</code>çš„<code>PersistentVolume</code></p>
<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ç›®å‰<code>PersistentVolume</code>å’Œ<code>PersistentVolumeClaim</code>ä¹‹é—´æ˜¯ä¸€å¯¹ä¸€ç»‘å®šçš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ª<code>PersistentVolume</code>åªèƒ½è¢«ä¸€ä¸ª<code>PersistentVolumeClaim</code>ç»‘å®šã€‚</p>
</blockquote>
<h3 id="åˆ›å»ºä¸€ä¸ªdeployment">åˆ›å»ºä¸€ä¸ªDeployment</h3>
<p>åˆ›å»ºä¸€ä¸ª<code>deployment</code>ç„¶åç»‘å®š<code>PersistentVolumeClaim</code>ç´§æ¥ç€å›ºå®šèŠ‚ç‚¹åˆ°<code>online-beijing-node1</code></p>
<pre tabindex="0"><code>---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    k8s.kuboard.cn/name: task-nginx-demo
  name: task-nginx-demo
  namespace: default
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      k8s.kuboard.cn/name: task-nginx-demo
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        k8s.kuboard.cn/name: task-nginx-demo
    nodeSelector:
      kubernetes.io/hostname: online-beijing-node1
    spec:
      containers:
        - image: &#39;nginx:latest&#39;
          imagePullPolicy: Always
          name: task-nginx-demo
          ports:
            - containerPort: 80
              hostPort: 80
              name: http
              protocol: TCP
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: &#34;/usr/share/nginx/html&#34;
            name: task-hostpath-volume
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:
      - name: task-hostpath-volume
        persistentVolumeClaim:
          claimName: task-pv-claim
</code></pre><p>å½“è¿™ä¸ª<code>deployment</code>åˆ›å»ºå®Œæˆä»¥åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¿é—®<code>service</code>æµ‹è¯•ä¸€ä¸‹.</p>
<p>æ­£å¸¸æƒ…å†µä¸‹ä½ å¯ä»¥çœ‹åˆ°<code>Hello This is new hostPath message.</code>è¿™æ¡ä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="p">[</span><span class="l">root@Online-Beijing-master1 yaml]# curl -v 10.10.56.102</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">* Rebuilt URL to</span><span class="p">:</span><span class="w"> </span><span class="m">10.10.56.102</span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>*<span class="w">   </span><span class="l">Trying 10.10.56.102...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>*<span class="w"> </span><span class="l">TCP_NODELAY set</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>*<span class="w"> </span><span class="l">Connected to 10.10.56.102 (10.10.56.102) port 80 (#0)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">&gt; GET / HTTP/1.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&gt; Host</span><span class="p">:</span><span class="w"> </span><span class="m">10.10.56.102</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&gt; User-Agent</span><span class="p">:</span><span class="w"> </span><span class="l">curl/7.61.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&gt; Accept</span><span class="p">:</span><span class="w"> </span><span class="cp">*/*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">&gt; </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">&lt; HTTP/1.1 200 OK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Server</span><span class="p">:</span><span class="w"> </span><span class="l">nginx/1.23.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Date</span><span class="p">:</span><span class="w"> </span><span class="l">Wed, 22 Mar 2023 09:54:49 GMT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Content-Type</span><span class="p">:</span><span class="w"> </span><span class="l">text/html</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Content-Length</span><span class="p">:</span><span class="w"> </span><span class="m">36</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Last-Modified</span><span class="p">:</span><span class="w"> </span><span class="l">Wed, 22 Mar 2023 07:53:15 GMT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Connection</span><span class="p">:</span><span class="w"> </span><span class="l">keep-alive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; ETag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;641ab3eb-24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Accept-Ranges</span><span class="p">:</span><span class="w"> </span><span class="l">bytes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">Hello This is new hostPath message.</span><span class="w">
</span></span></span></code></pre></div><p>è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬ä¸€ä¸ªå¾ˆç®€å•çš„åŸºäº<code>hostPath</code>æ¥æŒä¹…åŒ–æ•°æ®ä½¿ç”¨<code>PersistentVolume</code>å’Œ<code>PersistentVolumeClaim</code>ç®€å•æ•™å­¦ã€‚</p>
<h2 id="local-persistentvolume">Local PersistentVolume</h2>
<p>ä¸Šé¢æˆ‘ä»¬åˆ›å»ºäº†åç«¯æ˜¯ <code>hostPath</code> ç±»å‹çš„ PV èµ„æºå¯¹è±¡,é‚£ä¹ˆä¸ªäººè®¤ä¸º<code>hostPath</code>çš„ç¼ºç‚¹åœ¨äº</p>
<ol>
<li>
<p>Podä¸èƒ½è¿›è¡Œéšæ—¶éšåœ°çš„èŠ‚ç‚¹æ›´æ¢,å¦‚æœæ›´æ¢åˆ™ä¼šå‡ºç°ä¸¢å¤±æ•°æ®çš„ç°è±¡ã€‚</p>
<p>éœ€è¦æ¯æ¬¡éƒ½æ­é…<code>nodeSelector</code>è¿›è¡Œä½¿ç”¨ã€‚</p>
</li>
</ol>
<p>å…¶ä¼˜ç‚¹ä¹Ÿæ˜¯ç›¸å¯¹äºæ¯”è¾ƒæ˜æ˜¾</p>
<ol>
<li>å› ä¸º<code>hostPath</code>ä½¿ç”¨çš„æ˜¯æœ¬åœ°ç£ç›˜,å¯ä»¥å……åˆ†çš„åˆ©ç”¨ç£ç›˜çš„è¯»å†™æ€§èƒ½ã€‚</li>
</ol>
<hr>
<p>æ‰€ä»¥åœ¨ hostPath çš„åŸºç¡€ä¸Šï¼ŒKubernetes ä¾é  PVã€PVC å®ç°äº†ä¸€ä¸ªæ–°çš„ç‰¹æ€§ï¼Œè¿™ä¸ªç‰¹æ€§çš„åå­—å«ä½œï¼š<code>Local Persistent Volume</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ <code>Local PV</code>ã€‚</p>
<p><code>local</code> å·åªèƒ½ç”¨ä½œé™æ€åˆ›å»ºçš„æŒä¹…å·ã€‚ä¸æ”¯æŒåŠ¨æ€é…ç½®ã€‚</p>
<p>ç„¶è€Œï¼Œ<code>local</code> å·ä»ç„¶å–å†³äºåº•å±‚èŠ‚ç‚¹çš„å¯ç”¨æ€§ï¼Œå¹¶ä¸é€‚åˆæ‰€æœ‰åº”ç”¨ç¨‹åºã€‚ å¦‚æœèŠ‚ç‚¹å˜å¾—ä¸å¥åº·ï¼Œé‚£ä¹ˆ <code>local</code> å·ä¹Ÿå°†å˜å¾—ä¸å¯è¢« Pod è®¿é—®ã€‚ä½¿ç”¨å®ƒçš„ Pod å°†ä¸èƒ½è¿è¡Œã€‚ ä½¿ç”¨ <code>local</code> å·çš„åº”ç”¨ç¨‹åºå¿…é¡»èƒ½å¤Ÿå®¹å¿è¿™ç§å¯ç”¨æ€§çš„é™ä½ï¼Œä»¥åŠå› åº•å±‚ç£ç›˜çš„è€ç”¨æ€§ç‰¹å¾è€Œå¸¦æ¥çš„æ½œåœ¨çš„æ•°æ®ä¸¢å¤±é£é™©ã€‚</p>
<h3 id="å®ƒä¸hostpathæœ‰ä½•ä¸åŒ">å®ƒä¸HostPathæœ‰ä½•ä¸åŒï¼Ÿ</h3>
<p>ä¸ºäº†æ›´å¥½åœ°ç†è§£æœ¬åœ°æŒä¹…å·çš„ä¼˜åŠ¿ï¼Œå°†å…¶ä¸<a class="link" href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath"  target="_blank" rel="noopener"
    >HostPath å·</a>è¿›è¡Œæ¯”è¾ƒå¾ˆæœ‰ç”¨ã€‚<code>HostPath</code> å·å°†ä¸»æœºèŠ‚ç‚¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æˆ–ç›®å½•æŒ‚è½½åˆ° Pod ä¸­ã€‚ç±»ä¼¼åœ°ï¼Œ<code>Local Persistent Volume</code> å°†æœ¬åœ°ç£ç›˜æˆ–åˆ†åŒºæŒ‚è½½åˆ° Pod ä¸­</p>
<p>æœ€å¤§çš„åŒºåˆ«æ˜¯ Kubernetes è°ƒåº¦ç¨‹åºäº†è§£æœ¬åœ°æŒä¹…å·å±äºå“ªä¸ªèŠ‚ç‚¹ã€‚å¯¹äº HostPath å·ï¼Œå¼•ç”¨ HostPath å·çš„ pod å¯èƒ½ä¼šè¢«è°ƒåº¦ç¨‹åºç§»åŠ¨åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ä½†æ˜¯å¯¹äº <code>Local Persistent Volumes</code>ï¼ŒKubernetes è°ƒåº¦å™¨ç¡®ä¿ä½¿ç”¨ <code>Local Persistent Volume</code> çš„ pod æ€»æ˜¯è¢«è°ƒåº¦åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>è™½ç„¶ HostPath å·å¯ä»¥é€šè¿‡ <code>Persistent Volume Claim (PVC)</code> å¼•ç”¨æˆ–ç›´æ¥å†…åµŒåœ¨ pod å®šä¹‰ä¸­ï¼Œä½† <code>Local Persistent Volumes</code> åªèƒ½é€šè¿‡ PVC å¼•ç”¨ã€‚è¿™æä¾›äº†é¢å¤–çš„å®‰å…¨ä¼˜åŠ¿ï¼Œå› ä¸º <code>Persistent Volume</code> å¯¹è±¡ç”±ç®¡ç†å‘˜ç®¡ç†ï¼Œé˜²æ­¢ Pod èƒ½å¤Ÿè®¿é—®ä¸»æœºä¸Šçš„ä»»ä½•è·¯å¾„ã€‚</p>
<blockquote>
<p>æ‰€ä»¥ï¼Œä¸€èˆ¬æ¥è¯´ <code>Local PV</code> å¯¹åº”çš„å­˜å‚¨ä»‹è´¨æ˜¯ä¸€å—é¢å¤–æŒ‚è½½åœ¨å®¿ä¸»æœºçš„ç£ç›˜æˆ–è€…å—è®¾å¤‡ã€‚</p>
</blockquote>
<h3 id="åˆ›å»ºä¸€ä¸ªlocalæŒä¹…å·å®ä¾‹">åˆ›å»ºä¸€ä¸ªLocalæŒä¹…å·å®ä¾‹</h3>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ <code>local</code> å·å’Œ <code>nodeAffinity</code> çš„æŒä¹…å·ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">20Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">local-storage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/mnt/disks/ssd1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">required</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/hostname</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">online-beijing-node1</span><span class="w">
</span></span></span></code></pre></div><p>ä½¿ç”¨ <code>local</code> å·æ—¶ï¼Œä½ éœ€è¦è®¾ç½® <code>PersistentVolume</code> å¯¹è±¡çš„ <code>nodeAffinity</code> å­—æ®µã€‚ Kubernetes è°ƒåº¦ï¨¸ä½¿ç”¨ <code>PersistentVolume</code> çš„ <code>nodeAffinity</code> ä¿¡æ¯æ¥å°†ä½¿ç”¨ <code>local</code> å·çš„ Pod è°ƒåº¦åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ã€‚</p>
<p>å½“ç„¶äº†,è¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœä½ çš„Podæƒ³ä½¿ç”¨è¿™ä¸ª<code>PV</code>çš„è¯,é‚£ä¹ˆå°±åªèƒ½è¿è¡Œåœ¨<code>online-beijing-node1</code>è¿™ä¸ªèŠ‚ç‚¹ä¸Šã€‚è¿™æ ·ï¼Œè°ƒåº¦å™¨åœ¨è°ƒåº¦ Pod çš„æ—¶å€™ï¼Œå°±èƒ½å¤ŸçŸ¥é“ä¸€ä¸ª PV ä¸èŠ‚ç‚¹çš„å¯¹åº”å…³ç³»ï¼Œä»è€Œåšå‡ºæ­£ç¡®çš„é€‰æ‹©ã€‚</p>
<p><strong>ç»‘å®šPersistentVolumeClaim</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">bound-tasknginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">local-storage</span><span class="w">
</span></span></span></code></pre></div><p>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªPodæ¥ç»‘å®šè¿™ä¸ªPvc,ç„¶åå¯ä»¥é€šè¿‡è®¿é—®<code>Pod</code>çš„<code>IP</code>åœ°å€è¿›è¡ŒéªŒè¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv-local-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-pv-local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">bound-tasknginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-pv-local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-pv-local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">root@Online-Beijing-master1 yaml]# curl -v 10.10.38.225 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">* Rebuilt URL to</span><span class="p">:</span><span class="w"> </span><span class="m">10.10.38.225</span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>*<span class="w">   </span><span class="l">Trying 10.10.38.225...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>*<span class="w"> </span><span class="l">TCP_NODELAY set</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>*<span class="w"> </span><span class="l">Connected to 10.10.38.225 (10.10.38.225) port 80 (#0)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">&gt; GET / HTTP/1.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&gt; Host</span><span class="p">:</span><span class="w"> </span><span class="m">10.10.38.225</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&gt; User-Agent</span><span class="p">:</span><span class="w"> </span><span class="l">curl/7.61.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&gt; Accept</span><span class="p">:</span><span class="w"> </span><span class="cp">*/*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">&gt; </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">&lt; HTTP/1.1 200 OK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Server</span><span class="p">:</span><span class="w"> </span><span class="l">nginx/1.23.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Date</span><span class="p">:</span><span class="w"> </span><span class="l">Thu, 23 Mar 2023 08:45:18 GMT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Content-Type</span><span class="p">:</span><span class="w"> </span><span class="l">text/html</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Content-Length</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Last-Modified</span><span class="p">:</span><span class="w"> </span><span class="l">Thu, 23 Mar 2023 08:43:41 GMT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Connection</span><span class="p">:</span><span class="w"> </span><span class="l">keep-alive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; ETag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;641c113d-19&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">&lt; Accept-Ranges</span><span class="p">:</span><span class="w"> </span><span class="l">bytes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">&lt; </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Date</span><span class="p">:</span><span class="w"> </span><span class="ld">2023-03-23</span><span class="w"> </span><span class="l">LocalPv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>*<span class="w"> </span><span class="l">Connection</span><span class="w"> </span><span class="c">#0 to host 10.10.38.225 left intact</span><span class="w">
</span></span></span></code></pre></div><p>å½“ç„¶äº†ä½ ä¹Ÿå¯ä»¥è¿›å…¥åˆ°<code>Pod</code>å½“ä¸­æŸ¥çœ‹æ˜¯å¦æˆåŠŸ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 yaml<span class="o">]</span><span class="c1"># kubectl exec -it pv-local-pod /bin/bash</span>
</span></span><span class="line"><span class="cl">root@pv-local-pod:/usr/share/nginx/html# <span class="nb">cd</span> /usr/share/nginx/html/
</span></span><span class="line"><span class="cl">root@pv-local-pod:/usr/share/nginx/html# cat index.html 
</span></span><span class="line"><span class="cl">Date: 2023-03-23 LocalPv
</span></span></code></pre></div><h2 id="åˆ é™¤é™æ€ç®¡ç†çš„æŒä¹…åŒ–å­˜å‚¨">åˆ é™¤é™æ€ç®¡ç†çš„æŒä¹…åŒ–å­˜å‚¨</h2>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸Šé¢æ‰‹åŠ¨åˆ›å»º<code>PersistentVolume</code>çš„æ–¹å¼ï¼Œå³é™æ€çš„<code>PersistentVolume</code>ç®¡ç†æ–¹å¼ï¼Œåœ¨åˆ é™¤<code>PersistentVolume</code>æ—¶éœ€è¦æŒ‰å¦‚ä¸‹æµç¨‹æ‰§è¡Œæ“ä½œã€‚</p>
<ol>
<li>åˆ é™¤ä½¿ç”¨è¿™ä¸ª<code>PersistentVolume</code>çš„ Pod</li>
<li>ä»å®¿ä¸»æœºç§»é™¤æœ¬åœ°ç£ç›˜</li>
<li>åˆ é™¤<code>PersistentVolumeClaim</code></li>
<li>åˆ é™¤<code>PersistentVolume</code></li>
</ol>
]]></content:encoded>
    </item>
    <item>
      <title>Ingressçš„ç®€å•ä½¿ç”¨</title>
      <link>https://blog.mletter.cn/tech/kubernetes/nginx-ingress/</link>
      <pubDate>Wed, 08 Mar 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/nginx-ingress/</guid>
      <description>&lt;h1 id=&#34;ä»€ä¹ˆæ˜¯ingress&#34;&gt;ä»€ä¹ˆæ˜¯Ingress&lt;/h1&gt;
&lt;p&gt;Ingress æ˜¯å¯¹é›†ç¾¤ä¸­æœåŠ¡çš„å¤–éƒ¨è®¿é—®è¿›è¡Œç®¡ç†çš„ API å¯¹è±¡ï¼Œå…¸å‹çš„è®¿é—®æ–¹å¼æ˜¯ HTTPã€‚&lt;/p&gt;
&lt;p&gt;Ingress å¯ä»¥æä¾›è´Ÿè½½å‡è¡¡ã€SSL ç»ˆç»“å’ŒåŸºäºåç§°çš„è™šæ‹Ÿæ‰˜ç®¡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#ingress-v1-networking-k8s-io&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Ingress&lt;/a&gt; å…¬å¼€ä»é›†ç¾¤å¤–éƒ¨åˆ°é›†ç¾¤å†…&lt;a class=&#34;link&#34; href=&#34;https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;æœåŠ¡&lt;/a&gt;çš„ HTTP å’Œ HTTPS è·¯ç”±ã€‚ æµé‡è·¯ç”±ç”± Ingress èµ„æºä¸Šå®šä¹‰çš„è§„åˆ™æ§åˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æ˜¯ä¸€ä¸ªå°†æ‰€æœ‰æµé‡éƒ½å‘é€åˆ°åŒä¸€ Service çš„ç®€å• Ingress ç¤ºä¾‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img style=&#34;max-width: 100%; height: auto;&#34; loading=&#34;lazy&#34; alt=&#34;img&#34; loading=&#34;lazy&#34; src=&#34;https://d33wubrfki0l68.cloudfront.net/4f01eaec32889ff16ee255e97822b6d165b633f0/a54b4/zh-cn/docs/images/ingress.svg&#34;&gt;&lt;/p&gt;
&lt;p&gt;Ingress å…¶å®å°±æ˜¯ä» Kuberenets é›†ç¾¤å¤–éƒ¨è®¿é—®é›†ç¾¤çš„ä¸€ä¸ªå…¥å£ï¼Œå°†å¤–éƒ¨çš„è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤å†…ä¸åŒçš„ Service ä¸Šï¼Œå…¶å®å°±ç›¸å½“äº nginxã€haproxy ç­‰è´Ÿè½½å‡è¡¡ä»£ç†æœåŠ¡å™¨ï¼Œå¯èƒ½ä½ ä¼šè§‰å¾—æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ nginx å°±å®ç°äº†ï¼Œä½†æ˜¯åªä½¿ç”¨ nginx è¿™ç§æ–¹å¼æœ‰å¾ˆå¤§ç¼ºé™·ï¼Œæ¯æ¬¡æœ‰æ–°æœåŠ¡åŠ å…¥çš„æ—¶å€™æ€ä¹ˆæ”¹ Nginx é…ç½®ï¼Ÿä¸å¯èƒ½è®©æˆ‘ä»¬å»æ‰‹åŠ¨æ›´æ”¹æˆ–è€…æ»šåŠ¨æ›´æ–°å‰ç«¯çš„ Nginx Pod å§ï¼Ÿé‚£æˆ‘ä»¬å†åŠ ä¸Šä¸€ä¸ªæœåŠ¡å‘ç°çš„å·¥å…·æ¯”å¦‚ consul å¦‚ä½•ï¼Ÿè²Œä¼¼æ˜¯å¯ä»¥ï¼Œå¯¹å§ï¼ŸIngress å®é™…ä¸Šå°±æ˜¯è¿™æ ·å®ç°çš„ï¼Œåªæ˜¯æœåŠ¡å‘ç°çš„åŠŸèƒ½è‡ªå·±å®ç°äº†ï¼Œä¸éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„æœåŠ¡äº†ï¼Œç„¶åå†åŠ ä¸Šä¸€ä¸ªåŸŸåè§„åˆ™å®šä¹‰ï¼Œè·¯ç”±ä¿¡æ¯çš„åˆ·æ–°ä¾é  Ingress Controller æ¥æä¾›ã€‚&lt;/p&gt;
&lt;p&gt;Ingress Controller å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªç›‘å¬å™¨ï¼Œé€šè¿‡ä¸æ–­åœ°ç›‘å¬ kube-apiserverï¼Œå®æ—¶çš„æ„ŸçŸ¥åç«¯ Serviceã€Pod çš„å˜åŒ–ï¼Œå½“å¾—åˆ°è¿™äº›ä¿¡æ¯å˜åŒ–åï¼ŒIngress Controller å†ç»“åˆ Ingress çš„é…ç½®ï¼Œæ›´æ–°åå‘ä»£ç†è´Ÿè½½å‡è¡¡å™¨ï¼Œè¾¾åˆ°æœåŠ¡å‘ç°çš„ä½œç”¨ã€‚å…¶å®è¿™ç‚¹å’ŒæœåŠ¡å‘ç°å·¥å…· consulã€ consul-template éå¸¸ç±»ä¼¼ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ç°åœ¨å¯ä»¥ä¾›å¤§å®¶ä½¿ç”¨çš„ Ingress Controller æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ &lt;code&gt;traefik&lt;/code&gt;ã€&lt;code&gt;nginx-controller&lt;/code&gt;ã€&lt;code&gt;Kubernetes Ingress Controller&lt;/code&gt; for Kongã€&lt;code&gt;HAProxy Ingress controller&lt;/code&gt;ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ª Ingress Controllerï¼Œç°åœ¨æ™®éç”¨å¾—è¾ƒå¤šçš„æ˜¯ traefik å’Œ nginx-controllerï¼Œtraefik çš„æ€§èƒ½è¾ƒ nginx-controller å·®ï¼Œä½†æ˜¯é…ç½®ä½¿ç”¨è¦ç®€å•è®¸å¤šï¼Œæˆ‘ä»¬è¿™é‡Œä¼šé‡ç‚¹ç»™å¤§å®¶ä»‹ç» nginx-controller ä»¥åŠ traefik çš„ä½¿ç”¨ã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯ingress">ä»€ä¹ˆæ˜¯Ingress</h1>
<p>Ingress æ˜¯å¯¹é›†ç¾¤ä¸­æœåŠ¡çš„å¤–éƒ¨è®¿é—®è¿›è¡Œç®¡ç†çš„ API å¯¹è±¡ï¼Œå…¸å‹çš„è®¿é—®æ–¹å¼æ˜¯ HTTPã€‚</p>
<p>Ingress å¯ä»¥æä¾›è´Ÿè½½å‡è¡¡ã€SSL ç»ˆç»“å’ŒåŸºäºåç§°çš„è™šæ‹Ÿæ‰˜ç®¡ã€‚</p>
<p><a class="link" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#ingress-v1-networking-k8s-io"  target="_blank" rel="noopener"
    >Ingress</a> å…¬å¼€ä»é›†ç¾¤å¤–éƒ¨åˆ°é›†ç¾¤å†…<a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/"  target="_blank" rel="noopener"
    >æœåŠ¡</a>çš„ HTTP å’Œ HTTPS è·¯ç”±ã€‚ æµé‡è·¯ç”±ç”± Ingress èµ„æºä¸Šå®šä¹‰çš„è§„åˆ™æ§åˆ¶ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå°†æ‰€æœ‰æµé‡éƒ½å‘é€åˆ°åŒä¸€ Service çš„ç®€å• Ingress ç¤ºä¾‹ï¼š</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="img" loading="lazy" src="https://d33wubrfki0l68.cloudfront.net/4f01eaec32889ff16ee255e97822b6d165b633f0/a54b4/zh-cn/docs/images/ingress.svg"></p>
<p>Ingress å…¶å®å°±æ˜¯ä» Kuberenets é›†ç¾¤å¤–éƒ¨è®¿é—®é›†ç¾¤çš„ä¸€ä¸ªå…¥å£ï¼Œå°†å¤–éƒ¨çš„è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤å†…ä¸åŒçš„ Service ä¸Šï¼Œå…¶å®å°±ç›¸å½“äº nginxã€haproxy ç­‰è´Ÿè½½å‡è¡¡ä»£ç†æœåŠ¡å™¨ï¼Œå¯èƒ½ä½ ä¼šè§‰å¾—æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ nginx å°±å®ç°äº†ï¼Œä½†æ˜¯åªä½¿ç”¨ nginx è¿™ç§æ–¹å¼æœ‰å¾ˆå¤§ç¼ºé™·ï¼Œæ¯æ¬¡æœ‰æ–°æœåŠ¡åŠ å…¥çš„æ—¶å€™æ€ä¹ˆæ”¹ Nginx é…ç½®ï¼Ÿä¸å¯èƒ½è®©æˆ‘ä»¬å»æ‰‹åŠ¨æ›´æ”¹æˆ–è€…æ»šåŠ¨æ›´æ–°å‰ç«¯çš„ Nginx Pod å§ï¼Ÿé‚£æˆ‘ä»¬å†åŠ ä¸Šä¸€ä¸ªæœåŠ¡å‘ç°çš„å·¥å…·æ¯”å¦‚ consul å¦‚ä½•ï¼Ÿè²Œä¼¼æ˜¯å¯ä»¥ï¼Œå¯¹å§ï¼ŸIngress å®é™…ä¸Šå°±æ˜¯è¿™æ ·å®ç°çš„ï¼Œåªæ˜¯æœåŠ¡å‘ç°çš„åŠŸèƒ½è‡ªå·±å®ç°äº†ï¼Œä¸éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„æœåŠ¡äº†ï¼Œç„¶åå†åŠ ä¸Šä¸€ä¸ªåŸŸåè§„åˆ™å®šä¹‰ï¼Œè·¯ç”±ä¿¡æ¯çš„åˆ·æ–°ä¾é  Ingress Controller æ¥æä¾›ã€‚</p>
<p>Ingress Controller å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªç›‘å¬å™¨ï¼Œé€šè¿‡ä¸æ–­åœ°ç›‘å¬ kube-apiserverï¼Œå®æ—¶çš„æ„ŸçŸ¥åç«¯ Serviceã€Pod çš„å˜åŒ–ï¼Œå½“å¾—åˆ°è¿™äº›ä¿¡æ¯å˜åŒ–åï¼ŒIngress Controller å†ç»“åˆ Ingress çš„é…ç½®ï¼Œæ›´æ–°åå‘ä»£ç†è´Ÿè½½å‡è¡¡å™¨ï¼Œè¾¾åˆ°æœåŠ¡å‘ç°çš„ä½œç”¨ã€‚å…¶å®è¿™ç‚¹å’ŒæœåŠ¡å‘ç°å·¥å…· consulã€ consul-template éå¸¸ç±»ä¼¼ã€‚</p>
<blockquote>
<p>ç°åœ¨å¯ä»¥ä¾›å¤§å®¶ä½¿ç”¨çš„ Ingress Controller æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ <code>traefik</code>ã€<code>nginx-controller</code>ã€<code>Kubernetes Ingress Controller</code> for Kongã€<code>HAProxy Ingress controller</code>ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ª Ingress Controllerï¼Œç°åœ¨æ™®éç”¨å¾—è¾ƒå¤šçš„æ˜¯ traefik å’Œ nginx-controllerï¼Œtraefik çš„æ€§èƒ½è¾ƒ nginx-controller å·®ï¼Œä½†æ˜¯é…ç½®ä½¿ç”¨è¦ç®€å•è®¸å¤šï¼Œæˆ‘ä»¬è¿™é‡Œä¼šé‡ç‚¹ç»™å¤§å®¶ä»‹ç» nginx-controller ä»¥åŠ traefik çš„ä½¿ç”¨ã€‚</p>
</blockquote>
<h2 id="å®‰è£…nginx-ingress-controller">å®‰è£…NGINX Ingress Controller</h2>
<ul>
<li>å®˜æ–¹æ–‡æ¡£ï¼š<a class="link" href="https://kubernetes.github.io/ingress-nginx/"  target="_blank" rel="noopener"
    >NGINX Ingress Controller</a></li>
</ul>
<p>NGINX Ingress Controller æ˜¯ä½¿ç”¨ Kubernetes Ingress èµ„æºå¯¹è±¡æ„å»ºçš„ï¼Œç”¨ ConfigMap æ¥å­˜å‚¨ Nginx é…ç½®çš„ä¸€ç§ Ingress Controller å®ç°ã€‚</p>
<p>ç”±äº nginx-ingress æ‰€åœ¨çš„èŠ‚ç‚¹éœ€è¦èƒ½å¤Ÿè®¿é—®å¤–ç½‘ï¼Œè¿™æ ·åŸŸåå¯ä»¥è§£æåˆ°è¿™äº›èŠ‚ç‚¹ä¸Šç›´æ¥ä½¿ç”¨ï¼Œæ‰€ä»¥éœ€è¦è®© nginx-ingress ç»‘å®šèŠ‚ç‚¹çš„ 80 å’Œ 443 ç«¯å£ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ hostPort æ¥è¿›è¡Œè®¿é—®ã€‚</p>
<p><strong>æŸ¥çœ‹å½“å‰Ingress-Nginxé€‚ç”¨çš„kubernetesç‰ˆæœ¬</strong></p>
<table>
  <thead>
      <tr>
          <th>Ingress-NGINX version</th>
          <th>k8s supported version</th>
          <th>Alpine Version</th>
          <th>Nginx Version</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>v1.6.4</td>
          <td>1.26, 1.25, 1.24, 1.23</td>
          <td>3.17.0</td>
          <td>1.21.6</td>
      </tr>
      <tr>
          <td>v1.5.1</td>
          <td>1.25, 1.24, 1.23</td>
          <td>3.16.2</td>
          <td>1.21.6</td>
      </tr>
      <tr>
          <td>v1.4.0</td>
          <td>1.25, 1.24, 1.23, 1.22</td>
          <td>3.16.2</td>
          <td>1.19.10â€ </td>
      </tr>
      <tr>
          <td>v1.3.1</td>
          <td>1.24, 1.23, 1.22, 1.21, 1.20</td>
          <td>3.16.2</td>
          <td>1.19.10â€ </td>
      </tr>
      <tr>
          <td>v1.3.0</td>
          <td>1.24, 1.23, 1.22, 1.21, 1.20</td>
          <td>3.16.0</td>
          <td>1.19.10â€ </td>
      </tr>
      <tr>
          <td>v1.2.1</td>
          <td>1.23, 1.22, 1.21, 1.20, 1.19</td>
          <td>3.14.6</td>
          <td>1.19.10â€ </td>
      </tr>
      <tr>
          <td>v1.1.3</td>
          <td>1.23, 1.22, 1.21, 1.20, 1.19</td>
          <td>3.14.4</td>
          <td>1.19.10â€ </td>
      </tr>
      <tr>
          <td>v1.1.2</td>
          <td>1.23, 1.22, 1.21, 1.20, 1.19</td>
          <td>3.14.2</td>
          <td>1.19.9â€ </td>
      </tr>
      <tr>
          <td>v1.1.1</td>
          <td>1.23, 1.22, 1.21, 1.20, 1.19</td>
          <td>3.14.2</td>
          <td>1.19.9â€ </td>
      </tr>
      <tr>
          <td>v1.1.0</td>
          <td>1.22, 1.21, 1.20, 1.19</td>
          <td>3.14.2</td>
          <td>1.19.9â€ </td>
      </tr>
      <tr>
          <td>v1.0.5</td>
          <td>1.22, 1.21, 1.20, 1.19</td>
          <td>3.14.2</td>
          <td>1.19.9â€ </td>
      </tr>
      <tr>
          <td>v1.0.4</td>
          <td>1.22, 1.21, 1.20, 1.19</td>
          <td>3.14.2</td>
          <td>1.19.9â€ </td>
      </tr>
      <tr>
          <td>v1.0.3</td>
          <td>1.22, 1.21, 1.20, 1.19</td>
          <td>3.14.2</td>
          <td>1.19.9â€ </td>
      </tr>
      <tr>
          <td>v1.0.2</td>
          <td>1.22, 1.21, 1.20, 1.19</td>
          <td>3.14.2</td>
          <td>1.19.9â€ </td>
      </tr>
      <tr>
          <td>v1.0.1</td>
          <td>1.22, 1.21, 1.20, 1.19</td>
          <td>3.14.2</td>
          <td>1.19.9â€ </td>
      </tr>
      <tr>
          <td>v1.0.0</td>
          <td>1.22, 1.21, 1.20, 1.19</td>
          <td>3.13.5</td>
          <td>1.20.1</td>
      </tr>
  </tbody>
</table>
<ol>
<li>ä½¿ç”¨<code>Helm</code>è¿›è¡Œéƒ¨ç½²<code>nginx-ingress-controller</code></li>
</ol>
<pre tabindex="0"><code>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
helm fetch ingress-nginx/ingress-nginx
tar -xvf ingress-nginx-4.5.2.tgz
</code></pre><ol>
<li>æ–°å»ºä¸€ä¸ª<code>value-test.yaml</code>çš„é…ç½®æ–‡ä»¶</li>
</ol>
<ul>
<li><code>dnsPolicy</code>ï¼šå› ä¸ºå¤„äº<code>hostNetwork:true</code>çš„çŠ¶æ€ä¸‹,Podé»˜è®¤ä½¿ç”¨å®¿ä¸»æœºçš„DNSè§£æ,è¿™æ ·ä¼šå¯¼è‡´å¦‚æœä½ ä½¿ç”¨<code>ServiceName</code>çš„æ–¹å¼æ¥è®¿é—®Podçš„è¯ä¼šå‡ºç°æ— æ³•è§£æçš„æƒ…å†µã€‚æ‰€ä»¥ä¿®æ”¹ä¸º<code>ClusterFirstWithHostNet</code></li>
<li>è¯·å°†<code>webhook</code>çš„é•œåƒä¿®æ”¹ä¸º<code>registry.cn-beijing.aliyuncs.com/polymerization/kube-webhook-certgen:v20220916-gd32f8c343</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">controller</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">registry.cn-beijing.aliyuncs.com/polymerization/nginx-controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;v1.6.4&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">digest</span><span class="p">:</span><span class="w"> </span><span class="l">sha256:e727015a639975f4fc0808b91f9e88a83c60938b640ee6c2f5606ddd779c858d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterFirstWithHostNet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">publishService</span><span class="p">:</span><span class="w">  </span><span class="c"># hostNetwork æ¨¡å¼ä¸‹è®¾ç½®ä¸ºfalseï¼Œé€šè¿‡èŠ‚ç‚¹IPåœ°å€ä¸ŠæŠ¥ingress statusæ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">   </span><span class="c"># æ³¨æ„,å¦‚æœä½ çš„Kubernetesé›†ç¾¤ä¸­å­˜åœ¨å¤šä¸ªTaintéœ€è¦å…¨éƒ¨è¿›è¡Œå®¹å¿ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;node-role.kubernetes.io/master&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Equal&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;NoSchedule&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;node-role.kubernetes.io/control-plane&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Equal&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;NoSchedule&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">   </span><span class="c"># å›ºå®šèŠ‚ç‚¹-&gt;è¯·ç»™3å°masterå…¨éƒ¨æ‰“ä¸Šè¿™ä¸ªæ ‡ç­¾-&gt;ä¸ªäººå»ºè®®å°†ingress-managerè¾¹ç¼˜åŒ–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">node.kubernetes.io/ingress-manager</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">  </span><span class="c"># HostNetwork æ¨¡å¼ä¸éœ€è¦åˆ›å»ºservice</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">admissionWebhooks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">registry</span><span class="p">:</span><span class="w"> </span><span class="l">registry.cn-beijing.aliyuncs.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w">  </span><span class="l">polymerization/kube-webhook-certgen</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="l">v20220916-gd32f8c343</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">digest</span><span class="p">:</span><span class="w"> </span><span class="l">sha256:c0e3bef270e179a5e4ab373f8ba6d57f596f3683d9d40c33ea900b19ec182ba2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">defaultBackend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></div><ol>
<li>éƒ¨ç½²<code>ingress-controller</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># å®‰è£…</span>
</span></span><span class="line"><span class="cl">helm install --namespace ingress-nginx ingress-nginx ./ingress-nginx -f value-test.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># å¸è½½</span>
</span></span><span class="line"><span class="cl">helm uninstall ingress-nginx --namespace ingress-nginx
</span></span></code></pre></div><h2 id="ingressçš„åŸºæœ¬ä½¿ç”¨">Ingressçš„åŸºæœ¬ä½¿ç”¨</h2>
<h3 id="åˆ›å»ºä¸€ä¸ªingressèµ„æºå¯¹è±¡">åˆ›å»ºä¸€ä¸ªingressèµ„æºå¯¹è±¡</h3>
<p>ä¸€ä¸ªæœ€å°çš„ Ingress èµ„æºç¤ºä¾‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-qingyang-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">out-apps</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx.qingyang.com</span><span class="w"> </span><span class="c"># å°†åŸŸåæ˜ å°„åˆ°åç«¯æœåŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">os-qingyang</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>Ingress éœ€è¦æŒ‡å®š <code>apiVersion</code>ã€<code>kind</code>ã€ <code>metadata</code>å’Œ <code>spec</code> å­—æ®µã€‚ Ingress å¯¹è±¡çš„å‘½åå¿…é¡»æ˜¯åˆæ³•çš„ <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/names#dns-subdomain-names"  target="_blank" rel="noopener"
    >DNS å­åŸŸååç§°</a>ã€‚ å…³äºå¦‚ä½•ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œè¯·å‚è§<a class="link" href="https://kubernetes.io/zh-cn/docs/tasks/run-application/run-stateless-application-deployment/"  target="_blank" rel="noopener"
    >éƒ¨ç½²åº”ç”¨</a>ã€ <a class="link" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/"  target="_blank" rel="noopener"
    >é…ç½®å®¹å™¨</a>ã€ <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/manage-deployment/"  target="_blank" rel="noopener"
    >ç®¡ç†èµ„æº</a>ã€‚ Ingress ç»å¸¸ä½¿ç”¨æ³¨è§£ï¼ˆannotationsï¼‰æ¥é…ç½®ä¸€äº›é€‰é¡¹ï¼Œå…·ä½“å–å†³äº Ingress æ§åˆ¶å™¨ï¼Œä¾‹å¦‚<a class="link" href="https://github.com/kubernetes/ingress-nginx/blob/main/docs/examples/rewrite/README.md"  target="_blank" rel="noopener"
    >é‡å†™ç›®æ ‡æ³¨è§£</a>ã€‚ ä¸åŒçš„ <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers"  target="_blank" rel="noopener"
    >Ingress æ§åˆ¶å™¨</a>æ”¯æŒä¸åŒçš„æ³¨è§£ã€‚ æŸ¥çœ‹ä½ æ‰€é€‰çš„ Ingress æ§åˆ¶å™¨çš„æ–‡æ¡£ï¼Œä»¥äº†è§£å…¶æ”¯æŒå“ªäº›æ³¨è§£ã€‚</p>
<blockquote>
<p>å¦‚æœ <code>ingressClassName</code> è¢«çœç•¥ï¼Œé‚£ä¹ˆä½ åº”è¯¥å®šä¹‰ä¸€ä¸ªé»˜è®¤ <code>Ingress ç±»</code>,å¦åˆ™æ— æ³•è½¬å‘æœåŠ¡</p>
</blockquote>
<p>åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„<code>ingressClass</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressClass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/component</span><span class="p">:</span><span class="w"> </span><span class="l">controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingressclass.kubernetes.io/is-default-class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">k8s.io/ingress-nginx</span><span class="w">
</span></span></span></code></pre></div><p>æœ‰ä¸€äº› Ingress æ§åˆ¶å™¨ä¸éœ€è¦å®šä¹‰é»˜è®¤çš„ <code>IngressClass</code>ã€‚æ¯”å¦‚ï¼šIngress-NGINX æ§åˆ¶å™¨å¯ä»¥é€šè¿‡<a class="link" href="https://kubernetes.github.io/ingress-nginx/#what-is-the-flag-watch-ingress-without-class"  target="_blank" rel="noopener"
    >å‚æ•°</a> <code>--watch-ingress-without-class</code> æ¥é…ç½®ã€‚ ä¸è¿‡ä»ç„¶æ¨èåˆ›å»ºé»˜è®¤çš„<code>ingressClass</code></p>
<blockquote>
<p>å¯ä»¥çœ‹ä¸€ä¸‹ç®€å•åœ°ingress-controllerè¯·æ±‚æµç¨‹</p>
</blockquote>
<ol>
<li>å®¢æˆ·ç«¯é¦–å…ˆå¯¹ <code>ngdemo.qikqiak.com</code> æ‰§è¡Œ DNS è§£æï¼Œå¾—åˆ° Ingress Controller æ‰€åœ¨èŠ‚ç‚¹çš„ IP</li>
<li>åå®¢æˆ·ç«¯å‘ Ingress Controller å‘é€ HTTP è¯·æ±‚</li>
<li>æ ¹æ® Ingress å¯¹è±¡é‡Œé¢çš„æè¿°åŒ¹é…åŸŸåï¼Œæ‰¾åˆ°å¯¹åº”çš„ Service å¯¹è±¡ï¼Œå¹¶è·å–å…³è”çš„ Endpoints åˆ—è¡¨ï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘ç»™å…¶ä¸­ä¸€ä¸ª Pod</li>
</ol>
<h3 id="åˆ›å»ºtodo-appæµ‹è¯•æš‚æ—¶åºŸå¼ƒ">åˆ›å»ºTodo-appæµ‹è¯•(æš‚æ—¶åºŸå¼ƒ)</h3>
<ol>
<li>é¦–å…ˆéƒ¨ç½²<code>MongoDB</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">resolv-conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-dns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">items</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">resolv.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">resolv.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">27017</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data/db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">resolv-conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/resolv.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">resolv.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">27017</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">27017</span><span class="w">
</span></span></span></code></pre></div><ol>
<li>åˆ›å»ºTodo</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">todo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">todo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">todo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">cnych/todo:v1.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;DBHOST&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;mongodb://mongo.default.svc.cluster.local:27017&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">todo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">todo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">todo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx.qingyang.com</span><span class="w"> </span><span class="c"># å°†åŸŸåæ˜ å°„åˆ°åç«¯æœåŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">todo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span></code></pre></div><h3 id="url-rewrite">URL Rewrite</h3>
<p>Rewriteçš„Ingressæ³¨è§£</p>
<table>
  <thead>
      <tr>
          <th><a class="link" href="http://nginx.ingress.kubernetes.io/rewrite-target"  target="_blank" rel="noopener"
    >nginx.ingress.kubernetes.io/rewrite-target</a></th>
          <th>Target URI where the traffic must be redirected</th>
          <th>string</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><a class="link" href="http://nginx.ingress.kubernetes.io/ssl-redirect"  target="_blank" rel="noopener"
    >nginx.ingress.kubernetes.io/ssl-redirect</a></td>
          <td>Indicates if the location section is only accessible via SSL (defaults to True when Ingress contains a Certificate)</td>
          <td>bool</td>
      </tr>
      <tr>
          <td><a class="link" href="http://nginx.ingress.kubernetes.io/force-ssl-redirect"  target="_blank" rel="noopener"
    >nginx.ingress.kubernetes.io/force-ssl-redirect</a></td>
          <td>Forces the redirection to HTTPS even if the Ingress is not TLS Enabled</td>
          <td>bool</td>
      </tr>
      <tr>
          <td><a class="link" href="http://nginx.ingress.kubernetes.io/app-root"  target="_blank" rel="noopener"
    >nginx.ingress.kubernetes.io/app-root</a></td>
          <td>Defines the Application Root that the Controller must redirect if itâ€™s in <code>/</code> context</td>
          <td>string</td>
      </tr>
      <tr>
          <td><a class="link" href="http://nginx.ingress.kubernetes.io/use-regex"  target="_blank" rel="noopener"
    >nginx.ingress.kubernetes.io/use-regex</a></td>
          <td>Indicates if the paths defined on an Ingress use regular expressions</td>
          <td>bool</td>
      </tr>
  </tbody>
</table>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦å¯¹è®¿é—®çš„ URL è·¯å¾„åšä¸€ä¸ª Rewriteï¼Œæ¯”å¦‚åœ¨ PATH ä¸­æ·»åŠ ä¸€ä¸ª app çš„å‰ç¼€ï¼Œå…³äº Rewrite çš„æ“ä½œåœ¨ <a class="link" href="https://kubernetes.github.io/ingress-nginx/examples/rewrite/"  target="_blank" rel="noopener"
    >ingress-nginx å®˜æ–¹æ–‡æ¡£</a>ä¸­ä¹Ÿç»™å‡ºå¯¹åº”çš„è¯´æ˜ã€‚</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/rewrite-target</code>: æµé‡å¿…é¡»é‡å®šå‘çš„ç›®æ ‡URI(Target URI where the traffic must be redirected)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">todo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/rewrite-target</span><span class="p">:</span><span class="w"> </span><span class="l">/$2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx.qingyang.com </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/something(/|$)(.*)</span><span class="w"> </span><span class="c"># åŒ¹é…/somethingå’Œ/something/*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">todo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span></code></pre></div><p>åœ¨æ­¤å…¥å£å®šä¹‰ä¸­ï¼Œæ•è·çš„ä»»ä½•å­—ç¬¦éƒ½<code>(.*)</code>å°†åˆ†é…ç»™å ä½ç¬¦<code>$2</code>ï¼Œç„¶åå°†å…¶ç”¨ä½œæ³¨é‡Šä¸­çš„å‚æ•°<code>rewrite-target</code>ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸Šé¢çš„å…¥å£å®šä¹‰å°†å¯¼è‡´ä»¥ä¸‹é‡å†™ï¼š</p>
<ul>
<li><code>nginx.qingyang.com/something</code>æ”¹å†™ä¸º<code>nginx.qingyang.com/</code></li>
<li><code>nginx.qingyang.com/something/</code>æ”¹å†™ä¸º<code>nginx.qingyang.com/</code></li>
<li><code>nginx.qingyang.com/something/new</code>æ”¹å†™ä¸º<code>nginx.qingyang.com/new</code></li>
</ul>
<blockquote>
<p>ä½¿ç”¨æ­¤æ–¹æ³•å¯èƒ½ä¼šå¯¼è‡´éƒ¨åˆ†<code>cssã€js</code>ç­‰å†…å®¹æ— æ³•æ‰¾åˆ°,å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å®ç°</p>
</blockquote>
<ol>
<li>é€šè¿‡<code>configuration-snippet</code>æ³¨è§£</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">todo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/rewrite-target</span><span class="p">:</span><span class="w"> </span><span class="l">/$2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/configuration-snippet</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        rewrite ^/css/(.*)$ /something/css/$1  redirect; # ä¸ºcssæ ·å¼æ·»åŠ /somethingå‰ç¼€
</span></span></span><span class="line"><span class="cl"><span class="sd">        rewrite ^/js/(.*)$ /something/js/$1</span><span class="w">        
</span></span></span></code></pre></div><h2 id="basic-auth">Basic Auth</h2>
<p>ä»¬è¿˜å¯ä»¥åœ¨ Ingress Controller ä¸Šé¢é…ç½®ä¸€äº›åŸºæœ¬çš„ Auth è®¤è¯ï¼Œæ¯”å¦‚ Basic Authï¼Œå¯ä»¥ç”¨ htpasswd ç”Ÿæˆä¸€ä¸ªå¯†ç æ–‡ä»¶æ¥éªŒè¯èº«ä»½éªŒè¯ã€‚</p>
<pre tabindex="0"><code>[root@Online-Beijing-master1 ~]# htpasswd -c auth admin
</code></pre><p>åˆ›å»ºä¸€ä¸ª<code>secret</code></p>
<pre tabindex="0"><code>[root@Online-Beijing-master1 ~]# kubectl create secret generic basic-auth --from-file=authBasic Auth çš„ Ingress å¯¹è±¡ï¼š
</code></pre><p>åˆ›å»ºä¸€ä¸ªå…·æœ‰ <code>Basic Auth</code> çš„ Ingress å¯¹è±¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">basic-auth-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-secret</span><span class="p">:</span><span class="w"> </span><span class="l">basic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-realm</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Authentication Required - admin&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx.qingyang.com </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">os-vue-comment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>æ­£å¸¸ä¼šå¼¹å‡ºæ¥è®¤è¯çª—å£ï¼Œè¿›è¡Œè®¤è¯å°±è¡Œã€‚</p>
<h2 id="ç°åº¦åº”ç”¨">ç°åº¦åº”ç”¨</h2>
<p>åœ¨æ—¥å¸¸å·¥ä½œä¸­æˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹æœåŠ¡è¿›è¡Œç‰ˆæœ¬æ›´æ–°å‡çº§ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°æ»šåŠ¨å‡çº§ã€è“ç»¿å‘å¸ƒã€ç°åº¦å‘å¸ƒç­‰ä¸åŒçš„å‘å¸ƒæ“ä½œã€‚è€Œ <code>ingress-nginx</code> æ”¯æŒé€šè¿‡ Annotations é…ç½®æ¥å®ç°ä¸åŒåœºæ™¯ä¸‹çš„ç°åº¦å‘å¸ƒå’Œæµ‹è¯•ï¼Œå¯ä»¥æ»¡è¶³é‡‘ä¸é›€å‘å¸ƒã€è“ç»¿éƒ¨ç½²ä¸ A/B æµ‹è¯•ç­‰ä¸šåŠ¡åœºæ™¯ã€‚</p>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›é€šè¿‡å‘ä¸ç”Ÿäº§æœåŠ¡ä¸åŒçš„æœåŠ¡å‘é€å°‘é‡è¯·æ±‚æ¥<code>é‡‘ä¸é›€</code>ä¸€ç»„æ–°çš„æ›´æ”¹ã€‚Canary æ³¨é‡Šä½¿ Ingress è§„èŒƒå¯ä»¥å……å½“è¯·æ±‚è·¯ç”±åˆ°çš„æ›¿ä»£æœåŠ¡ï¼Œå…·ä½“å–å†³äºåº”ç”¨çš„è§„åˆ™ã€‚</p>
<p><a class="link" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#canary"  target="_blank" rel="noopener"
    >ingress-nginx çš„ Annotations</a> æ”¯æŒä»¥ä¸‹ 4 ç§ Canary è§„åˆ™ï¼š</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/canary-by-header</code>: åŸºäº Request Header çš„æµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºç°åº¦å‘å¸ƒä»¥åŠ A/B æµ‹è¯•ã€‚å½“ Request Header è®¾ç½®ä¸º always æ—¶ï¼Œè¯·æ±‚å°†ä¼šè¢«ä¸€ç›´å‘é€åˆ° Canary ç‰ˆæœ¬ï¼›å½“ Request Header è®¾ç½®ä¸º neveræ—¶ï¼Œè¯·æ±‚ä¸ä¼šè¢«å‘é€åˆ° Canary å…¥å£ï¼›å¯¹äºä»»ä½•å…¶ä»– Header å€¼ï¼Œå°†å¿½ç•¥ Headerï¼Œå¹¶é€šè¿‡ä¼˜å…ˆçº§å°†è¯·æ±‚ä¸å…¶ä»–é‡‘ä¸é›€è§„åˆ™è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒã€‚</li>
<li><code>nginx.ingress.kubernetes.io/canary-by-header-value</code>: è¦åŒ¹é…çš„ Request Header çš„å€¼ï¼Œç”¨äºé€šçŸ¥ Ingress å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingress ä¸­æŒ‡å®šçš„æœåŠ¡ã€‚å½“ Request Header è®¾ç½®ä¸ºæ­¤å€¼æ—¶ï¼Œå®ƒå°†è¢«è·¯ç”±åˆ° Canary å…¥å£ã€‚è¯¥è§„åˆ™å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ Request Header çš„å€¼ã€‚æ­¤æ³¨é‡Šå¿…é¡»ä¸ ä¸€èµ·ä½¿ç”¨<code>nginx.ingress.kubernetes.io/canary-by-header</code>ã€‚å¦‚æœæœªå®šä¹‰<code>canary-by-header</code>,é‚£ä¹ˆè¯¥æ³¨è§£æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚</li>
<li><code>nginx.ingress.kubernetes.io/canary-weight</code>: åŸºäºæœåŠ¡æƒé‡çš„æµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºè“ç»¿éƒ¨ç½²ï¼Œæƒé‡èŒƒå›´ 0 - 100 æŒ‰ç™¾åˆ†æ¯”å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingress ä¸­æŒ‡å®šçš„æœåŠ¡ã€‚æƒé‡ä¸º 0 æ„å‘³ç€è¯¥é‡‘ä¸é›€è§„åˆ™ä¸ä¼šå‘ Canary å…¥å£çš„æœåŠ¡å‘é€ä»»ä½•è¯·æ±‚ï¼Œæƒé‡ä¸º 100 æ„å‘³ç€æ‰€æœ‰è¯·æ±‚éƒ½å°†è¢«å‘é€åˆ° Canary å…¥å£ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/canary-by-cookie</code>: åŸºäº cookie çš„æµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºç°åº¦å‘å¸ƒä¸ A/B æµ‹è¯•ã€‚ç”¨äºé€šçŸ¥ Ingress å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingress ä¸­æŒ‡å®šçš„æœåŠ¡çš„cookieã€‚å½“ cookie å€¼è®¾ç½®ä¸º always æ—¶ï¼Œå®ƒå°†è¢«è·¯ç”±åˆ° Canary å…¥å£ï¼›å½“ cookie å€¼è®¾ç½®ä¸º never æ—¶ï¼Œè¯·æ±‚ä¸ä¼šè¢«å‘é€åˆ° Canary å…¥å£ï¼›å¯¹äºä»»ä½•å…¶ä»–å€¼ï¼Œå°†å¿½ç•¥ cookie å¹¶å°†è¯·æ±‚ä¸å…¶ä»–é‡‘ä¸é›€è§„åˆ™è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒã€‚</li>
</ul>
<blockquote>
<p>Canary è§„åˆ™æŒ‰ä¼˜å…ˆé¡ºåºè¿›è¡Œè¯„ä¼°ã€‚ä¼˜å…ˆçº§å¦‚ä¸‹ï¼š<code>canary-by-header -&gt; canary-by-cookie -&gt; canary-weight</code></p>
</blockquote>
<p>æŠŠä»¥ä¸Šçš„å››ä¸ª annotation è§„åˆ™å¯ä»¥æ€»ä½“åˆ’åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š</p>
<h3 id="åŸºäºæƒé‡çš„çš„canaryè§„åˆ™">åŸºäºæƒé‡çš„çš„Canaryè§„åˆ™</h3>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="img" loading="lazy" src="https://pek3b.qingstor.com/kubesphere-docs/png/20190826201233.png"></p>
<h3 id="åŸºäºç”¨æˆ·è¯·æ±‚çš„canaryè§„åˆ™">åŸºäºç”¨æˆ·è¯·æ±‚çš„Canaryè§„åˆ™</h3>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="img" loading="lazy" src="https://pek3b.qingstor.com/kubesphere-docs/png/20190826204915.png"></p>
<h3 id="ç°åº¦éªŒè¯">ç°åº¦éªŒè¯</h3>
<ol>
<li>é¦–å…ˆæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªåŸºäº<code>Producation</code>ç‰ˆæœ¬çš„åº”ç”¨</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">production-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">production </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">production</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">production</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">production-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mirrorgooglecontainers/echoserver:1.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">NODE_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">spec.nodeName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAMESPACE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_IP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">status.podIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">production-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">production</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">production</span><span class="w">
</span></span></span></code></pre></div><ol>
<li>åˆ›å»ºProduction ç‰ˆæœ¬çš„åº”ç”¨è·¯ç”± (Ingress)ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">production-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">prod.qingyang.com </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">production-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><ol>
<li>åˆ›å»ºCanaryç‰ˆæœ¬çš„åº”ç”¨ä¸Šçº¿</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">canary-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">canary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">canary-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">canary-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mirrorgooglecontainers/echoserver:1.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">NODE_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">spec.nodeName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAMESPACE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_IP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">status.podIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">canary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">canary-app</span><span class="w">
</span></span></span></code></pre></div><h4 id="åŸºäºæƒé‡çš„canaryè§„åˆ™">åŸºäºæƒé‡çš„Canaryè§„åˆ™</h4>
<p>åŸºäºæƒé‡çš„æµé‡åˆ‡åˆ†çš„å…¸å‹åº”ç”¨åœºæ™¯å°±æ˜¯<code>è“ç»¿éƒ¨ç½²</code>ï¼Œå¯é€šè¿‡å°†æƒé‡è®¾ç½®ä¸º 0 æˆ– 100 æ¥å®ç°ã€‚ä¾‹å¦‚ï¼Œå¯å°† Green ç‰ˆæœ¬è®¾ç½®ä¸ºä¸»è¦éƒ¨åˆ†ï¼Œå¹¶å°† Blue ç‰ˆæœ¬çš„å…¥å£é…ç½®ä¸º Canaryã€‚æœ€åˆï¼Œå°†æƒé‡è®¾ç½®ä¸º 0ï¼Œå› æ­¤ä¸ä¼šå°†æµé‡ä»£ç†åˆ° Blue ç‰ˆæœ¬ã€‚ä¸€æ—¦æ–°ç‰ˆæœ¬æµ‹è¯•å’ŒéªŒè¯éƒ½æˆåŠŸåï¼Œå³å¯å°† Blue ç‰ˆæœ¬çš„æƒé‡è®¾ç½®ä¸º 100ï¼Œå³æ‰€æœ‰æµé‡ä» Green ç‰ˆæœ¬è½¬å‘ Blueã€‚</p>
<blockquote>
<p>ä»¥ä¸‹ Ingress ç¤ºä¾‹çš„ Canary ç‰ˆæœ¬ä½¿ç”¨äº†<strong>åŸºäºæƒé‡è¿›è¡Œæµé‡åˆ‡åˆ†</strong>çš„ annotation è§„åˆ™ï¼Œå°†åˆ†é… <strong>30%</strong> çš„æµé‡è¯·æ±‚å‘é€è‡³ Canary ç‰ˆæœ¬ã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w"> </span><span class="c"># å¼€å¯canaryæœºåˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-weight</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30&#34;</span><span class="w"> </span><span class="c"># åˆ‡åˆ†30çš„æµé‡åˆ°canaryç‰ˆæœ¬ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">prod.qingyang.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>åº”ç”¨çš„ Canary ç‰ˆæœ¬åŸºäºæƒé‡ (30%) è¿›è¡Œæµé‡åˆ‡åˆ†åï¼Œè®¿é—®åˆ° Canary ç‰ˆæœ¬çš„æ¦‚ç‡æ¥è¿‘ 30%ï¼Œæµé‡æ¯”ä¾‹å¯èƒ½ä¼šæœ‰å°èŒƒå›´çš„æµ®åŠ¨ã€‚</p>
</blockquote>
<h4 id="åŸºäº-request-header">åŸºäº Request Header</h4>
<p>åŸºäº Request Header è¿›è¡Œæµé‡åˆ‡åˆ†çš„å…¸å‹åº”ç”¨åœºæ™¯å³<code>ç°åº¦å‘å¸ƒæˆ– A/B æµ‹è¯•åœºæ™¯</code>ã€‚å‚è€ƒä»¥ä¸‹æˆªå›¾ï¼Œåœ¨ KubeSphere ç»™ Canary ç‰ˆæœ¬çš„åº”ç”¨è·¯ç”± (Ingress) æ–°å¢ä¸€æ¡ annotation <code>nginx.ingress.kubernetes.io/canary-by-header: canary</code>(è¿™é‡Œçš„ annotation çš„ value å¯ä»¥æ˜¯ä»»æ„å€¼)ï¼Œä½¿å½“å‰çš„ Ingress å®ç°åŸºäº Request Header è¿›è¡Œæµé‡åˆ‡åˆ†ã€‚</p>
<blockquote>
<p>é‡‘ä¸é›€è§„åˆ™æŒ‰ä¼˜å…ˆé¡ºåº <code>canary-by-header - &gt; canary-by-cookie - &gt; canary-weight</code>è¿›è¡Œå¦‚ä¸‹æ’åºï¼Œå› æ­¤ä»¥ä¸‹æƒ…å†µå°†å¿½ç•¥åŸæœ‰ canary-weight çš„è§„åˆ™ã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-by-header</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;canary-header&#34;</span><span class="w"> </span><span class="c"># æ·»åŠ header</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w"> </span><span class="c"># å¼€å¯canaryæœºåˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-weight</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30&#34;</span><span class="w"> </span><span class="c"># åˆ‡åˆ†30çš„æµé‡åˆ°canaryç‰ˆæœ¬ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">prod.qingyang.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>æˆ‘ä»¬å°è¯•è®¿é—®ä¸€ä¸‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># for i in $(seq 1 10); do curl -s prod.qingyang.com | grep &#34;Hostname&#34;; done</span>
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span></code></pre></div><p>å°è¯•åŠ å…¥è¯·æ±‚å¤´è®¿é—®</p>
<ul>
<li>å¦‚æœä½ çš„<code>canary-header</code>çš„å€¼ä¸º<code>never</code>åˆ™è¡¨ç¤ºè¯·æ±‚æ°¸è¿œä¸ä¼šè¯·æ±‚åˆ°å½“å‰ç‰ˆæœ¬,å¦‚æœä½ çš„<code>canary-header</code>çš„å€¼è®¾ç½®ä¸º<code>always</code>çš„è¯åˆ™è¡¨ç¤ºæ°¸è¿œè¯·æ±‚å½“å‰ç‰ˆæœ¬</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># for i in $(seq 1 10); do curl -s -H &#34;canary-header: never&#34; prod.qingyang.com | grep &#34;Hostname&#34;; done</span>
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">Hostname: production-app-678488687f-s4sbd
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># for i in $(seq 1 10); do curl -s -H &#34;canary-header: always&#34; prod.qingyang.com | grep &#34;Hostname&#34;; done</span>
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span><span class="line"><span class="cl">Hostname: canary-demo-54dfb9bd-n2zlg
</span></span></code></pre></div><p>å¦‚æœä½ æƒ³è®©ç”¨æˆ·è¯·æ±‚åˆ°æŒ‡å®šçš„æœåŠ¡ä¸Šå¯ä»¥æ·»åŠ <code>ginx.ingress.kubernetes.io/canary-by-header-value: user-value</code>,å½“è¯·æ±‚è®¿é—®æºå¸¦<code>canary-header: user-value</code>çš„æ—¶å€™,é‚£ä¹ˆè¯¥è¯·æ±‚ä¼šè¢«è½¬å‘åˆ°<code>canary</code>ç‰ˆæœ¬ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-by-header-value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;user-value&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-by-header</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;canary-header&#34;</span><span class="w"> </span><span class="c"># æ·»åŠ header</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w"> </span><span class="c"># å¼€å¯canaryæœºåˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-weight</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30&#34;</span><span class="w"> </span><span class="c"># åˆ‡åˆ†30çš„æµé‡åˆ°canaryç‰ˆæœ¬ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">prod.qingyang.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><h4 id="åŸºäº-cookieçš„canary">åŸºäº Cookieçš„canary</h4>
<p>ä¸åŸºäº Request Header çš„ annotation ç”¨æ³•è§„åˆ™ç±»ä¼¼ã€‚ä¾‹å¦‚åœ¨ <code>A/B æµ‹è¯•åœºæ™¯</code>ä¸‹ï¼Œéœ€è¦è®©åœ°åŸŸä¸ºåŒ—äº¬çš„ç”¨æˆ·è®¿é—® Canary ç‰ˆæœ¬ã€‚é‚£ä¹ˆå½“ cookie çš„ annotation è®¾ç½®ä¸º <code>nginx.ingress.kubernetes.io/canary-by-cookie: &quot;users_from_beijing&quot;</code>ï¼Œæ­¤æ—¶åå°å¯å¯¹ç™»å½•çš„ç”¨æˆ·è¯·æ±‚è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¯¥ç”¨æˆ·è®¿é—®æºæ¥è‡ªåŒ—äº¬åˆ™è®¾ç½® cookie <code>users_from_beijing</code>çš„å€¼ä¸º <code>always</code>ï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿åŒ—äº¬çš„ç”¨æˆ·ä»…è®¿é—® Canary ç‰ˆæœ¬</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-by-cookie</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;user_from_beijing&#34;</span><span class="w"> </span><span class="c"># æ·»åŠ cookie</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w"> </span><span class="c"># å¼€å¯canaryæœºåˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-weight</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30&#34;</span><span class="w"> </span><span class="c"># åˆ‡åˆ†30çš„æµé‡åˆ°canaryç‰ˆæœ¬ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">prod.qingyang.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><h2 id="è‡ªç­¾https">è‡ªç­¾HTTPS</h2>
<p>å¦‚æœæˆ‘ä»¬éœ€è¦ç”¨ HTTPS æ¥è®¿é—®æˆ‘ä»¬è¿™ä¸ªåº”ç”¨çš„è¯ï¼Œå°±éœ€è¦ç›‘å¬ 443 ç«¯å£äº†ï¼ŒåŒæ ·ç”¨ HTTPS è®¿é—®åº”ç”¨å¿…ç„¶å°±éœ€è¦è¯ä¹¦ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ <code>openssl</code> æ¥åˆ›å»ºä¸€ä¸ªè‡ªç­¾åçš„è¯ä¹¦ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="s2">&#34;/CN=prod.qingyang.com&#34;</span>
</span></span></code></pre></div><p>åˆ›å»º<code>tls</code>ç±»å‹çš„<code>secret</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create secret tls self-sign-nginx --cert<span class="o">=</span>tls.crt --key<span class="o">=</span>tls.key
</span></span></code></pre></div><p>åˆ›å»ºå¸¦<code>tls</code>çš„<code>ingress</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">canary-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w"> </span><span class="c"># å¼€å¯canaryæœºåˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-weight</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30&#34;</span><span class="w"> </span><span class="c"># åˆ‡åˆ†30çš„æµé‡åˆ°canaryç‰ˆæœ¬ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">prod.qingyang.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">prod.qingyang.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">self-sign-nginx</span><span class="w">
</span></span></span></code></pre></div><h2 id="certmanager-è‡ªåŠ¨-https">CertManager è‡ªåŠ¨ HTTPS</h2>
<p>cert-manager å°†è¯ä¹¦å’Œè¯ä¹¦é¢å‘è€…ä½œä¸ºèµ„æºç±»å‹æ·»åŠ åˆ° Kubernetes é›†ç¾¤ä¸­ï¼Œå¹¶ç®€åŒ–äº†è¿™äº›è¯ä¹¦çš„è·å–ã€æ›´æ–°å’Œä½¿ç”¨è¿‡ç¨‹ã€‚</p>
<p>å®ƒå¯ä»¥ä»å„ç§å—æ”¯æŒçš„æ¥æºé¢å‘è¯ä¹¦ï¼ŒåŒ…æ‹¬ <a class="link" href="https://letsencrypt.org/"  target="_blank" rel="noopener"
    >Letâ€™s Encrypt</a>ã€<a class="link" href="https://www.vaultproject.io/"  target="_blank" rel="noopener"
    >HashiCorp Vault</a>å’Œ<a class="link" href="https://www.venafi.com/"  target="_blank" rel="noopener"
    >Venafi</a>ä»¥åŠç§æœ‰ PKIã€‚</p>
<p>å®ƒå°†ç¡®ä¿è¯ä¹¦æœ‰æ•ˆä¸”æœ€æ–°ï¼Œå¹¶å°è¯•åœ¨åˆ°æœŸå‰çš„é…ç½®æ—¶é—´æ›´æ–°è¯ä¹¦ã€‚</p>
<p>å®ƒå¤§è‡´åŸºäº <a class="link" href="https://github.com/jetstack/kube-lego"  target="_blank" rel="noopener"
    >kube-lego</a>çš„å·¥ä½œï¼Œå¹¶å€Ÿé‰´äº†å…¶ä»–ç±»ä¼¼é¡¹ç›®ï¼ˆä¾‹å¦‚ <a class="link" href="https://github.com/PalmStoneGames/kube-cert-manager"  target="_blank" rel="noopener"
    >kube-cert-managerï¼‰</a>çš„ä¸€äº›æ™ºæ…§ã€‚</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="CertManagerå·¥ä½œåŸç†" loading="lazy" src="https://cert-manager.io/images/high-level-overview.svg"></p>
<ul>
<li><code>Issuers</code>: ä»£è¡¨çš„æ˜¯è¯ä¹¦é¢å‘è€…ï¼Œå¯ä»¥å®šä¹‰å„ç§æä¾›è€…çš„è¯ä¹¦é¢å‘è€…ï¼Œå½“å‰æ”¯æŒåŸºäº <code>Let's Encrypt/HashiCorp/Vault</code> å’Œ CA çš„è¯ä¹¦é¢å‘è€…ï¼Œè¿˜å¯ä»¥å®šä¹‰ä¸åŒç¯å¢ƒä¸‹çš„è¯ä¹¦é¢å‘è€…ã€‚</li>
<li><code>Certificates</code>: ä»£è¡¨çš„æ˜¯ç”Ÿæˆè¯ä¹¦çš„è¯·æ±‚.</li>
</ul>
<h3 id="éƒ¨ç½²cert-manager">éƒ¨ç½²cert-manager</h3>
<p>å¥½åƒè¿™ä¸ª<code>quay.io</code>èƒ½æ‹‰ä¸‹æ¥äº†â€¦</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/cert-manager.yaml
</span></span></code></pre></div><p>æ­£å¸¸éƒ¨ç½²å®Œæˆå¯ä»¥çœ‹åˆ°Podæ­£åœ¨è¿è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get pods -n cert-manager</span>
</span></span><span class="line"><span class="cl">NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">cert-manager-6499989f7-m6vdj               1/1     Running   <span class="m">0</span>          2m30s
</span></span><span class="line"><span class="cl">cert-manager-cainjector-645b688547-xjcb8   1/1     Running   <span class="m">0</span>          2m30s
</span></span><span class="line"><span class="cl">cert-manager-webhook-6b7f49999f-mcnf7      1/1     Running   <span class="m">0</span>          2m30s
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„æµ‹è¯•æ¥éªŒè¯ä¸‹æ˜¯å¦å¯ä»¥ç­¾å‘åŸºæœ¬çš„è¯ä¹¦ç±»å‹ï¼Œåˆ›å»ºä¸€ä¸ª Issuer èµ„æºå¯¹è±¡æ¥æµ‹è¯• webhook å·¥ä½œæ˜¯å¦æ­£å¸¸(åœ¨å¼€å§‹ç­¾å‘è¯ä¹¦ä¹‹å‰ï¼Œå¿…é¡»åœ¨ç¾¤é›†ä¸­è‡³å°‘é…ç½®ä¸€ä¸ª Issuer æˆ– ClusterIssuer èµ„æº)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-selfsigned</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selfSigned</span><span class="p">:</span><span class="w"> </span>{}<span class="w">  </span><span class="c"># é…ç½®è‡ªç­¾åçš„è¯ä¹¦æœºæ„ç±»å‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">selfsigned-cert</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">example.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">selfsigned-cert-tls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-selfsigned</span><span class="w">
</span></span></span></code></pre></div><h3 id="è‡ªåŠ¨https">è‡ªåŠ¨HTTPS</h3>
<p><code>Let's Encrypt</code> ä½¿ç”¨ <code>ACME</code> åè®®æ¥æ ¡éªŒåŸŸåæ˜¯å¦çœŸçš„å±äºä½ ï¼Œæ ¡éªŒæˆåŠŸåå°±å¯ä»¥è‡ªåŠ¨é¢å‘å…è´¹è¯ä¹¦ï¼Œè¯ä¹¦æœ‰æ•ˆæœŸåªæœ‰ 90 å¤©ï¼Œåœ¨åˆ°æœŸå‰éœ€è¦å†æ ¡éªŒä¸€æ¬¡æ¥å®ç°ç»­æœŸï¼Œè€Œ cert-manager æ˜¯å¯ä»¥è‡ªåŠ¨ç»­æœŸçš„ï¼Œæ‰€ä»¥äº‹å®ä¸Šå¹¶ä¸ç”¨æ‹…å¿ƒè¯ä¹¦è¿‡æœŸçš„é—®é¢˜ã€‚ç›®å‰ä¸»è¦æœ‰ HTTP å’Œ DNS ä¸¤ç§æ ¡éªŒæ–¹å¼ã€‚</p>
<h4 id="http-01-æ ¡éªŒ">HTTP-01 æ ¡éªŒ</h4>
<p><code>HTTP-01</code> çš„æ ¡éªŒæ˜¯é€šè¿‡ç»™ä½ åŸŸåæŒ‡å‘çš„ HTTP æœåŠ¡å¢åŠ ä¸€ä¸ªä¸´æ—¶ locationï¼Œåœ¨æ ¡éªŒçš„æ—¶å€™ <code>Let's Encrypt</code> ä¼šå‘é€ http è¯·æ±‚åˆ° <code>http://&lt;YOUR_DOMAIN&gt;/.well-known/acme-challenge/&lt;TOKEN&gt;</code>ï¼Œå…¶ä¸­ <code>YOUR_DOMAIN</code> å°±æ˜¯è¢«æ ¡éªŒçš„åŸŸåï¼Œ<code>TOKEN</code> æ˜¯ cert-manager ç”Ÿæˆçš„ä¸€ä¸ªè·¯å¾„ï¼Œå®ƒé€šè¿‡ä¿®æ”¹ Ingress è§„åˆ™æ¥å¢åŠ è¿™ä¸ªä¸´æ—¶æ ¡éªŒè·¯å¾„å¹¶æŒ‡å‘æä¾› TOKEN çš„æœåŠ¡ã€‚<code>Let's Encrypt</code> ä¼šå¯¹æ¯” TOKEN æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œæ ¡éªŒæˆåŠŸåå°±ä¼šé¢å‘è¯ä¹¦äº†ï¼Œä¸è¿‡è¿™ç§æ–¹æ³•ä¸æ”¯æŒæ³›åŸŸåè¯ä¹¦ã€‚</p>
<p>ä½¿ç”¨ HTTP æ ¡éªŒè¿™ç§æ–¹å¼ï¼Œé¦–å…ˆéœ€è¦å°†åŸŸåè§£æé…ç½®å¥½ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä¿è¯ ACME æœåŠ¡ç«¯å¯ä»¥æ­£å¸¸è®¿é—®åˆ°ä½ çš„ HTTP æœåŠ¡ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥ä¸Šé¢çš„ TODO åº”ç”¨ä¸ºä¾‹ï¼Œæˆ‘ä»¬å·²ç»å°† <code>demo.qingyang.com</code> åŸŸååšå¥½äº†æ­£ç¡®çš„è§£æã€‚</p>
<p>ç”±äº Letâ€™s Encrypt çš„ç”Ÿäº§ç¯å¢ƒæœ‰ç€ä¸¥æ ¼çš„æ¥å£è°ƒç”¨é™åˆ¶ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬éœ€è¦å…ˆåœ¨ staging ç¯å¢ƒæµ‹è¯•é€šè¿‡åï¼Œå†åˆ‡æ¢åˆ°ç”Ÿäº§ç¯å¢ƒã€‚é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå…¨å±€èŒƒå›´ staging ç¯å¢ƒä½¿ç”¨çš„ HTTP-01 æ ¡éªŒæ–¹å¼çš„è¯ä¹¦é¢å‘æœºæ„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ACMEæœåŠ¡ç«¯åœ°å€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># æ³¨å†ŒACMEçš„é‚®ç®±</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">ailunbolinkenasi@gmail.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ç”¨äºå­˜æ”¾ACMEå¸å·privateKeyçš„secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-issuer-account-key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">  </span><span class="c"># ACMEçš„ç±»å‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># æŒ‡å®šingressçš„åç§°</span><span class="w">
</span></span></span></code></pre></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥ç”Ÿæˆå…è´¹è¯ä¹¦äº†ï¼Œcert-manager ç»™æˆ‘ä»¬æä¾›äº† <code>Certificate</code> è¿™ä¸ªç”¨äºç”Ÿæˆè¯ä¹¦çš„è‡ªå®šä¹‰èµ„æºå¯¹è±¡ï¼Œä¸è¿‡è¿™ä¸ªå¯¹è±¡éœ€è¦åœ¨ä¸€ä¸ªå…·ä½“çš„å‘½åç©ºé—´ä¸‹ä½¿ç”¨ï¼Œè¯ä¹¦æœ€ç»ˆä¼šåœ¨è¿™ä¸ªå‘½åç©ºé—´ä¸‹ä»¥ Secret çš„èµ„æºå¯¹è±¡å­˜å‚¨ã€‚æˆ‘ä»¬è¿™é‡Œæ˜¯è¦ç»“åˆ ingress-nginx ä¸€èµ·ä½¿ç”¨ï¼Œå®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ Ingress å¯¹è±¡ï¼Œæ·»åŠ ä¸Š cert-manager çš„ç›¸å…³æ³¨è§£å³å¯ï¼Œä¸éœ€è¦æ‰‹åŠ¨åˆ›å»º Certificate å¯¹è±¡äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;letsencrypt-staging&#34;</span><span class="w">  </span><span class="c"># ä½¿ç”¨å“ªä¸ªissuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">demo.qingyang.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">demo-qingyang-com-tls  </span><span class="w"> </span><span class="c"># ç”¨äºå­˜å‚¨è¯ä¹¦çš„Secretå¯¹è±¡åå­—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">demo.qingyang.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>åˆ›å»ºå®Œæˆåä¼šå¤šå‡ºä¸€ä¸ª<code>ingress</code>å¯¹è±¡,ä¸»è¦æ˜¯ä¸ºäº†è®©<code>acme</code>å¯ä»¥è®¿é—®åˆ°å½“å‰çš„çš„<code>token</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get ingress</span>
</span></span><span class="line"><span class="cl">NAME                        CLASS    HOSTS               ADDRESS                         PORTS     AGE
</span></span><span class="line"><span class="cl">cm-acme-http-solver-xpxm7   &lt;none&gt;   demo.qingyang.com   10.1.6.24,10.1.6.45,10.1.6.48   <span class="m">80</span>        7m51s
</span></span><span class="line"><span class="cl">https-ingress               nginx    demo.qingyang.com   10.1.6.24,10.1.6.45,10.1.6.48   80, <span class="m">443</span>   7m55s
</span></span></code></pre></div><p>å¯ä»¥æŸ¥çœ‹å½“å‰çš„<code>acme</code>è®¤è¯,å…¶ä¸­<code>/.well-known/acme-challenge/pVY-ihomZPdlWDMt44cV9qZUwMQScjHvd3Zkf_FDLRI</code>æ˜¯è¢«éªŒè¯å¯¹è±¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl describe ingress cm-acme-http-solver-xpxm7</span>
</span></span><span class="line"><span class="cl">Name:             cm-acme-http-solver-xpxm7
</span></span><span class="line"><span class="cl">Labels:           acme.cert-manager.io/http-domain<span class="o">=</span><span class="m">1002178207</span>
</span></span><span class="line"><span class="cl">                  acme.cert-manager.io/http-token<span class="o">=</span><span class="m">1266355919</span>
</span></span><span class="line"><span class="cl">                  acme.cert-manager.io/http01-solver<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl">Namespace:        default
</span></span><span class="line"><span class="cl">Address:          10.1.6.24,10.1.6.45,10.1.6.48
</span></span><span class="line"><span class="cl">Ingress Class:    &lt;none&gt;
</span></span><span class="line"><span class="cl">Default backend:  &lt;default&gt;
</span></span><span class="line"><span class="cl">Rules:
</span></span><span class="line"><span class="cl">  Host               Path  Backends
</span></span><span class="line"><span class="cl">  ----               ----  --------
</span></span><span class="line"><span class="cl">  demo.qingyang.com
</span></span><span class="line"><span class="cl">                     /.well-known/acme-challenge/pVY-ihomZPdlWDMt44cV9qZUwMQScjHvd3Zkf_FDLRI   cm-acme-http-solver-f4ntj:8089 <span class="o">(</span>10.10.180.124:8089<span class="o">)</span>
</span></span><span class="line"><span class="cl">Annotations:         kubernetes.io/ingress.class: nginx
</span></span><span class="line"><span class="cl">                     nginx.ingress.kubernetes.io/whitelist-source-range: 0.0.0.0/0,::/0
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type    Reason  Age                    From                      Message
</span></span><span class="line"><span class="cl">  ----    ------  ----                   ----                      -------
</span></span><span class="line"><span class="cl">  Normal  Sync    7m46s <span class="o">(</span>x2 over 8m13s<span class="o">)</span>  nginx-ingress-controller  Scheduled <span class="k">for</span> sync
</span></span><span class="line"><span class="cl">  Normal  Sync    7m46s <span class="o">(</span>x2 over 8m13s<span class="o">)</span>  nginx-ingress-controller  Scheduled <span class="k">for</span> sync
</span></span><span class="line"><span class="cl">  Normal  Sync    7m46s <span class="o">(</span>x2 over 8m13s<span class="o">)</span>  nginx-ingress-controller  Scheduled <span class="k">for</span> sync
</span></span></code></pre></div><p>ä½ å¯ä»¥å°è¯•è®¿é—®<code>https://demo.qingyang.com/.well-known/acme-challenge/pVY-ihomZPdlWDMt44cV9qZUwMQScjHvd3Zkf_FDLRI</code>ã€‚æ­£å¸¸ä¼šå‡ºç°å…·ä½“çš„<code>éªŒè¯å¯†é’¥</code>å³æˆåŠŸ.</p>
<blockquote>
<p>ç”±äºæˆ‘çš„æ˜¯æœ¬åœ°è‡ªå·±æ­å»ºçš„kubernetesé›†ç¾¤,æ²¡æœ‰å¤–éƒ¨è§£æçš„è®¿é—®æƒé™æ‰€ä»¥è¿™ä¸ªåœ°æ–¹å°±æ²¡åŠæ³•ç»™å¤§å®¶æ¼”ç¤ºäº†ã€‚</p>
</blockquote>
<h4 id="dns-01-æ ¡éªŒ">DNS-01 æ ¡éªŒ</h4>
<p><code>NS-01</code> çš„æ ¡éªŒæ˜¯é€šè¿‡ DNS æä¾›å•†çš„ API æ‹¿åˆ°ä½ çš„ DNS æ§åˆ¶æƒé™ï¼Œ åœ¨ <code>Let's Encrypt</code> ä¸º cert-manager æä¾› TOKEN åï¼Œcert-manager å°†åˆ›å»ºä»è¯¥ TOKEN å’Œä½ çš„å¸æˆ·å¯†é’¥æ´¾ç”Ÿçš„ <code>TXT</code> è®°å½•ï¼Œå¹¶å°†è¯¥è®°å½•æ”¾åœ¨ <code>_acme-challenge.&lt;YOUR_DOMAIN&gt;</code>ã€‚ç„¶å <code>Let's Encrypt</code> å°†å‘ DNS ç³»ç»ŸæŸ¥è¯¢è¯¥è®°å½•ï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œå°±å¯ä»¥é¢å‘è¯ä¹¦ï¼Œè¿™ç§æ–¹æ³•æ˜¯æ”¯æŒæ³›åŸŸåè¯ä¹¦çš„ã€‚</p>
<p>DNS-01 æ”¯æŒå¤šç§ä¸åŒçš„æœåŠ¡æä¾›å•†ï¼Œç›´æ¥åœ¨ Issuer æˆ–è€… ClusterIssuer ä¸­å¯ä»¥ç›´æ¥é…ç½®ï¼Œå¯¹äºä¸€äº›ä¸æ”¯æŒçš„ DNS æœåŠ¡æä¾›å•†å¯ä»¥ä½¿ç”¨å¤–éƒ¨ webhook æ¥æä¾›æ”¯æŒï¼Œæ¯”å¦‚é˜¿é‡Œäº‘çš„ DNS è§£æé»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸æ”¯æŒçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘è¿™ä¸ª webhook æ¥æä¾›æ”¯æŒã€‚</p>
<ul>
<li><a class="link" href="https://github.com/pragkent/alidns-webhook"  target="_blank" rel="noopener"
    >alidns-webhook</a></li>
</ul>
<ol>
<li>å®‰è£…<code>alidns-webhook</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f https://raw.githubusercontent.com/pragkent/alidns-webhook/master/deploy/bundle.yaml
</span></span></code></pre></div><ol>
<li>æ¥ç€åˆ›å»ºä¸€ä¸ªåŒ…å«è®¿é—®é˜¿é‡Œäº‘ DNS è®¤è¯å¯†é’¥ä¿¡æ¯çš„ Secret å¯¹è±¡ï¼Œå¯¹åº”çš„ <code>accessk-key</code> å’Œ <code>secret-key</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create secret generic alidns-secret --from-literal<span class="o">=</span>access-key<span class="o">=</span>YOUR_ACCESS_KEY --from-literal<span class="o">=</span>secret-key<span class="o">=</span>YOUR_SECRET_KEY -n cert-manager
</span></span></code></pre></div><ol>
<li>æ¥ä¸‹æ¥åŒæ ·é¦–å…ˆåˆ›å»ºä¸€ä¸ª staging ç¯å¢ƒçš„ DNS ç±»å‹çš„è¯ä¹¦æœºæ„èµ„æºå¯¹è±¡</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging-dns01</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">beilanzhisen@163.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging-dns01</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">dns01</span><span class="p">:</span><span class="w">   </span><span class="c"># ACME DNS-01 ç±»å‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">webhook</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">groupName</span><span class="p">:</span><span class="w"> </span><span class="l">acme.yourcompany.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">solverName</span><span class="p">:</span><span class="w"> </span><span class="l">alidns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">accessKeySecretRef</span><span class="p">:</span><span class="w">  </span><span class="c"># å¼•ç”¨ ak</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">alidns-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">access-key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">secretKeySecretRef</span><span class="p">:</span><span class="w">  </span><span class="c"># å¼•ç”¨ sk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">alidns-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">secret-key</span><span class="w">
</span></span></span></code></pre></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„ ClusterIssuer å¯¹è±¡æ¥æˆ–è€…è¯ä¹¦æ•°æ®äº†ï¼Œåˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„ Certificate èµ„æºå¯¹è±¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">qingyang-com-cert</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">qingyang-com-tls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*.qingyang.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">qingyang.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;*.qingyang.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging-dns01</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span></span></span></code></pre></div><p>åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨ Ingress èµ„æºå¯¹è±¡ä¸­ä½¿ç”¨ä¸Šé¢çš„ Secret å¯¹è±¡äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;letsencrypt-staging&#34;</span><span class="w">  </span><span class="c"># ä½¿ç”¨å“ªä¸ªissuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;*.qingyang.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">qingyang-com-tls  </span><span class="w"> </span><span class="c"># ç”¨äºå­˜å‚¨è¯ä¹¦çš„Secretå¯¹è±¡åå­—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">demo.qingyang.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>CacheDNSå’ŒDNSç¼“å­˜</title>
      <link>https://blog.mletter.cn/tech/kubernetes/nodelocaldns/</link>
      <pubDate>Sun, 26 Feb 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/nodelocaldns/</guid>
      <description>å¦‚æœåœ¨é›†ç¾¤è§„æ¨¡è¾ƒå¤§å¹¶å‘è¾ƒé«˜çš„æƒ…å†µä¸‹æˆ‘ä»¬ä»ç„¶éœ€è¦å¯¹ DNS è¿›è¡Œä¼˜åŒ–ï¼Œå…¸å‹çš„å°±æ˜¯å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„ CoreDNS ä¼šå‡ºç°è¶…æ—¶5sçš„æƒ…å†µã€‚</description>
      <content:encoded><![CDATA[<p>å¦‚æœåœ¨é›†ç¾¤è§„æ¨¡è¾ƒå¤§å¹¶å‘è¾ƒé«˜çš„æƒ…å†µä¸‹æˆ‘ä»¬ä»ç„¶éœ€è¦å¯¹ DNS è¿›è¡Œä¼˜åŒ–ï¼Œå…¸å‹çš„å°±æ˜¯å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„ CoreDNS ä¼šå‡ºç°è¶…æ—¶5sçš„æƒ…å†µã€‚</p>
<h2 id="è¶…æ—¶åŸå› ">è¶…æ—¶åŸå› </h2>
<p>åœ¨ iptables æ¨¡å¼ä¸‹ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰ï¼Œæ¯ä¸ªæœåŠ¡çš„ kube-proxy åœ¨ä¸»æœºç½‘ç»œåç§°ç©ºé—´çš„ nat è¡¨ä¸­åˆ›å»ºä¸€äº› iptables è§„åˆ™ã€‚ æ¯”å¦‚åœ¨é›†ç¾¤ä¸­å…·æœ‰ä¸¤ä¸ª DNS æœåŠ¡å™¨å®ä¾‹çš„ kube-dns æœåŠ¡ï¼Œå…¶ç›¸å…³è§„åˆ™å¤§è‡´å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>1<span class="o">)</span> -A PREROUTING -m comment --comment <span class="s2">&#34;kubernetes service portals&#34;</span> -j KUBE-SERVICES
</span></span><span class="line"><span class="cl">&lt;...&gt;
</span></span><span class="line"><span class="cl"><span class="o">(</span>2<span class="o">)</span> -A KUBE-SERVICES -d 10.96.0.10/32 -p udp -m comment --comment <span class="s2">&#34;kube-system/kube-dns:dns cluster IP&#34;</span> -m udp --dport <span class="m">53</span> -j KUBE-SVC-TCOU7JCQXEZGVUNU
</span></span><span class="line"><span class="cl">&lt;...&gt;
</span></span><span class="line"><span class="cl"><span class="o">(</span>3<span class="o">)</span> -A KUBE-SVC-TCOU7JCQXEZGVUNU -m comment --comment <span class="s2">&#34;kube-system/kube-dns:dns&#34;</span> -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-LLLB6FGXBLX6PZF7
</span></span><span class="line"><span class="cl"><span class="o">(</span>4<span class="o">)</span> -A KUBE-SVC-TCOU7JCQXEZGVUNU -m comment --comment <span class="s2">&#34;kube-system/kube-dns:dns&#34;</span> -j KUBE-SEP-LRVEW52VMYCOUSMZ
</span></span><span class="line"><span class="cl">&lt;...&gt;
</span></span><span class="line"><span class="cl"><span class="o">(</span>5<span class="o">)</span> -A KUBE-SEP-LLLB6FGXBLX6PZF7 -p udp -m comment --comment <span class="s2">&#34;kube-system/kube-dns:dns&#34;</span> -m udp -j DNAT --to-destination 10.32.0.6:53
</span></span><span class="line"><span class="cl">&lt;...&gt;
</span></span><span class="line"><span class="cl"><span class="o">(</span>6<span class="o">)</span> -A KUBE-SEP-LRVEW52VMYCOUSMZ -p udp -m comment --comment <span class="s2">&#34;kube-system/kube-dns:dns&#34;</span> -m udp -j DNAT --to-destination 10.32.0.7:53
</span></span></code></pre></div><p>æˆ‘ä»¬çŸ¥é“æ¯ä¸ª Pod çš„ <code>/etc/resolv.conf</code> æ–‡ä»¶ä¸­éƒ½æœ‰å¡«å……çš„ <code>nameserver 10.96.0.10</code> è¿™ä¸ªæ¡ç›®ã€‚æ‰€ä»¥æ¥è‡ª Pod çš„ DNS æŸ¥æ‰¾è¯·æ±‚å°†å‘é€åˆ° <code>10.96.0.10</code>ï¼Œè¿™æ˜¯ kube-dns æœåŠ¡çš„ ClusterIP åœ°å€ã€‚ ç”±äº <code>(1)</code> è¯·æ±‚è¿›å…¥ <code>KUBE-SERVICE</code> é“¾ï¼Œç„¶ååŒ¹é…è§„åˆ™ <code>(2)</code>ï¼Œæœ€åæ ¹æ® <code>(3)</code> çš„ random éšæœºæ¨¡å¼ï¼Œè·³è½¬åˆ° (5) æˆ– (6) æ¡ç›®ï¼Œå°†è¯·æ±‚ UDP æ•°æ®åŒ…çš„ç›®æ ‡ IP åœ°å€ä¿®æ”¹ä¸º DNS æœåŠ¡å™¨çš„<code>å®é™…</code> IP åœ°å€ï¼Œè¿™æ˜¯é€šè¿‡ <code>DNAT</code> å®Œæˆçš„ã€‚å…¶ä¸­ <code>10.32.0.6</code> å’Œ <code>10.32.0.7</code> æ˜¯æˆ‘ä»¬é›†ç¾¤ä¸­ CoreDNS çš„ä¸¤ä¸ª Pod å‰¯æœ¬çš„ IP åœ°å€ã€‚</p>
<h2 id="å†…æ ¸ä¸­çš„dnat">å†…æ ¸ä¸­çš„DNAT</h2>
<p><code>DNAT</code> çš„ä¸»è¦èŒè´£æ˜¯åŒæ—¶æ›´æ”¹ä¼ å‡ºæ•°æ®åŒ…çš„ç›®çš„åœ°ï¼Œå“åº”æ•°æ®åŒ…çš„æºï¼Œå¹¶ç¡®ä¿å¯¹æ‰€æœ‰åç»­æ•°æ®åŒ…è¿›è¡Œç›¸åŒçš„ä¿®æ”¹ã€‚åè€…ä¸¥é‡ä¾èµ–äºè¿æ¥è·Ÿè¸ªæœºåˆ¶ï¼Œä¹Ÿç§°ä¸º <code>conntrack</code>ï¼Œå®ƒè¢«å®ç°ä¸ºå†…æ ¸æ¨¡å—ã€‚<code>conntrack</code> ä¼šè·Ÿè¸ªç³»ç»Ÿä¸­æ­£åœ¨è¿›è¡Œçš„ç½‘ç»œè¿æ¥ã€‚</p>
<p><code>conntrack</code> ä¸­çš„æ¯ä¸ªè¿æ¥éƒ½ç”±ä¸¤ä¸ªå…ƒç»„è¡¨ç¤ºï¼Œä¸€ä¸ªå…ƒç»„ç”¨äºåŸå§‹è¯·æ±‚ï¼ˆIP_CT_DIR_ORIGINALï¼‰ï¼Œå¦ä¸€ä¸ªå…ƒç»„ç”¨äºç­”å¤ï¼ˆIP_CT_DIR_REPLYï¼‰ã€‚å¯¹äº UDPï¼Œæ¯ä¸ªå…ƒç»„éƒ½ç”±æº IP åœ°å€ï¼Œæºç«¯å£ä»¥åŠç›®æ ‡ IP åœ°å€å’Œç›®æ ‡ç«¯å£ç»„æˆï¼Œç­”å¤å…ƒç»„åŒ…å«å­˜å‚¨åœ¨src å­—æ®µä¸­çš„ç›®æ ‡çš„çœŸå®åœ°å€ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœ IP åœ°å€ä¸º <code>10.40.0.17</code> çš„ Pod å‘ kube-dns çš„ ClusterIP å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¯¥è¯·æ±‚è¢«è½¬æ¢ä¸º <code>10.32.0.6</code>ï¼Œåˆ™å°†åˆ›å»ºä»¥ä¸‹å…ƒç»„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">åŸå§‹ï¼šsrc <span class="o">=</span> 10.40.0.17 <span class="nv">dst</span> <span class="o">=</span> 10.96.0.10 <span class="nv">sport</span> <span class="o">=</span> <span class="m">53378</span> <span class="nv">dport</span> <span class="o">=</span> <span class="m">53</span>
</span></span><span class="line"><span class="cl">å›å¤ï¼šsrc <span class="o">=</span> 10.32.0.6 <span class="nv">dst</span> <span class="o">=</span> 10.40.0.17 <span class="nv">sport</span> <span class="o">=</span> <span class="m">53</span> <span class="nv">dport</span> <span class="o">=</span> <span class="m">53378</span>
</span></span></code></pre></div><p>é€šè¿‡è¿™äº›æ¡ç›®å†…æ ¸å¯ä»¥ç›¸åº”åœ°ä¿®æ”¹ä»»ä½•ç›¸å…³æ•°æ®åŒ…çš„ç›®çš„åœ°å’Œæºåœ°å€ï¼Œè€Œæ— éœ€å†æ¬¡éå† DNAT è§„åˆ™ï¼Œæ­¤å¤–ï¼Œå®ƒå°†çŸ¥é“å¦‚ä½•ä¿®æ”¹å›å¤ä»¥åŠåº”å°†å›å¤å‘é€ç»™è°ã€‚åˆ›å»º <code>conntrack</code> æ¡ç›®åï¼Œå°†é¦–å…ˆå¯¹å…¶è¿›è¡Œç¡®è®¤ï¼Œç„¶åå¦‚æœæ²¡æœ‰å·²ç¡®è®¤çš„ <code>conntrack</code> æ¡ç›®å…·æœ‰ç›¸åŒçš„åŸå§‹å…ƒç»„æˆ–å›å¤å…ƒç»„ï¼Œåˆ™å†…æ ¸å°†å°è¯•ç¡®è®¤è¯¥æ¡ç›®ã€‚</p>
<blockquote>
<p>å…·ä½“åŸå› å¯ä»¥å‚è€ƒ weave works æ€»ç»“çš„æ–‡ç«  <a class="link" href="https://www.weave.works/blog/racy-conntrack-and-dns-lookup-timeouts"  target="_blank" rel="noopener"
    >Racy conntrack and DNS lookup timeouts</a></p>
</blockquote>
<ul>
<li>åªæœ‰å¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ï¼Œå¹¶å‘ä»åŒä¸€ä¸ª socket å‘é€ç›¸åŒäº”å…ƒç»„çš„ UDP æŠ¥æ–‡æ—¶ï¼Œæ‰æœ‰ä¸€å®šæ¦‚ç‡ä¼šå‘ç”Ÿ</li>
<li>glibcã€muslï¼ˆalpine linux çš„ libc åº“ï¼‰éƒ½ä½¿ç”¨ <code>parallel query</code>, å°±æ˜¯å¹¶å‘å‘å‡ºå¤šä¸ªæŸ¥è¯¢è¯·æ±‚ï¼Œå› æ­¤å¾ˆå®¹æ˜“ç¢°åˆ°è¿™æ ·çš„å†²çªï¼Œé€ æˆæŸ¥è¯¢è¯·æ±‚è¢«ä¸¢å¼ƒ</li>
<li>ç”±äº ipvs ä¹Ÿä½¿ç”¨äº† conntrack, ä½¿ç”¨ kube-proxy çš„ ipvs æ¨¡å¼ï¼Œå¹¶ä¸èƒ½é¿å…è¿™ä¸ªé—®é¢˜</li>
</ul>
<h3 id="è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</h3>
<p>è¦å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜æœ€å¥½å½“ç„¶æ˜¯å†…æ ¸ä¸Šå» FIX æ‰è¿™ä¸ª BUGï¼Œé™¤äº†è¿™ç§æ–¹æ³•ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•æ¥è¿›è¡Œè§„é¿ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…ç›¸åŒäº”å…ƒç»„ DNSè¯·æ±‚çš„å¹¶å‘ã€‚</p>
<p>åœ¨ <code>resolv.conf</code> ä¸­å°±æœ‰ä¸¤ä¸ªç›¸å…³çš„å‚æ•°å¯ä»¥è¿›è¡Œé…ç½®ï¼š</p>
<ul>
<li><code>single-request-reopen</code>ï¼šå‘é€ A ç±»å‹è¯·æ±‚å’Œ AAAA ç±»å‹è¯·æ±‚ä½¿ç”¨ä¸åŒçš„æºç«¯å£ï¼Œè¿™æ ·ä¸¤ä¸ªè¯·æ±‚åœ¨ conntrack è¡¨ä¸­ä¸å ç”¨åŒä¸€ä¸ªè¡¨é¡¹ï¼Œä»è€Œé¿å…å†²çªã€‚</li>
<li><code>single-request</code>ï¼šé¿å…å¹¶å‘ï¼Œæ”¹ä¸ºä¸²è¡Œå‘é€ A ç±»å‹å’Œ AAAA ç±»å‹è¯·æ±‚ã€‚æ²¡æœ‰äº†å¹¶å‘ï¼Œä»è€Œä¹Ÿé¿å…äº†å†²çªã€‚</li>
</ul>
<ol>
<li>Pod çš„ postStart hook ä¸­æ·»åŠ </li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">postStart</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">/bin/sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- -<span class="l">c </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;/bin/echo &#39;options single-request-reopen&#39; &gt;&gt; /etc/resolv.conf&#34;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>ä½¿ç”¨ <code>template.spec.dnsConfig</code> é…ç½®</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dnsConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">options</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">single-request-reopen	</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>ä½¿ç”¨ ConfigMap è¦†ç›– Pod é‡Œé¢çš„ <code>/etc/resolv.conf</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># configmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resolv.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    nameserver 1.2.3.4
</span></span></span><span class="line"><span class="cl"><span class="sd">    search default.svc.cluster.local svc.cluster.local cluster.local
</span></span></span><span class="line"><span class="cl"><span class="sd">    options ndots:5 single-request-reopen timeout:1</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">resolvconf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Pod Spec</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">resolv-conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/resolv.conf   </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">resolv.conf </span><span class="w"> </span><span class="c"># åœ¨æŸä¸ªç›®å½•ä¸‹é¢æŒ‚è½½ä¸€ä¸ªæ–‡ä»¶ï¼ˆä¿è¯ä¸è¦†ç›–å½“å‰ç›®å½•ï¼‰éœ€è¦ä½¿ç”¨subPath -&gt; ä¸æ”¯æŒçƒ­æ›´æ–°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">resolv-conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">resolvconf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">items</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">resolv.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">resolv.conf</span><span class="w">
</span></span></span></code></pre></div><h2 id="nodelocal-dnscache">NodeLocal DNSCache</h2>
<p>NodeLocal DNSCache é€šè¿‡åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šä½œä¸º DaemonSet è¿è¡Œ DNS ç¼“å­˜ä»£ç†æ¥æé«˜é›†ç¾¤ DNS æ€§èƒ½ã€‚ åœ¨å½“ä»Šçš„ä½“ç³»ç»“æ„ä¸­ï¼Œè¿è¡Œåœ¨ <code>ClusterFirst</code> DNS æ¨¡å¼ä¸‹çš„ Pod å¯ä»¥è¿æ¥åˆ° kube-dns <code>serviceIP</code> è¿›è¡Œ DNS æŸ¥è¯¢ã€‚ é€šè¿‡ kube-proxy æ·»åŠ çš„ iptables è§„åˆ™å°†å…¶è½¬æ¢ä¸º kube-dns/CoreDNS ç«¯ç‚¹ã€‚ å€ŸåŠ©è¿™ç§æ–°æ¶æ„ï¼ŒPod å°†å¯ä»¥è®¿é—®åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ DNS ç¼“å­˜ä»£ç†ï¼Œä»è€Œé¿å… iptables DNAT è§„åˆ™å’Œè¿æ¥è·Ÿè¸ªã€‚ æœ¬åœ°ç¼“å­˜ä»£ç†å°†æŸ¥è¯¢ kube-dns æœåŠ¡ä»¥è·å–é›†ç¾¤ä¸»æœºåçš„ç¼“å­˜ç¼ºå¤±ï¼ˆé»˜è®¤ä¸º â€œ<code>cluster.local</code>â€ åç¼€ï¼‰ã€‚</p>
<h3 id="åŠ¨æœº">åŠ¨æœº</h3>
<ul>
<li>ä½¿ç”¨å½“å‰çš„ DNS ä½“ç³»ç»“æ„ï¼Œå¦‚æœæ²¡æœ‰æœ¬åœ° kube-dns/CoreDNS å®ä¾‹ï¼Œåˆ™å…·æœ‰æœ€é«˜ DNS QPS çš„ Pod å¯èƒ½å¿…é¡»å»¶ä¼¸åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ã€‚ åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œæ‹¥æœ‰æœ¬åœ°ç¼“å­˜å°†æœ‰åŠ©äºæ”¹å–„å»¶è¿Ÿã€‚</li>
<li>è·³è¿‡ iptables DNAT å’Œè¿æ¥è·Ÿè¸ªå°†æœ‰åŠ©äºå‡å°‘ <a class="link" href="https://github.com/kubernetes/kubernetes/issues/56903"  target="_blank" rel="noopener"
    >conntrack ç«äº‰</a>å¹¶é¿å… UDP DNS æ¡ç›®å¡«æ»¡ conntrack è¡¨ã€‚</li>
<li>ä»æœ¬åœ°ç¼“å­˜ä»£ç†åˆ° kube-dns æœåŠ¡çš„è¿æ¥å¯ä»¥å‡çº§ä¸º TCPã€‚ TCP conntrack æ¡ç›®å°†åœ¨è¿æ¥å…³é—­æ—¶è¢«åˆ é™¤ï¼Œç›¸å UDP æ¡ç›®å¿…é¡»è¶…æ—¶ ï¼ˆ<a class="link" href="https://www.kernel.org/doc/Documentation/networking/nf_conntrack-sysctl.txt"  target="_blank" rel="noopener"
    >é»˜è®¤</a> <code>nf_conntrack_udp_timeout</code> æ˜¯ 30 ç§’ï¼‰ã€‚</li>
<li>å°† DNS æŸ¥è¯¢ä» UDP å‡çº§åˆ° TCP å°†å‡å°‘ç”±äºè¢«ä¸¢å¼ƒçš„ UDP åŒ…å’Œ DNS è¶…æ—¶è€Œå¸¦æ¥çš„å°¾éƒ¨ç­‰å¾…æ—¶é—´ï¼› è¿™ç±»å»¶æ—¶é€šå¸¸é•¿è¾¾ 30 ç§’ï¼ˆ3 æ¬¡é‡è¯• + 10 ç§’è¶…æ—¶ï¼‰ã€‚ ç”±äº nodelocal ç¼“å­˜ç›‘å¬ UDP DNS æŸ¥è¯¢ï¼Œåº”ç”¨ä¸éœ€è¦å˜æ›´ã€‚</li>
<li>åœ¨èŠ‚ç‚¹çº§åˆ«å¯¹ DNS è¯·æ±‚çš„åº¦é‡å’Œå¯è§æ€§ã€‚</li>
<li>å¯ä»¥é‡æ–°å¯ç”¨è´Ÿç¼“å­˜ï¼Œä»è€Œå‡å°‘å¯¹ kube-dns æœåŠ¡çš„æŸ¥è¯¢æ•°é‡ã€‚</li>
</ul>
<p>å·¥ä½œåŸç†å¦‚ä¸‹</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="NodeLocal DNSCache æµ" loading="lazy" src="https://d33wubrfki0l68.cloudfront.net/bf8e5eaac697bac89c5b36a0edb8855c860bfb45/6944f/images/docs/nodelocaldns.svg"></p>
<p>æ­¤å›¾æ˜¾ç¤ºäº† NodeLocal DNSCache å¦‚ä½•å¤„ç† DNS æŸ¥è¯¢</p>
<h3 id="å®‰è£…nodelocaldns">å®‰è£…NodeLocalDNS</h3>
<p>ç›´æ¥ä»å®˜æ–¹çš„èµ„æºæ¸…å•å½“ä¸­è·å–å³å¯</p>
<ul>
<li><code>image</code>ï¼šé»˜è®¤é•œåƒå›½å†…æ˜¯ä¸‹è½½ä¸äº†çš„è¯·æ›´æ¢åœ°å€</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># ä¸‹è½½å®Œæˆè¯·æ›´æ¢imageåœ°å€ï¼š registry.cn-beijing.aliyuncs.com/custom_img/k8s-dns-node-cache:1.22.18</span>
</span></span></code></pre></div><p>æ³¨æ„èµ„æºæ¸…å•ä¸­çš„å‡ ä¸ªå˜é‡ä¿¡æ¯</p>
<ul>
<li><code>__PILLAR__DNS__SERVER__</code>ï¼šè¡¨ç¤º kube-dns è¿™ä¸ª Service çš„ ClusterIPã€‚</li>
<li><code>__PILLAR__LOCAL__DNS__</code>: è¡¨ç¤º DNSCache æœ¬åœ°çš„ IPï¼Œé»˜è®¤ä¸º <code>169.254.20.10</code></li>
<li><code>__PILLAR__DNS__DOMAIN__</code>: è¡¨ç¤ºé›†ç¾¤åŸŸï¼Œé»˜è®¤å°±æ˜¯ <code>cluster.local</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œè·å–</span>
</span></span><span class="line"><span class="cl">kubectl get svc kube-dns -n kube-system -o <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ä¿®æ”¹éƒ¨åˆ†å˜é‡ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/__PILLAR__DNS__SERVER__/10.10.0.10/g
</span></span></span><span class="line"><span class="cl"><span class="s1">s/__PILLAR__LOCAL__DNS__/169.254.20.10/g
</span></span></span><span class="line"><span class="cl"><span class="s1">s/__PILLAR__DNS__DOMAIN__/cluster.local/g&#39;</span> nodelocaldns.yaml 
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºèµ„æºé…ç½®æ¸…å•</span>
</span></span><span class="line"><span class="cl">kubectl apply -f nodelocaldns.yaml
</span></span></code></pre></div><ul>
<li>å¦‚æœ kube-proxy è¿è¡Œåœ¨ IPVS æ¨¡å¼(å› ä¸ºæˆ‘æ˜¯<code>ipvs</code>çš„æ¨¡å¼)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sed -i <span class="s2">&#34;s/__PILLAR__LOCAL__DNS__/</span><span class="nv">$localdns</span><span class="s2">/g; s/__PILLAR__DNS__DOMAIN__/</span><span class="nv">$domain</span><span class="s2">/g; s/,__PILLAR__DNS__SERVER__//g; s/__PILLAR__CLUSTER__DNS__/</span><span class="nv">$kubedns</span><span class="s2">/g&#34;</span> nodelocaldns.yaml
</span></span></code></pre></div><p>åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œnode-local-dns Pod åªä¼šä¾¦å¬ <code>&lt;node-local-address&gt;</code> çš„åœ°å€ã€‚ node-local-dns æ¥å£ä¸èƒ½ç»‘å®š kube-dns çš„é›†ç¾¤ IP åœ°å€ï¼Œå› ä¸º IPVS è´Ÿè½½å‡è¡¡ä½¿ç”¨çš„æ¥å£å·²ç»å ç”¨äº†è¯¥åœ°å€ã€‚ node-local-dns Pod ä¼šè®¾ç½® <code>__PILLAR__UPSTREAM__SERVERS__</code>ã€‚</p>
<p>æŸ¥çœ‹Podæ˜¯å¦è¿è¡ŒæˆåŠŸ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get pods -n kube-system | grep node-local-dns</span>
</span></span><span class="line"><span class="cl">node-local-dns-578vf                             1/1     Running   <span class="m">0</span>             5m23s
</span></span><span class="line"><span class="cl">node-local-dns-5jhcl                             1/1     Running   <span class="m">0</span>             5m23s
</span></span><span class="line"><span class="cl">node-local-dns-8hz5j                             1/1     Running   <span class="m">0</span>             5m23s
</span></span><span class="line"><span class="cl">node-local-dns-ch44w                             1/1     Running   <span class="m">0</span>             5m23s
</span></span><span class="line"><span class="cl">node-local-dns-jbg2p                             1/1     Running   <span class="m">0</span>             5m23s
</span></span><span class="line"><span class="cl">node-local-dns-t92ww                             1/1     Running   <span class="m">0</span>             5m23s
</span></span></code></pre></div><p>å¦‚æœ kube-proxy ç»„ä»¶ä½¿ç”¨çš„æ˜¯ ipvs æ¨¡å¼çš„è¯æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ kubelet çš„ <code>--cluster-dns</code> å‚æ•°ï¼Œå°†å…¶æŒ‡å‘ <code>169.254.20.10</code>ï¼ŒDaemonset ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªç½‘å¡æ¥ç»‘è¿™ä¸ª IPï¼ŒPod å‘æœ¬èŠ‚ç‚¹è¿™ä¸ª IP å‘ DNS è¯·æ±‚ï¼Œç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„æ—¶å€™æ‰ä¼šå†ä»£ç†åˆ°ä¸Šæ¸¸é›†ç¾¤ DNS è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<blockquote>
<p>å¦‚æœæ‹…å¿ƒçº¿ä¸Šç¯å¢ƒä¿®æ”¹ <code>--cluster-dns</code> å‚æ•°ä¼šäº§ç”Ÿå½±å“ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨æ–°éƒ¨ç½²çš„ Pod ä¸­é€šè¿‡ dnsConfig é…ç½®ä½¿ç”¨æ–°çš„ localdns çš„åœ°å€æ¥è¿›è¡Œè§£æã€‚</p>
</blockquote>
<ol>
<li>é€šè¿‡ä¿®æ”¹<code>--cluster-dns</code>å®ç°</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 1. é¦–å…ˆæŸ¥çœ‹å½“å‰çš„proxyæ¨¡å¼</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get cm kube-proxy -n kube-system -o yaml | grep mode</span>
</span></span><span class="line"><span class="cl">    mode: <span class="s2">&#34;ipvs&#34;</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/10.10.0.10/169.254.20.10/g&#39;</span> /var/lib/kubelet/config.yaml
</span></span><span class="line"><span class="cl">systemctl daemon-reload <span class="o">&amp;&amp;</span> systemctl restart kubelet
</span></span></code></pre></div><ol start="2">
<li>Podä¸­é€šè¿‡dnsConfigé…ç½®ä½¿ç”¨localdns</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">dnsConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nameservers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="m">169.254.20.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">searches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">default.svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">options</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ndots</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>ç”±äºæŒ‡å®š<code>nameservers</code>å±äº<code>append</code>æ“ä½œï¼Œå¦‚æœéœ€è¦å¿½ç•¥åŸæ¥çš„dnsåœ°å€è¯·ä½¿ç”¨<code>dnsPolicy: None</code></p>
</blockquote>
<h2 id="corednsçš„æ€§èƒ½ä¼˜åŒ–">CoreDnsçš„æ€§èƒ½ä¼˜åŒ–</h2>
<ol>
<li>åˆç†æ§åˆ¶CoreDNSçš„å‰¯æœ¬æ•°é‡</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl -n kube-system scale --replicas<span class="o">=</span><span class="m">10</span> deployment/coredns
</span></span></code></pre></div><ol start="2">
<li>ä¸º coredns å®šä¹‰ HPA è‡ªåŠ¨æ‰©ç¼©å®¹ã€‚</li>
<li>å®‰è£… <a class="link" href="https://github.com/kubernetes-sigs/cluster-proportional-autoscaler"  target="_blank" rel="noopener"
    >cluster-proportional-autoscaler</a> ä»¥å®ç°æ›´ç²¾ç¡®çš„æ‰©ç¼©å®¹(æ¨è)ã€‚</li>
<li>ç¦ç”¨IPv6</li>
</ol>
<p>å¦‚æœ K8S èŠ‚ç‚¹æ²¡æœ‰ç¦ç”¨ IPV6 çš„è¯ï¼Œå®¹å™¨å†…è¿›ç¨‹è¯·æ±‚ coredns æ—¶çš„é»˜è®¤è¡Œä¸ºæ˜¯åŒæ—¶å‘èµ· IPV4 å’Œ IPV6 è§£æï¼Œè€Œé€šå¸¸æˆ‘ä»¬åªéœ€è¦ç”¨åˆ° IPV4ï¼Œå½“å®¹å™¨è¯·æ±‚æŸä¸ªåŸŸåæ—¶ï¼Œcoredns è§£æä¸åˆ° IPV6 è®°å½•ï¼Œå°±ä¼š forward åˆ° upstream å»è§£æï¼Œå¦‚æœåˆ° upstream éœ€è¦ç»è¿‡è¾ƒé•¿æ—¶é—´(æ¯”å¦‚è·¨å…¬ç½‘ï¼Œè·¨æœºæˆ¿ä¸“çº¿)ï¼Œå°±ä¼šæ‹–æ…¢æ•´ä¸ªè§£ææµç¨‹çš„é€Ÿåº¦ï¼Œä¸šåŠ¡å±‚é¢å°±ä¼šæ„ŸçŸ¥ DNS è§£ææ…¢ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl edit cm coredns -n kube-system
</span></span></code></pre></div><p>Corefileä¸­æ·»åŠ ç¦ç”¨IPv6</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Corefile</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    .:53 {
</span></span></span><span class="line"><span class="cl"><span class="sd">        errors
</span></span></span><span class="line"><span class="cl"><span class="sd">        health {
</span></span></span><span class="line"><span class="cl"><span class="sd">           lameduck 5s
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">        # æ·»åŠ æ­¤å†…å®¹
</span></span></span><span class="line"><span class="cl"><span class="sd">        template ANY AAAA {
</span></span></span><span class="line"><span class="cl"><span class="sd">           rcode NXDOMAIN
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">        ...</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><ol>
<li>ä¼˜åŒ–ndots</li>
</ol>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes é›†ç¾¤ä¸­çš„åŸŸåè§£æå¾€å¾€éœ€è¦ç»è¿‡å¤šæ¬¡è¯·æ±‚æ‰èƒ½è§£æåˆ°ã€‚æŸ¥çœ‹ pod å†… çš„ <code>/etc/resolv.conf</code> å¯ä»¥çŸ¥é“ <code>ndots</code> é€‰é¡¹é»˜è®¤ä¸º 5</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@nginxv1-56f77cbc67-4v4fp:/# cat /etc/resolv.conf 
</span></span><span class="line"><span class="cl">search default.svc.cluster.local svc.cluster.local cluster.local
</span></span><span class="line"><span class="cl">nameserver 10.10.0.10
</span></span><span class="line"><span class="cl">options ndots:5
</span></span></code></pre></div><p>æ„æ€æ˜¯: å¦‚æœåŸŸåä¸­ <code>.</code> çš„æ•°é‡å°äº 5ï¼Œå°±ä¾æ¬¡éå† <code>search</code> ä¸­çš„åç¼€å¹¶æ‹¼æ¥ä¸Šè¿›è¡Œ DNS æŸ¥è¯¢ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ debug å‘½åç©ºé—´æŸ¥è¯¢ <code>kubernetes.default.svc.cluster.local</code> è¿™ä¸ª service:</p>
<ol>
<li>åŸŸåä¸­æœ‰4ä¸ª<code>.</code>å°äº5å°è¯•æ‹¼æ¥ä¸Šç¬¬ä¸€ä¸ª search è¿›è¡ŒæŸ¥è¯¢,ä¹Ÿå°±æ˜¯æŸ¥è¯¢å³<code>kubernetes.default.svc.cluster.local.debug.svc.cluster.local</code>æŸ¥ä¸åˆ°è¯¥åŸŸåã€‚</li>
<li>ç»§ç»­å°è¯• <code>kubernetes.default.svc.cluster.local.svc.cluster.local</code>ï¼ŒæŸ¥ä¸åˆ°è¯¥åŸŸåã€‚</li>
<li>ç»§ç»­å°è¯• <code>kubernetes.default.svc.cluster.local.cluster.local</code>ï¼Œä»ç„¶æŸ¥ä¸åˆ°è¯¥åŸŸåã€‚</li>
<li>å°è¯•ä¸åŠ åç¼€ï¼Œå³ <code>kubernetes.default.svc.cluster.local</code>ï¼ŒæŸ¥è¯¢æˆåŠŸï¼Œè¿”å›å“åº”çš„ ClusterIPã€‚</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç®€å•çš„ service åŸŸåè§£æéœ€è¦ç»è¿‡ 4 è½®è§£ææ‰èƒ½æˆåŠŸï¼Œé›†ç¾¤ä¸­å……æ–¥ç€å¤§é‡æ— ç”¨çš„ DNS è¯·æ±‚ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è®¾ç½®è¾ƒå°çš„ ndotsï¼Œåœ¨ Pod çš„ <code>dnsConfig</code> ä¸­å¯ä»¥è®¾ç½®</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginxv1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l">/dev/termination-log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">terminationMessagePolicy</span><span class="p">:</span><span class="w"> </span><span class="l">File</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># åŠ å…¥dnsConfigè¿›è¡Œè®¾ç½® </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dnsConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">options</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ndots</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åä¸šåŠ¡å‘è¯·æ±‚æ—¶å°½é‡å°† service åŸŸåæ‹¼å®Œæ•´ï¼Œè¿™æ ·å°±ä¸ä¼šç»è¿‡ search æ‹¼æ¥é€ æˆå¤§é‡å¤šä½™çš„ DNS è¯·æ±‚ã€‚</p>
<p>ä¸è¿‡è¿™æ ·ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„åŠæ³•å‘¢ï¼Ÿæœ‰çš„ï¼è¯·çœ‹ä¸‹é¢çš„ <code>autopath</code> æ–¹å¼ã€‚</p>
<ol>
<li>å¯ç”¨autopath</li>
</ol>
<p>å¯ç”¨ CoreDNS çš„ autopath æ’ä»¶å¯ä»¥é¿å…æ¯æ¬¡åŸŸåè§£æç»è¿‡å¤šæ¬¡è¯·æ±‚æ‰èƒ½è§£æåˆ°ï¼ŒåŸç†æ˜¯ CoreDNS æ™ºèƒ½è¯†åˆ«æ‹¼æ¥è¿‡ search çš„ DNS è§£æï¼Œç›´æ¥å“åº” CNAME å¹¶é™„ä¸Šç›¸åº”çš„ ClusterIPï¼Œä¸€æ­¥åˆ°ä½ï¼Œå¯ä»¥æå¤§å‡å°‘é›†ç¾¤å†… DNS è¯·æ±‚æ•°é‡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">kubectl -n kube-system edit configmap coredns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">&#34;Corefile&#34;: </span><span class="l">&#34;.:53 {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">errors</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">health {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="l">lameduck 5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">kubernetes cluster.local in-addr.arpa ip6.arpa {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="l">pods insecure</span><span class="w"> </span><span class="c"># ä¿®æ”¹ä¸º pods verified</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="l">fallthrough in-addr.arpa ip6.arpa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="l">ttl 30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">autopath @kubernetes</span><span class="w"> </span><span class="c"># æ·»åŠ autopath @kubernetes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">prometheus :9153</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">forward . /etc/resolv.conf {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="l">max_concurrent 1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">template ANY AAAA {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="l">rcode NXDOMAIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">cache 30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">loop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">reload</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">loadbalance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯ç”¨ autopath åï¼Œç”±äº coredns éœ€è¦ watch æ‰€æœ‰çš„ podï¼Œä¼šå¢åŠ  coredns çš„å†…å­˜æ¶ˆè€—ï¼Œæ ¹æ®æƒ…å†µé€‚å½“è°ƒèŠ‚ coredns çš„ <code>memory request</code> å’Œ limitã€‚</p>
<ul>
<li>æœ‰å…´è¶£çš„å¯ä»¥å»çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a class="link" href="https://draveness.me/dns-coredns/"  target="_blank" rel="noopener"
    >è¯¦è§£DNSå’ŒCoreDNS</a></li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>ä½¿ç”¨Kubeadmåˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„ETCDé›†ç¾¤</title>
      <link>https://blog.mletter.cn/tech/kubernetes/install-etcd-ha/</link>
      <pubDate>Sun, 26 Feb 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/install-etcd-ha/</guid>
      <description>é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeadm åœ¨æ¯ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªæœ¬åœ° etcd å®ä¾‹ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ etcd é›†ç¾¤ï¼Œå¹¶åœ¨ä¸åŒçš„ä¸»æœºä¸Šæä¾› etcd å®ä¾‹ã€‚ è¿™ä¸¤ç§æ–¹æ³•çš„åŒºåˆ«åœ¨ é«˜å¯ç”¨æ‹“æ‰‘çš„é€‰é¡¹ é¡µé¢ä¸­é˜è¿°ã€‚è¿™ä¸ªä»»åŠ¡å°†æŒ‡å¯¼ä½ åˆ›å»ºä¸€ä¸ªç”±ä¸‰ä¸ªæˆå‘˜ç»„æˆçš„é«˜å¯ç”¨å¤–éƒ¨ etcd é›†ç¾¤ï¼Œè¯¥é›†ç¾¤åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å¯è¢« kubeadm ä½¿ç”¨ã€‚</description>
      <content:encoded><![CDATA[<h2 id="ä½¿ç”¨kubeadmåˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„etcdé›†ç¾¤">ä½¿ç”¨Kubeadmåˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„Etcdé›†ç¾¤</h2>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeadm åœ¨æ¯ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªæœ¬åœ° etcd å®ä¾‹ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ etcd é›†ç¾¤ï¼Œå¹¶åœ¨ä¸åŒçš„ä¸»æœºä¸Šæä¾› etcd å®ä¾‹ã€‚ è¿™ä¸¤ç§æ–¹æ³•çš„åŒºåˆ«åœ¨ é«˜å¯ç”¨æ‹“æ‰‘çš„é€‰é¡¹ é¡µé¢ä¸­é˜è¿°ã€‚</p>
<p>è¿™ä¸ªä»»åŠ¡å°†æŒ‡å¯¼ä½ åˆ›å»ºä¸€ä¸ªç”±ä¸‰ä¸ªæˆå‘˜ç»„æˆçš„é«˜å¯ç”¨å¤–éƒ¨ etcd é›†ç¾¤ï¼Œè¯¥é›†ç¾¤åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å¯è¢« kubeadm ä½¿ç”¨ã€‚</p>
<h2 id="å‡†å¤‡å¼€å§‹">å‡†å¤‡å¼€å§‹</h2>
<ul>
<li>ä¸‰ä¸ªå¯ä»¥é€šè¿‡ 2379 å’Œ 2380 ç«¯å£ç›¸äº’é€šä¿¡çš„ä¸»æœºã€‚æœ¬æ–‡æ¡£ä½¿ç”¨è¿™äº›ä½œä¸ºé»˜è®¤ç«¯å£ã€‚ä¸è¿‡ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡ kubeadm çš„é…ç½®æ–‡ä»¶è¿›è¡Œè‡ªå®šä¹‰ã€‚</li>
<li>æ¯ä¸ªä¸»æœºå¿…é¡»å®‰è£… systemd å’Œ bash å…¼å®¹çš„ shellã€‚</li>
<li>æ¯å°ä¸»æœºå¿…é¡»å®‰è£…<code>æœ‰å®¹å™¨è¿è¡Œæ—¶</code>ã€<code>kubelet</code> å’Œ <code>kubeadm</code></li>
<li>æ¯ä¸ªä¸»æœºéƒ½åº”è¯¥èƒ½å¤Ÿè®¿é—® Kubernetes å®¹å™¨é•œåƒä»“åº“ (<a class="link" href="http://registry.k8s.io/"  target="_blank" rel="noopener"
    >registry.k8s.io</a>)ï¼Œ æˆ–è€…ä½¿ç”¨ kubeadm config images list/pull åˆ—å‡º/æ‹‰å–æ‰€éœ€çš„ etcd é•œåƒã€‚ æœ¬æŒ‡å—å°†æŠŠ etcd å®ä¾‹è®¾ç½®ä¸ºç”± kubelet ç®¡ç†çš„é™æ€ Podã€‚</li>
<li>ä¸€äº›å¯ä»¥ç”¨æ¥åœ¨ä¸»æœºé—´å¤åˆ¶æ–‡ä»¶çš„åŸºç¡€è®¾æ–½ã€‚ä¾‹å¦‚ ssh å’Œ scp å°±å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚</li>
</ul>
<blockquote>
<p>æœ¬æ¬¡å®¹å™¨è¿è¡Œæ—¶é‡‡ç”¨<code>Containerd</code>ä½œä¸ºRuntime</p>
</blockquote>
<h3 id="å°†kubeleté…ç½®ä¸ºetcdçš„æœåŠ¡å¯åŠ¨ç®¡ç†å™¨">å°†Kubeleté…ç½®ä¸ºEtcdçš„æœåŠ¡å¯åŠ¨ç®¡ç†å™¨</h3>
<blockquote>
<p>ä½ å¿…é¡»åœ¨è¦è¿è¡Œ etcd çš„æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œæ­¤æ“ä½œã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF &gt; /usr/lib/systemd/system/kubelet.service.d/20-etcd-service-manager.conf 
</span></span></span><span class="line"><span class="cl"><span class="s">[Service]
</span></span></span><span class="line"><span class="cl"><span class="s">ExecStart=
</span></span></span><span class="line"><span class="cl"><span class="s">ExecStart=/usr/bin/kubelet --address=127.0.0.1 --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=systemd  --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock
</span></span></span><span class="line"><span class="cl"><span class="s">Restart=always
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>å¯åŠ¨kubelet</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl daemon-reload
</span></span><span class="line"><span class="cl">systemctl restart kubelet
</span></span></code></pre></div><blockquote>
<p>æ³¨æ„: è¯·æ‰§è¡Œå®Œæ¯•ååŠ¡å¿…ç¡®ä¿<code>kubelet</code>å¤„äº<code>running</code>çŠ¶æ€ã€‚</p>
</blockquote>
<h3 id="ä¸ºkubeadmåˆ›å»ºé…ç½®æ–‡ä»¶">ä¸ºKubeadmåˆ›å»ºé…ç½®æ–‡ä»¶</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ä½¿ç”¨ä½ çš„ä¸»æœº IP æ›¿æ¢ HOST0ã€HOST1 å’Œ HOST2 çš„ IP åœ°å€</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HOST0</span><span class="o">=</span>10.1.6.48
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HOST1</span><span class="o">=</span>10.1.6.24
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HOST2</span><span class="o">=</span>10.1.6.45
</span></span><span class="line"><span class="cl"><span class="c1"># ä½¿ç”¨ä½ çš„ä¸»æœºåæ›´æ–° NAME0ã€NAME1 å’Œ NAME2</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NAME0</span><span class="o">=</span><span class="s2">&#34;containerd-master1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NAME1</span><span class="o">=</span><span class="s2">&#34;containerd-master2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NAME2</span><span class="o">=</span><span class="s2">&#34;containerd-master3&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºä¸´æ—¶ç›®å½•æ¥å­˜å‚¨å°†è¢«åˆ†å‘åˆ°å…¶å®ƒä¸»æœºä¸Šçš„æ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">mkdir -p /tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/ /tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/ /tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">HOSTS</span><span class="o">=(</span><span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span> <span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span> <span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">NAMES</span><span class="o">=(</span><span class="si">${</span><span class="nv">NAME0</span><span class="si">}</span> <span class="si">${</span><span class="nv">NAME1</span><span class="si">}</span> <span class="si">${</span><span class="nv">NAME2</span><span class="si">}</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="s2">&#34;</span><span class="si">${</span><span class="p">!HOSTS[@]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl"><span class="nv">HOST</span><span class="o">=</span><span class="si">${</span><span class="nv">HOSTS</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAMES</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF &gt; /tmp/${HOST}/kubeadmcfg.yaml
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: &#34;kubeadm.k8s.io/v1beta3&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">kind: InitConfiguration
</span></span></span><span class="line"><span class="cl"><span class="s">nodeRegistration:
</span></span></span><span class="line"><span class="cl"><span class="s">    name: ${NAME}
</span></span></span><span class="line"><span class="cl"><span class="s">localAPIEndpoint:
</span></span></span><span class="line"><span class="cl"><span class="s">    advertiseAddress: ${HOST}
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: &#34;kubeadm.k8s.io/v1beta3&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ClusterConfiguration
</span></span></span><span class="line"><span class="cl"><span class="s">etcd:
</span></span></span><span class="line"><span class="cl"><span class="s">    local:
</span></span></span><span class="line"><span class="cl"><span class="s">        dataDir: /var/lib/etcds
</span></span></span><span class="line"><span class="cl"><span class="s">        serverCertSANs:
</span></span></span><span class="line"><span class="cl"><span class="s">        - &#34;${HOST}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        peerCertSANs:
</span></span></span><span class="line"><span class="cl"><span class="s">        - &#34;${HOST}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        extraArgs:
</span></span></span><span class="line"><span class="cl"><span class="s">            initial-cluster: ${NAMES[0]}=https://${HOSTS[0]}:2380,${NAMES[1]}=https://${HOSTS[1]}:2380,${NAMES[2]}=https://${HOSTS[2]}:2380
</span></span></span><span class="line"><span class="cl"><span class="s">            initial-cluster-state: new
</span></span></span><span class="line"><span class="cl"><span class="s">            name: ${NAME}
</span></span></span><span class="line"><span class="cl"><span class="s">            listen-peer-urls: https://${HOST}:2380
</span></span></span><span class="line"><span class="cl"><span class="s">            listen-client-urls: https://${HOST}:2379
</span></span></span><span class="line"><span class="cl"><span class="s">            advertise-client-urls: https://${HOST}:2379
</span></span></span><span class="line"><span class="cl"><span class="s">            initial-advertise-peer-urls: https://${HOST}:2380
</span></span></span><span class="line"><span class="cl"><span class="s">imageRepository: registry.aliyuncs.com/google_containers
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><h3 id="ç”Ÿæˆè¯ä¹¦é¢å‘æœºæ„">ç”Ÿæˆè¯ä¹¦é¢å‘æœºæ„</h3>
<p>å¦‚æœä½ è¿˜æ²¡æœ‰ CAï¼Œåˆ™åœ¨ $HOST0ï¼ˆä½ ä¸º kubeadm ç”Ÿæˆé…ç½®æ–‡ä»¶çš„ä½ç½®ï¼‰ä¸Šè¿è¡Œæ­¤å‘½ä»¤ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init phase certs etcd-ca
</span></span></code></pre></div><ul>
<li>è¿™ä¸€æ“ä½œå°†ä¼šç”Ÿæˆ
<ul>
<li><code>/etc/kubernetes/pki/etcd/ca.crt</code></li>
<li><code>/etc/kubernetes/pki/etcd/ca.key</code></li>
</ul>
</li>
</ul>
<h3 id="ä¸ºæ¯ä¸ªæˆå‘˜åˆ›å»ºè¯ä¹¦">ä¸ºæ¯ä¸ªæˆå‘˜åˆ›å»ºè¯ä¹¦</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init phase certs etcd-server --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-peer --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-healthcheck-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs apiserver-etcd-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">cp -R /etc/kubernetes/pki /tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl"><span class="c1"># æ¸…ç†ä¸å¯é‡å¤ä½¿ç”¨çš„è¯ä¹¦</span>
</span></span><span class="line"><span class="cl">find /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-server --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-peer --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-healthcheck-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs apiserver-etcd-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">cp -R /etc/kubernetes/pki /tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">find /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># HOST0ä¸éœ€è¦è¿›è¡Œç§»åŠ¨</span>
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-server --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-peer --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs etcd-healthcheck-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span><span class="line"><span class="cl">kubeadm init phase certs apiserver-etcd-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span></code></pre></div><h3 id="å¤åˆ¶è¯ä¹¦å’Œ-kubeadm-é…ç½®">å¤åˆ¶è¯ä¹¦å’Œ kubeadm é…ç½®</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">scp -r /tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/* root@<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>:
</span></span><span class="line"><span class="cl">scp -r /tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/* root@<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>:
</span></span><span class="line"><span class="cl">chown -R root:root pki/
</span></span><span class="line"><span class="cl">mv pki /etc/kubernetes/
</span></span></code></pre></div><h3 id="è¯·æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨">è¯·æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨</h3>
<p>æ£€æŸ¥<code>$HOST0</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-master1 ~<span class="o">]</span><span class="c1"># tree /etc/kubernetes/pki/</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.crt
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.key
</span></span><span class="line"><span class="cl">â””â”€â”€ etcd
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ ca.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ ca.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ server.crt
</span></span><span class="line"><span class="cl">    â””â”€â”€ server.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> directory, <span class="m">10</span> files
</span></span></code></pre></div><p>æ£€æŸ¥<code>$HOST1</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-master2 ~<span class="o">]</span><span class="c1"># tree /etc/kubernetes/pki/</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.crt
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.key
</span></span><span class="line"><span class="cl">â””â”€â”€ etcd
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ ca.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ server.crt
</span></span><span class="line"><span class="cl">    â””â”€â”€ server.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> directory, <span class="m">9</span> files
</span></span></code></pre></div><p>æ£€æŸ¥<code>$HOST2</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-master3 ~<span class="o">]</span><span class="c1"># tree /etc/kubernetes/pki/</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.crt
</span></span><span class="line"><span class="cl">â”œâ”€â”€ apiserver-etcd-client.key
</span></span><span class="line"><span class="cl">â””â”€â”€ etcd
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ ca.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ healthcheck-client.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.crt
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ peer.key
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ server.crt
</span></span><span class="line"><span class="cl">    â””â”€â”€ server.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> directory, <span class="m">9</span> files
</span></span></code></pre></div><h3 id="åˆ›å»ºetcdçš„podæ¸…å•">åˆ›å»ºEtcdçš„Podæ¸…å•</h3>
<p>è¯·åœ¨<code>$HOST0</code>è¿›è¡Œæ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init phase etcd <span class="nb">local</span> --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
</span></span></code></pre></div><p>è¯·åœ¨<code>$HOST1</code>è¿›è¡Œæ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init phase etcd <span class="nb">local</span> --config<span class="o">=</span><span class="nv">$HOME</span>/kubeadmcfg.yaml
</span></span></code></pre></div><p>è¯·åœ¨<code>$HOST2</code>è¿›è¡Œæ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init phase etcd <span class="nb">local</span> --config<span class="o">=</span><span class="nv">$HOME</span>/kubeadmcfg.yaml
</span></span></code></pre></div><h3 id="æ£€æŸ¥etcdçš„podæ˜¯å¦è¿è¡Œ">æ£€æŸ¥Etcdçš„Podæ˜¯å¦è¿è¡Œ</h3>
<ul>
<li>ä¸‰å°Etcdä¸»æœºå…¨éƒ¨ä½¿ç”¨<code>crictl ps -a </code>è¿›è¡ŒæŸ¥çœ‹EtcdPodæ˜¯å¦å¤„äº<code>running</code>çŠ¶æ€</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-master1 ~<span class="o">]</span><span class="c1"># crictl ps -a</span>
</span></span><span class="line"><span class="cl">CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD
</span></span><span class="line"><span class="cl">0a183925d2542       <span class="m">0048118155842</span>       <span class="m">52</span> seconds ago      Running     
</span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>ConfigMapå’ŒSecretçš„ä½¿ç”¨</title>
      <link>https://blog.mletter.cn/tech/kubernetes/configmap-or-service/</link>
      <pubDate>Tue, 14 Feb 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/configmap-or-service/</guid>
      <description>ConfigMap æ˜¯ä¸€ç§ API å¯¹è±¡ï¼Œç”¨æ¥å°†éæœºå¯†æ€§çš„æ•°æ®ä¿å­˜åˆ°é”®å€¼å¯¹ä¸­ã€‚ä½¿ç”¨æ—¶ï¼Œ Pods å¯ä»¥å°†å…¶ç”¨ä½œç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°æˆ–è€…å­˜å‚¨å·ä¸­çš„é…ç½®æ–‡ä»¶ã€‚</description>
      <content:encoded><![CDATA[<h2 id="configmap">ConfigMap</h2>
<p>ConfigMap æ˜¯ä¸€ç§ API å¯¹è±¡ï¼Œç”¨æ¥å°†éæœºå¯†æ€§çš„æ•°æ®ä¿å­˜åˆ°é”®å€¼å¯¹ä¸­ã€‚ä½¿ç”¨æ—¶ï¼Œ <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/"  target="_blank" rel="noopener"
    >Pods</a> å¯ä»¥å°†å…¶ç”¨ä½œç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°æˆ–è€…å­˜å‚¨å·ä¸­çš„é…ç½®æ–‡ä»¶ã€‚</p>
<p>ConfigMap å°†ä½ çš„ç¯å¢ƒé…ç½®ä¿¡æ¯å’Œ <a class="link" href="https://kubernetes.io/zh-cn/docs/reference/glossary/?all=true#term-image"  target="_blank" rel="noopener"
    >å®¹å™¨é•œåƒ</a> è§£è€¦ï¼Œä¾¿äºåº”ç”¨é…ç½®çš„ä¿®æ”¹ã€‚
ConfigMap åœ¨è®¾è®¡ä¸Šä¸æ˜¯ç”¨æ¥ä¿å­˜å¤§é‡æ•°æ®çš„ã€‚åœ¨ ConfigMap ä¸­ä¿å­˜çš„æ•°æ®ä¸å¯è¶…è¿‡1MiB(è¿™å…¶å®æ˜¯ETCDçš„è¦æ±‚å“ˆå“ˆå“ˆ)ã€‚å¦‚æœä½ éœ€è¦ä¿å­˜è¶…å‡ºæ­¤å°ºå¯¸é™åˆ¶çš„æ•°æ®ï¼Œä½ å¯èƒ½å¸Œæœ›è€ƒè™‘æŒ‚è½½å­˜å‚¨å· æˆ–è€…ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“æˆ–è€…æ–‡ä»¶æœåŠ¡ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ª ConfigMap çš„ç¤ºä¾‹ï¼Œå®ƒçš„ä¸€äº›é”®åªæœ‰ä¸€ä¸ªå€¼ï¼Œå…¶ä»–é”®çš„å€¼çœ‹èµ·æ¥åƒæ˜¯ é…ç½®çš„ç‰‡æ®µæ ¼å¼ã€‚</p>
<ul>
<li>é€šè¿‡<code>Key</code>å’Œ<code>Value</code>è¿™ç§é”®å€¼å¯¹æ¥è¿›è¡Œå†™å…¥æ•°æ®</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">game-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># ç±»å±æ€§é”®ï¼›æ¯ä¸€ä¸ªé”®éƒ½æ˜ å°„åˆ°ä¸€ä¸ªç®€å•çš„å€¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">player_initial_lives</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ui_properties_file_name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;user-interface.properties&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># ç±»æ–‡ä»¶é”®,ä¸€èˆ¬ç”¨æ¥ä¿å­˜ä¸€ä¸ªæ–‡ä»¶åˆ°æŒ‡å®šç›®å½•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">game.properties</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    enemy.types=aliens,monsters
</span></span></span><span class="line"><span class="cl"><span class="sd">    player.maximum-lives=5    </span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">user-interface.properties</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    color.good=purple
</span></span></span><span class="line"><span class="cl"><span class="sd">    color.bad=yellow
</span></span></span><span class="line"><span class="cl"><span class="sd">    allow.textmode=true</span><span class="w">    
</span></span></span></code></pre></div><p>ä½ å¯ä»¥ä½¿ç”¨å››ç§æ–¹å¼æ¥ä½¿ç”¨ ConfigMap é…ç½® Pod ä¸­çš„å®¹å™¨ï¼š</p>
<ol>
<li>åœ¨å®¹å™¨å‘½ä»¤å’Œå‚æ•°å†…</li>
<li>å®¹å™¨çš„ç¯å¢ƒå˜é‡</li>
<li>åœ¨åªè¯»å·é‡Œé¢æ·»åŠ ä¸€ä¸ªæ–‡ä»¶ï¼Œè®©åº”ç”¨æ¥è¯»å–</li>
<li>ç¼–å†™ä»£ç åœ¨ Pod ä¸­è¿è¡Œï¼Œä½¿ç”¨ Kubernetes API æ¥è¯»å– ConfigMap</li>
</ol>
<h3 id="é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼ä½¿ç”¨configmap">é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼ä½¿ç”¨ConfigMap</h3>
<p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>Deployment</code>ç„¶åé€šè¿‡Envç¯å¢ƒå˜é‡çš„æ–¹å¼è¿›è¡Œä½¿ç”¨<code>ConfigMap</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web-beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l">beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web-beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-shop-beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">100Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼è¿›è¡ŒæŒ‚è½½</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PLAYER_INITIAL_LIVES</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">game-demo </span><span class="w"> </span><span class="c"># è¡¨ç¤ºå½“å‰é”®æ¥è‡ªgame-demoè¿™ä¸ªConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">player_initial_lives</span><span class="w"> </span><span class="c"># è¡¨ç¤ºå–player_initial_livesè¿™ä¸ªé”®çš„å†…å®¹</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ°Podå†…éƒ¨è¿›è¡Œ<code>echo</code>æŒ‚è½½çš„å˜é‡åæŸ¥çœ‹æ˜¯å¦æœ‰è¾“å‡º</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@nginx-web-beijing-d6d994854-d6tjk:/# <span class="nb">echo</span> <span class="nv">$PLAYER_INITIAL_LIVES</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span></code></pre></div><h3 id="å°†configmapå½“åšæ–‡ä»¶ä½¿ç”¨">å°†ConfigMapå½“åšæ–‡ä»¶ä½¿ç”¨</h3>
<ol>
<li>åˆ›å»ºä¸€ä¸ª ConfigMap å¯¹è±¡æˆ–è€…ä½¿ç”¨ç°æœ‰çš„ ConfigMap å¯¹è±¡ã€‚å¤šä¸ª Pod å¯ä»¥å¼•ç”¨åŒä¸€ä¸ª ConfigMapã€‚</li>
<li>ä¿®æ”¹ Pod å®šä¹‰ï¼Œåœ¨ <code>spec.volumes[]</code> ä¸‹æ·»åŠ ä¸€ä¸ªå·ã€‚ ä¸ºè¯¥å·è®¾ç½®ä»»æ„åç§°ï¼Œä¹‹åå°† <code>spec.volumes[].configMap.name</code> å­—æ®µè®¾ç½®ä¸ºå¯¹ä½ çš„ ConfigMap å¯¹è±¡çš„å¼•ç”¨ã€‚</li>
<li>ä¸ºæ¯ä¸ªéœ€è¦è¯¥ ConfigMap çš„å®¹å™¨æ·»åŠ ä¸€ä¸ª <code>.spec.containers[].volumeMounts[]</code>ã€‚ è®¾ç½® <code>.spec.containers[].volumeMounts[].readOnly=true</code> å¹¶å°† <code>.spec.containers[].volumeMounts[].mountPath</code> è®¾ç½®ä¸ºä¸€ä¸ªæœªä½¿ç”¨çš„ç›®å½•åï¼Œ ConfigMap çš„å†…å®¹å°†å‡ºç°åœ¨è¯¥ç›®å½•ä¸­ã€‚</li>
<li>æ›´æ”¹ä½ çš„é•œåƒæˆ–è€…å‘½ä»¤è¡Œï¼Œä»¥ä¾¿ç¨‹åºèƒ½å¤Ÿä»è¯¥ç›®å½•ä¸­æŸ¥æ‰¾æ–‡ä»¶ã€‚ConfigMap ä¸­çš„æ¯ä¸ª <code>data</code> é”®ä¼šå˜æˆ <code>mountPath</code> ä¸‹é¢çš„ä¸€ä¸ªæ–‡ä»¶åã€‚</li>
</ol>
<p>åˆ›å»ºä¸€ä¸ªæŒ‚è½½ConfigMapçš„<code>Deployment</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web-beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l">beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web-beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-shop-beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">100Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/vue-config&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">game-demo</span><span class="w">
</span></span></span></code></pre></div><p>è¿›å…¥å®¹å™¨ä¸­æŸ¥çœ‹<code>/etc/vue-config</code>ç›®å½•ä¸‹æ˜¯å¦æœ‰é…ç½®æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@nginx-web-beijing-5649b8f646-pzmm4:/etc/vue-config# ls
</span></span><span class="line"><span class="cl">service-interface.properties
</span></span><span class="line"><span class="cl">root@nginx-web-beijing-5649b8f646-pzmm4:/etc/vue-config# cat service-interface.properties  
</span></span><span class="line"><span class="cl">port: <span class="m">4000</span>
</span></span></code></pre></div><p>å¦‚æœ Pod ä¸­æœ‰å¤šä¸ªå®¹å™¨ï¼Œåˆ™æ¯ä¸ªå®¹å™¨éƒ½éœ€è¦è‡ªå·±çš„ <code>volumeMounts</code> å—ï¼Œä½†é’ˆå¯¹æ¯ä¸ª ConfigMapï¼Œä½ åªéœ€è¦è®¾ç½®ä¸€ä¸ª <code>spec.volumes</code> å—ã€‚</p>
<h3 id="è¢«æŒ‚è½½çš„configmapå†…å®¹ä¼šè¢«è‡ªåŠ¨æ›´æ–°">è¢«æŒ‚è½½çš„ConfigMapå†…å®¹ä¼šè¢«è‡ªåŠ¨æ›´æ–°</h3>
<p>å½“å·ä¸­ä½¿ç”¨çš„ ConfigMap è¢«æ›´æ–°æ—¶ï¼Œæ‰€æŠ•å°„çš„é”®æœ€ç»ˆä¹Ÿä¼šè¢«æ›´æ–°ã€‚ kubelet ç»„ä»¶ä¼šåœ¨æ¯æ¬¡å‘¨æœŸæ€§åŒæ­¥æ—¶æ£€æŸ¥æ‰€æŒ‚è½½çš„ ConfigMap æ˜¯å¦ä¸ºæœ€æ–°ã€‚ ä¸è¿‡ï¼Œkubelet ä½¿ç”¨çš„æ˜¯å…¶æœ¬åœ°çš„é«˜é€Ÿç¼“å­˜æ¥è·å¾— ConfigMap çš„å½“å‰å€¼ã€‚ é«˜é€Ÿç¼“å­˜çš„ç±»å‹å¯ä»¥é€šè¿‡ <a class="link" href="https://kubernetes.io/zh-cn/docs/reference/config-api/kubelet-config.v1beta1/"  target="_blank" rel="noopener"
    >KubeletConfiguration ç»“æ„</a>. çš„ <code>ConfigMapAndSecretChangeDetectionStrategy</code> å­—æ®µæ¥é…ç½®ã€‚</p>
<p>ConfigMap æ—¢å¯ä»¥é€šè¿‡ watch æ“ä½œå®ç°å†…å®¹ä¼ æ’­ï¼ˆé»˜è®¤å½¢å¼ï¼‰ï¼Œä¹Ÿå¯å®ç°åŸºäº TTL çš„ç¼“å­˜ï¼Œè¿˜å¯ä»¥ç›´æ¥ç»è¿‡æ‰€æœ‰è¯·æ±‚é‡å®šå‘åˆ° API æœåŠ¡å™¨ã€‚ å› æ­¤ï¼Œä» ConfigMap è¢«æ›´æ–°çš„é‚£ä¸€åˆ»ç®—èµ·ï¼Œåˆ°æ–°çš„ä¸»é”®è¢«æŠ•å°„åˆ° Pod ä¸­å»ï¼Œ è¿™ä¸€æ—¶é—´è·¨åº¦å¯èƒ½ä¸ kubelet çš„åŒæ­¥å‘¨æœŸåŠ ä¸Šé«˜é€Ÿç¼“å­˜çš„ä¼ æ’­å»¶è¿Ÿç›¸ç­‰ã€‚ è¿™é‡Œçš„ä¼ æ’­å»¶è¿Ÿå–å†³äºæ‰€é€‰çš„é«˜é€Ÿç¼“å­˜ç±»å‹ ï¼ˆåˆ†åˆ«å¯¹åº” watch æ“ä½œçš„ä¼ æ’­å»¶è¿Ÿã€é«˜é€Ÿç¼“å­˜çš„ TTL æ—¶é•¿æˆ–è€… 0ï¼‰ã€‚</p>
<blockquote>
<p>ä»¥ç¯å¢ƒå˜é‡æ–¹å¼ä½¿ç”¨çš„ ConfigMap æ•°æ®ä¸ä¼šè¢«è‡ªåŠ¨æ›´æ–°ã€‚ æ›´æ–°è¿™äº›æ•°æ®éœ€è¦é‡æ–°å¯åŠ¨ Podã€‚</p>
</blockquote>
<h2 id="secret">Secret</h2>
<p>Secret æ˜¯ä¸€ç§åŒ…å«å°‘é‡æ•æ„Ÿä¿¡æ¯ä¾‹å¦‚å¯†ç ã€ä»¤ç‰Œæˆ–å¯†é’¥çš„å¯¹è±¡ã€‚ è¿™æ ·çš„ä¿¡æ¯å¯èƒ½ä¼šè¢«æ”¾åœ¨ <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/"  target="_blank" rel="noopener"
    >Pod</a> è§„çº¦ä¸­æˆ–è€…é•œåƒä¸­ã€‚ ä½¿ç”¨ Secret æ„å‘³ç€ä½ ä¸éœ€è¦åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­åŒ…å«æœºå¯†æ•°æ®ã€‚</p>
<p>ç”±äºåˆ›å»º Secret å¯ä»¥ç‹¬ç«‹äºä½¿ç”¨å®ƒä»¬çš„ Podï¼Œ å› æ­¤åœ¨åˆ›å»ºã€æŸ¥çœ‹å’Œç¼–è¾‘ Pod çš„å·¥ä½œæµç¨‹ä¸­æš´éœ² Secretï¼ˆåŠå…¶æ•°æ®ï¼‰çš„é£é™©è¾ƒå°ã€‚ Kubernetes å’Œåœ¨é›†ç¾¤ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥å¯¹ Secret é‡‡å–é¢å¤–çš„é¢„é˜²æªæ–½ï¼Œ ä¾‹å¦‚é¿å…å°†æœºå¯†æ•°æ®å†™å…¥éæ˜“å¤±æ€§å­˜å‚¨ã€‚</p>
<p>Secret ç±»ä¼¼äº <a class="link" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/"  target="_blank" rel="noopener"
    >ConfigMap</a> ä½†ä¸“é—¨ç”¨äºä¿å­˜æœºå¯†æ•°æ®ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>: é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes Secret æœªåŠ å¯†åœ°å­˜å‚¨åœ¨ API æœåŠ¡å™¨çš„åº•å±‚æ•°æ®å­˜å‚¨ï¼ˆetcdï¼‰ä¸­ã€‚ ä»»ä½•æ‹¥æœ‰ API è®¿é—®æƒé™çš„äººéƒ½å¯ä»¥æ£€ç´¢æˆ–ä¿®æ”¹ Secretï¼Œä»»ä½•æœ‰æƒè®¿é—® etcd çš„äººä¹Ÿå¯ä»¥ã€‚ æ­¤å¤–ï¼Œä»»ä½•æœ‰æƒé™åœ¨å‘½åç©ºé—´ä¸­åˆ›å»º Pod çš„äººéƒ½å¯ä»¥ä½¿ç”¨è¯¥è®¿é—®æƒé™è¯»å–è¯¥å‘½åç©ºé—´ä¸­çš„ä»»ä½• Secretï¼› è¿™åŒ…æ‹¬é—´æ¥è®¿é—®ï¼Œä¾‹å¦‚åˆ›å»º Deployment çš„èƒ½åŠ›ã€‚</p>
</blockquote>
<p>ä¸ºäº†å®‰å…¨åœ°ä½¿ç”¨ Secretï¼Œè¯·è‡³å°‘æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>ä¸º Secret <a class="link" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/encrypt-data/"  target="_blank" rel="noopener"
    >å¯ç”¨é™æ€åŠ å¯†</a>ã€‚</li>
<li>ä»¥æœ€å°ç‰¹æƒè®¿é—® Secret å¹¶<a class="link" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authorization/"  target="_blank" rel="noopener"
    >å¯ç”¨æˆ–é…ç½® RBAC è§„åˆ™</a>ã€‚</li>
<li>é™åˆ¶ Secret å¯¹ç‰¹å®šå®¹å™¨çš„è®¿é—®ã€‚</li>
<li><a class="link" href="https://secrets-store-csi-driver.sigs.k8s.io/concepts.html#provider-for-the-secrets-store-csi-driver"  target="_blank" rel="noopener"
    >è€ƒè™‘ä½¿ç”¨å¤–éƒ¨ Secret å­˜å‚¨é©±åŠ¨</a>ã€‚</li>
</ol>
<h3 id="secretçš„ä½¿ç”¨">Secretçš„ä½¿ç”¨</h3>
<p>Pod å¯ä»¥ç”¨ä¸‰ç§æ–¹å¼ä¹‹ä¸€æ¥ä½¿ç”¨ Secretï¼š</p>
<ul>
<li>ä½œä¸ºæŒ‚è½½åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä¸Šçš„<a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/"  target="_blank" rel="noopener"
    >å·</a> ä¸­çš„<a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod"  target="_blank" rel="noopener"
    >æ–‡ä»¶</a>ã€‚</li>
<li>ä½œä¸º<a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#using-secrets-as-environment-variables"  target="_blank" rel="noopener"
    >å®¹å™¨çš„ç¯å¢ƒå˜é‡</a>ã€‚</li>
<li>ç”± <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#using-imagepullsecrets"  target="_blank" rel="noopener"
    >kubelet åœ¨ä¸º Pod æ‹‰å–é•œåƒæ—¶ä½¿ç”¨</a>ã€‚</li>
</ul>
<p>Kubernetesæ§åˆ¶é¢ä¹Ÿä½¿ç”¨ Secretï¼› ä¾‹å¦‚ï¼Œ<a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#bootstrap-token-secrets"  target="_blank" rel="noopener"
    >å¼•å¯¼ä»¤ç‰Œ Secret</a> æ˜¯ä¸€ç§å¸®åŠ©è‡ªåŠ¨åŒ–èŠ‚ç‚¹æ³¨å†Œçš„æœºåˆ¶ã€‚</p>
<p><code>Secret</code> ä¸»è¦ä½¿ç”¨çš„æœ‰ä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š</p>
<ul>
<li><code>Opaque</code>ï¼šbase64 ç¼–ç æ ¼å¼çš„ Secretï¼Œç”¨æ¥å­˜å‚¨å¯†ç ã€å¯†é’¥ç­‰ï¼›ä½†æ•°æ®ä¹Ÿå¯ä»¥é€šè¿‡<code>base64 â€“decode</code>è§£ç å¾—åˆ°åŸå§‹æ•°æ®ï¼Œæ‰€æœ‰åŠ å¯†æ€§å¾ˆå¼±ã€‚</li>
<li><code>kubernetes.io/dockerconfigjson</code>ï¼šç”¨æ¥å­˜å‚¨ç§æœ‰<code>docker registry</code>çš„è®¤è¯ä¿¡æ¯ã€‚</li>
<li><code>kubernetes.io/service-account-token</code>ï¼šç”¨äº <code>ServiceAccount</code>, ServiceAccount åˆ›å»ºæ—¶ Kubernetes ä¼šé»˜è®¤åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ Secret å¯¹è±¡ï¼ŒPod å¦‚æœä½¿ç”¨äº† ServiceAccountï¼Œå¯¹åº”çš„ Secret ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod ç›®å½• <code>/run/secrets/kubernetes.io/serviceaccount</code> ä¸­ã€‚</li>
<li><code>bootstrap.kubernetes.io/token</code>ï¼šç”¨äºèŠ‚ç‚¹æ¥å…¥é›†ç¾¤çš„æ ¡éªŒçš„ Secret</li>
</ul>
<h3 id="opaque-secretçš„ä½¿ç”¨">Opaque Secretçš„ä½¿ç”¨</h3>
<p><code>Opaque</code> ç±»å‹çš„æ•°æ®æ˜¯ä¸€ä¸ª map ç±»å‹ï¼Œè¦æ±‚ value å¿…é¡»æ˜¯ <code>base64</code> ç¼–ç æ ¼å¼ï¼Œæ¯”å¦‚æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªç”¨æˆ·åä¸º adminï¼Œå¯†ç ä¸º admin321 çš„ <code>Secret</code> å¯¹è±¡ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆæŠŠç”¨æˆ·åå’Œå¯†ç åš <code>base64</code> ç¼–ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># echo -n &#34;admin321&#34; | base64</span>
</span></span><span class="line"><span class="cl"><span class="nv">YWRtaW4zMjE</span><span class="o">=</span>
</span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ä¸Šé¢ç¼–ç è¿‡åçš„æ•°æ®æ¥ç¼–å†™ä¸€ä¸ª YAML æ–‡ä»¶ï¼š(opaque-demo.yaml)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">base-user-info</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">YWRtaW4=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">YWRtaW4zMjE=</span><span class="w">
</span></span></span></code></pre></div><p>åˆ›å»ºå¥½ <code>Secret</code>å¯¹è±¡åï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥ä½¿ç”¨å®ƒï¼š</p>
<ul>
<li>ä»¥ç¯å¢ƒå˜é‡çš„å½¢å¼</li>
<li>ä»¥Volumeçš„å½¢å¼æŒ‚è½½</li>
</ul>
<h3 id="é€šè¿‡ç¯å¢ƒå˜é‡æŒ‚è½½secret">é€šè¿‡ç¯å¢ƒå˜é‡æŒ‚è½½Secret</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web-beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l">beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web-beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vue-shop-beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">100Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">USERNAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">base-user-info</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">username</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PASSWORD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">base-user-info</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">password</span><span class="w">
</span></span></span></code></pre></div><h3 id="é€šè¿‡volumeæŒ‚è½½">é€šè¿‡VolumeæŒ‚è½½</h3>
<p>Secret æŠŠä¸¤ä¸ª key æŒ‚è½½æˆäº†ä¸¤ä¸ªå¯¹åº”çš„æ–‡ä»¶ã€‚å½“ç„¶å¦‚æœæƒ³è¦æŒ‚è½½åˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸Šé¢ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šä¸€èŠ‚è¯¾çš„æ–¹æ³•ï¼šåœ¨ <code>secretName</code> ä¸‹é¢æ·»åŠ  <code>items</code> æŒ‡å®š <code>key</code> å’Œ <code>path</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secret2-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secret2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;ls /etc/secrets&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secrets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/secrets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secrets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">base-user-info</span><span class="w">
</span></span></span></code></pre></div><p>ä¸€èˆ¬æ¥è¯´Podé»˜è®¤çš„è®¿é—®<code>API Server</code>çš„Tokenéƒ½ä¼šæŒ‚è½½åˆ°<code>/var/run/secrets/kubernetes.io/serviceaccount</code>å½“ä¸­,åˆ©ç”¨è‡ªå¸¦çš„<code>token</code>å’Œ<code>ca.crt</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰çš„Podéƒ½ä¼šè¢«æ³¨å…¥å½“å‰<code>namespace</code>ä¸‹çš„<code>token</code>å’Œ<code>ca.crt</code>è¿™æ ·ä»¥æ¥å°±å¯ä»¥å»è®¿é—®APIServeräº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@nginx-web-beijing-87c9f478f-knrfp:/var/run/secrets/kubernetes.io/serviceaccount# ls
</span></span><span class="line"><span class="cl">ca.crt  namespace  token
</span></span></code></pre></div><h3 id="kubernetesiodockerconfigjsonhttpkubernetesiodockerconfigjson"><a class="link" href="http://kubernetes.io/dockerconfigjson"  target="_blank" rel="noopener"
    >kubernetes.io/dockerconfigjson</a></h3>
<p>é™¤äº†ä¸Šé¢çš„ <code>Opaque</code> è¿™ç§ç±»å‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ¥åˆ›å»ºç”¨æˆ· <code>docker registry</code> è®¤è¯çš„ <code>Secret</code>ï¼Œç›´æ¥ä½¿ç”¨<code>kubectl create</code> å‘½ä»¤åˆ›å»ºå³å¯ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create secret docker-registry beijing-harbor --docker-server<span class="o">=</span>DOCKER_SERVER --docker-username<span class="o">=</span>DOCKER_USER --docker-password<span class="o">=</span>DOCKER_PASSWORD --docker-email<span class="o">=</span>DOCKER_EMAIL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl create secret docker-registry beijing-harbor --docker-server<span class="o">=</span>127.0.0.1 --docker-username<span class="o">=</span>admin --docker-password<span class="o">=</span><span class="m">123123</span> --docker-email<span class="o">=</span>beilanzhisen@163.com
</span></span></code></pre></div><p>é™¤äº†ä¸Šé¢è¿™ç§æ–¹æ³•ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šæ–‡ä»¶çš„æ–¹å¼æ¥åˆ›å»ºé•œåƒä»“åº“è®¤è¯ä¿¡æ¯ï¼Œéœ€è¦æ³¨æ„å¯¹åº”çš„ <code>KEY</code> å’Œ <code>TYPE</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create secret generic beijing-harbor --from-file<span class="o">=</span>.dockerconfigjson<span class="o">=</span>/root/.docker/config.json --type<span class="o">=</span>kubernetes.io/dockerconfigjson
</span></span></code></pre></div><p>å¦‚æœæˆ‘ä»¬éœ€è¦æ‹‰å–ç§æœ‰ä»“åº“ä¸­çš„ Docker é•œåƒçš„è¯å°±éœ€è¦ä½¿ç”¨åˆ°ä¸Šé¢çš„ myregistry è¿™ä¸ª <code>Secret</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">piVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.1.100</span><span class="p">:</span><span class="m">5000</span><span class="l">/test:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">beijing-harbor</span><span class="w">
</span></span></span></code></pre></div><p><code>ImagePullSecrets</code> ä¸ <code>Secrets</code> ä¸åŒï¼Œå› ä¸º <code>Secrets</code> å¯ä»¥æŒ‚è½½åˆ° Pod ä¸­ï¼Œä½†æ˜¯ <code>ImagePullSecrets</code> åªèƒ½ç”± Kubelet è®¿é—®ã€‚</p>
<h2 id="serviceaccount">ServiceAccount</h2>
<p><code>ServiceAccount</code> ä¸»è¦æ˜¯ç”¨äºè§£å†³ Pod åœ¨é›†ç¾¤ä¸­çš„èº«ä»½è®¤è¯é—®é¢˜çš„ã€‚è®¤è¯ä½¿ç”¨çš„æˆæƒä¿¡æ¯å…¶å®å°±æ˜¯åˆ©ç”¨å‰é¢æˆ‘ä»¬è®²åˆ°çš„ä¸€ä¸ªç±»å‹ä¸º <code>kubernetes.io/service-account-token</code> è¿›è¡Œç®¡ç†çš„ã€‚</p>
<p><code>ServiceAccount</code> æ˜¯å‘½åç©ºé—´çº§åˆ«çš„ï¼Œæ¯ä¸€ä¸ªå‘½åç©ºé—´åˆ›å»ºçš„æ—¶å€™å°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåä¸º <code>default</code> çš„ <code>ServiceAccount</code> å¯¹è±¡:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create ns kube-test
</span></span><span class="line"><span class="cl">kubectl get secret -n kube-test
</span></span><span class="line"><span class="cl">NAME                  TYPE                                  DATA   AGE
</span></span><span class="line"><span class="cl">default-token-vn4tr   kubernetes.io/service-account-token   <span class="m">3</span>      2m27s
</span></span></code></pre></div><h3 id="å®ç°åŸç†">å®ç°åŸç†</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ca.crt</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">a3ViZS10ZXN0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">ZXlKaG...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/service-account.name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/service-account.uid</span><span class="p">:</span><span class="w"> </span><span class="l">75b3314b-e949-4f7b-9450-9bcd89c8c972</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-11-23T04:19:47Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default-token-vn4tr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4297521&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l">/api/v1/namespaces/kube-test/secrets/default-token-vn4tr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">e3e60f95-f255-471b-a6c0-600a3c0ee53a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/service-account-token</span><span class="w">
</span></span></span></code></pre></div><p>åœ¨ <code>data</code> åŒºåŸŸæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰3ä¸ªä¿¡æ¯ï¼š</p>
<ul>
<li><code>ca.crt</code>ï¼šç”¨äºæ ¡éªŒæœåŠ¡ç«¯çš„è¯ä¹¦ä¿¡æ¯</li>
<li><code>namespace</code>ï¼šè¡¨ç¤ºå½“å‰ç®¡ç†çš„å‘½åç©ºé—´</li>
<li><code>token</code>ï¼šç”¨äº Pod èº«ä»½è®¤è¯çš„ Token</li>
</ul>
<p>å‰é¢æˆ‘ä»¬ä¹Ÿæåˆ°äº†é»˜è®¤æƒ…å†µä¸‹å½“å‰ namespace ä¸‹é¢çš„ Pod ä¼šé»˜è®¤ä½¿ç”¨ <code>default</code> è¿™ä¸ª ServiceAccountï¼Œå¯¹åº”çš„ <code>Secret</code> ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„ <code>/var/run/secrets/kubernetes.io/serviceaccount/</code> ç›®å½•ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ Pod é‡Œé¢è·å–åˆ°ç”¨äºèº«ä»½è®¤è¯çš„ä¿¡æ¯äº†ã€‚</p>
<p>å®é™…ä¸Šè¿™ä¸ªè‡ªåŠ¨æŒ‚è½½è¿‡ç¨‹æ˜¯åœ¨ Pod åˆ›å»ºçš„æ—¶å€™é€šè¿‡ <code>Admisson Controllerï¼ˆå‡†å…¥æ§åˆ¶å™¨ï¼‰</code> æ¥å®ç°çš„ï¼Œå…³äºå‡†å…¥æ§åˆ¶å™¨çš„è¯¦ç»†ä¿¡æ¯æˆ‘ä»¬ä¼šåœ¨åé¢çš„å®‰å…¨ç« èŠ‚ä¸­å’Œå¤§å®¶ç»§ç»­å­¦ä¹ ã€‚</p>
<blockquote>
<p><code>Admission Controllerï¼ˆå‡†å…¥æ§åˆ¶ï¼‰</code>æ˜¯ Kubernetes API Server ç”¨äºæ‹¦æˆªè¯·æ±‚çš„ä¸€ç§æ‰‹æ®µã€‚<code>Admission</code> å¯ä»¥åšåˆ°å¯¹è¯·æ±‚çš„èµ„æºå¯¹è±¡è¿›è¡Œæ ¡éªŒï¼Œä¿®æ”¹ï¼ŒPod åˆ›å»ºæ—¶ <code>Admission Controller</code> ä¼šæ ¹æ®æŒ‡å®šçš„çš„ <code>ServiceAccount</code>ï¼ˆé»˜è®¤çš„ defaultï¼‰æŠŠå¯¹åº”çš„ <code>Secret</code> æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„å›ºå®šç›®å½•ä¸‹ <code>/var/run/secrets/kubernetes.io/serviceaccount/</code>ã€‚</p>
</blockquote>
]]></content:encoded>
    </item>
    <item>
      <title>HorizontalPodAutoscaler</title>
      <link>https://blog.mletter.cn/tech/kubernetes/horizontal-pod-autoscaler/</link>
      <pubDate>Tue, 14 Feb 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/horizontal-pod-autoscaler/</guid>
      <description>åœ¨Kubernetes ä¸­HorizontalPodAutoscalerè‡ªåŠ¨æ›´æ–°å·¥ä½œè´Ÿè½½èµ„æº ï¼ˆä¾‹å¦‚ Deployment æˆ–è€… StatefulSetï¼‰ï¼Œ ç›®çš„æ˜¯è‡ªåŠ¨æ‰©ç¼©å·¥ä½œè´Ÿè½½ä»¥æ»¡è¶³éœ€æ±‚ã€‚</description>
      <content:encoded><![CDATA[<h2 id="horizontalpodautoscaler">HorizontalPodAutoscaler</h2>
<ul>
<li><a class="link" href="https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/"  target="_blank" rel="noopener"
    >HPAå®˜æ–¹æ–‡æ¡£</a></li>
</ul>
<p>åœ¨Kubernetes ä¸­<code>HorizontalPodAutoscaler</code>è‡ªåŠ¨æ›´æ–°å·¥ä½œè´Ÿè½½èµ„æº ï¼ˆä¾‹å¦‚ <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/"  target="_blank" rel="noopener"
    >Deployment</a> æˆ–è€… <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/"  target="_blank" rel="noopener"
    >StatefulSet</a>ï¼‰ï¼Œ ç›®çš„æ˜¯è‡ªåŠ¨æ‰©ç¼©å·¥ä½œè´Ÿè½½ä»¥æ»¡è¶³éœ€æ±‚ã€‚</p>
<p>æ°´å¹³æ‰©ç¼©æ„å‘³ç€å¯¹å¢åŠ çš„è´Ÿè½½çš„å“åº”æ˜¯éƒ¨ç½²æ›´å¤šçš„ <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/"  target="_blank" rel="noopener"
    >Pod</a>ã€‚ è¿™ä¸å‚ç›´(Vertical)æ‰©ç¼©ä¸åŒï¼Œå¯¹äº Kubernetesï¼Œ å‚ç›´æ‰©ç¼©æ„å‘³ç€å°†æ›´å¤šèµ„æºï¼ˆä¾‹å¦‚ï¼šå†…å­˜æˆ– CPUï¼‰åˆ†é…ç»™å·²ç»ä¸ºå·¥ä½œè´Ÿè½½è¿è¡Œçš„ Podã€‚</p>
<p>å¦‚æœè´Ÿè½½å‡å°‘ï¼Œå¹¶ä¸”Podçš„æ•°é‡é«˜äºé…ç½®çš„æœ€å°å€¼ï¼Œ<code>HorizontalPodAutoscaler</code> ä¼šæŒ‡ç¤ºå·¥ä½œè´Ÿè½½èµ„æºï¼ˆDeploymentã€StatefulSet æˆ–å…¶ä»–ç±»ä¼¼èµ„æºï¼‰ç¼©å‡ã€‚</p>
<blockquote>
<p>æ°´å¹³Podè‡ªåŠ¨æ‰©ç¼©ä¸é€‚ç”¨äºæ— æ³•æ‰©ç¼©çš„å¯¹è±¡: ä¾‹å¦‚DemonSetè¿™ç§</p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥ç®€å•çš„é€šè¿‡ <code>kubectl autoscale</code> å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ª HPA èµ„æºå¯¹è±¡ï¼Œ<code>HPA Controller</code>é»˜è®¤<code>30s</code>è½®è¯¢ä¸€æ¬¡ï¼ˆå¯é€šè¿‡ <code>kube-controller-manager</code> çš„<code>--horizontal-pod-autoscaler-sync-period</code> å‚æ•°è¿›è¡Œè®¾ç½®ï¼‰ï¼ŒæŸ¥è¯¢æŒ‡å®šçš„èµ„æºä¸­çš„ Pod èµ„æºä½¿ç”¨ç‡ï¼Œå¹¶ä¸”ä¸åˆ›å»ºæ—¶è®¾å®šçš„å€¼å’ŒæŒ‡æ ‡åšå¯¹æ¯”ï¼Œä»è€Œå®ç°è‡ªåŠ¨ä¼¸ç¼©çš„åŠŸèƒ½ã€‚</p>
<h3 id="horizontalpodautoscaler-æ˜¯å¦‚ä½•å·¥ä½œçš„">HorizontalPodAutoscaler æ˜¯å¦‚ä½•å·¥ä½œçš„</h3>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="å·¥ä½œå›¾" loading="lazy" src="https://bj.bcebos.com/baidu-rmb-video-cover-1/2f7f46bc72825e43f55f683e9ebefdd3.png"></p>
<p>Kubernetes å°†æ°´å¹³ Pod è‡ªåŠ¨æ‰©ç¼©å®ç°ä¸ºä¸€ä¸ªé—´æ­‡è¿è¡Œçš„æ§åˆ¶å›è·¯ï¼ˆå®ƒä¸æ˜¯ä¸€ä¸ªè¿ç»­çš„è¿‡ç¨‹ï¼‰ã€‚é—´éš”ç”± <a class="link" href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-controller-manager/"  target="_blank" rel="noopener"
    ><code>kube-controller-manager</code></a> çš„ <code>--horizontal-pod-autoscaler-sync-period</code> å‚æ•°è®¾ç½®ï¼ˆé»˜è®¤é—´éš”ä¸º 15 ç§’ï¼‰ã€‚</p>
<p>åœ¨æ¯ä¸ªæ—¶é—´æ®µå†…ï¼Œæ§åˆ¶å™¨ç®¡ç†å™¨éƒ½ä¼šæ ¹æ®æ¯ä¸ª HorizontalPodAutoscaler å®šä¹‰ä¸­æŒ‡å®šçš„æŒ‡æ ‡æŸ¥è¯¢èµ„æºåˆ©ç”¨ç‡ã€‚ æ§åˆ¶å™¨ç®¡ç†å™¨æ‰¾åˆ°ç”± <code>scaleTargetRef</code> å®šä¹‰çš„ç›®æ ‡èµ„æºï¼Œç„¶åæ ¹æ®ç›®æ ‡èµ„æºçš„ <code>.spec.selector</code> æ ‡ç­¾é€‰æ‹© Podï¼Œ å¹¶ä»èµ„æºæŒ‡æ ‡ APIï¼ˆé’ˆå¯¹æ¯ä¸ª Pod çš„èµ„æºæŒ‡æ ‡ï¼‰æˆ–è‡ªå®šä¹‰æŒ‡æ ‡è·å–æŒ‡æ ‡ APIï¼ˆé€‚ç”¨äºæ‰€æœ‰å…¶ä»–æŒ‡æ ‡ï¼‰</p>
<ul>
<li>å¯¹äºæŒ‰ Pod ç»Ÿè®¡çš„èµ„æºæŒ‡æ ‡ï¼ˆå¦‚ CPUï¼‰ï¼Œæ§åˆ¶å™¨ä»èµ„æºæŒ‡æ ‡ API ä¸­è·å–æ¯ä¸€ä¸ª HorizontalPodAutoscaler æŒ‡å®šçš„ Pod çš„åº¦é‡å€¼ï¼Œå¦‚æœè®¾ç½®äº†ç›®æ ‡ä½¿ç”¨ç‡ï¼Œæ§åˆ¶å™¨è·å–æ¯ä¸ª Pod ä¸­çš„å®¹å™¨<a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/configuration/manage-resources-containers/#requests-and-limits"  target="_blank" rel="noopener"
    >èµ„æºä½¿ç”¨</a>æƒ…å†µï¼Œ å¹¶è®¡ç®—èµ„æºä½¿ç”¨ç‡ã€‚å¦‚æœè®¾ç½®äº† target å€¼ï¼Œå°†ç›´æ¥ä½¿ç”¨åŸå§‹æ•°æ®ï¼ˆä¸å†è®¡ç®—ç™¾åˆ†æ¯”ï¼‰ã€‚ æ¥ä¸‹æ¥ï¼Œæ§åˆ¶å™¨æ ¹æ®å¹³å‡çš„èµ„æºä½¿ç”¨ç‡æˆ–åŸå§‹å€¼è®¡ç®—å‡ºæ‰©ç¼©çš„æ¯”ä¾‹ï¼Œè¿›è€Œè®¡ç®—å‡ºç›®æ ‡å‰¯æœ¬æ•°ã€‚</li>
<li>å¦‚æœ Pod ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ç¤ºï¼Œæ§åˆ¶å™¨æœºåˆ¶ä¸èµ„æºæŒ‡æ ‡ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºè‡ªå®šä¹‰æŒ‡æ ‡åªä½¿ç”¨åŸå§‹å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç‡ã€‚</li>
<li>å¦‚æœ Pod ä½¿ç”¨å¯¹è±¡æŒ‡æ ‡å’Œå¤–éƒ¨æŒ‡æ ‡ï¼ˆæ¯ä¸ªæŒ‡æ ‡æè¿°ä¸€ä¸ªå¯¹è±¡ä¿¡æ¯ï¼‰ã€‚ è¿™ä¸ªæŒ‡æ ‡å°†ç›´æ¥æ ¹æ®ç›®æ ‡è®¾å®šå€¼ç›¸æ¯”è¾ƒï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªä¸Šé¢æåˆ°çš„æ‰©ç¼©æ¯”ä¾‹ã€‚ åœ¨ <code>autoscaling/v2</code> ç‰ˆæœ¬ API ä¸­ï¼Œè¿™ä¸ªæŒ‡æ ‡ä¹Ÿå¯ä»¥æ ¹æ® Pod æ•°é‡å¹³åˆ†åå†è®¡ç®—ã€‚</li>
</ul>
<p><code>HorizontalPodAutoscaler</code>çš„å¸¸è§ç”¨é€”æ˜¯å°†å…¶é…ç½®ä¸ºä»<a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/"  target="_blank" rel="noopener"
    >èšåˆ API</a> ï¼ˆ<code>metrics.k8s.io</code>ã€<code>custom.metrics.k8s.io</code> æˆ– <code>external.metrics.k8s.io</code>ï¼‰è·å–æŒ‡æ ‡ã€‚ <code>metrics.k8s.io</code> API é€šå¸¸ç”±åä¸º<code>Metrics Server</code>çš„æ’ä»¶æä¾›ï¼Œéœ€è¦å•ç‹¬å¯åŠ¨ã€‚æœ‰å…³èµ„æºæŒ‡æ ‡çš„æ›´å¤šä¿¡æ¯ï¼Œ è¯·å‚é˜… <a class="link" href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/#metrics-server"  target="_blank" rel="noopener"
    >Metrics Server</a>ã€‚</p>
<h3 id="metrics-server">Metrics-Server</h3>
<p>åœ¨ HPA çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ <code>Heapster</code> æä¾› CPU å’Œå†…å­˜æŒ‡æ ‡ï¼Œåœ¨ HPA v2 è¿‡åå°±éœ€è¦å®‰è£… Metrcis Server äº†ï¼Œ<code>Metrics Server</code> å¯ä»¥é€šè¿‡æ ‡å‡†çš„ Kubernetes API æŠŠç›‘æ§æ•°æ®æš´éœ²å‡ºæ¥ï¼Œæœ‰äº† <code>Metrics Server</code> ä¹‹åï¼Œæˆ‘ä»¬å°±å®Œå…¨å¯ä»¥é€šè¿‡æ ‡å‡†çš„ Kubernetes API æ¥è®¿é—®æˆ‘ä»¬æƒ³è¦è·å–çš„ç›‘æ§æ•°æ®äº†ï¼š</p>
<pre tabindex="0"><code class="language-bahs" data-lang="bahs">https://api.k8s.io:8443/metrics.k8s.io/v1beta1/namespaces/&lt;namespace-name&gt;/pods/&lt;pod-name&gt;
</code></pre><p>æ¯”å¦‚å½“æˆ‘ä»¬è®¿é—®ä¸Šé¢çš„ API çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°è¯¥ Pod çš„èµ„æºæ•°æ®ï¼Œè¿™äº›æ•°æ®å…¶å®æ˜¯æ¥è‡ªäº kubelet çš„ <code>Summary API</code> é‡‡é›†è€Œæ¥çš„ã€‚ä¸è¿‡éœ€è¦è¯´æ˜çš„æ˜¯æˆ‘ä»¬è¿™é‡Œå¯ä»¥é€šè¿‡æ ‡å‡†çš„ API æ¥è·å–èµ„æºç›‘æ§æ•°æ®ï¼Œå¹¶ä¸æ˜¯å› ä¸º <code>Metrics Server</code> å°±æ˜¯ APIServer çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯é€šè¿‡ Kubernetes æä¾›çš„ <code>Aggregator</code> æ±‡èšæ’ä»¶æ¥å®ç°çš„ï¼Œæ˜¯ç‹¬ç«‹äº APIServer ä¹‹å¤–è¿è¡Œçš„ã€‚</p>
<h3 id="èšåˆ-api">èšåˆ API</h3>
<p><code>Aggregator</code> å…è®¸å¼€å‘äººå‘˜ç¼–å†™ä¸€ä¸ªè‡ªå·±çš„æœåŠ¡ï¼ŒæŠŠè¿™ä¸ªæœåŠ¡æ³¨å†Œåˆ° Kubernetes çš„ APIServer é‡Œé¢å»ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åƒåŸç”Ÿçš„ APIServer æä¾›çš„ API ä½¿ç”¨è‡ªå·±çš„ API äº†ï¼Œæˆ‘ä»¬æŠŠè‡ªå·±çš„æœåŠ¡è¿è¡Œåœ¨ Kubernetes é›†ç¾¤é‡Œé¢ï¼Œç„¶å Kubernetes çš„ <code>Aggregator</code> é€šè¿‡ Service åç§°å°±å¯ä»¥è½¬å‘åˆ°æˆ‘ä»¬è‡ªå·±å†™çš„ Service é‡Œé¢å»äº†ã€‚è¿™æ ·è¿™ä¸ªèšåˆå±‚å°±å¸¦æ¥äº†å¾ˆå¤šå¥½å¤„ï¼š</p>
<ul>
<li>å¢åŠ äº† API çš„æ‰©å±•æ€§ï¼Œå¼€å‘äººå‘˜å¯ä»¥ç¼–å†™è‡ªå·±çš„ API æœåŠ¡æ¥æš´éœ²ä»–ä»¬æƒ³è¦çš„ APIã€‚</li>
<li>ä¸°å¯Œäº† APIï¼Œæ ¸å¿ƒ kubernetes å›¢é˜Ÿé˜»æ­¢äº†å¾ˆå¤šæ–°çš„ API ææ¡ˆï¼Œé€šè¿‡å…è®¸å¼€å‘äººå‘˜å°†ä»–ä»¬çš„ API ä½œä¸ºå•ç‹¬çš„æœåŠ¡å…¬å¼€ï¼Œè¿™æ ·å°±æ— é¡»ç¤¾åŒºç¹æ‚çš„å®¡æŸ¥äº†ã€‚</li>
<li>å¼€å‘åˆ†é˜¶æ®µå®éªŒæ€§ APIï¼Œæ–°çš„ API å¯ä»¥åœ¨å•ç‹¬çš„èšåˆæœåŠ¡ä¸­å¼€å‘ï¼Œå½“å®ƒç¨³å®šä¹‹åï¼Œåœ¨åˆå¹¶ä¼š APIServer å°±å¾ˆå®¹æ˜“äº†ã€‚</li>
<li>ç¡®ä¿æ–° API éµå¾ª Kubernetes çº¦å®šï¼Œå¦‚æœæ²¡æœ‰è¿™é‡Œæå‡ºçš„æœºåˆ¶ï¼Œç¤¾åŒºæˆå‘˜å¯èƒ½ä¼šè¢«è¿«æ¨å‡ºè‡ªå·±çš„ä¸œè¥¿ï¼Œè¿™æ ·å¾ˆå¯èƒ½é€ æˆç¤¾åŒºæˆå‘˜å’Œç¤¾åŒºçº¦å®šä¸ä¸€è‡´ã€‚</li>
</ul>
<h3 id="éƒ¨ç½²hpa">éƒ¨ç½²HPA</h3>
<p>æˆ‘ä»¬è¦ä½¿ç”¨ HPAï¼Œå°±éœ€è¦åœ¨é›†ç¾¤ä¸­å®‰è£… <code>Metrics Server</code> æœåŠ¡ï¼Œè¦å®‰è£… <code>Metrics Server</code> å°±éœ€è¦å¼€å¯ <code>Aggregator</code>ï¼Œå› ä¸º <code>Metrics Server</code> å°±æ˜¯é€šè¿‡è¯¥ä»£ç†è¿›è¡Œæ‰©å±•çš„ï¼Œä¸è¿‡æˆ‘ä»¬é›†ç¾¤æ˜¯é€šè¿‡ Kubeadm æ­å»ºçš„ï¼Œé»˜è®¤å·²ç»å¼€å¯äº†ï¼Œå¦‚æœæ˜¯äºŒè¿›åˆ¶æ–¹å¼å®‰è£…çš„é›†ç¾¤ï¼Œéœ€è¦å•ç‹¬é…ç½® kube-apsierver æ·»åŠ å¦‚ä¸‹æ‰€ç¤ºçš„å‚æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">--<span class="l">requestheader-client-ca-file=&lt;path to aggregator CA cert&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>--<span class="l">requestheader-allowed-names=aggregator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>--<span class="l">requestheader-extra-headers-prefix=X-Remote-Extra-</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>--<span class="l">requestheader-group-headers=X-Remote-Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>--<span class="l">requestheader-username-headers=X-Remote-User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>--<span class="l">proxy-client-cert-file=&lt;path to aggregator proxy cert&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>--<span class="l">proxy-client-key-file=&lt;path to aggregator proxy key&gt;</span><span class="w">
</span></span></span></code></pre></div><p><code>Aggregator</code> èšåˆå±‚å¯åŠ¨å®Œæˆåï¼Œå°±å¯ä»¥æ¥å®‰è£… <code>Metrics Server</code> äº†ï¼Œæˆ‘ä»¬å¯ä»¥è·å–è¯¥ä»“åº“çš„å®˜æ–¹å®‰è£…èµ„æºæ¸…å•ï¼š</p>
<ul>
<li>å®˜æ–¹ä»“åº“åœ°å€ï¼šhttps://github.com/kubernetes-sigs/metrics-server</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># è¯·ä¿®æ”¹é•œåƒä¸º: registry.aliyuncs.com/google_containers/metrics-server:v0.6.2</span>
</span></span><span class="line"><span class="cl">wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.2/components.yaml
</span></span></code></pre></div><p>å¦‚æœå‡ºç°<code>x509: cannot validate certificate for 10.151.30.22 because it doesnâ€™t contain any IP SANs</code>è¿™ç§é”™è¯¯,å› ä¸ºéƒ¨ç½²é›†ç¾¤çš„æ—¶å€™ï¼ŒCA è¯ä¹¦å¹¶æ²¡æœ‰æŠŠå„ä¸ªèŠ‚ç‚¹çš„ IP ç­¾ä¸Šå»ï¼Œæ‰€ä»¥è¿™é‡Œ <code>Metrics Server</code> é€šè¿‡ IP å»è¯·æ±‚æ—¶ï¼Œæç¤ºç­¾çš„è¯ä¹¦æ²¡æœ‰å¯¹åº”çš„IPæ‰€å¯¼è‡´çš„,æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ª<code>--kubelet-insecure-tls</code>å‚æ•°è·³è¿‡è¯ä¹¦æ ¡éªŒï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- --<span class="l">cert-dir=/tmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- --<span class="l">secure-port=4443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- --<span class="l">kubelet-preferred-address-types=InternalIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- --<span class="l">kubelet-use-node-status-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- --<span class="l">metric-resolution=15s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- --<span class="l">kubelet-insecure-tls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ä¿®æ”¹å®Œæˆåè®°å¾—éƒ¨ç½²</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kubectl apply -f components.yaml</span><span class="w">
</span></span></span></code></pre></div><p>éªŒè¯HPAæ˜¯å¦å®‰è£…æˆåŠŸ,ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>kubectl top</code> å‘½ä»¤æ¥è·å–åˆ°èµ„æºæ•°æ®äº†ï¼Œè¯æ˜ <code>Metrics Server</code> å·²ç»å®‰è£…æˆåŠŸäº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl top nodes</span>
</span></span><span class="line"><span class="cl">NAME                     CPU<span class="o">(</span>cores<span class="o">)</span>   CPU%   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   MEMORY%   
</span></span><span class="line"><span class="cl">online-beijing-master1   82m          1%     1970Mi          12%       
</span></span><span class="line"><span class="cl">online-beijing-master2   59m          0%     1379Mi          8%        
</span></span><span class="line"><span class="cl">online-beijing-master3   61m          0%     1389Mi          8%        
</span></span><span class="line"><span class="cl">online-beijing-node1     35m          0%     1957Mi          12%       
</span></span><span class="line"><span class="cl">online-beijing-node2     33m          0%     1875Mi          11%       
</span></span><span class="line"><span class="cl">online-beijing-node3     35m          0%     1045Mi          6% 
</span></span></code></pre></div><p>é¦–å…ˆæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª<code>deployment</code>ï¼Œå‡†å¤‡å¯¹ä»–è¿›è¡ŒHPA</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-demo-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-demo-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-demo-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-demo-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-demo-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-demo-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">100Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></div><h3 id="åˆ›å»ºåŸºäºcpuçš„è‡ªåŠ¨æ‰©å®¹">åˆ›å»ºåŸºäºCPUçš„è‡ªåŠ¨æ‰©å®¹</h3>
<blockquote>
<p>æˆ‘ä»¬è¿™æ¬¡åªé’ˆå¯¹CPUè¿›è¡Œæ“ä½œ,åç»­æˆ‘ä»¬ä¼šæ ¹æ®æ›´å¤šçš„è‡ªå®šä¹‰èµ„æºæ¥è¿›è¡Œæ‰©ç¼©å®¹ã€‚</p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª<code>HPA</code>ï¼Œå¯ä»¥ä½¿ç”¨<code>kubectl autoscale</code>å‘½ä»¤æ¥åˆ›å»ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl autoscale deployment hpa-demo-nginx --cpu-percent<span class="o">=</span><span class="m">10</span> --min<span class="o">=</span><span class="m">1</span> --max<span class="o">=</span><span class="m">6</span>
</span></span></code></pre></div><p>æ­¤å‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ªå…³è”èµ„æº<code>hpa-demo-nginx</code> çš„<code>HPA</code>ï¼Œæœ€å°çš„ pod å‰¯æœ¬æ•°ä¸º3ï¼Œæœ€å¤§ä¸º6ã€‚<code>HPA</code>ä¼šæ ¹æ®è®¾å®šçš„ cpuä½¿ç”¨ç‡ï¼ˆ10%ï¼‰åŠ¨æ€çš„å¢åŠ æˆ–è€…å‡å°‘podæ•°é‡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get hpa</span>
</span></span><span class="line"><span class="cl">NAME               REFERENCE                     TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span class="line"><span class="cl">hpa-demo-nginx   Deployment/hpa-demo-nginx   &lt;unknown&gt;/10%   <span class="m">1</span>         <span class="m">6</span>         <span class="m">0</span>          8s
</span></span></code></pre></div><p>æ¥ä¸‹æ¥å¯¹Podè¿›è¡Œå‹åŠ›æµ‹è¯•,ä¸æ–­çš„å»è¯·æ±‚å½“å‰<code>hpa-demo-nginx</code>Podçš„IP</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl run -i --tty load-generator --image<span class="o">=</span>busybox /bin/sh
</span></span><span class="line"><span class="cl"><span class="k">while</span> true<span class="p">;</span> <span class="k">do</span> wget -q -O- http://10.10.180.71<span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></div><p>æ­£å¸¸å¯ä»¥çœ‹åˆ°<code>HPA</code>å·²ç»æ­£å¸¸å·¥ä½œäº†ï¼ŒPodçš„å‰¯æœ¬æ•°é‡å·²ç»åˆ†é…åˆ°äº†æˆ‘ä»¬å½“æ—¶æŒ‡å®šçš„6ä¸ª</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get hpa</span>
</span></span><span class="line"><span class="cl">NAME             REFERENCE                   TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span class="line"><span class="cl">hpa-demo-nginx   Deployment/hpa-demo-nginx   78%/10%   <span class="m">1</span>         <span class="m">6</span>         <span class="m">6</span>          4m20s
</span></span></code></pre></div><p>ä»kubernetes<code>v1.12</code>ç‰ˆæœ¬å¼€å§‹,æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®<code>kube-controller-manager</code>çš„<code>--horizontal-pod-autoscaler-downscale-stabilization</code>å‚æ•°æ¥è®¾ç½®ä¸€ä¸ªæŒç»­æ—¶é—´,æŒ‡çš„æ˜¯ç”¨äºå½“å‰æ‰©å®¹æ“ä½œå®Œæˆå,å¤šä¹…ä»¥åæ‰è¿›è¡Œä¸€æ¬¡ç¼©æ”¾æ“ä½œã€‚é»˜è®¤ä¸º5åˆ†é’Ÿ,ä¹Ÿå°±æ˜¯äº”åˆ†é’Ÿåæ‰ä¼šè¿›è¡Œç¼©æ”¾ã€‚</p>
<h3 id="åˆ›å»ºä¸€ä¸ªåŸºäºå†…å­˜çš„è‡ªåŠ¨æ‰©å®¹">åˆ›å»ºä¸€ä¸ªåŸºäºå†…å­˜çš„è‡ªåŠ¨æ‰©å®¹</h3>
<p>è·ŸCPUæ˜¯ä¸€æ ·çš„,éƒ½æ˜¯åŸºäº<code>metrics-server</code>è·å–æŒ‡æ ‡ç„¶åè¿›è¡Œæ‰©å®¹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-mem-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-mem-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-mem-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-mem-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-mem-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-mem-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">20Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mount-configmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/script</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mount-configmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">increase-mem-config</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œå’Œå‰é¢æ™®é€šçš„åº”ç”¨æœ‰ä¸€äº›åŒºåˆ«ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªåä¸º <code>increase-mem-config</code> çš„ ConfigMap èµ„æºå¯¹è±¡æŒ‚è½½åˆ°äº†å®¹å™¨ä¸­ï¼Œè¯¥é…ç½®æ–‡ä»¶æ˜¯ç”¨äºåé¢å¢åŠ å®¹å™¨å†…å­˜å ç”¨çš„è„šæœ¬ï¼Œé…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼šï¼ˆincrease-mem-cm.yamlï¼‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">increase-mem-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">increase-mem.sh</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    #!/bin/bash  
</span></span></span><span class="line"><span class="cl"><span class="sd">    mkdir /tmp/memory  
</span></span></span><span class="line"><span class="cl"><span class="sd">    mount -t tmpfs -o size=40M tmpfs /tmp/memory  
</span></span></span><span class="line"><span class="cl"><span class="sd">    dd if=/dev/zero of=/tmp/memory/block  
</span></span></span><span class="line"><span class="cl"><span class="sd">    sleep 60 
</span></span></span><span class="line"><span class="cl"><span class="sd">    rm /tmp/memory/block  
</span></span></span><span class="line"><span class="cl"><span class="sd">    umount /tmp/memory  
</span></span></span><span class="line"><span class="cl"><span class="sd">    rmdir /tmp/memory</span><span class="w">    
</span></span></span></code></pre></div><p>ç”±äºè¿™é‡Œå¢åŠ å†…å­˜çš„è„šæœ¬éœ€è¦ä½¿ç”¨åˆ° <code>mount</code> å‘½ä»¤ï¼Œè¿™éœ€è¦å£°æ˜ä¸ºç‰¹æƒæ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æ·»åŠ äº† <code>securityContext.privileged=true</code> è¿™ä¸ªé…ç½®ã€‚ç°åœ¨æˆ‘ä»¬ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºå¯¹è±¡å³å¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f hpa-demo-mem.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f increase-mem-config.yaml 
</span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>Kubernetesä¸­Api-Serverç®€å•è§£è¯»</title>
      <link>https://blog.mletter.cn/tech/kubernetes/apiserver-read/</link>
      <pubDate>Tue, 07 Feb 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/apiserver-read/</guid>
      <description>Kubernetes APIçš„æ¯ä¸ªè¯·æ±‚éƒ½ä¼šç»è¿‡å¤šé˜¶æ®µçš„è®¿é—®æ§åˆ¶ä¹‹åæ‰ä¼šè¢«æ¥å—,è¿™ä¸€é˜¶æ®µåŒ…æ‹¬è®¤è¯ã€æˆæƒã€ä»¥åŠå‡†å…¥æ§åˆ¶(Admission Control)ç­‰</description>
      <content:encoded><![CDATA[<p><strong>è®¿é—®æ§åˆ¶æ¦‚è§ˆ</strong>
Kubernetes APIçš„æ¯ä¸ªè¯·æ±‚éƒ½ä¼šç»è¿‡å¤šé˜¶æ®µçš„è®¿é—®æ§åˆ¶ä¹‹åæ‰ä¼šè¢«æ¥å—,è¿™ä¸€é˜¶æ®µåŒ…æ‹¬è®¤è¯ã€æˆæƒã€ä»¥åŠå‡†å…¥æ§åˆ¶(Admission Control)ç­‰</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="img" loading="lazy" src="https://bj.bcebos.com/baidu-rmb-video-cover-1/2b6495c8749e3f4e4369e28cb50eeb87.png"></p>
<h2 id="è®¤è¯æ’ä»¶">è®¤è¯æ’ä»¶</h2>
<ul>
<li>x509è¯ä¹¦ï¼šä½¿ç”¨x509è¯ä¹¦åªéœ€è¦API Serverå¯åŠ¨çš„æ—¶å€™é…ç½® <code>--client-ca-file=SOMEFILE</code>ã€‚åœ¨è¯ä¹¦è®¤è¯çš„æ—¶å€™,å…¶CNåŸŸååšç”¨æˆ·å,è€Œç»„ç»‡æœºæ„ç”¨ä½œgroupåã€‚</li>
<li>é™æ€Tokenæ–‡ä»¶ï¼šä½¿ç”¨é™æ€Tokenæ–‡ä»¶è®¤è¯åªéœ€è¦åœ¨API Serverå¯åŠ¨çš„æ—¶å€™é…ç½® <code>--token-auth-file=SOMEFILE</code>ã€‚è¯¥æ–‡ä»¶ä¸º<code>csv</code>æ ¼å¼,æ¯è¡Œè‡³å°‘åŒ…æ‹¬ä¸‰åˆ—<code>token</code>ã€<code>username</code>ã€<code>user id</code></li>
<li>å¼•å¯¼Token
<ul>
<li>ä¸ºäº†æ”¯æŒå¹³æ»‘çš„å¯åŠ¨å’Œå¼•å¯¼æ–°çš„é›†ç¾¤,kubernetesåŒ…å«äº†ä¸€ç§åŠ¨æ€ç®¡ç†çš„æŒæœ‰ä»¤ç‰Œç±»å‹,ç§°ä½œå¯åŠ¨å¼•å¯¼ä»¤ç‰Œ(Bootstrap Token)</li>
<li>è¿™äº›ä»¤ç‰Œä»¥<code>Secret</code>çš„å½¢å¼ä¿å­˜åœ¨<code>kube-system</code>çš„åç§°ç©ºé—´ä¸­,å¯ä»¥åŠ¨æ€çš„ç®¡ç†å’Œåˆ›å»ºã€‚</li>
<li>æ§åˆ¶å™¨ç®¡ç†å™¨åŒ…å«çš„TokenCleaneræ§åˆ¶å™¨èƒ½å¤Ÿåœ¨å¯åŠ¨å¼•å¯¼ä»¤ç‰Œè¿‡æœŸæ—¶å°†å…¶åˆ é™¤ã€‚</li>
<li>åœ¨ä½¿ç”¨kubeadméƒ¨ç½²kubernetesçš„æ—¶å€™,å¯ä»¥é€šè¿‡<code>kubeadm token list</code>è¿›è¡ŒæŸ¥è¯¢ã€‚</li>
</ul>
</li>
<li>ServiceAccountï¼šæ˜¯kubernetesè‡ªåŠ¨ç”Ÿæˆçš„,å¹¶ä¸”ä¼šè‡ªåŠ¨æŒ‚è½½åˆ°å®¹å™¨çš„<code>/run/secrets/kubernetes.io/serviceaccount</code>ç›®å½•å½“ä¸­</li>
<li>Webhookä»¤ç‰Œèº«ä»½è®¤è¯
<ul>
<li><code>--authentication-token-webhook-config-file</code>ï¼šæŒ‡å‘ä¸€ä¸ªé…ç½®æ–‡ä»¶,å…¶ä¸­æè¿°å¦‚ä½•è®¿é—®è¿œç¨‹çš„WebhookæœåŠ¡</li>
<li><code>--authentication-token-webhook-cache-ttl</code>ï¼šç”¨æ¥è®¾å®šèº«ä»½è®¤è¯å†³å®šçš„ç¼“å­˜æ—¶é—´ã€‚é»˜è®¤ä¸º2åˆ†é’Ÿã€‚</li>
</ul>
</li>
</ul>
<h3 id="é™æ€tokenç”¨æ³•">é™æ€Tokenç”¨æ³•</h3>
<ol>
<li>æ–°å»ºä¸€ä¸ªå­˜æ”¾é™æ€Tokençš„ç›®å½•</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p /etc/kubernetes/auth
</span></span></code></pre></div><ol start="2">
<li>å°†Tokenå†…å®¹å†™å…¥åˆ°æ–‡ä»¶å½“ä¸­</li>
</ol>
<blockquote>
<p>æ³¨æ„ï¼šè¯¥æ–‡ä»¶æ ¼å¼ä¸ºCSVæ ¼å¼ï¼Œå…¶å®ä½ ä¹Ÿå¯ä»¥éšä¾¿å†™:happy:</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">æè¿°ï¼š Tokenå€¼  ç”¨æˆ·åç§°  ç”¨æˆ·ID å¯é€‰ç»„å
</span></span><span class="line"><span class="cl">kube-token,kubeadminer,1000,<span class="s2">&#34;group1,group2,group3&#34;</span>
</span></span></code></pre></div><p>å‡è®¾è¿™æ˜¯æˆ‘ä»¬è¯·æ±‚åç§°ç©ºé—´çš„è¯·æ±‚: <code>curl -k -v -XGET -H &quot;Authrization: Bearer kube-token&quot; https://api.k8s.version.cn:6443/api/v1/namespaces/default</code></p>
<p>æ­£å¸¸è¯·æ±‚ä¼šè¿”å›ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰åˆ›å»ºè¿™ä¸ª<code>kube-token</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;Status&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;apiVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;Failure&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;namespaces \&#34;default\&#34; is forbidden: User \&#34;system:anonymous\&#34; cannot get resource \&#34;namespaces\&#34; in API group \&#34;\&#34; in the namespace \&#34;default\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Forbidden&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;details&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;namespaces&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="mi">403</span>
</span></span></code></pre></div><ol start="3">
<li>è®¾ç½®<code>API Server</code></li>
</ol>
<blockquote>
<p>æ³¨æ„ï¼š æ“ä½œçš„æ—¶å€™è¯·å¤‡ä»½ä½ çš„API Serveræ–‡ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c">#  vim /etc/kubernetes/manifests/kube-apiserver.yaml </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># æŒ‚è½½æœ¬åœ°çš„/etc/basic-authè·¯å¾„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/basic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">auth-files</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span>- <span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/basic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">DirectoryOrCreate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">auth-files</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ä¿®æ”¹API Serverå¯åŠ¨å‚æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- --<span class="l">token-auth-file=/etc/basic-auth/kube-token.csv</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>è¯·æ‚¨ç­‰å¾…APIServeré‡å¯å®Œæˆ</p>
</blockquote>
<p>å½“æˆ‘ä»¬å†æ¬¡é€šè¿‡<code>kube-token</code>è¿›è¡Œè¯·æ±‚API Server å¦‚æœèƒ½æˆåŠŸè¯†åˆ«åˆ°æˆ‘ä»¬çš„ç”¨æˆ·å³å¯ï¼Œä¹Ÿå°±çŸ¥é“æˆ‘ä»¬å½“å‰çš„ç”¨æˆ·ä¸º<code>kubeadminer</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;Status&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;apiVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;Failure&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;namespaces \&#34;default\&#34; is forbidden: User \&#34;kubeadminer\&#34; cannot get resource \&#34;namespaces\&#34; in API group \&#34;\&#34; in the namespace \&#34;default\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Forbidden&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;details&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;namespaces&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="mi">403</span>
</span></span></code></pre></div><h3 id="useraccountå’Œserviceaccountçš„åŒºåˆ«">UserAccountå’ŒServiceAccountçš„åŒºåˆ«</h3>
<ol>
<li>UserAccountæ˜¯ä¸å¤–éƒ¨è®¤è¯äºŒæ¬¡å¼€å‘å¯¹æ¥å®ç°çš„,ç­¾å‘çš„Tokenæ˜¯å¤–éƒ¨ç³»ç»Ÿ,æ¯æ¬¡APIServeréœ€è¦å¸¦æ­¤Tokenè¯·æ±‚å¤–éƒ¨è®¤è¯æœåŠ¡å™¨ã€‚</li>
</ol>
<h3 id="æ„å»ºç¬¦åˆkubernetesè§„èŒƒçš„è®¤è¯æœåŠ¡">æ„å»ºç¬¦åˆKubernetesè§„èŒƒçš„è®¤è¯æœåŠ¡</h3>
<p>éœ€è¦ä¾ç…§kubernetesè§„èŒƒï¼Œæ¥æ„å»ºè®¤è¯æœåŠ¡è¿›è¡Œè®¤è¯</p>
<ol>
<li>URLï¼šhttp://api.k8s.verbos/authenticate</li>
<li>Method: POST(éœ€è¦æºå¸¦è¯·æ±‚æ•°æ®ç­‰ç­‰â€¦)</li>
<li>Inputï¼š</li>
<li>Outputï¼š</li>
</ol>
<h3 id="webhookè®¤è¯ç”¨æ³•">WebHookè®¤è¯ç”¨æ³•</h3>
<ol>
<li>æ–°å»ºä¸€ä¸ªwebhook-config.json</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;Config&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;apiVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;preferences&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;clusters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;github-authn&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;server&#34;</span><span class="p">:</span> <span class="s2">&#34;https://192.168.1.100:8443/authenticate&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;users&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;authn-apiserver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;secret&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;contexts&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;webhook&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;context&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;github-authn&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;authn-apiserver&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;current-context&#34;</span><span class="p">:</span> <span class="s2">&#34;webhook&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="æˆæƒ">æˆæƒ</h2>
<p>æˆæƒä¸»è¦æ˜¯ç”¨äºå¯¹äºé›†ç¾¤èµ„æºçš„è®¿é—®æ§åˆ¶ï¼Œé€šè¿‡æ£€æŸ¥è¯·æ±‚åŒ…å«çš„ç›¸å…³å±æ€§å€¼ï¼Œä¸ç›¸å¯¹åº”çš„è®¿é—®ç­–ç•¥è¿›è¡Œæ¯”è¾ƒï¼ŒAPIè¯·æ±‚å¿…é¡»æ»¡è¶³æŸäº›ç­–ç•¥æ‰èƒ½è¢«å¤„ç†ã€‚è·Ÿè®¤è¯ç±»ä¼¼ï¼Œkubernetesä¹Ÿæ”¯æŒå¤šç§æˆæƒæœºåˆ¶ï¼Œå¹¶æ”¯æŒåŒæ—¶å¼€å¯å¤šä¸ªæ’ä»¶æˆæƒï¼ˆåªè¦æœ‰ä¸€ä¸ªé€šè¿‡å³å¯ï¼‰ã€‚å¦‚æœæˆæƒæˆåŠŸï¼Œåˆ™ç”¨æˆ·çš„è¯·æ±‚ä¼šå‘é€åˆ°å‡†å…¥æ§åˆ¶æ¨¡å—è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚</p>
<p>kubernetesæˆæƒä»…å¤„ç†ä»¥ä¸‹è¯·æ±‚å±æ€§</p>
<ul>
<li>userã€groupã€extra</li>
<li>APIã€è¯·æ±‚æ–¹æ³•ã€è¯·æ±‚è·¯å¾„</li>
<li>è¯·æ±‚èµ„æºå’Œå­èµ„æº</li>
<li>Namespace</li>
<li>API Group</li>
</ul>
<p>kubernetesæ”¯æŒä»¥ä¸‹æˆæƒæ’ä»¶</p>
<ul>
<li>ABAC</li>
<li>RBAC</li>
<li>WebHook</li>
<li>Node</li>
</ul>
<h3 id="rbacå’Œabac">RBACå’ŒABAC</h3>
<p>ABAC(Attribute Based Access Control)æœ¬æ¥æ˜¯ä¸é”™çš„æ¦‚å¿µï¼Œä½†æ˜¯åœ¨kubernetesä¸­å®ç°çš„æ¯”è¾ƒéš¾äºç®¡ç†å’Œç†è§£ï¼Œè€Œä¸”éœ€è¦å¯¹masteræ‰€åœ¨èŠ‚ç‚¹è¿›è¡ŒSSHå’Œæ–‡ä»¶ç³»ç»Ÿæƒé™ï¼Œè¦ä½¿å¾—å¯¹æˆæƒçš„å˜æ›´ç”Ÿæ•ˆè¿˜éœ€è¦é‡å¯API Server</p>
<p>è€ŒRBACçš„ç­–ç•¥å¯ä»¥åˆ©ç”¨kubeletæˆ–è€…kubernetes APIè¿›è¡Œé…ç½®ã€‚RBACå¯ä»¥æˆæƒç»™ç”¨æˆ·ï¼Œè®©ç”¨æˆ·æœ‰æƒè¿›è¡Œæˆæƒç®¡ç†ï¼Œè¿™æ ·å°±å¯ä»¥æ— éœ€æ¥è§¦èŠ‚ç‚¹ï¼Œç›´æ¥è¿›è¡Œæˆæƒç®¡ç†ã€‚RBACåœ¨kubernetesä¸­è¢«æ˜ å°„ä¸ºAPIèµ„æºå’Œæ“ä½œã€‚</p>
<h3 id="roleå’Œclusterrole">Roleå’ŒClusterRole</h3>
<p>Role(è§’è‰²)æ˜¯ä¸€ç³»åˆ—ç‰¹å®šè§’è‰²æƒé™çš„é›†åˆï¼Œä¾‹å¦‚ä¸€ä¸ªè§’è‰²å¯ä»¥åŒ…å«è¯»å–Podçš„æƒé™å’Œåˆ—å‡ºPodçš„æƒé™ã€‚</p>
<p>Roleåªèƒ½ç”¨æ¥ç»™æŸä¸ªç‰¹å®šçš„namespaceä¸­çš„èµ„æºä½œé‰´æƒï¼Œå¯¹å¤šnamespaceå’Œé›†ç¾¤çº§çš„èµ„æºæ´»ç€æ˜¯éèµ„æºç±»çš„API(å¦‚/healthz)ä½¿ç”¨ClusterRole</p>
<blockquote>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„Roleé…ç½®</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">reader-pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•åœ°ClusterRoleé…ç½®</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">reader-pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><h3 id="binding">Binding</h3>
<p>å¦‚æœä½ æƒ³ä½¿å…¨å±€ç”Ÿæ•ˆå¯ä»¥ä½¿ç”¨<code>kind: ClusterRoleBingding</code>å¹¶ä¸”ä¸å†™<code>namespace</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBingding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">reader-pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># å½“å‰ç”¨æˆ·åªæœ‰developmentçš„è¯»å–æƒé™</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">development</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">guest01</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">reader-pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span></code></pre></div><h3 id="è´¦æˆ·ç»„çš„ç®¡ç†">è´¦æˆ·/ç»„çš„ç®¡ç†</h3>
<p>è§’è‰²ç»‘å®š(Role Bingding)æ˜¯å°†è§’è‰²ä¸­å®šä¹‰çš„æƒé™èµ‹äºˆä¸€ä¸ªæˆ–è€…ä¸€ç»„ç”¨æˆ·ã€‚
å®ƒåŒ…å«ä¸»ä½“(ç”¨æˆ·ã€ç»„æˆ–æœåŠ¡è´¦æˆ·)çš„åˆ—è¡¨å’Œå¯¹è¿™äº›ä¸»ä½“æ‰€è·å¾—çš„è§’è‰²çš„å¼•ç”¨
ç»„çš„æ¦‚å¿µ</p>
<ul>
<li>å½“å¤–éƒ¨ç³»ç»Ÿè®¤è¯å¯¹æ¥çš„æ—¶å€™,ç”¨æˆ·ä¿¡æ¯å¯åŒ…å«ç»„ä¿¡æ¯ï¼Œæˆæƒå¯ä»¥é’ˆå¯¹ç”¨æˆ·ç¾¤ç»„è¿›è¡Œ</li>
<li>å½“å¯¹<code>Service Account</code>æˆæƒçš„æ—¶å€™,Groupä»£è¡¨æŸä¸ªNamespaceä¸‹çš„æ‰€æœ‰<code>Service Account</code>
å¦‚æœé’ˆå¯¹ç¾¤ç»„æˆæƒ</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBingding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">reader-pods-global</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">guest01</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">reader-pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span></code></pre></div><p><code>name: system:serviceaccounts</code>è¡¨ç¤ºå½“å‰æ˜¯ä¸€ä¸ªserviceaccountçš„æ ¼å¼è¿›è¡Œå‘½åçš„,å¹¶ä¸”æˆæƒç»™developmentè¿™ä¸ªNamespaceé‡Œé¢æ‰€æœ‰çš„ServiceAccount</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBingding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">reader-pods-global</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">system:serviceaccounts:development</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">reader-pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span></code></pre></div><h3 id="è§„åˆ’ç³»ç»Ÿè§’è‰²">è§„åˆ’ç³»ç»Ÿè§’è‰²</h3>
<p>User:</p>
<ul>
<li>ç®¡ç†å‘˜ï¼šç®¡ç†æ‰€æœ‰èµ„æºçš„æƒé™</li>
<li>æ™®é€šç”¨æˆ·
<ul>
<li>æ˜¯å¦æœ‰è¯¥ç”¨æˆ·åˆ›å»ºçš„namespaceä¸‹çš„æ‰€æœ‰objectçš„æ“ä½œæƒé™ï¼Ÿ</li>
<li>å¯¹å…¶ä»–ç”¨æˆ·çš„namespaceèµ„æºæ˜¯å¦å¯è¯»ã€æ˜¯å¦å¯å†™
SystemAccount</li>
</ul>
</li>
<li>Systemæ˜¯å¼€å‘è€…åˆ›å»ºåº”ç”¨åï¼Œåº”ç”¨äºapiserveré€šè®¯éœ€è¦çš„èº«ä»½</li>
<li>ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå®šçš„ServiceAccountï¼Œkubernetesä¹Ÿä¸ºæ¯ä¸ªnamespaceåˆ›å»ºdefault <code>ServiceAccount</code></li>
<li><code>Default ServiceAccount</code>é€šå¸¸éœ€è¦ç»™å®šæƒé™ä»¥åæ‰èƒ½å¯¹API Serverè¿›è¡Œå†™æ“ä½œ</li>
</ul>
<h3 id="ä¸æƒé™ç›¸å…³çš„å…¶ä»–æœ€ä½³å®è·µ">ä¸æƒé™ç›¸å…³çš„å…¶ä»–æœ€ä½³å®è·µ</h3>
<p>ClusterRoleæ˜¯énamespaceç»‘å®šçš„,é’ˆå¯¹æ•´ä¸ªé›†ç¾¤ç”Ÿæ•ˆã€‚
é€šå¸¸éœ€è¦åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è§’è‰²ï¼Œå¹¶ä¸”ç»‘å®šç»™å¼€å‘è¿è¥å›¢é˜Ÿçš„æˆå‘˜
<code>ThirdPartyResource</code>å’Œ<code>CustomResourceDefinition</code>æ˜¯å…¨å±€èµ„æºï¼Œæ™®é€šç”¨æˆ·åˆ›å»ºä»¥åéœ€è¦ç®¡ç†å‘˜æˆæƒæ‰èƒ½çœŸæ­£æ“ä½œè¯¥å¯¹è±¡ã€‚</p>
<blockquote>
<p>sshåˆ°masterèŠ‚ç‚¹é€šè¿‡<code>insecure port</code>è®¿é—®apiserverå¯ä»¥ç»•è¿‡é‰´æƒ,å½“éœ€è¦åšç®¡ç†æ“ä½œåˆæ²¡æœ‰æƒé™çš„æ—¶å€™å¯ä»¥ä½¿ç”¨(ä¸æ¨è)</p>
</blockquote>
<h2 id="å‡†å…¥">å‡†å…¥</h2>
<h3 id="å‡†å…¥æ§åˆ¶">å‡†å…¥æ§åˆ¶</h3>
<p>å‡†å…¥æ§åˆ¶(Admission Control)åœ¨æˆæƒåå¯¹è¯·æ±‚åšè¿›ä¸€æ­¥çš„éªŒè¯æˆ–æ·»åŠ é»˜è®¤å‚æ•°ã€‚ä¸åŒäºæˆæƒå’Œè®¤è¯åªå…³å¿ƒè¯·æ±‚çš„ç”¨æˆ·å’Œæ“ä½œï¼Œå‡†å…¥æ§åˆ¶è¿˜å¤„ç†è¯·æ±‚çš„å†…å®¹ï¼Œå¹¶ä¸”ä»…å¯¹åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æˆ–è¿æ¥ç­‰æœ‰æ•ˆï¼Œè€Œå¯¹è¯»æ“ä½œæ— æ•ˆã€‚
å‡†å…¥æ§åˆ¶æ”¯æŒåŒæ—¶å¼€å¯å¤šä¸ªæ’ä»¶ï¼Œå®ƒä»¬ä¾æ¬¡è°ƒç”¨ï¼Œåªæœ‰å…¨éƒ¨æ’ä»¶éƒ½é€šè¿‡è¯·æ±‚æ‰å¯ä»¥è¿›å…¥ç³»ç»Ÿã€‚
é…é¢ç®¡ç†</p>
<ul>
<li>åŸå› ï¼šèµ„æºæœ‰é™ï¼Œå¦‚ä½•é™å®šæŸä¸ªç”¨æˆ·æœ‰å¤šå°‘èµ„æº
æ–¹æ¡ˆ</li>
<li>é¢„å®šä¹‰æ¯ä¸ª<code>Namespace</code>çš„<code>ResourceQuota</code>,å¹¶ä¸”æŠŠ<code>spec</code>ä¿å­˜ä¸º<code>ConfigMap</code></li>
<li>ç”¨æˆ·å¯ä»¥åˆ›å»ºå¤šå°‘ä¸ªPod?
<ul>
<li>BestEffortPod</li>
<li>QuSPod</li>
</ul>
</li>
<li>åˆ›å»º<code>ResourceQuota Controller</code>: ä¸€èˆ¬ç”¨äºç›‘æ§<code>namespace</code>åˆ›å»ºäº‹ä»¶ï¼Œå½“namespaceåˆ›å»ºçš„æ—¶å€™ï¼Œåœ¨è¯¥namespaceåˆ›å»ºå¯¹åº”çš„ResourceQuotaå¯¹è±¡</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># é™åˆ¶default namespaceåªèƒ½åˆ›å»º3ä¸ªconfigmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ResourceQuota</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default-counts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">configmaps</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3&#34;</span><span class="w">
</span></span></span></code></pre></div><h3 id="å‡†å…¥æ§åˆ¶æ’ä»¶">å‡†å…¥æ§åˆ¶æ’ä»¶</h3>
<ul>
<li>AlwaysAdmit: æ¥å—æ‰€æœ‰è¯·æ±‚</li>
<li>AlwaysPullImages: æ€»æ˜¯æ‹‰æ–°çš„é•œåƒã€‚ä¸€èˆ¬ç”¨å¤šç§Ÿæˆ·åœºæ™¯</li>
<li>DenyEscalatingExec: ç¦æ­¢ç‰¹æƒå®¹å™¨çš„execå’Œattachæ“ä½œ</li>
<li>ImagePolicyWebhook: é€šè¿‡webhookå†³å®šimageç­–ç•¥,éœ€è¦åŒæ—¶é…ç½®<code>--admission-control-config-file</code></li>
<li>ServiceAccount: è‡ªåŠ¨åˆ›å»ºé»˜è®¤Service Accountï¼Œå¹¶ç¡®ä¿Podså¼•ç”¨çš„ServiceAccountå·²ç»å­˜åœ¨</li>
<li>SecurityContextDeny: æ‹’ç»åŒ…å«éæ³•SecurityContexté…ç½®çš„å®¹å™¨</li>
<li>ResourceQuotaï¼šé™åˆ¶Podçš„è¯·æ±‚ä¸ä¼šè¶…è¿‡é…é¢ï¼Œéœ€è¦åœ¨namespaceä¸­åˆ›å»º<code>ResourceQuota</code>å¯¹è±¡</li>
<li>MutatingWebhookConfiguration: å˜å½¢æ’ä»¶ï¼Œæ”¯æŒå¯¹å‡†å…¥å¯¹è±¡çš„ä¿®æ”¹</li>
<li>ValidatingWebhoookConfiguration: æ ¡éªŒæ’ä»¶ï¼Œåªèƒ½å¯¹å‡†å…¥å¯¹è±¡åˆæ³•æ€§è¿›è¡Œæ ¡éªŒ</li>
</ul>
<blockquote>
<p>å¤ªå¤šäº† æˆ‘å°±ä¸ä¸€ä¸ªä¸€ä¸ªå†™äº†â€¦é™¤äº†é»˜è®¤çš„å‡†å…¥æ§åˆ¶æ’ä»¶ä»¥å¤–ï¼Œkubernetesé¢„ç•™äº†å‡†å…¥æ§åˆ¶æ’ä»¶çš„æ‰©å±•ç‚¹ï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰å‡†å…¥æ§åˆ¶æ’ä»¶</p>
</blockquote>
<h3 id="å‡†å…¥æ§åˆ¶æ’ä»¶çš„æ¼”ç¤º">å‡†å…¥æ§åˆ¶æ’ä»¶çš„æ¼”ç¤º</h3>
<ul>
<li>MutatingWebhookConfiguration: è¯´ç™½äº†å°±æ˜¯å¯¹å‡†å…¥æ§åˆ¶çš„å¯¹è±¡å†…å®¹è¿›è¡Œä¿®æ”¹</li>
<li>ç¡®ä¿å¯ç”¨ MutatingAdmissionWebhook å’Œ ValidatingAdmissionWebhook æ§åˆ¶å™¨ã€‚ <a class="link" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/#is-there-a-recommended-set-of-admission-controllers-to-use"  target="_blank" rel="noopener"
    >è¿™é‡Œ</a> æ˜¯ä¸€ç»„æ¨èçš„ admission æ§åˆ¶å™¨ï¼Œé€šå¸¸å¯ä»¥å¯ç”¨ã€‚</li>
<li>ç¡®ä¿å¯ç”¨äº†<code>admissionregistration.k8s.io/v1</code>çš„API</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/cncamp/admission-controller-webhook-demo.git
</span></span></code></pre></div><blockquote>
<p>è¿™ä¸ªæš‚ä¸”å…ˆä¸æ¼”ç¤ºäº†â€¦æˆ‘ä¹Ÿåœ¨ç ”ç©¶å“ˆå“ˆ</p>
</blockquote>
<h2 id="é™æµ">é™æµ</h2>
<h3 id="æ¼æ–—ç®—æ³•">æ¼æ–—ç®—æ³•</h3>
<p>æ¼æ´ç®—æ³•ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œè¯·æ±‚è¿›æ¥ä»¥åé¦–å…ˆè¿›å…¥æ¼æ–—é‡Œé¢ï¼Œç„¶åæ¼æ–—ä»¥æ’å®šçš„é€Ÿç‡å°†è¯·æ±‚æµå‡ºè¿›è¡Œå¤„ç†ï¼Œä»è€Œèµ·åˆ°å¹³æ»‘æµé‡çš„ä½œç”¨ã€‚
å½“è¯·æ±‚é‡è¿‡å¤§ï¼Œæ¼æ–—è¾¾åˆ°æœ€å¤§å®¹é‡çš„æ—¶å€™ä¼šæº¢å‡ºï¼Œæ­¤æ—¶è¯·æ±‚è¢«ä¸¢å¼ƒ
åœ¨ç³»ç»Ÿçœ‹æ¥ï¼Œè¯·æ±‚æ°¸è¿œæ˜¯ä»¥å¹³æ»‘çš„é€Ÿç‡è¿‡æ¥ï¼Œä»è€Œèµ·åˆ°äº†ä¿æŠ¤ç³»ç»Ÿçš„ä½œç”¨</p>
<h3 id="ä»¤ç‰Œæ¡¶ç®—æ³•">ä»¤ç‰Œæ¡¶ç®—æ³•</h3>
<ol>
<li>ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯å¯¹æ¼æ–—ç®—æ³•çš„ä¸€ç§æ”¹è¿›ï¼Œé™¤äº†èƒ½å¤Ÿèµ·åˆ°é™æµçš„ä½œç”¨å¤–ï¼Œè¿˜å…è®¸ä¸€å®šç¨‹åº¦çš„æµé‡çªå‘
åœ¨ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªä»¤ç‰Œæ¡¶ï¼Œç®—æ³•ä¸­å­˜åœ¨ä¸€ç§æœºåˆ¶ä»¥æ’å®šçš„é€Ÿç‡å‘ä»¤ç‰Œæ¡¶ä¸­æ”¾å…¥ä»¤ç‰Œã€‚</li>
<li>ä»¤ç‰Œæ¡¶ä¹Ÿæœ‰ä¸€å®šçš„å®¹é‡ï¼Œå¦‚æœæ»¡äº†çš„è¯ä»¤ç‰Œä¹Ÿæ— æ³•æ”¾è¿›å»</li>
<li>å½“æœ‰è¯·æ±‚è¿›å…¥çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆåˆ°ä»¤ç‰Œæ¡¶ä¸­å»é‚£ä»¤ç‰Œï¼Œåˆ™è¯¥è¯·æ±‚ä¼šè¢«å¤„ç†ï¼Œå¹¶æ¶ˆè€—æ‰æ‹¿åˆ°çš„ä»¤ç‰Œï¼Œå¦‚æœä»¤ç‰Œæ¡¶ä¸ºç©ºï¼Œåˆ™è¯·æ±‚ä¼šè¢«ä¸¢å¼ƒã€‚</li>
</ol>
<h3 id="api-serverçš„é™æµ">API Serverçš„é™æµ</h3>
<ul>
<li><code>max-requests-inflight</code>: åœ¨ç»™å®šçš„æ—¶é—´å†…çš„æœ€å¤§çš„<code>non-mutating</code>è¯·æ±‚æ•°</li>
<li><code>max-mutating-requests-inflight</code>: åœ¨ç»™å®šæ—¶é—´å†…çš„æœ€å¤§<code>mutating</code>è¯·æ±‚æ•°ï¼Œè°ƒæ•´apiserverçš„æµæ§qos</li>
</ul>
<p><strong>ååº”å‡ºæ¥çš„é—®é¢˜</strong></p>
<ol>
<li>ç²’åº¦ç²—: æ— æ³•ä¸ºä¸åŒç”¨æˆ·ï¼Œä¸åŒåœºæ™¯è®¾ç½®ä¸åŒçš„é™æµ</li>
<li>å•é˜Ÿåˆ—ï¼šå…±äº«é™æµçš„çª—å£/æ¡¶ï¼Œä¸€ä¸ªåç”¨æˆ·å¯èƒ½å°†æ•´ä¸ªç³»ç»Ÿå µå¡</li>
<li>ä¸å…¬å¹³ï¼šæ­£å¸¸ç”¨æˆ·çš„è¯·æ±‚ä¼šè¢«æ’åˆ°é˜Ÿå°¾ï¼Œæ— æ³•åŠæ—¶å¤„ç†è¯·æ±‚è€Œé¥¿æ­»</li>
<li>æ— ä¼˜å…ˆçº§: é‡è¦çš„ç³»ç»ŸæŒ‡ä»¤ä¸€å¹¶è¢«é™æµï¼Œç³»ç»Ÿæ•…éšœéš¾ä»¥æ¢å¤</li>
</ol>
<table>
  <thead>
      <tr>
          <th></th>
          <th>é»˜è®¤å€¼</th>
          <th>èŠ‚ç‚¹æ•°1000-3000</th>
          <th>èŠ‚ç‚¹æ•°&gt;3000</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>max-requests-inflight</td>
          <td>400</td>
          <td>1500</td>
          <td>3000</td>
      </tr>
      <tr>
          <td>max-mutating-requests-inflight</td>
          <td>200</td>
          <td>500</td>
          <td>1000</td>
      </tr>
  </tbody>
</table>
<h3 id="api-priority-and-fairness">API Priority and Fairness</h3>
<ul>
<li>APFä»¥æ›´ç»†é¢—ç²’åº¦çš„æ–¹å¼å¯¹è¯·æ±‚è¿›è¡Œåˆ†ç±»å’Œéš”ç¦»ã€‚</li>
<li>å®ƒè¿˜å¼•å…¥äº†ç©ºé—´æœ‰é™çš„æ’é˜Ÿæœºåˆ¶ï¼Œå› æ­¤åœ¨éå¸¸çŸ­æš‚çš„çªå‘æƒ…å†µä¸‹ï¼ŒAPIæœåŠ¡å™¨ä¸ä¼šæ‹’ç»ä»»ä½•è¯·æ±‚</li>
<li>é€šè¿‡ä½¿ç”¨å…¬å¹³æ’é˜ŸæŠ€æœ¯ä»é˜Ÿåˆ—ä¸­åˆ†å‘è¯·æ±‚ï¼Œè¿™æ ·ä¸€ä¸ªè¡Œä¸ºä¸ä½³çš„æ§åˆ¶å™¨å°±ä¸ä¼šé¥¿æ­»å…¶ä»–æ§åˆ¶å™¨</li>
<li>APFçš„æ ¸å¿ƒ
<ul>
<li>å¤šç­‰çº§</li>
<li>å¤šé˜Ÿåˆ—</li>
</ul>
</li>
<li>APF çš„å®ç°ä¾èµ–ä¸¤ä¸ªéå¸¸é‡è¦çš„èµ„æº <code>FlowSchema</code>, <code>PriorityLevelConfiguration</code></li>
<li>APF å¯¹è¯·æ±‚è¿›è¡Œæ›´ç»†ç²’åº¦çš„åˆ†ç±»ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚åˆ†ç±»å¯¹åº”ä¸€ä¸ª FlowSchema (FS)</li>
<li>FS å†…çš„è¯·æ±‚åˆä¼šæ ¹æ® distinguisher è¿›ä¸€æ­¥åˆ’åˆ†ä¸ºä¸åŒçš„ Flow.</li>
<li>FS ä¼šè®¾ç½®ä¸€ä¸ªä¼˜å…ˆçº§ (Priority Level, PL)ï¼Œä¸åŒä¼˜å…ˆçº§çš„å¹¶å‘èµ„æºæ˜¯éš”ç¦»çš„ã€‚æ‰€ä»¥ä¸åŒä¼˜å…ˆçº§çš„èµ„æºä¸ä¼šç›¸äº’æ’æŒ¤ã€‚ç‰¹å®šä¼˜å…ˆçº§çš„è¯·æ±‚å¯ä»¥è¢«é«˜ä¼˜å¤„ç†ã€‚</li>
<li>ä¸€ä¸ª PL å¯ä»¥å¯¹åº”å¤šä¸ª FSï¼ŒPL ä¸­ç»´æŠ¤äº†ä¸€ä¸ª <code>QueueSet</code>ï¼Œç”¨äºç¼“å­˜ä¸èƒ½åŠæ—¶å¤„ç†çš„è¯·æ±‚ï¼Œè¯·æ±‚ä¸ä¼šå› ä¸ºè¶…å‡º PL çš„å¹¶å‘é™åˆ¶è€Œè¢«ä¸¢å¼ƒã€‚</li>
<li>FS ä¸­çš„æ¯ä¸ª Flow é€šè¿‡ shuffle sharding ç®—æ³•ä» QueueSet é€‰å–ç‰¹å®šçš„ queues ç¼“å­˜è¯·æ±‚ã€‚</li>
<li>æ¯æ¬¡ä» QueueSet ä¸­å–è¯·æ±‚æ‰§è¡Œæ—¶ï¼Œä¼šå…ˆåº”ç”¨ fair queuing ç®—æ³•ä» QueueSet ä¸­é€‰ä¸­ä¸€ä¸ª queueï¼Œç„¶åä»è¿™ä¸ª queue ä¸­å–å‡º oldest è¯·æ±‚æ‰§è¡Œã€‚æ‰€ä»¥å³ä½¿æ˜¯åŒä¸€ä¸ª PL å†…çš„è¯·æ±‚ï¼Œä¹Ÿä¸ä¼šå‡ºç°ä¸€ä¸ª Flow å†…çš„è¯·æ±‚ä¸€ç›´å ç”¨èµ„æºçš„ä¸å…¬å¹³ç°è±¡ã€‚</li>
</ul>
<p>é€šè¿‡<code> kubectl get flowschema</code>æŸ¥çœ‹å½“å‰çš„<code>flow</code></p>
<h3 id="flow-schema">Flow Schema</h3>
<p><code>FlowSchema</code>ä¼šåŒ¹é…ä¸€äº›å…¥ç«™è¯·æ±‚,å¹¶å°†ä»–ä»¬åˆ†é…ç»™ä¼˜å…ˆçº§
æ¯ä¸ªå…¥ç«™è¯·æ±‚éƒ½ä¼šæœ‰å¯¹åº”çš„<code>FlowSchema</code>æµ‹è¯•æ˜¯å¦åŒ¹é…ï¼Œé¦–å…ˆä»<code>matchingPrecedence</code>æ•°å€¼æœ€ä½çš„åŒ¹é…å¼€å§‹(æˆ‘ä»¬è®¤ä¸ºè¿™æ˜¯é€»è¾‘ä¸ŠåŒ¹é…æœ€é«˜)ï¼Œç„¶åä¾æ¬¡è¿›è¡ŒåŒ¹é…ï¼Œç›´åˆ°é¦–ä¸ªåŒ¹é…å‡ºç°.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">flowcontrol.apiserver.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">FlowSchema</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w"> </span><span class="c"># FlowSchemaåç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">distinguisherMethod</span><span class="p">:</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ByNamespace </span><span class="w"> </span><span class="c"># Distinguisher åŒºåˆ†å™¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">matchingPrecedence</span><span class="p">:</span><span class="w"> </span><span class="m">800</span><span class="w">  </span><span class="c"># è§„åˆ™ä¼˜å…ˆçº§,æ•°å­—è¶Šå°çº§åˆ«è¶Šé«˜</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priorityLevelConfiguration</span><span class="p">:</span><span class="w"> </span><span class="c"># å¯¹åº”çš„ä¼˜å…ˆçº§é˜Ÿåˆ—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">workload-high </span><span class="w"> </span><span class="c"># ä¼˜å…ˆçº§é˜Ÿåˆ—åç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">resourceRules</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">resources</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;*&#39;</span><span class="w">   </span><span class="c"># å¯¹åº”çš„èµ„æºå’Œè¯·æ±‚ç±»å‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;*&#39;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">subjects</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">system:kube-scheduler</span><span class="w">
</span></span></span></code></pre></div><h3 id="prioritylevelconfigurationä¼˜å…ˆçº§é˜Ÿåˆ—">PriorityLevelConfiguration(ä¼˜å…ˆçº§é˜Ÿåˆ—)</h3>
<p>ä¸€ä¸ª<code>PriorityLevelConfiguration</code>è¡¨ç¤ºå•ä¸ªéš”ç¦»ç±»å‹ã€‚
æ¯ä¸ª<code>PriorityLevelConfiguration</code>å¯¹æœªå®Œæˆçš„è¯·æ±‚æ•°æœ‰å„è‡ªçš„é™åˆ¶,å¯¹æ’é˜Ÿä¸­çš„è¯·æ±‚æ•°ä¹Ÿæœ‰é™åˆ¶ã€‚</p>
<blockquote>
<p>PriorityLevelConfigurationæ˜¯å¯ä»¥è¢«å¤šä¸ªFlowSchemaè¿›è¡Œå¤ç”¨çš„</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">flowcontrol.apiserver.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PriorityLevelConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">global-default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">limited</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">assuredConcurrencyShares</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="c"># å…è®¸çš„å¹¶å‘è¯·æ±‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">limitResponse</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">queuing</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">handSize</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="c"># shuffle shardingé…ç½®,æ¯ä¸ªflowschmea+distinguisherçš„è¯·æ±‚ä¼šè¢«enqueueåˆ°å¤šå°‘ä¸ªé˜Ÿåˆ—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">queueLengthLimit</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w"> </span><span class="c"># æ¯ä¸ªé˜Ÿåˆ—ä¸­çš„å¯¹è±¡æ•°é‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">queues</span><span class="p">:</span><span class="w"> </span><span class="m">128</span><span class="w">  </span><span class="c"># å½“å‰PriorityLevelçš„é˜Ÿåˆ—æ€»æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Queue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Limited</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥é€šè¿‡<code>kubectl get PriorityLevelConfiguration</code>æŸ¥çœ‹å½“å‰kubernetesä¸­çš„ä¼˜å…ˆçº§é˜Ÿåˆ—</p>
<ul>
<li>system: ç”¨äº system:nodes ç»„ï¼ˆå³ kubeletï¼‰çš„è¯·æ±‚ï¼› kubelet å¿…é¡»èƒ½è¿ä¸Š API æœåŠ¡å™¨ï¼Œä»¥ä¾¿å·¥ä½œè´Ÿè½½èƒ½å¤Ÿè°ƒåº¦åˆ°å…¶ä¸Šã€‚</li>
<li>leader-election:
<ul>
<li>ç”¨äºå†…ç½®æ§åˆ¶å™¨çš„é¢†å¯¼é€‰ä¸¾çš„è¯·æ±‚ ï¼ˆç‰¹åˆ«æ˜¯æ¥è‡ª kube-system åç§°ç©ºé—´ä¸­ system:kube- controller-manager å’Œ system:kube-scheduler ç”¨æˆ·å’ŒæœåŠ¡è´¦å·ï¼Œé’ˆå¯¹ endpointsã€ configmaps æˆ– leases çš„è¯·æ±‚ï¼‰ã€‚</li>
<li>å°†è¿™äº›è¯·æ±‚ä¸å…¶ä»–æµé‡ç›¸éš”ç¦»éå¸¸é‡è¦ï¼Œå› ä¸ºé¢†å¯¼è€…é€‰ä¸¾å¤±è´¥ä¼šå¯¼è‡´æ§åˆ¶å™¨å‘ç”Ÿæ•…éšœå¹¶é‡æ–°å¯åŠ¨ï¼Œè¿™åè¿‡æ¥ä¼šå¯¼è‡´æ–°å¯åŠ¨çš„æ§åˆ¶å™¨åœ¨åŒæ­¥ä¿¡æ¯æ—¶ï¼Œæµé‡å¼€é”€æ›´å¤§ã€‚</li>
</ul>
</li>
<li>workload-high: ä¼˜å…ˆçº§ç”¨äºå†…ç½®æ§åˆ¶å™¨çš„è¯·æ±‚</li>
<li>workload-low: ä¼˜å…ˆçº§é€‚ç”¨äºæ¥è‡ªä»»ä½•æœåŠ¡å¸æˆ·çš„è¯·æ±‚ï¼Œé€šå¸¸åŒ…æ‹¬æ¥è‡ª Pods ä¸­è¿è¡Œçš„æ§åˆ¶å™¨çš„æ‰€æœ‰è¯·æ±‚ã€‚</li>
<li>global-default: ä¼˜å…ˆçº§å¯å¤„ç†æ‰€æœ‰å…¶ä»–æµé‡ï¼Œä¾‹å¦‚ï¼šéç‰¹æƒç”¨æˆ·è¿è¡Œçš„äº¤äº’å¼ kubectl å‘½ä»¤ã€‚</li>
<li>exempt: ä¼˜å…ˆçº§çš„è¯·æ±‚å®Œå…¨ä¸å—æµæ§é™åˆ¶ï¼šå®ƒä»¬æ€»æ˜¯ç«‹åˆ»è¢«åˆ†å‘ã€‚ ç‰¹æ®Šçš„ exempt FlowSchemaæŠŠ system:masters ç»„çš„æ‰€æœ‰è¯·æ±‚éƒ½å½’å…¥è¯¥ä¼˜å…ˆçº§ç»„ã€‚</li>
<li>catch-all:
<ul>
<li>ä¼˜å…ˆçº§ä¸ç‰¹æ®Šçš„ catch-all FlowSchema ç»“åˆä½¿ç”¨ï¼Œä»¥ç¡®ä¿æ¯ä¸ªè¯·æ±‚éƒ½åˆ†ç±»ã€‚</li>
<li>ä¸€èˆ¬ä¸åº”è¯¥ä¾èµ–äº catch-all çš„é…ç½®ï¼Œè€Œåº”é€‚å½“åœ°åˆ›å»ºè‡ªå·±çš„ catch-all FlowSchema å’ŒPriorityLevelConfigurationsï¼ˆæˆ–ä½¿ç”¨é»˜è®¤å®‰è£…çš„ global-default é…ç½®ï¼‰ã€‚</li>
<li>ä¸ºäº†å¸®åŠ©æ•è·éƒ¨åˆ†è¯·æ±‚æœªåˆ†ç±»çš„é…ç½®é”™è¯¯ï¼Œå¼ºåˆ¶è¦æ±‚ catch-all ä¼˜å…ˆçº§ä»…å…è®¸5ä¸ªå¹¶å‘ä»½é¢ï¼Œå¹¶ä¸”ä¸å¯¹è¯·æ±‚è¿›è¡Œæ’é˜Ÿï¼Œä½¿å¾—ä»…ä¸ catch-all FlowSchema åŒ¹é…çš„æµé‡è¢«æ‹’ç»çš„å¯èƒ½æ€§æ›´é«˜ï¼Œå¹¶æ˜¾ç¤º HTTP 429 é”™è¯¯ã€‚</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl get PriorityLevelConfiguration</span>
</span></span><span class="line"><span class="cl">NAME              TYPE      ASSUREDCONCURRENCYSHARES   QUEUES   HANDSIZE   QUEUELENGTHLIMIT   AGE
</span></span><span class="line"><span class="cl">catch-all         Limited   <span class="m">5</span>                          &lt;none&gt;   &lt;none&gt;     &lt;none&gt;             13h
</span></span><span class="line"><span class="cl">exempt            Exempt    &lt;none&gt;                     &lt;none&gt;   &lt;none&gt;     &lt;none&gt;             13h
</span></span><span class="line"><span class="cl">global-default    Limited   <span class="m">20</span>                         <span class="m">128</span>      <span class="m">6</span>          <span class="m">50</span>                 13h
</span></span><span class="line"><span class="cl">leader-election   Limited   <span class="m">10</span>                         <span class="m">16</span>       <span class="m">4</span>          <span class="m">50</span>                 13h
</span></span><span class="line"><span class="cl">node-high         Limited   <span class="m">40</span>                         <span class="m">64</span>       <span class="m">6</span>          <span class="m">50</span>                 13h
</span></span><span class="line"><span class="cl">system            Limited   <span class="m">30</span>                         <span class="m">64</span>       <span class="m">6</span>          <span class="m">50</span>                 13h
</span></span><span class="line"><span class="cl">workload-high     Limited   <span class="m">40</span>                         <span class="m">128</span>      <span class="m">6</span>          <span class="m">50</span>                 13h
</span></span><span class="line"><span class="cl">workload-low      Limited   <span class="m">100</span>                        <span class="m">128</span>      <span class="m">6</span>          <span class="m">50</span>                 13h
</span></span></code></pre></div><p>è¯¦ç»†è¯´ä¸€ä¸‹åˆ†æµç­–ç•¥</p>
<ol>
<li>æ ¹æ®<code>service-accounts</code>çš„flowè¿›è¡Œé™åˆ¶,<code>distinguisherMethod</code>æ ¹æ®ä¸åŒçš„ç”¨æˆ·è¿›è¡Œé™æµã€‚</li>
<li>è¿™ä¸€ç±»çš„flowåº”è¯¥é€šè¿‡<code>priorityLevelConfiguration</code>ä¸­å®šä¹‰çš„<code>workload-low</code>è¿›è¡Œé™æµ</li>
<li>é€šè¿‡<code>workload-low</code>ä¸­å®šä¹‰çš„<code>assuredConcurrencyShares</code>è®¾ç½®å½“å‰è¯·æ±‚çš„æœ€å¤§å¹¶å‘æ•°é‡</li>
</ol>
<h2 id="é«˜å¯ç”¨apiserver">é«˜å¯ç”¨APIServer</h2>
<h3 id="æ­å»ºå¤šç§Ÿæˆ·çš„kubernetesé›†ç¾¤">æ­å»ºå¤šç§Ÿæˆ·çš„kubernetesé›†ç¾¤</h3>
<p>æˆä¿¡</p>
<ul>
<li>è®¤è¯: ç¦æ­¢åŒ¿åè®¿é—®ï¼Œåªå…è®¸å¯ä¿¡ç”¨æˆ·åšæ“ä½œã€‚</li>
<li>æˆæƒï¼šåŸºäºæˆä¿¡çš„æ“ä½œï¼Œé˜²æ­¢å¤šç”¨æˆ·ä¹‹é—´äº’ç›¸å½±å“ï¼Œæ¯”å¦‚æ™®é€šç”¨æˆ·åˆ é™¤Kubernetesæ ¸å¿ƒæœåŠ¡ï¼Œæˆ–è€…Aç”¨æˆ·åˆ é™¤æˆ–ä¿®æ”¹Bç”¨æˆ· çš„åº”ç”¨ã€‚</li>
</ul>
<p>éš”ç¦»</p>
<ul>
<li>å¯è§è¡Œéš”ç¦»ï¼šç”¨æˆ·åªå…³å¿ƒè‡ªå·±çš„åº”ç”¨ï¼Œæ— éœ€çœ‹åˆ°å…¶ä»–ç”¨æˆ·çš„æœåŠ¡å’Œéƒ¨ç½²ã€‚</li>
<li>èµ„æºéš”ç¦»ï¼šæœ‰äº›å…³é”®é¡¹ç›®å¯¹èµ„æºéœ€æ±‚è¾ƒé«˜ï¼Œéœ€è¦æœ‰ä¸“ä¸šè®¾å¤‡ï¼Œä¸ä¸å…¶ä»–äººå…±äº«ã€‚</li>
<li>åº”ç”¨è®¿é—®éš”ç¦»ï¼šç”¨æˆ·åˆ›å»ºçš„æœåŠ¡ï¼ŒæŒ‰ç…§æ—¢å®šè§„åˆ™å…è®¸å…¶ä»–ç”¨æˆ·è®¿é—®ã€‚</li>
</ul>
<p>èµ„æºç®¡ç†</p>
<ul>
<li>Quotaç®¡ç†: è°èƒ½ç”¨å¤šå°‘èµ„æº</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>kubernetes-dashboard</title>
      <link>https://blog.mletter.cn/tech/kubernetes/kube-dashboard/</link>
      <pubDate>Fri, 03 Feb 2023 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/kube-dashboard/</guid>
      <description>kuberneteså®˜æ–¹dashboardéƒ¨ç½²æ–¹æ¡ˆ</description>
      <content:encoded><![CDATA[<h2 id="å®˜æ–¹webuiéƒ¨ç½²">å®˜æ–¹WebUIéƒ¨ç½²</h2>
<ul>
<li><a class="link" href="https://github.com/kubernetes/dashboard"  target="_blank" rel="noopener"
    >Dashboard</a></li>
</ul>
<h3 id="å®‰è£…éƒ¨ç½²">å®‰è£…éƒ¨ç½²</h3>
<p>ä»å®˜æ–¹ä»“åº“éƒ¨ç½²</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.1/aio/deploy/recommended.yaml</span>
</span></span></code></pre></div><p>å¦‚æœæ— æ³•ä¸‹è½½è¯·æ–°å»º<code>dashboard.yaml</code>å¤åˆ¶ä»¥ä¸‹å†…å®¹è¿›è¡Œåº”ç”¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Copyright 2017 The Kubernetes Authors.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># you may not use this file except in compliance with the License.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># You may obtain a copy of the License at</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#     http://www.apache.org/licenses/LICENSE-2.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Unless required by applicable law or agreed to in writing, software</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># See the License for the specific language governing permissions and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># limitations under the License.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-csrf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">csrf</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-key-holder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-settings</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;secrets&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;kubernetes-dashboard-key-holder&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;kubernetes-dashboard-certs&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;kubernetes-dashboard-csrf&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;delete&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Allow Dashboard to get and update &#39;kubernetes-dashboard-settings&#39; config map.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;configmaps&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;kubernetes-dashboard-settings&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;update&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Allow Dashboard to get metrics.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;services&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;heapster&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;dashboard-metrics-scraper&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;proxy&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;services/proxy&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;heapster&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;http:heapster:&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;https:heapster:&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;dashboard-metrics-scraper&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;http:dashboard-metrics-scraper&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Allow Metrics Scraper to get metrics from the Metrics server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;metrics.k8s.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;nodes&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">seccompProfile</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RuntimeDefault</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetesui/dashboard:v2.6.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- --<span class="l">auto-generate-certificates</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- --<span class="l">namespace=kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># Uncomment the following line to manually specify Kubernetes API server Host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># If not specified, Dashboard will attempt to auto discover the API server and connect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># to it. Uncomment only if the default does not work.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># - --apiserver-host=http://my-address:port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c"># Create on-disk volume to store exec logs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">1001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="m">2001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;kubernetes.io/os&#34;: </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Comment the following tolerations if Dashboard must not be deployed on master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">seccompProfile</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RuntimeDefault</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetesui/metrics-scraper:v1.0.8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">1001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="m">2001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;kubernetes.io/os&#34;: </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Comment the following tolerations if Dashboard must not be deployed on master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><p>åˆ›å»ºåº”ç”¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f dashboard.yaml
</span></span></code></pre></div><p>æŸ¥çœ‹Dashboardçš„<code>Pod</code>æ˜¯å¦è¿è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># kubectl get pods --all-namespaces</span>
</span></span><span class="line"><span class="cl">NAMESPACE              NAME                                        READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kubernetes-dashboard   dashboard-metrics-scraper-8c47d4b5d-t92v9   1/1     Running   <span class="m">0</span>          26m
</span></span><span class="line"><span class="cl">kubernetes-dashboard   kubernetes-dashboard-6c75475678-zlqn7       1/1     Running   <span class="m">0</span>          26m
</span></span></code></pre></div><p>ä¿®æ”¹Dashboardçš„<code>Services</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="p">[</span><span class="l">root@containerd-kube-master ~]# kubectl edit services kubernetes-dashboard  -n kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># and an empty file will abort the edit. If an error occurs while saving this file will be</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># reopened with the relevant failures.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;v1&#34;,&#34;kind&#34;:&#34;Service&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;labels&#34;:{&#34;k8s-app&#34;:&#34;kubernetes-dashboard&#34;},&#34;name&#34;:&#34;kubernetes-dashboard&#34;,&#34;namespace&#34;:&#34;kubernetes-dashboard&#34;},&#34;spec&#34;:{&#34;ports&#34;:[{&#34;port&#34;:443,&#34;targetPort&#34;:8443}],&#34;selector&#34;:{&#34;k8s-app&#34;:&#34;kubernetes-dashboard&#34;}}}</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2022-09-06T02:58:06Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5359&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">31019fac-9b16-46e5-9172-2cc3f63f2c86</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.114.92</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIPs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="m">10.101.114.92</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">internalTrafficPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipFamilies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">IPv4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipFamilyPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">SingleStack</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">30000</span><span class="w"> </span><span class="c"># æ·»åŠ ä¸€è¡ŒnodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sessionAffinity</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w"> </span><span class="c"># ä¿®æ”¹ä¸ºNodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loadBalancer</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><p>æ”¹å®Œä»¥åä¸€å®šè¦çœ‹ä¸€çœ¼ç”Ÿæ•ˆæ— ç”Ÿæ•ˆå•Š</p>
<ul>
<li>æŸ¥çœ‹åˆ°<code>TYPE</code>å¦‚æœæ˜¯<code>NodePort</code></li>
<li>æŸ¥çœ‹<code>PORT</code>å¯¹åº”443æ˜ å°„åˆ°äº†30000ç«¯å£</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># kubectl get services --all-namespaces</span>
</span></span><span class="line"><span class="cl">NAMESPACE              NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
</span></span><span class="line"><span class="cl">default                kubernetes                  ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                  98m
</span></span><span class="line"><span class="cl">kube-system            kube-dns                    ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   98m
</span></span><span class="line"><span class="cl">kubernetes-dashboard   dashboard-metrics-scraper   ClusterIP   10.103.193.200   &lt;none&gt;        8000/TCP                 43m
</span></span><span class="line"><span class="cl">kubernetes-dashboard   kubernetes-dashboard        NodePort    10.101.114.92    &lt;none&gt;        443:30000/TCP            43m
</span></span></code></pre></div><h3 id="è®¿é—®é¡µé¢">è®¿é—®é¡µé¢</h3>
<ul>
<li>è®¿é—®<a class="link" href="https://ip/"  target="_blank" rel="noopener"
    >https://IP</a>:PORT ä¾‹å¦‚: <a class="link" href="https://blog.mletter.cn/posts/3ac849ff#/login"  target="_blank" rel="noopener"
    >https://10.1.6.45:30000/#/login</a></li>
</ul>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="img" loading="lazy" src="https://bj.bcebos.com/baidu-rmb-video-cover-1/de50d922a1520814268f0051945f2f46.png"></p>
<p>æ–°ç‰ˆæœ¬ä¸­é»˜è®¤ä¸å­˜å‚¨<code>secret</code>çš„åŠ å¯†æ•°æ®äº†,æ‰€ä»¥å¦‚æœä½ æƒ³ä½¿ç”¨Tokenè¿›è¡Œç™»å½•çš„è¯,ä½ éœ€è¦æ–°å»ºä¸€ä¸ªç”¨æˆ·å¹¶ä¸”ç»‘å®šè§’è‰²</p>
<ul>
<li>æ–°å»ºä¸€ä¸ª<code>user.yaml</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">root@containerd-kube-master ~]# kubectl apply -f user.yaml</span><span class="w">
</span></span></span></code></pre></div><p>åŸºäº<code>admin-user</code>åˆ›å»ºä¸€ä¸ªtoken,ç„¶åæŠŠè¾“å‡ºçš„tokenç²˜è´´åˆ°Dashboard</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@Online-Beijing-master1 ~<span class="o">]</span><span class="c1"># kubectl create token admin-user -n kubernetes-dashboard</span>
</span></span><span class="line"><span class="cl">eyJhbGciOiJSUzI1NiIsImtpZCI6InN2amtNUDdoaTRoU3VUVUw3aC1UTkVCRXlBRkhnQmlPTWMzWWZmbUhTd0kifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjc3NTk5NjEwLCJpYXQiOjE2Nzc1OTYwMTAsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiZGU3ZDYxNWItMDk5MC00ZjI3LTlkOGQtNzkwMzQyNjZjNjRlIn19LCJuYmYiOjE2Nzc1OTYwMTAsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.uvntmSuffTF8HGIZNacfmDJr8DdMTY4SR_H6Gyxck6Te_p2J4u5mNNmId2F5uWaoeySCYam-CUkkAO2F5Uh2WjxfD0wb2YI8-FRKic8n40n30TgKhdDeK-wlliDK5kVlf9yvy5uDEc8TWZhkXz-e9WLCMqta4J6_vc6t5PYJf8u1I_SYVOiC5fgP46z3W9bZMYeGV7xmKQGl9OeofQokC1TJCojtrt0AZJ0MW_2FQjZG7ONdiywaOYnST-Ii5rK12hJFoAjZem6aTzXikOJJ03zw7Kw4WqVdMAqnbs81Clkefi-ZPxReED2wi65RbLf8KVXFVWMn9EccX5IQC5Y49Q
</span></span></code></pre></div><h2 id="æ¨èå‡ ä¸ªå…¶ä»–çš„webui">æ¨èå‡ ä¸ªå…¶ä»–çš„WebUi</h2>
<p><a class="link" href="https://kubesphere.io/zh/"  target="_blank" rel="noopener"
    >KubeSphere</a>
<a class="link" href="https://www.kubegems.io/"  target="_blank" rel="noopener"
    >KubeGems</a>
<a class="link" href="https://kuboard.cn/,Kuboard"  target="_blank" rel="noopener"
    >Kuboard</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>kubernetes1.22.0å•èŠ‚ç‚¹é›†ç¾¤éƒ¨ç½²</title>
      <link>https://blog.mletter.cn/tech/kubernetes/install-kubernetes-1220/</link>
      <pubDate>Thu, 29 Dec 2022 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/install-kubernetes-1220/</guid>
      <description>kubeadmç‰ˆéƒ¨ç½²kubernetesæ–¹æ¡ˆ</description>
      <content:encoded><![CDATA[<h2 id="kubernetes12210éƒ¨ç½²">kubernetes1.22.10éƒ¨ç½²</h2>
<h2 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h2>
<ul>
<li>å…¼å®¹çš„ Linux ä¸»æœºã€‚Kubernetes é¡¹ç›®ä¸ºåŸºäº Debian å’Œ Red Hat çš„ Linux å‘è¡Œç‰ˆä»¥åŠé‚£äº›æ²¡æœ‰åŒ…ç®¡ç†å™¨çš„å‘è¡Œç‰ˆæä¾›äº†é€šç”¨è¯´æ˜ã€‚</li>
<li>æ¯å°æœºå™¨ 2 GB æˆ–æ›´å¤š RAMï¼ˆä»»ä½•æ›´å°‘éƒ½ä¼šä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºç•™ä¸‹å¾ˆå°çš„ç©ºé—´ï¼‰ã€‚</li>
<li>2 ä¸ª CPU æˆ–æ›´å¤šã€‚</li>
<li>é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¹‹é—´çš„å®Œæ•´ç½‘ç»œè¿æ¥ï¼ˆå…¬å…±æˆ–ä¸“ç”¨ç½‘ç»œéƒ½å¯ä»¥ï¼‰ã€‚</li>
<li>æ¯ä¸ªèŠ‚ç‚¹çš„å”¯ä¸€ä¸»æœºåã€MAC åœ°å€å’Œ product_uuidã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a class="link" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#verify-mac-address"  target="_blank" rel="noopener"
    >æ­¤å¤„</a>ã€‚</li>
<li>æ‚¨çš„æœºå™¨ä¸Šçš„æŸäº›ç«¯å£æ˜¯å¼€æ”¾çš„ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a class="link" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports"  target="_blank" rel="noopener"
    >æ­¤å¤„</a>ã€‚</li>
<li>äº¤æ¢Swapåˆ†åŒºã€‚å¿…é¡»ç¦ç”¨Swapæ‰èƒ½ä½¿ kubelet æ­£å¸¸å·¥ä½œã€‚</li>
</ul>
<h3 id="æˆ‘çš„æœåŠ¡å™¨é…ç½®åˆ—è¡¨">æˆ‘çš„æœåŠ¡å™¨é…ç½®åˆ—è¡¨</h3>
<p>æ²¡æœ‰å¿…è¦æŒ‰ç…§æˆ‘çš„è¿™ä¸ªé…ç½®å»æ“ä½œä¸ªäººå»ºè®®å®éªŒç¯å¢ƒï¼šæ­£å¸¸æ¼”ç¤ºç¯å¢ƒ2æ ¸2Gå°±å¤Ÿäº†</p>
<h3 id="éœ€è¦å¼€æ”¾çš„ç«¯å£">éœ€è¦å¼€æ”¾çš„ç«¯å£</h3>
<p>è™½ç„¶ etcd ç«¯å£åŒ…å«åœ¨æ§åˆ¶å¹³é¢éƒ¨åˆ†ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥åœ¨å¤–éƒ¨æˆ–è‡ªå®šä¹‰ç«¯å£ä¸Šæ‰˜ç®¡è‡ªå·±çš„ etcd é›†ç¾¤ã€‚
å¯ä»¥è¦†ç›–æ‰€æœ‰é»˜è®¤ç«¯å£å·ã€‚å½“ä½¿ç”¨è‡ªå®šä¹‰ç«¯å£æ—¶ï¼Œè¿™äº›ç«¯å£éœ€è¦æ‰“å¼€è€Œä¸æ˜¯æ­¤å¤„æåˆ°çš„é»˜è®¤å€¼ã€‚
ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯ API æœåŠ¡å™¨ç«¯å£ï¼Œæœ‰æ—¶ä¼šåˆ‡æ¢åˆ° 443ã€‚æˆ–è€…ï¼Œé»˜è®¤ç«¯å£ä¿æŒåŸæ ·ï¼ŒAPI æœåŠ¡å™¨æ”¾åœ¨è´Ÿè½½å‡è¡¡å™¨åé¢ï¼Œè¯¥è´Ÿè½½å‡è¡¡å™¨ç›‘å¬ 443 å¹¶å°†è¯·æ±‚è·¯ç”±åˆ°é»˜è®¤ç«¯å£ä¸Šçš„ API æœåŠ¡å™¨ã€‚</p>
<h3 id="å‡†å¤‡ä¸»æœºåœ°å€">å‡†å¤‡ä¸»æœºåœ°å€</h3>
<ul>
<li>ä¿®æ”¹æ¯ä¸€å°ä¸»æœºçš„<code>/etc/hosts</code>é…ç½®</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># vim /etc/hosts</span>
</span></span><span class="line"><span class="cl">10.1.6.45 containerd-kube-master
</span></span><span class="line"><span class="cl">10.1.6.46 containerd-kube-work1
</span></span><span class="line"><span class="cl">10.1.6.47 containerd-kube-work2
</span></span></code></pre></div><h3 id="å…³é—­swapåˆ†åŒºä»¥åŠé˜²ç«å¢™">å…³é—­swapåˆ†åŒºä»¥åŠé˜²ç«å¢™</h3>
<p>è¿›å…¥<code>fstab</code>åæ‰¾åˆ°ä½ æŒ‚è½½çš„swapåˆ†åŒºæ³¨é‡Šå³å¯.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@bogon ~<span class="o">]</span><span class="c1"># swapoff -a</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># echo &#34;vm.swappiness = 0&#34; &gt;&gt; /etc/sysctl.conf</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@bogon ~<span class="o">]</span><span class="c1"># vim /etc/fstab</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/rl-swap     none                    swap    defaults        0 0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># systemctl stop firewalld &amp;&amp; systemctl disable firewalld # å…³é—­å¹¶ä¸”ç¦ç”¨é˜²ç«å¢™</span>
</span></span></code></pre></div><p>æ‰€æœ‰å†…å®¹å‡†å¤‡å®Œæˆåé‡å¯ä¸‰å°æœåŠ¡å™¨!</p>
<h2 id="containerdçš„åŸºç¡€å®‰è£…å’Œæ“ä½œ">Containerdçš„åŸºç¡€å®‰è£…å’Œæ“ä½œ</h2>
<p>æœ¬æ–‡æ¡£åç»­åŸºäº<code>Containerd</code>+<code>RockyLinux</code>+<code>Kubeadmin</code>éƒ¨ç½²Kubernetes1.24ç‰ˆæœ¬çš„ç¯å¢ƒã€‚</p>
<ul>
<li><a class="link" href="https://containerd.io/"  target="_blank" rel="noopener"
    >containerd</a></li>
<li><a class="link" href="https://www.docker.com/"  target="_blank" rel="noopener"
    >Docker</a></li>
<li><a class="link" href="https://cri-o.io/"  target="_blank" rel="noopener"
    >CRI-O</a></li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯,æ ¹æ®Kuberneteså®˜æ–¹ç»™å‡ºçš„å…¬å‘Šã€‚Kubernetes 1.20xç‰ˆæœ¬å°†ä¼šåºŸå¼ƒå¯¹<code>Dockerçš„æ”¯æŒ</code></p>
<h3 id="é€šè¿‡é˜¿é‡Œäº‘é•œåƒæºå®‰è£…">é€šè¿‡é˜¿é‡Œäº‘é•œåƒæºå®‰è£…</h3>
<ul>
<li><a class="link" href="https://developer.aliyun.com/mirror/"  target="_blank" rel="noopener"
    >å®˜æ–¹é•œåƒç«™</a></li>
<li>ä¸‰å°ä¸»æœºå…¨éƒ¨æ‰§è¡Œæ­¤æ“ä½œ</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># yum install -y yum-utils device-mapper-persistent-data lvm2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># yum -y install containerd.io</span>
</span></span></code></pre></div><p>æŸ¥çœ‹ä¸€ä¸‹<code>containerd</code>çš„ç‰ˆæœ¬</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># containerd -v</span>
</span></span><span class="line"><span class="cl">containerd containerd.io 1.6.8 9cd3357b7fd7218e4aec3eae239db1f68a5a6ec6
</span></span></code></pre></div><h3 id="ç”Ÿæˆcontainerdçš„é…ç½®æ–‡ä»¶">ç”Ÿæˆcontainerdçš„é…ç½®æ–‡ä»¶</h3>
<ul>
<li>ä¸‰å°ä¸»æœºå…¨éƒ¨æ‰§è¡Œæ­¤æ“ä½œ
é»˜è®¤æƒ…å†µä¸‹åœ¨<code>/etc/containerd/config.toml</code>å·²ç»æœ‰è¿™ä¸ªæ–‡ä»¶äº†,ä½†æ˜¯é‡Œé¢æ˜¯ä¸€äº›ç®€çŸ­çš„é…ç½®.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># mkdir - /etc/containerd/</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># containerd config default | tee /etc/containerd/config.toml # ç”Ÿæˆcontainedçš„é»˜è®¤é…ç½®</span>
</span></span></code></pre></div><h3 id="ä¿®æ”¹sandbox_img">ä¿®æ”¹sandbox_img</h3>
<ul>
<li><code>pause</code>ï¼š æ­¤é•œåƒæ˜¯kubernetesçš„åŸºç¡€å®¹å™¨</li>
<li>ä¸‰å°ä¸»æœºå…¨éƒ¨æ‰§è¡Œæ­¤æ“ä½œ
ç”±äºéƒ¨åˆ†ç”¨æˆ·æ— æ³•è¿›å…¥<code>k8s.gcr.io</code>èµ„æºåœ°å€,éœ€è¦å¯¹æ­¤åœ°å€è¿›è¡Œæ›¿æ¢.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">containerd-kube-master</span> <span class="nx">containerd</span><span class="p">]</span><span class="c"># vim /etc/containerd/config.toml</span>
</span></span><span class="line"><span class="cl"><span class="nx">sandbox_image</span> <span class="p">=</span> <span class="s2">&#34;k8s.gcr.io/pause:3.6&#34;</span>  <span class="c"># æ‰¾åˆ°æ­¤é€‰é¡¹å¹¶ä¸”ä¿®æ”¹ä¸º: registry.aliyuncs.com/google_containers/pause:3.6</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">default_runtime</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="nx">runtime_type</span> <span class="p">=</span> <span class="s2">&#34;io.containerd.runtime.v1.linux&#34;</span><span class="c"># ä¿®æ”¹ä¸ºio.containerd.runtime.v1.linux</span>
</span></span></code></pre></div><h3 id="ä¿®æ”¹systemd-cgroupé©±åŠ¨">ä¿®æ”¹Systemd Cgroupé©±åŠ¨</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">runtimes</span><span class="p">.</span><span class="nx">runc</span><span class="p">.</span><span class="nx">options</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SystemdCgroup</span> <span class="p">=</span> <span class="kc">true</span>
</span></span></code></pre></div><p>ç„¶åé‡å¯<code>containerd</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"> systemctl restart containerd
</span></span></code></pre></div><h3 id="è®¾ç½®crictl-æŸ¥æ‰¾çš„å®¹å™¨è¿è¡Œæ—¶">è®¾ç½®Crictl æŸ¥æ‰¾çš„å®¹å™¨è¿è¡Œæ—¶</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">crictl config runtime-endpoint unix:///var/run/containerd/containerd.sock
</span></span></code></pre></div><h3 id="é¢å¤–-è®¾ç½®containerdçš„ç§æœ‰ä»“åº“">(é¢å¤–) è®¾ç½®Containerdçš„ç§æœ‰ä»“åº“</h3>
<p>å¦‚æœä½ æƒ³ç”¨è‡ªå·±çš„ç§æœ‰ä»“åº“çš„è¯ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è¿›è¡Œè®¾å®š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">image_decryption</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="nx">key_model</span> <span class="p">=</span> <span class="s2">&#34;node&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="nx">config_path</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">auths</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">configs</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">configs</span><span class="p">.</span><span class="s2">&#34;10.1.6.15&#34;</span><span class="p">.</span><span class="nx">auth</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	   <span class="nx">username</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span> <span class="c"># ç§æœ‰ä»“åº“è´¦å·</span>
</span></span><span class="line"><span class="cl">	   <span class="nx">password</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span> <span class="c"># ç§æœ‰ä»“åº“å¯†ç </span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">headers</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">mirrors</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">mirrors</span><span class="p">.</span><span class="s2">&#34;10.1.6.15&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nx">endpoint</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span> <span class="c"># ç§æœ‰ä»“åº“åœ°å€</span>
</span></span></code></pre></div><h3 id="å¯åŠ¨containerd">å¯åŠ¨containerd</h3>
<ul>
<li>ä¸‰å°ä¸»æœºå…¨éƒ¨æ‰§è¡Œæ­¤æ“ä½œ
ä¿è¯<code>Active: active(running)</code>çš„çŠ¶æ€å³å¯</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># systemctl restart containerd</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># systemctl enable containerd</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># systemctl status containerd</span>
</span></span><span class="line"><span class="cl">â— containerd.service - containerd container runtime
</span></span><span class="line"><span class="cl">   Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/containerd.service<span class="p">;</span> disabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
</span></span><span class="line"><span class="cl">   Active: active <span class="o">(</span>running<span class="o">)</span> since Mon 2022-09-05 02:53:02 EDT<span class="p">;</span> 6s ago
</span></span><span class="line"><span class="cl">     Docs: &lt;https://containerd.io&gt;
</span></span><span class="line"><span class="cl">  Process: <span class="m">8465</span> <span class="nv">ExecStartPre</span><span class="o">=</span>/sbin/modprobe overlay <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>
</span></span><span class="line"><span class="cl"> Main PID: <span class="m">8467</span> <span class="o">(</span>containerd<span class="o">)</span>
</span></span><span class="line"><span class="cl">    Tasks: <span class="m">12</span>
</span></span><span class="line"><span class="cl">   Memory: 25.2M
</span></span><span class="line"><span class="cl">   CGroup: /system.slice/containerd.service
</span></span><span class="line"><span class="cl">           â””â”€8467 /usr/bin/containerd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Sep <span class="m">05</span> 02:53:02 containerd-kube-master containerd<span class="o">[</span>8467<span class="o">]</span>: <span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-09-05T02:53:02.159619104-04:00&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;Start subscribing containerd event&#34;</span>
</span></span><span class="line"><span class="cl">Sep <span class="m">05</span> 02:53:02 containerd-kube-master containerd<span class="o">[</span>8467<span class="o">]</span>: <span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-09-05T02:53:02.159662811-04:00&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;Start recovering state&#34;</span>
</span></span><span class="line"><span class="cl">Sep <span class="m">05</span> 02:53:02 containerd-kube-master containerd<span class="o">[</span>8467<span class="o">]</span>: <span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-09-05T02:53:02.159718042-04:00&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;Start event monitor&#34;</span>
</span></span><span class="line"><span class="cl">Sep <span class="m">05</span> 02:53:02 containerd-kube-master containerd<span class="o">[</span>8467<span class="o">]</span>: <span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-09-05T02:53:02.159737174-04:00&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;Start snapshots syncer&#34;</span>
</span></span><span class="line"><span class="cl">Sep <span class="m">05</span> 02:53:02 containerd-kube-master containerd<span class="o">[</span>8467<span class="o">]</span>: <span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-09-05T02:53:02.159750064-04:00&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;Start cni network conf syncer for default&#34;</span>
</span></span><span class="line"><span class="cl">Sep <span class="m">05</span> 02:53:02 containerd-kube-master containerd<span class="o">[</span>8467<span class="o">]</span>: <span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-09-05T02:53:02.159756351-04:00&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;Start streaming server&#34;</span>
</span></span><span class="line"><span class="cl">Sep <span class="m">05</span> 02:53:02 containerd-kube-master containerd<span class="o">[</span>8467<span class="o">]</span>: <span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-09-05T02:53:02.159868546-04:00&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span>serving... <span class="nv">address</span><span class="o">=</span>/run/containerd/containerd.sock.ttrpc
</span></span><span class="line"><span class="cl">Sep <span class="m">05</span> 02:53:02 containerd-kube-master containerd<span class="o">[</span>8467<span class="o">]</span>: <span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-09-05T02:53:02.159906215-04:00&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span>serving... <span class="nv">address</span><span class="o">=</span>/run/containerd/containerd.sock
</span></span><span class="line"><span class="cl">Sep <span class="m">05</span> 02:53:02 containerd-kube-master containerd<span class="o">[</span>8467<span class="o">]</span>: <span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-09-05T02:53:02.160196660-04:00&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;containerd successfully booted in 0.021144s&#34;</span>
</span></span><span class="line"><span class="cl">Sep <span class="m">05</span> 02:53:02 containerd-kube-master systemd<span class="o">[</span>1<span class="o">]</span>: Started containerd container runtime.
</span></span></code></pre></div><h3 id="é…ç½®ipv4è½¬å‘">é…ç½®IPV4è½¬å‘</h3>
<ul>
<li>ä¸‰å°å…¨éƒ¨æ‰§è¡Œ</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | tee /etc/modules-load.d/kubernetes1.24.conf
</span></span></span><span class="line"><span class="cl"><span class="s">overlay
</span></span></span><span class="line"><span class="cl"><span class="s">br_netfilter
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | tee /etc/sysctl.d/kubernetes1.24-forsys.conf
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">net.ipv4.ip_forward = 1
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># modprobe br_netfilter</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># sysctl --system</span>
</span></span></code></pre></div><h2 id="kuberneteså®‰è£…">kuberneteså®‰è£…</h2>
<p>kubernetesçš„å®‰è£…ä¾æ—§æ˜¯åŸºäºaliyun</p>
<h3 id="é€šè¿‡é˜¿é‡Œäº‘é•œåƒæºå®‰è£…-1">é€šè¿‡é˜¿é‡Œäº‘é•œåƒæºå®‰è£…</h3>
<ul>
<li>ä¸‰å°å…¨éƒ¨å®‰è£…
ç”±äºå®˜ç½‘æœªå¼€æ”¾åŒæ­¥æ–¹å¼, å¯èƒ½ä¼šæœ‰ç´¢å¼•gpgæ£€æŸ¥å¤±è´¥çš„æƒ…å†µ, è¿™æ—¶è¯·ç”¨ <code>yum install -y --nogpgcheck kubelet kubeadm kubectl</code> å®‰è£…</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class="line"><span class="cl"><span class="s">[kubernetes]
</span></span></span><span class="line"><span class="cl"><span class="s">name=Kubernetes
</span></span></span><span class="line"><span class="cl"><span class="s">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span class="line"><span class="cl"><span class="s">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgcheck=1
</span></span></span><span class="line"><span class="cl"><span class="s">repo_gpgcheck=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-work1 ~<span class="o">]</span><span class="c1"># yum install -y kubelet-1.22.10 kubeadm-1.22.10 kubectl-1.22.10</span>
</span></span></code></pre></div><p>å¯ä»¥é€šè¿‡<code>yum --showduplicates list kubelet</code>æŸ¥çœ‹å½“å‰ä»“åº“ä¸­å¯ç”¨çš„ç‰ˆæœ¬</p>
<h3 id="å®‰è£…å‘½ä»¤æç¤º">å®‰è£…å‘½ä»¤æç¤º</h3>
<p>å®‰è£…åå¯ä»¥ä½¿ç”¨tabè¿›è¡Œå¿«æ·æç¤º</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># yum -y install bash-completion</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># source &lt;(kubeadm completion bash) &amp;&amp; source &lt;(kubectl completion bash)</span>
</span></span></code></pre></div><p>å¦‚æœä½ æƒ³è¦<code>æ°¸ä¹…</code>çš„ä½¿å…¶ç”Ÿæ•ˆ,è¯·æŠŠä»–ä»¬åŠ å…¥åˆ°<code>.bashrc</code>å½“ä¸­</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> ~
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># vim .bashrc</span>
</span></span><span class="line"><span class="cl"><span class="c1"># .bashrc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># User specific aliases and functions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">rm</span><span class="o">=</span><span class="s1">&#39;rm -i&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">cp</span><span class="o">=</span><span class="s1">&#39;cp -i&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">mv</span><span class="o">=</span><span class="s1">&#39;mv -i&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Source global definitions</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -f /etc/bashrc <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        . /etc/bashrc
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span> &lt;<span class="o">(</span>kubeadm completion bash<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span> &lt;<span class="o">(</span>kubectl completion bash<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span> &lt;<span class="o">(</span>crictl completion bash<span class="o">)</span>
</span></span></code></pre></div><h3 id="å¯åŠ¨kubelet">å¯åŠ¨kubelet</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># systemctl enable kubelet</span>
</span></span></code></pre></div><h3 id="åˆå§‹åŒ–é›†ç¾¤é…ç½®ä¿¡æ¯">åˆå§‹åŒ–é›†ç¾¤é…ç½®ä¿¡æ¯</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># kubeadm config print init-defaults &gt; init.yaml</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">bootstrapTokens</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">groups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">system:bootstrappers:kubeadm:default-node-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">abcdef.0123456789abcdef</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="l">24h0m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">usages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">signing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">authentication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">InitConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">localAPIEndpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">advertiseAddress</span><span class="p">:</span><span class="w"> </span><span class="m">10.1.6.45</span><span class="w"> </span><span class="c"># åˆå§‹åŒ–çš„ç¬¬ä¸€å°masterä¸»æœºçš„åœ°å€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bindPort</span><span class="p">:</span><span class="w"> </span><span class="m">6443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeRegistration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">criSocket</span><span class="p">:</span><span class="w"> </span><span class="l">unix:///var/run/containerd/containerd.sock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-master</span><span class="w"> </span><span class="c"># å®šä¹‰ä¸»æœºçš„å”¯ä¸€åç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">taints</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiServer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">timeoutForControlPlane</span><span class="p">:</span><span class="w"> </span><span class="l">4m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">certificatesDir</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/pki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">controllerManager</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">dns</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dataDir</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imageRepository</span><span class="p">:</span><span class="w"> </span><span class="l">registry.aliyuncs.com/google_containers</span><span class="w"> </span><span class="c"># ä¿®æ”¹ä¸ºé˜¿é‡Œäº‘åœ°å€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kubernetesVersion</span><span class="p">:</span><span class="w"> </span><span class="m">1.22.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">networking</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dnsDomain</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceSubnet</span><span class="p">:</span><span class="w"> </span><span class="m">10.96.0.0</span><span class="l">/12  </span><span class="w"> </span><span class="c"># Podä½¿ç”¨çš„å­ç½‘åœ°å€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">scheduler</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># kubeadm init --config=init.yaml   # ç­‰å¾…é•œåƒPullå®Œæˆ</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>init<span class="o">]</span> Using Kubernetes version: v1.24.0
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Pulling images required <span class="k">for</span> setting up a Kubernetes cluster
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> This might take a minute or two, depending on the speed of your internet connection
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> You can also perform this action in beforehand using <span class="s1">&#39;kubeadm config images pull&#39;</span>
</span></span></code></pre></div><h3 id="åˆ›å»ºadminé…ç½®ç›®å½•">åˆ›å»ºadminé…ç½®ç›®å½•</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># mkdir -p $HOME/.kube</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</span></span></code></pre></div><h3 id="åˆ›å»ºé›†ç¾¤ç½‘ç»œ">åˆ›å»ºé›†ç¾¤ç½‘ç»œ</h3>
<p>å› ä¸ºflannelä¸æ”¯æŒç½‘ç»œéš”ç¦»,æ‰€ä»¥ä¸æƒ³ç”¨äº†!</p>
<ul>
<li>ä¸å†åŸºäº<code>flannel</code>,è€Œæ˜¯åŸºäº<code>calico</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master .kube<span class="o">]</span><span class="c1"># curl https://raw.githubusercontent.com/projectcalico/calico/v3.24.1/manifests/calico.yaml -O</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --&gt;è¿™ä¸ªåœ°å€å¥½åƒæ˜¯ç”¨ä¸äº†äº†,ç°åœ¨404äº†...</span>
</span></span><span class="line"><span class="cl">curl https://projectcalico.docs.tigera.io/manifests/calico.yaml -O
</span></span></code></pre></div><p>ç¼–è¾‘<code>calico.yaml</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CALICO_IPV4POOL_CIDR</span><span class="w"> </span><span class="c"># ä¿®æ”¹CIDRä¸ºKubernetesçš„å­ç½‘åœ°å€,å³åˆå§‹åŒ–é›†ç¾¤çš„serviceSubnet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.96.0.0/12&#34;</span><span class="w">
</span></span></span></code></pre></div><p>åˆ›å»º<code>calico</code>ç½‘ç»œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># kubectl apply -f calico.yaml</span>
</span></span></code></pre></div><h3 id="åŠ å…¥é›†ç¾¤">åŠ å…¥é›†ç¾¤</h3>
<p>å¦‚æœåˆå§‹åŒ–æˆåŠŸä¼šå‡ºç°<code>Your Kubernetes control-plane has initialized successfully!</code></p>
<ul>
<li>åœ¨nodeèŠ‚ç‚¹æ‰§è¡Œ</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-work1 containerd<span class="o">]</span><span class="c1"># kubeadm join 10.1.6.45:6443 --token abcdef.0123456789abcdef \\</span>
</span></span><span class="line"><span class="cl">        --discovery-token-ca-cert-hash sha256:417d4385cc4f0cc572b106a6a13bf59fd865421f12a401f3660afa6ca19e500d
</span></span></code></pre></div><h3 id="éªŒè¯é›†ç¾¤">éªŒè¯é›†ç¾¤</h3>
<p>æŸ¥çœ‹masterèŠ‚ç‚¹çš„<code>Pod</code>æ˜¯å¦å…¨éƒ¨å¯åŠ¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># kubectl get pods --all-namespaces</span>
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                        READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   calico-kube-controllers-6799f5f4b4-pf8w8    1/1     Running   <span class="m">0</span>          2m16s
</span></span><span class="line"><span class="cl">kube-system   calico-node-lzcjk                           1/1     Running   <span class="m">0</span>          54s
</span></span><span class="line"><span class="cl">kube-system   calico-node-mrqkd                           1/1     Running   <span class="m">0</span>          2m16s
</span></span><span class="line"><span class="cl">kube-system   calico-node-r45bc                           1/1     Running   <span class="m">0</span>          71s
</span></span><span class="line"><span class="cl">kube-system   coredns-74586cf9b6-gkmbl                    1/1     Running   <span class="m">0</span>          2m37s
</span></span><span class="line"><span class="cl">kube-system   coredns-74586cf9b6-tgh6f                    1/1     Running   <span class="m">0</span>          2m37s
</span></span><span class="line"><span class="cl">kube-system   etcd-kubernetes-master                      1/1     Running   <span class="m">2</span>          2m42s
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-kubernetes-master            1/1     Running   <span class="m">2</span>          2m43s
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-kubernetes-master   1/1     Running   <span class="m">2</span>          2m43s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-mx4bg                            1/1     Running   <span class="m">0</span>          54s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-ssw98                            1/1     Running   <span class="m">0</span>          71s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-tpgfj                            1/1     Running   <span class="m">0</span>          2m38s
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-kubernetes-master            1/1     Running   <span class="m">2</span>          2m43s
</span></span></code></pre></div><p>ä»masterä¸ŠæŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦å·²ç»å…¨éƒ¨<code>Ready</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># kubectl get nodes</span>
</span></span><span class="line"><span class="cl">NAME                    STATUS   ROLES           AGE     VERSION
</span></span><span class="line"><span class="cl">containerd-kube-work1   Ready    &lt;none&gt;          55s     v1.24.2
</span></span><span class="line"><span class="cl">containerd-kube-work2   Ready    &lt;none&gt;          38s     v1.24.2
</span></span><span class="line"><span class="cl">containerd-kube-master  Ready    control-plane   2m29s   v1.24.2
</span></span></code></pre></div><p>åˆ°æ­¤ä¸ºæ­¢,1.24çš„kuberneteså·²ç»å®‰è£…å®Œæ¯•</p>
<h3 id="æä¸€ä¸ªå°é—®é¢˜">æä¸€ä¸ªå°é—®é¢˜</h3>
<p>çœ‹ä¸€ä¸‹ä½ ä»¬çš„<code>coredns</code>æ˜¯å¦åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Š,å¦‚æœåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Š,å»ºè®®é‡æ–°åˆ†é…ä¸€ä¸‹corednsä¿è¯å…¶é«˜å¯ç”¨æ€§</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># kubectl get pods --all-namespaces -o wide</span>
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                        READY   STATUS    RESTARTS   AGE   IP            NODE                    NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">kube-system   coredns-74586cf9b6-gkmbl                    1/1     Running   <span class="m">0</span>          32m   10.105.56.1   kubernetes-master       &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">kube-system   coredns-74586cf9b6-tgh6f                    1/1     Running   <span class="m">0</span>          32m   10.105.56.3   kubernetes-master       &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>é‡æ–°åˆ†é…<code>coredns</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># kubectl --namespace kube-system rollout restart deployment coredns</span>
</span></span></code></pre></div><h2 id="é—®é¢˜è§£å†³">é—®é¢˜è§£å†³</h2>
<h3 id="ä½¿ç”¨crictl-imageå‡ºç°warn0000-image-connect-using-default-endpoints">ä½¿ç”¨crictl imageå‡ºç°<code>WARN[0000] image connect using default endpoints</code></h3>
<ul>
<li>å‡ºç°è¯¥é—®é¢˜çš„åŸå› æ˜¯ç”±äºcrictlä¸çŸ¥é“ä½¿ç”¨é‚£ä¸ª<code>sock</code>å¯¼è‡´çš„</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master ~<span class="o">]</span><span class="c1"># crictl image</span>
</span></span><span class="line"><span class="cl">WARN<span class="o">[</span>0000<span class="o">]</span> image connect using default endpoints: <span class="o">[</span>unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span class="o">]</span>. As the default settings are now deprecated, you should <span class="nb">set</span> the endpoint instead.
</span></span></code></pre></div><blockquote>
<p>è§£å†³æ–¹æ³•å¦‚ä¸‹</p>
</blockquote>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹<code>containerd</code>çš„<code>sock</code>å­˜æ”¾äº<code>/run/containerd/containerd.sock</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="c"># é‡æ–°è®¾ç½®ä¸€ä¸‹ä½¿ç”¨çš„runtime-endpoint</span>
</span></span><span class="line"><span class="cl"><span class="nx">crictl</span> <span class="nx">config</span> <span class="nx">runtime-endpoint</span> <span class="nx">unix</span><span class="err">:///</span><span class="nx">run</span><span class="err">/</span><span class="nx">containerd</span><span class="err">/</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">sock</span>
</span></span></code></pre></div><p>é»˜è®¤ç”Ÿæˆçš„<code>crictl</code>å­˜æ”¾åœ¨<code>/etc/crictl.yaml</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># vim /etc/crictl.yaml</span>
</span></span></code></pre></div><p>ç¼–è¾‘é…ç½®æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">runtime-endpoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;unix:///run/containerd/containerd.sock&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">image-endpoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;unix:///run/containerd/containerd.sock&#34;</span><span class="w"> </span><span class="c"># æ–°ç‰ˆæœ¬å¢åŠ äº†image-endpointéœ€è¦æ‰‹åŠ¨æ›´æ”¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">pull-image-on-create</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">disable-pull-on-run</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># systemctl daemon-reload</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master containerd<span class="o">]</span><span class="c1"># crictl image</span>
</span></span><span class="line"><span class="cl">IMAGE               TAG                 IMAGE ID            SIZE
</span></span></code></pre></div><h3 id="masterä¸»é›†ç¾¤åŠ å…¥tokenè¿‡æœŸå¦‚ä½•å¤„ç†">Masterä¸»é›†ç¾¤åŠ å…¥tokenè¿‡æœŸå¦‚ä½•å¤„ç†</h3>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹,è¯¥tokenåªæœ‰24å°æ—¶,å¦‚æœtokenå€¼è¿‡æœŸçš„è¯éœ€è¦é‡æ–°ç”Ÿæˆ</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">--discovery-token-ca-cert-hash sha256:793106d3b4305808d55c3cdb211f89a768bec86ecef64264b131dc8f2548da16
</span></span></code></pre></div><ol>
<li>æŸ¥çœ‹å½“å‰masteré›†ç¾¤çš„tokenåˆ—è¡¨</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master .kube<span class="o">]</span><span class="c1"># kubeadm token list</span>
</span></span><span class="line"><span class="cl">TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
</span></span><span class="line"><span class="cl">abcdef.0123456789abcdef   8h          2022-09-06T10:10:05Z   authentication,signing   &lt;none&gt;                                                     system:bootstrappers:kubeadm:default-node-token
</span></span></code></pre></div><ol start="2">
<li>é‡æ–°ç”Ÿæˆä¸€ä»½token</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master .kube<span class="o">]</span><span class="c1"># kubeadm token create</span>
</span></span></code></pre></div><ol start="3">
<li>é€šè¿‡è¯ä¹¦hashtokne</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master .kube<span class="o">]</span><span class="c1"># openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &#39;s/^.* //&#39;</span>
</span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>åˆ©ç”¨Kubeadmè¿›è¡Œå¤šMasteré«˜å¯ç”¨éƒ¨ç½²</title>
      <link>https://blog.mletter.cn/tech/kubernetes/install-kubernetes-ha/</link>
      <pubDate>Thu, 29 Dec 2022 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/install-kubernetes-ha/</guid>
      <description>å¦‚ä½•ä½¿ç”¨kubeadmæ–¹æ¡ˆæ¥å®‰è£…é«˜å¯ç”¨çš„kubernetesé›†ç¾¤</description>
      <content:encoded><![CDATA[<h1 id="åˆ©ç”¨kubeadmåˆ›å»ºé«˜å¯ç”¨é›†ç¾¤">åˆ©ç”¨Kubeadmåˆ›å»ºé«˜å¯ç”¨é›†ç¾¤</h1>
<ul>
<li>ä½¿ç”¨å…·æœ‰å †å çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ã€‚è¿™ç§æ–¹æ³•æ‰€éœ€åŸºç¡€è®¾æ–½è¾ƒå°‘ã€‚etcd æˆå‘˜å’Œæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä½äºåŒä¸€ä½ç½®ã€‚</li>
<li>ä½¿ç”¨å¤–éƒ¨ etcd é›†ç¾¤ã€‚è¿™ç§æ–¹æ³•æ‰€éœ€åŸºç¡€è®¾æ–½è¾ƒå¤šã€‚æ§åˆ¶å¹³é¢çš„èŠ‚ç‚¹å’Œ etcd æˆå‘˜æ˜¯åˆ†å¼€çš„ã€‚
åœ¨ä¸‹ä¸€æ­¥ä¹‹å‰ï¼Œä½ åº”è¯¥ä»”ç»†è€ƒè™‘å“ªç§æ–¹æ³•æ›´å¥½åœ°æ»¡è¶³ä½ çš„åº”ç”¨ç¨‹åºå’Œç¯å¢ƒçš„éœ€æ±‚ã€‚ é«˜å¯ç”¨æ‹“æ‰‘é€‰é¡¹ è®²è¿°äº†æ¯ç§æ–¹æ³•çš„ä¼˜ç¼ºç‚¹ã€‚</li>
<li><a class="link" href="https://blog.mletter.cn/kubernetes/InstallKubernetes1.22.10"  target="_blank" rel="noopener"
    >å¦‚ä½•å®‰è£…Kubectlå’ŒKubeadm</a></li>
<li><a class="link" href="https://blog.mletter.cn/kubernetes/InstallEtcdHA"  target="_blank" rel="noopener"
    >å¦‚ä½•å®‰è£…å¤–éƒ¨çš„Etcdé›†ç¾¤</a></li>
</ul>
<h2 id="å‚ä¸ä¸»æœºåˆ—è¡¨">å‚ä¸ä¸»æœºåˆ—è¡¨</h2>
<table>
  <thead>
      <tr>
          <th>IP</th>
          <th>CPU</th>
          <th>å†…å­˜</th>
          <th style="text-align: left">ç¡¬ç›˜</th>
          <th style="text-align: left">è§’è‰²</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>10.1.6.48</td>
          <td>8</td>
          <td>16</td>
          <td style="text-align: left">100</td>
          <td style="text-align: left">control-plane1</td>
      </tr>
      <tr>
          <td>10.1.6.24</td>
          <td>8</td>
          <td>16</td>
          <td style="text-align: left">100</td>
          <td style="text-align: left">control-plane2</td>
      </tr>
      <tr>
          <td>10.1.6.45</td>
          <td>8</td>
          <td>16</td>
          <td style="text-align: left">100</td>
          <td style="text-align: left">control-plane3</td>
      </tr>
      <tr>
          <td>10.1.6.46</td>
          <td>8</td>
          <td>16</td>
          <td style="text-align: left">100</td>
          <td style="text-align: left">work1</td>
      </tr>
      <tr>
          <td>10.1.6.43</td>
          <td>8</td>
          <td>16</td>
          <td style="text-align: left">100</td>
          <td style="text-align: left">work2</td>
      </tr>
      <tr>
          <td>10.1.6.47</td>
          <td>8</td>
          <td>16</td>
          <td style="text-align: left">100</td>
          <td style="text-align: left">work3</td>
      </tr>
      <tr>
          <td>10.1.6.213</td>
          <td>4</td>
          <td>4</td>
          <td style="text-align: left">20</td>
          <td style="text-align: left">HA+KP1</td>
      </tr>
      <tr>
          <td>10.1.6.214</td>
          <td>4</td>
          <td>4</td>
          <td style="text-align: left">20</td>
          <td style="text-align: left">HA+KP2</td>
      </tr>
      <tr>
          <td>10.1.6.215</td>
          <td></td>
          <td></td>
          <td style="text-align: left"></td>
          <td style="text-align: left">Load_Balancer_IP</td>
      </tr>
      <tr>
          <td>10.1.6.51</td>
          <td>8</td>
          <td>16</td>
          <td style="text-align: left">100</td>
          <td style="text-align: left">Etcd1</td>
      </tr>
      <tr>
          <td>10.1.6.52</td>
          <td>8</td>
          <td>16</td>
          <td style="text-align: left">100</td>
          <td style="text-align: left">Etcd2</td>
      </tr>
      <tr>
          <td>10.1.6.53</td>
          <td>8</td>
          <td>16</td>
          <td style="text-align: left">100</td>
          <td style="text-align: left">Etcd3</td>
      </tr>
  </tbody>
</table>
<h2 id="ä¸ºkube-apiserveråˆ›å»ºè´Ÿè½½å‡è¡¡å™¨">ä¸ºKube-apiserveråˆ›å»ºè´Ÿè½½å‡è¡¡å™¨</h2>
<p>Keepalived æä¾› VRRP å®ç°ï¼Œå¹¶å…è®¸æ‚¨é…ç½® Linux æœºå™¨ä½¿è´Ÿè½½å‡è¡¡ï¼Œé¢„é˜²å•ç‚¹æ•…éšœã€‚HAProxy æä¾›å¯é ã€é«˜æ€§èƒ½çš„è´Ÿè½½å‡è¡¡ï¼Œèƒ½ä¸ Keepalived å®Œç¾é…åˆã€‚</p>
<p>ç”±äº lb1 å’Œ lb2 ä¸Šå®‰è£…äº† Keepalived å’Œ HAproxyï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æ•…éšœï¼Œè™šæ‹Ÿ IP åœ°å€ï¼ˆå³æµ®åŠ¨ IP åœ°å€ï¼‰å°†è‡ªåŠ¨ä¸å¦ä¸€ä¸ªèŠ‚ç‚¹å…³è”ï¼Œä½¿é›†ç¾¤ä»ç„¶å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä»è€Œå®ç°é«˜å¯ç”¨ã€‚è‹¥æœ‰éœ€è¦ï¼Œä¹Ÿå¯ä»¥æ­¤ä¸ºç›®çš„ï¼Œæ·»åŠ æ›´å¤šå®‰è£… Keepalived å’Œ HAproxy çš„èŠ‚ç‚¹ã€‚</p>
<p>å…ˆè¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… <code>Keepalived</code> å’Œ <code>HAproxy</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yum install keepalived haproxy psmisc -y
</span></span><span class="line"><span class="cl">dnf install keepalived haproxy psmisc -y
</span></span></code></pre></div><p>åœ¨ä¸¤å°ç”¨äºè´Ÿè½½å‡è¡¡çš„æœºå™¨ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥é…ç½® Proxyï¼ˆä¸¤å°æœºå™¨çš„ Proxy é…ç½®ç›¸åŒï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vi /etc/haproxy/haproxy.cfg
</span></span></code></pre></div><pre tabindex="0"><code class="language-conf" data-lang="conf">global
    log /dev/log  local0 warning
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

   stats socket /var/lib/haproxy/stats

defaults
  log global
  option  httplog
  option  dontlognull
        timeout connect 5000
        timeout client 50000
        timeout server 50000

frontend kube-apiserver
  bind *:8443
  mode tcp
  option tcplog
  default_backend kube-apiserver

backend kube-apiserver
    mode tcp
    option tcplog
    option tcp-check
    balance roundrobin
    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
    server kube-apiserver-1 10.1.6.48:6443 check # Replace the IP address with your own.
    server kube-apiserver-2 10.1.6.24:6443 check # Replace the IP address with your own.
    server kube-apiserver-3 10.1.6.45:6443 check # Replace the IP address with your own.
</code></pre><p>å¯åŠ¨Haproxy</p>
<blockquote>
<p>è¯·ç¡®ä¿ä½ çš„LB2ä¹Ÿå·²ç»è¿›è¡Œå¦‚ä¸Šé…ç½®</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl restart haproxy
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> haproxy
</span></span></code></pre></div><p>é…ç½®Keepalived
<code>KP1</code>é…ç½®å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim /etc/keepalived/keepalived.conf
</span></span></code></pre></div><pre tabindex="0"><code class="language-conf" data-lang="conf">global_defs {
  notification_email {
  }
  router_id LVS_DEVEL
  vrrp_skip_check_adv_addr
  vrrp_garp_interval 0
  vrrp_gna_interval 0
}

vrrp_script chk_haproxy {
  script &#34;killall -0 haproxy&#34;
  interval 2
  weight 2
}

vrrp_instance haproxy-vip {
  state BACKUP
  priority 100
  interface ens192                      # ç½‘å¡åç§°
  virtual_router_id 60
  advert_int 1
  authentication {
    auth_type PASS
    auth_pass 1111
  }
  unicast_src_ip 10.1.6.213      # The IP address of this machine
  unicast_peer {
    10.1.6.214                  # The IP address of peer machines
  }

  virtual_ipaddress {
    10.1.6.215/24                  # è™šæ‹ŸIPåœ°å€
  }

  track_script {
    chk_haproxy
  }
}
</code></pre><p><code>KP2</code>é…ç½®å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim /etc/keepalived/keepalived.conf
</span></span></code></pre></div><pre tabindex="0"><code class="language-conf" data-lang="conf">global_defs {
  notification_email {
  }
  router_id LVS_DEVEL
  vrrp_skip_check_adv_addr
  vrrp_garp_interval 0
  vrrp_gna_interval 0
}

vrrp_script chk_haproxy {
  script &#34;killall -0 haproxy&#34;
  interval 2
  weight 2
}

vrrp_instance haproxy-vip {
  state BACKUP
  priority 90
  interface ens192                      # Network card
  virtual_router_id 60
  advert_int 1
  authentication {
    auth_type PASS
    auth_pass 1111
  }
  unicast_src_ip 10.1.6.214      # The IP address of this machine
  unicast_peer {
    10.1.6.214                         # The IP address of peer machines
  }

  virtual_ipaddress {
    10.1.6.215/24                  # The VIP address
  }

  track_script {
    chk_haproxy
  }
}
</code></pre><p>è¯·ç¡®ä¿ä½ çš„<code>KP1</code>å’Œ<code>KP2</code>éƒ½å®Œæˆäº†å¦‚ä¸Šé…ç½®</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl start keepalived
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> keepalived
</span></span></code></pre></div><h2 id="é…ç½®masterä¸»æœºèŠ‚ç‚¹çš„hostsæ–‡ä»¶">é…ç½®Masterä¸»æœºèŠ‚ç‚¹çš„Hostsæ–‡ä»¶</h2>
<ul>
<li>
<p>æ‰€æœ‰çš„Masterä¸»æœºéƒ½éœ€è¦è¿›è¡Œé…ç½®,é˜²æ­¢åç»­è§£æä¸åˆ°<code>api.k8s.verbos.com</code></p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">10.1.6.48 containerd-master1
10.1.6.24 containerd-master2
10.1.6.45 containerd-master3
10.1.6.46 containerd-work1
10.1.6.43 containerd-work2
10.1.6.47 containerd-work3
10.1.6.51 etcd1
10.1.6.52 etcd2
10.1.6.53 etcd3
10.1.6.215  api.k8s.verbos.com
</code></pre><h3 id="è®¾ç½®etcdé›†ç¾¤è¯ä¹¦">è®¾ç½®Etcdé›†ç¾¤è¯ä¹¦</h3>
<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯å·¥ä½œåœ¨WorkèŠ‚ç‚¹çš„Etcdæˆ–è€…å…¶ä»–å•ç‹¬çš„Etcdé›†ç¾¤,è¯·å°†Etcdçš„<code>ca</code>è¯ä¹¦è¿›è¡Œæ‹·è´åˆ°MasterèŠ‚ç‚¹å½“ä¸­.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CONTROL_PLANE</span><span class="o">=</span><span class="s2">&#34;root@10.1.6.48&#34;</span>
</span></span><span class="line"><span class="cl">scp /etc/kubernetes/pki/etcd/ca.crt <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CONTROL_PLANE</span><span class="si">}</span><span class="s2">&#34;</span>:
</span></span><span class="line"><span class="cl">scp /etc/kubernetes/pki/apiserver-etcd-client.crt <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CONTROL_PLANE</span><span class="si">}</span><span class="s2">&#34;</span>:
</span></span><span class="line"><span class="cl">scp /etc/kubernetes/pki/apiserver-etcd-client.key <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CONTROL_PLANE</span><span class="si">}</span><span class="s2">&#34;</span>:
</span></span></code></pre></div><h2 id="è®¾ç½®ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹">è®¾ç½®ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹</h2>
<p>ç”¨ä»¥ä¸‹å†…å®¹åˆ›å»ºä¸€ä¸ªåä¸º <code>kubeadm-config.yaml</code> çš„æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kubernetesVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1.22.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">controlPlaneEndpoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;api.k8s.verbos.com:8443&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiServer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">certSANs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="m">10.1.6.48</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="m">10.1.6.24</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="m">10.1.6.45</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">external</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">https://10.1.6.51:2379</span><span class="w"> </span><span class="c"># é€‚å½“åœ°æ›´æ”¹ ETCD_0_IP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">https://10.1.6.52:2379</span><span class="w"> </span><span class="c"># é€‚å½“åœ°æ›´æ”¹ ETCD_1_IP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">https://10.1.6.53:2379</span><span class="w"> </span><span class="c"># é€‚å½“åœ°æ›´æ”¹ ETCD_2_IP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">caFile</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/pki/etcd/ca.crt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">certFile</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/pki/apiserver-etcd-client.crt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">keyFile</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/pki/apiserver-etcd-client.key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">imageRepository</span><span class="p">:</span><span class="w"> </span><span class="l">registry.aliyuncs.com/google_containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">networking</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">podSubnet</span><span class="p">:</span><span class="w"> </span><span class="m">10.244.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">serviceSubnet</span><span class="p">:</span><span class="w"> </span><span class="m">10.10.0.0</span><span class="l">/16</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>
<p>åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm init --config kubeadm-config.yaml --upload-certs --v<span class="o">=</span><span class="m">5</span>
</span></span></code></pre></div><blockquote>
<p>æ³¨æ„ï¼šå¦‚æœä½ çš„é›†ç¾¤åˆå§‹åŒ–æˆåŠŸä½ å°†ä¼šçœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯.</p>
</blockquote>
<ul>
<li>è¯·ä¿å­˜å¥½<code>kubeadm join</code>çš„å†…å®¹,é»˜è®¤2å°æ—¶åè¿‡æœŸ,è¿‡æœŸåé‡æ–°ç”Ÿæˆå³å¯</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Your Kubernetes control-plane has initialized successfully!
</span></span><span class="line"><span class="cl">To start using your cluster, you need to run the following as a regular user:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">  sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">  sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Alternatively, <span class="k">if</span> you are the root user, you can run:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You should now deploy a pod network to the cluster.
</span></span><span class="line"><span class="cl">Run <span class="s2">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class="line"><span class="cl">  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You can now join any number of the control-plane node running the following <span class="nb">command</span> on each as root:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  kubeadm join api.k8s.verbos.com:8443 --token 9oerz0.fw6s8ft9xa44i077 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --discovery-token-ca-cert-hash sha256:be3c70562ae6bf8cfcfbbfa3bb8124fe63af3b1a0671e806a4ccf1bc243d5c6b <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --control-plane --certificate-key cdf0f280f9e59e18e5f60d98b624008d828ba00ef096a2e38fd9b6b1463be152
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span class="line"><span class="cl">As a safeguard, uploaded-certs will be deleted in two hours<span class="p">;</span> If necessary, you can use
</span></span><span class="line"><span class="cl"><span class="s2">&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubeadm join api.k8s.verbos.com:8443 --token 9oerz0.fw6s8ft9xa44i077 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --discovery-token-ca-cert-hash sha256:be3c70562ae6bf8cfcfbbfa3bb8124fe63af3b1a0671e806a4ccf1bc243d5c6b 
</span></span></code></pre></div><p><strong>æ‹·è´é›†ç¾¤é…ç½®æ–‡ä»¶</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span></code></pre></div><h2 id="è¿è¡Œç½‘ç»œcniæ’ä»¶calico">è¿è¡Œç½‘ç»œCNIæ’ä»¶(Calico)</h2>
<blockquote>
<p>æ³¨æ„ï¼šæ­¤æ—¶ä½ åº”å½“æœ‰ä¸€ä¸ªCNIæ’ä»¶æ¥æä¾›ç½‘ç»œæœåŠ¡,å¦‚æœä¸å®‰è£…CNIæ’ä»¶,é‚£ä¹ˆé›†ç¾¤å°†ä¼šå¤„äº<code>ä¸å¯ç”¨</code>çŠ¶æ€.</p>
</blockquote>
<p>å¦‚æœä½ å¯ä»¥æ­£å¸¸è®¿é—®github</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-kube-master .kube<span class="o">]</span><span class="c1"># curl https://raw.githubusercontent.com/projectcalico/calico/v3.24.1/manifests/calico.yaml -O</span>
</span></span></code></pre></div><p>å›½å†…ç”¨æˆ·</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl https://projectcalico.docs.tigera.io/manifests/calico.yaml -O
</span></span></code></pre></div><h3 id="ä¿®æ”¹calicoyamlé…ç½®">ä¿®æ”¹Calico.yamlé…ç½®</h3>
<p>ä¿®æ”¹CIDRä¸ºKubernetesçš„å­ç½‘åœ°å€,è¯¥åœ°å€ä¸º<code>serviceSubnet</code>çš„åœ°å€,ä¹Ÿå°±æ˜¯Podè¿è¡Œçš„åœ°å€ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CALICO_IPV4POOL_CIDR</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.10.0.0/16&#34;</span><span class="w">
</span></span></span></code></pre></div><p>æ‰§è¡Œ<code>calico.yaml</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f calico.yaml
</span></span></code></pre></div><h2 id="å°†å…¶ä»–æ§åˆ¶å¹³é¢èŠ‚ç‚¹åŠ å…¥é›†ç¾¤">å°†å…¶ä»–æ§åˆ¶å¹³é¢èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h2>
<p>å½“ä½ å·²ç»ç¡®ä¿ä½ çš„<code>containerd-master1</code>å®Œæˆåˆå§‹åŒ–çš„æ—¶å€™,ä½ å¯ä»¥å°†å…¶ä»–çš„masterèŠ‚ç‚¹åŠ å…¥åˆ°æ­¤é›†ç¾¤å½“ä¸­.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  kubeadm join api.k8s.verbos.com:8443 --token 9oerz0.fw6s8ft9xa44i077 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --discovery-token-ca-cert-hash sha256:be3c70562ae6bf8cfcfbbfa3bb8124fe63af3b1a0671e806a4ccf1bc243d5c6b <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --control-plane --certificate-key cdf0f280f9e59e18e5f60d98b624008d828ba00ef096a2e38fd9b6b1463be152
</span></span></code></pre></div><p>åŠ å…¥é›†ç¾¤æˆåŠŸå,è¯·æ‹·è´é›†ç¾¤é…ç½®æ–‡ä»¶å¦åˆ™å°†å½±å“<code>kubelet</code>çš„å·¥ä½œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span></code></pre></div><h2 id="å°†å·¥ä½œèŠ‚ç‚¹åŠ å…¥é›†ç¾¤">å°†å·¥ä½œèŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm join api.k8s.verbos.com:8443 --token mck9bg.renw4t689mmx7oe1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --discovery-token-ca-cert-hash sha256:ed51fca8615acf5f437f63f66a9709e43ef942caf19aea4c595cb905e4a9a00f
</span></span></code></pre></div><h2 id="å¯é€‰é¡¹ä¿®æ”¹kubeletçš„æ•°æ®å­˜å‚¨ç›®å½•">(å¯é€‰é¡¹)ä¿®æ”¹Kubeletçš„æ•°æ®å­˜å‚¨ç›®å½•</h2>
<p>å¦‚æœä½ éœ€è¦ä¿®æ”¹kubeletçš„æ•°æ®å­˜å‚¨ç›®å½•,è¯·æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œæ“ä½œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim /etc/sysconfig/kubelet
</span></span></code></pre></div><p>è®¾ç½®ä½ çš„kubeletçš„æ•°æ®å­˜å‚¨ç›®å½•(å»ºè®®å•ç‹¬çš„ä¸ºkubeletæŒ‚è½½ä¸€å—æ•°æ®ç›˜)</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">KUBELET_EXTRA_ARGS=&#34;--root-dir=/data/k8s/kubelet&#34;
</code></pre><p>é‡å¯kubelet</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl daemon-reloa
</span></span><span class="line"><span class="cl">systemctl restart kubelet
</span></span><span class="line"><span class="cl">umount <span class="k">$(</span>df -HT <span class="p">|</span> grep <span class="s1">&#39;/var/lib/kubelet/pods&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $7}&#39;</span><span class="k">)</span>
</span></span></code></pre></div><p>æŸ¥çœ‹æ–°çš„æ•°æ®ç›®å½•æ˜¯å¦æœ‰kubeletçš„æ•°æ®</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@containerd-master2 kubelet<span class="o">]</span><span class="c1"># ls /data/k8s/kubelet/</span>
</span></span><span class="line"><span class="cl">cpu_manager_state  memory_manager_state  plugins  plugins_registry  pod-resources  pods
</span></span></code></pre></div><h2 id="å¦‚ä½•å‰”é™¤ä¸€ä¸ªmaster">å¦‚ä½•å‰”é™¤ä¸€ä¸ªMaster</h2>
<ul>
<li>å…ˆè¯´ä¸€ä¸ªé—®é¢˜,å½“æˆ‘ä»¬æ­£å¸¸å¦‚æœä¸€ä¸ªMasterè¦è¿›è¡ŒæŸç§å‡çº§çš„æ—¶å€™,å¦‚ä½•æ­£ç¡®çš„å®‰å…¨çš„æ¥è¿›è¡Œåˆ é™¤è¯¥Masterã€‚</li>
</ul>
<ol>
<li>é¦–å…ˆæˆ‘ä»¬è¦å°†è¯¥Masterè®¾ç½®ä¸ºä¸å¯è°ƒåº¦çš„çŠ¶æ€,å¹¶ä¸”é©±é€åœ¨å…¶ä¸Šé¢çš„Pod</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># è®¾ç½®Masterä¸ºä¸å¯è°ƒåº¦çš„çŠ¶æ€</span>
</span></span><span class="line"><span class="cl">kubectl cordon online-beijing-master1
</span></span><span class="line"><span class="cl"><span class="c1"># å°†Masterå‰”é™¤è¯¥é›†ç¾¤</span>
</span></span><span class="line"><span class="cl">kubectl drain online-beijing-master1 --ignore-daemonsets
</span></span><span class="line"><span class="cl"><span class="c1"># ç„¶åå°†å…¶èŠ‚ç‚¹ä»é›†ç¾¤ä¸­åˆ é™¤</span>
</span></span><span class="line"><span class="cl">kubectl delete node online-beijing-master1
</span></span></code></pre></div><blockquote>
<p>è¿™é‡Œæä¸€ä¸ªå°é—®é¢˜: å½“ä½ ä½¿ç”¨<code>kubectl drain</code>çš„æ—¶å€™,å¦‚æœä½ å½“å‰çš„Masterå·²ç»æœ‰æŒ‚è½½çš„<code>emptyDir</code>éœ€è¦ä½¿ç”¨<code>--delete-emptydir-data </code>è¿›è¡Œåˆ é™¤ã€‚
TODO: åˆ é™¤å‰è¯·æ³¨æ„å¤‡ä»½æ‚¨çš„æ•°æ®ã€‚</p>
</blockquote>
]]></content:encoded>
    </item>
    <item>
      <title>Kubernetesä½ç‰ˆæœ¬ä¸­å†…å­˜æ³„æ¼é—®é¢˜</title>
      <link>https://blog.mletter.cn/tech/kubernetes/memory-leakage-analysis/</link>
      <pubDate>Sat, 08 Oct 2022 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/memory-leakage-analysis/</guid>
      <description>ç»å¤§å¤šæ•°çš„kubernetesé›†ç¾¤éƒ½æœ‰è¿™ä¸ªéšæ‚£ã€‚åªä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ³„æ¼å¾—æ¯”è¾ƒæ…¢ï¼Œè¿˜æ²¡æœ‰è¡¨ç°å‡ºæ¥è€Œå·²ã€‚</description>
      <content:encoded><![CDATA[<h2 id="kubernetesä¸­cgroupæ³„æ¼é—®é¢˜">Kubernetesä¸­Cgroupæ³„æ¼é—®é¢˜</h2>
<p>Cgorupæ–‡æ¡£: <a class="link" href="https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt"  target="_blank" rel="noopener"
    >https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt</a></p>
<p>ç»å¤§å¤šæ•°çš„kubernetesé›†ç¾¤éƒ½æœ‰è¿™ä¸ªéšæ‚£ã€‚åªä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ³„æ¼å¾—æ¯”è¾ƒæ…¢ï¼Œè¿˜æ²¡æœ‰è¡¨ç°å‡ºæ¥è€Œå·²ã€‚</p>
<p>ä¸€ä¸ªpodå¯èƒ½æ³„æ¼ä¸¤ä¸ªmemory cgroupæ•°é‡é…é¢ã€‚å³ä½¿podç™¾åˆ†ä¹‹ç™¾å‘ç”Ÿæ³„æ¼ï¼Œ é‚£ä¹Ÿéœ€è¦ä¸€ä¸ªèŠ‚ç‚¹é”€æ¯è¿‡ä¸‰ä¸‡å¤šä¸ªpodä¹‹åï¼Œæ‰ä¼šé€ æˆåç»­podåˆ›å»ºå¤±è´¥ã€‚</p>
<p>ä¸€æ—¦è¡¨ç°å‡ºæ¥ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±å½»åº•ä¸å¯ç”¨äº†ï¼Œå¿…é¡»é‡å¯æ‰èƒ½æ¢å¤ã€‚</p>
<h2 id="æ•…éšœè¡¨ç°">æ•…éšœè¡¨ç°</h2>
<ul>
<li>è¯¥å†…å®¹çš„æ•…éšœä¿¡æ¯å·²ç»æäº¤ç»™Github: <a class="link" href="https://github.com/kubernetes/kubernetes/issues/112940"  target="_blank" rel="noopener"
    >https://github.com/kubernetes/kubernetes/issues/112940</a></li>
</ul>
<p>æˆ‘åœ¨æœåŠ¡å™¨ä¸­æ›´æ–°Podå‡ºç°å¦‚ä¸‹é”™è¯¯ <code>cannot allocate memory</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">unable to ensure pod container exists: failed to create container <span class="k">for</span> <span class="o">[</span>kubepods burstable podd5dafc96-2bcd-40db-90fd-c75758746a7a<span class="o">]</span> : mkdir /sys/fs/cgroup/memory/kubepods/burstable/podd5dafc96-2bcd-40db-90fd-c75758746a7a: cannot allocate memory
</span></span></code></pre></div><p>ä½¿ç”¨<code>dmesg</code>æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—çš„é”™è¯¯å†…å®¹ä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">SLUB: Unable to allocate memory on node -1
</span></span></code></pre></div><h2 id="æœåŠ¡å™¨é…ç½®ä¿¡æ¯">æœåŠ¡å™¨é…ç½®ä¿¡æ¯</h2>
<ul>
<li>æ“ä½œç³»ç»Ÿ: <code>CentOS Linux release 7.9.2009 (Core)</code></li>
<li>ç³»ç»Ÿå†…æ ¸: <code>3.10.0-1160.el7.x86_64</code></li>
<li>Kubernetes: <code>1.17.9</code></li>
<li>dockerVersion: <code>20.10.7</code></li>
</ul>
<h2 id="é—®é¢˜åŸå› 1">é—®é¢˜åŸå› 1</h2>
<p>Kubernetesåœ¨1.9ç‰ˆæœ¬å¼€å¯äº†å¯¹kmemçš„æ”¯æŒ,å› æ­¤ 1.9ä»¥åçš„æ‰€æœ‰ç‰ˆæœ¬éƒ½æœ‰è¯¥é—®é¢˜ï¼Œä½†å¿…é¡»æ­é…3.xå†…æ ¸çš„æœºå™¨æ‰ä¼šå‡ºé—®é¢˜ã€‚ä¸€æ—¦å‡ºç°ä¼šå¯¼è‡´æ–° pod æ— æ³•åˆ›å»ºï¼Œå·²æœ‰ podä¸å—å½±å“ï¼Œä½†pod æ¼‚ç§»åˆ°æœ‰é—®é¢˜çš„èŠ‚ç‚¹å°±ä¼šå¤±è´¥ï¼Œç›´æ¥å½±å“ä¸šåŠ¡ç¨³å®šæ€§ã€‚å› ä¸ºæ˜¯å†…å­˜æ³„éœ²ï¼Œç›´æ¥é‡å¯æœºå™¨å¯ä»¥æš‚æ—¶è§£å†³ï¼Œä½†è¿˜ä¼šå†æ¬¡å‡ºç°ã€‚
cgroupçš„kmem accountç‰¹æ€§åœ¨3.x å†…æ ¸ä¸Šæœ‰å†…å­˜æ³„éœ²é—®é¢˜ï¼Œå¦‚æœå¼€å¯äº†kmem accountç‰¹æ€§ä¼šå¯¼è‡´å¯åˆ†é…å†…å­˜è¶Šæ¥è¶Šå°‘ï¼Œç›´åˆ°æ— æ³•åˆ›å»ºæ–° pod æˆ–èŠ‚ç‚¹å¼‚å¸¸ã€‚</p>
<ol>
<li>kmem account æ˜¯cgroup çš„ä¸€ä¸ªæ‰©å±•ï¼Œå…¨ç§°CONFIG_MEMCG_KMEMï¼Œå±äºæœºå™¨é»˜è®¤é…ç½®ï¼Œæœ¬èº«æ²¡å•¥é—®é¢˜ï¼Œåªæ˜¯è¯¥ç‰¹æ€§åœ¨ 3.10 çš„å†…æ ¸ä¸Šå­˜åœ¨æ¼æ´æœ‰å†…å­˜æ³„éœ²é—®é¢˜ï¼Œ4.xçš„å†…æ ¸ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ã€‚</li>
<li>å› ä¸º kmem account æ˜¯ cgroup çš„æ‰©å±•èƒ½åŠ›ï¼Œå› æ­¤runcã€dockerã€k8s å±‚é¢ä¹Ÿè¿›è¡Œäº†è¯¥åŠŸèƒ½çš„æ”¯æŒï¼Œå³é»˜è®¤éƒ½æ‰“å¼€äº†kmem å±æ€§ã€‚</li>
<li>å› ä¸º3.10 çš„å†…æ ¸å·²ç»æ˜ç¡®æç¤º kmem æ˜¯å®éªŒæ€§è´¨ï¼Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨è¯¥ç‰¹æ€§ï¼Œæ‰€ä»¥è¿™å…¶å®ä¸ç®—å†…æ ¸çš„é—®é¢˜ï¼Œæ˜¯ k8s å…¼å®¹é—®é¢˜ã€‚</li>
</ol>
<h2 id="é—®é¢˜åŸå› 2">é—®é¢˜åŸå› 2</h2>
<p>memcgæ˜¯ Linux å†…æ ¸ä¸­ç”¨äºç®¡ç† cgroup å†…å­˜çš„æ¨¡å—ï¼Œæ•´ä¸ªç”Ÿå‘½å‘¨æœŸåº”è¯¥æ˜¯è·Ÿéš cgroup çš„ï¼Œä½†æ˜¯åœ¨ä½ç‰ˆæœ¬å†…æ ¸ä¸­<code>(å·²çŸ¥3.10)</code>ï¼Œä¸€æ—¦ç»™æŸä¸ª memory cgroup å¼€å¯ kmem accounting ä¸­çš„ memory.kmem.limit_in_bytes å°±å¯èƒ½ä¼šå¯¼è‡´ä¸èƒ½å½»åº•åˆ é™¤ memcg å’Œå¯¹åº”çš„ cssidï¼Œä¹Ÿå°±æ˜¯è¯´åº”ç”¨å³ä½¿å·²ç»åˆ é™¤äº† cgroup (/sys/fs/cgroup/memory ä¸‹å¯¹åº”çš„ cgroup ç›®å½•å·²ç»åˆ é™¤), ä½†åœ¨å†…æ ¸ä¸­æ²¡æœ‰é‡Šæ”¾ cssidï¼Œå¯¼è‡´å†…æ ¸è®¤ä¸ºçš„ cgroup çš„æ•°é‡å®é™…æ•°é‡ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•å¾—çŸ¥å†…æ ¸è®¤ä¸ºçš„ cgroup æ•°é‡æ˜¯å¤šå°‘ã€‚
è¿™ä¸ªé—®é¢˜å¯èƒ½ä¼šå¯¼è‡´åˆ›å»ºå®¹å™¨å¤±è´¥ï¼Œå› ä¸ºåˆ›å»ºå®¹å™¨ä¸ºå…¶éœ€è¦åˆ›å»º cgroup æ¥åšéš”ç¦»ï¼Œè€Œä½ç‰ˆæœ¬å†…æ ¸æœ‰ä¸ªé™åˆ¶ï¼šå…è®¸åˆ›å»ºçš„ cgroup æœ€å¤§æ•°é‡å†™æ­»ä¸º 65535ï¼Œå¦‚æœèŠ‚ç‚¹ä¸Šç»å¸¸åˆ›å»ºå’Œé”€æ¯å¤§é‡å®¹å™¨å¯¼è‡´åˆ›å»ºå¾ˆå¤š cgroupï¼Œåˆ é™¤å®¹å™¨ä½†æ²¡æœ‰å½»åº•åˆ é™¤ cgroup é€ æˆæ³„éœ²(çœŸå®æ•°é‡æˆ‘ä»¬æ— æ³•å¾—çŸ¥)ï¼Œåˆ°è¾¾ 65535 åå†åˆ›å»ºå®¹å™¨å°±ä¼šæŠ¥åˆ›å»º cgroup å¤±è´¥å¹¶æŠ¥é”™ no space left on deviceï¼Œä½¿ç”¨ kubernetes æœ€ç›´è§‚çš„æ„Ÿå—å°±æ˜¯ pod åˆ›å»ºä¹‹åæ— æ³•å¯åŠ¨æˆåŠŸã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<p>ç›®å‰å®˜æ–¹ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹:</p>
<ol>
<li>kernel upgrade to 4.0+: <a class="link" href="https://github.com/kubernetes/kubernetes/issues/61937#issuecomment-377585452"  target="_blank" rel="noopener"
    >Update kernel</a></li>
<li>rebuild the kubelet with nokmem args. See <a class="link" href="https://github.com/kubernetes/kubernetes/issues/96701#issuecomment-911061574"  target="_blank" rel="noopener"
    >nokmem</a></li>
<li>Set cgroup.memory=nokmem in grub: see <a class="link" href="https://github.com/kubernetes/kubernetes/issues/61937#issuecomment-567042968"  target="_blank" rel="noopener"
    >grub</a></li>
</ol>
<h3 id="è§£å†³æ–¹æ¡ˆä¸€">è§£å†³æ–¹æ¡ˆä¸€</h3>
<ul>
<li>æ„Ÿè°¢æä¾›çš„è§£å†³æ–¹æ¡ˆ: <a class="link" href="https://cloud.tencent.com/developer/article/1739289"  target="_blank" rel="noopener"
    >https://cloud.tencent.com/developer/article/1739289</a></li>
<li><a class="link" href="https://github.com/torvalds/linux/commit/d6e0b7fa11862433773d986b5f995ffdf47ce672"  target="_blank" rel="noopener"
    >https://github.com/torvalds/linux/commit/d6e0b7fa11862433773d986b5f995ffdf47ce672</a></li>
<li><a class="link" href="https://support.mesosphere.com/s/article/Critical-Issue-KMEM-MSPH-2018-0006"  target="_blank" rel="noopener"
    >https://support.mesosphere.com/s/article/Critical-Issue-KMEM-MSPH-2018-0006</a></li>
</ul>
<p>è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯ï¼š</p>
<ul>
<li>1ã€è¦å‡çº§æ‰€æœ‰èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹é‡å¯çš„è¯å·²æœ‰ pod è‚¯å®šè¦æ¼‚ç§»ï¼Œå¦‚æœèŠ‚ç‚¹è§„æ¨¡å¾ˆå¤§ï¼Œè¿™ä¸ªå‡çº§æ“ä½œä¼šå¾ˆç¹çï¼Œä¸šåŠ¡éƒ¨é—¨ä¹Ÿä¼šæœ‰æ„è§ï¼Œè¦äº‹å…ˆæ²Ÿé€šã€‚</li>
<li>2ã€è¿™ä¸ªé—®é¢˜å½’æ ¹ç»“åº•æ˜¯è½¯ä»¶å…¼å®¹é—®é¢˜ï¼Œ3.x è‡ªå·±éƒ½è¯´äº†ä¸æˆç†Ÿï¼Œä¸å»ºè®®ä½ ä½¿ç”¨è¯¥ç‰¹æ€§ï¼Œk8sã€dockerå´ è¿˜è¦å¼€å¯è¿™ä¸ªå±æ€§ï¼Œé‚£å°±ä¸æ˜¯å†…æ ¸çš„è´£ä»»ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯äº‘ä¸Šæœºå™¨ï¼Œæƒ³æ›¿æ¢4.x å†…æ ¸éœ€è¦è™šæœºå›¢é˜Ÿåšè¶³å¤Ÿçš„æµ‹è¯•å’Œè¯„å®¡ï¼Œå› æ­¤è¿™æ˜¯ä¸ªé•¿æœŸæ–¹æ¡ˆï¼Œä¸èƒ½ç«‹åˆ»è§£å†³é—®é¢˜ã€‚</li>
<li>3ã€å·²æœ‰ä¸šåŠ¡åœ¨ 3.x è¿è¡Œæ­£å¸¸ï¼Œä¸ä»£è¡¨å¯ä»¥åœ¨ 4.x ä¹Ÿè¿è¡Œæ­£å¸¸ï¼Œå³å…¨é‡å‡çº§å†…æ ¸ä¹‹å‰éœ€è¦åšè¶³å¤Ÿçš„æµ‹è¯•ï¼Œå°¤å…¶æ˜¯æœ‰äº›ä¸šåŠ¡éœ€æ±‚å¯¹osåšè¿‡å®šåˆ¶ã€‚</li>
</ul>
<h3 id="è§£å†³æ–¹æ¡ˆ2">è§£å†³æ–¹æ¡ˆ2</h3>
<p>ä¿®æ”¹è™šæœºå¯åŠ¨çš„å¼•å¯¼é¡¹ grub ä¸­çš„<code>cgroup.memory=nokmem</code>ï¼Œè®©æœºå™¨å¯åŠ¨æ—¶ç›´æ¥ç¦ç”¨ cgroupçš„ kmem å±æ€§</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim /etc/default/grub
</span></span><span class="line"><span class="cl"><span class="nv">GRUB_TIMEOUT</span><span class="o">=</span><span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="nv">GRUB_DISTRIBUTOR</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>sed <span class="s1">&#39;s, release .*$,,g&#39;</span> /etc/system-release<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">GRUB_DEFAULT</span><span class="o">=</span>saved
</span></span><span class="line"><span class="cl"><span class="nv">GRUB_DISABLE_SUBMENU</span><span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">GRUB_TERMINAL_OUTPUT</span><span class="o">=</span><span class="s2">&#34;console&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&#34;crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet cgroup.memory=nokmem&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">GRUB_DISABLE_RECOVERY</span><span class="o">=</span><span class="s2">&#34;true&#34;</span>
</span></span></code></pre></div><p>æ›´æ”¹å®Œæˆåä½ éœ€è¦ç”Ÿæˆä¸€ä¸‹æ–°çš„cgroupé…ç½®.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/usr/sbin/grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span class="line"><span class="cl">reboot <span class="c1"># é‡å¯æœåŠ¡å™¨</span>
</span></span></code></pre></div><h3 id="è§£å†³æ–¹æ¡ˆ3">è§£å†³æ–¹æ¡ˆ3</h3>
<p>å¦‚æœä½ æƒ³åœ¨Kubernetesä¸­ç¦ç”¨è¯¥å±æ€§ã€‚issue ä¸­ä¸€èˆ¬å»ºè®®ä¿®æ”¹ kubeletä»£ç å¹¶é‡æ–°ç¼–è¯‘ã€‚</p>
<p>å¯¹äºv1.13åŠå…¶ä¹‹å‰ç‰ˆæœ¬çš„kubeletï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">vendor</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">opencontainers</span><span class="o">/</span><span class="nx">runc</span><span class="o">/</span><span class="nx">libcontainer</span><span class="o">/</span><span class="nx">cgroups</span><span class="o">/</span><span class="nx">fs</span><span class="o">/</span><span class="nx">memory</span><span class="p">.</span><span class="k">go</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">EnableKernelMemoryAccounting</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">setKernelMemory</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">kernelMemoryLimit</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>é‡æ–°ç¼–è¯‘å¹¶æ›¿æ¢ <code>kubelet</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make <span class="nv">WHAT</span><span class="o">=</span>cmd/kubelet <span class="nv">GOFLAGS</span><span class="o">=</span>-v <span class="nv">GOGCFLAGS</span><span class="o">=</span><span class="s2">&#34;-N -l&#34;</span>
</span></span></code></pre></div><p>å¯¹äºv1.14åŠå…¶ä¹‹åç‰ˆæœ¬çš„kubelet,é€šè¿‡æ·»åŠ BUILDTAGSæ¥ç¦æ­¢ kmem accounting.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make <span class="nv">BUILDTAGS</span><span class="o">=</span><span class="s2">&#34;nokmem&#34;</span> <span class="nv">WHAT</span><span class="o">=</span>cmd/kubelet <span class="nv">GOFLAGS</span><span class="o">=</span>-v <span class="nv">GOGCFLAGS</span><span class="o">=</span><span class="s2">&#34;-N -l&#34;</span>
</span></span></code></pre></div><p>é‡åˆ°1.16 ç‰ˆæœ¬çš„BUILDTAGS=â€nokmemâ€œç¼–è¯‘å‡ºæ¥çš„ let è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œè¿˜æ˜¯é€šè¿‡ä¿®æ”¹ä»£ç çš„æ–¹å¼ä½¿å…¶ç”Ÿæ•ˆ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">vendor</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">opencontainers</span><span class="o">/</span><span class="nx">runc</span><span class="o">/</span><span class="nx">libcontainer</span><span class="o">/</span><span class="nx">cgroups</span><span class="o">/</span><span class="nx">fs</span><span class="o">/</span><span class="nx">kmem</span><span class="p">.</span><span class="k">go</span>
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">fs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;errors&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">EnableKernelMemoryAccounting</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">setKernelMemory</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">kernelMemoryLimit</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;kernel memory accounting disabled in this runc build&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç¼–è¯‘å‰ï¼Œå¯ä»¥ç¼–è¾‘ä¸‹æ–‡ä»¶ hack/lib/version.shï¼Œå°† <code>KUBE_GIT_TREE_STATE=&quot;dirty&quot;</code> æ”¹ä¸º <code>KUBE_GIT_TREE_STATE=&quot;clean&quot;</code>ï¼Œç¡®ä¿ç‰ˆæœ¬å·å¹²å‡€ã€‚</p>
<h3 id="å½±å“èŒƒå›´">å½±å“èŒƒå›´</h3>
<p>k8såœ¨1.9ç‰ˆæœ¬å¼€å¯äº†å¯¹kmemçš„æ”¯æŒï¼Œå› æ­¤1.9ä»¥åçš„æ‰€æœ‰ç‰ˆæœ¬éƒ½æœ‰è¯¥é—®é¢˜,ä½†å¿…é¡»æ­é… 3.xå†…æ ¸çš„æœºå™¨æ‰ä¼šå‡ºé—®é¢˜ã€‚ä¸€æ—¦å‡ºç°ä¼šå¯¼è‡´æ–°podæ— æ³•åˆ›å»º,å·²æœ‰ podä¸å—å½±å“ï¼Œä½†pod æ¼‚ç§»åˆ°æœ‰é—®é¢˜çš„èŠ‚ç‚¹å°±ä¼šå¤±è´¥ï¼Œç›´æ¥å½±å“ä¸šåŠ¡ç¨³å®šæ€§ã€‚å› ä¸ºæ˜¯å†…å­˜æ³„éœ²ï¼Œç›´æ¥é‡å¯æœºå™¨å¯ä»¥æš‚æ—¶è§£å†³ï¼Œä½†è¿˜ä¼šå†æ¬¡å‡ºç°ã€‚</p>
<h2 id="å¤§æ¦‚å¾—åŸç†ç†è§£">å¤§æ¦‚å¾—åŸç†ç†è§£</h2>
<h3 id="kemeæ˜¯ä»€ä¹ˆ">kemeæ˜¯ä»€ä¹ˆ?</h3>
<p>kmemæ˜¯Cgroupçš„ä¸€ä¸ªæ‰©å±•ï¼Œå…¨ç§°CONFIG_MEMCG_KMEMï¼Œå±äºæœºå™¨é»˜è®¤é…ç½®ã€‚</p>
<p>å†…æ ¸å†…å­˜ä¸ç”¨æˆ·å†…å­˜ï¼š</p>
<p>å†…æ ¸å†…å­˜ï¼šä¸“ç”¨äºLinuxå†…æ ¸ç³»ç»ŸæœåŠ¡ä½¿ç”¨ï¼Œæ˜¯ä¸å¯swapçš„ï¼Œå› è€Œè¿™éƒ¨åˆ†å†…å­˜éå¸¸å®è´µçš„ã€‚ä½†ç°å®ä¸­å­˜åœ¨å¾ˆå¤šé’ˆå¯¹å†…æ ¸å†…å­˜èµ„æºçš„æ”»å‡»ï¼Œå¦‚ä¸æ–­åœ°forkæ–°è¿›ç¨‹ä»è€Œè€—å°½ç³»ç»Ÿèµ„æºï¼Œå³æ‰€è°“çš„â€œfork bombâ€ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢è¿™ç§æ”»å‡»ï¼Œç¤¾åŒºä¸­æè®®é€šè¿‡linuxå†…æ ¸é™åˆ¶ cgroupä¸­çš„kmem å®¹é‡ï¼Œä»è€Œé™åˆ¶æ¶æ„è¿›ç¨‹çš„è¡Œä¸ºï¼Œå³kernel memory accountingæœºåˆ¶ã€‚</p>
<p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹KMEMæ˜¯å¦æ‰“å¼€ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat /boot/config-<span class="sb">`</span>uname -r<span class="sb">`</span><span class="p">|</span>grep CONFIG_MEMCG
</span></span><span class="line"><span class="cl"><span class="nv">CONFIG_MEMCG</span><span class="o">=</span>y
</span></span><span class="line"><span class="cl"><span class="nv">CONFIG_MEMCG_SWAP</span><span class="o">=</span>y
</span></span><span class="line"><span class="cl"><span class="nv">CONFIG_MEMCG_SWAP_ENABLED</span><span class="o">=</span>y
</span></span><span class="line"><span class="cl"><span class="nv">CONFIG_MEMCG_KMEM</span><span class="o">=</span>y
</span></span></code></pre></div><h3 id="cgroupä¸kmemæœºåˆ¶">cgroupä¸kmemæœºåˆ¶</h3>
<p>ä½¿ç”¨ cgroup é™åˆ¶å†…å­˜æ—¶ï¼Œæˆ‘ä»¬ä¸ä½†éœ€è¦é™åˆ¶å¯¹ç”¨æˆ·å†…å­˜çš„ä½¿ç”¨ï¼Œä¹Ÿéœ€è¦é™åˆ¶å¯¹å†…æ ¸å†…å­˜çš„ä½¿ç”¨ã€‚kernel memory accounting æœºåˆ¶ä¸º cgroup çš„å†…å­˜é™åˆ¶å¢åŠ äº† stack pagesï¼ˆä¾‹å¦‚æ–°è¿›ç¨‹åˆ›å»ºï¼‰ã€slab pages(SLAB/SLUBåˆ†é…å™¨ä½¿ç”¨çš„å†…å­˜)ã€sockets memory pressureã€tcp memory pressureç­‰ï¼Œä»¥ä¿è¯ kernel memory ä¸è¢«æ»¥ç”¨ã€‚</p>
<p>å½“ä½ å¼€å¯äº†kmem æœºåˆ¶ï¼Œå…·ä½“ä½“ç°åœ¨ memory.kmem.limit_in_bytes è¿™ä¸ªæ–‡ä»¶ä¸Šï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/sys/fs/cgroup/memory/kubepods/pod632f736f-5ef2-11ea-ad9e-fa163e35f5d4/memory.kmem.limit_in_bytes
</span></span></code></pre></div><p>å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬å°† memory.kmem.limit_in_bytes è®¾ç½®æˆå¤§äº memory.limit_in_bytesï¼Œä»è€Œåªé™åˆ¶åº”ç”¨çš„æ€»å†…å­˜ä½¿ç”¨ã€‚</p>
<h3 id="dockerä¸k8sä½¿ç”¨kmem">dockerä¸k8sä½¿ç”¨kmem</h3>
<p>ä»¥ä¸Šæè¿°éƒ½æ˜¯cgroupå±‚é¢å³æœºå™¨å±‚é¢ï¼Œä½†æ˜¯ runc å’Œ docker å‘ç°æœ‰è¿™ä¸ªå±æ€§ä¹‹åï¼Œåœ¨åæ¥çš„ç‰ˆæœ¬ä¸­ä¹Ÿæ”¯æŒäº† kmem ï¼Œk8s å‘ç° dockeræ”¯æŒï¼Œä¹Ÿåœ¨ 1.9 ç‰ˆæœ¬å¼€å§‹æ”¯æŒã€‚</p>
<p>1.9ç‰ˆæœ¬åŠä¹‹åï¼Œkubelet æ‰å¼€å¯ kmem å±æ€§</p>
<p>kubelet çš„è¿™éƒ¨åˆ†ä»£ç ä½äºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">https://github.com/kubernetes/kubernetes/blob/release-1.12/vendor/github.com/opencontainers/runc/libcontainer/cgroups/fs/memory.go#L70-L106
</span></span></code></pre></div><p>å¯¹äºk8sã€docker è€Œè¨€ï¼Œkmem å±æ€§å±äºæ­£å¸¸è¿­ä»£å’Œä¼˜åŒ–ï¼Œè‡³äº3.xçš„å†…æ ¸ä¸Šå­˜åœ¨ bug ä¸èƒ½å…¼å®¹ï¼Œä¸æ˜¯k8s å…³å¿ƒçš„é—®é¢˜ã€‚ä½† issue ä¸­ä¸æ–­æœ‰äººåé¦ˆï¼Œå› æ­¤åœ¨ k8s 1.14 ç‰ˆæœ¬çš„ kubelet ä¸­ï¼Œå¢åŠ äº†ä¸€ä¸ªç¼–è¯‘é€‰é¡¹ make BUILDTAGS=â€œnokmemâ€ï¼Œå°±å¯ä»¥ç¼–è¯‘ kubelet æ—¶å°±ç¦ç”¨ kmemï¼Œé¿å…æ‰è¿™ä¸ªé—®é¢˜ã€‚è€Œ1.8 åˆ°1.14 ä¸­é—´çš„ç‰ˆæœ¬ï¼Œåªèƒ½é€‰æ‹©æ›´æ”¹ kubelet çš„ä»£ç ã€‚</p>
]]></content:encoded>
    </item>
    <item>
      <title>æœ‰å…³äºKubernetesä¸­å½±å“Podè°ƒåº¦çš„é—®é¢˜</title>
      <link>https://blog.mletter.cn/tech/kubernetes/pod-scheduling-issues/</link>
      <pubDate>Tue, 21 Dec 2021 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/pod-scheduling-issues/</guid>
      <description>æ­¤é—®é¢˜å¼•å‡ºçš„æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æ‰€æœ‰çš„èµ„æºå®Œå…¨å……è¶³,ä½†æ˜¯ä¼šå‡ºç°æ›´æ–°Podã€åˆ é™¤Podã€æ–°å»ºPodæ— æ³•è°ƒåº¦çš„æƒ…å†µã€‚</description>
      <content:encoded><![CDATA[<blockquote>
<p>æ­¤é—®é¢˜å¼•å‡ºçš„æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æ‰€æœ‰çš„èµ„æºå®Œå…¨å……è¶³,ä½†æ˜¯ä¼šå‡ºç°æ›´æ–°Podã€åˆ é™¤Podã€æ–°å»ºPodæ— æ³•è°ƒåº¦çš„æƒ…å†µã€‚</p>
</blockquote>
<h2 id="ç”Ÿäº§ç¯å¢ƒè§£å†³é—®é¢˜åŠæ³•">ç”Ÿäº§ç¯å¢ƒè§£å†³é—®é¢˜åŠæ³•</h2>
<p>æ‰¾åˆ°é—®é¢˜è·ŸåŸæ‰€åœ¨,é»˜è®¤çš„<code>maxPods: 110</code>,K8Sé»˜è®¤ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„podè°ƒåº¦æ•°æ˜¯110ï¼Œå½“å‰æœ‰é™åˆ¶podæ•°çš„éœ€æ±‚ã€‚
<code>vim /var/lib/kubelet/config.yaml</code></p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">maxPods: 110 # ä¿®æ”¹ä¸ºmaxPods: 330
</code></pre><h2 id="å½±å“podè°ƒåº¦çš„æƒ…å†µ">å½±å“Podè°ƒåº¦çš„æƒ…å†µ</h2>
<h3 id="requestsèµ„æºé™åˆ¶">requestsèµ„æºé™åˆ¶</h3>
<ul>
<li><code>requests</code>ï¼šæ˜¯ä¸€ç§ç¡¬é™åˆ¶,Kubernetesåœ¨è¿›è¡ŒPodè¯·æ±‚è°ƒåº¦çš„æ—¶å€™,èŠ‚ç‚¹çš„å¯ç”¨èµ„æºå¿…é¡»æ»¡è¶³<code>500m</code>çš„CPUæ‰èƒ½è¿›è¡Œè°ƒåº¦,ä¸”ä½¿ç”¨æœ€å¤§é™åˆ¶ä¸º<code>1</code>ä¸ªCPU,å¦‚æœè¯¥Podè¶…è¿‡è¯·æ±‚çš„æœ€å¤§é™åˆ¶,åˆ™Kuberneteså°†ä¼šæŠŠè¯¥Podè¿›è¡ŒKillé‡å¯ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">500m</span><span class="w">
</span></span></span></code></pre></div><p>å½“ä½ è®¾ç½®requestä¸º<code>500m</code>ä»¥åŠlimitä¸º<code>1000m</code>çš„æ—¶å€™,å½“ä½ ä½¿ç”¨ <code>kubectl describe node</code>æŸ¥çœ‹èŠ‚ç‚¹èµ„æºçš„æ—¶å€™å¯èƒ½ä¼šä¸ä½ è®¾ç½®çš„è¯·æ±‚é‡ä¸ç¬¦åˆ,è¿™æ˜¯ä»¥ä½ Pod
çš„å®é™…ä½¿ç”¨é‡ä¸ºæ ‡å‡†çš„ã€‚</p>
<h3 id="èŠ‚ç‚¹æ ‡ç­¾çš„label">èŠ‚ç‚¹æ ‡ç­¾çš„Label</h3>
<ul>
<li>æ ‡ç­¾é€‰æ‹©å™¨ï¼š <code>kubectl label node kubernetes-node1 env_role=dev</code> é€šè¿‡æ­¤å‘½ä»¤å¯¹ç›¸åº”çš„èŠ‚ç‚¹åŠ å…¥æ ‡ç­¾ <code>kubectl label node èŠ‚ç‚¹åç§° æ ‡ç­¾åç§°</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">env_role</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span></code></pre></div><p>å½“ç„¶,ä½ ä¹Ÿå¯ä»¥é€šè¿‡<code>kubectl get node --show-labels</code>å‘½ä»¤æŸ¥çœ‹å½“å‰èŠ‚ç‚¹çš„æ ‡ç­¾</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME      STATUS                     ROLES    AGE    VERSION   LABELS
</span></span><span class="line"><span class="cl">master1   Ready,SchedulingDisabled   master   141d   v1.17.9   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>master1,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/master<span class="o">=</span>
</span></span><span class="line"><span class="cl">master2   Ready,SchedulingDisabled   master   139d   v1.17.9   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>master2,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/master<span class="o">=</span>
</span></span><span class="line"><span class="cl">master3   Ready,SchedulingDisabled   master   139d   v1.17.9   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>master3,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/master<span class="o">=</span>
</span></span><span class="line"><span class="cl">node1     Ready                      worker   141d   v1.17.9   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>node1,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/worker<span class="o">=</span>
</span></span><span class="line"><span class="cl">node2     Ready                      worker   141d   v1.17.9   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>node2,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/worker<span class="o">=</span>
</span></span><span class="line"><span class="cl">node3     Ready                      worker   141d   v1.17.9   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>node3,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/worker<span class="o">=</span>
</span></span></code></pre></div><h3 id="èŠ‚ç‚¹äº²å’Œæ€§">èŠ‚ç‚¹äº²å’Œæ€§</h3>
<ul>
<li>èŠ‚ç‚¹äº²å’Œæ€§ï¼š<code>nodeAffinity</code>å’Œä¹‹å‰<code>nodeSelector</code>åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„,æœ‰çš„è¯æ»¡è¶³è¿›è¡Œè°ƒåº¦,å¦‚æœæ²¡æœ‰çš„è¯åˆ™ä¾æ—§ä¹Ÿå¯ä»¥è°ƒåº¦ã€‚</li>
<li>ç¡¬äº²å’Œæ€§ï¼š<code>requiredDuringSchedulingIgnoreDuringExecution</code>,å½“å‰çº¦æŸçš„æ¡ä»¶è¡¨ç¤ºä¸ºåœ¨<code>env_role</code>è¿™ä¸ªé”®ä¸­æœ‰<code>dev</code>/<code>test</code> æœ‰çš„è¯å³æ»¡è¶³çš„è°ƒåº¦,å¦‚æœä¸æ»¡è¶³åˆ™ä¸è°ƒåº¦ã€‚</li>
<li>è½¯äº²å’Œæ€§: <code>preferredDuringSchedulingIgnoredDuringExecution</code>,è¿›è¡Œå°è¯•æ˜¯å¦æ»¡è¶³æµ‹è¯•,å¦‚æœæ»¡è¶³åˆ™æ»¡è¶³è°ƒåº¦,å¦‚æœä¸æ»¡è¶³åˆ™ä¾æ—§ä¼šè¿›è¡Œè°ƒåº¦ã€‚</li>
<li>æ”¯æŒçš„æ“ä½œç¬¦ï¼š<code>In</code>/<code>Not In</code>/<code>Gt</code>/<code>Lt</code>/<code>DoesNotExists</code>åˆ†åˆ«ä¸º å­˜åœ¨ã€ä¸å­˜åœ¨ã€å¤§äºã€å°äºã€ä¸å­˜åœ¨ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">requiredDuringSchedulingIgnoreDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">metchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">env_role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">  </span><span class="c"># è¡¨ç¤ºæƒé‡ æ¯”ä¾‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">preference</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w"> </span><span class="c"># æ“ä½œç¬¦ In </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">otherprod</span><span class="w">
</span></span></span></code></pre></div><h3 id="æ±¡ç‚¹å’Œæ±¡ç‚¹å®¹å¿">æ±¡ç‚¹å’Œæ±¡ç‚¹å®¹å¿</h3>
<ul>
<li>æ±¡ç‚¹ï¼š<code>nodeSelector</code>å’Œ<code>nodeAffinity</code>Podè°ƒåº¦åœ¨æŸäº›èŠ‚ç‚¹ä¸Š,æ˜¯å±äºPodçš„å±æ€§,åœ¨è°ƒåº¦çš„æ—¶å€™è¿›è¡Œå®ç°,è€Œæ±¡ç‚¹æ˜¯å¯¹èŠ‚ç‚¹åšä¸åˆ†é…è°ƒåº¦,æ˜¯èŠ‚ç‚¹å±æ€§ã€‚</li>
<li>æ±¡ç‚¹å®¹å¿ï¼šå½“ä¸€ä¸ªæ±¡ç‚¹ä¸å…è®¸è¢«è°ƒåº¦çš„æ—¶å€™,åŒæ—¶åˆæƒ³è®©ä»–å¯èƒ½ä¼šå‚ä¸è°ƒåº¦,ç±»ä¼¼äºè½¯äº²å’Œæ€§ã€‚</li>
<li>åœºæ™¯ï¼šä½œä¸ºä¸“ç”¨èŠ‚ç‚¹ã€é…ç½®ç‰¹å®šç¡¬ä»¶èŠ‚ç‚¹ã€åŸºäºTainté©±é€</li>
<li>NoScheduleï¼šä¸€å®šä¸è¢«è°ƒåº¦</li>
<li>PreferNoSchdule: å°½é‡ä¸è¢«è°ƒåº¦</li>
<li>NoExecute: ä¸è°ƒåº¦,å¹¶ä¸”ä¼šé©±é€åœ¨è¯¥èŠ‚ç‚¹ä¸ŠPod</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># æ±¡ç‚¹å®¹å¿</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;env_role&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Equal&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yes&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;NoSchedule&#34;</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>ä½¿ç”¨<code>kubectl describe node kubernetes-master1 | grep Taints</code>è¿›è¡ŒæŸ¥çœ‹æ˜¯å¦ä¸ºæ±¡ç‚¹ã€‚
ä½¿ç”¨<code>kubectl taint node èŠ‚ç‚¹åç§° key=value:æ±¡ç‚¹å€¼</code></p>
</blockquote>
]]></content:encoded>
    </item>
    <item>
      <title>kubernetes-ç¦»çº¿éƒ¨ç½²Skywallking</title>
      <link>https://blog.mletter.cn/tech/kubernetes/skywallking/</link>
      <pubDate>Wed, 07 Apr 2021 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/skywallking/</guid>
      <description>ç¦»çº¿çŠ¶æ€çš„ç¯å¢ƒä¸‹å¦‚ä½•å»éƒ¨ç½²skywalking</description>
      <content:encoded><![CDATA[<blockquote>
<p>æ³¨æ„ï¼šè¯·å„ä½è®°ä½æŠŠæ‰€æœ‰ç¦»çº¿åŒ…å…¨æ‹¿åˆ°æœ¬åœ°â€¦</p>
</blockquote>
<h2 id="åœ¨çº¿éƒ¨ç½²chartmuseum">åœ¨çº¿éƒ¨ç½²chartmuseum</h2>
<p>ç›´æ¥ä½¿ç”¨æœ€ç®€å•çš„ docker run æ–¹å¼ï¼Œä½¿ç”¨local æœ¬åœ°å­˜å‚¨æ–¹å¼ï¼Œé€šè¿‡ -v æ˜ å°„åˆ°å®¿ä¸»æœº /opt/charts
æ›´å¤šæ”¯æŒå®‰è£…æ–¹å¼è§å®˜ç½‘</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir /opt/charts
</span></span><span class="line"><span class="cl">docker run -d <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 8080:8080 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -e <span class="nv">DEBUG</span><span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -e <span class="nv">STORAGE</span><span class="o">=</span><span class="nb">local</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -e <span class="nv">STORAGE_LOCAL_ROOTDIR</span><span class="o">=</span>/charts <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -v /opt/charts:/charts <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  chartmuseum/chartmuseum:latest
</span></span></code></pre></div><h2 id="ä¸‹è½½skywalkingåŒ…">ä¸‹è½½SkywalkingåŒ…</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/apache/skywalking-kubernetes.git
</span></span><span class="line"><span class="cl"><span class="c1"># æ›´æ¢ä»“åº“</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> skywalking-kubernetes-master/chart/skywalking/
</span></span><span class="line"><span class="cl">vim Chats.yaml
</span></span><span class="line"><span class="cl">dependencies:
</span></span><span class="line"><span class="cl">  - name: elasticsearch
</span></span><span class="line"><span class="cl">    version: ~7.12.1  <span class="c1"># å®˜ç½‘çš„ç‰ˆæœ¬å·ä¸º7.5.1 æœ€æ–°çš„elasticç‰ˆæœ¬ä¸º7.12.1</span>
</span></span><span class="line"><span class="cl">    repository: http://localhost:8080 <span class="c1"># ä¿®æ”¹ä¸ºä½ æœ¬åœ°çš„Repoåœ°å€</span>
</span></span><span class="line"><span class="cl">    condition: elasticsearch.enabled
</span></span></code></pre></div><h3 id="æ·»åŠ elasticsearchä»“åº“">æ·»åŠ elasticsearchä»“åº“</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm repo add elastic https://helm.elastic.co
</span></span><span class="line"><span class="cl">helm pull elastic/elasticsearch  <span class="c1"># æŠŠelasticsearchå†…å®¹æ‹‰ä¸‹æ¥</span>
</span></span></code></pre></div><h2 id="ä¸Šä¼ æœ¬åœ°helm">ä¸Šä¼ æœ¬åœ°Helm</h2>
<blockquote>
<p>ä»¥é˜²ä¸‡ä¸€è¯·å…ˆå®‰è£…helmpushæ’ä»¶</p>
<p><a class="link" href="https://github.com/chartmuseum/helm-push"  target="_blank" rel="noopener"
    >https://github.com/chartmuseum/helm-push</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm repo add chartmuseum http://localhost:8080
</span></span><span class="line"><span class="cl">curl --data-binary <span class="s2">&#34;@elasticsearch-7.12.1.tgz&#34;</span> http://localhost:8080/api/charts
</span></span><span class="line"><span class="cl">helm push /root/skywalking-kubernetes-master/chart/skywalking/ chartmuseum
</span></span><span class="line"><span class="cl">helm repo update <span class="c1"># æ›´æ–°ä»“åº“</span>
</span></span></code></pre></div><p><strong>ä½ å¯ä»¥å°è¯•æœç´¢ä¸€ä¸‹</strong></p>
<blockquote>
<p>ä¿è¯ä»“åº“ä¸­å­˜åœ¨elasticsarchå’Œskywalking</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@k-master1 ~<span class="o">]</span><span class="c1"># helm search repo</span>
</span></span><span class="line"><span class="cl">NAME                            CHART VERSION   APP VERSION     DESCRIPTION                                       
</span></span><span class="line"><span class="cl">chartmuseum/elasticsearch       7.12.1          7.12.1          Official Elastic helm chart <span class="k">for</span> Elasticsearch     
</span></span><span class="line"><span class="cl">chartmuseum/skywalking          4.0.0                           Apache SkyWalking APM System
</span></span></code></pre></div><h2 id="éƒ¨ç½²skywalking">éƒ¨ç½²skywalking</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> skywalking-kubernetes/chart
</span></span><span class="line"><span class="cl">helm dep up skywalking
</span></span><span class="line"><span class="cl"><span class="c1"># change the release name according to your scenario</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">SKYWALKING_RELEASE_NAME</span><span class="o">=</span>skywalking
</span></span><span class="line"><span class="cl"><span class="c1"># change the namespace according to your scenario</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">SKYWALKING_RELEASE_NAMESPACE</span><span class="o">=</span>default
</span></span><span class="line"><span class="cl">helm install <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SKYWALKING_RELEASE_NAME</span><span class="si">}</span><span class="s2">&#34;</span> skywalking -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SKYWALKING_RELEASE_NAMESPACE</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set oap.image.tag<span class="o">=</span>8.1.0-es7 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set oap.storageType<span class="o">=</span>elasticsearch7 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set ui.image.tag<span class="o">=</span>8.1.0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set elasticsearch.imageTag<span class="o">=</span>7.5.1
</span></span><span class="line"><span class="cl">helm uninstall skywalking <span class="c1"># å¸è½½skywalking</span>
</span></span></code></pre></div><h3 id="å‡†å¤‡ç¦»çº¿é•œåƒ">å‡†å¤‡ç¦»çº¿é•œåƒ</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">busybox:1.30
</span></span><span class="line"><span class="cl">docker.elastic.co/elasticsearch/elasticsearch:7.5.1
</span></span><span class="line"><span class="cl">apache/skywalking-oap-server:8.1.0-es7
</span></span><span class="line"><span class="cl">apache/skywalking-ui:8.1.0
</span></span><span class="line"><span class="cl">chartmuseum/chartmuseum:latest
</span></span></code></pre></div><h2 id="helmä¸­çš„elasticsearchå¯èƒ½ä¼šå­˜åœ¨é—®é¢˜">Helmä¸­çš„Elasticsearchå¯èƒ½ä¼šå­˜åœ¨é—®é¢˜</h2>
<blockquote>
<p>ä½ ä»¬ä¹Ÿå¯ä»¥ç”¨æˆ‘çš„è¿™ä¸ªelasticsearché…ç½® æ³¨æ„ä¿®æ”¹PVC</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch-master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch-master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/managed-by</span><span class="p">:</span><span class="w"> </span><span class="l">Helm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">heritage</span><span class="p">:</span><span class="w"> </span><span class="l">Helm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="l">skywalking</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">esMajorVersion</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;7&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-name</span><span class="p">:</span><span class="w"> </span><span class="l">skywalking</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch-master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch-master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch-master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">heritage</span><span class="p">:</span><span class="w"> </span><span class="l">Helm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="l">skywalking</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initContainers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">configure-sysctl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;docker.elastic.co/elasticsearch/elasticsearch:7.5.1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">sysctl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s1">&#39;-w&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">vm.max_map_count=262144</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l">/dev/termination-log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">terminationMessagePolicy</span><span class="p">:</span><span class="w"> </span><span class="l">File</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;docker.elastic.co/elasticsearch/elasticsearch:7.5.1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9200</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">transport</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9300</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">datadir</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/elasticsearch/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">node.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.initial_master_nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">                elasticsearch-master-0,elasticsearch-master-1,elasticsearch-master-2,</span><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">discovery.seed_hosts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch-master-headless</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">network.host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.0.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ES_JAVA_OPTS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xmx1g -Xms1g&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">node.data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">node.ingest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">node.master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">2Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">2Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="s1">&#39;-c&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="p">&gt;</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">                  #!/usr/bin/env bash -e
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">                  # If the node is starting up wait for the cluster to be ready
</span></span></span><span class="line"><span class="cl"><span class="sd">                  (request params: &#39;wait_for_status=green&amp;timeout=1s&#39; )
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">                  # Once it has started only check that the node itself is
</span></span></span><span class="line"><span class="cl"><span class="sd">                  responding
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">                  START_FILE=/tmp/.es_start_file
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">                  http () {
</span></span></span><span class="line"><span class="cl"><span class="sd">                      local path=&#34;${1}&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">                      if [ -n &#34;${ELASTIC_USERNAME}&#34; ] &amp;&amp; [ -n &#34;${ELASTIC_PASSWORD}&#34; ]; then
</span></span></span><span class="line"><span class="cl"><span class="sd">                        BASIC_AUTH=&#34;-u ${ELASTIC_USERNAME}:${ELASTIC_PASSWORD}&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">                      else
</span></span></span><span class="line"><span class="cl"><span class="sd">                        BASIC_AUTH=&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">                      fi
</span></span></span><span class="line"><span class="cl"><span class="sd">                      curl -XGET -s -k --fail ${BASIC_AUTH} http://127.0.0.1:9200${path}
</span></span></span><span class="line"><span class="cl"><span class="sd">                  }
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">                  if [ -f &#34;${START_FILE}&#34; ]; then
</span></span></span><span class="line"><span class="cl"><span class="sd">                      echo &#39;Elasticsearch is already running, lets check the node is healthy and there are master nodes available&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">                      http &#34;/_cluster/health?timeout=0s&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">                  else
</span></span></span><span class="line"><span class="cl"><span class="sd">                      echo &#39;Waiting for elasticsearch cluster to become cluster to be ready (request params: &#34;wait_for_status=green&amp;timeout=1s&#34; )&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">                      if http &#34;/_cluster/health?wait_for_status=green&amp;timeout=1s&#34; ; then
</span></span></span><span class="line"><span class="cl"><span class="sd">                          touch ${START_FILE}
</span></span></span><span class="line"><span class="cl"><span class="sd">                          exit 0
</span></span></span><span class="line"><span class="cl"><span class="sd">                      else
</span></span></span><span class="line"><span class="cl"><span class="sd">                          echo &#39;Cluster is not yet ready (request params: &#34;wait_for_status=green&amp;timeout=1s&#34; )&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">                          exit 1
</span></span></span><span class="line"><span class="cl"><span class="sd">                      fi
</span></span></span><span class="line"><span class="cl"><span class="sd">                  fi</span><span class="w">                  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l">/dev/termination-log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">terminationMessagePolicy</span><span class="p">:</span><span class="w"> </span><span class="l">File</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">capabilities</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">drop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">120</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterFirst</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">podAntiAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span>- <span class="l">elasticsearch-master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/hostname</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">schedulerName</span><span class="p">:</span><span class="w"> </span><span class="l">default-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeClaimTemplates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">datadir</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volume.beta.kubernetes.io/storage-class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;managed-nfs-storage-class&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;ReadWriteMany&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">10Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch-master-headless</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podManagementPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Parallel</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>kubernetes-Serviceè§£è¯»</title>
      <link>https://blog.mletter.cn/tech/kubernetes/kube-service-read/</link>
      <pubDate>Mon, 13 Apr 2020 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/kube-service-read/</guid>
      <description>Service æ˜¯ä¸€ç§æŠ½è±¡çš„å¯¹è±¡ï¼Œå®ƒå®šä¹‰äº†ä¸€ç»„ Pod çš„é€»è¾‘é›†åˆå’Œä¸€ä¸ªç”¨äºè®¿é—®å®ƒä»¬çš„ç­–ç•¥ï¼Œå…¶å®è¿™ä¸ªæ¦‚å¿µå’Œå¾®æœåŠ¡éå¸¸ç±»ä¼¼ã€‚ä¸€ä¸ª Serivce ä¸‹é¢åŒ…å«çš„ Pod é›†åˆæ˜¯ç”± Label Selector æ¥å†³å®šçš„ã€‚</description>
      <content:encoded><![CDATA[<h1 id="serviceçš„ç®€å•ç†è§£">Serviceçš„ç®€å•ç†è§£</h1>
<p>Service æ˜¯ä¸€ç§æŠ½è±¡çš„å¯¹è±¡ï¼Œå®ƒå®šä¹‰äº†ä¸€ç»„ Pod çš„é€»è¾‘é›†åˆå’Œä¸€ä¸ªç”¨äºè®¿é—®å®ƒä»¬çš„ç­–ç•¥ï¼Œå…¶å®è¿™ä¸ªæ¦‚å¿µå’Œå¾®æœåŠ¡éå¸¸ç±»ä¼¼ã€‚ä¸€ä¸ª Serivce ä¸‹é¢åŒ…å«çš„ Pod é›†åˆæ˜¯ç”± Label Selector æ¥å†³å®šçš„ã€‚</p>
<p>å‡å¦‚æˆ‘ä»¬åç«¯è¿è¡Œäº†3ä¸ªå‰¯æœ¬ï¼Œè¿™äº›å‰¯æœ¬éƒ½æ˜¯å¯ä»¥æ›¿ä»£çš„ï¼Œå› ä¸ºå‰ç«¯å¹¶ä¸å…³å¿ƒå®ƒä»¬ä½¿ç”¨çš„æ˜¯å“ªä¸€ä¸ªåç«¯æœåŠ¡ã€‚å°½ç®¡ç”±äºå„ç§åŸå› åç«¯çš„ Pod é›†åˆä¼šå‘é€å˜åŒ–ï¼Œä½†æ˜¯å‰ç«¯å´ä¸éœ€è¦çŸ¥é“è¿™äº›å˜åŒ–ï¼Œä¹Ÿä¸éœ€è¦è‡ªå·±ç”¨ä¸€ä¸ªåˆ—è¡¨æ¥è®°å½•è¿™äº›åç«¯çš„æœåŠ¡ï¼ŒService çš„è¿™ç§æŠ½è±¡å°±å¯ä»¥å¸®æˆ‘ä»¬è¾¾åˆ°è¿™ç§è§£è€¦çš„ç›®çš„ã€‚</p>
<h2 id="ä¸‰ç§ip">ä¸‰ç§IP</h2>
<p>åœ¨ç»§ç»­å¾€ä¸‹å­¦ä¹  Service ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¼„æ˜ç™½ Kubernetes ç³»ç»Ÿä¸­çš„ä¸‰ç§IPï¼Œå› ä¸ºç»å¸¸æœ‰åŒå­¦æ··ä¹±ã€‚</p>
<ul>
<li>NodeIPï¼šNode èŠ‚ç‚¹çš„ IP åœ°å€</li>
<li>PodIP: Pod çš„ IP åœ°å€</li>
<li>ClusterIP: Service çš„ IP åœ°å€</li>
</ul>
<p>é¦–å…ˆï¼ŒNodeIPæ˜¯Kubernetesé›†ç¾¤ä¸­èŠ‚ç‚¹çš„ç‰©ç†ç½‘å¡IPåœ°å€(ä¸€èˆ¬ä¸ºå†…ç½‘)ï¼Œæ‰€æœ‰å±äºè¿™ä¸ªç½‘ç»œçš„æœåŠ¡å™¨ä¹‹é—´éƒ½å¯ä»¥ç›´æ¥é€šä¿¡ï¼Œæ‰€ä»¥Kubernetesé›†ç¾¤å¤–è¦æƒ³è®¿é—®Kubernetesé›†ç¾¤å†…éƒ¨çš„æŸä¸ªèŠ‚ç‚¹æˆ–è€…æœåŠ¡ï¼Œè‚¯å®šå¾—é€šè¿‡Node Pè¿›è¡Œé€šä¿¡ï¼ˆè¿™ä¸ªæ—¶å€™ä¸€èˆ¬æ˜¯é€šè¿‡å¤–ç½‘ IP äº†ï¼‰</p>
<p>ç„¶åPodIPæ˜¯æ¯ä¸ªPodçš„IPåœ°å€ï¼Œå®ƒæ˜¯ç½‘ç»œæ’ä»¶è¿›è¡Œåˆ†é…çš„ï¼Œå‰é¢æˆ‘ä»¬å·²ç»è®²è§£è¿‡</p>
<p>æœ€åClusterIPæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„IPï¼Œä»…ä»…ä½œç”¨äºKubernetes Service è¿™ä¸ªå¯¹è±¡ï¼Œç”±Kubernetesè‡ªå·±æ¥è¿›è¡Œç®¡ç†å’Œåˆ†é…åœ°å€ã€‚</p>
<h2 id="å®šä¹‰servcie">å®šä¹‰Servcie</h2>
<p>å®šä¹‰ Service çš„æ–¹å¼å’Œæˆ‘ä»¬å‰é¢å®šä¹‰çš„å„ç§èµ„æºå¯¹è±¡çš„æ–¹å¼ç±»å‹ï¼Œä¾‹å¦‚ï¼Œå‡å®šæˆ‘ä»¬æœ‰ä¸€ç»„ Pod æœåŠ¡ï¼Œå®ƒä»¬å¯¹å¤–æš´éœ²äº† 8080 ç«¯å£ï¼ŒåŒæ—¶éƒ½è¢«æ‰“ä¸Šäº† app=beijing-nginx è¿™æ ·çš„æ ‡ç­¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åƒä¸‹é¢è¿™æ ·æ¥å®šä¹‰ä¸€ä¸ª Service å¯¹è±¡</p>
<pre tabindex="0"><code>apiVersion: v1
kind: Service
metadata:
  name: public-beijing-nginx-service
spec:
  selector:
    app: beijing-nginx
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80 # å¯ä»¥ç†è§£æˆæ˜¯serviceçš„è®¿é—®ç«¯å£
    name: beijing-nginx-http
</code></pre><p>ç„¶åé€šè¿‡çš„ä½¿ç”¨ <code>kubectl create -f myservice.yaml</code> å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªåä¸º myservice çš„ Service å¯¹è±¡ï¼Œå®ƒä¼šå°†è¯·æ±‚ä»£ç†åˆ°ä½¿ç”¨ TCP ç«¯å£ä¸º 80ï¼Œå…·æœ‰æ ‡ç­¾ <code>app=beijing-nginx-http</code> çš„ Pod ä¸Šï¼Œè¿™ä¸ª Service ä¼šè¢«ç³»ç»Ÿåˆ†é…ä¸€ä¸ªæˆ‘ä»¬ä¸Šé¢è¯´çš„ Cluster IPï¼Œè¯¥ Service è¿˜ä¼šæŒç»­çš„ç›‘å¬ selector ä¸‹é¢çš„ Podï¼Œä¼šæŠŠè¿™äº› Pod ä¿¡æ¯æ›´æ–°åˆ°ä¸€ä¸ªåä¸º myservice çš„Endpoints å¯¹è±¡ä¸Šå»ï¼Œè¿™ä¸ªå¯¹è±¡å°±ç±»ä¼¼äºæˆ‘ä»¬ä¸Šé¢è¯´çš„ Pod é›†åˆäº†ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒService èƒ½å¤Ÿå°†ä¸€ä¸ªæ¥æ”¶ç«¯å£æ˜ å°„åˆ°ä»»æ„çš„ targetPortã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒtargetPort å°†è¢«è®¾ç½®ä¸ºä¸ port å­—æ®µç›¸åŒçš„å€¼ã€‚å¯èƒ½æ›´æœ‰è¶£çš„æ˜¯ï¼ŒtargetPort å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¼•ç”¨äº† backend Pod çš„ä¸€ä¸ªç«¯å£çš„åç§°ã€‚å› å®é™…æŒ‡æ´¾ç»™è¯¥ç«¯å£åç§°çš„ç«¯å£å·ï¼Œåœ¨æ¯ä¸ª backend Pod ä¸­å¯èƒ½å¹¶ä¸ç›¸åŒï¼Œæ‰€ä»¥å¯¹äºéƒ¨ç½²å’Œè®¾è®¡ Serviceï¼Œè¿™ç§æ–¹å¼ä¼šæä¾›æ›´å¤§çš„çµæ´»æ€§ã€‚</p>
<p>å¦å¤– Service èƒ½å¤Ÿæ”¯æŒ TCP å’Œ UDP åè®®ï¼Œé»˜è®¤æ˜¯ TCP åè®®ã€‚</p>
<h2 id="kube-proxy">kube-proxy</h2>
<p>å‰é¢æˆ‘ä»¬è®²åˆ°è¿‡ï¼Œåœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œæ¯ä¸ª Node ä¼šè¿è¡Œä¸€ä¸ª kube-proxy è¿›ç¨‹, è´Ÿè´£ä¸º Service å®ç°ä¸€ç§ VIPï¼ˆè™šæ‹Ÿ IPï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„ clusterIPï¼‰çš„ä»£ç†å½¢å¼ï¼Œç°åœ¨çš„ Kubernetes ä¸­é»˜è®¤æ˜¯ä½¿ç”¨çš„ iptables è¿™ç§æ¨¡å¼æ¥ä»£ç†ã€‚</p>
<h3 id="iptables">iptables</h3>
<p>è¿™ç§æ¨¡å¼ï¼Œkube-proxy ä¼š watch apiserver å¯¹ Service å¯¹è±¡å’Œ Endpoints å¯¹è±¡çš„æ·»åŠ å’Œç§»é™¤ã€‚å¯¹æ¯ä¸ª Serviceï¼Œå®ƒä¼šæ·»åŠ ä¸Š iptables è§„åˆ™ï¼Œä»è€Œæ•è·åˆ°è¾¾è¯¥ Service çš„ clusterIPï¼ˆè™šæ‹Ÿ IPï¼‰å’Œç«¯å£çš„è¯·æ±‚ï¼Œè¿›è€Œå°†è¯·æ±‚é‡å®šå‘åˆ° Service çš„ä¸€ç»„ backend ä¸­çš„æŸä¸€ä¸ª Pod ä¸Šé¢ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <code>Pod readiness æ¢é’ˆ</code> éªŒè¯åç«¯ Pod å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä»¥ä¾¿ iptables æ¨¡å¼ä¸‹çš„ kube-proxy ä»…çœ‹åˆ°æµ‹è¯•æ­£å¸¸çš„åç«¯ï¼Œè¿™æ ·åšæ„å‘³ç€å¯ä»¥é¿å…å°†æµé‡é€šè¿‡ <code>kube-proxy</code> å‘é€åˆ°å·²çŸ¥å¤±è´¥çš„ Pod ä¸­ï¼Œæ‰€ä»¥å¯¹äºçº¿ä¸Šçš„åº”ç”¨æ¥è¯´ä¸€å®šè¦åš readiness æ¢é’ˆã€‚</p>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="img" loading="lazy" src="https://d33wubrfki0l68.cloudfront.net/86c9416a1c3e7cef4b941c250c1ec49eef19bb9a/069f9/images/docs/services-iptables-overview.svg"></p>
<p>ptables æ¨¡å¼çš„ kube-proxy é»˜è®¤çš„ç­–ç•¥æ˜¯ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªåç«¯ Podã€‚</p>
<p>æ¯”å¦‚å½“åˆ›å»º backend Service æ—¶ï¼ŒKubernetes ä¼šç»™å®ƒæŒ‡æ´¾ä¸€ä¸ªè™šæ‹Ÿ IP åœ°å€ï¼Œæ¯”å¦‚ 10.0.0.1ã€‚å‡è®¾ Service çš„ç«¯å£æ˜¯ 1234ï¼Œè¯¥ Service ä¼šè¢«é›†ç¾¤ä¸­æ‰€æœ‰çš„ kube-proxy å®ä¾‹è§‚å¯Ÿåˆ°ã€‚å½“ kube-proxy çœ‹åˆ°ä¸€ä¸ªæ–°çš„ Serviceï¼Œå®ƒä¼šå®‰è£…ä¸€ç³»åˆ—çš„ iptables è§„åˆ™ï¼Œä» VIP é‡å®šå‘åˆ° <code>per-Service</code> è§„åˆ™ã€‚ è¯¥ <code>per-Service</code> è§„åˆ™è¿æ¥åˆ° <code>per-Endpoint</code> è§„åˆ™ï¼Œè¯¥ <code>per-Endpoint</code> è§„åˆ™ä¼šé‡å®šå‘ï¼ˆç›®æ ‡ <code>NAT</code>ï¼‰åˆ°åç«¯çš„ Podã€‚</p>
<h4 id="ä¼˜åŒ–iptablesæ¨¡å¼æ€§èƒ½">ä¼˜åŒ–iptablesæ¨¡å¼æ€§èƒ½</h4>
<p>åœ¨å¤§å‹é›†ç¾¤ï¼ˆæœ‰æ•°ä¸‡ä¸ª Pod å’Œ Serviceï¼‰ä¸­ï¼Œå½“ Serviceï¼ˆæˆ–å…¶ EndpointSlicesï¼‰å‘ç”Ÿå˜åŒ–æ—¶ iptables æ¨¡å¼çš„ kube-proxy åœ¨æ›´æ–°å†…æ ¸ä¸­çš„è§„åˆ™æ—¶å¯èƒ½è¦ç”¨è¾ƒé•¿æ—¶é—´ã€‚ ä½ å¯ä»¥é€šè¿‡ä¿®æ”¹<code>kube-proxy</code>çš„<code>ConfigMap</code>ä¸­çš„é€‰é¡¹æ¥è°ƒæ•´ kube-proxy çš„åŒæ­¥è¡Œä¸ºï¼š</p>
<pre tabindex="0"><code>iptables:
  minSyncPeriod: 1s
  syncPeriod: 30s
</code></pre><ul>
<li>minSyncPeriod: å‚æ•°è®¾ç½®å°è¯•åŒæ­¥ iptables è§„åˆ™ä¸å†…æ ¸ä¹‹é—´çš„æœ€çŸ­æ—¶é•¿ã€‚å¦‚æœæ˜¯ <code>0s</code>ï¼Œé‚£ä¹ˆæ¯æ¬¡æœ‰ä»»ä¸€ Service æˆ– Endpoint å‘ç”Ÿå˜æ›´æ—¶ï¼Œkube-proxy éƒ½ä¼šç«‹å³åŒæ­¥è¿™äº›è§„åˆ™ã€‚ è¿™ç§æ–¹å¼åœ¨è¾ƒå°çš„é›†ç¾¤ä¸­å¯ä»¥å·¥ä½œå¾—å¾ˆå¥½ï¼Œä½†å¦‚æœåœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å¾ˆå¤šä¸œè¥¿å‘ç”Ÿå˜æ›´æ—¶ï¼Œå®ƒä¼šå¯¼è‡´å¤§é‡å†—ä½™å·¥ä½œã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªç”± Deployment æ”¯æŒçš„ Serviceï¼Œå…±æœ‰ 100 ä¸ª Podï¼Œä½ åˆ é™¤äº†è¿™ä¸ª Deploymentï¼Œ ä¸”è®¾ç½®äº† <code>minSyncPeriod: 0s</code>ï¼Œkube-proxy æœ€ç»ˆä¼šä» iptables è§„åˆ™ä¸­é€ä¸ªåˆ é™¤ Service çš„ Endpointï¼Œ æ€»å…±æ›´æ–° 100 æ¬¡ã€‚ä½¿ç”¨è¾ƒå¤§çš„ <code>minSyncPeriod</code> å€¼æ—¶ï¼Œå¤šä¸ª Pod åˆ é™¤äº‹ä»¶å°†è¢«èšåˆåœ¨ä¸€èµ·ï¼Œ å› æ­¤ kube-proxy æœ€ç»ˆå¯èƒ½ä¼šè¿›è¡Œä¾‹å¦‚ 5 æ¬¡æ›´æ–°ï¼Œæ¯æ¬¡ç§»é™¤ 20 ä¸ªç«¯ç‚¹ï¼Œ è¿™æ ·åœ¨ CPU åˆ©ç”¨ç‡æ–¹é¢æ›´æœ‰æ•ˆç‡ï¼Œèƒ½å¤Ÿæ›´å¿«åœ°åŒæ­¥æ‰€æœ‰å˜æ›´ã€‚</li>
</ul>
<blockquote>
<p>é»˜è®¤å€¼ <code>1s</code> å¯¹äºä¸­å°å‹é›†ç¾¤æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æŠ˜è¡·æ–¹æ¡ˆã€‚ åœ¨å¤§å‹é›†ç¾¤ä¸­ï¼Œå¯èƒ½éœ€è¦å°†å…¶è®¾ç½®ä¸ºæ›´å¤§çš„å€¼ã€‚ ï¼ˆç‰¹åˆ«æ˜¯ï¼Œå¦‚æœ kube-proxy çš„ <code>sync_proxy_rules_duration_seconds</code> æŒ‡æ ‡è¡¨æ˜å¹³å‡æ—¶é—´è¿œå¤§äº 1 ç§’ï¼Œ é‚£ä¹ˆæé«˜ <code>minSyncPeriod</code> å¯èƒ½ä¼šä½¿æ›´æ–°æ›´æœ‰æ•ˆç‡ã€‚ï¼‰</p>
</blockquote>
<ul>
<li><code>syncPeriod</code>: å‚æ•°æ§åˆ¶ä¸å•æ¬¡ Service å’Œ Endpoint çš„å˜æ›´æ²¡æœ‰ç›´æ¥å…³ç³»çš„å°‘æ•°åŒæ­¥æ“ä½œã€‚ ç‰¹åˆ«æ˜¯ï¼Œå®ƒæ§åˆ¶ kube-proxy åœ¨å¤–éƒ¨ç»„ä»¶å·²å¹²æ¶‰ kube-proxy çš„ iptables è§„åˆ™æ—¶é€šçŸ¥çš„é€Ÿåº¦ã€‚ åœ¨å¤§å‹é›†ç¾¤ä¸­ï¼Œkube-proxy ä¹Ÿä»…åœ¨æ¯éš” <code>syncPeriod</code> æ—¶é•¿æ‰§è¡ŒæŸäº›æ¸…ç†æ“ä½œï¼Œä»¥é¿å…ä¸å¿…è¦çš„å·¥ä½œã€‚</li>
</ul>
<h3 id="ipvs">IPVS</h3>
<p>åœ¨ <code>ipvs</code> æ¨¡å¼ä¸‹ï¼Œkube-proxy ç›‘è§† Kubernetes Service å’Œ EndpointSliceï¼Œ ç„¶åè°ƒç”¨ <code>netlink</code> æ¥å£åˆ›å»º IPVS è§„åˆ™ï¼Œ å¹¶å®šæœŸä¸ Kubernetes Service å’Œ EndpointSlice åŒæ­¥ IPVS è§„åˆ™ã€‚ è¯¥æ§åˆ¶å›è·¯ç¡®ä¿ IPVS çŠ¶æ€ä¸æœŸæœ›çš„çŠ¶æ€ä¿æŒä¸€è‡´ã€‚ è®¿é—® Service æ—¶ï¼ŒIPVS ä¼šå°†æµé‡å¯¼å‘åˆ°æŸä¸€ä¸ªåç«¯ Podã€‚</p>
<p>IPVS ä»£ç†æ¨¡å¼åŸºäº netfilter å›è°ƒå‡½æ•°ï¼Œç±»ä¼¼äº iptables æ¨¡å¼ï¼Œ ä½†å®ƒä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ç”Ÿæ•ˆã€‚ è¿™æ„å‘³ç€ IPVS æ¨¡å¼ä¸‹çš„ kube-proxy æ¯” iptables æ¨¡å¼ä¸‹çš„ kube-proxy é‡å®šå‘æµé‡çš„å»¶è¿Ÿæ›´ä½ï¼ŒåŒæ­¥ä»£ç†è§„åˆ™æ—¶æ€§èƒ½ä¹Ÿæ›´å¥½ã€‚ ä¸å…¶ä»–ä»£ç†æ¨¡å¼ç›¸æ¯”ï¼ŒIPVS æ¨¡å¼è¿˜æ”¯æŒæ›´é«˜çš„ç½‘ç»œæµé‡ååé‡ã€‚</p>
<p>IPVS æä¾›äº†æ›´å¤šé€‰é¡¹æ¥å¹³è¡¡åç«¯ Pod çš„æµé‡ï¼Œé»˜è®¤æ˜¯ <code>rr</code>ï¼Œæœ‰å¦‚ä¸‹ä¸€äº›ç­–ç•¥ï¼š</p>
<ul>
<li>rr: è½®è¯¢</li>
<li>lc: æœ€å°‘è¿æ¥ï¼ˆæ‰“å¼€è¿æ¥æ•°æœ€å°‘ï¼‰</li>
<li>dh: ç›®æ ‡åœ°å€å“ˆå¸Œ</li>
<li>sh: æºåœ°å€å“ˆå¸Œ</li>
<li>sed: æœ€çŸ­é¢„æœŸå»¶è¿Ÿ</li>
<li>nq:æœ€å°‘é˜Ÿåˆ—</li>
</ul>
<p><img style="max-width: 100%; height: auto;" loading="lazy" alt="img" loading="lazy" src="https://d33wubrfki0l68.cloudfront.net/5cf236cbe0fecd3dfa46f6c648fc732c3ff06bf5/33f79/images/docs/services-ipvs-overview.svg"></p>
<p>ä¸è¿‡ç°åœ¨åªèƒ½æ•´ä½“ä¿®æ”¹ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡ kube-proxy ä¸­é…ç½® <code>â€“ipvs-scheduler</code> å‚æ•°æ¥å®ç°ï¼Œæš‚æ—¶ä¸æ”¯æŒç‰¹å®šçš„ Service è¿›è¡Œé…ç½®ã€‚</p>
<p>å¼€å¯<code>ipvs</code>æ¨¡å—</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">modprobe -- ip_vs
</span></span><span class="line"><span class="cl">modprobe -- ip_vs_rr
</span></span><span class="line"><span class="cl">modprobe -- ip_vs_wrr
</span></span><span class="line"><span class="cl">modprobe -- ip_vs_sh
</span></span><span class="line"><span class="cl">modprobe -- nf_conntrack_ipv4
</span></span><span class="line"><span class="cl">yum install ipvsadm ipset -y
</span></span></code></pre></div><p>ä¿®æ”¹<code>kube-proxy</code>çš„<code>configMap</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl edit configmap kube-proxy -n kube-system
</span></span><span class="line"><span class="cl"><span class="c1"># ä¿®æ”¹modeä¸º&#34;ipvs&#34;</span>
</span></span><span class="line"><span class="cl">   minSyncPeriod: 0s
</span></span><span class="line"><span class="cl">      scheduler: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">      syncPeriod: 30s
</span></span><span class="line"><span class="cl">    kind: KubeProxyConfiguration
</span></span><span class="line"><span class="cl">    metricsBindAddress: 127.0.0.1:10249
</span></span><span class="line"><span class="cl">    mode: <span class="s2">&#34;ipvs&#34;</span>                          <span class="c1"># ä¿®æ”¹æ­¤å¤„</span>
</span></span><span class="line"><span class="cl">    nodePortAddresses: null
</span></span></code></pre></div><blockquote>
<p>ä¿®æ”¹å®Œæˆåè®°å¾—é‡å¯<code>kube-proxy</code>ï¼Œç„¶åä½¿ç”¨<code>ipvsadm -ln</code>æ ¡éªŒã€‚æ­£å¸¸å¯ä»¥å‡ºç°å¾ˆå¤šçš„è§„åˆ™é“¾æ¡ã€‚</p>
</blockquote>
<h4 id="ä¼šè¯äº²å’Œæ€§">ä¼šè¯äº²å’Œæ€§</h4>
<p>åœ¨è¿™äº›ä»£ç†æ¨¡å‹ä¸­ï¼Œç»‘å®šåˆ° <code>Service IP:Port</code> çš„æµé‡è¢«ä»£ç†åˆ°åˆé€‚çš„åç«¯ï¼Œ å®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“ä»»ä½•å…³äº Kubernetesã€Service æˆ– Pod çš„ä¿¡æ¯ã€‚</p>
<p>å¦‚æœè¦ç¡®ä¿æ¥è‡ªç‰¹å®šå®¢æˆ·ç«¯çš„è¿æ¥æ¯æ¬¡éƒ½ä¼ é€’ç»™åŒä¸€ä¸ª Podï¼Œ ä½ å¯ä»¥é€šè¿‡è®¾ç½® Service çš„ <code>.spec.sessionAffinity</code> ä¸º <code>ClientIP</code> æ¥è®¾ç½®åŸºäºå®¢æˆ·ç«¯ IP åœ°å€çš„ä¼šè¯äº²å’Œæ€§ï¼ˆé»˜è®¤ä¸º <code>None</code>ï¼‰ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sessionAffinity</span><span class="p">:</span><span class="w"> </span><span class="l">ClientIP</span><span class="w">
</span></span></span></code></pre></div><h3 id="ä¼šè¯è¶…æ—¶">ä¼šè¯è¶…æ—¶</h3>
<p>ä½ è¿˜å¯ä»¥é€šè¿‡è®¾ç½® Service çš„ <code>.spec.sessionAffinityConfig.clientIP.timeoutSeconds</code> æ¥è®¾ç½®æœ€å¤§ä¼šè¯ç²˜æ€§æ—¶é—´ï¼ˆé»˜è®¤å€¼ä¸º 10800ï¼Œå³ 3 å°æ—¶ï¼‰ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sessionAffinityConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">clientIP</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10800</span><span class="w">
</span></span></span></code></pre></div><h2 id="service">Service</h2>
<p>å°†è¿è¡Œåœ¨ä¸€ç»„ <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/"  target="_blank" rel="noopener"
    >Pods</a> ä¸Šçš„åº”ç”¨ç¨‹åºå…¬å¼€ä¸ºç½‘ç»œæœåŠ¡çš„æŠ½è±¡æ–¹æ³•ã€‚</p>
<p>ä½¿ç”¨ Kubernetesï¼Œä½ æ— éœ€ä¿®æ”¹åº”ç”¨ç¨‹åºå»ä½¿ç”¨ä¸ç†Ÿæ‚‰çš„æœåŠ¡å‘ç°æœºåˆ¶ã€‚ Kubernetes ä¸º Pod æä¾›è‡ªå·±çš„ IP åœ°å€ï¼Œå¹¶ä¸ºä¸€ç»„ Pod æä¾›ç›¸åŒçš„ DNS åï¼Œ å¹¶ä¸”å¯ä»¥åœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚</p>
<p>Kubernetes <code>ServiceTypes</code> å…è®¸æŒ‡å®šä½ æ‰€éœ€è¦çš„ Service ç±»å‹ã€‚</p>
<ul>
<li><code>ClusterIP</code>ï¼šé€šè¿‡é›†ç¾¤çš„å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼Œé€‰æ‹©è¯¥å€¼æ—¶æœåŠ¡åªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚ è¿™ä¹Ÿæ˜¯ä½ æ²¡æœ‰ä¸ºæœåŠ¡æ˜¾å¼æŒ‡å®š <code>type</code> æ—¶ä½¿ç”¨çš„é»˜è®¤å€¼ã€‚ ä½ å¯ä»¥ä½¿ç”¨ <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/"  target="_blank" rel="noopener"
    >Ingress</a> æˆ–è€… <a class="link" href="https://gateway-api.sigs.k8s.io/"  target="_blank" rel="noopener"
    >Gateway API</a> å‘å…¬ä¼—æš´éœ²æœåŠ¡ã€‚</li>
<li>NodePortï¼š é€šè¿‡æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ IP å’Œé™æ€ç«¯å£ï¼ˆ<code>NodePort</code>ï¼‰æš´éœ²æœåŠ¡ã€‚ ä¸ºäº†è®©èŠ‚ç‚¹ç«¯å£å¯ç”¨ï¼ŒKubernetes è®¾ç½®äº†é›†ç¾¤ IP åœ°å€ï¼Œè¿™ç­‰åŒäºä½ è¯·æ±‚ <code>type: ClusterIP</code> çš„æœåŠ¡ã€‚</li>
<li>LoadBalancerï¼šä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚ å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å¯ä»¥å°†æµé‡è·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ <code>NodePort</code> æœåŠ¡å’Œ <code>ClusterIP</code> æœåŠ¡ä¸Šã€‚</li>
<li>ExternalNameï¼šé€šè¿‡è¿”å› <code>CNAME</code> è®°å½•å’Œå¯¹åº”å€¼ï¼Œå¯ä»¥å°†æœåŠ¡æ˜ å°„åˆ° <code>externalName</code> å­—æ®µçš„å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œ<code>foo.bar.example.com</code>ï¼‰ã€‚ æ— éœ€åˆ›å»ºä»»ä½•ç±»å‹ä»£ç†ã€‚</li>
</ul>
<h3 id="nodeport">NodePort</h3>
<p>å¦‚æœä½ å°† <code>type</code> å­—æ®µè®¾ç½®ä¸º <code>NodePort</code>ï¼Œåˆ™ Kubernetes æ§åˆ¶å¹³é¢å°†åœ¨ <code>--service-node-port-range</code> æ ‡å¿—æŒ‡å®šçš„èŒƒå›´å†…åˆ†é…ç«¯å£ï¼ˆé»˜è®¤å€¼ï¼š30000-32767ï¼‰ã€‚ æ¯ä¸ªèŠ‚ç‚¹å°†é‚£ä¸ªç«¯å£ï¼ˆæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ç›¸åŒç«¯å£å·ï¼‰ä»£ç†åˆ°ä½ çš„æœåŠ¡ä¸­ã€‚ ä½ çš„æœåŠ¡åœ¨å…¶ <code>.spec.ports[*].nodePort</code> å­—æ®µä¸­æŠ¥å‘Šå·²åˆ†é…çš„ç«¯å£ã€‚</p>
<p>ä½¿ç”¨ NodePort å¯ä»¥è®©ä½ è‡ªç”±è®¾ç½®è‡ªå·±çš„è´Ÿè½½å‡è¡¡è§£å†³æ–¹æ¡ˆï¼Œ é…ç½® Kubernetes ä¸å®Œå…¨æ”¯æŒçš„ç¯å¢ƒï¼Œ ç”šè‡³ç›´æ¥æš´éœ²ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹çš„ IP åœ°å€ã€‚</p>
<p>å¯¹äº NodePort æœåŠ¡ï¼ŒKubernetes é¢å¤–åˆ†é…ä¸€ä¸ªç«¯å£ï¼ˆTCPã€UDP æˆ– SCTP ä»¥åŒ¹é…æœåŠ¡çš„åè®®ï¼‰ã€‚ é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å°†è‡ªå·±é…ç½®ä¸ºç›‘å¬åˆ†é…çš„ç«¯å£å¹¶å°†æµé‡è½¬å‘åˆ°ä¸è¯¥æœåŠ¡å…³è”çš„æŸä¸ªå°±ç»ªç«¯ç‚¹ã€‚ é€šè¿‡ä½¿ç”¨é€‚å½“çš„åè®®ï¼ˆä¾‹å¦‚ TCPï¼‰å’Œé€‚å½“çš„ç«¯å£ï¼ˆåˆ†é…ç»™è¯¥æœåŠ¡ï¼‰è¿æ¥åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼Œ ä½ å°†èƒ½å¤Ÿä»é›†ç¾¤å¤–éƒ¨ä½¿ç”¨ <code>type: NodePort</code> æœåŠ¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">MyApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ`targetPort` è¢«è®¾ç½®ä¸ºä¸ `port` å­—æ®µç›¸åŒçš„å€¼ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># å¯é€‰å­—æ®µ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼ŒKubernetes æ§åˆ¶å¹³é¢ä¼šä»æŸä¸ªèŒƒå›´å†…åˆ†é…ä¸€ä¸ªç«¯å£å·ï¼ˆé»˜è®¤ï¼š30000-32767ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">30007</span><span class="w">
</span></span></span></code></pre></div><h3 id="loadbalancer">LoadBalancer</h3>
<p>åœ¨ä½¿ç”¨æ”¯æŒå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„äº‘æä¾›å•†çš„æœåŠ¡æ—¶ï¼Œè®¾ç½® <code>type</code> çš„å€¼ä¸º <code>&quot;LoadBalancer&quot;</code>ï¼Œ å°†ä¸º Service æä¾›è´Ÿè½½å‡è¡¡å™¨ã€‚ è´Ÿè½½å‡è¡¡å™¨æ˜¯å¼‚æ­¥åˆ›å»ºçš„ï¼Œå…³äºè¢«æä¾›çš„è´Ÿè½½å‡è¡¡å™¨çš„ä¿¡æ¯å°†ä¼šé€šè¿‡ Service çš„ <code>status.loadBalancer</code> å­—æ®µå‘å¸ƒå‡ºå»ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">MyApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">9376</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.171.239</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loadBalancer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="m">192.0.2.127</span><span class="w">
</span></span></span></code></pre></div><p>è‡ªå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„æµé‡å°†ç›´æ¥é‡å®šå‘åˆ°åç«¯ Pod ä¸Šï¼Œä¸è¿‡å®é™…å®ƒä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¿™è¦ä¾èµ–äºäº‘æä¾›å•†ã€‚</p>
<p>æŸäº›äº‘æä¾›å•†å…è®¸è®¾ç½® <code>loadBalancerIP</code>ã€‚ åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå°†æ ¹æ®ç”¨æˆ·è®¾ç½®çš„ <code>loadBalancerIP</code> æ¥åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨ã€‚ å¦‚æœæ²¡æœ‰è®¾ç½® <code>loadBalancerIP</code> å­—æ®µï¼Œå°†ä¼šç»™è´Ÿè½½å‡è¡¡å™¨æŒ‡æ´¾ä¸€ä¸ªä¸´æ—¶ IPã€‚ å¦‚æœè®¾ç½®äº† <code>loadBalancerIP</code>ï¼Œä½†äº‘æä¾›å•†å¹¶ä¸æ”¯æŒè¿™ç§ç‰¹æ€§ï¼Œé‚£ä¹ˆè®¾ç½®çš„ <code>loadBalancerIP</code> å€¼å°†ä¼šè¢«å¿½ç•¥æ‰ã€‚</p>
<p>è¦å®ç° <code>type: LoadBalancer</code> çš„æœåŠ¡ï¼ŒKubernetes é€šå¸¸é¦–å…ˆè¿›è¡Œä¸è¯·æ±‚ <code>type: NodePort</code> æœåŠ¡ç­‰æ•ˆçš„æ›´æ”¹ã€‚ cloud-controller-manager ç»„ä»¶ç„¶åé…ç½®å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ä»¥å°†æµé‡è½¬å‘åˆ°å·²åˆ†é…çš„èŠ‚ç‚¹ç«¯å£ã€‚</p>
<h3 id="externalname">ExternalName</h3>
<p>ç±»å‹ä¸º ExternalName çš„æœåŠ¡å°†æœåŠ¡æ˜ å°„åˆ° DNS åç§°ï¼Œè€Œä¸æ˜¯å…¸å‹çš„é€‰æ‹©ç®—ç¬¦ï¼Œä¾‹å¦‚ <code>my-service</code> æˆ–è€… <code>cassandra</code>ã€‚ ä½ å¯ä»¥ä½¿ç”¨ <code>spec.externalName</code> å‚æ•°æŒ‡å®šè¿™äº›æœåŠ¡ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ Service å®šä¹‰å°† <code>prod</code> åç§°ç©ºé—´ä¸­çš„ <code>my-service</code> æœåŠ¡æ˜ å°„åˆ° <code>my.database.example.com</code></p>
<pre tabindex="0"><code>apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: prod
spec:
  type: ExternalName
  externalName: my.database.example.com
</code></pre><h3 id="è‡ªå®šä¹‰service">è‡ªå®šä¹‰Service</h3>
<p>å‡è®¾æˆ‘ä»¬çš„etcdé›†ç¾¤åœ¨å¤–éƒ¨ï¼Œæˆ‘ä»¬æƒ³è¦é€šè¿‡<code>Service</code>è¿›è¡Œè®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œè‡ªå®šä¹‰çš„<code>Service</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ClusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">etcd-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">2379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Endpoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-etcd-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subsets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">address</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="m">10.151.30.11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">etcd-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">2379</span><span class="w">
</span></span></span></code></pre></div><h2 id="è·å–å®¢æˆ·ç«¯ip">è·å–å®¢æˆ·ç«¯IP</h2>
<p>é€šå¸¸ï¼Œå½“é›†ç¾¤å†…çš„å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡çš„æ—¶å€™ï¼Œæ˜¯æ”¯æŒæœåŠ¡çš„ Pod å¯ä»¥è·å–åˆ°å®¢æˆ·ç«¯çš„ IP åœ°å€çš„ï¼Œä½†æ˜¯ï¼Œå½“é€šè¿‡èŠ‚ç‚¹ç«¯å£æ¥æ”¶åˆ°è¿æ¥æ—¶ï¼Œç”±äºå¯¹æ•°æ®åŒ…æ‰§è¡Œäº†æºç½‘ç»œåœ°å€è½¬æ¢ï¼ˆSNATï¼‰ï¼Œå› æ­¤æ•°æ®åŒ…çš„æº IP åœ°å€ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåç«¯çš„ Pod æ— æ³•çœ‹åˆ°å®é™…çš„å®¢æˆ·ç«¯ IPï¼Œå¯¹äºæŸäº›åº”ç”¨æ¥è¯´æ˜¯ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ï¼Œnginx çš„è¯·æ±‚æ—¥å¿—å°±æ— æ³•è·å–å‡†ç¡®çš„å®¢æˆ·ç«¯è®¿é—® IP äº†ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ç»„<code>nginx</code>é›†ç¾¤æœåŠ¡ï¼Œå½“æˆ‘ä»<code>10.1.6.48</code>è¿›è¡Œè®¿é—®çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æœ€ç»ˆå‘ˆç°ç»™æˆ‘ä»¬çš„åœ°å€</p>
<pre tabindex="0"><code class="language-log" data-lang="log">10.10.207.192 - - [23/Feb/2023:06:09:24 +0000] &#34;GET / HTTP/1.1&#34; 200 615 &#34;-&#34; &#34;curl/7.61.1&#34; &#34;-&#34;
10.10.207.192 - - [23/Feb/2023:06:10:50 +0000] &#34;GET / HTTP/1.1&#34; 200 615 &#34;-&#34; &#34;curl/7.61.1&#34; &#34;-&#34;
10.10.207.192 - - [23/Feb/2023:06:10:52 +0000] &#34;GET / HTTP/1.1&#34; 200 615 &#34;-&#34; &#34;curl/7.61.1&#34; &#34;-&#34;
10.10.207.192 - - [23/Feb/2023:06:10:53 +0000] &#34;GET / HTTP/1.1&#34; 200 615 &#34;-&#34; &#34;curl/7.61.1&#34; &#34;-&#34;
</code></pre><p>æ­£å¸¸æ¥è¯´æˆ‘å¾—åˆ°çš„åº”è¯¥æ˜¯å®¢æˆ·ç«¯çš„çœŸå®IPåœ°å€ï¼Œè€Œæˆ‘ç°åœ¨å¾—åˆ°çš„å´æ˜¯<code>tunl0@NONE</code>çš„IPåœ°å€</p>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨ Service è®¾ç½® <code>externalTrafficPolicy</code> æ¥å‡å°‘ç½‘ç»œè·³æ•°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">public-beijing-nginx-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">externalTrafficPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">beijing-nginx-http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">beijing-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sessionAffinity</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipFamilies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">IPv4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipFamilyPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">SingleStack</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">internalTrafficPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loadBalancer</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><p>ä½†è¿™å¯èƒ½å¯¼è‡´æµé‡åˆ†é…ä¸å‡ã€‚ æ²¡æœ‰é’ˆå¯¹ç‰¹å®š LoadBalancer æœåŠ¡çš„ä»»ä½• Pod çš„èŠ‚ç‚¹å°†æ— æ³•é€šè¿‡è‡ªåŠ¨åˆ†é…çš„ <code>.spec.healthCheckNodePort</code> è¿›è¡Œ NLB ç›®æ ‡ç»„çš„è¿è¡ŒçŠ¶å†µæ£€æŸ¥ï¼Œå¹¶ä¸”ä¸ä¼šæ”¶åˆ°ä»»ä½•æµé‡ã€‚</p>
]]></content:encoded>
    </item>
    <item>
      <title>åŸºäºkuberneteséƒ¨ç½²nacosé›†ç¾¤</title>
      <link>https://blog.mletter.cn/tech/kubernetes/install-nacos-cluster/</link>
      <pubDate>Tue, 07 Apr 2020 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/install-nacos-cluster/</guid>
      <description>kubernetesæŒä¹…åŒ–éƒ¨ç½²nacosé›†ç¾¤æ¼”ç¤º</description>
      <content:encoded><![CDATA[<h2 id="ç®€å•å®‰è£…ä½¿ç”¨">ç®€å•å®‰è£…ä½¿ç”¨</h2>
<blockquote>
<p>æœ€æ–°ç‰ˆæœ¬åº”è¯¥æ˜¯1.4.1</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/nacos-group/nacos-k8s.git
</span></span></code></pre></div><ul>
<li>ç®€å•ä½¿ç”¨</li>
<li>å¦‚æœä½ ä½¿ç”¨ç®€å•æ–¹å¼å¿«é€Ÿå¯åŠ¨,è¯·æ³¨æ„è¿™æ˜¯æ²¡æœ‰ä½¿ç”¨æŒä¹…åŒ–å·çš„,å¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±é£é™©:!!!</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> nacos-k8s
</span></span><span class="line"><span class="cl">chmod +x quick-startup.sh
</span></span><span class="line"><span class="cl">./quick-startup.sh
</span></span></code></pre></div><ul>
<li>æ¼”ç¤ºä½¿ç”¨</li>
<li><strong>æœåŠ¡æ³¨å†Œ</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -X PUT <span class="s1">&#39;http://cluster-ip:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080&#39;</span>
</span></span></code></pre></div><ul>
<li><strong>æœåŠ¡å‘ç°</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -X GET <span class="s1">&#39;http://cluster-ip:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName&#39;</span>
</span></span></code></pre></div><ul>
<li><strong>å‘å¸ƒé…ç½®</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -X POST <span class="s2">&#34;http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld&#34;</span>
</span></span></code></pre></div><ul>
<li><strong>è·å–é…ç½®</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -X GET <span class="s2">&#34;http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&#34;</span>
</span></span></code></pre></div><h2 id="é«˜çº§ç”¨æ³•">é«˜çº§ç”¨æ³•</h2>
<blockquote>
<p>åœ¨é«˜çº§ä½¿ç”¨ä¸­,Nacosåœ¨K8Sæ‹¥æœ‰è‡ªåŠ¨æ‰©å®¹ç¼©å®¹å’Œæ•°æ®æŒä¹…ç‰¹æ€§,è¯·æ³¨æ„å¦‚æœéœ€è¦ä½¿ç”¨è¿™éƒ¨åˆ†åŠŸèƒ½è¯·ä½¿ç”¨PVCæŒä¹…å·,Nacosçš„è‡ªåŠ¨æ‰©å®¹ç¼©å®¹éœ€è¦ä¾èµ–æŒä¹…å·,ä»¥åŠæ•°æ®æŒä¹…åŒ–ä¹Ÿæ˜¯ä¸€æ ·,æœ¬ä¾‹ä¸­ä½¿ç”¨çš„æ˜¯NFSæ¥ä½¿ç”¨PVC.</p>
</blockquote>
<h3 id="éƒ¨ç½²nfs">éƒ¨ç½²NFS</h3>
<p>nfs-client-provisioner å¯åŠ¨æ€ä¸ºkubernetesæä¾›pvå·ï¼Œæ˜¯Kubernetesçš„ç®€æ˜“NFSçš„å¤–éƒ¨provisionerï¼Œæœ¬èº«ä¸æä¾›NFSï¼Œéœ€è¦ç°æœ‰çš„NFSæœåŠ¡å™¨æä¾›å­˜å‚¨ã€‚æŒä¹…å·ç›®å½•çš„å‘½åè§„åˆ™ä¸º: <code>${namespace}-${pvcName}-${pvName}</code></p>
<p><strong>åˆ›å»ºè§’è‰²</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create -f deploy/nfs/rbac.yaml
</span></span></code></pre></div><p><strong>ä¿®æ”¹NFSçš„yaml</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">vim nacos-k8s/deploy/nfs/deployment.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Recreate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/external_storage/nfs-client-provisioner:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client-root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/persistentvolumes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PROVISIONER_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">fuseim.pri/ifs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">NFS_SERVER</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">10.1.6.93</span><span class="w"> </span><span class="c"># ä¿®æ”¹NFSçš„IPä¸ºä½ æœ¬åœ°çš„NFSIPåœ°å€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">NFS_PATH</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/server/nacos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client-root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="m">10.1.6.93</span><span class="w"> </span><span class="c"># åŒä¸Š</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/server/nacos</span><span class="w">
</span></span></span></code></pre></div><p><strong>éƒ¨ç½²NFS-client</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create -f deploy/nfs/deployment.yaml
</span></span></code></pre></div><p><strong>éƒ¨ç½²NFS StorageClass</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create -f deploy/nfs/class.yaml
</span></span></code></pre></div><p><strong>éªŒè¯nfs-client-provisioneræ˜¯å¦æˆåŠŸ</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get pod -l <span class="nv">app</span><span class="o">=</span>nfs-client-provisioner
</span></span></code></pre></div><h3 id="éƒ¨ç½²mysql">éƒ¨ç½²mysql</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create -f deploy/mysql/mysql-nfs.yaml
</span></span></code></pre></div><h3 id="éƒ¨ç½²nacos">éƒ¨ç½²Nacos</h3>
<ul>
<li>ä¿®æ”¹ <strong>deploy/nacos/nacos-pvc-nfs.yaml</strong></li>
</ul>
<blockquote>
<p>å¯ä»¥è‡ªè¡Œé€‰æ‹©æ›´æ”¹</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mysql.master.db.name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ä¸»åº“åç§°&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mysql.master.port</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ä¸»åº“ç«¯å£&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mysql.slave.port</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ä»åº“ç«¯å£&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mysql.master.user</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ä¸»åº“ç”¨æˆ·å&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mysql.master.password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ä¸»åº“å¯†ç &#34;</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><strong>åˆ›å»ºNacos</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create -f nacos-k8s/deploy/nacos/nacos-pvc-nfs.yaml
</span></span></code></pre></div><h3 id="æ‰©å®¹æµ‹è¯•">æ‰©å®¹æµ‹è¯•</h3>
<ul>
<li>åœ¨æ‰©å®¹å‰ï¼Œä½¿ç”¨ <a class="link" href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec"  target="_blank" rel="noopener"
    ><code>kubectl exec</code></a>è·å–åœ¨podä¸­çš„Nacosé›†ç¾¤é…ç½®æ–‡ä»¶ä¿¡æ¯</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">for</span> i in <span class="m">0</span> 1<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> nacos-<span class="nv">$i</span><span class="p">;</span> kubectl <span class="nb">exec</span> nacos-<span class="nv">$i</span> cat conf/cluster.conf<span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></div><p>StatefulSetæ§åˆ¶å™¨æ ¹æ®å…¶åºæ•°ç´¢å¼•ä¸ºæ¯ä¸ªPodæä¾›å”¯ä¸€çš„ä¸»æœºåã€‚ ä¸»æœºåé‡‡ç”¨ - çš„å½¢å¼ã€‚ å› ä¸ºnacos StatefulSetçš„å‰¯æœ¬å­—æ®µè®¾ç½®ä¸º3ï¼Œæ‰€ä»¥å½“å‰é›†ç¾¤æ–‡ä»¶ä¸­åªæœ‰ä¸‰ä¸ªNacosèŠ‚ç‚¹åœ°å€</p>
<ul>
<li>ä½¿ç”¨kubectl scale å¯¹NacosåŠ¨æ€æ‰©å®¹</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl scale sts nacos --replicas<span class="o">=</span><span class="m">5</span>
</span></span></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>kubernetes-Schedulerç®€å•è¯¦è§£</title>
      <link>https://blog.mletter.cn/tech/kubernetes/kube-schdeduler/</link>
      <pubDate>Sat, 14 Mar 2020 00:00:00 +0000</pubDate>
      <guid>https://blog.mletter.cn/tech/kubernetes/kube-schdeduler/</guid>
      <description>kube-scheduler æ˜¯ kubernetes çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€</description>
      <content:encoded><![CDATA[<p><code>kube-scheduler</code> æ˜¯ kubernetes çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œä¸»è¦è´Ÿè´£æ•´ä¸ªé›†ç¾¤èµ„æºçš„è°ƒåº¦åŠŸèƒ½ï¼Œæ ¹æ®ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œç­–ç•¥ï¼Œå°† Pod è°ƒåº¦åˆ°æœ€ä¼˜çš„å·¥ä½œèŠ‚ç‚¹ä¸Šé¢å»ï¼Œä»è€Œæ›´åŠ åˆç†ã€æ›´åŠ å……åˆ†çš„åˆ©ç”¨é›†ç¾¤çš„èµ„æºï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ kubernetes ä¸€ä¸ªéå¸¸é‡è¦çš„ç†ç”±ã€‚å¦‚æœä¸€é—¨æ–°çš„æŠ€æœ¯ä¸èƒ½å¸®åŠ©ä¼ä¸šèŠ‚çº¦æˆæœ¬ã€æä¾›æ•ˆç‡ï¼Œæˆ‘ç›¸ä¿¡æ˜¯å¾ˆéš¾æ¨è¿›çš„ã€‚</p>
<h2 id="è°ƒåº¦æµç¨‹">è°ƒåº¦æµç¨‹</h2>
<p><code>kube-scheduler</code> æä¾›çš„é»˜è®¤è°ƒåº¦å™¨èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬ç»å¤§å¤šæ•°çš„è¦æ±‚ï¼Œæˆ‘ä»¬å‰é¢å’Œå¤§å®¶æ¥è§¦çš„ç¤ºä¾‹ä¹ŸåŸºæœ¬ä¸Šç”¨çš„é»˜è®¤çš„ç­–ç•¥ï¼Œéƒ½å¯ä»¥ä¿è¯æˆ‘ä»¬çš„ Pod å¯ä»¥è¢«åˆ†é…åˆ°èµ„æºå……è¶³çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ä½†æ˜¯åœ¨å®é™…çš„çº¿ä¸Šé¡¹ç›®ä¸­ï¼Œå¯èƒ½æˆ‘ä»¬è‡ªå·±ä¼šæ¯” kubernetes æ›´åŠ äº†è§£æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ª Pod åªèƒ½è¿è¡Œåœ¨ç‰¹å®šçš„å‡ ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…è¿™å‡ ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æ¥è¿è¡Œç‰¹å®šç±»å‹çš„åº”ç”¨ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬çš„è°ƒåº¦å™¨èƒ½å¤Ÿå¯æ§ã€‚</p>
<ol>
<li>å‘èµ·åˆ›å»º<code>Deployment</code>è¯·æ±‚-&gt;<code>API Server</code>,è¿™ä¸ªæ—¶å€™<code>APIServer</code>ä¼šè¿›è¡Œä¸€ç³»åˆ—çš„é€»è¾‘å¤„ç†,ä¾‹å¦‚: é‰´æƒã€æŸ¥çœ‹ä½ æ˜¯å¦æœ‰æƒé™æ“ä½œã€Deploymentåˆ›å»ºæ˜¯å¦åˆæ³•ç­‰ç­‰,ç„¶åå°†è¯·æ±‚å­˜å‚¨åˆ°etcdå½“ä¸­å¹¶ä¸”è½¬å‘ç»™<code>Controller Manager</code></li>
<li><code>Controller Manager</code>ä¼šç›‘å¬<code>API Server</code>,è¿™ä¸ªæ—¶å€™å‡è®¾ç›‘å¬åˆ°çš„æ˜¯ä¸€ä¸ªåˆ›å»º<code>Deployment</code>çš„è¯·æ±‚,åˆ™ä¼šæŠŠè¯·æ±‚è½¬å‘åˆ°<code>Deployment Controller</code></li>
<li><code>Deployment Controller</code>æ¥å—åˆ°è¯·æ±‚ååˆ›å»º<code>ReplicaSet</code>,ç„¶å<code>ReplicaSet Controller</code>ä¼šæ ¹æ®<code>yaml</code>å½“ä¸­å®šä¹‰çš„<code>template</code>æ¨¡æ¿æ¥è¿›è¡Œåˆ›å»ºPod,ç„¶åè¿”å›ç»™<code>API Server</code></li>
<li>åœ¨åˆ›å»ºä¹‹åˆçš„Podå±æ€§ä¸­<code>nodeName</code>ä¸ºç©º,ä¹Ÿå°±æ˜¯æ²¡æœ‰è¢«è°ƒåº¦è¿‡çš„,è¿™ä¸ªæ—¶å€™è°ƒåº¦å™¨å°±ä¼šå¯¹å®ƒè¿›è¡Œè°ƒåº¦,è°ƒåº¦å»watchPodå¯¹è±¡,ç„¶ååˆ†æé‚£ä¸ªèŠ‚ç‚¹æœ€é€‚åˆè¿™ä¸ªPod,ç„¶åå°†èŠ‚ç‚¹çš„åå­—é€šè¿‡ç±»ä¼¼äºbindçš„è¿™ç§æ–¹æ³•å†™å…¥åˆ°<code>nodeName</code>å½“ä¸­ã€‚</li>
<li>ç„¶åè¯¥èŠ‚ç‚¹çš„kubeletä¼šè¿›è¡Œä¸€ç³»åˆ—çš„åˆ¤æ–­,ç„¶åè¿›å…¥Create Podçš„æµç¨‹,ç„¶åè¿›è¡Œä¸€ç³»åˆ—çš„<code>CNI</code>å’Œ<code>CSI</code>çš„è¿‡ç¨‹ã€‚</li>
</ol>
<blockquote>
<p>è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å¾€å¾€è¶Šç®€å•çš„ä¸œè¥¿,èƒŒåå®ç°çš„è¶Šå¤æ‚ã€‚</p>
</blockquote>
<h3 id="è°ƒåº¦é˜¶æ®µ">è°ƒåº¦é˜¶æ®µ</h3>
<p><code>kube-scheduler</code>è°ƒåº¦åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ</p>
<ol>
<li><code>predicate</code>: è¿‡æ»¤é˜¶æ®µï¼Œè¿‡æ»¤ä¸ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ã€‚</li>
<li><code>priority</code>: ä¼˜å…ˆçº§æ’åºï¼Œé€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ç»™èŠ‚ç‚¹æ‰“åˆ†ã€‚</li>
</ol>
<h3 id="predicatesç­–ç•¥">Predicatesç­–ç•¥</h3>
<ol>
<li><code>PodFitsHostPorts</code>: æ£€æŸ¥æ˜¯å¦æœ‰Host Portså†²çª</li>
<li><code>PodFitsPorts</code>: åŒä¸Š</li>
<li><code>PodFitsResources</code>: æ£€æŸ¥Nodeçš„èµ„æºæ˜¯å¦å……è¶³ï¼ŒåŒ…æ‹¬å…è®¸çš„Podæ•°é‡ã€CPUã€å†…å­˜ã€GPUä¸ªæ•°ä»¥åŠå…¶ä»–çš„OpaqueIntResourcesã€‚</li>
<li><code>HostName</code>:æ£€æŸ¥<code>pod.Spec.NodeName</code>æ˜¯å¦ä¸å€™é€‰èŠ‚ç‚¹ä¸€è‡´</li>
<li><code>MatchNodeSelector</code>:æ£€æŸ¥å€™é€‰èŠ‚ç‚¹çš„<code>pod.Spec.NodeSelector</code>æ˜¯å¦åŒ¹é…</li>
<li><code>NoVolumeZoneConflict</code>:æ£€æŸ¥<code>volume zone</code>æ˜¯å¦å†²çª</li>
</ol>
<h3 id="priorityç­–ç•¥">Priorityç­–ç•¥</h3>
<ol>
<li><code>SelectorSpreadPriority</code>: ä¼˜å…ˆå‡å°‘èŠ‚ç‚¹ä¸Šå±äºåŒä¸€ä¸ª<code>Service</code>æˆ–<code>Replication Controller</code>çš„Podæ•°é‡ã€‚</li>
<li><code>InterPodAffinityPriority</code>: ä¼˜å…ˆå°†Podè°ƒåº¦åˆ°ç›¸åŒçš„æ‹“æ‰‘ä¸Š</li>
<li><code>LeastRequestedPriority</code>:ä¼˜å…ˆè°ƒåº¦åˆ°è¯·æ±‚èµ„æºå°‘çš„èŠ‚ç‚¹ä¸Š</li>
<li><code>BalancedResourceAllocation</code>: ä¼˜å…ˆå¹³è¡¡å„èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨</li>
<li><code>NodePreferAvoidPodsPriority</code>:æƒé‡åˆ¤æ–­</li>
</ol>
<blockquote>
<p>å¤ªå¤šäº†å¯ä»¥è‡ªå·±å»å®˜ç½‘äº†è§£ä¸€ä¸‹ï¼Œè¿™äº›ç­–ç•¥éƒ½å¯ä»¥é€šè¿‡<code>scheduler</code>é…ç½®æ–‡ä»¶å»é…ç½®ï¼Œå…¶å®ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬ä¸å¤ªéœ€è¦ï¼Œæˆ‘è§‰å¾—kubernetesçš„è°ƒåº¦æ˜¯æœ€è®©æˆ‘ä»¬çœå¿ƒçš„ã€‚</p>
</blockquote>
<h2 id="èµ„æºéœ€æ±‚">èµ„æºéœ€æ±‚</h2>
<ul>
<li><code>requests</code>:å±äºè°ƒåº¦å™¨è°ƒåº¦çš„æ—¶å€™æ‰€å‚è€ƒçš„æŒ‡æ ‡ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘è¿™ä¸ªåº”ç”¨æœ€å°‘éœ€è¦<code>250m</code>çš„cpuå’Œ<code>256m</code>çš„å†…å­˜æ‰èƒ½è¿è¡Œã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">qa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">qa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">qa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">host-time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/localtime</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">2Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">250m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥æŸ¥çœ‹ä½ èŠ‚ç‚¹çš„ä¸€äº›èµ„æºçŠ¶æ€</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="p">[</span><span class="l">root@master1 ~]# kubectl get nodes -o yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">allocatable</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">15600m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ephemeral-storage</span><span class="p">:</span><span class="w"> </span><span class="l">104278276Ki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hugepages-1Gi</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hugepages-2Mi</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;38390677064&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pods</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;330&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;16&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ephemeral-storage</span><span class="p">:</span><span class="w"> </span><span class="l">104278276Ki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hugepages-1Gi</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hugepages-2Mi</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">40003048Ki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pods</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;330&#34;</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹çœ‹è¿™ä¸ª<code>deployment</code>è¿è¡Œä»¥åæˆ‘ä»¬çš„<code>cgroup</code>å¯¹ä»–åšäº†å¦‚ä½•çš„é™åˆ¶</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">&#34;CgroupParent&#34;: </span><span class="s2">&#34;/kubepods/burstable/pod1ceee26d-2ec2-43a8-96ef-5aa9ac99779b&#34;</span><span class="w">
</span></span></span></code></pre></div><p>è¿›å…¥è¿™ä¸ªç›®å½•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># cd /sys/fs/cgroup/cpu/kubepods/burstable/pod1ceee26d-2ec2-43a8-96ef-5aa9ac99779b</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 pod1ceee26d-2ec2-43a8-96ef-5aa9ac99779b<span class="o">]</span><span class="c1"># cat cpu.shares </span>
</span></span><span class="line"><span class="cl"><span class="m">358</span>
</span></span></code></pre></div><blockquote>
<p>kuberneteså¯¹äºä¸åŒçš„QOSçš„å¤„ç†æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
</blockquote>
<h3 id="limit-range">Limit-range</h3>
<p>ä¸€ä¸ª <strong>LimitRangeï¼ˆé™åˆ¶èŒƒå›´ï¼‰</strong> å¯¹è±¡æä¾›çš„é™åˆ¶èƒ½å¤Ÿåšåˆ°ï¼š</p>
<ul>
<li>åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­å®æ–½å¯¹æ¯ä¸ª Pod æˆ– Container æœ€å°å’Œæœ€å¤§çš„èµ„æºä½¿ç”¨é‡çš„é™åˆ¶ã€‚</li>
<li>åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­å®æ–½å¯¹æ¯ä¸ª <a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims"  target="_blank" rel="noopener"
    >PersistentVolumeClaim</a> èƒ½ç”³è¯·çš„æœ€å°å’Œæœ€å¤§çš„å­˜å‚¨ç©ºé—´å¤§å°çš„é™åˆ¶ã€‚</li>
<li>åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­å®æ–½å¯¹ä¸€ç§èµ„æºçš„ç”³è¯·å€¼å’Œé™åˆ¶å€¼çš„æ¯”å€¼çš„æ§åˆ¶ã€‚</li>
<li>è®¾ç½®ä¸€ä¸ªå‘½åç©ºé—´ä¸­å¯¹è®¡ç®—èµ„æºçš„é»˜è®¤ç”³è¯·/é™åˆ¶å€¼ï¼Œå¹¶ä¸”è‡ªåŠ¨çš„åœ¨è¿è¡Œæ—¶æ³¨å…¥åˆ°å¤šä¸ª Container ä¸­ã€‚</li>
</ul>
<p>å½“æŸå‘½åç©ºé—´ä¸­æœ‰ä¸€ä¸ª LimitRange å¯¹è±¡æ—¶ï¼Œå°†åœ¨è¯¥å‘½åç©ºé—´ä¸­å®æ–½ LimitRange é™åˆ¶ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">LimitRange</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu-resource-constraint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="c"># æ­¤å¤„å®šä¹‰é»˜è®¤é™åˆ¶å€¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">500m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">defaultRequest</span><span class="p">:</span><span class="w"> </span><span class="c"># æ­¤å¤„å®šä¹‰é»˜è®¤è¯·æ±‚å€¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">500m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="c"># max å’Œ min å®šä¹‰é™åˆ¶èŒƒå›´</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">min</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Container</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>è¿™ä¸œè¥¿å…¶å®æ˜¯ä¸å¤ªå¸¸ç”¨çš„</p>
</blockquote>
<h2 id="ç”Ÿäº§ç¯å¢ƒéœ€è¦è€ƒè™‘çš„é—®é¢˜">ç”Ÿäº§ç¯å¢ƒéœ€è¦è€ƒè™‘çš„é—®é¢˜</h2>
<ul>
<li>æ˜¯å¦å…¬å¹³è°ƒåº¦</li>
<li>èµ„æºæ˜¯å¦é«˜æ•ˆåˆ©ç”¨</li>
<li>QOS</li>
<li><code>affinity</code>å’Œ<code>anti-affinity</code></li>
<li>æ•°æ®æœ¬åœ°åŒ–</li>
<li>å†…éƒ¨è´Ÿè½½å¹²æ‰°(inter-workload interference)</li>
<li><code>deadlines</code></li>
</ul>
]]></content:encoded>
    </item>
  </channel>
</rss>
