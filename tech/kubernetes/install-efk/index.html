<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>kubernetes基于EFK的日志落地实现 | 太阳可以是蓝色</title>
<meta name=keywords content="kubernetes"><meta name=description content="Kubernetes 中比较流行的日志收集解决方案是 Elasticsearch、Fluentd 和 Kibana（EFK）技术栈，也是官方现在比较推荐的一种方案。
Elasticsearch 是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于索引和搜索大量日志数据，也可用于搜索许多不同类型的文档。
Elasticsearch 通常与 Kibana 一起部署，Kibana 是 Elasticsearch 的一个功能强大的数据可视化 Dashboard，Kibana 允许你通过 web 界面来浏览Elasticsearch 日志数据。
Fluentd是一个流行的开源数据收集器，我们将在 Kubernetes 集群节点上安装 Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。
我们先来配置启动一个可扩展的 Elasticsearch 集群，然后在 Kubernetes 集群中创建一个 Kibana 应用，最后通过 DaemonSet 来运行 Fluentd，以便它在每个 Kubernetes 工作节点上都可以运行一个 Pod。
安装 Elasticsearch 集群
先创建一个命名空间，我们将在其中安装所有日志相关的资源对象。
kubectl create ns kube-logging
环境准备
ElasticSearch 安装有最低安装要求，如果安装后 Pod 无法正常启动，请检查是否符合最低要求的配置，要求如下：

  
      
          节点
          CPU最低要求
          内存最低要求
      
  
  
      
          elasticsearch-master
          核心数>2
          内存>2G
      
      
          elasticsearch-data
          核心数>1
          内存>2G
      
      
          elasticsearch-client
          核心数>1
          内存>2G
      
  

集群节点信息

  
      
          集群
          节点类型
          副本数目
          存储大小
          网络模式
          描述
      
  
  
      
          elasticsearch
          master
          3
          5Gi
          ClusterIP
          主节点
      
      
          elasticsearch-data
          data
          3
          50Gi
          ClusterIP
          数据节点
      
      
          elasticsearch-client
          client
          2
          无
          NodePort
          负责处理用户请求
      
  


建议使用 StorageClass 来做持久化存储，当然如果你是线上环境建议使用 Local PV 或者 Ceph RBD 之类的存储来持久化 Elasticsearch 的数据。"><meta name=author content="iren."><link rel=canonical href=https://blog.mletter.cn/tech/kubernetes/install-efk/><link crossorigin=anonymous href=/assets/css/stylesheet.cc707ba415c88b815010bba5c5e0b1f11e11d905dfc1004752901e8d81c3fcf3.css integrity="sha256-zHB7pBXIi4FQELulxeCx8R4R2QXfwQBHUpAejYHD/PM=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.mletter.cn/tech/kubernetes/install-efk/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script src=/view-image.min.js></script><script>window.ViewImage&&ViewImage.init("img")</script><style>:root{--sys-font-family:-apple-system, "PingFang SC", Georgia, 'Nimbus Roman No9 L', 'Hiragino Sans GB', 'Noto Serif SC', 'Microsoft Yahei', 'WenQuanYi Micro Hei', 'ST Heiti', sans-serif;--code-font-family:"JetBrains Mono", Menlo, Monaco, Consolas, "Courier New";--article-font-family:-apple-system, "PingFang SC", var(--base-font-family)}</style><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><meta property="og:url" content="https://blog.mletter.cn/tech/kubernetes/install-efk/"><meta property="og:site_name" content="太阳可以是蓝色"><meta property="og:title" content="kubernetes基于EFK的日志落地实现"><meta property="og:description" content="Kubernetes 中比较流行的日志收集解决方案是 Elasticsearch、Fluentd 和 Kibana（EFK）技术栈，也是官方现在比较推荐的一种方案。
Elasticsearch 是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于索引和搜索大量日志数据，也可用于搜索许多不同类型的文档。
Elasticsearch 通常与 Kibana 一起部署，Kibana 是 Elasticsearch 的一个功能强大的数据可视化 Dashboard，Kibana 允许你通过 web 界面来浏览Elasticsearch 日志数据。
Fluentd是一个流行的开源数据收集器，我们将在 Kubernetes 集群节点上安装 Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。
我们先来配置启动一个可扩展的 Elasticsearch 集群，然后在 Kubernetes 集群中创建一个 Kibana 应用，最后通过 DaemonSet 来运行 Fluentd，以便它在每个 Kubernetes 工作节点上都可以运行一个 Pod。
安装 Elasticsearch 集群 先创建一个命名空间，我们将在其中安装所有日志相关的资源对象。
kubectl create ns kube-logging 环境准备 ElasticSearch 安装有最低安装要求，如果安装后 Pod 无法正常启动，请检查是否符合最低要求的配置，要求如下：
节点 CPU最低要求 内存最低要求 elasticsearch-master 核心数>2 内存>2G elasticsearch-data 核心数>1 内存>2G elasticsearch-client 核心数>1 内存>2G 集群节点信息
集群 节点类型 副本数目 存储大小 网络模式 描述 elasticsearch master 3 5Gi ClusterIP 主节点 elasticsearch-data data 3 50Gi ClusterIP 数据节点 elasticsearch-client client 2 无 NodePort 负责处理用户请求 建议使用 StorageClass 来做持久化存储，当然如果你是线上环境建议使用 Local PV 或者 Ceph RBD 之类的存储来持久化 Elasticsearch 的数据。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-08T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-08T00:00:00+00:00"><meta property="article:tag" content="Kubernetes"><meta property="og:image" content="https://img14.360buyimg.com/ddimg/jfs/t1/177175/31/35833/30306/64cb08eeF5ba90f46/1da6311bbbec8921.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://img14.360buyimg.com/ddimg/jfs/t1/177175/31/35833/30306/64cb08eeF5ba90f46/1da6311bbbec8921.jpg"><meta name=twitter:title content="kubernetes基于EFK的日志落地实现"><meta name=twitter:description content="Kubernetes 中比较流行的日志收集解决方案是 Elasticsearch、Fluentd 和 Kibana（EFK）技术栈，也是官方现在比较推荐的一种方案。
Elasticsearch 是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于索引和搜索大量日志数据，也可用于搜索许多不同类型的文档。
Elasticsearch 通常与 Kibana 一起部署，Kibana 是 Elasticsearch 的一个功能强大的数据可视化 Dashboard，Kibana 允许你通过 web 界面来浏览Elasticsearch 日志数据。
Fluentd是一个流行的开源数据收集器，我们将在 Kubernetes 集群节点上安装 Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。
我们先来配置启动一个可扩展的 Elasticsearch 集群，然后在 Kubernetes 集群中创建一个 Kibana 应用，最后通过 DaemonSet 来运行 Fluentd，以便它在每个 Kubernetes 工作节点上都可以运行一个 Pod。
安装 Elasticsearch 集群
先创建一个命名空间，我们将在其中安装所有日志相关的资源对象。
kubectl create ns kube-logging
环境准备
ElasticSearch 安装有最低安装要求，如果安装后 Pod 无法正常启动，请检查是否符合最低要求的配置，要求如下：

  
      
          节点
          CPU最低要求
          内存最低要求
      
  
  
      
          elasticsearch-master
          核心数>2
          内存>2G
      
      
          elasticsearch-data
          核心数>1
          内存>2G
      
      
          elasticsearch-client
          核心数>1
          内存>2G
      
  

集群节点信息

  
      
          集群
          节点类型
          副本数目
          存储大小
          网络模式
          描述
      
  
  
      
          elasticsearch
          master
          3
          5Gi
          ClusterIP
          主节点
      
      
          elasticsearch-data
          data
          3
          50Gi
          ClusterIP
          数据节点
      
      
          elasticsearch-client
          client
          2
          无
          NodePort
          负责处理用户请求
      
  


建议使用 StorageClass 来做持久化存储，当然如果你是线上环境建议使用 Local PV 或者 Ceph RBD 之类的存储来持久化 Elasticsearch 的数据。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"","item":"https://blog.mletter.cn/posts/"},{"@type":"ListItem","position":2,"name":"kubernetes基于EFK的日志落地实现","item":"https://blog.mletter.cn/tech/kubernetes/install-efk/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kubernetes基于EFK的日志落地实现","name":"kubernetes基于EFK的日志落地实现","description":"Kubernetes 中比较流行的日志收集解决方案是 Elasticsearch、Fluentd 和 Kibana（EFK）技术栈，也是官方现在比较推荐的一种方案。\nElasticsearch 是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于索引和搜索大量日志数据，也可用于搜索许多不同类型的文档。\nElasticsearch 通常与 Kibana 一起部署，Kibana 是 Elasticsearch 的一个功能强大的数据可视化 Dashboard，Kibana 允许你通过 web 界面来浏览Elasticsearch 日志数据。\nFluentd是一个流行的开源数据收集器，我们将在 Kubernetes 集群节点上安装 Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。\n我们先来配置启动一个可扩展的 Elasticsearch 集群，然后在 Kubernetes 集群中创建一个 Kibana 应用，最后通过 DaemonSet 来运行 Fluentd，以便它在每个 Kubernetes 工作节点上都可以运行一个 Pod。\n安装 Elasticsearch 集群 先创建一个命名空间，我们将在其中安装所有日志相关的资源对象。\nkubectl create ns kube-logging 环境准备 ElasticSearch 安装有最低安装要求，如果安装后 Pod 无法正常启动，请检查是否符合最低要求的配置，要求如下：\n节点 CPU最低要求 内存最低要求 elasticsearch-master 核心数\u0026gt;2 内存\u0026gt;2G elasticsearch-data 核心数\u0026gt;1 内存\u0026gt;2G elasticsearch-client 核心数\u0026gt;1 内存\u0026gt;2G 集群节点信息\n集群 节点类型 副本数目 存储大小 网络模式 描述 elasticsearch master 3 5Gi ClusterIP 主节点 elasticsearch-data data 3 50Gi ClusterIP 数据节点 elasticsearch-client client 2 无 NodePort 负责处理用户请求 建议使用 StorageClass 来做持久化存储，当然如果你是线上环境建议使用 Local PV 或者 Ceph RBD 之类的存储来持久化 Elasticsearch 的数据。\n","keywords":["kubernetes"],"articleBody":"Kubernetes 中比较流行的日志收集解决方案是 Elasticsearch、Fluentd 和 Kibana（EFK）技术栈，也是官方现在比较推荐的一种方案。\nElasticsearch 是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于索引和搜索大量日志数据，也可用于搜索许多不同类型的文档。\nElasticsearch 通常与 Kibana 一起部署，Kibana 是 Elasticsearch 的一个功能强大的数据可视化 Dashboard，Kibana 允许你通过 web 界面来浏览Elasticsearch 日志数据。\nFluentd是一个流行的开源数据收集器，我们将在 Kubernetes 集群节点上安装 Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。\n我们先来配置启动一个可扩展的 Elasticsearch 集群，然后在 Kubernetes 集群中创建一个 Kibana 应用，最后通过 DaemonSet 来运行 Fluentd，以便它在每个 Kubernetes 工作节点上都可以运行一个 Pod。\n安装 Elasticsearch 集群 先创建一个命名空间，我们将在其中安装所有日志相关的资源对象。\nkubectl create ns kube-logging 环境准备 ElasticSearch 安装有最低安装要求，如果安装后 Pod 无法正常启动，请检查是否符合最低要求的配置，要求如下：\n节点 CPU最低要求 内存最低要求 elasticsearch-master 核心数\u003e2 内存\u003e2G elasticsearch-data 核心数\u003e1 内存\u003e2G elasticsearch-client 核心数\u003e1 内存\u003e2G 集群节点信息\n集群 节点类型 副本数目 存储大小 网络模式 描述 elasticsearch master 3 5Gi ClusterIP 主节点 elasticsearch-data data 3 50Gi ClusterIP 数据节点 elasticsearch-client client 2 无 NodePort 负责处理用户请求 建议使用 StorageClass 来做持久化存储，当然如果你是线上环境建议使用 Local PV 或者 Ceph RBD 之类的存储来持久化 Elasticsearch 的数据。\n由于 ElasticSearch 7.x 版本默认安装了 X-Pack 插件，并且部分功能免费，需要我们配置一些安全证书文件。\n准备生成证书文件 注意：由于我们采用的是containerd所以使用nerdctl来运行一个容器\nmkdir -p elastic-certs nerdctl run --name elastic-certs -v elastic-certs:/app -it -w /app elasticsearch:7.17.3 /bin/sh -c \\ \"elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass '' \u0026\u0026 \\ elasticsearch-certutil cert --name security-master --dns \\ security-master --ca /app/elastic-stack-ca.p12 --pass '' --ca-pass '' --out /app/elastic-certificates.p12\" # 找到nerdctl挂载的目录 cd /var/lib/nerdctl/1935db59/volumes/default/elastic-certs/_data/ # 这个每个人是不一样的 可以自己搜索一下 mv * /root/elastic-certs/ cd /root/elastic-certs/ \u0026\u0026 openssl pkcs12 -nodes -passin pass:'' -in elastic-certificates.p12 -out elastic-certificate.pem 添加证书到kubernetes kubectl create secret -n kube-logging generic elastic-certs --from-file=elastic-certificates.p12 # 设置集群用户名和密码 kubectl create secret -n kube-logging generic elastic-auth --from-literal=username=elastic --from-literal=password=elastic-master 准备安装Elastic集群 采用Helm的方式来添加elasticsearch仓库 helm repo add elastic https://helm.elastic.co helm repo update ElaticSearch 安装需要安装三次，分别安装 Master、Data、Client 节点，Master 节点负责集群间的管理工作；Data 节点负责存储数据；Client 节点负责代理 ElasticSearch Cluster 集群，负载均衡。 2. 拉取elasticsearch\nhelm pull elastic/elasticsearch --untar --version 7.17.3 cd elasticsearch/ 在Chart目录下创建对应节点节点的values文件 以下是master-value.yaml\n# 设置集群名称 clusterName: \"elasticsearch\" # 设置节点名称 nodeGroup: \"master\" # 设置角色 roles: master: \"true\" ingest: \"false\" data: \"false\" # 镜像 image: \"docker.elastic.co/elasticsearch/elasticsearch\" imageTag: \"7.17.3\" imagePullPolicy: \"IfNotPresent\" # 副本数 replicas: 3 # ---资源配置--- esJavaOpts: \"-Xmx1g -Xms1g\" resources: requests: cpu: \"2000m\" memory: \"2Gi\" limits: cpu: \"2000m\" memory: \"2Gi\" # 数据持久卷配置 persistence: enabled: true # 存储数据大小配置 volumeClaimTemplate: storageClassName: managed-nfs-storage # 定义你自己的存储类 accessModes: ['ReadWriteOnce'] resources: requests: storage: 5Gi # ---安全设置--- # 设置协议，可配置为 http、https protocol: http # 证书挂载配置，这里我们挂入上面创建的证书 secretMounts: - name: elastic-certs secretName: elastic-certs path: /usr/share/elasticsearch/config/certs defaultMode: 0755 # 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml、log4j2.properties # ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下 # 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https esConfig: elasticsearch.yml: | xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.enabled: true # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # 环境变量配置，这里引入上面设置的用户名、密码 secret 文件 extraEnvs: - name: ELASTIC_USERNAME valueFrom: secretKeyRef: name: elastic-auth key: username - name: ELASTIC_PASSWORD valueFrom: secretKeyRef: name: elastic-auth key: password # ---调度设置--- # 设置调度策略 # - hard：只有当有足够的节点时 Pod 才会被调度，并且它们永远不会出现在同一个节点上 # - soft：尽最大努力调度 antiAffinity: 'soft' tolerations: - operator: \"Exists\" # 容忍全部污点 以下是data-value.yaml的内容\n# 设置集群名称 clusterName: \"elasticsearch\" # 设置节点名称 nodeGroup: \"data\" # 设置角色 roles: master: \"false\" ingest: \"true\" data: \"true\" # 镜像 image: \"docker.elastic.co/elasticsearch/elasticsearch\" imageTag: \"7.17.3\" imagePullPolicy: \"IfNotPresent\" # 副本数 replicas: 3 # ---资源配置--- esJavaOpts: \"-Xmx1g -Xms1g\" resources: requests: cpu: \"1000m\" memory: \"2Gi\" limits: cpu: \"1000m\" memory: \"2Gi\" # 数据持久卷配置 persistence: enabled: true # 存储数据大小配置 volumeClaimTemplate: storageClassName: managed-nfs-storage # 定义你自己的存储类 accessModes: ['ReadWriteOnce'] resources: requests: storage: 20Gi # ---安全设置--- # 设置协议，可配置为 http、https protocol: http # 证书挂载配置，这里我们挂入上面创建的证书 secretMounts: - name: elastic-certs secretName: elastic-certs path: /usr/share/elasticsearch/config/certs defaultMode: 0755 # 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml、log4j2.properties # ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下 # 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https esConfig: elasticsearch.yml: | xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.enabled: true # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # 环境变量配置，这里引入上面设置的用户名、密码 secret 文件 extraEnvs: - name: ELASTIC_USERNAME valueFrom: secretKeyRef: name: elastic-auth key: username - name: ELASTIC_PASSWORD valueFrom: secretKeyRef: name: elastic-auth key: password 以下是client-value.yaml\n# 设置集群名称 clusterName: \"elasticsearch\" # 设置节点名称 nodeGroup: \"client\" # 设置角色 roles: master: \"false\" ingest: \"false\" data: \"false\" # 镜像 image: \"docker.elastic.co/elasticsearch/elasticsearch\" imageTag: \"7.17.3\" imagePullPolicy: \"IfNotPresent\" # 副本数 replicas: 1 # ---资源配置--- esJavaOpts: \"-Xmx1g -Xms1g\" resources: requests: cpu: \"1000m\" memory: \"2Gi\" limits: cpu: \"1000m\" memory: \"2Gi\" # 数据持久卷配置 persistence: enabled: false # ---安全设置--- # 设置协议，可配置为 http、https protocol: http # 证书挂载配置，这里我们挂入上面创建的证书 secretMounts: - name: elastic-certs secretName: elastic-certs path: /usr/share/elasticsearch/config/certs defaultMode: 0755 # 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml、log4j2.properties # ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下 # 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https esConfig: elasticsearch.yml: | xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.enabled: true # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # 环境变量配置，这里引入上面设置的用户名、密码 secret 文件 extraEnvs: - name: ELASTIC_USERNAME valueFrom: secretKeyRef: name: elastic-auth key: username - name: ELASTIC_PASSWORD valueFrom: secretKeyRef: name: elastic-auth key: password # ----服务设置---- service: type: NodePort nodePort: '30200' 开始部署相关节点 helm upgrade --install elasticsearch-master -f master-values.yaml --namespace kube-logging ./ # 部署master helm upgrade --install elasticsearch-data -f data-values.yaml --namespace kube-logging ./ # 部署data helm upgrade --install elasticsearch-client -f client-values.yaml --namespace kube-logging ./ # 部署 client 正常情况下看到所有节点都处于running状态即可\n[root@Online-Beijing-master1 elasticsearch]# kubectl get pods -n kube-logging NAME READY STATUS RESTARTS AGE elasticsearch-client-0 1/1 Running 0 13m elasticsearch-data-0 1/1 Running 0 17m elasticsearch-data-1 1/1 Running 0 17m elasticsearch-data-2 1/1 Running 0 17m elasticsearch-master-0 1/1 Running 0 43m elasticsearch-master-1 1/1 Running 0 43m elasticsearch-master-2 1/1 Running 0 43m 安装Kibana 依旧使用helm的方式进行部署\n使用helm pull拉取Kibana包来进行解压 helm pull elastic/kibana --untar --version 7.17.3 cd kibana 定义一个名字为custom-value.yaml的文件 # 指定镜像与镜像版本 image: 'kibana' imageTag: '7.17.3' # 配置 ElasticSearch 地址 elasticsearchHosts: 'http://elasticsearch-client:9200' # 环境变量配置，这里引入上面设置的用户名、密码 secret 文件 extraEnvs: - name: 'ELASTICSEARCH_USERNAME' valueFrom: secretKeyRef: name: elastic-auth key: username - name: 'ELASTICSEARCH_PASSWORD' valueFrom: secretKeyRef: name: elastic-auth key: password resources: requests: cpu: '500m' memory: '1Gi' limits: cpu: '500m' memory: '1Gi' # kibana 配置中添加语言配置，设置 kibana 为中文 kibanaConfig: kibana.yml: | i18n.locale: \"zh-CN\" service: type: NodePort nodePort: '30601' 部署kibana helm install kibana -f custom-value.yaml --namespace kube-logging . 部署Fluentd Fluentd 是一个高效的日志聚合器，是用 Ruby 编写的，并且可以很好地扩展。对于大部分企业来说，Fluentd 足够高效并且消耗的资源相对较少，另外一个工具 Fluent-bit 更轻量级，占用资源更少，但是插件相对 Fluentd 来说不够丰富，所以整体来说，Fluentd 更加成熟，使用更加广泛，所以这里我们使用 Fluentd 来作为日志收集工具。\n工作原理 Fluentd 通过一组给定的数据源抓取日志数据，处理后（转换成结构化的数据格式）将它们转发给其他服务，比如 Elasticsearch、对象存储等等。Fluentd 支持超过 300 个日志存储和分析服务，所以在这方面是非常灵活的。主要运行步骤如下：\n首先 Fluentd 从多个日志源获取数据 结构化并且标记这些数据 然后根据匹配的标签将数据发送到多个目标服务去 官方文档 日志源配置 比如我们这里为了收集 Kubernetes 节点上的所有容器日志，就需要做如下的日志源配置：\nid：表示引用该日志源的唯一标识符，该标识可用于进一步过滤和路由结构化日志数据 type：Fluentd 内置的指令，tail 表示 Fluentd 从上次读取的位置通过 tail 不断获取数据，另外一个是 http 表示通过一个 GET 请求来收集数据。 path：tail 类型下的特定参数，告诉 Fluentd 采集 /var/log/containers 目录下的所有日志，这是 docker 在 Kubernetes 节点上用来存储运行容器 stdout 输出日志数据的目录。 pos_file：检查点，如果 Fluentd 程序重新启动了，它将使用此文件中的位置来恢复日志数据收集。 tag：用来将日志源与目标或者过滤器匹配的自定义字符串，Fluentd 匹配源/目标标签来路由日志数据。 @id fluentd-containers.log @type tail # Fluentd 内置的输入方式，其原理是不停地从源文件中获取新的日志,类似于tail命令 path /var/log/containers/*.log # 挂载的宿主机容器日志地址 pos_file /var/log/es-containers.log.pos tag raw.kubernetes.* # 设置日志标签 read_from_head true # 多行格式化成JSON @type multi_format # 使用 multi-format-parser 解析器插件 format json # JSON 解析器 time_key time # 指定事件时间的时间字段 time_format %Y-%m-%dT%H:%M:%S.%NZ # 时间格式 format /^(?.+) (?stdout|stderr) [^ ]* (?.*)$/ time_format %Y-%m-%dT%H:%M:%S.%N%:z 过滤 由于 Kubernetes 集群中应用太多，也还有很多历史数据，所以我们可以只将某些应用的日志进行收集，比如我们只采集具有 discovery-log=true 这个 Label 标签的 Pod 日志，这个时候就需要使用 filter。\n# 删除无用的属性 @type record_transformer remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash # 只保留具有discovery-log=true标签的Pod日志 @id filter_log @type grep key $.kubernetes.labels.discovery-log pattern ^true$ 路由设置 @id elasticsearch @type elasticsearch @log_level info include_tag_key true type_name fluentd host \"#{ENV['OUTPUT_HOST']}\" port \"#{ENV['OUTPUT_PORT']}\" logstash_format true @type file path /var/log/fluentd-buffers/kubernetes.system.buffer flush_mode interval retry_type exponential_backoff flush_thread_count 2 flush_interval 5s retry_forever retry_max_interval 30 chunk_limit_size \"#{ENV['OUTPUT_BUFFER_CHUNK_LIMIT']}\" queue_limit_length \"#{ENV['OUTPUT_BUFFER_QUEUE_LIMIT']}\" overflow_action block match：标识一个目标标签，后面是一个匹配日志源的正则表达式，我们这里想要捕获所有的日志并将它们发送给 Elasticsearch，所以需要配置成**。 id：目标的一个唯一标识符。 type：支持的输出插件标识符，我们这里要输出到 Elasticsearch，所以配置成 elasticsearch，这是 Fluentd 的一个内置插件。 log_level：指定要捕获的日志级别，我们这里配置成 info，表示任何该级别或者该级别以上（INFO、WARNING、ERROR）的日志都将被路由到 Elsasticsearch。 host/port：定义 Elasticsearch 的地址，也可以配置认证信息，我们的 Elasticsearch 不需要认证，所以这里直接指定 host 和 port 即可。 logstash_format：Elasticsearch 服务对日志数据构建反向索引进行搜索，将 logstash_format 设置为 true，Fluentd 将会以 logstash 格式来转发结构化的日志数据。 Buffer： Fluentd 允许在目标不可用时进行缓存，比如，如果网络出现故障或者 Elasticsearch 不可用的时候。缓冲区配置也有助于降低磁盘的 IO。 开始部署Fluentd 要收集 Kubernetes 集群的日志，直接用DasemonSet 控制器来部署 Fluentd 应用，这样，它就可以从 Kubernetes 节点上采集日志，确保在集群中的每个节点上始终运行一个 Fluentd 容器。当然可以直接使用 Helm 来进行一键安装，为了能够了解更多实现细节，我们这里还是采用手动方法来进行安装。\n安装文档 首先创建fluentd的configmap # fluentd-configmap.yaml kind: ConfigMap apiVersion: v1 metadata: name: fluentd-conf namespace: kube-logging data: # containerd的容器日志 containerd.input.conf: |- @id containerd-fluentd-beta.log # 唯一Id：运行时+收集插件+环境 @type tail # Fluentd 内置的输入方式，其原理是不停地从源文件中获取新的日志 path /var/log/containers/*.log # Docker 容器日志路径 pos_file /var/log/es-containers.log.pos # 记录读取的位置 tag raw.kubernetes.* # 设置日志标签 read_from_head true # 从头读取 # 多行格式化成JSON # 可以使用我们介绍过的 multiline 插件实现多行日志 @type multi_format # 使用 multi-format-parser 解析器插件 format json # JSON解析器 time_key time # 指定事件时间的时间字段 time_format %Y-%m-%dT%H:%M:%S.%NZ # 时间格式 format /^(?.+) (?stdout|stderr) [^ ]* (?.*)$/ time_format %Y-%m-%dT%H:%M:%S.%N%:z # 在日志输出中检测异常(多行日志)，并将其作为一条日志转发 # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions # 匹配tag为raw.kubernetes.**日志信息 @id raw.kubernetes @type detect_exceptions # 使用detect-exceptions插件处理异常栈信息 remove_tag_prefix raw # 移除 raw 前缀 message log multiline_flush_interval 5 # 拼接日志 @id filter_concat @type concat # Fluentd Filter 插件，用于连接多个日志中分隔的多行日志 key message multiline_end_regexp /\\n$/ # 以换行符“\\n”拼接 separator \"\" # 添加 Kubernetes metadata 数据 @id filter_kubernetes_metadata @type kubernetes_metadata # 修复 ES 中的 JSON 字段 # 插件地址：https://github.com/repeatedly/fluent-plugin-multi-format-parser @id filter_parser @type parser # multi-format-parser多格式解析器插件 key_name log # 在要解析的日志中指定字段名称 reserve_data true # 在解析结果中保留原始键值对 remove_key_name_field true # key_name 解析成功后删除字段 @type multi_format format json format none # 删除一些多余的属性 @type record_transformer remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash # 只保留具有kubernetes.log.kubernetes.log/fluentd标签的Pod日志 @id filter_log @type grep key $.kubernetes.labels.kubernetes.log/fluentd pattern ^true$ ###### 监听配置，一般用于日志聚合用 ###### forward.input.conf: |- # 监听通过TCP发送的消息 @id forward @type forward output.conf: |- @id elasticsearch @type elasticsearch @log_level info include_tag_key true host elasticsearch-client port 9200 user elastic # FLUENT_ELASTICSEARCH_USER | FLUENT_ELASTICSEARCH_PASSWORD password elastic-master logstash_format true logstash_prefix kubernetes-cluster request_timeout 30s @type file path /var/log/fluentd-buffers/kubernetes.system.buffer flush_mode interval retry_type exponential_backoff flush_thread_count 2 flush_interval 5s retry_forever retry_max_interval 30 chunk_limit_size 2M queue_limit_length 8 overflow_action block 创建相关的Rbac权限 --- apiVersion: v1 kind: ServiceAccount metadata: name: fluentd namespace: kube-logging --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: fluentd rules: - apiGroups: - \"\" resources: - pods - namespaces verbs: - get - list - watch --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: fluentd roleRef: kind: ClusterRole name: fluentd apiGroup: rbac.authorization.k8s.io subjects: - kind: ServiceAccount name: fluentd namespace: kube-logging 创建fluentd的daemonset 这个是最新的版本还在研究中,用下面的版本。\napiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd namespace: kube-logging labels: k8s-app: fluentd-logging version: v1 spec: selector: matchLabels: k8s-app: fluentd-logging version: v1 template: metadata: labels: k8s-app: fluentd-logging version: v1 spec: serviceAccount: fluentd serviceAccountName: fluentd tolerations: - key: node-role.kubernetes.io/control-plane effect: NoSchedule - key: node-role.kubernetes.io/master effect: NoSchedule containers: - name: fluentd image: fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch env: - name: K8S_NODE_NAME valueFrom: fieldRef: fieldPath: spec.nodeName - name: FLUENT_ELASTICSEARCH_HOST value: \"elasticsearch-client-headless.kube-logging.svc.cluster.local\" - name: FLUENT_ELASTICSEARCH_PORT value: \"9200\" - name: FLUENT_ELASTICSEARCH_SCHEME value: \"http\" # Option to configure elasticsearch plugin with self signed certs # ================================================================ - name: FLUENT_ELASTICSEARCH_SSL_VERIFY value: \"true\" # Option to configure elasticsearch plugin with tls # ================================================================ - name: FLUENT_ELASTICSEARCH_SSL_VERSION value: \"TLSv1_2\" # X-Pack Authentication # ===================== - name: FLUENT_ELASTICSEARCH_USER value: \"elastic\" - name: FLUENT_ELASTICSEARCH_PASSWORD value: \"elastic-master\" - name: FLUENT_ELASTICSEARCH_LOGSTASH_PREFIX value: \"kubernetes-cluster\" resources: limits: memory: 200Mi requests: cpu: 100m memory: 200Mi volumeMounts: - name: varlog mountPath: /var/log - name: fluentconfig mountPath: /fluentd/etc/custom - name: dockercontainerlogdirectory mountPath: /var/log/pods readOnly: true terminationGracePeriodSeconds: 30 volumes: - name: varlog hostPath: path: /var/log - name: fluentconfig configMap: name: fluentd-conf - name: dockercontainerlogdirectory hostPath: path: /var/log/pods 麻烦用下面的进行部署\napiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd namespace: kube-logging labels: app: fluentd kubernetes.io/cluster-service: 'true' spec: selector: matchLabels: app: fluentd template: metadata: labels: app: fluentd kubernetes.io/cluster-service: 'true' spec: tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule serviceAccountName: fluentd containers: - name: fluentd image: quay.io/fluentd_elasticsearch/fluentd:v3.4.0 volumeMounts: - name: fluentconfig mountPath: /etc/fluent/config.d - name: varlog mountPath: /var/log volumes: - name: fluentconfig configMap: name: fluentd-conf - name: varlog hostPath: path: /var/log 关于保留指定标签的问题 部署完成以后我发现一直有一个小问题，就是无论我如何设置label都无法让elasticsearch获取到正常的数据。\n根据这个问题，我进行了更细致的排查。现在得出了如下的结论。\n可能是由于我对知识的缺乏，我定义的是Deployment当中的label标签，但是这个label标识只作用于Deployment本身，通常用作kubernete集群中的选择器匹配，例如我们的Service要去匹配某个Deployment。\n关于spec.template.metadata.labels，我发现这个才是我们正确要匹配的label标签选项，因为这些标签用于标识Deployment所创建的Pod\n所以最后总结出来的问题就是，我们上面的fluentd中写的过滤插件 key $.kubernetes.labels.kubernetes.log/fluentd中所匹配的label标签应当是spec.template.metadata.labels的label\nspec: replicas: 2 selector: matchLabels: app: canary template: metadata: creationTimestamp: null labels: app: canary kubernetes.log/fluentd: 'true' ","wordCount":"1676","inLanguage":"zh","image":"https://img14.360buyimg.com/ddimg/jfs/t1/177175/31/35833/30306/64cb08eeF5ba90f46/1da6311bbbec8921.jpg","datePublished":"2023-12-08T00:00:00Z","dateModified":"2023-12-08T00:00:00Z","author":{"@type":"Person","name":"iren."},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.mletter.cn/tech/kubernetes/install-efk/"},"publisher":{"@type":"Organization","name":"太阳可以是蓝色","logo":{"@type":"ImageObject","url":"https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.mletter.cn/ accesskey=h title="太阳可以是蓝色 (Alt + H)">太阳可以是蓝色</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.mletter.cn/ title=主页><span>主页</span></a></li><li><a href=https://blog.mletter.cn/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.mletter.cn/posts/ title=文章><span>文章</span></a></li><li><a href=https://blog.mletter.cn/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.mletter.cn/friends/ title=友联><span>友联</span></a></li><li><a href=https://blog.mletter.cn/about title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.mletter.cn/>主页</a>&nbsp;»&nbsp;<a href=https://blog.mletter.cn/posts/></a></div><h1 class="post-title entry-hint-parent">kubernetes基于EFK的日志落地实现</h1><div class=post-meta><span title='2023-12-08 00:00:00 +0000 UTC'>十二月 8, 2023</span>&nbsp;·&nbsp;8 分钟&nbsp;·&nbsp;iren.</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#安装-elasticsearch-集群>安装 Elasticsearch 集群</a><ul><li><a href=#环境准备>环境准备</a></li><li><a href=#准备生成证书文件>准备生成证书文件</a></li><li><a href=#准备安装elastic集群>准备安装Elastic集群</a></li></ul></li><li><a href=#安装kibana>安装Kibana</a></li><li><a href=#部署fluentd>部署Fluentd</a><ul><li><a href=#工作原理>工作原理</a></li><li><a href=#日志源配置>日志源配置</a></li><li><a href=#过滤>过滤</a></li><li><a href=#路由设置>路由设置</a></li><li><a href=#开始部署fluentd>开始部署Fluentd</a></li></ul></li><li><a href=#关于保留指定标签的问题>关于保留指定标签的问题</a></li></ul></nav></div></details></div><div class=post-content><p>Kubernetes 中比较流行的日志收集解决方案是 <code>Elasticsearch</code>、<code>Fluentd</code> 和 <code>Kibana</code>（EFK）技术栈，也是官方现在比较推荐的一种方案。</p><p><code>Elasticsearch</code> 是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于索引和搜索大量日志数据，也可用于搜索许多不同类型的文档。</p><p><code>Elasticsearch</code> 通常与 <code>Kibana</code> 一起部署，<code>Kibana</code> 是 <code>Elasticsearch</code> 的一个功能强大的数据可视化 Dashboard，<code>Kibana</code> 允许你通过 web 界面来浏览<code>Elasticsearch</code> 日志数据。</p><p><code>Fluentd</code>是一个流行的开源数据收集器，我们将在 Kubernetes 集群节点上安装 <code>Fluentd</code>，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。</p><p>我们先来配置启动一个可扩展的 Elasticsearch 集群，然后在 Kubernetes 集群中创建一个 Kibana 应用，最后通过 DaemonSet 来运行 Fluentd，以便它在每个 Kubernetes 工作节点上都可以运行一个 Pod。</p><h2 id=安装-elasticsearch-集群>安装 Elasticsearch 集群<a hidden class=anchor aria-hidden=true href=#安装-elasticsearch-集群>#</a></h2><p>先创建一个命名空间，我们将在其中安装所有日志相关的资源对象。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create ns kube-logging
</span></span></code></pre></div><h3 id=环境准备>环境准备<a hidden class=anchor aria-hidden=true href=#环境准备>#</a></h3><p><code>ElasticSearch</code> 安装有最低安装要求，如果安装后 Pod 无法正常启动，请检查是否符合最低要求的配置，要求如下：</p><table><thead><tr><th>节点</th><th>CPU最低要求</th><th>内存最低要求</th></tr></thead><tbody><tr><td>elasticsearch-master</td><td>核心数>2</td><td>内存>2G</td></tr><tr><td>elasticsearch-data</td><td>核心数>1</td><td>内存>2G</td></tr><tr><td>elasticsearch-client</td><td>核心数>1</td><td>内存>2G</td></tr></tbody></table><p>集群节点信息</p><table><thead><tr><th>集群</th><th>节点类型</th><th>副本数目</th><th>存储大小</th><th>网络模式</th><th>描述</th></tr></thead><tbody><tr><td>elasticsearch</td><td>master</td><td>3</td><td>5Gi</td><td>ClusterIP</td><td>主节点</td></tr><tr><td>elasticsearch-data</td><td>data</td><td>3</td><td>50Gi</td><td>ClusterIP</td><td>数据节点</td></tr><tr><td>elasticsearch-client</td><td>client</td><td>2</td><td>无</td><td>NodePort</td><td>负责处理用户请求</td></tr></tbody></table><blockquote><p>建议使用 <code>StorageClass</code> 来做持久化存储，当然如果你是线上环境建议使用 Local PV 或者 Ceph RBD 之类的存储来持久化 Elasticsearch 的数据。</p></blockquote><p>由于 ElasticSearch 7.x 版本默认安装了 X-Pack 插件，并且部分功能免费，需要我们配置一些安全证书文件。</p><h3 id=准备生成证书文件>准备生成证书文件<a hidden class=anchor aria-hidden=true href=#准备生成证书文件>#</a></h3><blockquote><p>注意：由于我们采用的是<code>containerd</code>所以使用<code>nerdctl</code>来运行一个容器</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p elastic-certs
</span></span><span class=line><span class=cl>nerdctl run --name elastic-certs -v elastic-certs:/app -it -w /app elasticsearch:7.17.3 /bin/sh -c  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s2>&#34;elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass &#39;&#39; &amp;&amp; \
</span></span></span><span class=line><span class=cl><span class=s2>    elasticsearch-certutil cert --name security-master --dns \
</span></span></span><span class=line><span class=cl><span class=s2>    security-master --ca /app/elastic-stack-ca.p12 --pass &#39;&#39; --ca-pass &#39;&#39; --out /app/elastic-certificates.p12&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 找到nerdctl挂载的目录</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /var/lib/nerdctl/1935db59/volumes/default/elastic-certs/_data/ <span class=c1># 这个每个人是不一样的 可以自己搜索一下</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mv * /root/elastic-certs/
</span></span><span class=line><span class=cl><span class=nb>cd</span> /root/elastic-certs/ <span class=o>&amp;&amp;</span> openssl pkcs12 -nodes -passin pass:<span class=s1>&#39;&#39;</span> -in elastic-certificates.p12 -out elastic-certificate.pem
</span></span></code></pre></div><ol start=2><li>添加证书到<code>kubernetes</code></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create secret -n kube-logging generic elastic-certs --from-file<span class=o>=</span>elastic-certificates.p12
</span></span><span class=line><span class=cl><span class=c1># 设置集群用户名和密码</span>
</span></span><span class=line><span class=cl>kubectl create secret -n kube-logging generic elastic-auth --from-literal<span class=o>=</span><span class=nv>username</span><span class=o>=</span>elastic --from-literal<span class=o>=</span><span class=nv>password</span><span class=o>=</span>elastic-master
</span></span></code></pre></div><h3 id=准备安装elastic集群>准备安装Elastic集群<a hidden class=anchor aria-hidden=true href=#准备安装elastic集群>#</a></h3><ol><li>采用<code>Helm</code>的方式来添加<code>elasticsearch</code>仓库</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add elastic https://helm.elastic.co
</span></span><span class=line><span class=cl>helm repo update
</span></span></code></pre></div><p>ElaticSearch 安装需要安装三次，分别安装 Master、Data、Client 节点，Master 节点负责集群间的管理工作；Data 节点负责存储数据；Client 节点负责代理 ElasticSearch Cluster 集群，负载均衡。
2. 拉取elasticsearch</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm pull elastic/elasticsearch --untar --version 7.17.3
</span></span><span class=line><span class=cl><span class=nb>cd</span> elasticsearch/
</span></span></code></pre></div><p>在Chart目录下创建对应节点节点的<code>values</code>文件
以下是<code>master-value.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 设置集群名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;elasticsearch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置节点名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodeGroup</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;master&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置角色</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>master</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 镜像</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;docker.elastic.co/elasticsearch/elasticsearch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imageTag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;7.17.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;IfNotPresent&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 副本数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ---资源配置---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>esJavaOpts</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xmx1g -Xms1g&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2000m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2000m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 数据持久卷配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>persistence</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 存储数据大小配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumeClaimTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>managed-nfs-storage</span><span class=w> </span><span class=c># 定义你自己的存储类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;ReadWriteOnce&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>5Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ---安全设置---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置协议，可配置为 http、https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 证书挂载配置，这里我们挂入上面创建的证书</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>secretMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>elastic-certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/elasticsearch/config/certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>0755</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml、log4j2.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>esConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>elasticsearch.yml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.verification_mode: certificate
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class=line><span class=cl><span class=sd>    # xpack.security.http.ssl.enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class=line><span class=cl><span class=sd>    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extraEnvs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ELASTIC_USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ELASTIC_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ---调度设置---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置调度策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># - hard：只有当有足够的节点时 Pod 才会被调度，并且它们永远不会出现在同一个节点上</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># - soft：尽最大努力调度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>antiAffinity</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;soft&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w> </span><span class=c># 容忍全部污点</span><span class=w>
</span></span></span></code></pre></div><p>以下是<code>data-value.yaml</code>的内容</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 设置集群名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;elasticsearch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置节点名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodeGroup</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置角色</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>master</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 镜像</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;docker.elastic.co/elasticsearch/elasticsearch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imageTag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;7.17.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;IfNotPresent&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 副本数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ---资源配置---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>esJavaOpts</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xmx1g -Xms1g&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1000m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1000m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 数据持久卷配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>persistence</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 存储数据大小配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumeClaimTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>managed-nfs-storage</span><span class=w> </span><span class=c># 定义你自己的存储类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;ReadWriteOnce&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>20Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ---安全设置---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置协议，可配置为 http、https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 证书挂载配置，这里我们挂入上面创建的证书</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>secretMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>elastic-certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/elasticsearch/config/certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>0755</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml、log4j2.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>esConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>elasticsearch.yml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.verification_mode: certificate
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class=line><span class=cl><span class=sd>    # xpack.security.http.ssl.enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class=line><span class=cl><span class=sd>    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extraEnvs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ELASTIC_USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ELASTIC_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span></code></pre></div><p>以下是<code>client-value.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 设置集群名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;elasticsearch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置节点名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodeGroup</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;client&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置角色</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>master</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 镜像</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;docker.elastic.co/elasticsearch/elasticsearch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imageTag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;7.17.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;IfNotPresent&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 副本数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ---资源配置---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>esJavaOpts</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xmx1g -Xms1g&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1000m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1000m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 数据持久卷配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>persistence</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ---安全设置---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置协议，可配置为 http、https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 证书挂载配置，这里我们挂入上面创建的证书</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>secretMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>elastic-certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/elasticsearch/config/certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>0755</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml、log4j2.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>esConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>elasticsearch.yml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.verification_mode: certificate
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class=line><span class=cl><span class=sd>    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class=line><span class=cl><span class=sd>    # xpack.security.http.ssl.enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
</span></span></span><span class=line><span class=cl><span class=sd>    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extraEnvs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ELASTIC_USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ELASTIC_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ----服务设置----</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;30200&#39;</span><span class=w>
</span></span></span></code></pre></div><ol start=3><li>开始部署相关节点</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade --install elasticsearch-master -f master-values.yaml --namespace kube-logging ./ <span class=c1># 部署master</span>
</span></span><span class=line><span class=cl>helm upgrade --install elasticsearch-data -f data-values.yaml --namespace kube-logging ./ <span class=c1># 部署data</span>
</span></span><span class=line><span class=cl>helm upgrade --install elasticsearch-client -f client-values.yaml --namespace kube-logging ./  <span class=c1># 部署 client</span>
</span></span></code></pre></div><p>正常情况下看到所有节点都处于<code>running</code>状态即可</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@Online-Beijing-master1 elasticsearch<span class=o>]</span><span class=c1># kubectl get pods -n kube-logging</span>
</span></span><span class=line><span class=cl>NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>elasticsearch-client-0   1/1     Running   <span class=m>0</span>          13m
</span></span><span class=line><span class=cl>elasticsearch-data-0     1/1     Running   <span class=m>0</span>          17m
</span></span><span class=line><span class=cl>elasticsearch-data-1     1/1     Running   <span class=m>0</span>          17m
</span></span><span class=line><span class=cl>elasticsearch-data-2     1/1     Running   <span class=m>0</span>          17m
</span></span><span class=line><span class=cl>elasticsearch-master-0   1/1     Running   <span class=m>0</span>          43m
</span></span><span class=line><span class=cl>elasticsearch-master-1   1/1     Running   <span class=m>0</span>          43m
</span></span><span class=line><span class=cl>elasticsearch-master-2   1/1     Running   <span class=m>0</span>          43m
</span></span></code></pre></div><h2 id=安装kibana>安装Kibana<a hidden class=anchor aria-hidden=true href=#安装kibana>#</a></h2><p>依旧使用<code>helm</code>的方式进行部署</p><ol><li>使用<code>helm pull</code>拉取<code>Kibana</code>包来进行解压</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm pull elastic/kibana --untar --version 7.17.3
</span></span><span class=line><span class=cl><span class=nb>cd</span> kibana
</span></span></code></pre></div><ol start=2><li>定义一个名字为<code>custom-value.yaml</code>的文件</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 指定镜像与镜像版本</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kibana&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imageTag</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;7.17.3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 配置 ElasticSearch 地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>elasticsearchHosts</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;http://elasticsearch-client:9200&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extraEnvs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ELASTICSEARCH_USERNAME&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ELASTICSEARCH_PASSWORD&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elastic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;500m&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;1Gi&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;500m&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;1Gi&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kibana 配置中添加语言配置，设置 kibana 为中文</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kibanaConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kibana.yml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    i18n.locale: &#34;zh-CN&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;30601&#39;</span><span class=w>
</span></span></span></code></pre></div><ol start=3><li>部署<code>kibana</code></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install kibana -f custom-value.yaml --namespace kube-logging .
</span></span></code></pre></div><h2 id=部署fluentd>部署Fluentd<a hidden class=anchor aria-hidden=true href=#部署fluentd>#</a></h2><p>Fluentd 是一个高效的日志聚合器，是用 Ruby 编写的，并且可以很好地扩展。对于大部分企业来说，Fluentd 足够高效并且消耗的资源相对较少，另外一个工具 <code>Fluent-bit</code> 更轻量级，占用资源更少，但是插件相对 Fluentd 来说不够丰富，所以整体来说，Fluentd 更加成熟，使用更加广泛，所以这里我们使用 Fluentd 来作为日志收集工具。</p><h3 id=工作原理>工作原理<a hidden class=anchor aria-hidden=true href=#工作原理>#</a></h3><p>Fluentd 通过一组给定的数据源抓取日志数据，处理后（转换成结构化的数据格式）将它们转发给其他服务，比如 Elasticsearch、对象存储等等。Fluentd 支持超过 300 个日志存储和分析服务，所以在这方面是非常灵活的。主要运行步骤如下：</p><ul><li>首先 Fluentd 从多个日志源获取数据</li><li>结构化并且标记这些数据</li><li>然后根据匹配的标签将数据发送到多个目标服务去</li><li><a class=link href=https://docs.fluentd.org/quickstart target=_blank rel=noopener>官方文档</a></li></ul><p><img style=max-width:100%;height:auto loading=lazy alt=image.png loading=lazy src=https://img14.360buyimg.com/ddimg/jfs/t1/177175/31/35833/30306/64cb08eeF5ba90f46/1da6311bbbec8921.jpg></p><h3 id=日志源配置>日志源配置<a hidden class=anchor aria-hidden=true href=#日志源配置>#</a></h3><p>比如我们这里为了收集 Kubernetes 节点上的所有容器日志，就需要做如下的日志源配置：</p><ul><li>id：表示引用该日志源的唯一标识符，该标识可用于进一步过滤和路由结构化日志数据</li><li>type：Fluentd 内置的指令，tail 表示 Fluentd 从上次读取的位置通过 tail 不断获取数据，另外一个是 http 表示通过一个 GET 请求来收集数据。</li><li>path：<code>tail</code> 类型下的特定参数，告诉 Fluentd 采集 /var/log/containers 目录下的所有日志，这是 docker 在 Kubernetes 节点上用来存储运行容器 stdout 输出日志数据的目录。</li><li>pos_file：检查点，如果 Fluentd 程序重新启动了，它将使用此文件中的位置来恢复日志数据收集。</li><li>tag：用来将日志源与目标或者过滤器匹配的自定义字符串，Fluentd 匹配源/目标标签来路由日志数据。</li></ul><pre tabindex=0><code>&lt;source&gt;
  @id fluentd-containers.log
  @type tail                             # Fluentd 内置的输入方式，其原理是不停地从源文件中获取新的日志,类似于tail命令
  path /var/log/containers/*.log         # 挂载的宿主机容器日志地址
  pos_file /var/log/es-containers.log.pos
  tag raw.kubernetes.*                   # 设置日志标签
  read_from_head true
  &lt;parse&gt;                                # 多行格式化成JSON
    @type multi_format                   # 使用 multi-format-parser 解析器插件
    &lt;pattern&gt;
      format json                        # JSON 解析器
      time_key time                      # 指定事件时间的时间字段
      time_format %Y-%m-%dT%H:%M:%S.%NZ  # 时间格式
    &lt;/pattern&gt;
    &lt;pattern&gt;
      format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/
      time_format %Y-%m-%dT%H:%M:%S.%N%:z
    &lt;/pattern&gt;
  &lt;/parse&gt;
&lt;/source&gt;
</code></pre><h3 id=过滤>过滤<a hidden class=anchor aria-hidden=true href=#过滤>#</a></h3><p>由于 Kubernetes 集群中应用太多，也还有很多历史数据，所以我们可以只将某些应用的日志进行收集，比如我们只采集具有<code> discovery-log=true</code> 这个 Label 标签的 Pod 日志，这个时候就需要使用 filter。</p><pre tabindex=0><code># 删除无用的属性
&lt;filter kubernetes.**&gt;
  @type record_transformer
  remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash
&lt;/filter&gt;
# 只保留具有discovery-log=true标签的Pod日志
&lt;filter kubernetes.**&gt;
  @id filter_log
  @type grep
  &lt;regexp&gt;
    key $.kubernetes.labels.discovery-log
    pattern ^true$
  &lt;/regexp&gt;
&lt;/filter&gt;
</code></pre><h3 id=路由设置>路由设置<a hidden class=anchor aria-hidden=true href=#路由设置>#</a></h3><pre tabindex=0><code>&lt;match **&gt;
  @id elasticsearch
  @type elasticsearch
  @log_level info
  include_tag_key true
  type_name fluentd
  host &#34;#{ENV[&#39;OUTPUT_HOST&#39;]}&#34;
  port &#34;#{ENV[&#39;OUTPUT_PORT&#39;]}&#34;
  logstash_format true
  &lt;buffer&gt;
    @type file
    path /var/log/fluentd-buffers/kubernetes.system.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 5s
    retry_forever
    retry_max_interval 30
    chunk_limit_size &#34;#{ENV[&#39;OUTPUT_BUFFER_CHUNK_LIMIT&#39;]}&#34;
    queue_limit_length &#34;#{ENV[&#39;OUTPUT_BUFFER_QUEUE_LIMIT&#39;]}&#34;
    overflow_action block
  &lt;/buffer&gt;
&lt;/match&gt;
</code></pre><ul><li>match：标识一个目标标签，后面是一个匹配日志源的正则表达式，我们这里想要捕获所有的日志并将它们发送给 Elasticsearch，所以需要配置成**。</li><li>id：目标的一个唯一标识符。</li><li>type：支持的输出插件标识符，我们这里要输出到 Elasticsearch，所以配置成 elasticsearch，这是 Fluentd 的一个内置插件。</li><li>log_level：指定要捕获的日志级别，我们这里配置成 info，表示任何该级别或者该级别以上（INFO、WARNING、ERROR）的日志都将被路由到 Elsasticsearch。</li><li>host/port：定义 Elasticsearch 的地址，也可以配置认证信息，我们的 Elasticsearch 不需要认证，所以这里直接指定 host 和 port 即可。</li><li>logstash_format：Elasticsearch 服务对日志数据构建反向索引进行搜索，将 logstash_format 设置为 true，Fluentd 将会以 logstash 格式来转发结构化的日志数据。</li><li>Buffer： Fluentd 允许在目标不可用时进行缓存，比如，如果网络出现故障或者 Elasticsearch 不可用的时候。缓冲区配置也有助于降低磁盘的 IO。</li></ul><h3 id=开始部署fluentd>开始部署Fluentd<a hidden class=anchor aria-hidden=true href=#开始部署fluentd>#</a></h3><p>要收集 Kubernetes 集群的日志，直接用<code>DasemonSet</code> 控制器来部署 Fluentd 应用，这样，它就可以从 Kubernetes 节点上采集日志，确保在集群中的每个节点上始终运行一个 Fluentd 容器。当然可以直接使用 Helm 来进行一键安装，为了能够了解更多实现细节，我们这里还是采用手动方法来进行安装。</p><ul><li><a class=link href=https://docs.fluentd.org/container-deployment/kubernetes target=_blank rel=noopener>安装文档</a></li></ul><ol><li>首先创建<code>fluentd</code>的<code>configmap</code></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># fluentd-configmap.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># containerd的容器日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containerd.input.conf</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;source&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @id containerd-fluentd-beta.log         # 唯一Id：运行时+收集插件+环境
</span></span></span><span class=line><span class=cl><span class=sd>      @type tail                              # Fluentd 内置的输入方式，其原理是不停地从源文件中获取新的日志
</span></span></span><span class=line><span class=cl><span class=sd>      path /var/log/containers/*.log          # Docker 容器日志路径
</span></span></span><span class=line><span class=cl><span class=sd>      pos_file /var/log/es-containers.log.pos  # 记录读取的位置
</span></span></span><span class=line><span class=cl><span class=sd>      tag raw.kubernetes.*                    # 设置日志标签
</span></span></span><span class=line><span class=cl><span class=sd>      read_from_head true                     # 从头读取
</span></span></span><span class=line><span class=cl><span class=sd>      &lt;parse&gt;                                 # 多行格式化成JSON
</span></span></span><span class=line><span class=cl><span class=sd>        # 可以使用我们介绍过的 multiline 插件实现多行日志
</span></span></span><span class=line><span class=cl><span class=sd>        @type multi_format                    # 使用 multi-format-parser 解析器插件
</span></span></span><span class=line><span class=cl><span class=sd>        &lt;pattern&gt;
</span></span></span><span class=line><span class=cl><span class=sd>          format json                         # JSON解析器
</span></span></span><span class=line><span class=cl><span class=sd>          time_key time                       # 指定事件时间的时间字段
</span></span></span><span class=line><span class=cl><span class=sd>          time_format %Y-%m-%dT%H:%M:%S.%NZ   # 时间格式
</span></span></span><span class=line><span class=cl><span class=sd>        &lt;/pattern&gt;
</span></span></span><span class=line><span class=cl><span class=sd>        &lt;pattern&gt;
</span></span></span><span class=line><span class=cl><span class=sd>          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/
</span></span></span><span class=line><span class=cl><span class=sd>          time_format %Y-%m-%dT%H:%M:%S.%N%:z
</span></span></span><span class=line><span class=cl><span class=sd>        &lt;/pattern&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      &lt;/parse&gt;
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/source&gt;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 在日志输出中检测异常(多行日志)，并将其作为一条日志转发
</span></span></span><span class=line><span class=cl><span class=sd>    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;match raw.kubernetes.**&gt;           # 匹配tag为raw.kubernetes.**日志信息
</span></span></span><span class=line><span class=cl><span class=sd>      @id raw.kubernetes
</span></span></span><span class=line><span class=cl><span class=sd>      @type detect_exceptions           # 使用detect-exceptions插件处理异常栈信息
</span></span></span><span class=line><span class=cl><span class=sd>      remove_tag_prefix raw             # 移除 raw 前缀
</span></span></span><span class=line><span class=cl><span class=sd>      message log
</span></span></span><span class=line><span class=cl><span class=sd>      multiline_flush_interval 5
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/match&gt;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;filter **&gt;  # 拼接日志
</span></span></span><span class=line><span class=cl><span class=sd>      @id filter_concat
</span></span></span><span class=line><span class=cl><span class=sd>      @type concat                # Fluentd Filter 插件，用于连接多个日志中分隔的多行日志
</span></span></span><span class=line><span class=cl><span class=sd>      key message
</span></span></span><span class=line><span class=cl><span class=sd>      multiline_end_regexp /\n$/  # 以换行符“\n”拼接
</span></span></span><span class=line><span class=cl><span class=sd>      separator &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/filter&gt;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 添加 Kubernetes metadata 数据
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;filter kubernetes.**&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @id filter_kubernetes_metadata
</span></span></span><span class=line><span class=cl><span class=sd>      @type kubernetes_metadata
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/filter&gt;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 修复 ES 中的 JSON 字段
</span></span></span><span class=line><span class=cl><span class=sd>    # 插件地址：https://github.com/repeatedly/fluent-plugin-multi-format-parser
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;filter kubernetes.**&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @id filter_parser
</span></span></span><span class=line><span class=cl><span class=sd>      @type parser                # multi-format-parser多格式解析器插件
</span></span></span><span class=line><span class=cl><span class=sd>      key_name log                # 在要解析的日志中指定字段名称
</span></span></span><span class=line><span class=cl><span class=sd>      reserve_data true           # 在解析结果中保留原始键值对
</span></span></span><span class=line><span class=cl><span class=sd>      remove_key_name_field true  # key_name 解析成功后删除字段
</span></span></span><span class=line><span class=cl><span class=sd>      &lt;parse&gt;
</span></span></span><span class=line><span class=cl><span class=sd>        @type multi_format
</span></span></span><span class=line><span class=cl><span class=sd>        &lt;pattern&gt;
</span></span></span><span class=line><span class=cl><span class=sd>          format json
</span></span></span><span class=line><span class=cl><span class=sd>        &lt;/pattern&gt;
</span></span></span><span class=line><span class=cl><span class=sd>        &lt;pattern&gt;
</span></span></span><span class=line><span class=cl><span class=sd>          format none
</span></span></span><span class=line><span class=cl><span class=sd>        &lt;/pattern&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      &lt;/parse&gt;
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/filter&gt;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 删除一些多余的属性
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;filter kubernetes.**&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @type record_transformer
</span></span></span><span class=line><span class=cl><span class=sd>      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/filter&gt;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 只保留具有kubernetes.log.kubernetes.log/fluentd标签的Pod日志
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;filter kubernetes.**&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @id filter_log
</span></span></span><span class=line><span class=cl><span class=sd>      @type grep
</span></span></span><span class=line><span class=cl><span class=sd>      &lt;regexp&gt;
</span></span></span><span class=line><span class=cl><span class=sd>        key $.kubernetes.labels.kubernetes.log/fluentd
</span></span></span><span class=line><span class=cl><span class=sd>        pattern ^true$
</span></span></span><span class=line><span class=cl><span class=sd>      &lt;/regexp&gt;
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/filter&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>###### 监听配置，一般用于日志聚合用 ######</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>forward.input.conf</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 监听通过TCP发送的消息
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;source&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @id forward
</span></span></span><span class=line><span class=cl><span class=sd>      @type forward
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/source&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>output.conf</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;match **&gt;
</span></span></span><span class=line><span class=cl><span class=sd>      @id elasticsearch
</span></span></span><span class=line><span class=cl><span class=sd>      @type elasticsearch
</span></span></span><span class=line><span class=cl><span class=sd>      @log_level info
</span></span></span><span class=line><span class=cl><span class=sd>      include_tag_key true
</span></span></span><span class=line><span class=cl><span class=sd>      host elasticsearch-client
</span></span></span><span class=line><span class=cl><span class=sd>      port 9200
</span></span></span><span class=line><span class=cl><span class=sd>      user elastic # FLUENT_ELASTICSEARCH_USER | FLUENT_ELASTICSEARCH_PASSWORD
</span></span></span><span class=line><span class=cl><span class=sd>      password elastic-master
</span></span></span><span class=line><span class=cl><span class=sd>      logstash_format true
</span></span></span><span class=line><span class=cl><span class=sd>      logstash_prefix kubernetes-cluster
</span></span></span><span class=line><span class=cl><span class=sd>      request_timeout 30s
</span></span></span><span class=line><span class=cl><span class=sd>      &lt;buffer&gt;
</span></span></span><span class=line><span class=cl><span class=sd>        @type file
</span></span></span><span class=line><span class=cl><span class=sd>        path /var/log/fluentd-buffers/kubernetes.system.buffer
</span></span></span><span class=line><span class=cl><span class=sd>        flush_mode interval
</span></span></span><span class=line><span class=cl><span class=sd>        retry_type exponential_backoff
</span></span></span><span class=line><span class=cl><span class=sd>        flush_thread_count 2
</span></span></span><span class=line><span class=cl><span class=sd>        flush_interval 5s
</span></span></span><span class=line><span class=cl><span class=sd>        retry_forever
</span></span></span><span class=line><span class=cl><span class=sd>        retry_max_interval 30
</span></span></span><span class=line><span class=cl><span class=sd>        chunk_limit_size 2M
</span></span></span><span class=line><span class=cl><span class=sd>        queue_limit_length 8
</span></span></span><span class=line><span class=cl><span class=sd>        overflow_action block
</span></span></span><span class=line><span class=cl><span class=sd>      &lt;/buffer&gt;
</span></span></span><span class=line><span class=cl><span class=sd>    &lt;/match&gt;</span><span class=w>
</span></span></span></code></pre></div><ol start=2><li>创建相关的Rbac权限</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>namespaces</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span></code></pre></div><ol start=3><li>创建<code>fluentd</code>的<code>daemonset</code></li></ol><blockquote><p>这个是最新的版本还在研究中,用下面的版本。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccount</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/control-plane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>K8S_NODE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>spec.nodeName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w>  </span><span class=l>FLUENT_ELASTICSEARCH_HOST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;elasticsearch-client-headless.kube-logging.svc.cluster.local&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w>  </span><span class=l>FLUENT_ELASTICSEARCH_PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;9200&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>FLUENT_ELASTICSEARCH_SCHEME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># Option to configure elasticsearch plugin with self signed certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># ================================================================</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>FLUENT_ELASTICSEARCH_SSL_VERIFY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># Option to configure elasticsearch plugin with tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># ================================================================</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>FLUENT_ELASTICSEARCH_SSL_VERSION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;TLSv1_2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># X-Pack Authentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># =====================</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>FLUENT_ELASTICSEARCH_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;elastic&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>FLUENT_ELASTICSEARCH_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;elastic-master&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>FLUENT_ELASTICSEARCH_LOGSTASH_PREFIX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;kubernetes-cluster&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>200Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>200Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentconfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/fluentd/etc/custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dockercontainerlogdirectory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log/pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentconfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dockercontainerlogdirectory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/log/pods</span><span class=w>
</span></span></span></code></pre></div><p>麻烦用下面的进行部署</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>quay.io/fluentd_elasticsearch/fluentd:v3.4.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentconfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/fluent/config.d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentconfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span></code></pre></div><h2 id=关于保留指定标签的问题>关于保留指定标签的问题<a hidden class=anchor aria-hidden=true href=#关于保留指定标签的问题>#</a></h2><p>部署完成以后我发现一直有一个小问题，就是无论我如何设置<code>label</code>都无法让<code>elasticsearch</code>获取到正常的数据。</p><p>根据这个问题，我进行了更细致的排查。现在得出了如下的结论。</p><ol><li><p>可能是由于我对知识的缺乏，我定义的是<code>Deployment</code>当中的<code>label</code>标签，但是这个<code>label</code>标识只作用于<code>Deployment</code>本身，通常用作<code>kubernete</code>集群中的选择器匹配，例如我们的<code>Service</code>要去匹配某个<code>Deployment</code>。</p></li><li><p>关于<code>spec.template.metadata.labels</code>，我发现这个才是我们正确要匹配的<code>label</code>标签选项，因为这些标签用于标识<code>Deployment</code>所创建的<code>Pod</code></p></li><li><p>所以最后总结出来的问题就是，我们上面的<code>fluentd</code>中写的过滤插件<code> key $.kubernetes.labels.kubernetes.log/fluentd</code>中所匹配的<code>label</code>标签应当是<code>spec.template.metadata.labels</code>的<code>label</code></p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>kubernetes.log/fluentd</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.mletter.cn/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://blog.mletter.cn/tech/gitlab/repository-management/><span class=title>« 上一页</span><br><span>管理好内部的代码仓库-GitLab篇</span>
</a><a class=next href=https://blog.mletter.cn/tourists/sichuan/><span class=title>下一页 »</span><br><span>旅行日记-四川·阿坝甘孜藏族自治州</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share kubernetes基于EFK的日志落地实现 on x" href="https://x.com/intent/tweet/?text=kubernetes%e5%9f%ba%e4%ba%8eEFK%e7%9a%84%e6%97%a5%e5%bf%97%e8%90%bd%e5%9c%b0%e5%ae%9e%e7%8e%b0&amp;url=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-efk%2f&amp;hashtags=kubernetes"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubernetes基于EFK的日志落地实现 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-efk%2f&amp;title=kubernetes%e5%9f%ba%e4%ba%8eEFK%e7%9a%84%e6%97%a5%e5%bf%97%e8%90%bd%e5%9c%b0%e5%ae%9e%e7%8e%b0&amp;summary=kubernetes%e5%9f%ba%e4%ba%8eEFK%e7%9a%84%e6%97%a5%e5%bf%97%e8%90%bd%e5%9c%b0%e5%ae%9e%e7%8e%b0&amp;source=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-efk%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubernetes基于EFK的日志落地实现 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-efk%2f&title=kubernetes%e5%9f%ba%e4%ba%8eEFK%e7%9a%84%e6%97%a5%e5%bf%97%e8%90%bd%e5%9c%b0%e5%ae%9e%e7%8e%b0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubernetes基于EFK的日志落地实现 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-efk%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubernetes基于EFK的日志落地实现 on whatsapp" href="https://api.whatsapp.com/send?text=kubernetes%e5%9f%ba%e4%ba%8eEFK%e7%9a%84%e6%97%a5%e5%bf%97%e8%90%bd%e5%9c%b0%e5%ae%9e%e7%8e%b0%20-%20https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-efk%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubernetes基于EFK的日志落地实现 on telegram" href="https://telegram.me/share/url?text=kubernetes%e5%9f%ba%e4%ba%8eEFK%e7%9a%84%e6%97%a5%e5%bf%97%e8%90%bd%e5%9c%b0%e5%ae%9e%e7%8e%b0&amp;url=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-efk%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubernetes基于EFK的日志落地实现 on ycombinator" href="https://news.ycombinator.com/submitlink?t=kubernetes%e5%9f%ba%e4%ba%8eEFK%e7%9a%84%e6%97%a5%e5%bf%97%e8%90%bd%e5%9c%b0%e5%ae%9e%e7%8e%b0&u=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-efk%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><div id=tcomment></div><script src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/twikoo/1.4.18/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo.mletter.cn/",el:"#tcomment"})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.mletter.cn/>太阳可以是蓝色</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><br><span id=span style=color:#101011></span>
<script type=text/javascript>function runtime(){const a=new Date("12/07/2020 12:50:18"),r=new Date,c=r.getTime()-a.getTime(),l=24*60*60*1e3,e=c/l,t=Math.floor(e),n=(e-t)*24,s=Math.floor(n),o=(n-s)*60,i=Math.floor(o),d=Math.floor((o-i)*60);document.getElementById("span").innerHTML="已运行: "+t+"天"+s+"小时"+i+"分"+d+"秒"}runtime(),setInterval(runtime,1e3)</script><br><font color=#101011>本站由 <a href=https://www.netlify.com/ rel="noopener noreferrer nofollow" target=_blank>Netlify</a> 提供计算服务, 由 <a href=https://www.netlify.com/ rel="noopener noreferrer nofollow" target=_blank>Netlify</a> 提供全站加速服务。</font><br></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>const menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("href").substr(1),n=document.querySelector(`[id='${decodeURIComponent(t)}']`);window.matchMedia("(prefers-reduced-motion: reduce)").matches?n.scrollIntoView():n.scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>const mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.classList.contains("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>