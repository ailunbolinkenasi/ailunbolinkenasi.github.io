<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>利用Kubeadm进行多Master高可用部署 | 太阳可以是蓝色</title>
<meta name=keywords content="kubernetes"><meta name=description content="如何使用kubeadm方案来安装高可用的kubernetes集群"><meta name=author content="iren."><link rel=canonical href=https://blog.mletter.cn/tech/kubernetes/install-kubernetes-ha/><link crossorigin=anonymous href=/assets/css/stylesheet.54398d0fb317133a824d0a4034cf0879e64c7449a21217c62f4c262009100d8f.css integrity="sha256-VDmND7MXEzqCTQpANM8IeeZMdEmiEhfGL0wmIAkQDY8=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.mletter.cn/tech/kubernetes/install-kubernetes-ha/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script src=/view-image.min.js></script><script>window.ViewImage&&ViewImage.init("img")</script><style>:root{--sys-font-family:-apple-system, "PingFang SC", Georgia, 'Nimbus Roman No9 L', 'Hiragino Sans GB', 'Noto Serif SC', 'Microsoft Yahei', 'WenQuanYi Micro Hei', 'ST Heiti', sans-serif;--code-font-family:"JetBrains Mono", Menlo, Monaco, Consolas, "Courier New";--article-font-family:-apple-system, "PingFang SC", var(--base-font-family)}</style><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><meta property="og:url" content="https://blog.mletter.cn/tech/kubernetes/install-kubernetes-ha/"><meta property="og:site_name" content="太阳可以是蓝色"><meta property="og:title" content="利用Kubeadm进行多Master高可用部署"><meta property="og:description" content="如何使用kubeadm方案来安装高可用的kubernetes集群"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-29T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-29T00:00:00+00:00"><meta property="article:tag" content="Kubernetes"><meta property="og:image" content="https://img14.360buyimg.com/ddimg/jfs/t1/164569/9/40677/14419/65bc6e4cFa1d8c0c3/5ccf7e6caadc9b83.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://img14.360buyimg.com/ddimg/jfs/t1/164569/9/40677/14419/65bc6e4cFa1d8c0c3/5ccf7e6caadc9b83.jpg"><meta name=twitter:title content="利用Kubeadm进行多Master高可用部署"><meta name=twitter:description content="如何使用kubeadm方案来安装高可用的kubernetes集群"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"","item":"https://blog.mletter.cn/posts/"},{"@type":"ListItem","position":2,"name":"利用Kubeadm进行多Master高可用部署","item":"https://blog.mletter.cn/tech/kubernetes/install-kubernetes-ha/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"利用Kubeadm进行多Master高可用部署","name":"利用Kubeadm进行多Master高可用部署","description":"如何使用kubeadm方案来安装高可用的kubernetes集群","keywords":["kubernetes"],"articleBody":"利用Kubeadm创建高可用集群 使用具有堆叠的控制平面节点。这种方法所需基础设施较少。etcd 成员和控制平面节点位于同一位置。 使用外部 etcd 集群。这种方法所需基础设施较多。控制平面的节点和 etcd 成员是分开的。 在下一步之前，你应该仔细考虑哪种方法更好地满足你的应用程序和环境的需求。 高可用拓扑选项 讲述了每种方法的优缺点。 如何安装Kubectl和Kubeadm 如何安装外部的Etcd集群 参与主机列表 IP CPU 内存 硬盘 角色 10.1.6.48 8 16 100 control-plane1 10.1.6.24 8 16 100 control-plane2 10.1.6.45 8 16 100 control-plane3 10.1.6.46 8 16 100 work1 10.1.6.43 8 16 100 work2 10.1.6.47 8 16 100 work3 10.1.6.213 4 4 20 HA+KP1 10.1.6.214 4 4 20 HA+KP2 10.1.6.215 Load_Balancer_IP 10.1.6.51 8 16 100 Etcd1 10.1.6.52 8 16 100 Etcd2 10.1.6.53 8 16 100 Etcd3 为Kube-apiserver创建负载均衡器 Keepalived 提供 VRRP 实现，并允许您配置 Linux 机器使负载均衡，预防单点故障。HAProxy 提供可靠、高性能的负载均衡，能与 Keepalived 完美配合。\n由于 lb1 和 lb2 上安装了 Keepalived 和 HAproxy，如果其中一个节点故障，虚拟 IP 地址（即浮动 IP 地址）将自动与另一个节点关联，使集群仍然可以正常运行，从而实现高可用。若有需要，也可以此为目的，添加更多安装 Keepalived 和 HAproxy 的节点。\n先运行以下命令安装 Keepalived 和 HAproxy。\nyum install keepalived haproxy psmisc -y dnf install keepalived haproxy psmisc -y 在两台用于负载均衡的机器上运行以下命令以配置 Proxy（两台机器的 Proxy 配置相同）：\nvi /etc/haproxy/haproxy.cfg global log /dev/log local0 warning chroot /var/lib/haproxy pidfile /var/run/haproxy.pid maxconn 4000 user haproxy group haproxy daemon stats socket /var/lib/haproxy/stats defaults log global option httplog option dontlognull timeout connect 5000 timeout client 50000 timeout server 50000 frontend kube-apiserver bind *:8443 mode tcp option tcplog default_backend kube-apiserver backend kube-apiserver mode tcp option tcplog option tcp-check balance roundrobin default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100 server kube-apiserver-1 10.1.6.48:6443 check # Replace the IP address with your own. server kube-apiserver-2 10.1.6.24:6443 check # Replace the IP address with your own. server kube-apiserver-3 10.1.6.45:6443 check # Replace the IP address with your own. 启动Haproxy\n请确保你的LB2也已经进行如上配置\nsystemctl restart haproxy systemctl enable haproxy 配置Keepalived KP1配置如下\nvim /etc/keepalived/keepalived.conf global_defs { notification_email { } router_id LVS_DEVEL vrrp_skip_check_adv_addr vrrp_garp_interval 0 vrrp_gna_interval 0 } vrrp_script chk_haproxy { script \"killall -0 haproxy\" interval 2 weight 2 } vrrp_instance haproxy-vip { state BACKUP priority 100 interface ens192 # 网卡名称 virtual_router_id 60 advert_int 1 authentication { auth_type PASS auth_pass 1111 } unicast_src_ip 10.1.6.213 # The IP address of this machine unicast_peer { 10.1.6.214 # The IP address of peer machines } virtual_ipaddress { 10.1.6.215/24 # 虚拟IP地址 } track_script { chk_haproxy } } KP2配置如下\nvim /etc/keepalived/keepalived.conf global_defs { notification_email { } router_id LVS_DEVEL vrrp_skip_check_adv_addr vrrp_garp_interval 0 vrrp_gna_interval 0 } vrrp_script chk_haproxy { script \"killall -0 haproxy\" interval 2 weight 2 } vrrp_instance haproxy-vip { state BACKUP priority 90 interface ens192 # Network card virtual_router_id 60 advert_int 1 authentication { auth_type PASS auth_pass 1111 } unicast_src_ip 10.1.6.214 # The IP address of this machine unicast_peer { 10.1.6.214 # The IP address of peer machines } virtual_ipaddress { 10.1.6.215/24 # The VIP address } track_script { chk_haproxy } } 请确保你的KP1和KP2都完成了如上配置\nsystemctl start keepalived systemctl enable keepalived 配置Master主机节点的Hosts文件 所有的Master主机都需要进行配置,防止后续解析不到api.k8s.verbos.com\n10.1.6.48 containerd-master1 10.1.6.24 containerd-master2 10.1.6.45 containerd-master3 10.1.6.46 containerd-work1 10.1.6.43 containerd-work2 10.1.6.47 containerd-work3 10.1.6.51 etcd1 10.1.6.52 etcd2 10.1.6.53 etcd3 10.1.6.215 api.k8s.verbos.com 设置Etcd集群证书 如果你使用的是工作在Work节点的Etcd或者其他单独的Etcd集群,请将Etcd的ca证书进行拷贝到Master节点当中.\nexport CONTROL_PLANE=\"root@10.1.6.48\" scp /etc/kubernetes/pki/etcd/ca.crt \"${CONTROL_PLANE}\": scp /etc/kubernetes/pki/apiserver-etcd-client.crt \"${CONTROL_PLANE}\": scp /etc/kubernetes/pki/apiserver-etcd-client.key \"${CONTROL_PLANE}\": 设置第一个控制平面节点 用以下内容创建一个名为 kubeadm-config.yaml 的文件\napiVersion: kubeadm.k8s.io/v1beta3 kind: ClusterConfiguration kubernetesVersion: v1.22.10 controlPlaneEndpoint: \"api.k8s.verbos.com:8443\" apiServer: certSANs: - 10.1.6.48 - 10.1.6.24 - 10.1.6.45 etcd: external: endpoints: - https://10.1.6.51:2379 # 适当地更改 ETCD_0_IP - https://10.1.6.52:2379 # 适当地更改 ETCD_1_IP - https://10.1.6.53:2379 # 适当地更改 ETCD_2_IP caFile: /etc/kubernetes/pki/etcd/ca.crt certFile: /etc/kubernetes/pki/apiserver-etcd-client.crt keyFile: /etc/kubernetes/pki/apiserver-etcd-client.key imageRepository: registry.aliyuncs.com/google_containers networking: podSubnet: 10.244.0.0/16 serviceSubnet: 10.10.0.0/16 在节点上运行如下命令\nkubeadm init --config kubeadm-config.yaml --upload-certs --v=5 注意：如果你的集群初始化成功你将会看到如下信息.\n请保存好kubeadm join的内容,默认2小时后过期,过期后重新生成即可 Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Alternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.conf You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ You can now join any number of the control-plane node running the following command on each as root: kubeadm join api.k8s.verbos.com:8443 --token 9oerz0.fw6s8ft9xa44i077 \\ --discovery-token-ca-cert-hash sha256:be3c70562ae6bf8cfcfbbfa3bb8124fe63af3b1a0671e806a4ccf1bc243d5c6b \\ --control-plane --certificate-key cdf0f280f9e59e18e5f60d98b624008d828ba00ef096a2e38fd9b6b1463be152 Please note that the certificate-key gives access to cluster sensitive data, keep it secret! As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use \"kubeadm init phase upload-certs --upload-certs\" to reload certs afterward. Then you can join any number of worker nodes by running the following on each as root: kubeadm join api.k8s.verbos.com:8443 --token 9oerz0.fw6s8ft9xa44i077 \\ --discovery-token-ca-cert-hash sha256:be3c70562ae6bf8cfcfbbfa3bb8124fe63af3b1a0671e806a4ccf1bc243d5c6b 拷贝集群配置文件\nmkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config 运行网络CNI插件(Calico) 注意：此时你应当有一个CNI插件来提供网络服务,如果不安装CNI插件,那么集群将会处于不可用状态.\n如果你可以正常访问github\n[root@containerd-kube-master .kube]# curl https://raw.githubusercontent.com/projectcalico/calico/v3.24.1/manifests/calico.yaml -O 国内用户\ncurl https://projectcalico.docs.tigera.io/manifests/calico.yaml -O 修改Calico.yaml配置 修改CIDR为Kubernetes的子网地址,该地址为serviceSubnet的地址,也就是Pod运行的地址。\n- name: CALICO_IPV4POOL_CIDR value: \"10.10.0.0/16\" 执行calico.yaml\nkubectl apply -f calico.yaml 将其他控制平面节点加入集群 当你已经确保你的containerd-master1完成初始化的时候,你可以将其他的master节点加入到此集群当中.\nkubeadm join api.k8s.verbos.com:8443 --token 9oerz0.fw6s8ft9xa44i077 \\ --discovery-token-ca-cert-hash sha256:be3c70562ae6bf8cfcfbbfa3bb8124fe63af3b1a0671e806a4ccf1bc243d5c6b \\ --control-plane --certificate-key cdf0f280f9e59e18e5f60d98b624008d828ba00ef096a2e38fd9b6b1463be152 加入集群成功后,请拷贝集群配置文件否则将影响kubelet的工作\nmkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config 将工作节点加入集群 kubeadm join api.k8s.verbos.com:8443 --token mck9bg.renw4t689mmx7oe1 \\ --discovery-token-ca-cert-hash sha256:ed51fca8615acf5f437f63f66a9709e43ef942caf19aea4c595cb905e4a9a00f (可选项)修改Kubelet的数据存储目录 如果你需要修改kubelet的数据存储目录,请按照如下方式进行操作\nvim /etc/sysconfig/kubelet 设置你的kubelet的数据存储目录(建议单独的为kubelet挂载一块数据盘)\nKUBELET_EXTRA_ARGS=\"--root-dir=/data/k8s/kubelet\" 重启kubelet\nsystemctl daemon-reloa systemctl restart kubelet umount $(df -HT | grep '/var/lib/kubelet/pods' | awk '{print $7}') 查看新的数据目录是否有kubelet的数据\n[root@containerd-master2 kubelet]# ls /data/k8s/kubelet/ cpu_manager_state memory_manager_state plugins plugins_registry pod-resources pods 如何剔除一个Master 先说一个问题,当我们正常如果一个Master要进行某种升级的时候,如何正确的安全的来进行删除该Master。 首先我们要将该Master设置为不可调度的状态,并且驱逐在其上面的Pod # 设置Master为不可调度的状态 kubectl cordon online-beijing-master1 # 将Master剔除该集群 kubectl drain online-beijing-master1 --ignore-daemonsets # 然后将其节点从集群中删除 kubectl delete node online-beijing-master1 这里提一个小问题: 当你使用kubectl drain的时候,如果你当前的Master已经有挂载的emptyDir需要使用--delete-emptydir-data 进行删除。 TODO: 删除前请注意备份您的数据。\n","wordCount":"808","inLanguage":"zh","image":"https://img14.360buyimg.com/ddimg/jfs/t1/164569/9/40677/14419/65bc6e4cFa1d8c0c3/5ccf7e6caadc9b83.jpg","datePublished":"2022-12-29T00:00:00Z","dateModified":"2022-12-29T00:00:00Z","author":{"@type":"Person","name":"iren."},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.mletter.cn/tech/kubernetes/install-kubernetes-ha/"},"publisher":{"@type":"Organization","name":"太阳可以是蓝色","logo":{"@type":"ImageObject","url":"https://blog.mletter.cn/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.mletter.cn/ accesskey=h title="太阳可以是蓝色 (Alt + H)">太阳可以是蓝色</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.mletter.cn/ title=主页><span>主页</span></a></li><li><a href=https://blog.mletter.cn/posts/ title=文章><span>文章</span></a></li><li><a href=https://blog.mletter.cn/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.mletter.cn/friends/ title=友联><span>友联</span></a></li><li><a href=https://blog.mletter.cn/about title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.mletter.cn/>主页</a>&nbsp;»&nbsp;<a href=https://blog.mletter.cn/posts/></a></div><h1 class="post-title entry-hint-parent">利用Kubeadm进行多Master高可用部署</h1><div class=post-description>如何使用kubeadm方案来安装高可用的kubernetes集群</div><div class=post-meta><span title='2022-12-29 00:00:00 +0000 UTC'>十二月 29, 2022</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;iren.&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/install-kubernetes-ha.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#参与主机列表>参与主机列表</a></li><li><a href=#为kube-apiserver创建负载均衡器>为Kube-apiserver创建负载均衡器</a></li><li><a href=#配置master主机节点的hosts文件>配置Master主机节点的Hosts文件</a><ul><li><a href=#设置etcd集群证书>设置Etcd集群证书</a></li></ul></li><li><a href=#设置第一个控制平面节点>设置第一个控制平面节点</a></li><li><a href=#运行网络cni插件calico>运行网络CNI插件(Calico)</a><ul><li><a href=#修改calicoyaml配置>修改Calico.yaml配置</a></li></ul></li><li><a href=#将其他控制平面节点加入集群>将其他控制平面节点加入集群</a></li><li><a href=#将工作节点加入集群>将工作节点加入集群</a></li><li><a href=#可选项修改kubelet的数据存储目录>(可选项)修改Kubelet的数据存储目录</a></li><li><a href=#如何剔除一个master>如何剔除一个Master</a></li></ul></nav></div></details></div><div class=post-content><h1 id=利用kubeadm创建高可用集群>利用Kubeadm创建高可用集群<a hidden class=anchor aria-hidden=true href=#利用kubeadm创建高可用集群>#</a></h1><ul><li>使用具有堆叠的控制平面节点。这种方法所需基础设施较少。etcd 成员和控制平面节点位于同一位置。</li><li>使用外部 etcd 集群。这种方法所需基础设施较多。控制平面的节点和 etcd 成员是分开的。
在下一步之前，你应该仔细考虑哪种方法更好地满足你的应用程序和环境的需求。 高可用拓扑选项 讲述了每种方法的优缺点。</li><li><a class=link href=https://blog.mletter.cn/kubernetes/InstallKubernetes1.22.10 target=_blank rel=noopener>如何安装Kubectl和Kubeadm</a></li><li><a class=link href=https://blog.mletter.cn/kubernetes/InstallEtcdHA target=_blank rel=noopener>如何安装外部的Etcd集群</a></li></ul><h2 id=参与主机列表>参与主机列表<a hidden class=anchor aria-hidden=true href=#参与主机列表>#</a></h2><table><thead><tr><th>IP</th><th>CPU</th><th>内存</th><th style=text-align:left>硬盘</th><th style=text-align:left>角色</th></tr></thead><tbody><tr><td>10.1.6.48</td><td>8</td><td>16</td><td style=text-align:left>100</td><td style=text-align:left>control-plane1</td></tr><tr><td>10.1.6.24</td><td>8</td><td>16</td><td style=text-align:left>100</td><td style=text-align:left>control-plane2</td></tr><tr><td>10.1.6.45</td><td>8</td><td>16</td><td style=text-align:left>100</td><td style=text-align:left>control-plane3</td></tr><tr><td>10.1.6.46</td><td>8</td><td>16</td><td style=text-align:left>100</td><td style=text-align:left>work1</td></tr><tr><td>10.1.6.43</td><td>8</td><td>16</td><td style=text-align:left>100</td><td style=text-align:left>work2</td></tr><tr><td>10.1.6.47</td><td>8</td><td>16</td><td style=text-align:left>100</td><td style=text-align:left>work3</td></tr><tr><td>10.1.6.213</td><td>4</td><td>4</td><td style=text-align:left>20</td><td style=text-align:left>HA+KP1</td></tr><tr><td>10.1.6.214</td><td>4</td><td>4</td><td style=text-align:left>20</td><td style=text-align:left>HA+KP2</td></tr><tr><td>10.1.6.215</td><td></td><td></td><td style=text-align:left></td><td style=text-align:left>Load_Balancer_IP</td></tr><tr><td>10.1.6.51</td><td>8</td><td>16</td><td style=text-align:left>100</td><td style=text-align:left>Etcd1</td></tr><tr><td>10.1.6.52</td><td>8</td><td>16</td><td style=text-align:left>100</td><td style=text-align:left>Etcd2</td></tr><tr><td>10.1.6.53</td><td>8</td><td>16</td><td style=text-align:left>100</td><td style=text-align:left>Etcd3</td></tr></tbody></table><h2 id=为kube-apiserver创建负载均衡器>为Kube-apiserver创建负载均衡器<a hidden class=anchor aria-hidden=true href=#为kube-apiserver创建负载均衡器>#</a></h2><p>Keepalived 提供 VRRP 实现，并允许您配置 Linux 机器使负载均衡，预防单点故障。HAProxy 提供可靠、高性能的负载均衡，能与 Keepalived 完美配合。</p><p>由于 lb1 和 lb2 上安装了 Keepalived 和 HAproxy，如果其中一个节点故障，虚拟 IP 地址（即浮动 IP 地址）将自动与另一个节点关联，使集群仍然可以正常运行，从而实现高可用。若有需要，也可以此为目的，添加更多安装 Keepalived 和 HAproxy 的节点。</p><p>先运行以下命令安装 <code>Keepalived</code> 和 <code>HAproxy</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install keepalived haproxy psmisc -y
</span></span><span class=line><span class=cl>dnf install keepalived haproxy psmisc -y
</span></span></code></pre></div><p>在两台用于负载均衡的机器上运行以下命令以配置 Proxy（两台机器的 Proxy 配置相同）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /etc/haproxy/haproxy.cfg
</span></span></code></pre></div><pre tabindex=0><code class=language-conf data-lang=conf>global
    log /dev/log  local0 warning
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

   stats socket /var/lib/haproxy/stats

defaults
  log global
  option  httplog
  option  dontlognull
        timeout connect 5000
        timeout client 50000
        timeout server 50000

frontend kube-apiserver
  bind *:8443
  mode tcp
  option tcplog
  default_backend kube-apiserver

backend kube-apiserver
    mode tcp
    option tcplog
    option tcp-check
    balance roundrobin
    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
    server kube-apiserver-1 10.1.6.48:6443 check # Replace the IP address with your own.
    server kube-apiserver-2 10.1.6.24:6443 check # Replace the IP address with your own.
    server kube-apiserver-3 10.1.6.45:6443 check # Replace the IP address with your own.
</code></pre><p>启动Haproxy</p><blockquote><p>请确保你的LB2也已经进行如上配置</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl restart haproxy
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> haproxy
</span></span></code></pre></div><p>配置Keepalived
<code>KP1</code>配置如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim /etc/keepalived/keepalived.conf
</span></span></code></pre></div><pre tabindex=0><code class=language-conf data-lang=conf>global_defs {
  notification_email {
  }
  router_id LVS_DEVEL
  vrrp_skip_check_adv_addr
  vrrp_garp_interval 0
  vrrp_gna_interval 0
}

vrrp_script chk_haproxy {
  script &#34;killall -0 haproxy&#34;
  interval 2
  weight 2
}

vrrp_instance haproxy-vip {
  state BACKUP
  priority 100
  interface ens192                      # 网卡名称
  virtual_router_id 60
  advert_int 1
  authentication {
    auth_type PASS
    auth_pass 1111
  }
  unicast_src_ip 10.1.6.213      # The IP address of this machine
  unicast_peer {
    10.1.6.214                  # The IP address of peer machines
  }

  virtual_ipaddress {
    10.1.6.215/24                  # 虚拟IP地址
  }

  track_script {
    chk_haproxy
  }
}
</code></pre><p><code>KP2</code>配置如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim /etc/keepalived/keepalived.conf
</span></span></code></pre></div><pre tabindex=0><code class=language-conf data-lang=conf>global_defs {
  notification_email {
  }
  router_id LVS_DEVEL
  vrrp_skip_check_adv_addr
  vrrp_garp_interval 0
  vrrp_gna_interval 0
}

vrrp_script chk_haproxy {
  script &#34;killall -0 haproxy&#34;
  interval 2
  weight 2
}

vrrp_instance haproxy-vip {
  state BACKUP
  priority 90
  interface ens192                      # Network card
  virtual_router_id 60
  advert_int 1
  authentication {
    auth_type PASS
    auth_pass 1111
  }
  unicast_src_ip 10.1.6.214      # The IP address of this machine
  unicast_peer {
    10.1.6.214                         # The IP address of peer machines
  }

  virtual_ipaddress {
    10.1.6.215/24                  # The VIP address
  }

  track_script {
    chk_haproxy
  }
}
</code></pre><p>请确保你的<code>KP1</code>和<code>KP2</code>都完成了如上配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl start keepalived
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> keepalived
</span></span></code></pre></div><h2 id=配置master主机节点的hosts文件>配置Master主机节点的Hosts文件<a hidden class=anchor aria-hidden=true href=#配置master主机节点的hosts文件>#</a></h2><ul><li><p>所有的Master主机都需要进行配置,防止后续解析不到<code>api.k8s.verbos.com</code></p><pre tabindex=0><code class=language-conf data-lang=conf>10.1.6.48 containerd-master1
10.1.6.24 containerd-master2
10.1.6.45 containerd-master3
10.1.6.46 containerd-work1
10.1.6.43 containerd-work2
10.1.6.47 containerd-work3
10.1.6.51 etcd1
10.1.6.52 etcd2
10.1.6.53 etcd3
10.1.6.215  api.k8s.verbos.com
</code></pre><h3 id=设置etcd集群证书>设置Etcd集群证书<a hidden class=anchor aria-hidden=true href=#设置etcd集群证书>#</a></h3><p>如果你使用的是工作在Work节点的Etcd或者其他单独的Etcd集群,请将Etcd的<code>ca</code>证书进行拷贝到Master节点当中.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CONTROL_PLANE</span><span class=o>=</span><span class=s2>&#34;root@10.1.6.48&#34;</span>
</span></span><span class=line><span class=cl>scp /etc/kubernetes/pki/etcd/ca.crt <span class=s2>&#34;</span><span class=si>${</span><span class=nv>CONTROL_PLANE</span><span class=si>}</span><span class=s2>&#34;</span>:
</span></span><span class=line><span class=cl>scp /etc/kubernetes/pki/apiserver-etcd-client.crt <span class=s2>&#34;</span><span class=si>${</span><span class=nv>CONTROL_PLANE</span><span class=si>}</span><span class=s2>&#34;</span>:
</span></span><span class=line><span class=cl>scp /etc/kubernetes/pki/apiserver-etcd-client.key <span class=s2>&#34;</span><span class=si>${</span><span class=nv>CONTROL_PLANE</span><span class=si>}</span><span class=s2>&#34;</span>:
</span></span></code></pre></div><h2 id=设置第一个控制平面节点>设置第一个控制平面节点<a hidden class=anchor aria-hidden=true href=#设置第一个控制平面节点>#</a></h2><p>用以下内容创建一个名为 <code>kubeadm-config.yaml</code> 的文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm.k8s.io/v1beta3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1.22.10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controlPlaneEndpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;api.k8s.verbos.com:8443&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiServer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>certSANs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>10.1.6.48</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>10.1.6.24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>10.1.6.45</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>etcd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>external</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>https://10.1.6.51:2379</span><span class=w> </span><span class=c># 适当地更改 ETCD_0_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>https://10.1.6.52:2379</span><span class=w> </span><span class=c># 适当地更改 ETCD_1_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>https://10.1.6.53:2379</span><span class=w> </span><span class=c># 适当地更改 ETCD_2_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>caFile</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/pki/etcd/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>certFile</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/pki/apiserver-etcd-client.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>keyFile</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/pki/apiserver-etcd-client.key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imageRepository</span><span class=p>:</span><span class=w> </span><span class=l>registry.aliyuncs.com/google_containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networking</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>podSubnet</span><span class=p>:</span><span class=w> </span><span class=m>10.244.0.0</span><span class=l>/16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serviceSubnet</span><span class=p>:</span><span class=w> </span><span class=m>10.10.0.0</span><span class=l>/16</span><span class=w>
</span></span></span></code></pre></div></li></ul><p>在节点上运行如下命令</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubeadm init --config kubeadm-config.yaml --upload-certs --v<span class=o>=</span><span class=m>5</span>
</span></span></code></pre></div><blockquote><p>注意：如果你的集群初始化成功你将会看到如下信息.</p></blockquote><ul><li>请保存好<code>kubeadm join</code>的内容,默认2小时后过期,过期后重新生成即可</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Your Kubernetes control-plane has initialized successfully!
</span></span><span class=line><span class=cl>To start using your cluster, you need to run the following as a regular user:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>  sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>  sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Alternatively, <span class=k>if</span> you are the root user, you can run:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>/etc/kubernetes/admin.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You should now deploy a pod network to the cluster.
</span></span><span class=line><span class=cl>Run <span class=s2>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class=line><span class=cl>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You can now join any number of the control-plane node running the following <span class=nb>command</span> on each as root:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubeadm join api.k8s.verbos.com:8443 --token 9oerz0.fw6s8ft9xa44i077 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --discovery-token-ca-cert-hash sha256:be3c70562ae6bf8cfcfbbfa3bb8124fe63af3b1a0671e806a4ccf1bc243d5c6b <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --control-plane --certificate-key cdf0f280f9e59e18e5f60d98b624008d828ba00ef096a2e38fd9b6b1463be152
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span class=line><span class=cl>As a safeguard, uploaded-certs will be deleted in two hours<span class=p>;</span> If necessary, you can use
</span></span><span class=line><span class=cl><span class=s2>&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubeadm join api.k8s.verbos.com:8443 --token 9oerz0.fw6s8ft9xa44i077 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --discovery-token-ca-cert-hash sha256:be3c70562ae6bf8cfcfbbfa3bb8124fe63af3b1a0671e806a4ccf1bc243d5c6b 
</span></span></code></pre></div><p><strong>拷贝集群配置文件</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span></code></pre></div><h2 id=运行网络cni插件calico>运行网络CNI插件(Calico)<a hidden class=anchor aria-hidden=true href=#运行网络cni插件calico>#</a></h2><blockquote><p>注意：此时你应当有一个CNI插件来提供网络服务,如果不安装CNI插件,那么集群将会处于<code>不可用</code>状态.</p></blockquote><p>如果你可以正常访问github</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@containerd-kube-master .kube<span class=o>]</span><span class=c1># curl https://raw.githubusercontent.com/projectcalico/calico/v3.24.1/manifests/calico.yaml -O</span>
</span></span></code></pre></div><p>国内用户</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl https://projectcalico.docs.tigera.io/manifests/calico.yaml -O
</span></span></code></pre></div><h3 id=修改calicoyaml配置>修改Calico.yaml配置<a hidden class=anchor aria-hidden=true href=#修改calicoyaml配置>#</a></h3><p>修改CIDR为Kubernetes的子网地址,该地址为<code>serviceSubnet</code>的地址,也就是Pod运行的地址。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CALICO_IPV4POOL_CIDR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.10.0.0/16&#34;</span><span class=w>
</span></span></span></code></pre></div><p>执行<code>calico.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f calico.yaml
</span></span></code></pre></div><h2 id=将其他控制平面节点加入集群>将其他控制平面节点加入集群<a hidden class=anchor aria-hidden=true href=#将其他控制平面节点加入集群>#</a></h2><p>当你已经确保你的<code>containerd-master1</code>完成初始化的时候,你可以将其他的master节点加入到此集群当中.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  kubeadm join api.k8s.verbos.com:8443 --token 9oerz0.fw6s8ft9xa44i077 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --discovery-token-ca-cert-hash sha256:be3c70562ae6bf8cfcfbbfa3bb8124fe63af3b1a0671e806a4ccf1bc243d5c6b <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --control-plane --certificate-key cdf0f280f9e59e18e5f60d98b624008d828ba00ef096a2e38fd9b6b1463be152
</span></span></code></pre></div><p>加入集群成功后,请拷贝集群配置文件否则将影响<code>kubelet</code>的工作</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span></code></pre></div><h2 id=将工作节点加入集群>将工作节点加入集群<a hidden class=anchor aria-hidden=true href=#将工作节点加入集群>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubeadm join api.k8s.verbos.com:8443 --token mck9bg.renw4t689mmx7oe1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --discovery-token-ca-cert-hash sha256:ed51fca8615acf5f437f63f66a9709e43ef942caf19aea4c595cb905e4a9a00f
</span></span></code></pre></div><h2 id=可选项修改kubelet的数据存储目录>(可选项)修改Kubelet的数据存储目录<a hidden class=anchor aria-hidden=true href=#可选项修改kubelet的数据存储目录>#</a></h2><p>如果你需要修改kubelet的数据存储目录,请按照如下方式进行操作</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim /etc/sysconfig/kubelet
</span></span></code></pre></div><p>设置你的kubelet的数据存储目录(建议单独的为kubelet挂载一块数据盘)</p><pre tabindex=0><code class=language-conf data-lang=conf>KUBELET_EXTRA_ARGS=&#34;--root-dir=/data/k8s/kubelet&#34;
</code></pre><p>重启kubelet</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reloa
</span></span><span class=line><span class=cl>systemctl restart kubelet
</span></span><span class=line><span class=cl>umount <span class=k>$(</span>df -HT <span class=p>|</span> grep <span class=s1>&#39;/var/lib/kubelet/pods&#39;</span> <span class=p>|</span> awk <span class=s1>&#39;{print $7}&#39;</span><span class=k>)</span>
</span></span></code></pre></div><p>查看新的数据目录是否有kubelet的数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@containerd-master2 kubelet<span class=o>]</span><span class=c1># ls /data/k8s/kubelet/</span>
</span></span><span class=line><span class=cl>cpu_manager_state  memory_manager_state  plugins  plugins_registry  pod-resources  pods
</span></span></code></pre></div><h2 id=如何剔除一个master>如何剔除一个Master<a hidden class=anchor aria-hidden=true href=#如何剔除一个master>#</a></h2><ul><li>先说一个问题,当我们正常如果一个Master要进行某种升级的时候,如何正确的安全的来进行删除该Master。</li></ul><ol><li>首先我们要将该Master设置为不可调度的状态,并且驱逐在其上面的Pod</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 设置Master为不可调度的状态</span>
</span></span><span class=line><span class=cl>kubectl cordon online-beijing-master1
</span></span><span class=line><span class=cl><span class=c1># 将Master剔除该集群</span>
</span></span><span class=line><span class=cl>kubectl drain online-beijing-master1 --ignore-daemonsets
</span></span><span class=line><span class=cl><span class=c1># 然后将其节点从集群中删除</span>
</span></span><span class=line><span class=cl>kubectl delete node online-beijing-master1
</span></span></code></pre></div><blockquote><p>这里提一个小问题: 当你使用<code>kubectl drain</code>的时候,如果你当前的Master已经有挂载的<code>emptyDir</code>需要使用<code>--delete-emptydir-data </code>进行删除。
TODO: 删除前请注意备份您的数据。</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.mletter.cn/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://blog.mletter.cn/tech/kubernetes/install-kubernetes-1220/><span class=title>« 上一页</span><br><span>kubernetes1.22.0单节点集群部署</span>
</a><a class=next href=https://blog.mletter.cn/tech/kubernetes/memory-leakage-analysis/><span class=title>下一页 »</span><br><span>Kubernetes低版本中内存泄漏问题</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 利用Kubeadm进行多Master高可用部署 on x" href="https://x.com/intent/tweet/?text=%e5%88%a9%e7%94%a8Kubeadm%e8%bf%9b%e8%a1%8c%e5%a4%9aMaster%e9%ab%98%e5%8f%af%e7%94%a8%e9%83%a8%e7%bd%b2&amp;url=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-kubernetes-ha%2f&amp;hashtags=kubernetes"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 利用Kubeadm进行多Master高可用部署 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-kubernetes-ha%2f&amp;title=%e5%88%a9%e7%94%a8Kubeadm%e8%bf%9b%e8%a1%8c%e5%a4%9aMaster%e9%ab%98%e5%8f%af%e7%94%a8%e9%83%a8%e7%bd%b2&amp;summary=%e5%88%a9%e7%94%a8Kubeadm%e8%bf%9b%e8%a1%8c%e5%a4%9aMaster%e9%ab%98%e5%8f%af%e7%94%a8%e9%83%a8%e7%bd%b2&amp;source=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-kubernetes-ha%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 利用Kubeadm进行多Master高可用部署 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-kubernetes-ha%2f&title=%e5%88%a9%e7%94%a8Kubeadm%e8%bf%9b%e8%a1%8c%e5%a4%9aMaster%e9%ab%98%e5%8f%af%e7%94%a8%e9%83%a8%e7%bd%b2"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 利用Kubeadm进行多Master高可用部署 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-kubernetes-ha%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 利用Kubeadm进行多Master高可用部署 on whatsapp" href="https://api.whatsapp.com/send?text=%e5%88%a9%e7%94%a8Kubeadm%e8%bf%9b%e8%a1%8c%e5%a4%9aMaster%e9%ab%98%e5%8f%af%e7%94%a8%e9%83%a8%e7%bd%b2%20-%20https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-kubernetes-ha%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 利用Kubeadm进行多Master高可用部署 on telegram" href="https://telegram.me/share/url?text=%e5%88%a9%e7%94%a8Kubeadm%e8%bf%9b%e8%a1%8c%e5%a4%9aMaster%e9%ab%98%e5%8f%af%e7%94%a8%e9%83%a8%e7%bd%b2&amp;url=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-kubernetes-ha%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 利用Kubeadm进行多Master高可用部署 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e5%88%a9%e7%94%a8Kubeadm%e8%bf%9b%e8%a1%8c%e5%a4%9aMaster%e9%ab%98%e5%8f%af%e7%94%a8%e9%83%a8%e7%bd%b2&u=https%3a%2f%2fblog.mletter.cn%2ftech%2fkubernetes%2finstall-kubernetes-ha%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><div id=tcomment></div><script src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/twikoo/1.4.18/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo.mletter.cn/",el:"#tcomment"})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.mletter.cn/>太阳可以是蓝色</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><br><span id=span style=color:#101011></span>
<script type=text/javascript>function runtime(){const a=new Date("12/07/2020 12:50:18"),r=new Date,c=r.getTime()-a.getTime(),l=24*60*60*1e3,e=c/l,t=Math.floor(e),n=(e-t)*24,s=Math.floor(n),o=(n-s)*60,i=Math.floor(o),d=Math.floor((o-i)*60);document.getElementById("span").innerHTML="已运行: "+t+"天"+s+"小时"+i+"分"+d+"秒"}runtime(),setInterval(runtime,1e3)</script><br><font color=#101011>本站由 <a href=https://www.netlify.com/ rel="noopener noreferrer nofollow" target=_blank>Netlify</a> 提供计算服务, 由 <a href=https://www.netlify.com/ rel="noopener noreferrer nofollow" target=_blank>Netlify</a> 提供全站加速服务。</font><br></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>const menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("href").substr(1),n=document.querySelector(`[id='${decodeURIComponent(t)}']`);window.matchMedia("(prefers-reduced-motion: reduce)").matches?n.scrollIntoView():n.scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>const mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.classList.contains("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>